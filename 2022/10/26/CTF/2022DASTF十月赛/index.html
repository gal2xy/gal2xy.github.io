

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="gla2xy">
  <meta name="keywords" content="">
  
    <meta name="description" content="CryptoRSA123456789101112131415161718192021222324252627282930313233343536373839404142434445464748from Crypto.Util.number import *from secret import flagdef encrypt1(n):    n1 &#x3D; hex(n&gt;&gt;200).encode">
<meta property="og:type" content="article">
<meta property="og:title" content="2022DASTF十月赛">
<meta property="og:url" content="http://example.com/2022/10/26/CTF/2022DASTF%E5%8D%81%E6%9C%88%E8%B5%9B/index.html">
<meta property="og:site_name" content="gla2xy&#39;s blog">
<meta property="og:description" content="CryptoRSA123456789101112131415161718192021222324252627282930313233343536373839404142434445464748from Crypto.Util.number import *from secret import flagdef encrypt1(n):    n1 &#x3D; hex(n&gt;&gt;200).encode">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-10-26T01:46:10.000Z">
<meta property="article:modified_time" content="2022-10-26T08:53:40.562Z">
<meta property="article:author" content="gla2xy">
<meta property="article:tag" content="低指数爆破">
<meta property="article:tag" content="Paillier">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>2022DASTF十月赛 - gla2xy&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"y4ByOj1FL3SFodYp7tlkfLna-gzGzoHsz","app_key":"7E1eIfDTBkJaMJkiQI0jToXE","server_url":null,"path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>gal2xy&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="2022DASTF十月赛"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        gla2xy
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-26 09:46" pubdate>
          2022年10月26日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          21k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          174 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">2022DASTF十月赛</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt1</span>(<span class="hljs-params">n</span>):<br>    n1 = <span class="hljs-built_in">hex</span>(n&gt;&gt;<span class="hljs-number">200</span>).encode()<br>    n2 = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(n))[<span class="hljs-number">20</span>:].encode()<br>    <span class="hljs-keyword">return</span> n1,n2<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt2</span>(<span class="hljs-params">m , n_1</span>):<br>    c_1 = <span class="hljs-built_in">pow</span>(m,e_1,n_1)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c_1 = &#x27;</span>+<span class="hljs-built_in">str</span>(c_1))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt3</span>(<span class="hljs-params">m , n_2</span>):<br>    c_2 = <span class="hljs-built_in">pow</span>( m , e_2 , n_2)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c_2 = &#x27;</span>+<span class="hljs-built_in">str</span>(c_2))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt4</span>(<span class="hljs-params">m</span>):<br>    k = getPrime(<span class="hljs-number">512</span>)<br>    m = m % k<br>    c_3 = <span class="hljs-built_in">pow</span>(m, e_2, n_3)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c_3 = &#x27;</span> + <span class="hljs-built_in">str</span>(c_3))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;m = &#x27;</span> + <span class="hljs-built_in">str</span>(m))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;k = &#x27;</span> + <span class="hljs-built_in">str</span>(k))<br><br>m1,m2 = encrypt1(flag)<br>m1 = bytes_to_long(m1)<br>m2 = bytes_to_long(m2)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n_2 = &#x27;</span> + <span class="hljs-built_in">str</span>(n_2))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n_3 = &#x27;</span> + <span class="hljs-built_in">str</span>(n_3))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;e_1 = &#x27;</span> + <span class="hljs-built_in">str</span>(e_1))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;e_2 = &#x27;</span> + <span class="hljs-built_in">str</span>(e_2))<br><br>encrypt2(m1,n_1)<br>encrypt3(n_1,n_2)<br>encrypt4(m2)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">n_2 = 675835056744450121024004008337170937331109883435712066354955474563267257037603081555653829598886559337325172694278764741403348512872239277008719548968016702852609803016353158454788807563316656327979897318887566108985783153878668451688372252234938716250621575338314779485058267785731636967957494369458211599823364746908763588582489400785865427060804408606617016267936273888743392372620816053927031794575978032607311497491069242347165424963308662091557862342478844612402720375931726316909635118113432836702120449010</span><br><span class="hljs-string">n_3 = 91294511667572917673898699346231897684542006136956966126836916292947639514392684487940336406038086150289315439796780158189004157494824987037667065310517044311794725172075653186677331434123198117797575528982908532086038107428540586044471407073066169603930082133459486076777574046803264038780927350142555712567</span><br><span class="hljs-string">e_1 = 65537</span><br><span class="hljs-string">e_2 = 3</span><br><span class="hljs-string">c_1 = 47029848959680138397125259006172340325269302342762903311733700258745280761154948381409328053449580957972265859283407071931484707002138926840483316880087281153554181290481533</span><br><span class="hljs-string">c_2 = 332431</span><br><span class="hljs-string">c_3 = 11951299411967534922967467740790967733301092706094553308467975774492025797106594440070380723007894861454249455013202734019215071856834943490096156048504952328784989777263664832098681831398770963056616417301705739505187754236801407014715780468333977293887519001724078504320344074325196167699818117367329779609</span><br><span class="hljs-string">m = 9530454742891231590945778054072843874837824815724564463369259282490619049557772650832818763768769359762168560563265763313176741847581931364</span><br><span class="hljs-string">k = 8139616873420730499092246564709331937498029453340099806219977060224838957080870950877930756958455278369862703151353509623205172658012437573652818022676431</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>

<p>解<code>m1</code>要先求出<code>n_1</code>，<code>n_1</code>的加密为低指数加密，爆破可以得出<code>n_1</code>，yafu分解然后解密<code>c_1</code>。</p>
<p><code>m2</code>部分根据代码有公式<br>$$<br>\begin{cases}<br>m_2 &#x3D; m + t*k\\<br>c_3 &#x3D; m^{e_2}\mod n_3<br>\end{cases}<br>&#x3D;&#x3D;&gt;c_3&#x3D;(m_2-t*k)^{e_2}\mod n_3<br>$$<br>于是在模$n_3$的域上构造$f &#x3D; (m_2-t*k)^{e_2} - c_3$ ，解出$t&#x3D;0$，即$m_2&#x3D;m$。</p>
<p>$m_1$，$m_2$解出来的有重叠部分，需去除。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> hexlify,unhexlify<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> iroot,invert<br><br><span class="hljs-comment">#n_2是偶数</span><br>n_2 = <span class="hljs-number">675835056744450121024004008337170937331109883435712066354955474563267257037603081555653829598886559337325172694278764741403348512872239277008719548968016702852609803016353158454788807563316656327979897318887566108985783153878668451688372252234938716250621575338314779485058267785731636967957494369458211599823364746908763588582489400785865427060804408606617016267936273888743392372620816053927031794575978032607311497491069242347165424963308662091557862342478844612402720375931726316909635118113432836702120449010</span><br>n_3 = <span class="hljs-number">91294511667572917673898699346231897684542006136956966126836916292947639514392684487940336406038086150289315439796780158189004157494824987037667065310517044311794725172075653186677331434123198117797575528982908532086038107428540586044471407073066169603930082133459486076777574046803264038780927350142555712567</span><br>e_1 = <span class="hljs-number">65537</span><br>e_2 = <span class="hljs-number">3</span><br>c_1 = <span class="hljs-number">47029848959680138397125259006172340325269302342762903311733700258745280761154948381409328053449580957972265859283407071931484707002138926840483316880087281153554181290481533</span><br>c_2 = <span class="hljs-number">332431</span><br>c_3 = <span class="hljs-number">11951299411967534922967467740790967733301092706094553308467975774492025797106594440070380723007894861454249455013202734019215071856834943490096156048504952328784989777263664832098681831398770963056616417301705739505187754236801407014715780468333977293887519001724078504320344074325196167699818117367329779609</span><br>m = <span class="hljs-number">9530454742891231590945778054072843874837824815724564463369259282490619049557772650832818763768769359762168560563265763313176741847581931364</span><br>k = <span class="hljs-number">8139616873420730499092246564709331937498029453340099806219977060224838957080870950877930756958455278369862703151353509623205172658012437573652818022676431</span><br><br><span class="hljs-comment">#低指数爆破</span><br>t = <span class="hljs-number">0</span><br>tmp = c_2<br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span>(iroot(tmp,<span class="hljs-number">3</span>)[<span class="hljs-number">1</span>]):<br>        n_1 = iroot(tmp,<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;n_1 = <span class="hljs-subst">&#123;n_1&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;t=<span class="hljs-subst">&#123;t&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">break</span><br>    tmp += n_2<br>    t += <span class="hljs-number">1</span><br><br><span class="hljs-comment">#yafu n_1</span><br>p = <span class="hljs-number">2224243981</span><br>q = <span class="hljs-number">2732337821</span><br>r = <span class="hljs-number">11585031296201346891716939633970482508158508580350404805965250133832632323150440185890235814142601827544669601048550999405490149435265122374459158586377571</span><br><br>phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)*(r-<span class="hljs-number">1</span>)<br>d = invert(e_1,phi)<br>m1 = <span class="hljs-built_in">pow</span>(c_1,d,n_1)<br><span class="hljs-comment"># print(long_to_bytes(m1))</span><br><span class="hljs-comment">#0x666c61677b3230366538353964</span><br>mm = <span class="hljs-number">0x666c61677b3230366538353964</span><br>flag1 = long_to_bytes(mm)<br><span class="hljs-built_in">print</span>(flag1)<br><span class="hljs-string">&#x27;&#x27;&#x27;sage</span><br><span class="hljs-string">n_3 = 91294511667572917673898699346231897684542006136956966126836916292947639514392684487940336406038086150289315439796780158189004157494824987037667065310517044311794725172075653186677331434123198117797575528982908532086038107428540586044471407073066169603930082133459486076777574046803264038780927350142555712567</span><br><span class="hljs-string">e_2 = 3</span><br><span class="hljs-string">c_3 = 11951299411967534922967467740790967733301092706094553308467975774492025797106594440070380723007894861454249455013202734019215071856834943490096156048504952328784989777263664832098681831398770963056616417301705739505187754236801407014715780468333977293887519001724078504320344074325196167699818117367329779609</span><br><span class="hljs-string">m = 9530454742891231590945778054072843874837824815724564463369259282490619049557772650832818763768769359762168560563265763313176741847581931364</span><br><span class="hljs-string">k = 8139616873420730499092246564709331937498029453340099806219977060224838957080870950877930756958455278369862703151353509623205172658012437573652818022676431</span><br><span class="hljs-string">p.&lt;x&gt; = PolynomialRing(Zmod(n_3))</span><br><span class="hljs-string">f= (m+x*k)^3 - c_3</span><br><span class="hljs-string">print(f.monic().small_roots())</span><br><span class="hljs-string"># [0]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">assert</span> m**<span class="hljs-number">3</span> % n_3 == c_3<br>flag2 = unhexlify(long_to_bytes(m))<br><span class="hljs-built_in">print</span>(flag2)<br><span class="hljs-comment">#有重复的字符</span><br><span class="hljs-comment"># flag&#123;206e859d859d8e854c4f600cb12757bbf9f5&#125;</span><br><span class="hljs-comment"># DASCTF&#123;206e859d8e854c4f600cb12757bbf9f5&#125;</span><br></code></pre></td></tr></table></figure>



<h2 id="Proof-Yourself"><a href="#Proof-Yourself" class="headerlink" title="Proof_Yourself"></a>Proof_Yourself</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2 <span class="hljs-keyword">as</span> gy<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> functools<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> os<br><br>_N = gy.next_prime(<span class="hljs-number">2</span> ** <span class="hljs-number">512</span>)<br>_rand_int = functools.partial(random.SystemRandom().randint, <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Encryptor</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.priKey = <span class="hljs-literal">None</span><br>        self.r = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__gen_prime__</span>(<span class="hljs-params">self, rs, n_bits</span>):<br>        p = gy.mpz_urandomb(rs, n_bits)<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> gy.is_prime(p):<br>            p += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> p<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__key_gen__</span>(<span class="hljs-params">self, n_bits=<span class="hljs-number">512</span></span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            rs = gy.random_state(datetime.now().microsecond)<br>            p = self.__gen_prime__(rs, n_bits)<br>            q = self.__gen_prime__(rs, n_bits)<br>            n = p * q<br>            lmd = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> gy.gcd(n, lmd) == <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">break</span><br><br>        g = n + <span class="hljs-number">1</span><br>        mu = gy.invert(lmd, n)<br>        self.pubKey = [n, g]<br>        self.priKey = [lmd, mu]<br>        <span class="hljs-keyword">return</span> (self.pubKey, self.priKey)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encipher</span>(<span class="hljs-params">self, plaintext</span>):<br>        m = plaintext<br>        n, g = self.pubKey<br>        <span class="hljs-keyword">if</span> self.r <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            r = gy.mpz_random(gy.random_state(datetime.now().microsecond), n)<br>            <span class="hljs-keyword">while</span> gy.gcd(n, r) != <span class="hljs-number">1</span>:<br>                r += <span class="hljs-number">1</span><br>            self.r = r<br>        <span class="hljs-keyword">else</span>:<br>            r = self.r<br>        ciphertext = gy.powmod(g, m, n ** <span class="hljs-number">2</span>) * gy.powmod(r, n, n ** <span class="hljs-number">2</span>) % (n ** <span class="hljs-number">2</span>)<span class="hljs-comment">#Paillier同态加密</span><br>        <span class="hljs-keyword">return</span> ciphertext<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decipher</span>(<span class="hljs-params">self, ciphertext</span>):<br>        <span class="hljs-comment"># The decryption process is hidden</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0xffffffff</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Proof</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.proof_param = <span class="hljs-literal">None</span><br>        self.pre_param = <span class="hljs-literal">None</span><br>        self.d = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params">self, pk, c1, c2, c3, m1, m2, r1, r2, r3</span>):<br>        self.pubKey = pk<br>        self.proof_param = [c1, c2, c3, m1, m2, r1, r2, r3]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pre_work_verify</span>(<span class="hljs-params">self</span>):<br>        c1, c2, c3, m1, m2, r1, r2, r3 = self.proof_param<br>        m4 = gy.mpz_random(gy.random_state(datetime.now().microsecond), self.pubKey[<span class="hljs-number">0</span>])<br>        pai = Encryptor()<br>        pai.pubKey = self.pubKey<br>        c4 = pai.encipher(m4)<br>        r4 = pai.r<br>        pai.r = <span class="hljs-literal">None</span> <span class="hljs-comment">#然后会重新生成r</span><br><br>        c5 = pai.encipher(m2 * m4)<br>        r5 = pai.r<br>        pai.r = <span class="hljs-literal">None</span><br><br>        self.pre_param = [c4, m4, r4, c5, r5]<br>        <span class="hljs-keyword">return</span> c4, c5<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_d</span>(<span class="hljs-params">self, d</span>):<br>        self.d = d<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">self</span>):<br>        n_2q = self.pubKey[<span class="hljs-number">0</span>] ** <span class="hljs-number">2</span><br>        c1, c2, c3, m1, m2, r1, r2, r3 = self.proof_param<br>        c4, m4, r4, c5, r5 = self.pre_param<br>        d = self.d<br><br>        e = d * m1 + m4<br>        a1 = <span class="hljs-built_in">pow</span>(r1, d, n_2q) * r4 % n_2q<br>        b1 = r5 * <span class="hljs-built_in">pow</span>(r3, d, n_2q) % n_2q<br>        a2 = <span class="hljs-built_in">pow</span>(r2, e, n_2q) * gy.invert(b1, n_2q) % n_2q<br>        b2 = <span class="hljs-built_in">pow</span>(c3, d, n_2q) * c5 % n_2q<br><br>        enc = Encryptor()<br>        enc.pubKey = self.pubKey<br>        enc.r = <span class="hljs-built_in">pow</span>(r1, d, n_2q) * r4 % n_2q<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">pow</span>(c1, d, n_2q) * c4 % n_2q != enc.encipher(d * m1 + m4): <span class="hljs-comment"># 这里要 ==</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        enc.r = a2<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(c2, e, n_2q) * gy.invert(b2, n_2q) % n_2q == enc.encipher(<span class="hljs-number">0</span>) <span class="hljs-comment">#必须从这里返回，且为True</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MProof</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.priKey = <span class="hljs-literal">None</span><br>        self.cs = <span class="hljs-literal">None</span><br>        self.rs = <span class="hljs-literal">None</span><br>        self.k = <span class="hljs-literal">None</span><br>        self.t = <span class="hljs-number">9</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_param</span>(<span class="hljs-params">self, pk, cs, rs, k</span>):<br>        self.pubKey = pk[<span class="hljs-number">0</span>]<br>        self.priKey = pk[<span class="hljs-number">1</span>]<br>        self.cs = cs<br>        self.rs = rs<br>        self.k = k<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">self, d</span>):<br>        enc = Encryptor()<br>        enc.pubKey = self.pubKey<br>        enc.priKey = self.priKey<br>        cs = self.cs<br>        rs = self.rs<br>        k = self.k<br>        t = self.t<br>        <span class="hljs-keyword">assert</span> k == enc.decipher(cs[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, t - <span class="hljs-number">1</span>):<br>            c1 = cs[<span class="hljs-number">0</span>]<br>            c2 = cs[i - <span class="hljs-number">1</span>]<br>            c3 = cs[i]<br>            m2 = enc.decipher(cs[i - <span class="hljs-number">1</span>])<br>            r1 = rs[<span class="hljs-number">0</span>]<br>            r2 = rs[i - <span class="hljs-number">1</span>]<br>            r3 = rs[i]<br><br>            proof = Proof()<br>            proof.setup(self.pubKey, c1, c2, c3, k, m2, r1, r2, r3)<br><br>            proof.pre_work_verify()<br>            proof.set_d(d)<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> proof.verify(): <span class="hljs-comment"># 这里要返回True</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    flag = os.environ[<span class="hljs-string">&quot;flag for GFCTF2022-Crypto Proof Yourself&quot;</span>]<br>    k = _rand_int(_N - <span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;k: &quot;</span>, k)<br>    d = _rand_int(_N - <span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;d: &quot;</span>, d)<br>    param = <span class="hljs-built_in">eval</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;please proof yourself: &quot;</span>))<br><br>    cs = param[<span class="hljs-string">&#x27;cs&#x27;</span>]<br>    rs = param[<span class="hljs-string">&#x27;rs&#x27;</span>]<br>    pk = param[<span class="hljs-string">&#x27;pk&#x27;</span>]<br><br>    <span class="hljs-built_in">print</span>(pk[<span class="hljs-number">0</span>])<br>    <span class="hljs-built_in">print</span>(rs)<br>    mp = MProof()<br>    mp.generate_param(pk, cs, rs, k)<br>    <span class="hljs-keyword">if</span> mp.verify(d):<br>        s = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cs:<br>            s *= i<br>            s %= _N<br>        aes = AES.new(<span class="hljs-built_in">str</span>(s)[:<span class="hljs-number">32</span>].encode(), AES.MODE_ECB)<br>        flag = flag.encode()<br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(flag) % AES.block_size != <span class="hljs-number">0</span>:<br>            flag += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>        c = aes.encrypt(flag)<br>        c = base64.b64encode(c)<br>        <span class="hljs-built_in">print</span>(c)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;you&#x27;re not yourself!&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br><br></code></pre></td></tr></table></figure>



<ul>
<li><p>MProof类中的verify()部分</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">k</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> enc.decipher(cs[<span class="hljs-number">0</span>])<br><span class="hljs-attribute">m2</span> <span class="hljs-operator">=</span> enc.decipher(cs[i - <span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure>

<p>说明 $k(m_1)$ 与 $c_1(cs[0])$是一组明密文，$m_2$ 与 $c_2(cs[i-1])$是一组明密文。</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-built_in">proof</span>.pre_work_verify()<br></code></pre></td></tr></table></figure>

<p>说明$c_4,m_4,r_4$是一组，$c_5,m_2*m_4$是一组。</p>
</li>
<li><p>Proof类中的verify()部分</p>
<p>就是一堆公式然后不断化简。</p>
<p>首先我们要明确verify返回的值必须是True，也就是从最后一个return返回，所以以下两个等式成立</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">① <span class="hljs-built_in">pow</span>(c1, d, n_2q) * c4 % n_2q == enc.encipher(d * m1 + m4)<br>② <span class="hljs-built_in">pow</span>(c2, e, n_2q) * gy.invert(b2, n_2q) % n_2q == enc.encipher(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>

<p>根据代码有以下公式<br>$$<br>\begin{cases}<br>\quad e &#x3D; d*m_1+m_4\\<br>\quad a_1 &#x3D; r_1^d*r_4 \% n^2\\<br>\quad b_1 &#x3D; r_5*r_3^d \% n^2\\<br>\quad a_2 &#x3D; r_2^e*b_1^{-1} \% n^2\\<br>\quad b_2 &#x3D; c_3^d*c_5 \% n^2\\<br>\quad r &#x3D; r_1^d*r_4 \% n^2(在①中)\\<br>\quad r &#x3D; r_2^e*b_1^{-1} \% n^2(在②中)<br>\end{cases}<br>$$<br>对①进行化简，有<br>$$<br>\begin{align}<br>c_1^d*c_4 &amp;≡ g^{d*m_1+m_4}*r^n \mod n^2\\<br>c_1^d*c_4 &amp;≡ g^{d*m_1}*g^{m_4}*r_1^{d*n}*r_4^n \mod n^2\\<br>c_1^d &amp;≡ g^{d*m_1}*r_1^{d*n} \mod n^2\\<br>c_1 &amp;≡ g^{m_1}*r_1^n \mod n^2\<br>\end{align}<br>$$<br>因为不可能从这里返回False，所以$c_1,m_1,r_1$是一组。</p>
<p>对②进行化简，有<br>$$<br>\begin{align}<br>c_2^e*b_2^{-1}&amp;≡r^n \mod n^2\\<br>c_2^e*b_2^{-1} &amp;≡ r_2^{e*n}*b_1^{-n} \mod n^2\\<br>c_2^{e}*b_1^n&amp;≡r_2^{e*n}*b_2 \mod n^2\\<br>c_2^{e}*r_5^n*r_3^{d*n}&amp;≡r_2^{e*n}*c_3^d*c_5 \mod n^2\\<br>c_2^e*(g^{m_2*m_4}*r_5^n)*r_3^{d*n} &amp;≡ r_2^{e*n}*c_3^d*c_5*g^{m_2*m_4} \mod n^2\\<br>c_2^e*r_3^{d*n} &amp;≡ r_2^{e*n}*c_3^d*g^{m_2*m_4} \mod n^2\\<br>g^{e*m_2}*(c_2^e)*(g^{m_3*d}*r_3^{d*n})&amp;≡(g^{e*m_2}*r_2^{e*n})*(c_3^d)*g^{m_3*d}*g^{m_2*m_4} \mod n^2\\<br>g^{e*m_2}*(c_2^e)*(g^{m_3}*r_3^n)^d&amp;≡(g^{m_2}*r_2^n)^e*(c_3^d)*g^{m_3*d+m_2*m_4}\mod n^2<br>\end{align}<br>$$<br>因为是Paillier同态加密，要使得②成立，极有可能是$m_2,c_2,r_2$和$m_3,c_3,r_3$分别为一组。故<br>$$<br>\begin{align}<br>g^{e*m_2}&amp;≡g^{m_3*d+m_2*m_4}\mod n^2\\<br>e*m_2 &amp;≡ m_3*d+m_2*m_4\mod φ(n^2)\\<br>m_1*m_2&amp;≡m_3\mod φ(n^2)<br>\end{align}<br>$$<br>因为我们要求$c_i(即cs[i])$，所以将上述等式转换为<br>$$<br>\begin{align}<br>m_1*m_2&amp;≡m_3\mod φ(n^2)\\<br>g^{m_1*m_2} &amp;≡ g^{m_3} \mod n^2\\<br>c_3 &amp;≡ g^{m_1*m_2}*r_3^n \mod n^2\\<br>cs_i &amp;≡ g^{m_0*m_{i-1}}*r_i^n \mod n^2 \quad,i∈[1,t-1](转换成跟cs_i对应的下标)<br>\end{align}<br>$$<br>前面的等式①的推导已经得到了$cs_0$的加密公式为<br>$$<br>cs_0 ≡ g^{m_0}*r_0^n\mod n^2<br>$$<br>然后根据MProof.verify()中的for循环，有<br>$$<br>\begin{align}<br>i&#x3D;1时,有m_1&amp;&#x3D;m_0*m_0&#x3D;k^2\\<br>i&#x3D;2时,有m_2&amp;&#x3D;m_0*m_1&#x3D;k^3\\…<br>\end{align}<br>$$<br>而$m_0 &#x3D; k$，故$m_i &#x3D; k^{(i+1)}$，$i∈[0,t-1]$。故求$cs_i和cs_0$的公式可合并为<br>$$<br>cs_i ≡ g^{k^{(i+1)}}*r_i^n \mod n^2 \quad,i∈[0,t-1]<br>$$</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> gmpy2<br><br>t = <span class="hljs-number">9</span><br>k = <span class="hljs-number">11279504534075664648994853756208309836888259081316987836068134565254532996039360827546417609514423428910384542842117375028420780633866653159695275393368525</span><br>d = <span class="hljs-number">10221665185656075870670995630062725196664430105025904882602057721789662854574978018794504264934209067929011475979200882531626936657436063908347321906634698</span><br>n, g = pk = [<span class="hljs-number">48818225666351727287207574448645102762537417687444983843100304919285725062598967011116889972414214836241381602471131430626879759533369143920487299838261148460925610689261484965443528954172944323770181595455493018560585886136460076911284321702606299935385905187490733877700172236929823996030434548431963845417</span>, <span class="hljs-number">48818225666351727287207574448645102762537417687444983843100304919285725062598967011116889972414214836241381602471131430626879759533369143920487299838261148460925610689261484965443528954172944323770181595455493018560585886136460076911284321702606299935385905187490733877700172236929823996030434548431963845418</span>]<br>rs = [<span class="hljs-number">7017835444643249654271082822123622319668823350427792339866057586668389112104752762656197513200543360993520983724957230042201508973227162755834455588213955577427129770220944523362675094151087610149577572745132843096125306714661937578722687485657829513505193501779196974947234280267216675125252078851200384511</span>, <span class="hljs-number">11926419785881734844311665235521692826579887231998046623960612782040667947241499738956574205257924912658501445776452678070116549164041547529876699253294424780763676555577471679864402445858336882095147665188840642566915806261768356998922735189200720213585973193760859762565499482788728104626011895319246070666</span>, <span class="hljs-number">42849056994192303821377400100288133996583852078950720125488290595760149056455393645072193770289570081775019724341661792638180771853532605128714550478335577195726229688940314874397525687446284173037582151644404387768530054222357908795147990398041926171515316417608763369700129500666902309717940977358807727525</span>, <span class="hljs-number">569456034348887900543839220414996643340590767934767190156995758515165897120739581783360541347732807472270912131379832279120488198273011491688831841399829273608264595546111772893429063435258947915507670361144515456182164834954215193382047579447153761545329658264080907041640135001986168270265476743567482692</span>, <span class="hljs-number">3882702856238247498776796661311784006527802920550510293689922477675526354665322642479849874736259591551374176143098918760791897417239069537473431992448934909453262242143947844529634470612342500819944459175262578570970986439077317400529787443727039336276584314877540411569781766947088676007567558786204756622</span>, <span class="hljs-number">34782235652997768305926510863494232383450368915240504241174297907018847182768375070693257841105403770877838315164696945795337955510221866283665914601590428884905858716454103802020812133141150426745257298797890891272342044576267512614330845263269719988690131903885166576787904418689220619969803389055644879283</span>, <span class="hljs-number">41592967491176047854989428284345162501007190601227408901070248204262133730525966700579489348638677097892234799114781714483501047161590906530561145043956218048476973681993844049727301616425300184917461748554561251157129032137452031152035104390819324726028213814331358281835310137578997975640720667608761964678</span>, <span class="hljs-number">2578609445428238934369429276761562264275224240462388961086309951471476260768389780485799474959219453117497280460546287104687546269870223859389440049894002336889078632572487931627548008400365190508858547984095575105551066221392543458691134989381950316158817283668533035090342510306180189918351739923749743570</span>]<br><span class="hljs-comment">#len(rs) = 8</span><br>_N = gmpy2.next_prime(<span class="hljs-number">2</span> ** <span class="hljs-number">512</span>)<br>c = <span class="hljs-string">b&#x27;Oq5bkAPCCT6W3CskX+2uqtY5wrhs+2DqupzjIJ0u/Yl0m/Ig1/uvrSWdezrqLxHG&#x27;</span><br><br>cs = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rs))]<br>n_2 = n**<span class="hljs-number">2</span><br><span class="hljs-comment"># cs[0] = pow(g, k, n_2)*pow(rs[0], n, n_2) % n_2</span><br>m_list = [k**(i+<span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rs))]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rs)):<br>    cs[i] = <span class="hljs-built_in">pow</span>(g, m_list[i], n_2)*<span class="hljs-built_in">pow</span>(rs[i], n, n_2) % n_2<br><br>s = <span class="hljs-number">1</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cs:<br>    s *= i<br>    s %= _N<br>aes = AES.new(<span class="hljs-built_in">str</span>(s)[:<span class="hljs-number">32</span>].encode(), AES.MODE_ECB)<br>c = base64.b64decode(c)<br>flag = aes.decrypt(c)<br><span class="hljs-built_in">print</span>(flag)<br><br></code></pre></td></tr></table></figure>



<h2 id="Recover-Secret"><a href="#Recover-Secret" class="headerlink" title="Recover_Secret"></a>Recover_Secret</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2 <span class="hljs-keyword">as</span> gy<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> functools<br><span class="hljs-keyword">import</span> libnum<br><span class="hljs-keyword">from</span> Crypto.Util <span class="hljs-keyword">import</span> number<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><br>of = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;output&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br>sys.stdout = of<br>_N = gy.next_prime(<span class="hljs-number">2</span> ** <span class="hljs-number">512</span>)<br>_rand_int = functools.partial(random.SystemRandom().randint, <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Encryptor</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.priKey = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__gen_prime__</span>(<span class="hljs-params">self, rs, n_bits</span>):<br>        p = gy.mpz_urandomb(rs, n_bits)<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> gy.is_prime(p):<br>            p += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> p<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__key_gen__</span>(<span class="hljs-params">self, n_bits=<span class="hljs-number">512</span></span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            rs = gy.random_state(datetime.now().microsecond)<br>            p = self.__gen_prime__(rs, n_bits)<br>            q = self.__gen_prime__(rs, n_bits)<br>            n = p * q<br>            lmd = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> gy.gcd(n, lmd) == <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">break</span><br><br>        g = n + <span class="hljs-number">1</span><br>        mu = gy.invert(lmd, n)<br>        self.pubKey = [n, g]<br>        self.priKey = [lmd, mu]<br>        <span class="hljs-keyword">return</span> (self.pubKey, self.priKey)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encipher</span>(<span class="hljs-params">self, plaintext</span>):<br>        m = plaintext<br>        n, g = self.pubKey<br>        r = gy.mpz_random(gy.random_state(datetime.now().microsecond), n)<br>        <span class="hljs-keyword">while</span> gy.gcd(n, r) != <span class="hljs-number">1</span>:<br>            r += <span class="hljs-number">1</span><br>        ciphertext = gy.powmod(g, m, n ** <span class="hljs-number">2</span>) * gy.powmod(r, n, n ** <span class="hljs-number">2</span>) % (n ** <span class="hljs-number">2</span>) <span class="hljs-comment">#Paillier同态加密</span><br>        <span class="hljs-keyword">return</span> ciphertext<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Commit</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.param = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__key_gen__</span>(<span class="hljs-params">self, n</span>): <span class="hljs-comment"># 参数n相同，则产生的q,g,h相同</span><br>        p = n<br>        r = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            q = r * p + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> gy.is_prime(q):<br>                <span class="hljs-keyword">break</span><br>            r += <span class="hljs-number">1</span><br>        x = q - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            g = x ** r % q<br>            <span class="hljs-keyword">if</span> g != <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">break</span><br>            x -= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            h = x ** r % q<br>            <span class="hljs-keyword">if</span>(g != h <span class="hljs-keyword">and</span> h != <span class="hljs-number">1</span>):<br>                <span class="hljs-keyword">break</span><br>            x -= <span class="hljs-number">1</span><br>        self.param = q, g, h<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">commit</span>(<span class="hljs-params">self, m</span>):<br>        q, g, h = self.param<br>        r = number.getRandomRange(<span class="hljs-number">1</span>, q - <span class="hljs-number">1</span>)<br>        c = (<span class="hljs-built_in">pow</span>(g, m, q) * <span class="hljs-built_in">pow</span>(h, r, q)) % q <span class="hljs-comment">#Benaloh加密</span><br>        <span class="hljs-keyword">return</span> c, r<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">shuffle</span>(<span class="hljs-params">X, Y, x</span>):<br>    res = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(X)):<br>        res.append([i, X[i], Y[i]])<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(x):<br>            res.append([i, X[i] + random.randint(-X[i], X[i]), Y[i] + random.randint(-Y[i], Y[i])])<br>    random.shuffle(res) <span class="hljs-comment">#随机排序</span><br>    <span class="hljs-keyword">return</span> res<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    k = <span class="hljs-number">6</span><br>    sk = []<br>    flag = os.environ[<span class="hljs-string">&quot;flag for GFCTF2022-Crypto Recover Secret&quot;</span>]<br>    secret = libnum.s2n(flag)<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">bin</span>(secret)) &lt; <span class="hljs-number">514</span><br>    enc = Encryptor()<br>    sk = [enc.__key_gen__() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k)]<br>    <span class="hljs-built_in">print</span>(sk)<br><br>    s = [_rand_int(_N - <span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k)]<br>    s[<span class="hljs-number">0</span>] = secret<br><br>    v = Commit()<br>    v.__key_gen__(_N)<br>    <span class="hljs-built_in">print</span>(v.param)<br>    cr = [v.commit(s[i]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k)]<br>    c = [i[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cr]<br>    <span class="hljs-built_in">print</span>(c)<br><br>    X = []<br>    Y = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, k + <span class="hljs-number">1</span>):<br>        xs = <span class="hljs-number">1</span><br>        enc.pubKey = sk[i - <span class="hljs-number">1</span>][<span class="hljs-number">0</span>]  <span class="hljs-comment"># [n_i,g_i]</span><br>        n_2q = enc.pubKey[<span class="hljs-number">0</span>] ** <span class="hljs-number">2</span>  <span class="hljs-comment"># n_i^2</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>            xs *= <span class="hljs-built_in">pow</span>(enc.encipher(i ** j), cr[j][<span class="hljs-number">1</span>], n_2q)<br>        X.append(xs)<br><br>        ys = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>            ys *= <span class="hljs-built_in">pow</span>(enc.encipher(i ** j), s[j], n_2q)<br>        Y.append(ys)<br><br>    X_Y = shuffle(X, Y, <span class="hljs-number">51</span>)<br>    <span class="hljs-built_in">print</span>(X_Y)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<p>类Encryptor是Paillier同态加密，类Commit貌似是Benaloh加密。</p>
<p>重点在X、Y的生成以及shuffle混淆，先看X、Y的生成，他们的生成公式类似，为<br>$$<br>xs_i &#x3D; E(i^0,r_0)^{cr_0}*E(i^1,r_1)^{cr_1}*…*E(i^5,r_5)^{cr_5}\mod n_i^2 \tag{1}<br>$$</p>
<p>$$<br>ys_i &#x3D; E(i^0,r_0)^{s_0}*E(i^1,r_1)^{s_1}*…*E(i^5,r_5)^{s_5}\mod n_i^2 \tag{2}<br>$$</p>
<p>（这里的$cr$指$cr$中的$r$。）</p>
<p>根据Paillier同态加密的特点，有<br>$$<br>D(E(m_1,r_1),E(m_2,r_2)\mod n^2) &#x3D; m_1+m_2\mod n<br>$$</p>
<p>$$<br>D(E(m_1,r_1)^k\mod n^2)&#x3D;k*m\mod n<br>$$</p>
<p>于是公式(1)(2)的解密公式为<br>$$<br>D(xs_i) &#x3D; cr_0*i^0+…+cr_5*i^5 \mod n_i<br>$$</p>
<p>$$<br>D(ys_i) &#x3D; s_0*i^0+…+s_5*i^5 \mod n_i<br>$$</p>
<p>因为$xs,ys$都有6个，而系数已知，所以可以构建矩阵方程解出$cr_i,s_i$。</p>
<p>但是$X,Y$被打乱了顺序。</p>
<p>根据commit()函数，有<br>$$<br>c_i &#x3D; g^{s_i}*h^{cr_i}<br>$$<br>进行如下转换<br>$$<br>c_0 &#x3D; g^{s_0}*h^{cr_0}，c_1^i &#x3D; g^{s_1*i}*h^{cr_1*i},c_2^{i^2} &#x3D; g^{s_2*i^2}*h^{cr_2*i^2},…\<br>$$<br>于是有<br>$$<br>\begin{align}<br>c_0*c_1^i*c_2^{i^2}*…*c_5^{i^5}<br>&amp;&#x3D; g^{s_0+s_1*i+s_2*i^2+…+s_5*i^5}*h^{cr_0+c_r1*i+cr_2*i^2+…+cr_5*i^5}\\<br>&amp;&#x3D;g^{D(ys_i)}*h^{D(xs_i)}\mod q<br>\end{align}<br>$$<br>因此通过此等式可得到正确的$X,Y$。</p>
<p>求出$Y$后，因为有六个未知数和六个方程，所以建个矩阵求解<br>$$<br>{\left[<br>\matrix{<br>  s_0 &amp; s_1 &amp; … &amp; s_5<br>}<br>\right]}<br>*<br>\left[<br>\matrix{<br>  1^0 &amp; 2^0 &amp; … &amp; 5^0\\<br>  1^1 &amp; 2^1 &amp; … &amp; 5^1\\<br>  …\\<br>  1^6 &amp; 2^6 &amp; … &amp; 5^6<br>}<br>\right]<br>&#x3D;\left[<br>\matrix{<br>  dec\_y_0 &amp; dec\_y_1 &amp; … &amp; dec\_y_5<br>}<br>\right]<br>$$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> mpz,next_prime<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Encryptor</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.priKey = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decipher</span>(<span class="hljs-params">self, ciphertext</span>):<br>        n, g = self.pubKey<br>        lmd, mu = self.priKey<br>        plaintext = (<span class="hljs-built_in">pow</span>(ciphertext, lmd, n**<span class="hljs-number">2</span>) - <span class="hljs-number">1</span>)*mu//n % n <span class="hljs-comment"># Paillier同态解密</span><br>        <span class="hljs-comment"># plaintext = (pow(ciphertext, lmd, n ** 2) - 1) // n  * mu % n</span><br>        <span class="hljs-keyword">return</span> plaintext<br><br><br>_N = next_prime(<span class="hljs-number">2</span> ** <span class="hljs-number">512</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;output&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    sk = <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    vparam = <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    c = <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    X_Y = <span class="hljs-built_in">eval</span>(f.readline().decode())<br><br>X_Y = <span class="hljs-built_in">sorted</span>(X_Y, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])<br>k = <span class="hljs-number">6</span><br>q, g, h = vparam<br><br><br>m_cs = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, k + <span class="hljs-number">1</span>):<br>    cs = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>        cs = cs * <span class="hljs-built_in">pow</span>(c[j], i**j, q) % q <span class="hljs-comment">#错误操作-&gt; cs *= pow(c[j], i**j, q) % q 取余在相乘</span><br>    m_cs.append(cs)<br><br><br>real_XY = []<br>enc = Encryptor()<br><span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> X_Y:<br>    i = each[<span class="hljs-number">0</span>]<br>    enc.pubKey = sk[i][<span class="hljs-number">0</span>]<br>    enc.priKey = sk[i][<span class="hljs-number">1</span>]<br>    de_xs = enc.decipher(each[<span class="hljs-number">1</span>])<br>    de_ys = enc.decipher(each[<span class="hljs-number">2</span>])<br>    gh = <span class="hljs-built_in">pow</span>(g, de_ys, q)*<span class="hljs-built_in">pow</span>(h, de_xs, q) % q<br>    <span class="hljs-keyword">if</span> gh == m_cs[i]:<br>        real_XY.append([i, de_xs, de_ys])<br><br><span class="hljs-comment"># print(real_XY)</span><br>k = <span class="hljs-number">6</span><br>Y = [<span class="hljs-built_in">int</span>(each[<span class="hljs-number">2</span>]) <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> real_XY]<br>Y = Matrix(Y)<br><br>A = []<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>    v = [i**j <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,k+<span class="hljs-number">1</span>)]<br>    A.append(v)<br>A = Matrix(A)<br><br>S = A.solve_left(Y)<br><span class="hljs-built_in">print</span>(S)<br><span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-built_in">int</span>(S[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>])))<br><br></code></pre></td></tr></table></figure>







<hr>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU1MzE3Njg2Mw==&mid=2247502987&idx=1&sn=39df1e5a1638db91f716f975fbeb69c1&chksm=fbf456fbcc83dfedf587a21112de8e6fae17942e848974c5eafd827ab94af9d65aa87bef424b&mpshare=1&scene=23&srcid=1025Lu8HWtUrWliFNcbdKzJS&sharer_sharetime=1666670305035&sharer_shareid=c677d9dd25d4fd3a57ca8bd9a85e6569#rd">DASCTF X GFCTF 2022 ｜十月赛官方Write Up (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://lazzzaro.github.io/2020/05/13/crypto-%E5%85%B6%E4%BB%96%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/#Paillier%E5%90%8C%E6%80%81%E5%8A%A0%E5%AF%86">其他加密算法 | Lazzaro (lazzzaro.github.io)</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Crypto/" class="category-chain-item">Crypto</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E4%BD%8E%E6%8C%87%E6%95%B0%E7%88%86%E7%A0%B4/">#低指数爆破</a>
      
        <a href="/tags/Paillier/">#Paillier</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>2022DASTF十月赛</div>
      <div>http://example.com/2022/10/26/CTF/2022DASTF十月赛/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>gla2xy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年10月26日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/04/CTF/BUUCTF_Reverse_Prombles%20Of%20Page%20One/" title="BUUCTF-Reverse——Prombles Of Page One">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">BUUCTF-Reverse——Prombles Of Page One</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/24/CTF/2022%E8%B5%A3%E8%82%B2%E6%9D%AF/" title="2022赣育杯">
                        <span class="hidden-mobile">2022赣育杯</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
