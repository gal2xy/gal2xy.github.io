<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>OLLVMç§»æ¤åˆ°LLVM14</title>
    <link href="/2024/04/17/OLLVM%E7%A7%BB%E6%A4%8D%E5%88%B0LLVM14/"/>
    <url>/2024/04/17/OLLVM%E7%A7%BB%E6%A4%8D%E5%88%B0LLVM14/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>ç”±äºOLLVMåªæ”¯æŒåˆ°ç‰ˆæœ¬4åå°±ä¸å†æ›´æ–°äº†ï¼Œç„¶è€ŒLLVMå·²ç»æ›´æ–°åˆ°äº†ç‰ˆæœ¬18äº†ã€‚æ•…æœ¬æ–‡ä¸»è¦ç›®çš„æ˜¯å°†OLLVMç§»æ¤åˆ°LLVM14ä¸Šã€‚è¿™é‡Œå‚è€ƒäº†<a href="https://github.com/buffcow/ollvm-project%E3%80%82">https://github.com/buffcow/ollvm-projectã€‚</a></p><p>æ ¹æ®é¡¹ç›®ä¸­çš„æäº¤è®°å½•ï¼Œå¯ä»¥å°†ä¿®æ”¹åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ul><li>ç§»æ¤ollvm&#x2F;obfuscator&#x2F;lib&#x2F;Transforms&#x2F;Obfuscationç›®å½•ï¼ˆç§»æ¤ollvmçš„Obfuscationçš„*.cppï¼‰ã€‚</li><li>ç§»æ¤ollvm&#x2F;obfuscator&#x2F;include&#x2F;llvm&#x2F;Transforms&#x2F;Obfuscationç›®å½•ï¼ˆç§»æ¤ollvmçš„Obfuscationçš„*.hï¼‰ã€‚</li><li>ä¿®æ”¹LLVMæºç ï¼Œä½¿ç§»æ¤ä»£ç ç”Ÿæ•ˆã€‚</li></ul><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404161712856.png"></p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404161713162.png"></p><h1 id="äºŒã€ç§»æ¤Obfuscationä¸­çš„-cpp"><a href="#äºŒã€ç§»æ¤Obfuscationä¸­çš„-cpp" class="headerlink" title="äºŒã€ç§»æ¤Obfuscationä¸­çš„*.cpp"></a>äºŒã€ç§»æ¤Obfuscationä¸­çš„*.cpp</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404161715141.png"></p><p>å»ºè®®ç›´æ¥å°†è¯¥é¡¹ç›®ä¸­çš„è¿™éƒ¨ä»½å¤åˆ¶è¿‡å»ã€‚å¦‚æœç§»æ¤çš„æ˜¯ollvmçš„æºç ï¼Œè¿˜éœ€è¦ä¿®æ”¹è¿™äº›ä»£ç ä¸­CryptoUtils.håº“çš„å¼•ç”¨ï¼š</p><figure class="highlight stan"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stan"><span class="hljs-meta">#include &quot;<span class="hljs-string">llvm</span>/C<span class="hljs-string">rypto</span>U<span class="hljs-string">tils.h</span>&quot;</span><br>æ”¹æˆ<br><span class="hljs-meta">#include &quot;<span class="hljs-string">llvm</span>/T<span class="hljs-string">ransforms</span>/O<span class="hljs-string">bfuscation</span>/C<span class="hljs-string">rypto</span>U<span class="hljs-string">tils.h</span>&quot;</span><br></code></pre></td></tr></table></figure><h1 id="ä¸‰ã€ç§»æ¤Obfuscationä¸­çš„-h"><a href="#ä¸‰ã€ç§»æ¤Obfuscationä¸­çš„-h" class="headerlink" title="ä¸‰ã€ç§»æ¤Obfuscationä¸­çš„*.h"></a>ä¸‰ã€ç§»æ¤Obfuscationä¸­çš„*.h</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404161716901.png"></p><p>å»ºè®®ç›´æ¥å°†è¯¥é¡¹ç›®ä¸­çš„è¿™éƒ¨ä»½å¤åˆ¶è¿‡å»ã€‚å¦‚æœç§»æ¤çš„æ˜¯ollvmçš„æºç ï¼ŒåŒæ ·ä¹Ÿéœ€è¦ä¿®æ”¹è¿™äº›ä»£ç ä¸­CryptoUtils.håº“çš„å¼•ç”¨ã€‚</p><h1 id="å››ã€ç§»æ¤ä»£ç ç”Ÿæ•ˆ"><a href="#å››ã€ç§»æ¤ä»£ç ç”Ÿæ•ˆ" class="headerlink" title="å››ã€ç§»æ¤ä»£ç ç”Ÿæ•ˆ"></a>å››ã€ç§»æ¤ä»£ç ç”Ÿæ•ˆ</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404161717849.png"></p><p>è¿™é‡Œè·Ÿç€ä¸Šé¢çš„æ­¥éª¤å¯¹LLVMæºç è¿›è¡Œä¿®æ”¹å°±è¡Œã€‚ï¼ˆä¸è¦å¤åˆ¶è¯¥é¡¹ç›®ä¸­çš„PassManagerBuilder.cppæºç ï¼Œç‰ˆæœ¬ä¹‹é—´å¯èƒ½æœ‰å¾®å°çš„å˜åŒ–ä»è€Œå¯¼è‡´ç¼–è¯‘æŠ¥é”™ï¼‰</p><h1 id="äº”ã€ç¼–è¯‘LLVM"><a href="#äº”ã€ç¼–è¯‘LLVM" class="headerlink" title="äº”ã€ç¼–è¯‘LLVM"></a>äº”ã€ç¼–è¯‘LLVM</h1><p>æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo cmake -S llvm -B build -G Ninja -DLLVM_ENABLE_PROJECTS=&quot;clang&quot; -DCMAKE_BUILD_TYPE=Release -DLLVM_INCLUDE_TESTS=OFF -DLLVM_ENABLE_NEW_PASS_MANAGER=OFF<br>sudo cmake --build build -j7<br></code></pre></td></tr></table></figure><p>çº¿ç¨‹æ•°è§†è‡ªå·±çš„è™šæ‹Ÿæœºçš„å¤„ç†å™¨æ•°é‡è€Œå®šã€‚</p><h1 id="å…­ã€æµ‹è¯•"><a href="#å…­ã€æµ‹è¯•" class="headerlink" title="å…­ã€æµ‹è¯•"></a>å…­ã€æµ‹è¯•</h1><p>æµ‹è¯•ä»£ç ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404161730876.png"></p><p>åœ¨LLVMé¡¹ç›®ç›®å½•ä¸‹çš„build&#x2F;binç›®å½•ä¸‹ï¼Œè¿›è¡Œæ ·ä¾‹æµ‹è¯•æ¥æ£€æŸ¥OLLVMæ˜¯å¦ç§»æ¤æˆåŠŸï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404161731812.png"></p><p><strong>æ³¨æ„ï¼Œæ˜¯<code>./clang</code>ï¼Œä¸æ˜¯<code>clang</code>ï¼Œå¦åˆ™å¦‚æœå½“å‰ç³»ç»Ÿç¯å¢ƒå­˜åœ¨clangï¼Œåˆ™ä¸ä¼šè°ƒç”¨å½“å‰ç›®å½•ä¸‹çš„clangã€‚</strong></p><p>æ‹–å…¥IDAä¸­ï¼Œå…¶æ§åˆ¶æµå›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404161728885.png"></p><p>å¯è§OLLVMæˆåŠŸçš„ç§»æ¤åˆ°äº†LLVM14ä¸­ï¼</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://github.com/buffcow/ollvm-project">https://github.com/buffcow/ollvm-project</a></p><p><a href="https://whitebird0.github.io/post/%E4%BB%8Ellvm%E5%88%B0ollvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">ä»LLVMåˆ°OLLVMå­¦ä¹ ç¬”è®° | Whitebirdâ€™s Home (whitebird0.github.io)</a></p>]]></content>
    
    
    <categories>
      
      <category>Obfuscation</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OLLVM</tag>
      
      <tag>ä»£ç æ··æ·†</tag>
      
      <tag>LLVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OLLVMæºç ç¼–è¯‘å’Œä½¿ç”¨</title>
    <link href="/2024/04/17/OLLVM%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%92%8C%E4%BD%BF%E7%94%A8/"/>
    <url>/2024/04/17/OLLVM%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%92%8C%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‡†å¤‡é˜¶æ®µ"><a href="#ä¸€ã€å‡†å¤‡é˜¶æ®µ" class="headerlink" title="ä¸€ã€å‡†å¤‡é˜¶æ®µ"></a>ä¸€ã€å‡†å¤‡é˜¶æ®µ</h1><h2 id="1-1-å·¥å…·é…ç½®"><a href="#1-1-å·¥å…·é…ç½®" class="headerlink" title="1.1 å·¥å…·é…ç½®"></a>1.1 å·¥å…·é…ç½®</h2><p>ç¼–è¯‘ollvméœ€è¦ç”¨åˆ°çš„å·¥å…·å¦‚ä¸‹ï¼š</p><ul><li>cmake</li><li>gcc 8.x</li><li>g++ 8.x</li></ul><p>gccå’Œg++çš„ç‰ˆæœ¬å¾—æ˜¯8.xçš„ç‰ˆæœ¬ï¼Œé€šè¿‡å¦‚ä¸‹æŒ‡ä»¤å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install gcc-8 g++-8 -y<br></code></pre></td></tr></table></figure><p>å¦‚æœ‰å¤šä¸ªç‰ˆæœ¬çš„gccå’Œg++ï¼Œéœ€é…ç½®ä¼˜å…ˆçº§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 8<br>sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-8 8<br>æˆ–è€…<br>sudo update-alternatives --config gcc  <br>sudo update-alternatives --config g++<br></code></pre></td></tr></table></figure><h2 id="1-2-ä¿®æ”¹ollvmæºç "><a href="#1-2-ä¿®æ”¹ollvmæºç " class="headerlink" title="1.2 ä¿®æ”¹ollvmæºç "></a>1.2 ä¿®æ”¹ollvmæºç </h2><p>ç¼–è¯‘é˜¶æ®µä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151110832.png"></p><p>æ„æ€æ˜¯<code>ollvm/obfuscator/include/llvm/ExecutionEngine/Orc/OrcRemoteTargetClient.h</code>ä¸­çš„readMemå‡½æ•°çš„è¿”å›å€¼ç±»å‹å’Œå‡½æ•°å®šä¹‰çš„è¿”å›ç±»å‹æœ‰å†²çªï¼Œéœ€è¦å°†ç¬¬690è¡Œçš„charæ”¹ä¸ºuint8_tï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151116060.png"></p><h1 id="äºŒã€å¼€å§‹ç¼–è¯‘"><a href="#äºŒã€å¼€å§‹ç¼–è¯‘" class="headerlink" title="äºŒã€å¼€å§‹ç¼–è¯‘"></a>äºŒã€å¼€å§‹ç¼–è¯‘</h1><p>ä¸‹è½½ollvmæºç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone -b llvm-4.0 https://github.com/obfuscator-llvm/obfuscator.git<br></code></pre></td></tr></table></figure><p>åˆ›å»ºbuildç›®å½•å¹¶è¿›å…¥è¯¥ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir build<br>cd build<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cmake -DCMAKE_BUILD_TYPE=Release -DLLVM_INCLUDE_TESTS=OFF ../obfuscator/<br></code></pre></td></tr></table></figure><p>wikiä¸­æ²¡æœ‰<code>-DLLVM_INCLUDE_TESTS=OFF</code>ï¼Œä½†æ˜¯ä¼šæŠ¥é”™<code>CMake Error at cmake/modules/AddLLVM.cmake:1163 (add_custom_target)</code>ã€‚</p><p>å¦‚æœcmakeé˜¶æ®µå‡ºé”™äº†ï¼Œè®°å¾—æ¸…é™¤buildç¼“å­˜ï¼ˆç›´æ¥é‡å»ºbuildæ–‡ä»¶å¤¹ï¼‰ã€‚</p><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¼€å§‹ç¼–è¯‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">make -j7<br></code></pre></td></tr></table></figure><p>æˆ‘è¿™å°è™šæ‹Ÿæœºæœ‰8ä¸ªå¤„ç†å™¨ï¼Œæ‰€ä»¥å¼„ä¸ª<code>-j7</code>ã€‚</p><h1 id="ä¸‰ã€ä½¿ç”¨"><a href="#ä¸‰ã€ä½¿ç”¨" class="headerlink" title="ä¸‰ã€ä½¿ç”¨"></a>ä¸‰ã€ä½¿ç”¨</h1><h2 id="3-1-æŒ‡ä»¤æ›¿æ¢"><a href="#3-1-æŒ‡ä»¤æ›¿æ¢" class="headerlink" title="3.1 æŒ‡ä»¤æ›¿æ¢"></a>3.1 æŒ‡ä»¤æ›¿æ¢</h2><p>å¯é€‰æŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">-mllvm -sub: activate instructions substitution<br>-mllvm -sub_loop=3: if the pass is activated, applies it 3 times on a function. Default : 1.<br></code></pre></td></tr></table></figure><p>æºç ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151149383.png"></p><p>ä½¿ç”¨çš„æ··æ·†æŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ollvm/build/bin/clang test.c -o test -mllvm -sub<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„æ··æ·†ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151151222.png"></p><p>ç¬¬ä¸€ä¸ª<code>c=a+b</code>è¢«æ›¿æ¢æˆäº†å‡æ³•è¿ç®—ï¼Œç¬¬äºŒä¸ª<code>c=a+b</code>é¢å¤–åŠ å…¥äº†ä¸€ä¸ªéšæœºæ•°ã€‚</p><h2 id="3-2-è™šå‡æ§åˆ¶æµ"><a href="#3-2-è™šå‡æ§åˆ¶æµ" class="headerlink" title="3.2 è™šå‡æ§åˆ¶æµ"></a>3.2 è™šå‡æ§åˆ¶æµ</h2><p>å¯é€‰æŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">-mllvm -bcf: activates the bogus control flow pass<br>-mllvm -bcf_loop=3: if the pass is activated, applies it 3 times on a function. Default: 1<br>-mllvm -bcf_prob=40: if the pass is activated, a basic bloc will be obfuscated with a probability of 40%. Default: 30<br></code></pre></td></tr></table></figure><p>æºç ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151204486.png"></p><p>ä½¿ç”¨çš„æ··æ·†æŒ‡ä»¤ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">ollvm<span class="hljs-regexp">/build/</span>bin/clang test.c -o test -mllvm -bcf -mllvm -bcf_loop=<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„æ··æ·†ç»“æœï¼š</p><p>å¤ªé•¿äº†ï¼Œåªå±•ç¤ºæ§åˆ¶æµå›¾ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151207197.png"></p><p>é‡Œé¢æ·»åŠ äº†å¾ˆå¤šæ¡ä»¶è·³è½¬ã€å¾ªç¯ã€‚</p><h2 id="3-3-æ§åˆ¶æµå¹³å¦åŒ–"><a href="#3-3-æ§åˆ¶æµå¹³å¦åŒ–" class="headerlink" title="3.3 æ§åˆ¶æµå¹³å¦åŒ–"></a>3.3 æ§åˆ¶æµå¹³å¦åŒ–</h2><p>å¯é€‰æŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">-mllvm -fla: activates control flow flattening<br>-mllvm -split: activates basic block splitting. Improve the flattening when applied together.<br>-mllvm -split_num=3: if the pass is activated, applies it 3 times on each basic block. Default: 1<br></code></pre></td></tr></table></figure><p>æºç ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151227635.png"></p><p>ä½¿ç”¨çš„æ··æ·†æŒ‡ä»¤ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">ollvm<span class="hljs-regexp">/build/</span>bin/clang test.c -o test -mllvm -fla<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„æ··æ·†ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151228948.png"></p><p>æ ¹æ®ä¹‹å‰çœ‹è¿‡çš„è®ºæ–‡ï¼Œæ§åˆ¶æµå¹³å¦åŒ–æ˜¯ä½¿ç”¨switch-caseç»“æ„ï¼Œé€šè¿‡è·¯ç”±å˜é‡æ¥æ§åˆ¶ä»£ç æµã€‚ä¸è¿‡è¿™é‡Œçš„IDAè¯†åˆ«æˆäº†å¾ªç¯ğŸ§ã€‚</p><p>å†æ¥çœ‹ä¸€ä¸‹å¸¦åŸºæœ¬å—åˆ†éš”çš„æ··æ·†æŒ‡ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ollvm/build/bin/clang test.c -o <span class="hljs-built_in">test</span> -mllvm -fla -mllvm -<span class="hljs-built_in">split</span><br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„æ··æ·†ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202404151233277.png"></p><p>åˆ†éš”åŸºæœ¬å—ä¹‹åå†å¹³å¦åŒ–ï¼Œä»æ§åˆ¶æµå›¾æ¥çœ‹ï¼Œè²Œä¼¼å¥½åƒçŸ¥é“äº†å¹³å¦åŒ–å¤§æ¦‚æ˜¯æŒ‡ä»€ä¹ˆäº†ã€‚æ··æ·†åçš„ä»£ç é‡Œé¢åˆ°å¤„éƒ½æ˜¯if-elseåˆ†æ”¯ï¼Œä¸€ä¸ªç®€å•çš„æºä»£ç æ··æ·†åå˜æˆå¦‚æ­¤å¤æ‚ï¼Œçœ‹æ¥è¿™åŠŸèƒ½æ˜¯ç›¸å½“ä¸é”™çš„å˜›ã€‚</p><h2 id="3-4-å‡½æ•°æ³¨è§£"><a href="#3-4-å‡½æ•°æ³¨è§£" class="headerlink" title="3.4 å‡½æ•°æ³¨è§£"></a>3.4 å‡½æ•°æ³¨è§£</h2><p>ç”¨äºæŒ‡å®šå“ªäº›å‡½æ•°è¦æ··æ·†ï¼Œä½¿ç”¨ä»€ä¹ˆæ ·çš„æ··æ·†ã€‚</p><p>ä¾‹å¦‚åªå¯¹<code>int fun()</code>å‡½æ•°è¿›è¡Œ<code>fla</code>æ··æ·†ï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·å£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">()</span> __<span class="hljs-title function_">attribute</span><span class="hljs-params">((__annotate__((<span class="hljs-string">&quot;fla&quot;</span>))))</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæƒ³å¯¹åŒä¸€å‡½æ•°ä½¿ç”¨å¤šä¸ªæ³¨è§£ï¼Œæ¯”å¦‚å¯¹<code>int fun()</code>å‡½æ•°è¿›è¡Œ<code>fla</code>å’Œ<code>sub</code>æ··æ·†ï¼Œå¯ä»¥è¿™ä¹ˆå£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">()</span> __<span class="hljs-title function_">attribute</span><span class="hljs-params">((__annotate__((<span class="hljs-string">&quot;fla sub&quot;</span>))))</span>;<br>æˆ–è€…<br><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">()</span> __<span class="hljs-title function_">attribute</span><span class="hljs-params">((__annotate__((<span class="hljs-string">&quot;fla&quot;</span>))))</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">()</span> __<span class="hljs-title function_">attribute</span><span class="hljs-params">((__annotate__((<span class="hljs-string">&quot;sub&quot;</span>))))</span>;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨åæ ‡å¿—æ¥ç¦æ­¢å¯¹æŸå‡½æ•°è¿›è¡Œæ··æ·†ï¼Œä¾‹å¦‚å¯¹<code>int fun()</code>å‡½æ•°ç¦æ­¢<code>bcf</code>æ··æ·†ï¼Œå¯ä»¥è¿™ä¹ˆå£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">()</span> __<span class="hljs-title function_">attribute</span><span class="hljs-params">((__annotate__((<span class="hljs-string">&quot;nobcf&quot;</span>))))</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Installation">https://github.com/obfuscator-llvm/obfuscator/wiki/Installation</a></p><p><a href="https://github.com/obfuscator-llvm/obfuscator/issues/77">https://github.com/obfuscator-llvm/obfuscator/issues/77</a></p><p><a href="https://www.jianshu.com/p/9136f7257e46">è·Ÿç€é“å¤´å¹²æ··æ·†2 ubuntu20.04ç¼–è¯‘ollvm - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Instructions-Substitution">https://github.com/obfuscator-llvm/obfuscator/wiki/Instructions-Substitution</a></p><p><a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Bogus-Control-Flow">https://github.com/obfuscator-llvm/obfuscator/wiki/Bogus-Control-Flow</a></p><p><a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening">https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening</a></p><p><a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Functions-annotations">https://github.com/obfuscator-llvm/obfuscator/wiki/Functions-annotations</a></p>]]></content>
    
    
    <categories>
      
      <category>Obfuscation</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OLLVM</tag>
      
      <tag>ä»£ç æ··æ·†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NDKå¼€å‘å­¦ä¹ ç¬”è®°</title>
    <link href="/2023/12/26/NDK%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/12/26/NDK%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€NDKé¡¹ç›®æ–°å¢å†…å®¹"><a href="#ä¸€ã€NDKé¡¹ç›®æ–°å¢å†…å®¹" class="headerlink" title="ä¸€ã€NDKé¡¹ç›®æ–°å¢å†…å®¹"></a>ä¸€ã€NDKé¡¹ç›®æ–°å¢å†…å®¹</h1><p>ä½¿ç”¨Android Studioç›´æ¥åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„NDKé¡¹ç›®ï¼Œä¼šå‘ç°æ–°å¢äº†å¦‚ä¸‹éƒ¨åˆ†ï¼š</p><ol><li><p>å¤šäº†åŠ è½½æœ¬åœ°åº“çš„ä»£ç å’Œæœ¬åœ°åº“ä¸­æ–¹æ³•çš„å£°æ˜ä»£ç ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312251151211.png"></p></li><li><p>åœ¨é¡¹ç›®çš„mainç›®å½•ä¸‹å¤šäº†cppç›®å½•ï¼ŒåŒ…å«CMakeLists.txté…ç½®æ–‡ä»¶ä»¥åŠnative-lib.cppä»£ç å®ç°æ–‡ä»¶ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312251155667.png"></p></li><li><p>buid.gradleé…ç½®æ–‡ä»¶ä¸­å¤šäº†nativeå±‚çš„ç¼–è¯‘é…ç½®ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312251157782.png"></p></li></ol><h1 id="äºŒã€NDKæ¨¡æ¿ä»£ç åˆ†æ"><a href="#äºŒã€NDKæ¨¡æ¿ä»£ç åˆ†æ" class="headerlink" title="äºŒã€NDKæ¨¡æ¿ä»£ç åˆ†æ"></a>äºŒã€NDKæ¨¡æ¿ä»£ç åˆ†æ</h1><p>å€ŸåŠ©ä¸Šé¢è¿™ä¸ªæ¨¡æ¿é¡¹ç›®æ¥ç†è§£åŸºæœ¬çš„NDKå¼€å‘ï¼š</p><ol><li><p>soåº“åŠ è½½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> &#123;<br>System.loadLibrary(<span class="hljs-string">&quot;nativetest&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒçš„åŠ è½½æ—¶æœºæœ‰ä¸¤ç§ï¼Œ</p><ul><li><strong>1ã€åœ¨ç±»é™æ€åˆå§‹åŒ–ä¸­ï¼š</strong> å¦‚æœåªåœ¨ä¸€ä¸ªç±»æˆ–è€…å¾ˆå°‘ç±»ä¸­ä½¿ç”¨åˆ°è¯¥ so åº“ï¼Œåˆ™æœ€å¸¸è§çš„æ–¹å¼æ˜¯åœ¨ç±»çš„é™æ€åˆå§‹åŒ–å—ä¸­è°ƒç”¨ã€‚</li><li><strong>2ã€åœ¨ Application åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼š</strong> å¦‚æœæœ‰å¾ˆå¤šç±»éœ€è¦ä½¿ç”¨åˆ°è¯¥ so åº“ï¼Œåˆ™å¯ä»¥è€ƒè™‘åœ¨ Application åˆå§‹åŒ–ç­‰åœºæ™¯ä¸­æå‰åŠ è½½ã€‚</li></ul></li><li><p>Javaå±‚nativeæ–¹æ³•å£°æ˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">stringFromJNI</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure></li><li><p>nativeæ–¹æ³•çš„å®ç°ä¸é™æ€æ³¨å†Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">JNIEXPORT jstring JNICALL <span class="hljs-title">Java_com_example_nativetest_MainActivity_stringFromJNI</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">        jobject <span class="hljs-comment">/* this */</span>)</span> </span>&#123;<br>    std::string hello = <span class="hljs-string">&quot;Hello from C++&quot;</span>;<br>    <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(hello.<span class="hljs-built_in">c_str</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°åé‡‡ç”¨ä»¥å­—ç¬¦ä¸² â€œJavaâ€ ä¸ºå‰ç¼€ï¼Œç”¨ â€œ_â€ ä¸‹åˆ’çº¿å°†å…¨é™å®šç±»åä»¥åŠæ–¹æ³•åè¿æ¥èµ·æ¥ï¼Œè¿™ä¸ªå°±æ˜¯JNIå‡½æ•°é™æ€æ³¨å†Œçº¦å®šçš„å‡½æ•°å‘½åè§„åˆ™ã€‚</p><p><code>extern &quot;C&quot;</code>è¡¨ç¤ºç¼–è¯‘å™¨ä½¿ç”¨Cè¯­è¨€çš„æ–¹å¼è¿›è¡Œç¼–è¯‘æˆ–è€…é“¾æ¥ã€‚</p><p>å®å®šä¹‰<code>JNIEXPORT</code>è¡¨ç¤ºå°†è¯¥å‡½æ•°å¯¼å‡ºï¼Œå¯ä¾›å¤–éƒ¨ä½¿ç”¨ã€‚å®å®šä¹‰<code>JNICALL</code>è¡¨ç¤ºè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªJNIå‡½æ•°ï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹ï¼ˆLinuxå¹³å°ä¸‹ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312251219966.png"></p><p><code>jstring</code>æ˜¯å‡½æ•°çš„è¿”å›ç±»å‹ã€‚</p><p><code>jobject</code> ç±»å‹æ˜¯ JNI å±‚å¯¹äº Java å±‚åº”ç”¨ç±»å‹å¯¹è±¡çš„è¡¨ç¤ºã€‚æ¯ä¸€ä¸ªä» Java è°ƒç”¨çš„ native æ–¹æ³•ï¼Œåœ¨ JNI å‡½æ•°ä¸­éƒ½ä¼šä¼ é€’ä¸€ä¸ªå½“å‰å¯¹è±¡çš„å¼•ç”¨ã€‚åŒºåˆ† 2 ç§æƒ…å†µï¼š</p><ul><li><strong>é™æ€Nativeæ–¹æ³•ï¼š</strong> ç¬¬äºŒä¸ªå‚æ•°ä¸º <code>jclass</code> ç±»å‹ï¼ŒæŒ‡å‘ native æ–¹æ³•æ‰€åœ¨ç±»çš„ Class å¯¹è±¡ã€‚</li><li><strong>å®ä¾‹Nativeæ–¹æ³•ï¼š</strong> ç¬¬äºŒä¸ªå‚æ•°ä¸º <code>jobject</code> ç±»å‹ï¼ŒæŒ‡å‘è°ƒç”¨ native æ–¹æ³•çš„å¯¹è±¡ã€‚</li></ul><p>å‚æ•° env æ˜¯Nativeå±‚ä¸­Javaç¯å¢ƒçš„ä»£è¡¨ï¼Œé€šè¿‡ JNIEnv* æŒ‡é’ˆå°±å¯ä»¥åœ¨ Native å±‚ä¸­è®¿é—® Java å±‚çš„ä»£ç å¹¶è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚è°ƒç”¨ Java çš„æ–¹æ³•ã€æ“ä½œ Java çš„å˜é‡å’Œå¯¹è±¡ç­‰ã€‚</p></li></ol><h1 id="ä¸‰ã€æ•°æ®ç±»å‹è½¬æ¢"><a href="#ä¸‰ã€æ•°æ®ç±»å‹è½¬æ¢" class="headerlink" title="ä¸‰ã€æ•°æ®ç±»å‹è½¬æ¢"></a>ä¸‰ã€æ•°æ®ç±»å‹è½¬æ¢</h1><h2 id="3-1-æ•°æ®ç±»å‹æ˜ å°„"><a href="#3-1-æ•°æ®ç±»å‹æ˜ å°„" class="headerlink" title="3.1 æ•°æ®ç±»å‹æ˜ å°„"></a>3.1 æ•°æ®ç±»å‹æ˜ å°„</h2><p>Javaçš„æ•°æ®ç±»å‹ä¸JNIä¸­çš„æ•°æ®ç±»å‹æ˜ å°„è§<a href="https://gal2xy.github.io/2023/12/10/JNI%E5%8E%9F%E7%90%86/#%E5%9B%9B%E3%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BD%AC%E6%8D%A2">JNIåŸç† - gla2xyâ€™s blog (gal2xy.github.io)</a>ã€‚ç”±äºJavaå±‚æ•°æ®ç±»å‹å’ŒC&#x2F;C++å±‚çš„æ•°æ®ç±»å‹ä¸å°½ç›¸åŒï¼Œå› æ­¤åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦åšç›¸åº”çš„è½¬æ¢ï¼š</p><ul><li><strong>åŸºç¡€æ•°æ®ç±»å‹ï¼š</strong> ä¼šç›´æ¥è½¬æ¢ä¸º C&#x2F;C++ çš„åŸºç¡€æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ int ç±»å‹æ˜ å°„ä¸º jint ç±»å‹ã€‚ç”±äº jint æ˜¯ C&#x2F;C++ ç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å½“ä½œæ™®é€š C&#x2F;C++ å˜é‡ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦ä¾èµ– JNIEnv ç¯å¢ƒå¯¹è±¡ã€‚</li><li><strong>å¼•ç”¨æ•°æ®ç±»å‹ï¼š</strong> å¯¹è±¡åªä¼šè½¬æ¢ä¸ºä¸€ä¸ª C&#x2F;C++ æŒ‡é’ˆï¼Œä¾‹å¦‚ Object ç±»å‹æ˜ å°„ä¸º jobject ç±»å‹ã€‚ç”±äºæŒ‡é’ˆæŒ‡å‘ Java è™šæ‹Ÿæœºå†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ä¸å¯èƒ½ç›´æ¥åœ¨ C&#x2F;C++ ä»£ç ä¸­æ“ä½œå¯¹è±¡ï¼Œè€Œæ˜¯éœ€è¦ä¾èµ– JNIEnv ç¯å¢ƒå¯¹è±¡ã€‚å¦å¤–ï¼Œä¸ºäº†é¿å…å¯¹è±¡åœ¨ä½¿ç”¨æ—¶çªç„¶è¢«å›æ”¶ï¼Œåœ¨æœ¬åœ°æ–¹æ³•è¿”å›å‰ï¼Œè™šæ‹Ÿæœºä¼šå›ºå®šï¼ˆpinï¼‰å¯¹è±¡ï¼Œé˜»æ­¢å…¶ GCã€‚</li></ul><p>è½¬æ¢çš„æ–¹æ³•è§JNIæºç ï¼š<a href="http://aospxref.com/android-8.0.0_r36/xref/libnativehelper/include/nativehelper/jni.h">jni.h (aospxref.com)</a>ã€‚</p><h2 id="3-2-å­—ç¬¦ä¸²"><a href="#3-2-å­—ç¬¦ä¸²" class="headerlink" title="3.2 å­—ç¬¦ä¸²"></a>3.2 å­—ç¬¦ä¸²</h2><p>å­—ç¬¦ä¸²çš„è½¬æ¢ç”±äºç¼–ç çš„åŸå› åˆ†ä¸ºä¸¤å¥—ï¼šä¸€å¥—æ˜¯ç”¨äºUnicodeç¼–ç ï¼Œå¦ä¸€å¥—æ˜¯ç”¨äºUTF-8ç¼–ç ï¼Œå…·ä½“å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//Unicodeç¼–ç </span><br><span class="hljs-function">jstring <span class="hljs-title">NewString</span><span class="hljs-params">(<span class="hljs-type">const</span> jchar* unicodeChars, jsize len)</span><span class="hljs-comment">//å°†nativeå±‚çš„å­—ç¬¦æ•°ç»„è½¬æˆUnicodeç¼–ç çš„javaå­—ç¬¦ä¸²å¯¹è±¡ï¼Œä»¥&#x27;$&#x27;ç»“å°¾</span></span><br><span class="hljs-function">jsize <span class="hljs-title">GetStringLength</span><span class="hljs-params">(jstring string)</span><span class="hljs-comment">//è¿”å›Unicodeç¼–ç çš„å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç”±äºç»“å°¾ç¬¦ä¸æ˜¯&#x27;\0&#x27;ï¼Œæ‰€ä»¥ä¸å¯é€šè¿‡strlenå‡½æ•°è·å–</span></span><br><span class="hljs-function"><span class="hljs-type">const</span> jchar* <span class="hljs-title">GetStringChars</span><span class="hljs-params">(jstring string, jboolean* isCopy)</span><span class="hljs-comment">//å°†Javaå­—ç¬¦ä¸²å¯¹è±¡è½¬æˆå­—nativeå±‚çš„å­—ç¬¦ä¸²æ•°ç»„</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReleaseStringChars</span><span class="hljs-params">(jstring string, <span class="hljs-type">const</span> jchar* chars)</span><span class="hljs-comment">//é‡Šæ”¾nativeå±‚çš„å­—ç¬¦ä¸²æ•°ç»„(ç¬¬äºŒä¸ªå‚æ•°)</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetStringRegion</span><span class="hljs-params">(jstring str, jsize start, jsize len, jchar* buf)</span><span class="hljs-comment">//å¤åˆ¶strçš„æŒ‡å®šéƒ¨åˆ†åˆ°bufä¸­</span></span><br><span class="hljs-function"><span class="hljs-comment">//UTF-8ç¼–ç </span></span><br><span class="hljs-function">jstring <span class="hljs-title">NewStringUTF</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* bytes)</span><span class="hljs-comment">//å°†nativeå±‚çš„å­—ç¬¦æ•°ç»„è½¬æˆUTF-8ç¼–ç çš„javaå­—ç¬¦ä¸²å¯¹è±¡ï¼Œä»¥&#x27;\0&#x27;ç»“å°¾</span></span><br><span class="hljs-function">jsize <span class="hljs-title">GetStringUTFLength</span><span class="hljs-params">(jstring string)</span><span class="hljs-comment">//è¿”å›UTF-8ç¼–ç çš„å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡strlenå‡½æ•°è·å–</span></span><br><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">GetStringUTFChars</span><span class="hljs-params">(jstring string, jboolean* isCopy)</span><span class="hljs-comment">//å°†Javaå­—ç¬¦ä¸²å¯¹è±¡è½¬æˆå­—nativeå±‚çš„å­—ç¬¦ä¸²æ•°ç»„</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReleaseStringUTFChars</span><span class="hljs-params">(jstring string, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* utf)</span><span class="hljs-comment">//é‡Šæ”¾nativeå±‚çš„å­—ç¬¦ä¸²æ•°ç»„(ç¬¬äºŒä¸ªå‚æ•°)</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetStringUTFRegion</span><span class="hljs-params">(jstring str, jsize start, jsize len, <span class="hljs-type">char</span>* buf)</span><span class="hljs-comment">//å¤åˆ¶stræŒ‡å®šéƒ¨åˆ†åˆ°bufä¸­</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">//é€šç”¨</span></span><br><span class="hljs-function"><span class="hljs-type">const</span> jchar* <span class="hljs-title">GetStringCritical</span><span class="hljs-params">(jstring string, jboolean* isCopy)</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReleaseStringCritical</span><span class="hljs-params">(jstring string, <span class="hljs-type">const</span> jchar* carray)</span></span><br></code></pre></td></tr></table></figure><h2 id="3-3-æ•°ç»„"><a href="#3-3-æ•°ç»„" class="headerlink" title="3.3 æ•°ç»„"></a>3.3 æ•°ç»„</h2><p>Nativeå±‚ä¸­æœ‰å¦‚ä¸‹æ•°ç»„ï¼š<code>ObjectArrayã€BooleanArrayã€ByteArrayã€CharArrayã€ShortArrayã€IntArrayã€LongArrayã€FloatArrayã€DoubleArray</code>ã€‚æ¯ç§ç±»å‹çš„æ•°ç»„éƒ½æœ‰ä¸€å¥—ç›¸ä¼¼çš„å¯¹åº”å‡½æ•°æ¥æ“ä½œæ•°ç»„ï¼Œå‡½æ•°ä¸»è¦å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&lt;Type&gt;ã€&lt;type&gt;ä»£æŒ‡åŸºæœ¬ç±»å‹<br><span class="hljs-comment">//é€šç”¨</span><br><span class="hljs-function">jsize <span class="hljs-title">GetArrayLength</span><span class="hljs-params">(jarray array)</span><span class="hljs-comment">//è¿”å›æ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="hljs-function">    </span><br><span class="hljs-function"><span class="hljs-comment">//å¼•ç”¨ç±»å‹æ•°ç»„</span></span><br><span class="hljs-function">    <span class="hljs-comment">//åˆ›å»ºå¼•ç”¨ç±»å‹çš„æ•°ç»„ï¼ŒlengthæŒ‡å®šæ•°ç»„å¤§å°ï¼ŒelementClassæŒ‡å®šå…ƒç´ çš„å¼•ç”¨ç±»å‹ï¼ŒinitialElementæŒ‡å®šå…ƒç´ çš„åˆå§‹å€¼ï¼Œä¸€èˆ¬ä¸ºnull</span></span><br><span class="hljs-function">jobjectArray <span class="hljs-title">NewObjectArray</span><span class="hljs-params">(jsize length, jclass elementClass, jobject initialElement)</span></span><br><span class="hljs-function">    <span class="hljs-comment">//è·å–arrayæ•°ç»„ä¸­æŒ‡å®šä¸‹æ ‡indexçš„å…ƒç´ çš„å€¼</span></span><br><span class="hljs-function">jobject <span class="hljs-title">GetObjectArrayElement</span><span class="hljs-params">(jobjectArray array, jsize index)</span></span><br><span class="hljs-function">    <span class="hljs-comment">//è®¾ç½®arrayæ•°ç»„ä¸­æŒ‡å®šä¸‹æ ‡indexçš„å…ƒç´ çš„å€¼</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetObjectArrayElement</span><span class="hljs-params">(jobjectArray array, jsize index, jobject value)</span></span><br><span class="hljs-function">    </span><br><span class="hljs-function"><span class="hljs-comment">//åŸºæœ¬ç±»å‹æ•°ç»„</span></span><br><span class="hljs-function">    <span class="hljs-comment">//åˆ›å»ºTypeç±»å‹çš„æ•°ç»„ï¼ŒlengthæŒ‡å®šæ•°ç»„å¤§å°</span></span><br><span class="hljs-function">j&lt;type&gt;Array New&lt;Type&gt;<span class="hljs-title">Array</span><span class="hljs-params">(jsize length)</span></span><br><span class="hljs-function">    <span class="hljs-comment">//å°†Javaå±‚çš„æ•°ç»„è½¬æˆnativeå±‚çš„æ•°ç»„</span></span><br><span class="hljs-function">j&lt;type&gt;* Get&lt;Type&gt;<span class="hljs-title">ArrayElements</span><span class="hljs-params">(j&lt;type&gt;Array array, j&lt;Type&gt;* isCopy)</span></span><br><span class="hljs-function">    <span class="hljs-comment">/*</span></span><br><span class="hljs-comment"><span class="hljs-function">    é‡Šæ”¾arrayæ•°ç»„ï¼Œelemsç”±Get&lt;Type&gt;ArrayElementså‡½æ•°è·å–çš„ï¼ŒmodeæŒ‡å®šæ“ä½œæ¨¡å¼ï¼š</span></span><br><span class="hljs-comment"><span class="hljs-function">    0æ›´æ–°æ•°ç»„å¹¶é‡Šæ”¾elems ç¼“å†²åŒº</span></span><br><span class="hljs-comment"><span class="hljs-function">    JNI_COMMITæ›´æ–°ä½†ä¸é‡Šæ”¾elems ç¼“å†²åŒº</span></span><br><span class="hljs-comment"><span class="hljs-function">    JNI_ABORTä¸ä½œæ›´æ–°ä½†é‡Šæ”¾elemsç¼“å†²åŒº</span></span><br><span class="hljs-comment"><span class="hljs-function">    */</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> Release&lt;Type&gt;<span class="hljs-title">ArrayElements</span><span class="hljs-params">(j&lt;type&gt;Array array, j&lt;type&gt;* elems,jint mode)</span></span><br><span class="hljs-function">    <span class="hljs-comment">//å¤åˆ¶arrayæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ åˆ°bufæ•°ç»„ä¸­</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> Get&lt;Type&gt;<span class="hljs-title">ArrayRegion</span><span class="hljs-params">(j&lt;type&gt;Array array, jsize start, jsize len, j&lt;type&gt;* buf)</span></span><br><span class="hljs-function">    <span class="hljs-comment">//å°†bufæ•°ç»„ä¸­çš„å…ƒç´ èµ‹å€¼åˆ°arrayæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> Set&lt;Type&gt;<span class="hljs-title">ArrayRegion</span><span class="hljs-params">(j&lt;type&gt;Array array, jsize start, jsize len, <span class="hljs-type">const</span> j&lt;type&gt;* buf)</span></span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//javaå±‚</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> extends AppCompatActivity &#123;<br>    <span class="hljs-type">static</span> &#123;<br>        System.<span class="hljs-built_in">loadLibrary</span>(<span class="hljs-string">&quot;nativetest&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span>[] a = &#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>&#125;;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-type">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>&#123;<br>        ...<br>        <span class="hljs-type">int</span>[] bArray = <span class="hljs-built_in">getIntArray</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; bArray.length ; i++) &#123;<br>            Log.<span class="hljs-built_in">d</span>(<span class="hljs-string">&quot;gal2xy&quot;</span>, <span class="hljs-string">&quot;bArray[&quot;</span> + i + <span class="hljs-string">&quot;]: &quot;</span> + bArray[i]);<br>        &#125;    <br>    &#125;<br><span class="hljs-keyword">public</span> native <span class="hljs-type">int</span>[] <span class="hljs-built_in">getIntArray</span>();<br>&#125;<br><span class="hljs-comment">//nativeå±‚</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">JNIEXPORT jintArray JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_nativetest_MainActivity_getIntArray</span><span class="hljs-params">(JNIEnv *env, jobject thiz)</span> </span>&#123;<br>    <span class="hljs-comment">//è·å–MainActivityçš„intæ•°ç»„ a</span><br>    jclass clz = env-&gt;<span class="hljs-built_in">GetObjectClass</span>(thiz);<br>    jfieldID aFieldID = env-&gt;<span class="hljs-built_in">GetStaticFieldID</span>(clz,<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;[I&quot;</span>);<br>    jintArray aArray = <span class="hljs-built_in">static_cast</span>&lt;jintArray&gt;(env-&gt;<span class="hljs-built_in">GetStaticObjectField</span>(clz, aFieldID));<br>    <span class="hljs-comment">//è·å–æ•°ç»„é•¿åº¦</span><br>    <span class="hljs-type">int</span> aAarryLen = env-&gt;<span class="hljs-built_in">GetArrayLength</span>(aArray);<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;Array Length: %d&quot;</span>, aAarryLen);<br>    <span class="hljs-comment">//è½¬æˆnativeä½¿ç”¨çš„intæ•°ç»„</span><br>    jint* intArray = <span class="hljs-literal">nullptr</span>;<br>    intArray = env-&gt;<span class="hljs-built_in">GetIntArrayElements</span>(aArray, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">//éå†æ•°ç»„</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; aAarryLen; ++i) &#123;<br>        <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;Array[%d] = %d&quot;</span>, i, intArray[i]);<br>        intArray[i] *= <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-comment">//æ›´æ–°javaå±‚çš„æ•°ç»„å¹¶é‡Šæ”¾nativeå±‚çš„å¯¹åº”çš„æ•°ç»„</span><br>    env-&gt;<span class="hljs-built_in">ReleaseIntArrayElements</span>(aArray, intArray,<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//è¿”å›ç»™Javaå±‚è¾“å‡º</span><br>    <span class="hljs-keyword">return</span> aArray;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312261727597.png"></p><h1 id="å››ã€JNIå±‚è®¿é—®Javaå±‚"><a href="#å››ã€JNIå±‚è®¿é—®Javaå±‚" class="headerlink" title="å››ã€JNIå±‚è®¿é—®Javaå±‚"></a>å››ã€JNIå±‚è®¿é—®Javaå±‚</h1><h2 id="4-1-è®¿é—®ç±»"><a href="#4-1-è®¿é—®ç±»" class="headerlink" title="4.1 è®¿é—®ç±»"></a>4.1 è®¿é—®ç±»</h2><ul><li><code>FindClass(classname)</code>ï¼šè·å–<code>classname</code>å¯¹åº”çš„ç±»ï¼Œ<code>classname</code>ä¸­çš„<code>.</code>éœ€è¦ç”¨<code>/</code>æ›¿æ¢ã€‚</li><li><code>GetSuperclass(clz)</code>ï¼šè·å–<code>clazz</code>çš„çˆ¶ç±»ã€‚</li><li><code>GetObjectClass(clzObj)</code>ï¼šè·å–ç±»å®ä¾‹<code>clzObj</code>çš„ç±»ã€‚</li><li><code>IsInstanceOf(clzObj, clz)</code>ï¼šåˆ¤æ–­ç±»å®ä¾‹<code>clzObj</code>å¯¹è±¡æ˜¯å¦æ˜¯<code>clz</code>ç±»ç±»å‹ã€‚</li><li><code>NewObject(clz, methodID, args...)</code>ï¼šè°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºå®ä¾‹å¯¹è±¡ã€‚</li><li><code>AllocObject(clz)</code>ï¼šåˆ›å»ºå®ä¾‹å¯¹è±¡ï¼ˆä»…ä»…ä¸ºç±»å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´è€Œå·²ï¼‰ï¼Œä¸åˆå§‹æˆå‘˜å˜é‡ï¼Œä¹Ÿä¸è°ƒç”¨æ„é€ æ–¹æ³•ã€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·å–ç±»</span><br>jclass clz = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;com/example/nativetest/Demo&quot;</span>);<br><span class="hljs-comment">//è·å–æ„é€ æ–¹æ³•</span><br>jmethodID initmethodID = env-&gt;<span class="hljs-built_in">GetMethodID</span>(clz,<span class="hljs-string">&quot;&lt;init&gt;&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>);<br><span class="hljs-comment">//åˆ›å»ºå®ä¾‹å¯¹è±¡</span><br>jobject DemoObj = env-&gt;<span class="hljs-built_in">NewObject</span>(clz, initmethodID);<br></code></pre></td></tr></table></figure><h2 id="4-2-è®¿é—®æ–¹æ³•ï¼ˆåŒ…æ‹¬æ„é€ æ–¹æ³•ï¼‰"><a href="#4-2-è®¿é—®æ–¹æ³•ï¼ˆåŒ…æ‹¬æ„é€ æ–¹æ³•ï¼‰" class="headerlink" title="4.2 è®¿é—®æ–¹æ³•ï¼ˆåŒ…æ‹¬æ„é€ æ–¹æ³•ï¼‰"></a>4.2 è®¿é—®æ–¹æ³•ï¼ˆåŒ…æ‹¬æ„é€ æ–¹æ³•ï¼‰</h2><h3 id="4-2-1-é™æ€æ–¹æ³•"><a href="#4-2-1-é™æ€æ–¹æ³•" class="headerlink" title="4.2.1 é™æ€æ–¹æ³•"></a>4.2.1 é™æ€æ–¹æ³•</h3><ul><li><code>GetStaticMethodId(clz, methodname, sig)</code>ï¼šè·å–é™æ€æ–¹æ³•IDã€‚</li><li><code>CallStatic&lt;Type&gt;Method(clz, methodID, args...)</code>ï¼šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œç±»å‹<code>&lt;Type&gt;</code>å–å†³äºæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œå¦‚<code>Objectã€Booleanã€Byteã€Charã€Doubleã€Floatã€Intã€Shortã€Longã€Void</code>ã€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">extern <span class="hljs-string">&quot;C&quot;</span> JNIEXPORT <span class="hljs-keyword">void</span> JNICALL<br><span class="hljs-title function_">Java_com_example_nativetest_MainActivity_accessField</span><span class="hljs-params">(JNIEnv *env, jobject thiz)</span> &#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> implement accessField()</span><br>    LOGD(<span class="hljs-string">&quot;come into native method: accessField&quot;</span>);<br>    <span class="hljs-comment">//è·å–ç±»</span><br>    <span class="hljs-type">jclass</span> <span class="hljs-variable">clz</span> <span class="hljs-operator">=</span> env-&gt;FindClass(<span class="hljs-string">&quot;com/example/nativetest/Demo&quot;</span>);<br>    <span class="hljs-comment">//è·å–æ–¹æ³•</span><br>    <span class="hljs-type">jmethodID</span> <span class="hljs-variable">mulmethodID</span> <span class="hljs-operator">=</span> env-&gt;GetStaticMethodID(clz,<span class="hljs-string">&quot;mul&quot;</span>, <span class="hljs-string">&quot;(II)I&quot;</span>);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> env-&gt;CallStaticIntMethod(clz, mulmethodID,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>);<br>    LOGD(<span class="hljs-string">&quot;result = %d&quot;</span>, result);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-2-å®ä¾‹æ–¹æ³•"><a href="#4-2-2-å®ä¾‹æ–¹æ³•" class="headerlink" title="4.2.2 å®ä¾‹æ–¹æ³•"></a>4.2.2 å®ä¾‹æ–¹æ³•</h3><p>éœ€è¦å…ˆé€šè¿‡<code>NewObject</code>æ–¹æ³•åˆ›å»ºå®ä¾‹å¯¹è±¡æ‰èƒ½è°ƒç”¨ã€‚</p><ul><li><code>GetMethodID(clz, methodname, sig)</code>ï¼šè·å–å®ä¾‹æ–¹æ³•IDã€‚</li><li><code>Call&lt;Type&gt;Method(clzObj, methodID, args...)</code>ï¼šè°ƒç”¨å®ä¾‹æ–¹æ³•ã€‚</li><li><code>CallNonvirtual&lt;Type&gt;Method(clzObj,clz,methodID,args...)</code>ï¼šè°ƒç”¨çˆ¶ç±»<code>clz</code>çš„æ–¹æ³•ï¼ˆå¦‚æœä¸æƒ³ç”¨è‡ªèº«çš„é‡è½½æ–¹æ³•ï¼‰ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">JNIEXPORT <span class="hljs-type">void</span> JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_nativetest_MainActivity_accessField</span><span class="hljs-params">(JNIEnv *env, jobject thiz)</span> </span>&#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> implement accessField()</span><br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;come into native method: accessField&quot;</span>);<br>    <span class="hljs-comment">//è·å–ç±»</span><br>    jclass clz = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;com/example/nativetest/Demo&quot;</span>);<br>    <span class="hljs-comment">//è·å–æ„é€ æ–¹æ³•</span><br>    jmethodID initmethodID = env-&gt;<span class="hljs-built_in">GetMethodID</span>(clz,<span class="hljs-string">&quot;&lt;init&gt;&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>);<br>    <span class="hljs-comment">//å®ä¾‹åŒ–å¯¹è±¡</span><br>    jobject DemoObj = env-&gt;<span class="hljs-built_in">NewObject</span>(clz, initmethodID);<br>    <span class="hljs-comment">//è·å–è¦è°ƒç”¨çš„æ–¹æ³•ID</span><br>    jmethodID addmethodId = env-&gt;<span class="hljs-built_in">GetMethodID</span>(clz,<span class="hljs-string">&quot;add&quot;</span>, <span class="hljs-string">&quot;(II)I&quot;</span>);<br>    <span class="hljs-type">int</span> result = env-&gt;<span class="hljs-built_in">CallIntMethod</span>(DemoObj,addmethodId,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;result = %d&quot;</span>, result);<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    //è·å–çˆ¶ç±»</span><br><span class="hljs-comment">    jclass origindemoclz = env-&gt;FindClass(&quot;com/example/nativetest/OriginDemo&quot;);</span><br><span class="hljs-comment">    jmethodID addmethodID = env-&gt;GetMethodID(origindemoclz,&quot;add&quot;, &quot;(II)I&quot;);//å®é™…ä¸Šæ˜¯å‡æ³•</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    int result = env-&gt;CallNonvirtualIntMethod(DemoObj,origindemoclz,addmethodID,1,2);</span><br><span class="hljs-comment">    LOGD(&quot;result = %d&quot;, result);//ç»“æœä¸º-1</span><br><span class="hljs-comment">    */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-3-CallMethodã€CallMethodAã€CallMethodVçš„åŒºåˆ«"><a href="#4-2-3-CallMethodã€CallMethodAã€CallMethodVçš„åŒºåˆ«" class="headerlink" title="4.2.3 CallMethodã€CallMethodAã€CallMethodVçš„åŒºåˆ«"></a>4.2.3 CallMethodã€CallMethodAã€CallMethodVçš„åŒºåˆ«</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//ä»¥CallVoidMethodä¸ºä¾‹</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CallVoidMethod</span><span class="hljs-params">(jobject obj, jmethodID methodID, ...)</span></span>&#123;<br>    va_list args;<br>    <span class="hljs-built_in">va_start</span>(args, methodID);<br>    functions-&gt;<span class="hljs-built_in">CallVoidMethodV</span>(<span class="hljs-keyword">this</span>, obj, methodID, args);<br>    <span class="hljs-built_in">va_end</span>(args);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CallVoidMethodV</span><span class="hljs-params">(jobject obj, jmethodID methodID, va_list args)</span></span>&#123; <br>    functions-&gt;<span class="hljs-built_in">CallVoidMethodV</span>(<span class="hljs-keyword">this</span>, obj, methodID, args); <br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CallVoidMethodA</span><span class="hljs-params">(jobject obj, jmethodID methodID, <span class="hljs-type">const</span> jvalue* args)</span></span>&#123; <br>    functions-&gt;<span class="hljs-built_in">CallVoidMethodA</span>(<span class="hljs-keyword">this</span>, obj, methodID, args); <br>&#125;<br></code></pre></td></tr></table></figure><p><code>Call&lt;Type&gt;Method</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>Call&lt;Type&gt;MethodV</code>æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨æ­¤ä¹‹å‰å°†<code>methodID</code>åé¢çš„å‚æ•°å°è£…æˆ<code>va_list</code>ç±»å‹çš„æ•°ç»„ï¼ˆæ•°ç»„çš„é•¿åº¦å¯å˜ï¼‰ã€‚</p><p><code>Call&lt;Type&gt;MethodV</code>æ–¹æ³•æ¥æ”¶<code>va_list</code>ç±»å‹çš„æ•°ç»„ã€‚</p><p><code>Call&lt;Type&gt;MethodA</code>æ–¹æ³•æ¥æ”¶<code>jvalue</code>ç±»å‹çš„æŒ‡é’ˆï¼Œ<code>jvalue</code>è”åˆä½“å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">union</span> <span class="hljs-title class_">jvalue</span> &#123;<br>    jboolean    z;<br>    jbyte       b;<br>    jchar       c;<br>    jshort      s;<br>    jint        i;<br>    jlong       j;<br>    jfloat      f;<br>    jdouble     d;<br>    jobject     l;<br>&#125; jvalue;<br></code></pre></td></tr></table></figure><h2 id="4-3-è®¿é—®Javaå­—æ®µ"><a href="#4-3-è®¿é—®Javaå­—æ®µ" class="headerlink" title="4.3 è®¿é—®Javaå­—æ®µ"></a>4.3 è®¿é—®Javaå­—æ®µ</h2><h3 id="4-3-1-é™æ€å­—æ®µ"><a href="#4-3-1-é™æ€å­—æ®µ" class="headerlink" title="4.3.1 é™æ€å­—æ®µ"></a>4.3.1 é™æ€å­—æ®µ</h3><ol><li><code>GetStaticFieldID(clz,FieldName,sig)</code>ï¼šè·å–é™æ€å­—æ®µIDã€‚</li><li><code>GetStatic&lt;Type&gt;Field(clz,FieldID)</code>ï¼šè·å–é™æ€å­—æ®µï¼Œç±»å‹<code>&lt;Type&gt;</code>å–å†³äºå­—æ®µçš„ç±»å‹ï¼Œå¦‚<code>Objectã€Booleanã€Byteã€Charã€Doubleã€Floatã€Intã€Shortã€Long</code>ã€‚</li><li><code>SetStatic&lt;Type&gt;Field(clz,FieldID,value)</code>ï¼šè®¾ç½®é™æ€å­—æ®µå€¼ã€‚</li></ol><p>ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">JNIEXPORT <span class="hljs-type">void</span> JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_nativetest_MainActivity_accessField</span><span class="hljs-params">(JNIEnv* env, jobject  thiz)</span> </span>&#123;<br><br><span class="hljs-comment">//1ã€é€šè¿‡å¯¹è±¡å¯¹åº”çš„ç±»</span><br>    jclass clz = env-&gt;<span class="hljs-built_in">GetObjectClass</span>(thiz);<br>    <span class="hljs-comment">//2ã€é€šè¿‡ç±»è·å–é™æ€å­—æ®µID</span><br>    jfieldID  staticstringFieldID = env-&gt;<span class="hljs-built_in">GetStaticFieldID</span>(clz,<span class="hljs-string">&quot;staticstring&quot;</span>, <span class="hljs-string">&quot;Ljava/lang/String;&quot;</span>);<br>    <br>    <span class="hljs-comment">//set</span><br>    <span class="hljs-comment">//jstring newString = env-&gt;NewStringUTF(&quot;newString alter by Native&quot;);</span><br>    <span class="hljs-comment">//env-&gt;SetStaticObjectField(clz, staticstringFieldID, newString);</span><br>    <br>    <span class="hljs-comment">//3ã€è·å–å­—æ®µçš„å€¼</span><br>    jstring staticstring = <span class="hljs-built_in">static_cast</span>&lt;jstring&gt;(env-&gt;<span class="hljs-built_in">GetStaticObjectField</span>(clz,staticstringFieldID));<br>    <span class="hljs-comment">//GetStringCharsæ–¹æ³•è·å–çš„å­—ç¬¦ä¸²ä»¥$ç»“å°¾ï¼Œä¸èƒ½ä»¥%sæ ¼å¼åŒ–è¾“å‡º</span><br>    <span class="hljs-comment">//4ã€è½¬æˆå¯ä¾›Nativeå±‚ç›´æ¥ä½¿ç”¨çš„ç±»å‹</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* staticchars = env-&gt;<span class="hljs-built_in">GetStringUTFChars</span>(staticstring, <span class="hljs-literal">nullptr</span>);<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;static String from Java: %s&quot;</span>, staticchars);<br>    <span class="hljs-comment">//5ã€é‡Šæ”¾èµ„æº</span><br>    env-&gt;<span class="hljs-built_in">ReleaseStringChars</span>(staticstring, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> jchar *&gt;(staticchars));<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-3-2-å®ä¾‹å­—æ®µ"><a href="#4-3-2-å®ä¾‹å­—æ®µ" class="headerlink" title="4.3.2 å®ä¾‹å­—æ®µ"></a>4.3.2 å®ä¾‹å­—æ®µ</h3><p>éœ€è¦å…ˆé€šè¿‡<code>NewObject</code>æ–¹æ³•åˆ›å»ºå®ä¾‹å¯¹è±¡æ‰èƒ½è°ƒç”¨ã€‚</p><ol><li><code>GetFieldID(clz,FieldName,sig)</code>ï¼šè·å–å®ä¾‹å­—æ®µIDã€‚</li><li><code>Get&lt;Type&gt;Field(clzObj,FieldID)</code>ï¼šè·å–å®ä¾‹å­—æ®µï¼Œç±»å‹<code>&lt;Type&gt;</code>å–å†³äºå­—æ®µçš„ç±»å‹ï¼Œå¦‚<code>Objectã€Booleanã€Byteã€Charã€Doubleã€Floatã€Intã€Shortã€Long</code>ã€‚</li><li><code>Set&lt;Type&gt;Field(clzObj,FieldID,value)</code>ï¼šè®¾ç½®å®ä¾‹å­—æ®µå€¼ã€‚</li></ol><p>ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">JNIEXPORT <span class="hljs-type">void</span> JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_nativetest_MainActivity_accessField</span><span class="hljs-params">(JNIEnv *env, jobject thiz)</span> </span>&#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> implement accessField()</span><br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;come into native method: accessField&quot;</span>);<br>    <span class="hljs-comment">//è·å–ç±»</span><br>    jclass clz = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;com/example/nativetest/Demo&quot;</span>);<br>    <span class="hljs-comment">//è·å–æ„é€ æ–¹æ³•</span><br>    jmethodID initmethodID = env-&gt;<span class="hljs-built_in">GetMethodID</span>(clz,<span class="hljs-string">&quot;&lt;init&gt;&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>);<br>    <span class="hljs-comment">//å®ä¾‹åŒ–å¯¹è±¡</span><br>    jobject DemoObj = env-&gt;<span class="hljs-built_in">NewObject</span>(clz, initmethodID);<br>    <span class="hljs-comment">//è·å–å­—æ®µID</span><br>    jfieldID aFieldID = env-&gt;<span class="hljs-built_in">GetFieldID</span>(clz, <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;I&quot;</span>);<br>    <span class="hljs-comment">//è·å–å€¼</span><br>    <span class="hljs-type">int</span> avalue = env-&gt;<span class="hljs-built_in">GetIntField</span>(DemoObj,aFieldID);<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;value = %d&quot;</span>, avalue);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-4-ç¼“å­˜ID"><a href="#4-4-ç¼“å­˜ID" class="headerlink" title="4.4 ç¼“å­˜ID"></a>4.4 ç¼“å­˜ID</h2><p>è®¿é—® Java å±‚å­—æ®µæˆ–æ–¹æ³•æ—¶ï¼Œéœ€è¦å…ˆåˆ©ç”¨å­—æ®µå &#x2F; æ–¹æ³•åå’Œæè¿°ç¬¦è¿›è¡Œæ£€ç´¢ï¼Œè·å¾— jfieldID &#x2F; jmethodIDã€‚è¿™ä¸ªæ£€ç´¢è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶ï¼Œä¼˜åŒ–æ–¹æ³•æ˜¯å°†å­—æ®µ ID å’Œæ–¹æ³• ID ç¼“å­˜èµ·æ¥ï¼Œå‡å°‘é‡å¤æ£€ç´¢ã€‚</p><blockquote><p><strong>æç¤ºï¼š</strong> ä»ä¸åŒçº¿ç¨‹ä¸­è·å–åŒä¸€ä¸ªå­—æ®µæˆ–æ–¹æ³• çš„ ID æ˜¯ç›¸åŒçš„ï¼Œç¼“å­˜ ID ä¸ä¼šæœ‰å¤šçº¿ç¨‹é—®é¢˜ã€‚</p></blockquote><p>ç¼“å­˜å­—æ®µIDå’Œæ–¹æ³•IDçš„æ–¹æ³•ä¸»è¦æœ‰ 2 ç§ï¼š</p><ul><li><strong>1ã€ä½¿ç”¨æ—¶ç¼“å­˜ï¼š</strong> ä½¿ç”¨æ—¶ç¼“å­˜æ˜¯æŒ‡åœ¨é¦–æ¬¡è®¿é—®å­—æ®µæˆ–æ–¹æ³•æ—¶ï¼Œå°†å­—æ®µ ID æˆ–æ–¹æ³• ID å­˜å‚¨åœ¨é™æ€å˜é‡ä¸­ã€‚è¿™æ ·å°†æ¥å†æ¬¡è°ƒç”¨æœ¬åœ°æ–¹æ³•æ—¶ï¼Œå°±ä¸éœ€è¦é‡å¤æ£€ç´¢ ID äº†ã€‚ä¾‹å¦‚ï¼š</li><li><strong>2ã€ç±»åˆå§‹åŒ–æ—¶ç¼“å­˜ï¼š</strong> é™æ€åˆå§‹åŒ–æ—¶ç¼“å­˜æ˜¯æŒ‡åœ¨ Java ç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæå‰ç¼“å­˜å­—æ®µ ID å’Œæ–¹æ³• IDã€‚å¯ä»¥é€‰æ‹©åœ¨ <code>JNI_OnLoad</code> æ–¹æ³•ä¸­ç¼“å­˜ï¼Œä¹Ÿå¯ä»¥åœ¨åŠ è½½ so åº“åè°ƒç”¨ä¸€ä¸ª native æ–¹æ³•è¿›è¡Œç¼“å­˜ã€‚</li></ul><p>ä¸¤ç§ç¼“å­˜ ID æ–¹å¼çš„ä¸»è¦åŒºåˆ«åœ¨äºç¼“å­˜å‘ç”Ÿçš„æ—¶æœºå’Œæ—¶æ•ˆæ€§ï¼š</p><ul><li><strong>1ã€æ—¶æœºä¸åŒï¼š</strong> ä½¿ç”¨æ—¶ç¼“å­˜æ˜¯å»¶è¿ŸæŒ‰éœ€ç¼“å­˜ï¼Œåªæœ‰åœ¨é¦–æ¬¡è®¿é—® Java æ—¶æ‰ä¼šè·å– ID å¹¶ç¼“å­˜ï¼Œè€Œç±»åˆå§‹åŒ–æ—¶ç¼“å­˜æ˜¯æå‰ç¼“å­˜ï¼›</li><li><strong>2ã€æ—¶æ•ˆæ€§ä¸åŒï¼š</strong> ä½¿ç”¨æ—¶ç¼“å­˜çš„ ID åœ¨ç±»å¸è½½åå¤±æ•ˆï¼Œåœ¨ç±»å¸è½½åä¸èƒ½ä½¿ç”¨ï¼Œè€Œç±»åŠ è½½æ—¶ç¼“å­˜åœ¨æ¯æ¬¡åŠ è½½ so åŠ¨æ€åº“æ—¶ä¼šé‡æ–°æ›´æ–°ç¼“å­˜ï¼Œå› æ­¤ç¼“å­˜çš„ ID æ˜¯ä¿æŒæœ‰æ•ˆçš„ã€‚</li></ul><h1 id="äº”ã€å¯¹è±¡å¼•ç”¨ç®¡ç†"><a href="#äº”ã€å¯¹è±¡å¼•ç”¨ç®¡ç†" class="headerlink" title="äº”ã€å¯¹è±¡å¼•ç”¨ç®¡ç†"></a>äº”ã€å¯¹è±¡å¼•ç”¨ç®¡ç†</h1><h2 id="5-1-å¼•ç”¨ç±»å‹"><a href="#5-1-å¼•ç”¨ç±»å‹" class="headerlink" title="5.1 å¼•ç”¨ç±»å‹"></a>5.1 å¼•ç”¨ç±»å‹</h2><p>JNIä¸­å­˜åœ¨ä¸‰ç§å¼•ç”¨ï¼šå±€éƒ¨å¼•ç”¨ã€å…¨å±€å¼•ç”¨ã€å¼±å…¨å±€å¼•ç”¨ã€‚</p><h3 id="5-1-1-å±€éƒ¨å¼•ç”¨"><a href="#5-1-1-å±€éƒ¨å¼•ç”¨" class="headerlink" title="5.1.1 å±€éƒ¨å¼•ç”¨"></a>5.1.1 å±€éƒ¨å¼•ç”¨</h3><p>JNIEnvæä¾›çš„å‡½æ•°æ‰€è¿”å›çš„å¼•ç”¨åŸºæœ¬ä¸Šéƒ½æ˜¯æœ¬åœ°å¼•ç”¨ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>å½“Nativeå‡½æ•°è¿”å›æ—¶ï¼Œè¿™ä¸ªæœ¬åœ°å¼•ç”¨å°±ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚</li><li>åªåœ¨åˆ›å»ºå®ƒçš„çº¿ç¨‹ä¸­æœ‰æ•ˆï¼Œä¸èƒ½å¤Ÿè·¨çº¿ç¨‹ä½¿ç”¨ã€‚</li><li>å±€éƒ¨å¼•ç”¨æ˜¯JVMè´Ÿè´£çš„å¼•ç”¨ç±»å‹ï¼Œå—JVMç®¡ç†ã€‚</li></ul><p><strong>å±€éƒ¨å¼•ç”¨å¯ä»¥é€šè¿‡<code>NewLocalRef</code>å‡½æ•°åˆ›å»ºï¼Œé€šè¿‡<code>DeleteLocalRef</code>å‡½æ•°æ¥é‡Šæ”¾ã€‚</strong></p><h3 id="5-1-2-å…¨å±€å¼•ç”¨"><a href="#5-1-2-å…¨å±€å¼•ç”¨" class="headerlink" title="5.1.2 å…¨å±€å¼•ç”¨"></a>5.1.2 å…¨å±€å¼•ç”¨</h3><p>å…¨å±€å¼•ç”¨ä¸æœ¬åœ°å¼•ç”¨ç›¸åï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>åœ¨nativeå‡½æ•°è¿”å›æ—¶ä¸ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œå› æ­¤å…¨å±€å¼•ç”¨éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œå¹¶ä¸”ä¸ä¼šè¢«GCå›æ”¶ã€‚</li><li>å…¨å±€å¼•ç”¨æ˜¯å¯ä»¥è·¨çº¿ç¨‹ä½¿ç”¨çš„ã€‚</li><li>å…¨å±€å¼•ç”¨ä¸å—åˆ°JVMç®¡ç†ã€‚</li></ul><p><strong>å…¨å±€å¼•ç”¨é€šè¿‡<code>JNIEnv</code>çš„<code>NewGlobalRef</code>å‡½æ•°åˆ›å»ºï¼Œé€šè¿‡<code>JNIEnv</code>çš„<code>DeleteGlobalRef</code>å‡½æ•°é‡Šæ”¾ã€‚</strong></p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp">jclass clazz = env-&gt;<span class="hljs-built_in">GetObjectClass</span>(classname);<br>jcalss mClass = (jcalss)env-&gt;<span class="hljs-built_in">NewGlobalRef</span>(clazz);<br>...<br>env-&gt;<span class="hljs-built_in">DeleteGlobalRef</span>(mClass)<br></code></pre></td></tr></table></figure><h3 id="5-1-3-å¼±å…¨å±€å¼•ç”¨"><a href="#5-1-3-å¼±å…¨å±€å¼•ç”¨" class="headerlink" title="5.1.3 å¼±å…¨å±€å¼•ç”¨"></a>5.1.3 å¼±å…¨å±€å¼•ç”¨</h3><p>å¼±å…¨å±€å¼•ç”¨æ˜¯ä¸€ç§ç‰¹æ®Šçš„å…¨å±€å¼•ç”¨ï¼Œå®ƒå’Œå…¨å±€å¼•ç”¨çš„ç‰¹ç‚¹ç›¸ä¼¼ï¼Œ<strong>ä½†æ˜¯å¼±å…¨å±€å¼•ç”¨æ˜¯å¯ä»¥è¢«GCå›æ”¶çš„</strong>ã€‚å¼±å…¨å±€å¼•ç”¨è¢«GCå›æ”¶ä¹‹åä¼šæŒ‡å‘NULLï¼Œå› æ­¤åœ¨è°ƒç”¨å‰éœ€è¦åˆ¤æ–­å®ƒæ˜¯å¦è¢«å›æ”¶äº†ï¼ˆé€šè¿‡<code>JNIEnv</code>çš„<code>IsSameObject</code>å‡½æ•°æ¥åˆ¤æ–­ï¼‰ã€‚</p><p><strong>å¼±å…¨å±€å¼•ç”¨é€šè¿‡<code>JNIEnv</code>çš„<code>NewWeakGlobalRef</code>å‡½æ•°æ¥åˆ›å»ºå¼±å…¨å±€å¼•ç”¨ï¼Œé€šè¿‡<code>JNIEnv</code>çš„<code>DeleteWeakGlobalRef</code>å‡½æ•°é‡Šæ”¾ã€‚</strong></p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp">jclass clazz = env-&gt;<span class="hljs-built_in">GetObjectClass</span>(classname);<br>jcalss mClass = (jcalss)env-&gt;<span class="hljs-built_in">NewWeakGlobalRef</span>(clazz);<br>env-&gt;<span class="hljs-built_in">DeleteWeakGlobalRef</span>(mClass)<br><span class="hljs-comment">//ä½¿ç”¨æ—¶</span><br><span class="hljs-keyword">if</span>(env-&gt;<span class="hljs-built_in">IsSameObject</span>(mClass,<span class="hljs-literal">NULL</span>))&#123;<br><span class="hljs-comment">//ä¸èƒ½ä½¿ç”¨</span><br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-comment">//å¯ä»¥ä½¿ç”¨</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-2-æ¯”è¾ƒå¼•ç”¨æ˜¯å¦æŒ‡å‘ç›¸åŒå¯¹è±¡"><a href="#5-2-æ¯”è¾ƒå¼•ç”¨æ˜¯å¦æŒ‡å‘ç›¸åŒå¯¹è±¡" class="headerlink" title="5.2 æ¯”è¾ƒå¼•ç”¨æ˜¯å¦æŒ‡å‘ç›¸åŒå¯¹è±¡"></a>5.2 æ¯”è¾ƒå¼•ç”¨æ˜¯å¦æŒ‡å‘ç›¸åŒå¯¹è±¡</h2><p>ä½¿ç”¨ <code>IsSameObject</code> åˆ¤æ–­ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦æŒ‡å‘ç›¸åŒå¯¹è±¡ï¼Œç¤ºä¾‹ä»£ç åŒä¸Šã€‚</p><p>å¦å¤–ï¼Œå½“å¼•ç”¨ä¸ <code>NULL</code> æ¯”è¾ƒæ—¶å«ä¹‰ç•¥æœ‰ä¸åŒï¼š</p><ul><li><strong>å±€éƒ¨å¼•ç”¨å’Œå…¨å±€å¼•ç”¨ä¸ NULL æ¯”è¾ƒï¼š</strong> ç”¨äºåˆ¤æ–­å¼•ç”¨æ˜¯å¦æŒ‡å‘ NULL å¯¹è±¡ï¼›</li><li><strong>å¼±å…¨å±€å¼•ç”¨ä¸ NULL æ¯”è¾ƒï¼š</strong> ç”¨äºåˆ¤æ–­å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦è¢«å›æ”¶ã€‚</li></ul><h1 id="å…­ã€å¼‚å¸¸å¤„ç†"><a href="#å…­ã€å¼‚å¸¸å¤„ç†" class="headerlink" title="å…­ã€å¼‚å¸¸å¤„ç†"></a>å…­ã€å¼‚å¸¸å¤„ç†</h1><h2 id="6-1-JNIå¼‚å¸¸å¤„ç†æœºåˆ¶"><a href="#6-1-JNIå¼‚å¸¸å¤„ç†æœºåˆ¶" class="headerlink" title="6.1 JNIå¼‚å¸¸å¤„ç†æœºåˆ¶"></a>6.1 JNIå¼‚å¸¸å¤„ç†æœºåˆ¶</h2><p>JNI ä¸­çš„å¼‚å¸¸æœºåˆ¶ä¸ Java å’Œ C&#x2F;C++ çš„å¤„ç†æœºåˆ¶éƒ½ä¸åŒï¼š</p><ul><li><strong>Java å’Œ C&#x2F;C++ï¼š</strong> ç¨‹åºä½¿ç”¨å…³é”®å­— <code>throw</code> æŠ›å‡ºå¼‚å¸¸ï¼Œè™šæ‹Ÿæœºä¼šä¸­æ–­å½“å‰æ‰§è¡Œæµç¨‹ï¼Œè½¬è€Œå»å¯»æ‰¾åŒ¹é…çš„catchå—ï¼Œæˆ–è€…ç»§ç»­å‘å¤–å±‚æŠ›å‡ºå¯»æ‰¾åŒ¹catchå—ã€‚</li><li><strong>JNI</strong>ï¼š ç¨‹åºä½¿ç”¨ JNI å‡½æ•° <code>ThrowNew</code> æŠ›å‡ºå¼‚å¸¸ï¼Œ<strong>å‘ç”Ÿå¼‚å¸¸æ—¶ç¨‹åºä¸ä¼šä¸­æ–­å½“å‰æ‰§è¡Œæµç¨‹</strong>ï¼Œè€Œæ˜¯è¿”å›åˆ°Javaå±‚åï¼Œè™šæ‹Ÿæœºæ‰ä¼šæŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚</li></ul><h2 id="6-2-æ£€æµ‹å¼‚å¸¸çš„æ–¹æ³•"><a href="#6-2-æ£€æµ‹å¼‚å¸¸çš„æ–¹æ³•" class="headerlink" title="6.2 æ£€æµ‹å¼‚å¸¸çš„æ–¹æ³•"></a>6.2 æ£€æµ‹å¼‚å¸¸çš„æ–¹æ³•</h2><p>JNIæ£€æµ‹å¼‚å¸¸çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p><ul><li>é€šè¿‡å‡½æ•°è¿”å›å€¼é”™è¯¯ç ï¼Œå¤§éƒ¨åˆ† JNI å‡½æ•°å’Œåº“å‡½æ•°éƒ½ä¼šæœ‰ç‰¹å®šçš„è¿”å›å€¼æ¥æ ‡ç¤ºé”™è¯¯ï¼Œä¾‹å¦‚ -1ã€NULL ç­‰ã€‚åœ¨ç¨‹åºæµç¨‹ä¸­å¯ä»¥å¤šæ£€æŸ¥å‡½æ•°è¿”å›å€¼æ¥åˆ¤æ–­å¼‚å¸¸ã€‚</li><li>é€šè¿‡ JNI å‡½æ•° <code>ExceptionOccurred</code> æˆ– <code>ExceptionCheck</code> æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å¼‚å¸¸å‘ç”Ÿã€‚</li></ul><h2 id="6-3-å¼‚å¸¸å‘ç”Ÿæ—¶çš„å¤„ç†æ–¹æ³•"><a href="#6-3-å¼‚å¸¸å‘ç”Ÿæ—¶çš„å¤„ç†æ–¹æ³•" class="headerlink" title="6.3 å¼‚å¸¸å‘ç”Ÿæ—¶çš„å¤„ç†æ–¹æ³•"></a>6.3 å¼‚å¸¸å‘ç”Ÿæ—¶çš„å¤„ç†æ–¹æ³•</h2><p>åœ¨ JNI å±‚å‡ºç°å¼‚å¸¸æ—¶ï¼Œæœ‰ä¸¤ç§å¤„ç†é€‰æ‹©ï¼š</p><ul><li>ç›´æ¥ <code>return</code> å½“å‰æ–¹æ³•ï¼Œè®© Java å±‚å»å¤„ç†è¿™ä¸ªå¼‚å¸¸ï¼ˆç±»ä¼¼Javaä¸­å‘æ–¹æ³•å¤–å±‚æŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚</li><li>é€šè¿‡ JNI å‡½æ•° <code>ExceptionClear</code> æ¸…é™¤è¿™ä¸ªå¼‚å¸¸ï¼Œå†æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºã€‚</li></ul><h2 id="6-4-JNIçš„å¼‚å¸¸å¤„ç†å‡½æ•°"><a href="#6-4-JNIçš„å¼‚å¸¸å¤„ç†å‡½æ•°" class="headerlink" title="6.4 JNIçš„å¼‚å¸¸å¤„ç†å‡½æ•°"></a>6.4 JNIçš„å¼‚å¸¸å¤„ç†å‡½æ•°</h2><p>JNI æä¾›äº†ä»¥ä¸‹ä¸å¼‚å¸¸å¤„ç†ç›¸å…³çš„å‡½æ•°ï¼š</p><ul><li><code>Throw(jthrowable obj)</code>ï¼šå‘Javaå±‚æŠ›å‡º<code>java.lang.Throwable</code>å¼‚å¸¸å¯¹è±¡ï¼Œè¯¥å¼‚å¸¸å¯¹è±¡å¯ä»¥é€šè¿‡<code>ExceptionOccurred()</code>è·å–ã€‚</li><li><code>ThrowNew(jclass clazz, const char* message)</code>ï¼šåˆ©ç”¨<code>message</code>æ„é€ å¼‚å¸¸å¯¹è±¡å¹¶å‘Javaå±‚æŠ›å‡ºå¼‚å¸¸ã€‚</li><li><code>ExceptionDescribe()</code>ï¼šæ‰“å°å¼‚å¸¸æè¿°ä¿¡æ¯ã€‚</li><li><code>ExceptionOccurred()</code>ï¼šæ£€æŸ¥å½“å‰ç¯å¢ƒæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œå¦‚æœå­˜åœ¨å¼‚å¸¸åˆ™è¿”å›è¯¥å¼‚å¸¸å¯¹è±¡ã€‚</li><li><code>ExceptionCheck()</code>ï¼šæ£€æŸ¥å½“å‰ç¯å¢ƒæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ã€‚</li><li><code>ExceptionClear()</code>ï¼šæ¸…é™¤å½“å‰ç¯å¢ƒçš„å¼‚å¸¸ã€‚</li><li><code>FatalError(const char* msg)</code>ï¼šæŠ›å‡ºè‡´å‘½é”™è¯¯å¹¶ä¸”ä¸å¸Œæœ›è™šæ‹Ÿæœºè¿›è¡Œä¿®å¤ã€‚</li></ul><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">JNIEXPORT <span class="hljs-type">void</span> JNICALL <span class="hljs-title">Java_com_example_nativetest_MainActivity_accessField</span><span class="hljs-params">(JNIEnv *env, jobject thiz)</span> </span>&#123;<br>    jclass  DemoClass = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;com/example/nativetest/Demo&quot;</span>);<br>    jfieldID aFieldID = env-&gt;<span class="hljs-built_in">GetStaticFieldID</span>(DemoClass,<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;I&quot;</span>);<span class="hljs-comment">//aä¸æ˜¯é™æ€å­—æ®µ</span><br>    <span class="hljs-keyword">if</span> (env-&gt;<span class="hljs-built_in">ExceptionCheck</span>())&#123;<br>        <span class="hljs-comment">//æ‰“å°å¼‚å¸¸ä¿¡æ¯</span><br>        env-&gt;<span class="hljs-built_in">ExceptionDescribe</span>();<br>        <span class="hljs-comment">//æ¸…é™¤å¼‚å¸¸ä¿¡æ¯</span><br>        env-&gt;<span class="hljs-built_in">ExceptionClear</span>();<br>        <span class="hljs-comment">//è¿›è¡Œå¼‚å¸¸å¤„ç†</span><br>        <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;å¼‚å¸¸å¤„ç†å®Œæ¯•&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ²¡æœ‰å¼‚å¸¸å¤„ç†çš„è¯ï¼Œç¨‹åºç›´æ¥å´©æºƒï¼›åŠ äº†å¼‚å¸¸å¤„ç†ä¹‹åï¼Œç¨‹åºèƒ½æ­£å¸¸è¿è¡Œï¼Œä¸”æ‰“å°å‡ºäº†ä¿¡æ¯ã€‚</p><h1 id="ä¸ƒã€å¤šçº¿ç¨‹"><a href="#ä¸ƒã€å¤šçº¿ç¨‹" class="headerlink" title="ä¸ƒã€å¤šçº¿ç¨‹"></a>ä¸ƒã€å¤šçº¿ç¨‹</h1><h2 id="7-1-ä¸èƒ½è·¨çº¿ç¨‹çš„å¼•ç”¨"><a href="#7-1-ä¸èƒ½è·¨çº¿ç¨‹çš„å¼•ç”¨" class="headerlink" title="7.1 ä¸èƒ½è·¨çº¿ç¨‹çš„å¼•ç”¨"></a>7.1 ä¸èƒ½è·¨çº¿ç¨‹çš„å¼•ç”¨</h2><p>åœ¨JNIä¸­ï¼Œæœ‰ä¸¤ç±»å¼•ç”¨æ˜¯æ— æ³•è·¨çº¿ç¨‹è°ƒç”¨çš„ï¼š</p><ul><li><p><strong>JNIEnv</strong></p><p>JNIåªåœ¨åˆ›å»ºå®ƒçš„çº¿ç¨‹ä¸­æœ‰æ•ˆï¼Œä¸èƒ½è·¨çº¿ç¨‹ä¼ é€’ï¼Œä¸åŒçº¿ç¨‹çš„JNIEnvæ˜¯å½¼æ­¤ç‹¬ç«‹çš„ã€‚</p><p>å¦‚éœ€è·å–JNIEnvï¼Œå¯é€šè¿‡JavaVMçš„<code>AttachCurrentThread</code>æ–¹æ³•å°†å½“å‰çº¿ç¨‹ä¾é™„åˆ°JavaVMä¸Šï¼Œè·å–å±äºå½“å‰çº¿ç¨‹çš„JNIEnvæŒ‡é’ˆï¼Œäº‹åéœ€è°ƒç”¨<code>DetachCurrentThread</code>æ–¹æ³•è§£é™¤ä¾é™„ã€‚</p><p>å¦‚æœå½“å‰çº¿ç¨‹å·²ç»ä¾é™„åˆ°JavaVMä¸Šï¼Œå¯ç›´æ¥ä½¿ç”¨<code>GetEnv</code>æ–¹æ³•ã€‚</p></li><li><p><strong>å±€éƒ¨å¼•ç”¨</strong></p><p>å±€éƒ¨å¼•ç”¨åªåœ¨åˆ›å»ºçš„çº¿ç¨‹å’Œæ–¹æ³•ä¸­æœ‰æ•ˆï¼Œä¸èƒ½è·¨çº¿ç¨‹ä½¿ç”¨ã€‚å¯ä»¥å°†å±€éƒ¨å¼•ç”¨å‡çº§ä¸ºå…¨å±€å¼•ç”¨åè·¨çº¿ç¨‹ä½¿ç”¨ã€‚</p></li></ul><h2 id="7-2-çº¿ç¨‹åˆ›å»º"><a href="#7-2-çº¿ç¨‹åˆ›å»º" class="headerlink" title="7.2 çº¿ç¨‹åˆ›å»º"></a>7.2 çº¿ç¨‹åˆ›å»º</h2><p>çº¿ç¨‹åˆ›å»ºçš„æ–¹æ³•æœ‰ä¸¤ç§</p><ul><li><p>é€šè¿‡Java APIåˆ›å»ºï¼šåå°„è°ƒç”¨Javaçš„Threadç±»åˆ›å»ºã€‚</p></li><li><p>é€šè¿‡C&#x2F;C++ APIåˆ›å»ºï¼šä½¿ç”¨<code>pthread_create()</code>æˆ–<code>std::thread</code>åˆ›å»ºçº¿ç¨‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">pthread_create</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span>* __pthread_ptr, <span class="hljs-type">pthread_attr_t</span> <span class="hljs-type">const</span>* __attr, <span class="hljs-type">void</span>* (*__start_routine)(<span class="hljs-type">void</span>*), <span class="hljs-type">void</span>*)</span></span>;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæ˜¯æŒ‡å‘pthreadçš„æŒ‡é’ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹idï¼Œç¬¬äºŒä¸ªæ˜¯çº¿ç¨‹å±æ€§ï¼Œç¬¬ä¸‰ä¸ªæ˜¯çº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°ï¼Œç¬¬å››ä¸ªæ˜¯å‡½æ•°å‚æ•°ã€‚</p></li></ul><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">myThread</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span></span>&#123;<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;come into Thread, a = %d&quot;</span>, a);<br>&#125;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span><br><span class="hljs-function">JNIEXPORT <span class="hljs-type">void</span> JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_nativetest_MainActivity_accessField</span><span class="hljs-params">(JNIEnv *env, jobject thiz)</span> </span>&#123;<br>    jclass  DemoClass = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;com/example/nativetest/Demo&quot;</span>);<br>    <span class="hljs-type">pthread_t</span> pthread;<br>    <span class="hljs-built_in">pthread_create</span>(&amp;pthread, <span class="hljs-literal">nullptr</span>, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *(*)(<span class="hljs-type">void</span> *)&gt;(myThread),<br>                   <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(<span class="hljs-number">5</span>));<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    å¯ä»¥è°ƒç”¨pthread_join(pthread_t, returnresultpointer)è®©ä¸»çº¿ç¨‹è¿›å…¥é˜»å¡ï¼Œ</span><br><span class="hljs-comment">    ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œåæ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;complete&quot;</span>);<span class="hljs-comment">//å›åˆ°ä¸»çº¿ç¨‹åï¼Œä¸ç®¡å­çº¿ç¨‹æœ‰æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¼šç»§ç»­å¾€ä¸‹èµ°</span><br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ¶‰åŠåˆ°å¤šå‚æ•°ä¼ é€’ï¼Œå°±éœ€è¦ä½¿ç”¨ç»“æ„ä½“æ¥å°è£…å‚æ•°ï¼Œå°†ç»“æ„ä½“æŒ‡é’ˆä¼ ç»™çº¿ç¨‹ã€‚</strong></p><h2 id="7-3-ç›‘è§†å™¨åŒæ­¥"><a href="#7-3-ç›‘è§†å™¨åŒæ­¥" class="headerlink" title="7.3 ç›‘è§†å™¨åŒæ­¥"></a>7.3 ç›‘è§†å™¨åŒæ­¥</h2><p>åœ¨JNIä¸­ï¼Œä¹Ÿå­˜åœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºçš„æƒ…å†µï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦äº’æ–¥é”æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚åœ¨Javaå±‚ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨<code>synchronized</code> å…³é”®å­—æ¥å®ç°äº’æ–¥ï¼Œåœ¨JNIå±‚ä¸­ï¼Œæä¾›äº†å¦‚ä¸‹å‡½æ•°å®ç°äº’æ–¥ï¼š</p><ul><li><code>MonitorEnter(jobject obj)</code>ï¼šè¿›å…¥åŒæ­¥å—ã€‚å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹å·²ç»è¿›å…¥è¯¥ jobject çš„ç›‘è§†å™¨ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šé˜»å¡ã€‚</li><li><code>MonitorExit(jobject obj)</code>ï¼šé€€å‡ºåŒæ­¥å—ã€‚å¦‚æœå½“å‰çº¿ç¨‹æœªè¿›å…¥è¯¥ jobject çš„ç›‘è§†å™¨ï¼Œåˆ™ä¼šæŠ›å‡º <code>IllegalMonitorStateException</code> å¼‚å¸¸ã€‚</li></ul><h2 id="7-4-ç­‰å¾…ä¸å”¤é†’"><a href="#7-4-ç­‰å¾…ä¸å”¤é†’" class="headerlink" title="7.4 ç­‰å¾…ä¸å”¤é†’"></a>7.4 ç­‰å¾…ä¸å”¤é†’</h2><p>JNI æ²¡æœ‰åƒJavaä¸€æ ·æä¾› wait&#x2F;notify ç›¸å…³åŠŸèƒ½çš„å‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦åå°„ Java æ–¹æ³•çš„æ–¹å¼æ¥å®ç°ã€‚</p><h1 id="å…«ã€JNI-OnLoad"><a href="#å…«ã€JNI-OnLoad" class="headerlink" title="å…«ã€JNI_OnLoad"></a>å…«ã€JNI_OnLoad</h1><p>å½“Javaå±‚é€šè¿‡<code>System.loadLibrary</code>æ–¹æ³•åŠ è½½soåº“æ—¶ï¼Œé¦–å…ˆä¼šè‡ªåŠ¨è°ƒç”¨<code>JNI_OnLoad</code>å‡½æ•°ï¼Œä¸”ç³»ç»Ÿä¼šå¸®æˆ‘ä»¬å®ç°<code>JNI_OnLoad</code>å‡½æ•°ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦é‡å®ç°<code>JNI_OnLoad</code>å‡½æ•°ï¼Œåˆ™å‡½æ•°çš„è¿”å›å€¼å¿…é¡»æ—¶JNIç‰ˆæœ¬ <code>JNI_VERSION_1_6</code>ã€‚</p><p>åœ¨<code>JNI_OnLoad</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€æ³¨å†Œnativeæ–¹æ³•ã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">JNIEXPORT jint JNICALL <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM* vm, <span class="hljs-type">void</span>* reserved)</span></span>&#123;<br>    JNIEnv* env = <span class="hljs-literal">nullptr</span>;<br>    jint result = <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-keyword">if</span> (vm-&gt;<span class="hljs-built_in">GetEnv</span>((<span class="hljs-type">void</span>**)&amp;env,JNI_VERSION_1_6) != JNI_OK)&#123;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    JNINativeMethod jmethods[] = &#123;<br>            &#123;<span class="hljs-string">&quot;DynamicRegistration&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>, (<span class="hljs-type">void</span> *)(DynamicRegistrationNative)&#125;<span class="hljs-comment">//DynamicRegistrationNativeä¸ºnativeæ–¹æ³•</span><br>    &#125;;<br>    <span class="hljs-comment">//è·å–åŠ¨æ€æ³¨å†Œçš„å‡½æ•°æ‰€åœ¨çš„ç±»</span><br>    jclass  clz = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;com/example/nativetest/MainActivity&quot;</span>);<br>    env-&gt;<span class="hljs-built_in">RegisterNatives</span>(clz,jmethods,<span class="hljs-built_in">sizeof</span>(jmethods)/<span class="hljs-built_in">sizeof</span>(JNINativeMethod));<br><br>    result = JNI_VERSION_1_6;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¹ã€æ—¥å¿—è¾“å‡º"><a href="#ä¹ã€æ—¥å¿—è¾“å‡º" class="headerlink" title="ä¹ã€æ—¥å¿—è¾“å‡º"></a>ä¹ã€æ—¥å¿—è¾“å‡º</h1><ol><li>å¯¼å…¥<code>&lt;android/log.h&gt;</code>åº“ã€‚</li><li>å®šä¹‰å®TAGã€‚</li><li>åˆ©ç”¨å®å®šä¹‰æ¥å®šä¹‰LOGDæˆ–LOGIæˆ–LOGEå‡½æ•°ã€‚</li></ol><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;jni.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/log.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,TAG ,__VA_ARGS__)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO , TAG, __VA_ARGS__);</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, TAG, __VA_ARGS__);</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TAG <span class="hljs-string">&quot;gal2xy&quot;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">JNIEXPORT <span class="hljs-type">void</span> JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_nativetest_MainActivity_accessField</span><span class="hljs-params">(JNIEnv *env, jobject thiz)</span> </span>&#123;<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;come into native method: accessField&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="åã€Nativeæ–¹æ³•æ³¨å†Œ"><a href="#åã€Nativeæ–¹æ³•æ³¨å†Œ" class="headerlink" title="åã€Nativeæ–¹æ³•æ³¨å†Œ"></a>åã€Nativeæ–¹æ³•æ³¨å†Œ</h1><p>Nativeæ–¹æ³•çš„æ³¨å†Œå¯åˆ†ä¸ºä¸¤ç§ï¼šé™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œã€‚å®ƒä»¬çš„åŸç†åˆ†æè¯¦è§<a href="https://gal2xy.github.io/2023/12/10/JNI%E5%8E%9F%E7%90%86/#%E4%B8%89%E3%80%81Native%E6%B3%A8%E5%86%8C%E6%96%B9%E6%B3%95">JNIåŸç†#ä¸‰ã€Nativeæ³¨å†Œæ–¹æ³•</a>ï¼Œè¿™é‡Œåªè®²å¦‚ä½•ä½¿ç”¨ã€‚</p><h2 id="10-1-é™æ€æ³¨å†Œ"><a href="#10-1-é™æ€æ³¨å†Œ" class="headerlink" title="10.1 é™æ€æ³¨å†Œ"></a>10.1 é™æ€æ³¨å†Œ</h2><p>é™æ€æ³¨å†Œé‡‡ç”¨çš„æ˜¯åŸºäºã€Œçº¦å®šã€çš„å‘½åè§„åˆ™ï¼Œç”±äºC&#x2F;C++æ— æ³•å®ç°é‡è½½å‡½æ•°ï¼Œæ‰€ä»¥æ ¹æ®æœ‰æ— é‡è½½åˆ†ä¸ºä¸¤ç§è§„åˆ™ï¼š</p><ul><li><strong>çŸ­åç§°è§„åˆ™</strong> ï¼š<code>Java_[ç±»çš„å…¨é™å®šå (å¸¦ä¸‹åˆ’çº¿)]_[æ–¹æ³•å]</code> ï¼Œå…¶ä¸­ç±»çš„å…¨é™å®šåä¸­çš„ <code>.</code> æ”¹ä¸º <code>_</code> ï¼›</li><li><strong>é•¿åç§°è§„åˆ™</strong> ï¼šåœ¨çŸ­åç§°çš„åŸºç¡€ä¸Šåè¿½åŠ ä¸¤ä¸ªä¸‹åˆ’çº¿ï¼ˆ<code>__</code>ï¼‰å’Œå‚æ•°æè¿°ç¬¦ï¼Œä»¥åŒºåˆ†å‡½æ•°é‡è½½ã€‚</li></ul><p>é™æ€æ³¨å†Œçš„å‡½æ•°éœ€è¦æš´éœ²åˆ°ç¬¦å·è¡¨ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ·»åŠ å®å®šä¹‰<code>JNIEXPORT</code>ã€‚</p><h2 id="10-2-åŠ¨æ€æ³¨å†Œ"><a href="#10-2-åŠ¨æ€æ³¨å†Œ" class="headerlink" title="10.2 åŠ¨æ€æ³¨å†Œ"></a>10.2 åŠ¨æ€æ³¨å†Œ</h2><p>åŠ¨æ€æ³¨å†Œéœ€è¦ä½¿ç”¨ <code>RegisterNatives</code> å‡½æ•°ï¼Œå› ä¸ºæ˜¯åŠ¨æ€æ³¨å†Œï¼Œæ‰€ä»¥å‡½æ•°å¹¶ä¸éœ€è¦æš´éœ²åˆ°ç¬¦å·è¡¨ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">jint <span class="hljs-title">RegisterNatives</span><span class="hljs-params">(jclass clazz, <span class="hljs-type">const</span> JNINativeMethod* methods, jint nMethods)</span></span><br><span class="hljs-function">jint <span class="hljs-title">UnregisterNatives</span><span class="hljs-params">(jclass clazz)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name;      <span class="hljs-comment">// Javaæ–¹æ³•å</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* signature; <span class="hljs-comment">// æ–¹æ³•ç­¾å</span><br>    <span class="hljs-type">void</span>*       fnPtr;     <span class="hljs-comment">// å‡½æ•°æŒ‡é’ˆ</span><br>&#125; JNINativeMethod;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><p>åœ¨Javaå±‚çš„MainActivityä¸­ï¼Œå£°æ˜äº†ä¸€ä¸ªnativeæ–¹æ³•ï¼š</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DynamicRegistration</span><span class="hljs-params">()</span></span>;<br></code></pre></td></tr></table></figure><p>å¹¶ä¸”è°ƒç”¨äº†è¯¥æ–¹æ³•ã€‚ç„¶ånativeå±‚çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//æ‰€è¦åŠ¨æ€åŠ è½½çš„å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DynamicRegistrationNative</span><span class="hljs-params">(JNIEnv *env, jobject thiz)</span> </span>&#123;<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;call DynamicRegistration method&quot;</span>);<br>&#125;<br><span class="hljs-comment">//ä½¿ç”¨JNINativeMethodç»“æ„ä½“è®°å½•è¦åŠ¨æ€æ³¨å†Œçš„å‡½æ•°</span><br>JNINativeMethod jmethods[] = &#123;<br>        &#123;<span class="hljs-string">&quot;DynamicRegistration&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>, (<span class="hljs-type">void</span> *)(DynamicRegistrationNative)&#125;<br>&#125;;<br><span class="hljs-comment">//åœ¨JNI_OnLoadå‡½æ•°ä¸­å®ç°åŠ¨æ€æ³¨å†Œ</span><br><span class="hljs-function">JNIEXPORT jint JNICALL <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM* vm, <span class="hljs-type">void</span>* reserved)</span></span>&#123;<br>    JNIEnv* env = <span class="hljs-literal">nullptr</span>;<br>    jint result = <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-keyword">if</span> (vm-&gt;<span class="hljs-built_in">GetEnv</span>((<span class="hljs-type">void</span>**)&amp;env,JNI_VERSION_1_6) != JNI_OK)&#123;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-comment">//è·å–åŠ¨æ€æ³¨å†Œçš„å‡½æ•°æ‰€åœ¨çš„ç±»</span><br>    jclass  clz = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;com/example/nativetest/MainActivity&quot;</span>);<br>    env-&gt;<span class="hljs-built_in">RegisterNatives</span>(clz,jmethods,<span class="hljs-built_in">sizeof</span>(jmethods)/<span class="hljs-built_in">sizeof</span>(JNINativeMethod));<br><br>    result = JNI_VERSION_1_6;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="10-3-æ³¨å†Œæ—¶æœº"><a href="#10-3-æ³¨å†Œæ—¶æœº" class="headerlink" title="10.3 æ³¨å†Œæ—¶æœº"></a>10.3 æ³¨å†Œæ—¶æœº</h2><table><thead><tr><th align="left">æ³¨å†Œæ—¶æœº</th><th align="left">æ³¨å†Œæ–¹å¼</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">ç¬¬ä¸€æ¬¡è°ƒç”¨native æ–¹æ³•æ—¶</td><td align="left">é™æ€æ³¨å†Œ</td><td align="left">è™šæ‹Ÿæœºä¼šåœ¨ JNI å‡½æ•°åº“ä¸­æœç´¢è¯¥å‡½æ•°æŒ‡é’ˆå¹¶è®°å½•ä¸‹æ¥ï¼Œåç»­è°ƒç”¨ä¸éœ€è¦é‡å¤æœç´¢ã€‚</td></tr><tr><td align="left">åŠ è½½ so åº“æ—¶</td><td align="left">åŠ¨æ€æ³¨å†Œ</td><td align="left">åŠ è½½ so åº“æ—¶ä¼šè‡ªåŠ¨å›è°ƒ JNI_OnLoad å‡½æ•°ï¼Œåœ¨å…¶ä¸­è°ƒç”¨ RegisterNatives æ³¨å†Œã€‚</td></tr><tr><td align="left">æå‰æ³¨å†Œ</td><td align="left">åŠ¨æ€æ³¨å†Œ</td><td align="left">åœ¨åŠ è½½ so åº“åï¼Œè°ƒç”¨è¯¥ native æ–¹æ³•å‰ï¼Œé€šè¿‡<u>é™æ€æ³¨å†Œçš„ native å‡½æ•°</u>è§¦å‘ RegisterNatives æ³¨å†Œã€‚ä¾‹å¦‚åœ¨ App å¯åŠ¨æ—¶ï¼Œå¾ˆå¤šç³»ç»Ÿæºç ä¼šæå‰åšä¸€æ¬¡æ³¨å†Œã€‚</td></tr></tbody></table><h1 id="åä¸€ã€JavaVM"><a href="#åä¸€ã€JavaVM" class="headerlink" title="åä¸€ã€JavaVM"></a>åä¸€ã€JavaVM</h1><h2 id="11-1-JavaVMæ˜¯ä»€ä¹ˆ"><a href="#11-1-JavaVMæ˜¯ä»€ä¹ˆ" class="headerlink" title="11.1 JavaVMæ˜¯ä»€ä¹ˆ"></a>11.1 JavaVMæ˜¯ä»€ä¹ˆ</h2><p><code>JavaVM</code>æ˜¯ <code>Java </code>è™šæ‹Ÿæœºåœ¨ <code>JNI </code>å±‚çš„ä»£è¡¨ï¼Œåœ¨ä¸€ä¸ªè™šæ‹Ÿæœºè¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ª <code>JVM</code>ï¼Œå› æ­¤è¯¥è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ª <code>JVM</code>ã€‚<code>JavaVM</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">_JavaVM</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__cplusplus)</span><br><span class="hljs-comment">//C++çš„å®å®šä¹‰</span><br><span class="hljs-keyword">typedef</span> _JavaVM JavaVM;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-comment">//Cçš„å®å®šä¹‰</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNIInvokeInterface</span>* JavaVM;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * JNI invocation interface.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNIInvokeInterface</span> &#123;<br>    <span class="hljs-type">void</span>*       reserved0;<br>    <span class="hljs-type">void</span>*       reserved1;<br>    <span class="hljs-type">void</span>*       reserved2;<br><br>    <span class="hljs-built_in">jint</span>        (*DestroyJavaVM)(JavaVM*);<br>    <span class="hljs-built_in">jint</span>        (*AttachCurrentThread)(JavaVM*, JNIEnv**, <span class="hljs-type">void</span>*);<br>    <span class="hljs-built_in">jint</span>        (*DetachCurrentThread)(JavaVM*);<br>    <span class="hljs-built_in">jint</span>        (*GetEnv)(JavaVM*, <span class="hljs-type">void</span>**, jint);<br>    <span class="hljs-built_in">jint</span>        (*AttachCurrentThreadAsDaemon)(JavaVM*, JNIEnv**, <span class="hljs-type">void</span>*);<br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * C++ version.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">_JavaVM</span> &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNIInvokeInterface</span>* functions;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__cplusplus)</span><br>    <span class="hljs-function">jint <span class="hljs-title">DestroyJavaVM</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">DestroyJavaVM</span>(<span class="hljs-keyword">this</span>); &#125;<br>    <span class="hljs-function">jint <span class="hljs-title">AttachCurrentThread</span><span class="hljs-params">(JNIEnv** p_env, <span class="hljs-type">void</span>* thr_args)</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">AttachCurrentThread</span>(<span class="hljs-keyword">this</span>, p_env, thr_args); &#125;<br>    <span class="hljs-function">jint <span class="hljs-title">DetachCurrentThread</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">DetachCurrentThread</span>(<span class="hljs-keyword">this</span>); &#125;<br>    <span class="hljs-function">jint <span class="hljs-title">GetEnv</span><span class="hljs-params">(<span class="hljs-type">void</span>** env, jint version)</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">GetEnv</span>(<span class="hljs-keyword">this</span>, env, version); &#125;<br>    <span class="hljs-function">jint <span class="hljs-title">AttachCurrentThreadAsDaemon</span><span class="hljs-params">(JNIEnv** p_env, <span class="hljs-type">void</span>* thr_args)</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">AttachCurrentThreadAsDaemon</span>(<span class="hljs-keyword">this</span>, p_env, thr_args); &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/*__cplusplus*/</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>_JavaVM</code>å…¶å®æ˜¯å¯¹<code>JNIInvokeInterface</code>çš„ä¸€ä¸ªå°è£…ç»“æ„ä½“ï¼Œé‡Œé¢çš„æ–¹æ³•æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨<code>JNIInvokeInterface</code>çš„æ–¹æ³•å®ç°ã€‚</p><p>åœ¨ä»¥ä¸Šæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨<code>GetEnv()</code>æ–¹æ³•æˆ–è€…<code>AttachCurrentThread()</code>æ–¹æ³•ï¼ˆå­çº¿ç¨‹ä¸­ï¼‰æ¥è·å–<code>JNIEnv</code>ã€‚</p><p>ç”±äº<code>JavaVm</code>åœ¨Cå’ŒC++ä¸­çš„å®å®šä¹‰ä¸åŒï¼ˆCä¸­æ˜¯ç»“æ„ä½“æŒ‡é’ˆï¼ŒC++ä¸­æ˜¯ç»“æ„ä½“ï¼‰ï¼Œå› æ­¤ä½¿ç”¨æ—¶æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp">JavaVM* vm;<br>JNIEnv* env = <span class="hljs-literal">nullptr</span>;<br><span class="hljs-comment">//C++</span><br>vm-&gt;<span class="hljs-built_in">GetEnv</span>((<span class="hljs-type">void</span>**)&amp;env,JNI_VERSION_1_6);<br><span class="hljs-comment">//C</span><br>(*vm)-&gt;<span class="hljs-built_in">GetEnv</span>((<span class="hljs-type">void</span>**)&amp;env,JNI_VERSION_1_6);<br></code></pre></td></tr></table></figure><h2 id="11-2-JavaVMçš„è·å–"><a href="#11-2-JavaVMçš„è·å–" class="headerlink" title="11.2 JavaVMçš„è·å–"></a>11.2 JavaVMçš„è·å–</h2><p>é€šè¿‡<code>JNIEnv</code>çš„<code>GetJavaVM(JavaVM** vm)</code>æ–¹æ³•æ¥è·å–<code>JavaVM</code>ã€‚</p><h1 id="åäºŒã€JNIEnv"><a href="#åäºŒã€JNIEnv" class="headerlink" title="åäºŒã€JNIEnv"></a>åäºŒã€JNIEnv</h1><h2 id="12-1-JNIEnvæ˜¯ä»€ä¹ˆ"><a href="#12-1-JNIEnvæ˜¯ä»€ä¹ˆ" class="headerlink" title="12.1 JNIEnvæ˜¯ä»€ä¹ˆ"></a>12.1 JNIEnvæ˜¯ä»€ä¹ˆ</h2><p><code>JNIEnv</code> æ˜¯ Native å±‚ä¸­ Java ç¯å¢ƒçš„ä»£è¡¨ï¼Œé€šè¿‡ <code>JNIEnv*</code> æŒ‡é’ˆå°±å¯ä»¥åœ¨ Native å±‚ä¸­è®¿é—® Java å±‚çš„ä»£ç å¹¶è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚è°ƒç”¨ Java çš„æ–¹æ³•ã€æ“ä½œ Java çš„å˜é‡å’Œå¯¹è±¡ç­‰ã€‚ä½†æ˜¯å®ƒåªåœ¨åˆ›å»ºå®ƒçš„çº¿ç¨‹ä¸­æœ‰æ•ˆï¼Œä¸èƒ½è·¨çº¿ç¨‹ä¼ é€’ï¼Œ å› æ­¤ä¸åŒçº¿ç¨‹çš„ JNIEnv æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ã€‚</p><p><code>JNIEnv</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">_JNIEnv</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__cplusplus)</span><br><span class="hljs-keyword">typedef</span> _JNIEnv JNIEnv;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNINativeInterface</span>* JNIEnv;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">_JNIEnv</span> &#123;<br>    <span class="hljs-comment">/* do not rename this; it does not seem to be entirely opaque */</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNINativeInterface</span>* functions;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__cplusplus)</span><br>    <span class="hljs-function">jint <span class="hljs-title">GetVersion</span><span class="hljs-params">()</span></span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">GetVersion</span>(<span class="hljs-keyword">this</span>); &#125;<br><br>    <span class="hljs-function">jclass <span class="hljs-title">DefineClass</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, jobject loader, <span class="hljs-type">const</span> jbyte* buf, jsize bufLen)</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">DefineClass</span>(<span class="hljs-keyword">this</span>, name, loader, buf, bufLen); &#125;<br>...<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNINativeInterface</span> &#123;<br>    <span class="hljs-type">void</span>*       reserved0;<br>    <span class="hljs-type">void</span>*       reserved1;<br>    <span class="hljs-type">void</span>*       reserved2;<br>    <span class="hljs-type">void</span>*       reserved3;<br>    <span class="hljs-built_in">jint</span>        (*GetVersion)(JNIEnv *);<br>    <span class="hljs-built_in">jclass</span>      (*DefineClass)(JNIEnv*, <span class="hljs-type">const</span> <span class="hljs-type">char</span>*, jobject, <span class="hljs-type">const</span> jbyte*, jsize);<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·çš„<code>_JNIEnv</code>å…¶å®æ˜¯å¯¹<code>JNINativeInterface</code>çš„ä¸€ä¸ªå°è£…ç»“æ„ä½“ï¼Œé‡Œé¢çš„æ–¹æ³•æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨<code>JNINativeInterface</code>çš„æ–¹æ³•å®ç°ã€‚</p><p>ç”±äºJNIEnvåœ¨Cå’ŒC++ä¸­çš„å®å®šä¹‰ä¸åŒï¼ˆCä¸­æ˜¯ç»“æ„ä½“æŒ‡é’ˆï¼ŒC++ä¸­æ˜¯ç»“æ„ä½“ï¼‰ï¼Œå› æ­¤ä½¿ç”¨æ—¶æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">JNIEnv* env;<br><span class="hljs-comment">//C++</span><br>env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;java/lang/String&quot;</span>);<br><span class="hljs-comment">//C</span><br>(*env)-&gt;<span class="hljs-built_in">FindClass</span>(env, <span class="hljs-string">&quot;java/lang/String&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="12-2-JNIEnvçš„è·å–"><a href="#12-2-JNIEnvçš„è·å–" class="headerlink" title="12.2 JNIEnvçš„è·å–"></a>12.2 JNIEnvçš„è·å–</h2><p>é€šè¿‡<code>JavaVM</code>çš„<code>GetEnv()</code>æ–¹æ³•æˆ–è€…<code>AttachCurrentThread()</code>æ–¹æ³•ï¼ˆå­çº¿ç¨‹ä¸­ï¼‰æ¥è·å–<code>JNIEnv</code>ã€‚</p><h1 id="åä¸‰ã€SOæ–‡ä»¶ç”Ÿæˆçš„ç›¸å…³äº‹é¡¹"><a href="#åä¸‰ã€SOæ–‡ä»¶ç”Ÿæˆçš„ç›¸å…³äº‹é¡¹" class="headerlink" title="åä¸‰ã€SOæ–‡ä»¶ç”Ÿæˆçš„ç›¸å…³äº‹é¡¹"></a>åä¸‰ã€SOæ–‡ä»¶ç”Ÿæˆçš„ç›¸å…³äº‹é¡¹</h1><h2 id="13-1-Nativeå±‚åˆ›å»ºCPPæ–‡ä»¶"><a href="#13-1-Nativeå±‚åˆ›å»ºCPPæ–‡ä»¶" class="headerlink" title="13.1 Nativeå±‚åˆ›å»ºCPPæ–‡ä»¶"></a>13.1 Nativeå±‚åˆ›å»ºCPPæ–‡ä»¶</h2><p>åœ¨<code>main/cpp</code>ç›®å½•ä¸‹åˆ›å»ºçš„æ–°cppæ–‡ä»¶ï¼Œéœ€è¦åœ¨<code>CMakeLists.txt</code>ä¸­çš„<code>add_library</code>ä¸­å£°æ˜ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312261957688.png"></p><h2 id="13-2-å¤šä¸ªcppç¼–è¯‘æˆå¤šä¸ªsoåº“-x2F-ä¸€ä¸ªsoåº“"><a href="#13-2-å¤šä¸ªcppç¼–è¯‘æˆå¤šä¸ªsoåº“-x2F-ä¸€ä¸ªsoåº“" class="headerlink" title="13.2 å¤šä¸ªcppç¼–è¯‘æˆå¤šä¸ªsoåº“&#x2F;ä¸€ä¸ªsoåº“"></a>13.2 å¤šä¸ªcppç¼–è¯‘æˆå¤šä¸ªsoåº“&#x2F;ä¸€ä¸ªsoåº“</h2><p>é»˜è®¤æƒ…å†µï¼ˆåªæœ‰ä¸€ä¸ª<code>add_library</code>æ ‡ç­¾ï¼‰æ˜¯æ— è®ºå¤šå°‘cppæ–‡ä»¶ï¼Œåªç¼–è¯‘æˆä¸€ä¸ªsoåº“ã€‚</p><p>æƒ³è¦ç¼–è¯‘æˆå¤šä¸ªsoåº“ï¼Œå¯ä»¥é€šè¿‡é¢å¤–æ·»åŠ <code>add_library</code>æ ‡ç­¾ï¼Œåœ¨å…¶ä¸­æŒ‡å®šsoåº“çš„åå­—å’Œæ‰€æ¶‰åŠåˆ°çš„cppæ–‡ä»¶ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312262013223.png"></p><h2 id="13-3-è‡ªå®šä¹‰soæ–‡ä»¶å"><a href="#13-3-è‡ªå®šä¹‰soæ–‡ä»¶å" class="headerlink" title="13.3 è‡ªå®šä¹‰soæ–‡ä»¶å"></a>13.3 è‡ªå®šä¹‰soæ–‡ä»¶å</h2><p>åœ¨<code>add_library</code>æ ‡ç­¾ä¸­ç›´æ¥å†™æ˜ï¼Œè§ä¸Šå›¾æ‰€ç¤ºã€‚</p><h2 id="13-4-æ·»åŠ ç¬¬ä¸‰æ–¹åº“æˆ–è€…ç³»ç»Ÿåº“"><a href="#13-4-æ·»åŠ ç¬¬ä¸‰æ–¹åº“æˆ–è€…ç³»ç»Ÿåº“" class="headerlink" title="13.4 æ·»åŠ ç¬¬ä¸‰æ–¹åº“æˆ–è€…ç³»ç»Ÿåº“"></a>13.4 æ·»åŠ ç¬¬ä¸‰æ–¹åº“æˆ–è€…ç³»ç»Ÿåº“</h2><p>å¦‚æœæƒ³è¦æ·»åŠ ç¬¬ä¸‰æ–¹åº“æˆ–è€…ç³»ç»Ÿåº“ï¼Œåˆ™éœ€æŒ‰å¦‚ä¸‹æ­¥éª¤è¿›è¡Œï¼š</p><ol><li><p>å°†soåº“å¤åˆ¶åˆ°<code>src/main/jniLibs/$&#123;æ¶æ„åç§°&#125;</code>ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312262124191.png"></p></li><li><p>å¦‚æœéœ€è¦ç›¸å…³çš„<code>.h</code>å¤´æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°cppç›®å½•ä¸‹æˆ–åˆ™æ–°å»ºç›®å½•ã€‚</p></li><li><p>åœ¨<code>CMakeLists.txt</code>ä¸­å£°æ˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312262134297.png"></p></li></ol><p>ç”Ÿæˆçš„apkçš„soåº“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312262134616.png"></p><p>æ˜æ˜¾å°†ç¬¬ä¸‰æ–¹åº“é“¾æ¥è¿›æ¥äº†ã€‚</p><h2 id="13-5-ç”ŸæˆæŒ‡å®šæ¶æ„çš„soåº“"><a href="#13-5-ç”ŸæˆæŒ‡å®šæ¶æ„çš„soåº“" class="headerlink" title="13.5 ç”ŸæˆæŒ‡å®šæ¶æ„çš„soåº“"></a>13.5 ç”ŸæˆæŒ‡å®šæ¶æ„çš„soåº“</h2><p>å¦‚æœæƒ³è¦ç”ŸæˆæŒ‡å®šåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼ˆABIï¼‰çš„soåº“ï¼Œå¯ä»¥åœ¨<code>buid.gradle.kts</code>æ–‡ä»¶ä¸­å£°æ˜ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312251147863.png"></p><h2 id="13-6-Nativeå±‚è°ƒç”¨soåº“"><a href="#13-6-Nativeå±‚è°ƒç”¨soåº“" class="headerlink" title="13.6 Nativeå±‚è°ƒç”¨soåº“"></a>13.6 Nativeå±‚è°ƒç”¨soåº“</h2><p>ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡<code>dlopen</code>å‡½æ•°æ‰“å¼€soåº“ï¼Œé€šè¿‡<code>dlsym</code>å‡½æ•°è·å–æŒ‡å®šå‡½æ•°çš„å¥æŸ„æ¥ä½¿ç”¨ï¼Œä»¥ä¸Šæ–¹æ³•éœ€è¦å¯¼å…¥<code>dlfcn.h</code>æ‰èƒ½ä½¿ç”¨ã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//å®šä¹‰å‡½æ•°åå¯¼å‡ºç¬¦å·</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OpenMemory <span class="hljs-string">&quot;_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPKNS_10OatDexFileEPS9_&quot;</span></span><br><span class="hljs-comment">/*å®šä¹‰å‡½æ•°æŒ‡é’ˆ*/</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *(*org_artDexFileOpenMemory)(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *base,<br>                                            <span class="hljs-type">size_t</span> size,<br>                                            <span class="hljs-type">const</span> std::string &amp;location,<br>                                            <span class="hljs-type">uint32_t</span> location_checksum,<br>                                            <span class="hljs-type">void</span> *mem_map,<br>                                            std::string *error_msg);<br><span class="hljs-comment">//æ‰“å¼€libartåº“</span><br><span class="hljs-type">void</span>* artHandle = (<span class="hljs-type">void</span>*)<span class="hljs-built_in">dlopen</span>(<span class="hljs-string">&quot;libart.so&quot;</span>, RTLD_LAZY);<br><span class="hljs-comment">//è·å–OpenMemoryå‡½æ•°æŒ‡é’ˆ</span><br><span class="hljs-keyword">auto</span> func = (org_artDexFileOpenMemory) <span class="hljs-built_in">dlsym</span>(artHandle, OpenMemory);<br></code></pre></td></tr></table></figure><p>å¦ä¸€ç§æ–¹æ³•å°±æ˜¯ 13.4 æ‰€è¿°ï¼Œå¯¼å…¥ååº“åå¯ç›´æ¥ä½¿ç”¨ã€‚</p><hr><p>å‚è€ƒï¼š<br><a href="https://juejin.cn/post/7125338583959306248">NDK ç³»åˆ—ï¼ˆ5ï¼‰ï¼šJNI ä»å…¥é—¨åˆ°å®è·µï¼Œä¸‡å­—çˆ†è‚è¯¦è§£ï¼ - æ˜é‡‘ (juejin.cn)</a></p><p><a href="https://juejin.cn/post/7125021894562349092/#heading-2">NDK ç³»åˆ—ï¼ˆ6ï¼‰ï¼šè¯´ä¸€ä¸‹æ³¨å†Œ JNI å‡½æ•°çš„æ–¹å¼å’Œæ—¶æœº - æ˜é‡‘ (juejin.cn)</a></p><p><a href="https://whitebird0.github.io/post/NDK%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">Androidå¼€å‘å­¦ä¹ ç¬”è®°â€”â€”NDKå¼€å‘ | Whitebirdâ€™s Home (whitebird0.github.io)</a></p><p><a href="https://blog.csdn.net/tkwxty/article/details/103609014">JNI&#x2F;NDKå…¥é—¨æŒ‡å—ä¹‹JNIå­—ç¬¦ä¸²å¤„ç†</a></p><p><a href="https://blog.csdn.net/tkwxty/article/details/103665532">JNI&#x2F;NDKå…¥é—¨æŒ‡å—ä¹‹JNIè®¿é—®æ•°ç»„</a></p><p><a href="https://juejin.cn/post/7066453944758861837">Android jniè°ƒç”¨ç¬¬ä¸‰æ–¹soåº“å’Œ.hæ–‡ä»¶ - æ˜é‡‘ (juejin.cn)</a></p><p><a href="https://blog.csdn.net/gxhea/article/details/115616602">CMakeListç¼–è¯‘æŠ¥é”™ninja: error: missing and no known rule to make itè§£å†³æ–¹æ³•-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NDK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fridaå…¥é—¨ç»ƒä¹ (äºŒ) - KGB Message</title>
    <link href="/2023/12/21/Frida%E5%85%A5%E9%97%A8%E7%BB%83%E4%B9%A0(%E4%BA%8C)%20-%20KGB%20Messager/"/>
    <url>/2023/12/21/Frida%E5%85%A5%E9%97%A8%E7%BB%83%E4%B9%A0(%E4%BA%8C)%20-%20KGB%20Messager/</url>
    
    <content type="html"><![CDATA[<p>é¢˜ç›®é™„ä»¶ï¼š<a href="https://github.com/tlamb96/kgb_messenger">tlamb96&#x2F;kgb_messenger: An Android CTF practice challenge (github.com)</a></p><hr><h1 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312211528403.png"></p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦è·Ÿè¸ªä¸€ä¸‹R.string.Userï¼Œç›´æ¥ç‚¹å‡»ï¼Œå¯ä»¥çŸ¥é“å¯¹åº”çš„èµ„æºidä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">User</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x7f0d0000</span>;<br></code></pre></td></tr></table></figure><p>æ ¹æ®è¿™ä¸ªèµ„æºidåœ¨<code>resources.arsc</code>ä¸­å¯ä»¥æœç´¢åˆ°å¯¹åº”çš„stringæ ‡ç­¾åç§°ä¸ºâ€Userâ€ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">&lt;public type<span class="hljs-operator">=</span><span class="hljs-string">&quot;string&quot;</span> name<span class="hljs-operator">=</span><span class="hljs-string">&quot;User&quot;</span> id<span class="hljs-operator">=</span><span class="hljs-string">&quot;0x7f0d0000&quot;</span> /&gt;<br></code></pre></td></tr></table></figure><p>æ ¹æ®æ ‡ç­¾åç§°ç›´æ¥æœç´¢èµ„æºæ–‡ä»¶ï¼ˆxmlæ–‡ä»¶ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312211532907.png"></p><p>è§£ç Base64å°±å¾—åˆ°äº†ç¬¬ä¸€ä¸ªflagï¼šFLAG{57ERL1NG_4RCH3R}ã€‚</p><p>è¦æƒ³è¿›å…¥ä¸‹ä¸€å…³ï¼Œæˆ‘ä»¬å°±éœ€è¦hookç³»ç»Ÿæ–¹æ³•<code>System.getProperty()</code>ã€<code>System.getenv()</code>ï¼Œä½¿å…¶ç›´æ¥è¿”å›æ­£ç¡®çš„å­—ç¬¦ä¸²ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MainActivity</span>(<span class="hljs-params"></span>)&#123;<br><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> <span class="hljs-title class_">SystemClass</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.System&quot;</span>);<br>            <span class="hljs-title class_">SystemClass</span>.<span class="hljs-property">getProperty</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>)&#123;<br>                <span class="hljs-keyword">var</span> tmp = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getProperty</span>(key);<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Russia&quot;</span>;<br>            &#125;<br>            <span class="hljs-title class_">SystemClass</span>.<span class="hljs-property">getenv</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>)&#123;<br>                <span class="hljs-keyword">var</span> tmp = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getenv</span>(name);<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;RkxBR3s1N0VSTDFOR180UkNIM1J9Cg==&quot;</span>;<br>            &#125;<br>        &#125;<br>    )<br><br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-title class_">MainActivity</span>)<br></code></pre></td></tr></table></figure><h1 id="LoginActivity"><a href="#LoginActivity" class="headerlink" title="LoginActivity"></a>LoginActivity</h1><p>æ˜¯ä¸€ä¸ªç™»å½•ç•Œé¢ï¼Œæ‰€å¯¹åº”çš„ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312211542220.png"></p><p>å¦‚æœæˆ‘ä»¬åªæ˜¯ç®€å•çš„è¿›å…¥ä¸‹ä¸€å…³ï¼Œå½“ç„¶å¯ä»¥ç›´æ¥hook <code>j()</code>æ–¹æ³•ï¼Œä½¿å…¶ç›´æ¥è¿”å›trueã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦å¾—åˆ°flagï¼Œflagçš„ç”Ÿæˆéœ€è¦ä¾é è´¦å·å’Œå¯†ç ï¼ˆè¯¦ç»†è§<code>i()</code>æ–¹æ³•ï¼‰ã€‚</p><p>å…¶ä¸­ <code>j()ã€i()</code>å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312211543965.png"></p><p>æ‰€ä»¥è¯´æˆ‘ä»¬ä¸åº”hook <code>j()</code>æ–¹æ³•ä½¿å…¶è¿”å›trueï¼Œè€Œæ˜¯è¦é€†md5ç è·å–å¯†ç æ˜æ–‡ï¼Œæ¨èç½‘ç«™<a href="https://md5hashing.net/hash/md5">md5 hash decoder and calculator (md5hashing.net)</a>ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312211609534.png"></p><p>å¾—åˆ°å¯†ç æ˜æ–‡ä¸ºï¼šguestã€‚</p><p>ä¸ºäº†æ›´ä¸ºæ–¹ä¾¿ç‚¹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥hook <code>Toast.makeText()</code>æ–¹æ³•ï¼Œåœ¨æ§åˆ¶å°è¾“å‡ºflagï¼Œæ¯•ç«Ÿtoastå¼¹çª—æ˜¾ç¤ºæ—¶é—´æ¯”è¾ƒçŸ­è€Œä¸”è¿˜ä¸èƒ½å¤åˆ¶ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginActivity</span>(<span class="hljs-params"></span>)&#123;<br><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> <span class="hljs-title class_">ToastClass</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;android.widget.Toast&quot;</span>);<br>            <span class="hljs-title class_">ToastClass</span>.<span class="hljs-property">makeText</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&quot;android.content.Context&quot;</span>, <span class="hljs-string">&quot;java.lang.CharSequence&quot;</span>, <span class="hljs-string">&quot;int&quot;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">context, text, duration</span>)&#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;flag = &quot;</span> + text);<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">makeText</span>(context,text,duration);<br>            &#125;<br>        &#125;<br>    )<br><br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-title class_">LoginActivity</span>)<br></code></pre></td></tr></table></figure><p>å¾—åˆ°ç¬¬äºŒä¸ªflagï¼šFLAG{G00G13_PR0}</p><h1 id="MessengerActivity"><a href="#MessengerActivity" class="headerlink" title="MessengerActivity"></a>MessengerActivity</h1><p>æ˜¯ä¸€ä¸ªèŠå¤©ç•Œé¢ã€‚å‘é€æ¶ˆæ¯çš„ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312212001850.png"></p><p>æ¥çœ‹<code>a()</code>å’Œ<code>b()</code>è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312212007984.png"></p><p>å°±æ˜¯ä¸¤ä¸ªç®€å•çš„åŠ å¯†æ–¹æ³•ï¼Œè¦è¯´æœ‰ç‚¹æŒ‘æˆ˜çš„ä¹Ÿå°±æ˜¯ç§»ä½å¼‚æˆ–äº†ï¼Œä¸è¿‡è¿™ä¸ªæ‹¿ä¸ªä¾‹å­åœ¨è‰ç¨¿ä¸Šæ¨æ¼”ä¸€éå°±çŸ¥é“æ€ä¹ˆåšäº†ã€‚</p><p>è§£å¯†è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">p = <span class="hljs-built_in">list</span>(<span class="hljs-string">&quot;V@]EAASB\u0012WZF\u0012e,a$7(&amp;am2(3.\u0003&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(p) // <span class="hljs-number">2</span>):<br>    c = <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(p[-<span class="hljs-number">1</span>-i]) ^ <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;A&#x27;</span>))<br>    p[-<span class="hljs-number">1</span> - i] = <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(p[i]) ^ <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;2&#x27;</span>))<br>    p[i] = c<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(_ <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> p))<br><br><br>r = <span class="hljs-built_in">list</span>(<span class="hljs-string">&quot;\u0000dslp&#125;oQ\u0000 dks$|M\u0000h +AYQg\u0000P*!M$gQ\u0000&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(r) // <span class="hljs-number">2</span>):<br>    r[i], r[-<span class="hljs-number">1</span>-i] = r[-<span class="hljs-number">1</span>-i], r[i]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(r)):<br>    shiftBit = i % <span class="hljs-number">8</span><br>    <span class="hljs-keyword">if</span> shiftBit == <span class="hljs-number">0</span>:<span class="hljs-comment"># &gt;&gt; 0 çš„è¿˜åŸä¸äº†</span><br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-comment"># é‡å¤å¾ªç¯å°±å¯ä»¥å¾—åˆ°åŸæ¥çš„</span><br>    <span class="hljs-keyword">while</span> shiftBit &lt; <span class="hljs-number">8</span>:<br>        r[i] = <span class="hljs-built_in">chr</span>((<span class="hljs-built_in">ord</span>(r[i]) &gt;&gt; shiftBit) ^ <span class="hljs-built_in">ord</span>(r[i]))<br>        shiftBit *= <span class="hljs-number">2</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(_ <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> r))<br></code></pre></td></tr></table></figure><p>å¾—åˆ°çš„æ˜æ–‡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312212010335.png"></p><p>ç”±äºå­˜åœ¨ç§»ä½ä¸º0bitçš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µæœ€åæ˜¯ç›¸åŒæ˜æ–‡è¿›è¡Œå¼‚æˆ–å¾—åˆ°0ï¼Œæ˜¯æ— æ³•è¿˜åŸå‡ºæ¥çš„ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨è¿˜åŸã€‚</p><p>æœ€ç»ˆflagå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312211733197.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>Hook</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Frida</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fridaå…¥é—¨ç»ƒä¹ (ä¸€) - ä¸ƒå±‚å…³å¡</title>
    <link href="/2023/12/20/Frida%E5%85%A5%E9%97%A8%E7%BB%83%E4%B9%A0(%E4%B8%80)%20-%20%E4%B8%83%E5%B1%82%E5%85%B3%E5%8D%A1/"/>
    <url>/2023/12/20/Frida%E5%85%A5%E9%97%A8%E7%BB%83%E4%B9%A0(%E4%B8%80)%20-%20%E4%B8%83%E5%B1%82%E5%85%B3%E5%8D%A1/</url>
    
    <content type="html"><![CDATA[<p>é™„ä»¶ï¼šè§[<a href="https://bbs.kanxue.com/thread-278023.htm">åŸåˆ›]fridaåŸºç¡€ é—¯å…³è®­ç»ƒ ä¸ƒå±‚å…³å¡-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><hr><h1 id="LoginActivity"><a href="#LoginActivity" class="headerlink" title="LoginActivity"></a>LoginActivity</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312201203055.png"></p><p><code>onClick()</code>æ–¹æ³•ä¸­åˆ¤æ–­äº†è¾“å…¥ä¸èƒ½ä¸ºç©ºï¼Œä¸”è¦æ»¡è¶³<code>LoginActivity.a(obj, obj).equals(obj2)</code>æ‰è¡Œï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312201136231.png"></p><p>å¾ˆç®€å•ï¼Œä¹Ÿå°±æ˜¯å¯†ç æ˜¯è´¦å·çš„HmacSha256åŠ å¯†ï¼ŒåŠ å¯†ä½¿ç”¨çš„å¯†é’¥æ˜¯è´¦å·æœ¬èº«ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨fridaæ¥æ“ä½œï¼Œç¼–å†™jsè„šæœ¬æ¥hook<code>a()</code>æ–¹æ³•ï¼Œæ‰“å°æˆ‘ä»¬éœ€è¦çš„è¿”å›å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.LoginActivity&quot;</span>);<br>            clazz.<span class="hljs-property">a</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>, <span class="hljs-string">&quot;java.lang.String&quot;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">str, str2</span>)&#123;<br>                <span class="hljs-keyword">var</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">a</span>(str, str2);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;HmacSHA256: &quot;</span> + result);<br>                <span class="hljs-keyword">return</span> <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>).$new(result);<br>            &#125;<br><br>        &#125;<br>    )<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(login)<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">HmacSHA256</span>: <span class="hljs-number">4</span>e4feaea959d426155a480dc07ef92f4754ee93edbe56d993d74f131497e66fb<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>adb shell input text &quot;xxx&quot;</code>å°†è¿™æ®µå€¼è¾“å…¥åˆ°è·å¾—ç„¦ç‚¹çš„EditTextæ§ä»¶ä¸­ã€‚</p><h1 id="FridaActivity1"><a href="#FridaActivity1" class="headerlink" title="FridaActivity1"></a>FridaActivity1</h1><p>æ•´ä¸ªUIç•Œé¢å°±ä¸€ä¸ªæŒ‰é’®å¯ä»¥è§¦å‘ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312201210395.png"></p><p>ç”±äºæˆ‘ä»¬æ— æ³•è¾“å…¥ï¼Œæ‰€ä»¥å¾—hook<code>a()</code>æ–¹æ³•ï¼Œä½¿å…¶ç›´æ¥è¿”å›åé¢è¿™ä¸²å­—ç¬¦ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FridaActivity1</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity1&quot;</span>);<br>            clazz.<span class="hljs-property">a</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">bArr</span>)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>).$new(<span class="hljs-string">&quot;R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL=&quot;</span>);<br>            &#125;<br>        &#125;<br>    )<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-title class_">FridaActivity1</span>)<br></code></pre></td></tr></table></figure><h1 id="FridaActivity2"><a href="#FridaActivity2" class="headerlink" title="FridaActivity2"></a>FridaActivity2</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312201232407.png"></p><p><code>CheckSuccess()</code>ä¸ºçˆ¶ç±»æ–¹æ³•ï¼Œæ˜¯ä¸ªç©ºçš„ï¼Œå¯ä»¥ä¸ç”¨ç®¡å®ƒã€‚åˆ†æå¯çŸ¥ï¼Œæˆ‘ä»¬éœ€è¦hook FridaActivity2å®ä¾‹ï¼Œç¯¡æ”¹è¿™ä¸¤ä¸ªå˜é‡çš„å€¼å°±è¡Œäº†ï¼ˆç›´æ¥æ”¹æˆ–è€…è°ƒç”¨setæ–¹æ³•æ”¹ï¼‰.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FridaActivity2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>);<br>            <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>,&#123;<br>                <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)&#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance: FridaActivity2&quot;</span>);<br>                    obj.<span class="hljs-property">static_bool_var</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<span class="hljs-comment">//æ³¨æ„æ˜¯booleanåŸºæœ¬ç±»å‹ï¼Œè€Œä¸æ˜¯Booleanç±»ï¼Œæ‰€ä»¥Java.use(&quot;java.lang.Boolean&quot;).$new()ä¼šæŠ¥é”™</span><br>                    obj.<span class="hljs-property">bool_var</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;static_bool_var = &quot;</span> + obj.<span class="hljs-property">static_bool_var</span> + <span class="hljs-string">&quot;; bool_var = &quot;</span> + obj.<span class="hljs-property">bool_var</span>);<br>                &#125;,<br>                <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;finish&quot;</span>)<br>                &#125;<br>            &#125;)<br>        &#125;<br>    )<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-title class_">FridaActivity2</span>)<br></code></pre></td></tr></table></figure><h1 id="FridaActivity3"><a href="#FridaActivity3" class="headerlink" title="FridaActivity3"></a>FridaActivity3</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312201950351.png"></p><p>æ•´ä¸ªæ“ä½œè·ŸFridaActivity2çš„ä¸€æ ·ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>å¦‚æœå­—æ®µåä¸æ–¹æ³•åä¸€æ ·ï¼Œåˆ™éœ€è¦ç»™å­—æ®µåå‰åŠ ä¸‹åˆ’çº¿â€_â€ï¼Œå¦åˆ™è·å–åˆ°çš„æ˜¯æ–¹æ³•</strong>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FridaActivity3</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity3&quot;</span>,&#123;<br>                <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)&#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance: FridaActivity3&quot;</span>);<br>                    obj.<span class="hljs-property">static_bool_var</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br>                    obj.<span class="hljs-property">bool_var</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-comment">//å±æ€§åå’Œæ–¹æ³•åç›¸åŒï¼Œå¼•ç”¨å±æ€§åéœ€è¦å‰ç½®&quot;_&quot;</span><br>                    obj.<span class="hljs-property">_same_name_bool_var</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;static_bool_var = &quot;</span> + obj.<span class="hljs-property">static_bool_var</span>.<span class="hljs-property">value</span> + <span class="hljs-string">&quot;; bool_var = &quot;</span> + obj.<span class="hljs-property">bool_var</span>.<span class="hljs-property">value</span> + <span class="hljs-string">&quot;; obj.same_name_bool_var = &quot;</span> + obj.<span class="hljs-property">_same_name_bool_var</span>.<span class="hljs-property">value</span>);<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-title function_">same_name_bool_var</span>());<br>                &#125;,<br>                <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;finish&quot;</span>);<br>                    <br>                &#125;<br>            &#125;)<br>        &#125;<br>    )<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-title class_">FridaActivity3</span>)<br></code></pre></td></tr></table></figure><h1 id="FridaActivity4"><a href="#FridaActivity4" class="headerlink" title="FridaActivity4"></a>FridaActivity4</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312201950668.png"></p><p>è¿™ä¸ªå¾ˆç®€å•ï¼Œåªè¦å°†è¿™äº›æ–¹æ³•å…¨éƒ¨hookä¸€éï¼Œä¿®æ”¹è¿”å›å€¼ä¸ºtrueå°±è¡Œäº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FridaActivity4</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity4$InnerClasses&quot;</span>);<br>            clazz.<span class="hljs-property">check1</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;;<br>            clazz.<span class="hljs-property">check2</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;;<br>            clazz.<span class="hljs-property">check3</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;;<br>            clazz.<span class="hljs-property">check4</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;;<br>            clazz.<span class="hljs-property">check5</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;;<br>            clazz.<span class="hljs-property">check6</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;;<br><br>        &#125;<br>    )<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-title class_">FridaActivity4</span>)<br></code></pre></td></tr></table></figure><h1 id="FridaActivity5"><a href="#FridaActivity5" class="headerlink" title="FridaActivity5"></a>FridaActivity5</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312201954075.png"></p><p>ä»”ç»†åˆ†ææ•´ä¸ªä»£ç çš„è¯ï¼Œä¸éš¾çŸ¥é“ï¼Œç¨‹åºé€šè¿‡<code>loaddex()</code>æ–¹æ³•åˆ›å»ºDexClassLoaderæ¥åŠ¨æ€åŠ è½½dexæ–‡ä»¶ï¼Œä¸è¿‡å®ƒå°†DexClassLoaderå¼ºè½¬ä¸ºCheckInterfaceæ¥å£ç±»ï¼Œé‡Œé¢çš„<code>check()</code>æ–¹æ³•ç”±å…¶å­ç±»DynamicCheckå®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è°ƒç”¨<code>getDynamicDexCheck().check()</code>æ˜¯ï¼Œæ‰§è¡Œçš„æ˜¯å­ç±»DynamicCheckçš„<code>check()</code>æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦hookè¯¥æ–¹æ³•ï¼Œä½¿å…¶è¿”å›trueã€‚</p><p>ä½†æ˜¯ï¼Œç”±äºå½“å‰çš„ç±»åŠ è½½å™¨æ˜¯åŠ è½½AndoridDemo.apkçš„ï¼Œè€Œ<code>check()</code>æ–¹æ³•åœ¨åŠ è½½DynamicPlugin.dexçš„ç±»åŠ è½½å™¨ä¸­ï¼Œæ‰€ä»¥éœ€è¦éå†ç±»åŠ è½½å™¨å¯»æ‰¾ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FridaActivity5</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-comment">/*ç”±äºå½“å‰jsä½¿ç”¨çš„ç±»åŠ è½½å™¨æ˜¯åŠ è½½AndoridDemo.apkçš„ï¼Œ</span><br><span class="hljs-comment">            æ‰€ä»¥éœ€è¦åŠ è½½DynamicPlugin.dexçš„ç±»åŠ è½½å™¨ï¼Œ</span><br><span class="hljs-comment">            ä¹‹åæ‰èƒ½implementate DynamicCheckçš„checkæ–¹æ³•*/</span><br>            <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">enumerateClassLoaders</span>(&#123;<br>                <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">loader</span>)&#123;<br>                    <span class="hljs-comment">//console.log(loader);</span><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">if</span>(loader.<span class="hljs-title function_">loadClass</span>(<span class="hljs-string">&quot;com.example.androiddemo.Dynamic.DynamicCheck&quot;</span>))&#123;<br>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;success&quot;</span>);<br>                            <span class="hljs-title class_">Java</span>.<span class="hljs-property">classFactory</span>.<span class="hljs-property">loader</span> = loader;<br>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(loader);<br>                            <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Dynamic.DynamicCheck&quot;</span>);<br>                            clazz.<span class="hljs-property">check</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                            &#125;<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>                        <br>                    &#125;<br>                    <br>                &#125;,<br>                <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;classloader change&quot;</span>);<br>                &#125;<br>            &#125;)<br>        &#125;<br>    )<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-title class_">FridaActivity5</span>)<br></code></pre></td></tr></table></figure><h1 id="FridaActivity6"><a href="#FridaActivity6" class="headerlink" title="FridaActivity6"></a>FridaActivity6</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312201955594.png"></p><p>è·ŸFridaActivity4ä¸€æ ·ï¼Œhookè¿™äº›æ–¹æ³•ä¿®æ”¹è¿”å›å€¼å°±å¯ä»¥äº†ï¼ˆä¸éœ€è¦åƒFridaActivity5ä¸€æ ·ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•åˆä¸æ˜¯åŠ¨æ€åŠ è½½æ¥çš„ï¼‰ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FridaActivity6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> <span class="hljs-title class_">Frida6Class0</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class0&quot;</span>);    <br>            <span class="hljs-title class_">Frida6Class0</span>.<span class="hljs-property">check</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">var</span> <span class="hljs-title class_">Frida6Class1</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class1&quot;</span>);    <br>            <span class="hljs-title class_">Frida6Class1</span>.<span class="hljs-property">check</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">var</span> <span class="hljs-title class_">Frida6Class2</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class2&quot;</span>);    <br>            <span class="hljs-title class_">Frida6Class2</span>.<span class="hljs-property">check</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>    )<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-title class_">FridaActivity6</span>)<br></code></pre></td></tr></table></figure><p>ç„¶ååˆ°äº†ç¬¬ä¸ƒå…³FridaActivity7ï¼Œçœ‹æºç å¯ä»¥çŸ¥é“æ•´ä¸ªç»ƒä¹ å°±ç»“æŸäº†ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>Hook</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Frida</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fridaçš„é›†æˆå·¥å…·:Objectionçš„ä½¿ç”¨</title>
    <link href="/2023/12/19/Frida%E7%9A%84%E9%9B%86%E6%88%90%E5%B7%A5%E5%85%B7-Objection%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/12/19/Frida%E7%9A%84%E9%9B%86%E6%88%90%E5%B7%A5%E5%85%B7-Objection%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="æŒ‡ä»¤é€‰é¡¹"><a href="#æŒ‡ä»¤é€‰é¡¹" class="headerlink" title="æŒ‡ä»¤é€‰é¡¹"></a>æŒ‡ä»¤é€‰é¡¹</h1><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">objection <span class="hljs-comment">--help</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191537985.png"></p><h1 id="Objectionè¿æ¥"><a href="#Objectionè¿æ¥" class="headerlink" title="Objectionè¿æ¥"></a>Objectionè¿æ¥</h1><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">objection -g <span class="hljs-variable">&lt;packagename&gt;</span> explore<br>objection -N -h <span class="hljs-variable">&lt;phone&#x27;s ip&gt;</span> -p <span class="hljs-variable">&lt;port&gt;</span> -g <span class="hljs-variable">&lt;packagename&gt;</span> explore <span class="hljs-comment"># æŒ‡å®šipä¸ç«¯å£è¿æ¥</span><br></code></pre></td></tr></table></figure><p>è¿æ¥æˆåŠŸåæ˜¯å¦‚ä¸‹ç”»é¢ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191552118.png"></p><p>æŒ‰ç©ºæ ¼å¯ä»¥è·å–å‘½ä»¤æç¤ºä»¥åŠå¯¹åº”çš„è§£é‡Šï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><h1 id="å¸¸ç”¨æŒ‡ä»¤"><a href="#å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤"></a>å¸¸ç”¨æŒ‡ä»¤</h1><h2 id="å†…å­˜ç¯‡"><a href="#å†…å­˜ç¯‡" class="headerlink" title="å†…å­˜ç¯‡"></a>å†…å­˜ç¯‡</h2><p><strong>æŸ¥çœ‹å†…å­˜ä¸­åŠ è½½çš„æ‰€æœ‰åº“</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">memory list modules (--json  &lt;localfilepath&gt;) <span class="hljs-regexp">//</span>åè€…å‚æ•°æ˜¯å°†è¿è¡Œç»“æœå¯¼å‡ºæˆjsonæ–‡ä»¶<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191556968.png"></p><p><strong>æŸ¥çœ‹æŒ‡å®šåº“çš„å¯¼å‡ºå‡½æ•°</strong></p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xquery">memory list exports &lt;<span class="hljs-keyword">module</span><span class="hljs-built_in"> name</span>&gt; (--json  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">localfilepath</span>&gt;</span>)</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191605738.png"></p><p><strong>å†…å­˜dump</strong></p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">memory dump <span class="hljs-literal">all</span> <span class="hljs-variable">&lt;localfilepath&gt;</span><br>memory dump from_base <span class="hljs-variable">&lt;base_address&gt;</span> <span class="hljs-variable">&lt;size_to_dump&gt;</span> <span class="hljs-variable">&lt;localfilepath&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191632654.png"></p><p><strong>å†…å­˜æœç´¢</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">memory</span> <span class="hljs-keyword">search</span> <span class="hljs-string">&quot;&lt;pattern eg: 41 41 41 ?? 41&gt;&quot;</span> --offsets-only     <span class="hljs-comment">//åªè·å–å­—ç¬¦ä¸²çš„åç§»é‡</span><br><span class="hljs-keyword">memory</span> <span class="hljs-keyword">search</span> <span class="hljs-string">&quot;&lt;pattern eg: 41 41 41 ?? 41&gt;&quot;</span> --string<br></code></pre></td></tr></table></figure><p>é€‰é¡¹<code>--string</code>çš„ä¾‹å­å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191614233.png"></p><p>é€‰é¡¹<code>--offsets-only</code>çš„ä¾‹å­å¦‚ä¸‹ï¼ˆéœ€è¦å°†å­—ç¬¦ä¸²è½¬åå…­è¿›åˆ¶ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191618455.png"></p><p><strong>å†…å­˜å†™</strong></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">memory <span class="hljs-built_in">write</span> <span class="hljs-string">&quot;&lt;address&gt;&quot;</span> <span class="hljs-string">&quot;&lt;pattern eg: 41 41 41 41&gt;&quot;</span> (<span class="hljs-comment">--string)</span><br></code></pre></td></tr></table></figure><p><strong>å†…å­˜å †æœç´¢å®ä¾‹</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">android heap <span class="hljs-keyword">search</span> instances &lt;<span class="hljs-keyword">class</span>&gt; (eg: com.example.<span class="hljs-keyword">test</span>)<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191653397.png"></p><p><strong>è°ƒç”¨å®ä¾‹çš„æ–¹æ³•</strong></p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smali">android heap<span class="hljs-built_in"> execute </span>&lt;Hashcode&gt; &lt;methodname&gt;<br></code></pre></td></tr></table></figure><p>ç„¶è€Œæœ‰å‚æ–¹æ³•æ‰§è¡ŒæŠ¥é”™ï¼Œæ— å‚æ–¹æ³•å¯ä»¥æˆåŠŸæ‰§è¡Œã€‚</p><p>æœ‰å‚æ–¹æ³•å¯ä»¥é€šè¿‡ç¼–å†™jsä»£ç æ¥æ‰§è¡Œï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">android heap evaluate <span class="hljs-tag">&lt;<span class="hljs-name">Hashcode</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">methodname</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ¥ç€å°±ä¼šè¿›å…¥åˆ°jsä»£ç ç¼–å†™ç¯èŠ‚ï¼Œç¼–å†™å®Œåï¼ŒEscæ¥ç€Enterï¼Œå°±ä¼šæ‰§è¡Œè„šæœ¬ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312192008039.png"></p><h2 id="hookç¯‡"><a href="#hookç¯‡" class="headerlink" title="hookç¯‡"></a>hookç¯‡</h2><p><strong>åˆ—å‡ºæ‰€æœ‰å·²åŠ è½½çš„activitiesã€class_loadersã€classesã€receiversã€servicesã€‚</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">android hooking list activities<span class="hljs-regexp">/class_loaders/</span>classes<span class="hljs-regexp">/receivers/</span>services<br>android hooking list class_methods &lt;classname&gt;<br></code></pre></td></tr></table></figure><p>ä¾‹å­ï¼šåˆ—ä¸¾<code>android.openg.Matrix</code>ç±»çš„æ–¹æ³•ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191709561.png"></p><p><strong>æœç´¢ç±»</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">android hooking <span class="hljs-keyword">search</span> classes &lt;<span class="hljs-type">name</span>&gt; //<span class="hljs-type">name</span>å¯ä»¥å…¨ç±»åï¼Œä¹Ÿå¯ä»¥æ˜¯éƒ¨åˆ†å…³é”®å­—<br></code></pre></td></tr></table></figure><p><strong>æœç´¢æ–¹æ³•</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">android hooking <span class="hljs-keyword">search</span> methods &lt;<span class="hljs-type">name</span>&gt; (optional: &lt;package-<span class="hljs-keyword">filter</span>&gt;) //<span class="hljs-type">name</span>å¯ä»¥å…¨ç±»åï¼Œä¹Ÿå¯ä»¥æ˜¯éƒ¨åˆ†å…³é”®å­—<br></code></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œæœç´¢<code>com.example.testfrida</code>åŒ…ä¸­çš„<code>MainActivity</code>æ–¹æ³•ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191719627.png"></p><p><strong>hookç±»çš„æ‰€æœ‰æ–¹æ³•(ä¸åŒ…æ‹¬æ„é€ æ–¹æ³•)</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">android hooking watch <span class="hljs-keyword">class</span> &lt;classname&gt; (--<span class="hljs-keyword">dump</span>-args)(--<span class="hljs-keyword">dump</span>-backtrace)(--<span class="hljs-keyword">dump</span>-<span class="hljs-keyword">return</span>)<br></code></pre></td></tr></table></figure><ul><li><code>--dump-args</code>ï¼šhookæ–¹æ³•çš„å‚æ•°å¹¶æ‰“å°</li><li><code>--dump-backtrace</code>ï¼šhookæ–¹æ³•çš„è°ƒç”¨æ ˆå¹¶æ‰“å°</li><li><code>--dump-return</code>ï¼šhookæ–¹æ³•çš„è¿”å›å€¼å¹¶æ‰“å°</li></ul><p><strong>hookç±»çš„æŒ‡å®šæ–¹æ³•(åŒ…æ‹¬é‡è½½æ–¹æ³•)</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">android hooking watch class_method &lt;classname.method&gt; (--<span class="hljs-keyword">dump</span>-args)(--<span class="hljs-keyword">dump</span>-backtrace)(--<span class="hljs-keyword">dump</span>-<span class="hljs-keyword">return</span>)<br><span class="hljs-comment">//å¦‚æœæ˜¯æ„é€ æ–¹æ³•ï¼Œåˆ™methodçš„å€¼å³ä¸º$init</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191928701.png"></p><p><strong>hook å•ä¸ªé‡è½½æ–¹æ³•(éœ€æŒ‡å®šå‚æ•°ç±»å‹)</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">android hooking watch class_method &lt;classname.method&gt; <span class="hljs-string">&quot;paramterTypes&quot;</span> (--<span class="hljs-keyword">dump</span>-args)(--<span class="hljs-keyword">dump</span>-backtrace)(--<span class="hljs-keyword">dump</span>-<span class="hljs-keyword">return</span>)<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191931639.png"></p><p><strong>æŸ¥çœ‹hookåˆ—è¡¨</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">jobs</span> list<br></code></pre></td></tr></table></figure><p><strong>å–æ¶ˆhook</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">jobs</span> <span class="hljs-built_in">kill</span> &lt;Job ID&gt;<br></code></pre></td></tr></table></figure><p><strong>é™„åŠ hook</strong></p><p>åœ¨æŸäº›app hookæ—¶ï¼Œ éœ€è¦åœ¨å¯åŠ¨æ—¶hookï¼Œä¸ºäº†é¿å…é”™è¿‡hookæ—¶æœºï¼Œé‡‡ç”¨é™„åŠ æ¨¡å¼ï¼Œåœ¨objection å¯åŠ¨æ—¶å°±æ³¨å…¥appã€‚ï¼ˆä¹Ÿå¯ä»¥ä¸è¿™ä¹ˆåšï¼Œè€Œæ˜¯å…ˆhookåå¯åŠ¨ç¨‹åºï¼‰</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">objection -g <span class="hljs-symbol">&lt;packageName&gt;</span> explore --startup-<span class="hljs-keyword">command</span> &lt;<span class="hljs-string">&quot;xxx&quot;</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>è®¾ç½®æ–¹æ³•è¿”å›å€¼ï¼ˆä»…é™Booleanç±»å‹ï¼‰</strong></p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lasso">android hooking <span class="hljs-built_in">set</span> <span class="hljs-keyword">return_value</span> <span class="hljs-string">&quot;&lt;fully qualified class method&gt;&quot;</span> <span class="hljs-string">&quot;&lt;optional overload&gt;&quot;</span> (eg: <span class="hljs-string">&quot;com.example.test.doLogin&quot;</span>) &lt;<span class="hljs-literal">true</span>/<span class="hljs-literal">false</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>ä¸ºæŒ‡å®šç±»ä¸­çš„å„ä¸ªæ–¹æ³•ç”Ÿæˆhookä»£ç ï¼š</strong></p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs verilog">android hooking <span class="hljs-keyword">generate</span> simple &lt;classname&gt;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡ç”Ÿæˆçš„åªæ˜¯å¤§è‡´æ¡†æ¶ï¼Œæ²¡æœ‰è¯¦ç»†çš„å†…éƒ¨æ–¹æ³•å®ç°ï¼Œè¿™äº›è¿˜å¾—é è‡ªå·±å†™ã€‚</p><p><strong>ä¸ºæŒ‡å®šç±»ç”Ÿæˆhookä»£ç ï¼š</strong></p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs verilog">android hooking <span class="hljs-keyword">generate</span> <span class="hljs-keyword">class</span> &lt;classname&gt;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ¯”è¾ƒè¯¦ç»†ï¼Œåº”è¯¥æ˜¯å®Œå…¨å®ç°äº†ï¼Ÿ</p><h2 id="å¯åŠ¨Activityæˆ–Service"><a href="#å¯åŠ¨Activityæˆ–Service" class="headerlink" title="å¯åŠ¨Activityæˆ–Service"></a>å¯åŠ¨Activityæˆ–Service</h2><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">android <span class="hljs-built_in">int</span>ent launch_activity &lt;activity_class&gt;<br>android <span class="hljs-built_in">int</span>ent launch_service &lt;service_class&gt;<br></code></pre></td></tr></table></figure><p>å¦‚æœåº”ç”¨çš„å¯åŠ¨æƒé™æ²¡æœ‰è®¾ç½®å¥½ï¼Œå°±å¯ä»¥è¾¾åˆ°Activityç»•è¿‡çš„æ•ˆæœï¼Œæ¯”å¦‚è¯´ä¸ç”¨ç™»é™†å°±å¯ä»¥è¿›å…¥æŸäº›ç•Œé¢ï¼ï¼ï¼</p><h2 id="å…³é—­-ssl-æ•ˆéªŒ"><a href="#å…³é—­-ssl-æ•ˆéªŒ" class="headerlink" title="å…³é—­ ssl æ•ˆéªŒ"></a>å…³é—­ ssl æ•ˆéªŒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">android sslpinning <span class="hljs-built_in">disable</span><br></code></pre></td></tr></table></figure><h2 id="å…³é—­-root-æ£€æµ‹"><a href="#å…³é—­-root-æ£€æµ‹" class="headerlink" title="å…³é—­ root æ£€æµ‹"></a>å…³é—­ root æ£€æµ‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">android root <span class="hljs-built_in">disable</span><br></code></pre></td></tr></table></figure><h2 id="æ˜¾ç¤º-app-ç›¸å…³ç¯å¢ƒå˜é‡"><a href="#æ˜¾ç¤º-app-ç›¸å…³ç¯å¢ƒå˜é‡" class="headerlink" title="æ˜¾ç¤º app ç›¸å…³ç¯å¢ƒå˜é‡"></a>æ˜¾ç¤º app ç›¸å…³ç¯å¢ƒå˜é‡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">env</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312191559546.png"></p><p>å¯ä»¥çœ‹åˆ°ç¼“å­˜ç›®å½•ï¼ˆcacheDirectoryï¼‰ä»¥åŠå®‰è£…ååº”ç”¨æ‰€åœ¨ç›®å½•ï¼ˆpackageCodePathï¼‰ç­‰ã€‚</p><h2 id="æŒ‡ä»¤è§£é‡Š"><a href="#æŒ‡ä»¤è§£é‡Š" class="headerlink" title="æŒ‡ä»¤è§£é‡Š"></a>æŒ‡ä»¤è§£é‡Š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">help</span> &lt;<span class="hljs-built_in">command</span>&gt;<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://www.anquanke.com/post/id/197657">https://www.anquanke.com/post/id/197657</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>Hook</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Frida</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pythonä¸­fridaåº“ä½¿ç”¨</title>
    <link href="/2023/12/18/Python%E4%B8%ADfrida%E5%BA%93%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/12/18/Python%E4%B8%ADfrida%E5%BA%93%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="å¯åŠ¨fridaæœåŠ¡"><a href="#å¯åŠ¨fridaæœåŠ¡" class="headerlink" title="å¯åŠ¨fridaæœåŠ¡"></a>å¯åŠ¨fridaæœåŠ¡</h1><h2 id="åŒ…åé™„åŠ "><a href="#åŒ…åé™„åŠ " class="headerlink" title="åŒ…åé™„åŠ "></a>åŒ…åé™„åŠ </h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><br>jscode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>device = frida.get_usb_device()<span class="hljs-comment"># è·å–usbè¿æ¥çš„æµ‹è¯•æœº</span><br>process = device.attach(<span class="hljs-string">&quot;è®¾ç½®&quot;</span>)<span class="hljs-comment"># åŒ…åé™„åŠ è¿›ç¨‹,å¯é€šè¿‡frida-ps -UæŸ¥çœ‹</span><br>script = process.create_script(jscode)<span class="hljs-comment">#åˆ›å»ºæ³¨å…¥è„šæœ¬</span><br>script.load()<span class="hljs-comment">#æ³¨å…¥è„šæœ¬</span><br>sys.stdin.read()<span class="hljs-comment"># åŠ è¿™ä¸ªæ‰èƒ½å›æ˜¾logè¾“å‡º</span><br></code></pre></td></tr></table></figure><h2 id="PIDé™„åŠ "><a href="#PIDé™„åŠ " class="headerlink" title="PIDé™„åŠ "></a>PIDé™„åŠ </h2><p>ç”±äºæœ‰çš„åº”ç”¨æ˜¯å¤šè¿›ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨åŒ…åé™„åŠ å°±ä¼šå†²çªï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨PIDé™„åŠ ã€‚PIDé™„åŠ åŒæ ·ä½¿ç”¨<code>attach()</code>æ–¹æ³•ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">frida.get_usb_device().attach(pid)<span class="hljs-comment">#pidé™„åŠ è¿›ç¨‹,å¯é€šè¿‡frida-ps -UæŸ¥çœ‹pid</span><br></code></pre></td></tr></table></figure><h2 id="spawnæ–¹å¼å¯åŠ¨"><a href="#spawnæ–¹å¼å¯åŠ¨" class="headerlink" title="spawnæ–¹å¼å¯åŠ¨"></a>spawnæ–¹å¼å¯åŠ¨</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><br>jscode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>device = frida.get_usb_device()<span class="hljs-comment"># è·å–usbè¿æ¥çš„æµ‹è¯•æœº</span><br>pid = device.spawn([<span class="hljs-string">&#x27;com.android.settings&#x27;</span>])<span class="hljs-comment">#ä»¥æŒ‚èµ·æ–¹å¼åˆ›å»ºè¿›ç¨‹</span><br>process = device.attach(pid)<span class="hljs-comment">#ç„¶åå†é™„åŠ è¿›ç¨‹</span><br>script = process.create_script(jscode)<span class="hljs-comment">#åˆ›å»ºè„šæœ¬</span><br>script.load()<span class="hljs-comment">#æ³¨å…¥è„šæœ¬</span><br>device.resume(pid)<span class="hljs-comment">#æ¢å¤è¿›ç¨‹è¿è¡Œ</span><br>sys.stdin.read()<span class="hljs-comment"># å›æ˜¾logè¾“å‡º</span><br></code></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯ä»¥æŒ‚èµ·çš„æ–¹å¼å¯åŠ¨è¿›ç¨‹ï¼ˆç›¸å½“äºåŠ¨è°ƒæ—¶çš„é™„åŠ ï¼‰ï¼Œç¨‹åºå¤„äºæš‚åœçŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦<code>resume()</code>æ¢å¤è¿›ç¨‹è¿è¡Œ</p><h2 id="éæ ‡å‡†ç«¯å£å¯åŠ¨frida-serverçš„è¿æ¥"><a href="#éæ ‡å‡†ç«¯å£å¯åŠ¨frida-serverçš„è¿æ¥" class="headerlink" title="éæ ‡å‡†ç«¯å£å¯åŠ¨frida-serverçš„è¿æ¥"></a>éæ ‡å‡†ç«¯å£å¯åŠ¨frida-serverçš„è¿æ¥</h2><p>å¦‚æœä½¿ç”¨éæ ‡å‡†ç«¯å£å¯åŠ¨æ‰‹æœºç«¯frida-serveræ—¶ï¼Œ</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta">./frida-<span class="hljs-keyword">server</span> -l <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:port<br></code></pre></td></tr></table></figure><p>åˆ™pythonä¸­çš„è®¾å¤‡è·å–çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">device = frida.get_device_manager().add_remote_device(<span class="hljs-string">&quot;ip:port&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="è¿æ¥å¤šä¸ªè®¾å¤‡"><a href="#è¿æ¥å¤šä¸ªè®¾å¤‡" class="headerlink" title="è¿æ¥å¤šä¸ªè®¾å¤‡"></a>è¿æ¥å¤šä¸ªè®¾å¤‡</h2><p>é€šè¿‡<code>frida.get_device_manager().add_remote_device()</code>ä¾æ¬¡æ·»åŠ ã€‚</p><h1 id="jsä¸pythonçš„äº¤äº’"><a href="#jsä¸pythonçš„äº¤äº’" class="headerlink" title="jsä¸pythonçš„äº¤äº’"></a>jsä¸pythonçš„äº¤äº’</h1><h2 id="æ•°æ®ä»jsåˆ°python"><a href="#æ•°æ®ä»jsåˆ°python" class="headerlink" title="æ•°æ®ä»jsåˆ°python"></a>æ•°æ®ä»jsåˆ°python</h2><p>åœ¨jsä»£ç ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨console.log()æ‰“å°æˆ‘ä»¬æƒ³è¦çŸ¥é“çš„å€¼ï¼Œä½†æ˜¯è¿™ä¸ªå€¼å¹¶ä¸èƒ½äº¤ç»™pythonä½¿ç”¨ï¼Œå› æ­¤åœ¨jsä»£ç ä¸­éœ€è¦ç”¨åˆ°<code>send(message[, data])</code>æ–¹æ³•å°†å€¼ä¼ é€’ç»™pythonå¤„ç†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><br>jscode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    function main()&#123;</span><br><span class="hljs-string">        Java.perform(function()&#123;</span><br><span class="hljs-string">            console.log(&quot;nihao123&quot;)</span><br><span class="hljs-string">            send(11111111)</span><br><span class="hljs-string">        &#125;)</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">    setImmediate(main)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment"># éœ€è¦è‡ªå®šä¹‰æ–¹æ³•ï¼Œå¤„ç†jsä¼ è¿‡æ¥çš„å€¼</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">onMessage</span>(<span class="hljs-params">message, data</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;message = <span class="hljs-subst">&#123;message&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;value = <span class="hljs-subst">&#123;message[<span class="hljs-string">&#x27;payload&#x27;</span>]&#125;</span>&quot;</span>)<br><br>device = frida.get_usb_device()<br>process = device.attach(<span class="hljs-string">&#x27;è®¾ç½®&#x27;</span>)<br>script = process.create_script(jscode)<span class="hljs-comment">#åˆ›å»ºæ³¨å…¥è„šæœ¬</span><br>script.on(<span class="hljs-string">&quot;message&quot;</span>, onMessage)<span class="hljs-comment">#æ³¨å†Œæ¶ˆæ¯å¤„ç†å‡½æ•°</span><br>script.load()<span class="hljs-comment">#æ³¨å…¥è„šæœ¬</span><br>sys.stdin.read()<span class="hljs-comment"># å›æ˜¾logè¾“å‡º</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">nihao123</span><br><span class="hljs-string">message = &#123;&#x27;type&#x27;: &#x27;send&#x27;, &#x27;payload&#x27;: 11111111&#125;</span><br><span class="hljs-string">value = 11111111</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure><h2 id="æ•°æ®ä»pythonåˆ°js"><a href="#æ•°æ®ä»pythonåˆ°js" class="headerlink" title="æ•°æ®ä»pythonåˆ°js"></a>æ•°æ®ä»pythonåˆ°js</h2><p>pythonè¦å‘jså‘é€æ•°æ®åˆ™éœ€è¦ä½¿ç”¨<code>script.post()</code>æ–¹æ³•ï¼Œjsä¸­åˆ™ä½¿ç”¨<code>recv([type, ]callback)</code>æ¥æ¥æ”¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><br>jscode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    function main()&#123;</span><br><span class="hljs-string">        Java.perform(function()&#123;</span><br><span class="hljs-string">            recv(function(obj)&#123;</span><br><span class="hljs-string">                console.log(obj.data)</span><br><span class="hljs-string">            &#125;).wait()</span><br><span class="hljs-string">        &#125;)</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">    setImmediate(main)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>device = frida.get_usb_device()<br>process = device.attach(<span class="hljs-string">&#x27;è®¾ç½®&#x27;</span>)<br>script = process.create_script(jscode)<span class="hljs-comment">#åˆ›å»ºæ³¨å…¥è„šæœ¬</span><br>script.load()<span class="hljs-comment">#æ³¨å…¥è„šæœ¬</span><br>script.post(&#123;<span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-string">&quot;111111&quot;</span>&#125;)<br>sys.stdin.read()<span class="hljs-comment"># å›æ˜¾logè¾“å‡º</span><br></code></pre></td></tr></table></figure><h1 id="rcpè½¬å‘"><a href="#rcpè½¬å‘" class="headerlink" title="rcpè½¬å‘"></a>rcpè½¬å‘</h1><p>js ç«¯ä½¿ç”¨<code>rpc.exports = &#123; key: value&#125;</code>å¯¼å‡ºå‡½æ•°ä¾›pythonä½¿ç”¨ï¼Œå…¶ä¸­é”®æŒ‡å®šæ–¹æ³•åç§°ï¼Œå€¼æ˜¯å¯¼å‡ºçš„å‡½æ•°ã€‚</p><p>pythonç«¯è°ƒç”¨<code>script.exports_sync.func()</code>æ‰§è¡Œjsä¸­çš„å‡½æ•°ã€‚</p><blockquote><p> æ³¨: å¦‚æœ js å¯¼å‡ºå‡½æ•°ä¸­åŒ…å«é©¼å³°å‘½åï¼Œåˆ™ python éœ€è¦å°†å¤§å†™æ›¿æ¢æˆ_å°å†™ï¼Œå¦‚ getUser &#x3D;&gt; get_user</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><br>jscode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    function add(a, b)&#123;</span><br><span class="hljs-string">        return a + b;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">    function sub(a, b)&#123;</span><br><span class="hljs-string">        return a - b;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">    rpc.exports = &#123;</span><br><span class="hljs-string">        add: add,</span><br><span class="hljs-string">        sub: sub</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>device = frida.get_usb_device()<br>process = device.attach(<span class="hljs-string">&#x27;è®¾ç½®&#x27;</span>)<br>script = process.create_script(jscode)<span class="hljs-comment">#åˆ›å»ºæ³¨å…¥è„šæœ¬</span><br>script.load()<span class="hljs-comment">#æ³¨å…¥è„šæœ¬</span><br><span class="hljs-comment"># result = script.exports.add(3, 5)æŠ¥é”™</span><br><span class="hljs-comment"># DeprecationWarning: Script.exports will become asynchronous in the future, use the explicit Script.exports_sync instead</span><br>result = script.exports_sync.add(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure><h1 id="ä½¿ç”¨-fastapi-æ­å»ºæœåŠ¡ç«¯æ¥å£"><a href="#ä½¿ç”¨-fastapi-æ­å»ºæœåŠ¡ç«¯æ¥å£" class="headerlink" title="ä½¿ç”¨ fastapi æ­å»ºæœåŠ¡ç«¯æ¥å£"></a>ä½¿ç”¨ fastapi æ­å»ºæœåŠ¡ç«¯æ¥å£</h1><p><a href="https://blog.csdn.net/my_name_is_learn/article/details/109819127">è¶…å…¨é¢æ•´ç†fastAPI(ä»å…¥é—¨åˆ°è¿ç”¨)ï¼Œè¿›æ¥çœ‹åç§’é’Ÿå†èµ°ä¸è¿Ÿ-CSDNåšå®¢</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> fastapi<br><span class="hljs-keyword">import</span> uvicorn<br><br>jscode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    function getUserData(uid)&#123;</span><br><span class="hljs-string">        return &#123;&quot;username&quot;: &quot;gal2xy&quot;, &quot;uid&quot;: uid, token: &quot;asldhoinzponpnasdf&quot;&#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">    rpc.exports = &#123;</span><br><span class="hljs-string">        getUserData: getUserData</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>app = fastapi.FastAPI()<br><span class="hljs-comment"># æ„é€ apiï¼šè¯·æ±‚æ–¹å¼(è·¯å¾„)ï¼Œè¯·æ±‚æ–¹å¼:getã€deleteã€postã€put</span><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/getUserData&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">getUserData</span>(<span class="hljs-params">uid</span>):<br>    result = script.exports_sync.get_user_data(uid)<br>    <span class="hljs-keyword">return</span> result<br>uvicorn.run(app, port=<span class="hljs-number">8080</span>)<span class="hljs-comment"># å¯åŠ¨æœåŠ¡ç«¯</span><br><br>device = frida.get_usb_device()<br>process = device.attach(<span class="hljs-string">&#x27;è®¾ç½®&#x27;</span>)<br>script = process.create_script(jscode)<span class="hljs-comment">#åˆ›å»ºæ³¨å…¥è„šæœ¬</span><br>script.load()<span class="hljs-comment">#æ³¨å…¥è„šæœ¬</span><br></code></pre></td></tr></table></figure><p>åœ¨æœ¬åœ°è®¿é—®<a href="http://127.0.0.1:8080/getUserData?uid=123">127.0.0.1:8080&#x2F;getUserData?uid&#x3D;123</a>å°±å¯ä»¥å¾—åˆ°userdataã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312181700772.png"></p><hr><p>å‚è€ƒï¼š</p><p><a href="https://kuizuo.cn/docs/frida-python-usage">Frida Pythonåº“ä½¿ç”¨ | æ„§æ€çš„å°ç«™ (kuizuo.cn)</a></p><p><a href="https://blog.csdn.net/my_name_is_learn/article/details/109819127">è¶…å…¨é¢æ•´ç†fastAPI(ä»å…¥é—¨åˆ°è¿ç”¨)ï¼Œè¿›æ¥çœ‹åç§’é’Ÿå†èµ°ä¸è¿Ÿ-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>Hook</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Frida</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Frida Javaå±‚Hookå­¦ä¹ ç¬”è®°</title>
    <link href="/2023/12/17/Frida%20Java%E5%B1%82Hook%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/12/17/Frida%20Java%E5%B1%82Hook%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå±‚Hook"><a href="#Javaå±‚Hook" class="headerlink" title="Javaå±‚Hook"></a>Javaå±‚Hook</h1><p>ç®€å•çš„ä»£ç æ¡†æ¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br><span class="hljs-comment">//ä½¿ç”¨Javaå¹³å°ï¼ŒJavaå±‚hookåœ¨Java.performä¸­æ‰§è¡Œ</span><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-comment">//ä»£ç é€»è¾‘</span><br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            ...<br>        &#125;<br>    )<br>&#125;<br><span class="hljs-comment">//è°ƒç”¨mainæ–¹æ³•</span><br><span class="hljs-title function_">setImmediate</span>(main)<br></code></pre></td></tr></table></figure><h2 id="è·å–ç±»å¯¹è±¡"><a href="#è·å–ç±»å¯¹è±¡" class="headerlink" title="è·å–ç±»å¯¹è±¡"></a>è·å–ç±»å¯¹è±¡</h2><ul><li><code>Java.use(classname)</code>ï¼šè·å–<code>classname</code>å¯¹åº”çš„ç±»ã€‚</li></ul><p>æ™®é€šç±»ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//æ™®é€šç±»çš„è·å–</span><br><span class="hljs-keyword">var</span> clazz = Java.<span class="hljs-keyword">use</span>(<span class="hljs-string">&quot;com.example.testfrida.demo&quot;</span>);<br></code></pre></td></tr></table></figure><p>å†…éƒ¨ç±»ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//å†…éƒ¨ç±»çš„è·å–</span><br><span class="hljs-keyword">var</span> clazz = Java.<span class="hljs-keyword">use</span>(<span class="hljs-string">&quot;com.example.testfrida.demo<span class="hljs-subst">$innerClass</span>&quot;</span>);<br><span class="hljs-keyword">var</span> clazz = Java.<span class="hljs-keyword">use</span>(<span class="hljs-string">&#x27;å¤–éƒ¨ç±»$1&#x27;</span>) <span class="hljs-comment">// è·å–ç¬¬ä¸€ä¸ªå†…éƒ¨ç±»</span><br></code></pre></td></tr></table></figure><p>åŒ¿åç±»ï¼š</p><p>åŒ¿åç±»æ˜¯æ ¹æ®å†…å­˜ç”Ÿæˆï¼Œæ²¡æœ‰å…·ä½“çš„å†…éƒ¨ç±»åï¼Œé€šè¿‡ smali ä»£ç æ¥åˆ¤æ–­ï¼Œå…·ä½“å‚è€ƒï¼š<a href="https://blog.xhyeax.com/2021/10/13/frida-hook-anonymous-class/">Frida HookåŒ¿åå†…éƒ¨ç±» | Xhyâ€™s Blog (xhyeax.com)</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;åŒ…å.MainActivity$1&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æšä¸¾ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java">Java.choose(<span class="hljs-string">&quot;æšä¸¾ç±»&quot;</span> &#123;<br>    onMatch: function (obj) &#123;<br>        console.log(obj.ordinal()); <span class="hljs-comment">// è¾“å‡ºæšä¸¾çš„é”®</span><br>    &#125;, onComplete: function () &#123;<br><br>    &#125;<br>&#125;)<br>console.log(Java.use(<span class="hljs-string">&quot;æšä¸¾ç±»&quot;</span>).values()); <span class="hljs-comment">// è¾“å‡ºå€¼</span><br></code></pre></td></tr></table></figure><p>è·å–ç±»å¯¹è±¡ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼Javaåå°„çš„æ–¹æ³•ï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> cl = java.<span class="hljs-title function_">use</span>(ç±»å)<br><span class="hljs-comment">//cl.newInstance()</span><br><span class="hljs-keyword">var</span> methods = cl.<span class="hljs-property">class</span>.<span class="hljs-title function_">getDeclaredMethods</span>() ã€<span class="hljs-title function_">getMethods</span>()  <span class="hljs-comment">// æ–¹æ³•</span><br><span class="hljs-keyword">var</span> constructors = cl.<span class="hljs-property">class</span>.<span class="hljs-title function_">getDeclaredConstructors</span>() <span class="hljs-comment">// æ„é€ å‡½æ•°</span><br><span class="hljs-keyword">var</span> fields = cl.<span class="hljs-property">class</span>.<span class="hljs-title function_">getDeclaredFields</span>() <span class="hljs-comment">// å­—æ®µ</span><br><span class="hljs-keyword">var</span> classes = cl.<span class="hljs-property">class</span>.<span class="hljs-title function_">getDeclaredClasses</span>() <span class="hljs-comment">// å†…éƒ¨ç±»</span><br><span class="hljs-keyword">var</span> superClass = cl.<span class="hljs-property">class</span>.<span class="hljs-title function_">getSuperclass</span>() <span class="hljs-comment">// çˆ¶ç±»(æŠ½è±¡ç±»)</span><br><span class="hljs-keyword">var</span> interfaces = cl.<span class="hljs-property">class</span>.<span class="hljs-title function_">getInterfaces</span>() <span class="hljs-comment">// æ‰€æœ‰æ¥å£</span><br><br><span class="hljs-comment">// éå†è¾“å‡º</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> method <span class="hljs-keyword">of</span> methods) &#123;<br>  <span class="hljs-comment">//method.getName()ã€invoke()</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ™®é€šæ–¹æ³•Hook"><a href="#æ™®é€šæ–¹æ³•Hook" class="headerlink" title="æ™®é€šæ–¹æ³•Hook"></a>æ™®é€šæ–¹æ³•Hook</h2><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>&#123;<br>        <span class="hljs-keyword">return</span>  a + b;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//åº”ç”¨ä¸­ä¸»åŠ¨è°ƒç”¨</span><br>Log.d(<span class="hljs-string">&quot;demo&quot;</span>, <span class="hljs-string">&quot;onCreate: &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">demo</span>().add(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>));<br></code></pre></td></tr></table></figure><p>hookä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.testfrida.demo&quot;</span>);<br>            clazz.<span class="hljs-property">add</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>)&#123;<br>                <span class="hljs-comment">//ä¿®æ”¹ä¼ å…¥çš„å‚æ•°å€¼</span><br>                a = <span class="hljs-number">1</span>;<br>                b = <span class="hljs-number">2</span>;<br>                <span class="hljs-comment">//è°ƒç”¨åŸæœ‰çš„addæ–¹æ³•ï¼Œå®ç°åŸæœ‰é€»è¾‘</span><br>                <span class="hljs-keyword">var</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">add</span>(a,b);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;value = &quot;</span> + result);<br>                <span class="hljs-comment">//åŸaddæ–¹æ³•éœ€è¦è¿”å›ï¼Œåœ¨è¿™é‡Œä¹Ÿéœ€è¦è¿”å›ç›¸åº”çš„ç±»å‹å€¼</span><br>                <span class="hljs-keyword">return</span> result;<br>            &#125;<br>        &#125;<br>    )<br>&#125;<br><span class="hljs-title function_">setImmediate</span>(main)<br><span class="hljs-comment">/*ç»“æœ</span><br><span class="hljs-comment">jsè¾“å‡ºï¼š</span><br><span class="hljs-comment">value = 3</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">app logè¾“å‡ºï¼š</span><br><span class="hljs-comment">onCreate: 3</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯hookï¼Œå¹¶æ²¡æœ‰ä¸»åŠ¨è°ƒç”¨addæ–¹æ³•ï¼Œåªæœ‰åº”ç”¨ç¨‹åºçš„ä»£ç é€»è¾‘è§¦å‘äº†æ‰ä¼šæœ‰ç»“æœã€‚</strong></p><h2 id="é‡è½½æ–¹æ³•Hook"><a href="#é‡è½½æ–¹æ³•Hook" class="headerlink" title="é‡è½½æ–¹æ³•Hook"></a>é‡è½½æ–¹æ³•Hook</h2><ul><li><code>class.methodname.overload(paramterTypes...)</code>ï¼šé€šè¿‡<code>overload</code>æŒ‡å®šç‰¹å®šçš„é‡è½½æ–¹æ³•ã€‚</li><li><code>class.methodname.overloads</code>ï¼šè·å–<code>class</code>ç±»ä¸­çš„<code>methodname</code>æ–¹æ³•çš„æ‰€æœ‰é‡è½½æ–¹æ³•ã€‚</li></ul><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>&#123;<br>        <span class="hljs-keyword">return</span>  a + b;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> c)</span>&#123;<br>        <span class="hljs-keyword">return</span> add(a, b) + c;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//åº”ç”¨ä¸­ä¸»åŠ¨è°ƒç”¨</span><br>Log.d(<span class="hljs-string">&quot;demo&quot;</span>, <span class="hljs-string">&quot;onCreate: &quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">demo</span>().add(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>));<br></code></pre></td></tr></table></figure><p>hookä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.testfrida.demo&quot;</span>);<br><span class="hljs-comment">//é€šè¿‡overload()æŒ‡å®šæ‰€è¦hookçš„é‡è½½æ–¹æ³•</span><br>            clazz.<span class="hljs-property">add</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>)&#123;<br>                <span class="hljs-comment">//é‡å†™ä¸¤ä¸ªå‚æ•°çš„addæ–¹æ³•çš„åŠ æ³•é€»è¾‘ä¸ºä¹˜æ³•é€»è¾‘</span><br>                <span class="hljs-keyword">var</span> result = a*b;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;value = &quot;</span> + result);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;<br><span class="hljs-comment">//é€šè¿‡overload()æŒ‡å®šæ‰€è¦hookçš„é‡è½½æ–¹æ³•</span><br>            clazz.<span class="hljs-property">add</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b, c</span>)&#123;<br>                <span class="hljs-comment">//é‡å†™ä¸‰ä¸ªå‚æ•°çš„addæ–¹æ³•çš„åŠ æ³•é€»è¾‘ä¸ºå‡æ³•é€»è¾‘</span><br>                <span class="hljs-keyword">var</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">add</span>(a,b) - c;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;value = &quot;</span> + result);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            //functionä¸­çš„å‚æ•°ä¸ªæ•°ä¹Ÿå¯ä»¥æ”¹å˜ï¼</span><br><span class="hljs-comment">            clazz.add.overload(&#x27;int&#x27;, &#x27;int&#x27;, &#x27;int&#x27;).implementation = function(a, b, c, d)&#123;</span><br><span class="hljs-comment">                d = 4</span><br><span class="hljs-comment">                var result = this.add(a,b) - c - d;</span><br><span class="hljs-comment">                console.log(&quot;value = &quot; + result);</span><br><span class="hljs-comment">                return result;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">            */</span><br>        &#125;<br>    )<br>&#125;<br><span class="hljs-title function_">setImmediate</span>(main)<br><span class="hljs-comment">/*ç»“æœ</span><br><span class="hljs-comment">jsè¾“å‡ºï¼šæ³¨é‡Šæ‰çš„ï¼š</span><br><span class="hljs-comment">value = 30value = 30</span><br><span class="hljs-comment">value = 23value = 19</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">app logè¾“å‡ºï¼š</span><br><span class="hljs-comment">onCreate: 23onCreate: 19</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.testfrida.demo&quot;</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clazz.<span class="hljs-property">add</span>.<span class="hljs-property">overloads</span>);<br><span class="hljs-comment">/*è¾“å‡º</span><br><span class="hljs-comment">function add(int, int): int,function add(int, int, int): int</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h2 id="æ„é€ æ–¹æ³•Hook"><a href="#æ„é€ æ–¹æ³•Hook" class="headerlink" title="æ„é€ æ–¹æ³•Hook"></a>æ„é€ æ–¹æ³•Hook</h2><ul><li><code>class.$init</code>ï¼šè·å–classç±»çš„æ„é€ æ–¹æ³•ï¼Œå¦‚æœ‰å¤šä¸ªé‡è½½çš„æ„é€ æ–¹æ³•ï¼Œä½¿ç”¨<code>.overload(paramterTypes...)</code>æŒ‡å®šã€‚</li></ul><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>...<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">demo</span><span class="hljs-params">()</span>&#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">demo</span><span class="hljs-params">(String b)</span> &#123;<br>        <span class="hljs-built_in">this</span>.b = b;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">demo</span><span class="hljs-params">(String b, <span class="hljs-type">boolean</span> flag)</span> &#123;<br>        <span class="hljs-built_in">this</span>.b = b;<br>        <span class="hljs-built_in">this</span>.flag = flag;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>hookä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.testfrida.demo&quot;</span>)<br>            <span class="hljs-comment">//å¤šä¸ªæ„é€ æ–¹æ³•ä½¿ç”¨overloadæ–¹æ³•æŒ‡å®š</span><br>            clazz.<span class="hljs-property">$init</span>.<span class="hljs-title function_">overload</span>().<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><span class="hljs-comment">//hookåä»£ç é€»è¾‘å®ç°</span><br>            &#125;<br>        &#125;<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å®ä¾‹åŒ–å¯¹è±¡"><a href="#å®ä¾‹åŒ–å¯¹è±¡" class="headerlink" title="å®ä¾‹åŒ–å¯¹è±¡"></a>å®ä¾‹åŒ–å¯¹è±¡</h2><ul><li><code>class.$new(paramters...)</code>ï¼šå®ä¾‹åŒ–classç±»å¯¹è±¡</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>    <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.testfrida.demo&quot;</span>);<br>        <span class="hljs-keyword">var</span> demoObj = clazz.$new();<br>        <span class="hljs-comment">//è°ƒç”¨addæ–¹æ³•</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(demoObj.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><h2 id="ä¸»åŠ¨è°ƒç”¨æ–¹æ³•"><a href="#ä¸»åŠ¨è°ƒç”¨æ–¹æ³•" class="headerlink" title="ä¸»åŠ¨è°ƒç”¨æ–¹æ³•"></a>ä¸»åŠ¨è°ƒç”¨æ–¹æ³•</h2><ul><li><p>é™æ€æ–¹æ³•ï¼šå¯é€šè¿‡ç±»ç›´æ¥è°ƒç”¨ï¼Œä¹Ÿå¯é€šè¿‡å®ä¾‹è°ƒç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(ç±»å) <br>clazz.æ–¹æ³•()<br></code></pre></td></tr></table></figure></li><li><p>éé™æ€æ–¹æ³•ï¼šåªèƒ½é€šè¿‡å®ä¾‹è°ƒç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(ç±»å) <br><span class="hljs-keyword">var</span> <span class="hljs-title class_">Obj</span> = clazz.$new(paramters...)<br><span class="hljs-title class_">Obj</span>.æ–¹æ³•(paramters...)<br></code></pre></td></tr></table></figure></li></ul><h2 id="è·å–å·²æœ‰å¯¹è±¡"><a href="#è·å–å·²æœ‰å¯¹è±¡" class="headerlink" title="è·å–å·²æœ‰å¯¹è±¡"></a>è·å–å·²æœ‰å¯¹è±¡</h2><p>å†…å­˜ä¸­éå†ï¼Œæ‰¾åˆ°æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&#x27;ç±»è·¯å¾„&#x27;</span>, &#123;<br>    <span class="hljs-comment">//æ¯éå†ä¸€ä¸ªå¯¹è±¡éƒ½ä¼šè°ƒç”¨onMatch</span><br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) &#123;<br>        <span class="hljs-comment">//todo...(ä¸»è¦åœ¨è¿™é‡Œå®ç°ä»£ç é€»è¾‘)</span><br>    &#125;,<br>    <span class="hljs-comment">//éå†å®Œæˆåè°ƒç”¨onComplete</span><br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-comment">//todo...</span><br>    &#125;,<br>&#125;)<br></code></pre></td></tr></table></figure><h2 id="å­—æ®µHook"><a href="#å­—æ®µHook" class="headerlink" title="å­—æ®µHook"></a>å­—æ®µHook</h2><blockquote><p><strong>æ³¨: å¦‚æœå­—æ®µåä¸æ–¹æ³•åä¸€æ ·ï¼Œåˆ™éœ€è¦ç»™å­—æ®µåå‰åŠ ä¸‹åˆ’çº¿_ï¼Œå¦åˆ™è·å–åˆ°çš„æ˜¯æ–¹æ³•</strong></p></blockquote><h3 id="é™æ€å­—æ®µ"><a href="#é™æ€å­—æ®µ" class="headerlink" title="é™æ€å­—æ®µ"></a>é™æ€å­—æ®µ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">ç±».å­—æ®µ<span class="hljs-comment">//è·å–ç±»çš„å±æ€§å®šä¹‰ï¼Œä¾‹å¦‚Java.Field&#123;holder: &lt;class: com.example.testfrida.demo&gt;, fieldType: 1, fieldReturnType: I, value: 3&#125;</span><br>ç±».å­—æ®µ.<span class="hljs-property">value</span> <span class="hljs-comment">// è·å–ç±»çš„å±æ€§å€¼</span><br>ç±».å­—æ®µ.<span class="hljs-property">value</span> = newValue <span class="hljs-comment">// ä¿®æ”¹ç±»çš„å€¼</span><br></code></pre></td></tr></table></figure><h3 id="éé™æ€å­—æ®µ"><a href="#éé™æ€å­—æ®µ" class="headerlink" title="éé™æ€å­—æ®µ"></a>éé™æ€å­—æ®µ</h3><ul><li><p>é€šè¿‡<code>$new</code>å®ä¾‹åŒ–å¯¹è±¡ï¼Œç„¶åå†è·å–ã€‚</p></li><li><p>ä½¿ç”¨<code>Java.choose()</code>éå†å†…å­˜è·å–å·²å­˜åœ¨çš„ç±»å¯¹è±¡ï¼Œç„¶åå†è·å–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java">Java.choose(<span class="hljs-string">&#x27;ç±»è·¯å¾„&#x27;</span>, &#123;<br>    onMatch: function (obj) &#123;<br>        obj.å­—æ®µ.value = ?;<br>        console.log(obj.å­—æ®µ.value);<br>    &#125;,<br>    onComplete: function () &#123;&#125;,<br>&#125;)<br></code></pre></td></tr></table></figure></li></ul><h2 id="è·å–å·²åŠ è½½çš„æ‰€æœ‰ç±»å"><a href="#è·å–å·²åŠ è½½çš„æ‰€æœ‰ç±»å" class="headerlink" title="è·å–å·²åŠ è½½çš„æ‰€æœ‰ç±»å"></a>è·å–å·²åŠ è½½çš„æ‰€æœ‰ç±»å</h2><ul><li><code>Java.enumerateLoadedClassesSync()</code> ï¼š åŒæ­¥è·å–å·²åŠ è½½æ‰€æœ‰ç±»ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œ<strong>é‡Œé¢çš„ç±»å‹æ˜¯å­—ç¬¦ä¸²å¹¶ä¸æ˜¯ç±»å¯¹è±¡</strong>ã€‚</li><li><code>Java.enumerateLoadedClasses() </code>ï¼šå¼‚æ­¥è·å–å·²åŠ è½½æ‰€æœ‰ç±»ï¼Œéœ€å†…éƒ¨å®ç°onMatchã€onCompleteæ–¹æ³•ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//1.</span><br><span class="hljs-keyword">var</span> classes = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">enumerateLoadedClassesSync</span>();<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;classes.<span class="hljs-property">length</span>;i++)&#123;<br>    <span class="hljs-keyword">if</span>(classes[i] == <span class="hljs-string">&quot;com.example.testfrida.demo&quot;</span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">typeof</span>(classes[i]));<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(classes[i]);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//2.</span><br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">enumerateLoadedClasses</span>(&#123;<br>    <span class="hljs-comment">//å¯¹æ¯ä¸ªç±»è¿›è¡Œæ“ä½œ</span><br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">clazz</span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clazz);<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><h2 id="è·å–ClassLoader"><a href="#è·å–ClassLoader" class="headerlink" title="è·å–ClassLoader"></a>è·å–ClassLoader</h2><ul><li><code>Java.enumerateClassLoadersSync()</code> ï¼š åŒæ­¥è·å–å·²å­˜åœ¨çš„æ‰€æœ‰ç±»åŠ è½½å™¨ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œ<strong>é‡Œé¢çš„æ˜¯ç±»åŠ è½½å™¨å¯¹è±¡</strong>ã€‚</li><li><code>Java.enumerateClassLoaders() </code>ï¼šå¼‚æ­¥è·å–å·²å­˜åœ¨çš„æ‰€æœ‰åŠ è½½å™¨ï¼Œéœ€å†…éƒ¨å®ç°onMatchã€onCompleteæ–¹æ³•ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//1.</span><br><span class="hljs-keyword">var</span> loaderlist = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">enumerateClassLoadersSync</span>()<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> loader <span class="hljs-keyword">of</span> loaderlist)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(loader);<br>&#125;<br><span class="hljs-comment">//2.</span><br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">enumerateClassLoaders</span>(&#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">loader</span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(loader);<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>hookåŠ¨æ€åŠ è½½çš„ç±»ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>    <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">enumerateClassLoaders</span>(&#123;<br>            <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">loader</span>)&#123;<br>                <span class="hljs-comment">//éœ€è¦ä½¿ç”¨try-catchæ¨¡å—ï¼Œå› ä¸ºfindClasså¯èƒ½å› æ‰¾ä¸åˆ°ç±»è€ŒæŠ¥é”™</span><br>                <span class="hljs-keyword">try</span>&#123;<br>                    <span class="hljs-keyword">if</span>(loader.<span class="hljs-title function_">finClass</span>(<span class="hljs-string">&quot;com.example.testfrida.nodo&quot;</span>))&#123;<br>                        <span class="hljs-comment">//æ›´æ”¹jsä»£ç å½“å‰æ‰€ä½¿ç”¨çš„classloaderä¸ºæ­¤loader</span><br>                        java.<span class="hljs-property">ClassFactory</span>.<span class="hljs-property">loader</span> = loader<br>                        <span class="hljs-comment">//è¿›è¡Œhookå®ç°</span><br>                        <span class="hljs-keyword">var</span> clazz = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.testfrida.nodo&quot;</span>)<br>                        clazz.<span class="hljs-property">add</span>.<span class="hljs-property">implementation</span>  =  <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>)&#123;<br>                            <span class="hljs-keyword">return</span> a - b;<br>                        &#125;<br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clazz.<span class="hljs-title function_">add</span>(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>));<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">catch</span>(error)&#123;<br><br>                &#125;<br><br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>            &#125;<br>        &#125;);<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><h2 id="æ„å»ºJavaæ•°ç»„"><a href="#æ„å»ºJavaæ•°ç»„" class="headerlink" title="æ„å»ºJavaæ•°ç»„"></a>æ„å»ºJavaæ•°ç»„</h2><ul><li><code>Java.array(type,elements)</code>ï¼šæ„é€ <code>elements</code>æ•°ç»„ä¸º<code>type</code>ç±»å‹çš„Javaæ•°ç»„ï¼Œå…¶ä¸­<code>type</code>æ˜¯Javaç±»å‹çš„ç­¾åã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//å­—ç¬¦ä¸²æ•°ç»„</span><br><span class="hljs-keyword">var</span> arr = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">array</span>(<span class="hljs-string">&#x27;Ljava.lang.String;&#x27;</span>,[<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>])<br><span class="hljs-comment">//intæ•°ç»„</span><br><span class="hljs-keyword">var</span> values = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">array</span>(<span class="hljs-string">&#x27;int&#x27;</span>, [ <span class="hljs-number">1003</span>, <span class="hljs-number">1005</span>, <span class="hljs-number">1007</span> ]);<br><span class="hljs-comment">//byteæ•°ç»„</span><br><span class="hljs-keyword">const</span> values = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">array</span>(<span class="hljs-string">&#x27;byte&#x27;</span>, [ <span class="hljs-number">0x48</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x69</span> ])<br><span class="hljs-comment">//å¯¹è±¡æ•°ç»„</span><br><span class="hljs-keyword">var</span> integerclass = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.Integer&#x27;</span>)<span class="hljs-comment">//è·å–Javaä¸­Integerå¯¹è±¡</span><br><span class="hljs-keyword">var</span> booleanclass = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.Boolean&#x27;</span>)<span class="hljs-comment">//è·å–Javaä¸­Booleanå¯¹è±¡</span><br><span class="hljs-comment">//æ„å»ºå¯¹è±¡æ•°ç»„ï¼ŒåŸºæœ¬ç±»å‹ä¸æ˜¯å¯¹è±¡ï¼Œéœ€è¦åŒ…è£…æˆå¯¹è±¡æ‰è¡Œ</span><br><span class="hljs-keyword">var</span> objarr = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">array</span>(<span class="hljs-string">&#x27;Ljava.lang.Object;&#x27;</span>, [<span class="hljs-string">&#x27;hello&#x27;</span>, integerclass.$new(<span class="hljs-number">1</span>), booleanclass.$new(<span class="hljs-literal">true</span>)])<br><br><span class="hljs-comment">//åŠ¨æ€æ•°ç»„ArrayList</span><br><span class="hljs-keyword">var</span> arraylist = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.util.ArrayList&#x27;</span>).$new()<br><span class="hljs-keyword">var</span> num = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.Integer&#x27;</span>).$new(<span class="hljs-number">1</span>)<br>arraylist.<span class="hljs-title function_">add</span>(num);<br>arraylist.<span class="hljs-title function_">add</span>(<span class="hljs-string">&#x27;hello&#x27;</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arraylist);<br>arraylist.<span class="hljs-title function_">remove</span>(num);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arraylist)<br></code></pre></td></tr></table></figure><h2 id="å–æ¶ˆHook"><a href="#å–æ¶ˆHook" class="headerlink" title="å–æ¶ˆHook"></a>å–æ¶ˆHook</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> cl = java.<span class="hljs-title function_">use</span>(ç±»å)<br><span class="hljs-comment">//å¯¹æ–¹æ³•è¿›è¡Œhook</span><br>cl.æ–¹æ³•å.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>&#125;<br><span class="hljs-comment">//å–æ¶ˆhook</span><br>cl.æ–¹æ³•å.<span class="hljs-property">implementation</span> = <span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure><h2 id="ç±»å‹è½¬æ¢"><a href="#ç±»å‹è½¬æ¢" class="headerlink" title="ç±»å‹è½¬æ¢"></a>ç±»å‹è½¬æ¢</h2><ul><li><code>Java.cast(handle, klass)</code>ï¼šå°†å¥æŸ„handleè½¬æˆklassç±»å‹çš„å˜é‡&#x2F;ç±»å‹ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Activity</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;android.app.Activity&#x27;</span>);<br><span class="hljs-keyword">const</span> activity = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(<span class="hljs-title function_">ptr</span>(<span class="hljs-string">&#x27;0x1234&#x27;</span>), <span class="hljs-title class_">Activity</span>);<br></code></pre></td></tr></table></figure><h2 id="æ–‡ä»¶æ“ä½œ"><a href="#æ–‡ä»¶æ“ä½œ" class="headerlink" title="æ–‡ä»¶æ“ä½œ"></a>æ–‡ä»¶æ“ä½œ</h2><ul><li><code>Java.openClassFile(filePath)</code>ï¼šæ‰“å¼€dexæ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ‹¥æœ‰<code>load()</code>ï¼ˆåŠ è½½åŒ…å«çš„ç±»ï¼‰ã€<code>getClassNames()</code>æ–¹æ³•</li></ul><h2 id="å‡½æ•°å †æ ˆæ‰“å°"><a href="#å‡½æ•°å †æ ˆæ‰“å°" class="headerlink" title="å‡½æ•°å †æ ˆæ‰“å°"></a>å‡½æ•°å †æ ˆæ‰“å°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">showStack</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;android.util.Log&#x27;</span>).<span class="hljs-title function_">getStackTraceString</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.Throwable&#x27;</span>).$new()))<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/qq_38474570/article/details/120876120">Androidä¹‹Fridaæ¡†æ¶å®Œå…¨ä½¿ç”¨æŒ‡å—-CSDNåšå®¢</a></p><p><a href="https://kuizuo.cn/docs/frida-note">https://kuizuo.cn/docs/frida-note</a></p><p><a href="https://frida.re/docs/javascript-api/#java">JavaScript API | Frida â€¢ A world-class dynamic instrumentation toolkit</a></p><p><a href="https://blog.csdn.net/weixin_35016347/article/details/104002411">Fridaç”¨æ³•è¯¦è§£ã€é™„ç”¨ä¾‹ã€‘_frida -u -f-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>Hook</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Frida</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidç¬¬ä¸€äºŒä»£å£³çš„è„±å£³ç‚¹åˆ†æ</title>
    <link href="/2023/12/12/Android%E7%AC%AC%E4%B8%80%E4%BA%8C%E4%BB%A3%E5%A3%B3%E7%9A%84%E8%84%B1%E5%A3%B3%E7%82%B9%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/12/Android%E7%AC%AC%E4%B8%80%E4%BA%8C%E4%BB%A3%E5%A3%B3%E7%9A%84%E8%84%B1%E5%A3%B3%E7%82%B9%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<blockquote><p>åªè®²ARTä¸‹çš„è„±å£³ï¼ŒDVMå¤ªè¿‡æ—¶äº†</p></blockquote><hr><h1 id="ä¸€ã€è„±å£³ç‚¹åˆ†æ"><a href="#ä¸€ã€è„±å£³ç‚¹åˆ†æ" class="headerlink" title="ä¸€ã€è„±å£³ç‚¹åˆ†æ"></a>ä¸€ã€è„±å£³ç‚¹åˆ†æ</h1><p>ç¼–å†™è¿‡Androidç¬¬ä¸€äºŒä»£åŠ å›ºå£³çš„å¯ä»¥çŸ¥é“ï¼Œæ— è®ºæ˜¯é€šè¿‡ç³»ç»Ÿçš„ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œè¿˜æ˜¯é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œæ— ä¸€ä¾‹å¤–ï¼Œæœ€ç»ˆéƒ½é€ƒä¸è¿‡åˆ›å»ºDexFileå¯¹è±¡ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DexFile</span> &#123;<br>    ...<br>    <span class="hljs-comment">// Raw header_item.</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Header</span> &#123;<br>        <span class="hljs-type">uint8_t</span> magic_[<span class="hljs-number">8</span>];<br>        <span class="hljs-type">uint32_t</span> checksum_;  <span class="hljs-comment">// See also location_checksum_</span><br>        <span class="hljs-type">uint8_t</span> signature_[kSha1DigestSize];<br>        <span class="hljs-type">uint32_t</span> file_size_;  <span class="hljs-comment">// size of entire file</span><br>        <span class="hljs-type">uint32_t</span> header_size_;  <span class="hljs-comment">// offset to start of next section</span><br>        <span class="hljs-type">uint32_t</span> endian_tag_;<br>        <span class="hljs-type">uint32_t</span> link_size_;  <span class="hljs-comment">// unused</span><br>        <span class="hljs-type">uint32_t</span> link_off_;  <span class="hljs-comment">// unused</span><br>        <span class="hljs-type">uint32_t</span> map_off_;  <span class="hljs-comment">// unused</span><br>        <span class="hljs-type">uint32_t</span> string_ids_size_;  <span class="hljs-comment">// number of StringIds</span><br>        <span class="hljs-type">uint32_t</span> string_ids_off_;  <span class="hljs-comment">// file offset of StringIds array</span><br>        <span class="hljs-type">uint32_t</span> type_ids_size_;  <span class="hljs-comment">// number of TypeIds, we don&#x27;t support more than 65535</span><br>        <span class="hljs-type">uint32_t</span> type_ids_off_;  <span class="hljs-comment">// file offset of TypeIds array</span><br>        <span class="hljs-type">uint32_t</span> proto_ids_size_;  <span class="hljs-comment">// number of ProtoIds, we don&#x27;t support more than 65535</span><br>        <span class="hljs-type">uint32_t</span> proto_ids_off_;  <span class="hljs-comment">// file offset of ProtoIds array</span><br>        <span class="hljs-type">uint32_t</span> field_ids_size_;  <span class="hljs-comment">// number of FieldIds</span><br>        <span class="hljs-type">uint32_t</span> field_ids_off_;  <span class="hljs-comment">// file offset of FieldIds array</span><br>        <span class="hljs-type">uint32_t</span> method_ids_size_;  <span class="hljs-comment">// number of MethodIds</span><br>        <span class="hljs-type">uint32_t</span> method_ids_off_;  <span class="hljs-comment">// file offset of MethodIds array</span><br>        <span class="hljs-type">uint32_t</span> class_defs_size_;  <span class="hljs-comment">// number of ClassDefs</span><br>        <span class="hljs-type">uint32_t</span> class_defs_off_;  <span class="hljs-comment">// file offset of ClassDef array</span><br>        <span class="hljs-type">uint32_t</span> data_size_;  <span class="hljs-comment">// unused</span><br>        <span class="hljs-type">uint32_t</span> data_off_;  <span class="hljs-comment">// unused</span><br>        <span class="hljs-keyword">private</span>:<br>        <span class="hljs-built_in">DISALLOW_COPY_AND_ASSIGN</span>(Header);<br>    &#125;;<br>    ...<br>    <span class="hljs-comment">// å…³é”®å‡½æ•°ï¼šè¿”å›DexFileå¯¹è±¡å¯¹åº”çš„å†…å­˜ä¸­çš„dexçš„èµ·å§‹åœ°å€</span><br>    <span class="hljs-function"><span class="hljs-type">const</span> byte* <span class="hljs-title">Begin</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> begin_;<br>    &#125;<br><span class="hljs-comment">// å…³é”®å‡½æ•°ï¼šè¿”å›DexFileå¯¹è±¡å¯¹åº”çš„å†…å­˜ä¸­çš„dexçš„å¤§å°</span><br>    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">Size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> size_;<br>    &#125;<br>    ...<br>    <span class="hljs-comment">// å…³é”®å˜é‡ï¼šå†…å­˜ä¸­çš„dexçš„èµ·å§‹åœ°å€</span><br>    <span class="hljs-type">const</span> byte* <span class="hljs-type">const</span> begin_;<br>    <span class="hljs-comment">// å…³é”®å˜é‡ï¼šå†…å­˜ä¸­çš„dexçš„å¤§å°</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> size_;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤ï¼Œæˆ‘ä»¬è„±å£³ï¼Œä¹Ÿä¼šå›´ç»•DexFileè¿™ä¸ªç±»ï¼ˆæˆ–è€…è¯´æ˜¯å¯¹è±¡ï¼‰æ¥è¿›è¡Œã€‚</p><p>æˆ‘ä»¬è¦æ˜ç™½ï¼Œè„±å£³æ— éå°±æ˜¯ä»å†…å­˜ä¸­å°†è§£å¯†çŠ¶æ€ä¸‹çš„dexæ•´ä½“dumpä¸‹æ¥ï¼ˆæˆ–è€…è¯´å†™æˆæ–‡ä»¶å­˜å‚¨ä¸‹æ¥ï¼‰ã€‚è€Œè¦æƒ³å®ç°è¿™ä¸€ç›®çš„ï¼Œå°±éœ€è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>å†…å­˜ä¸­dexçš„èµ·å§‹åœ°å€å’Œå¤§å°ï¼Œæˆ–è€…æ˜¯DexFileå¯¹è±¡ï¼Œç”šè‡³æ˜¯DexFileå¯¹è±¡çš„é¦–åœ°å€ã€‚</li><li>è„±å£³æ—¶æœºï¼Œåªæœ‰æ­£ç¡®çš„è„±å£³æ—¶æœºï¼Œæ‰èƒ½å¤Ÿdumpä¸‹è§£å¯†çŠ¶æ€ä¸‹çš„dexï¼Œå¦åˆ™å³ä½¿dumpä¸‹æ¥ä¹Ÿåªæ˜¯åŠ å¯†çŠ¶æ€ä¸‹çš„dexã€‚</li></ol><p>å¯¹äºé—®é¢˜ä¸€ï¼Œæˆ‘ä»¬è·Ÿè¸ªdexæ–‡ä»¶çš„åŠ è½½æµç¨‹å°±å¯ä»¥å¾ˆå®¹æ˜“è§£å†³çš„ã€‚dexæ–‡ä»¶çš„åŠ è½½æµç¨‹å…·ä½“è§ï¼š</p><ul><li><a href="https://gal2xy.github.io/2023/12/06/InMemoryDexClassLoader%E5%8A%A0%E8%BD%BD%E5%86%85%E5%AD%98dex%E7%9A%84%E6%B5%81%E7%A8%8B/">InMemoryDexClassLoaderåŠ è½½å†…å­˜dexçš„æµç¨‹</a></li><li><a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%80)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸€)</a></li></ul><p>åœ¨é“¾æ¥æ–‡ç« ä¸­ï¼Œæ‹¥æœ‰dexçš„èµ·å§‹åœ°å€å’Œå¤§å°çš„æœ‰è¿™ä¹ˆå‡ ä¸ªå‡½æ•°ï¼š</p><ul><li>DexFile::Open(const uint8_t* base, size_t size, â€¦)</li><li>OpenAndReadMagic()ï¼Œå› ä¸ºè¯¥å‡½æ•°ä¸­ä¼šåˆ›å»ºdexæ–‡ä»¶è¾“å…¥æµï¼Œå¯ä»¥å€Ÿæ­¤dumpã€‚</li><li>OpenCommon(const uint8_t* base, size_t size, â€¦)</li><li>OpenMemory(const uint8_t* base, size_t size, â€¦)</li><li>DexFileçš„æ„é€ å‡½æ•°</li><li>DexFileVerifier::Verify(const DexFile* dex_file, const uint8_t* begin, size_t size, â€¦)</li><li>DexFileVerifierçš„æ„é€ å‡½æ•°</li></ul><p>å› æ­¤å®ƒä»¬éƒ½å¯ä»¥ä½œä¸ºè„±å£³ç‚¹ã€‚å½“ç„¶äº†ï¼Œ è‚¯å®šä¸æ­¢è¿™äº›å‡½æ•°ï¼Œè¿˜æœ‰å¾ˆå¤šå¾ˆå¤šå‡½æ•°å¯ä»¥ä½œä¸ºè„±å£³ç‚¹ï¼Œæ¯”å¦‚è¯´é‚£äº›è¿”å›å€¼æ˜¯DexFileç±»å‹çš„å‡½æ•°ã€ä¸DexFileæœ‰å…³çš„å‡½æ•°ã€ä¸cookieæœ‰å…³çš„å‡½æ•°ç­‰ç­‰ã€‚å¯¹è¿™äº›å‡½æ•°åœ¨æºç å±‚é¢è¿›è¡Œæ”¹å†™ï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„è„±å£³æœºäº†ã€‚</p><p>é—®é¢˜äºŒå¾ˆç®€å•ï¼Œå¦‚ä½•ç¡®å®šè„±å£³æ—¶æœºå‘¢ï¼Ÿæ ¹æ®è„±å£³ç¨‹åºä¸­çš„ä»£ç é€»è¾‘ï¼Œé¦–å…ˆæ˜¯å£³ç¨‹åºå…ˆèµ°ä¸€édexåŠ è½½æµç¨‹ï¼Œç„¶åå†æ˜¯æºç¨‹åºèµ°ä¸€édexåŠ è½½æµç¨‹ï¼Œè™½ç„¶æœ‰çš„è„±å£³ç‚¹ä¼šè§¦å‘ä¸¤æ¬¡ï¼Œå³ä¼šdumpä¸¤æ¬¡ï¼ˆä¸€æ¬¡å£³ç¨‹åºdexï¼Œä¸€æ¬¡æºç¨‹åºdexï¼‰ï¼Œä½†æ˜¯æ²¡å…³ç³»ï¼Œå› ä¸ºdumpä¸‹æ¥ä¿å­˜çš„æ–‡ä»¶åæ˜¯å›ºå®šçš„ï¼Œé€ æˆçš„ç»“æœå°±æ˜¯é‡å†™è¦†ç›–ï¼Œè€Œåè€…å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„æºç¨‹åºdexã€‚</p><h1 id="äºŒã€è„±å£³æ–¹æ³•"><a href="#äºŒã€è„±å£³æ–¹æ³•" class="headerlink" title="äºŒã€è„±å£³æ–¹æ³•"></a>äºŒã€è„±å£³æ–¹æ³•</h1><p>è¯¦è§[<a href="https://bbs.kanxue.com/thread-273293.htm#msg_header_h2_4">åŸåˆ›]Androidæ¼æ´ä¹‹æˆ˜ï¼ˆ11ï¼‰â€”â€”æ•´ä½“åŠ å£³åŸç†å’Œè„±å£³æŠ€å·§è¯¦è§£-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a>ã€‚</p><hr><p>å‚è€ƒï¼š</p><p>[<a href="https://bbs.kanxue.com/thread-254555.htm">åŸåˆ›]æ‹¨äº‘è§æ—¥ï¼šå®‰å“APPè„±å£³çš„æœ¬è´¨ä»¥åŠå¦‚ä½•å¿«é€Ÿå‘ç°ARTä¸‹çš„è„±å£³ç‚¹-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p><a href="https://bbs.kanxue.com/thread-273293.htm">Androidæ¼æ´ä¹‹æˆ˜ï¼ˆ11ï¼‰â€”â€”æ•´ä½“åŠ å£³åŸç†å’Œè„±å£³æŠ€å·§è¯¦è§£</a></p><p><a href="https://bbs.kanxue.com/thread-277771.htm">[åŸåˆ›]ARTç¯å¢ƒä¸‹dexåŠ è½½æµç¨‹åˆ†æåŠfrida dump dexæ–¹æ¡ˆ</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidè„±å£³</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidç¬¬äºŒä»£åŠ å›ºå£³çš„åŸç†åŠå®ç° â€”â€” ä¸è½åœ°åŠ è½½</title>
    <link href="/2023/12/10/Android%E7%AC%AC%E4%BA%8C%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/12/10/Android%E7%AC%AC%E4%BA%8C%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å¯¹ç¬¬ä¸€ä»£å£³çš„æ”¹è‰¯"><a href="#ä¸€ã€å¯¹ç¬¬ä¸€ä»£å£³çš„æ”¹è‰¯" class="headerlink" title="ä¸€ã€å¯¹ç¬¬ä¸€ä»£å£³çš„æ”¹è‰¯"></a>ä¸€ã€å¯¹ç¬¬ä¸€ä»£å£³çš„æ”¹è‰¯</h1><p>åœ¨ç¬¬ä¸€ä»£åŠ å›ºå£³ä¸­ï¼Œä¼šå°†æºç¨‹åºAPKå­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç„¶åå†é€šè¿‡DexClassLoaderåŠ¨æ€åŠ è½½ã€‚è¿™ç§è½åœ°åŠ è½½æ–¹å¼å­˜åœ¨å¾ˆå¤§é—®é¢˜ï¼Œä¸€æ˜¯å®¹æ˜“åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è·å–åˆ°æºç¨‹åºAPKï¼ŒäºŒæ˜¯ä¸¤æ¬¡åŠ è½½æºç¨‹åºAPKåˆ°å†…å­˜ä¸­ï¼Œæ•ˆç‡ä½ã€‚</p><p>ç¬¬äºŒä»£å£³å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œåšåˆ°ä¸è½åœ°åŠ è½½ï¼Œå³ä¸ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿä½œä¸ºä¸­è½¬ç«™ï¼Œè€Œæ˜¯ç›´æ¥å°†å†…å­˜ä¸­çš„æºAPKå­—èŠ‚ç è¿›è¡ŒåŠ è½½ã€‚</p><p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæ€æ ·è§£å†³åŠ è½½å†…å­˜dexçš„éš¾é¢˜å‘¢ï¼Ÿ</p><h2 id="1-1-å¦‚ä½•åŠ è½½å†…å­˜dex"><a href="#1-1-å¦‚ä½•åŠ è½½å†…å­˜dex" class="headerlink" title="1.1 å¦‚ä½•åŠ è½½å†…å­˜dex"></a>1.1 å¦‚ä½•åŠ è½½å†…å­˜dex</h2><p>ä¸ç®¡æ˜¯ç›´æ¥åŠ è½½æ–‡ä»¶å­—èŠ‚ç è¿˜æ˜¯å€ŸåŠ©æ–‡ä»¶ç³»ç»Ÿä½œä¸ºä¸­è½¬ç«™æ¥åŠ è½½ï¼Œæœ€ç»ˆè‚¯å®šæ˜¯éƒ½éœ€è¦è§£ædexæ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬æ¥çœ‹çœ‹dexæ–‡ä»¶åŠ è½½æºç ä¸­æœ‰æ²¡æœ‰ç›´æ¥åŠ è½½æ–‡ä»¶å­—èŠ‚ç çš„æ–¹æ³•ã€‚</p><p>å…·ä½“åˆ†æè¯¦è§<a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%80)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸€)</a>ã€‚è¿™é‡Œå°±ç®€æ˜è¯´ä¸€ä¸‹ï¼š</p><ol><li><p>Android 4åŠä»¥ä¸‹ï¼Œæœ€ç»ˆè°ƒç”¨å¸¦ä¸‰ä¸ªå‚æ•°çš„nativeæ–¹æ³•<code>openDexFile()</code>ï¼Œä½†å¹¶ä¸æ¥å—æ–‡ä»¶å­—èŠ‚ç ä½œä¸ºå‚æ•°ã€‚<strong>ç„¶è€Œå…¶å¦ä¸€ä¸ªé‡è½½æ–¹æ³•æ¥å—å­—èŠ‚ç æ•°ç»„ä½œä¸ºå‚æ•°ä¼ å…¥</strong>ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312101628175.png"></p></li><li><p>Android 5~7ï¼Œæœ€ç»ˆè°ƒç”¨<code>openDexFile()</code>æ–¹æ³•ï¼Œé‡Œé¢ä¼šè°ƒç”¨nativeæ–¹æ³•<code>openDexFileNative()</code>ï¼Œç„¶è€Œå¹¶ä¸æ¥å—æ–‡ä»¶å­—èŠ‚ç ä½œä¸ºå‚æ•°ã€‚å› æ­¤éœ€è¦å€ŸåŠ©<code>libart.so</code>åº“ä¸­çš„<code>OpenMemory()</code>å‡½æ•°æ¥å®ç°å†…å­˜åŠ è½½æ–‡ä»¶å­—èŠ‚ç ï¼ˆéœ€è¦ç¼–å†™nativeå±‚ä»£ç å®ç°ï¼‰ã€‚</p></li><li><p>Android 8åŠä»¥ä¸Šï¼Œè·ŸAndroid 5~7ä¸€æ ·çš„æµç¨‹ï¼Œä½†æ˜¯é¢å¤–å¤šäº†ä¸€ä¸ªç”¨äºåŠ è½½å†…å­˜dexçš„ç±»åŠ è½½å™¨InMemoryDexClassLoaderï¼Œè¯¦ç»†è§<a href="https://gal2xy.github.io/2023/12/06/InMemoryDexClassLoader%E5%8A%A0%E8%BD%BD%E5%86%85%E5%AD%98dex%E7%9A%84%E6%B5%81%E7%A8%8B/">InMemoryDexClassLoaderåŠ è½½å†…å­˜dexçš„æµç¨‹</a>ã€‚</p></li></ol><p>ä¸ç®¡å“ªç§æ–¹æ³•ï¼Œå®ƒä»¬éƒ½ä¼šè¿”å›ä¸€ä¸ªcookieå€¼ï¼Œå®ƒæ˜¯å¯¹dexæ–‡ä»¶è¿›è¡Œæ“ä½œçš„å”¯ä¸€å‡­æ®ï¼Œå¯ä»¥ç®€å•ç†è§£æˆdexæ–‡ä»¶çš„â€œèº«ä»½è¯â€ã€‚</p><blockquote><p>ä¸ç®¡ä»€ä¹ˆç‰ˆæœ¬ï¼ŒåŠ è½½dexæµç¨‹ä¸­æœ€ç»ˆéƒ½ä¼šè°ƒç”¨DexFileçš„æ„é€ å‡½æ•°ï¼Œ<code>OpenMemory()</code>å‡½æ•°ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿”å›çš„è¿™ä¸ªcookieå…¶å®å°±æ˜¯DexFileçš„åœ°å€ï¼ï¼Ÿ</p></blockquote><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œé™¤äº†Android 8åŠä»¥ä¸Šç‰ˆæœ¬çš„ç³»ç»Ÿæ‹¥æœ‰ä¸€æ•´å¥—å†…å­˜dexåŠ è½½çš„æ–¹æ³•ï¼ˆå³æ‹¥æœ‰ç±»åŠ è½½å™¨InMemoryDexClassLoaderï¼‰ï¼Œå…¶ä»–ç‰ˆæœ¬å¹¶æ²¡æœ‰ç±»åŠ è½½å™¨ï¼Œå› æ­¤é¢ä¸´å†…å­˜dexä¸­ç±»åŠ è½½çš„é—®é¢˜ã€‚</p><h2 id="1-2-å¦‚ä½•è§£å†³å†…å­˜dexä¸­ç±»çš„åŠ è½½é—®é¢˜"><a href="#1-2-å¦‚ä½•è§£å†³å†…å­˜dexä¸­ç±»çš„åŠ è½½é—®é¢˜" class="headerlink" title="1.2 å¦‚ä½•è§£å†³å†…å­˜dexä¸­ç±»çš„åŠ è½½é—®é¢˜"></a>1.2 å¦‚ä½•è§£å†³å†…å­˜dexä¸­ç±»çš„åŠ è½½é—®é¢˜</h2><p>ç³»ç»Ÿç»™å®šçš„ç±»åŠ è½½å™¨DexClassLoaderå’ŒPathClassLoaderç±»åŠ è½½å™¨ï¼Œåœ¨åˆ›å»ºæ—¶åªæ¥å—æ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯åªæ¥å—æ–‡ä»¶ç³»ç»Ÿä¸­çš„dexç›¸å…³æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä½¿å…¶èƒ½å¤Ÿæ¥å—å†…å­˜dexã€‚è€Œåœ¨è¿™ä¹‹å‰ï¼Œéå¸¸æœ‰å¿…è¦æºç åˆ†æç±»çš„åŠ è½½è¿‡ç¨‹ï¼Œå…·ä½“åˆ†æè¯·è§<a href="https://gal2xy.github.io/2023/11/25/Android%E4%B8%AD%E7%9A%84ClassLoader/#%E5%9B%9B%E3%80%81ClassLoader%E5%8A%A0%E8%BD%BD%E7%B1%BB%E7%9A%84%E8%BF%87%E7%A8%8B">Androidä¸­çš„ClassLoader&#x2F;#å››ã€ClassLoaderåŠ è½½ç±»çš„è¿‡ç¨‹</a>ï¼ˆAndroid 8æºç ï¼‰ã€‚ç®€å•æ€»ç»“ä¸€ä¸‹è¯¥è¿‡ç¨‹ï¼š</p><p>ClassLoaderç±»çš„<code>loadClass()</code>æ–¹æ³• â†’ BaseDexClassLoaderç±»çš„<code>findClass()</code>æ–¹æ³• â†’ DexPathListç±»çš„<code>findClass()</code>æ–¹æ³• â†’ Elementç±»çš„<code>findClass()</code>æ–¹æ³• â†’ DexFileç±»çš„<code>loadClassBinaryName()</code>æ–¹æ³• â†’ DexFileç±»çš„<code>defineClass()</code>æ–¹æ³• â†’  DexFileç±»çš„<code>defineClassNative()</code>æ–¹æ³•</p><p>å¦‚æœä»”ç»†å»çœ‹æºç çš„è¯ï¼Œåº”è¯¥å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸­é—´çš„æ–¹æ³•ï¼ˆ3~6ï¼‰éƒ½åªæ˜¯ä½œä¸ºä¸€ä¸ªè·³æ¿è€Œå·²ï¼Œå¹¶æ²¡æœ‰åŠ è½½ç±»çš„ä»£ç å®ç°ï¼Œè€Œæ˜¯è°ƒç”¨åè€…æ–¹æ³•ã€‚å› æ­¤æˆ‘ä»¬åœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„æ—¶å€™ï¼Œå¯ä»¥è·³è¿‡ä¸­é—´è¿™äº›æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦é‡å†™BaseDexClassLoaderç±»çš„<code>findClass()</code>æ–¹æ³•ï¼Œä½¿å…¶èƒ½å¤Ÿç›´æ¥è°ƒç”¨<code>defineClassNative()</code>æ–¹æ³•ã€‚</p><p>é‚£ä¹ˆè¿™é‡Œåˆæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬æ€ä¹ˆè·å–åˆ°dexä¸­çš„ç±»åï¼Œè¿™æ ·æ‰èƒ½çŸ¥é“è¦åŠ è½½çš„ç±»æ˜¯ä¸æ˜¯dexä¸­çš„ï¼Œå¦‚æœæ˜¯ï¼Œæˆ‘ä»¬å°±è¦è°ƒç”¨<code>defineClassNative()</code>æ–¹æ³•æ¥è§£å†³ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±äº¤ç»™çˆ¶ç±»ã€‚ä¸è¿‡å¥½åœ¨<code>/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</code>ä¸­å°±æœ‰è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡cookieè·å–åˆ°dexä¸­çš„æ‰€æœ‰ç±»åï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String[] getClassNameList(Object cookie);<br></code></pre></td></tr></table></figure><p>è¿™æ ·ä¸€æ¥ï¼Œé—®é¢˜å°±éƒ½è§£å†³äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯å…·ä½“çš„å®ç°ç¯èŠ‚äº†ï¼</p><blockquote><p>ä»Android 7 å¼€å§‹ï¼Œ<code>defineClassNative(String name, ClassLoader loader, Object cookie)</code>å˜æˆäº†<code>defineClassNative(String name, ClassLoader loader, Object cookie, DexFile dexFile)</code>ï¼Œå¤šäº†ä¸€ä¸ªDexFileå‚æ•°ã€‚</p><p>è§£å†³æ–¹æ³•ï¼š</p><ol><li><p>ä¼ å…¥nullï¼ŒæŸ¥çœ‹å¯¹åº”æºç ï¼Œå¯ä»¥çŸ¥é“å°±æ˜¯å¤šäº†ä¸€æ­¥<code>class_linker-&gt;InsertDexFileInToClassLoader()</code>ï¼Œé¡¾åæ€ä¹‰ï¼Œåº”è¯¥æ˜¯å°†DexFileæ–‡ä»¶åŠ è½½åˆ°ç±»åŠ è½½å™¨ä¸­ï¼Œæ–¹ä¾¿ä¹‹ååŠ è½½ç±»ã€‚è€ŒåŠ è½½ç±»çš„è¿‡ç¨‹æˆ‘ä»¬è‡ªå·±å®ç°äº†ï¼Œåº”è¯¥ä¸ä¼šæœ‰é—®é¢˜çš„ã€‚</p></li><li><p>åˆšåˆšä¸Šä¸€å°èŠ‚è¯´è¿‡ï¼Œcookieè¿™ä¸ªå…¶å®å°±æ˜¯ä¸ªDexFileçš„é¦–åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªè·å–DexFileå¯¹è±¡ã€‚ï¼ˆå¼ºè½¬ï¼Ÿï¼‰</p></li></ol><p>ä¸ºä»€ä¹ˆè¯´cookieæ˜¯åœ°å€å‘¢ï¼Œè¯æ®å¦‚ä¸‹ï¼š</p><p><code>art/runtime/native/dalvik_system_DexFile.cc</code>ç›®å½•ä¸‹çš„<code>DexFile_defineClassNative</code>å‡½æ•°ï¼š</p><ul><li><p>Android 5.1 ï¼šç¬¬ä¸€è¡Œå°±æ˜¯è°ƒç”¨<code>toDexFiles(cookie, env)</code>å‡½æ•°è·å–DexFileå¯¹è±¡ï¼Œè€Œä¸”è¯¥æ–¹æ³•å®šä¹‰æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åä¸ºdex_file_addressã€‚</p></li><li><p>Android 6 ~ ï¼šç¬¬ä¸€è¡Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">`std::unique_ptr&lt;std::vector&lt;<span class="hljs-type">const</span> DexFile*&gt;&gt; dex_files = <span class="hljs-built_in">ConvertJavaArrayToNative</span>(env, cookie)`<br></code></pre></td></tr></table></figure><p>æ˜¯å§ï¼Œåˆæ˜¯é€šè¿‡cookieå¾—åˆ°DexFileå¯¹è±¡ï¼</p></li></ul><p>æ‰€ä»¥è¯´ï¼Œéå¸¸è‚¯å®šcookieå°±æ˜¯DexFileçš„é¦–åœ°å€</p></blockquote><h1 id="äºŒã€é¡¹ç›®"><a href="#äºŒã€é¡¹ç›®" class="headerlink" title="äºŒã€é¡¹ç›®"></a>äºŒã€é¡¹ç›®</h1><h2 id="2-1-ä½¿ç”¨ä¸€ç§æ–°çš„åŠ å£³æ–¹æ³•"><a href="#2-1-ä½¿ç”¨ä¸€ç§æ–°çš„åŠ å£³æ–¹æ³•" class="headerlink" title="2.1 ä½¿ç”¨ä¸€ç§æ–°çš„åŠ å£³æ–¹æ³•"></a>2.1 ä½¿ç”¨ä¸€ç§æ–°çš„åŠ å£³æ–¹æ³•</h2><p>åœ¨ç¼–å†™ç¬¬ä¸€ä»£å£³çš„æ—¶å€™ï¼Œæˆ‘æ˜¯ç”¨çš„æ˜¯åˆå¹¶æ–¹æ³•æ˜¯è„±å£³ç¨‹åºdex + æºæºç¨‹åºAPKå¹¶ä¸”ä»¥è„±å£³ç¨‹åºAPKä¸ºå¯„ä¸»ï¼Œä½†æˆ‘æ„Ÿè§‰è¿™æ ·åšç¼ºç‚¹å¾ˆå¤§ã€‚å› ä¸ºæºç¨‹åºå¯èƒ½ä¼šä½¿ç”¨åˆ°èµ„æºæ–‡ä»¶ï¼Œå°±éœ€è¦è¿›è¡Œèµ„æºæ›¿æ¢äº†ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬åº”è¯¥æ³¨æ„åˆ°ï¼Œè„±å£³ç¨‹åºå¹¶ä¸éœ€è¦ç”¨æˆ·ç•Œé¢ï¼Œç†åº”ä¹Ÿä¸éœ€è¦åŠ è½½èµ„æºæ–‡ä»¶ï¼Œåªéœ€è¦dexä¸­çš„ä»£ç é€»è¾‘ï¼Œä»¥åŠåœ¨è„±å£³ç¨‹åºAPKï¼ˆå¯„ä¸»ï¼‰çš„<code>AndroidManifest.xml</code>ä¸­å£°æ˜Applicationä»£ç†ç±»ã€‚é‚£ä¹ˆæˆ‘ä»¬åŠ å£³çš„æ–¹æ³•å¯ä»¥æ”¹æˆè¿™æ ·ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312101629323.png"></p><p>ä¹‹å‰æ€ä¹ˆæ”¹è„±å£³ç¨‹åºçš„<code>AndroidManifest.xml</code>å°±æ€ä¹ˆæ”¹æºç¨‹åºçš„<code>AndroidManifest.xml</code>ï¼Œå…¶å®å°±æ˜¯ç›¸å½“äºæ¢äº†ä¸ªå¯„ä¸»è€Œå·²ã€‚</p><h2 id="Android-8åŠä»¥ä¸Š"><a href="#Android-8åŠä»¥ä¸Š" class="headerlink" title="Android 8åŠä»¥ä¸Š"></a>Android 8åŠä»¥ä¸Š</h2><p>Android 8åŠä»¥ä¸Šçš„ç³»ç»Ÿç¯å¢ƒä¸­ï¼Œéå¸¸å¥½å®ç°ä¸è½åœ°åŠ è½½å£³ï¼Œå› ä¸ºç³»ç»Ÿç›´æ¥æä¾›äº†ç›¸åº”çš„å†…å­˜dexåŠ è½½å™¨InMemoryDexClassLoaderï¼Œå› æ­¤åœ¨ç¬¬ä¸€ä»£å£³åŸºç¡€ä¸Šï¼Œåªéœ€è¦åœ¨æ›¿æ¢ç±»åŠ è½½å™¨çš„è¿‡ç¨‹ä¸­ï¼Œä¿®æ”¹åˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨çš„æ–¹å¼å³å¯ã€‚</p><h3 id="æºç¨‹åº"><a href="#æºç¨‹åº" class="headerlink" title="æºç¨‹åº"></a>æºç¨‹åº</h3><p>è·Ÿä¹‹å‰çš„ä¸€æ ·ï¼Œåªä¸è¿‡ä¹‹å‰æ”¹çš„æ˜¯è„±å£³APKä¸­çš„AndroidMainfest.xmlæ–‡ä»¶ï¼Œè€Œç°åœ¨æ”¹çš„æ˜¯æºç¨‹åºAPKçš„AndroidMainfest.xmlæ–‡ä»¶ï¼Œä½†å†…å®¹ä¸å˜ã€‚</p><h3 id="åŠ å£³ç¨‹åº"><a href="#åŠ å£³ç¨‹åº" class="headerlink" title="åŠ å£³ç¨‹åº"></a>åŠ å£³ç¨‹åº</h3><p>å› ä¸ºæ¶‰åŠåˆ°æºç¨‹åºå¤šdexçš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦å¯¹ä»£ç è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿå‡å°‘äº†ä¸€äº›æ‰‹åŠ¨æ“ä½œï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> zlib <span class="hljs-keyword">import</span> adler32<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha1<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> unhexlify<br><span class="hljs-keyword">import</span> zipfile<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixCheckSum</span>(<span class="hljs-params">dexBytesArray</span>):<br>    <span class="hljs-comment"># dexfile[8:12]</span><br>    <span class="hljs-comment"># å°ç«¯å­˜å‚¨</span><br>    value = adler32(<span class="hljs-built_in">bytes</span>(dexBytesArray[<span class="hljs-number">12</span>:]))<br>    valueArray = <span class="hljs-built_in">bytearray</span>(value.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(valueArray)):<br>        dexBytesArray[<span class="hljs-number">8</span> + i] = valueArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixSignature</span>(<span class="hljs-params">dexBytesArray</span>):<br>    <span class="hljs-comment"># dexfile[12:32]</span><br>    sha_1 = sha1()<br>    sha_1.update(<span class="hljs-built_in">bytes</span>(dexBytesArray[<span class="hljs-number">32</span>:]))<br>    value = sha_1.hexdigest()<br>    valueArray = <span class="hljs-built_in">bytearray</span>(unhexlify(value))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(valueArray)):<br>        dexBytesArray[<span class="hljs-number">12</span> + i] = valueArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixFileSize</span>(<span class="hljs-params">dexBytesArray, fileSize</span>):<br>    <span class="hljs-comment"># dexfile[32:36]</span><br>    <span class="hljs-comment"># å°ç«¯å­˜å‚¨</span><br>    fileSizeArray = <span class="hljs-built_in">bytearray</span>(fileSize.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;little&quot;</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(fileSizeArray)):<br>        dexBytesArray[<span class="hljs-number">32</span> + i] = fileSizeArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypto</span>(<span class="hljs-params">file</span>):<br>    <span class="hljs-comment"># for i in range(len(file)):</span><br>    <span class="hljs-comment">#     file[i] ^= 0xff</span><br>    <span class="hljs-keyword">return</span> file<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">readDexsSourceApk</span>(<span class="hljs-params">sourceApkPath</span>):<br>    dexList = []<br>    <span class="hljs-keyword">with</span> zipfile.ZipFile(sourceApkPath, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> sourceApk:<br>        <span class="hljs-comment"># è·å–apkä¸­æ‰€æœ‰çš„æ–‡ä»¶è·¯å¾„åç§°</span><br>        nameList = sourceApk.namelist()<br>        <span class="hljs-keyword">for</span> fileName <span class="hljs-keyword">in</span> nameList:<br>            <span class="hljs-comment"># æå–dexæ–‡ä»¶</span><br>            <span class="hljs-keyword">if</span> fileName.endswith(<span class="hljs-string">&quot;.dex&quot;</span>):<br>                <span class="hljs-comment"># è§£å‹ç¼©åˆ°å½“å‰ç›®å½•ä¸‹ sourceApk.extract(fileName)</span><br>                <span class="hljs-comment"># å»ºè®®ç›´æ¥è¯»å–</span><br>                <span class="hljs-keyword">with</span> sourceApk.<span class="hljs-built_in">open</span>(fileName) <span class="hljs-keyword">as</span> dexfile:<br>                    data = <span class="hljs-built_in">bytearray</span>(dexfile.read())<br>                    dexList.append(data)<br>    <span class="hljs-keyword">return</span> dexList<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">readDexFromShellApk</span>(<span class="hljs-params">shellApkPath</span>):<br>    <span class="hljs-keyword">with</span> zipfile.ZipFile(shellApkPath, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> sourceApk:<br>        <span class="hljs-comment"># è·å–apkä¸­æ‰€æœ‰çš„æ–‡ä»¶è·¯å¾„åç§°</span><br>        nameList = sourceApk.namelist()<br>        <span class="hljs-keyword">for</span> fileName <span class="hljs-keyword">in</span> nameList:<br>            <span class="hljs-comment"># æå–dexæ–‡ä»¶</span><br>            <span class="hljs-keyword">if</span> fileName.endswith(<span class="hljs-string">&quot;.dex&quot;</span>):<br>                <span class="hljs-comment"># å»ºè®®ç›´æ¥è¯»å–</span><br>                <span class="hljs-keyword">with</span> sourceApk.<span class="hljs-built_in">open</span>(fileName) <span class="hljs-keyword">as</span> dexfile:<br>                    data = <span class="hljs-built_in">bytearray</span>(dexfile.read())<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">combineSourceDexs</span>(<span class="hljs-params">sourceDexList</span>):<br>    combinedDex = <span class="hljs-built_in">bytearray</span>()<br>    <span class="hljs-keyword">for</span> dexfile <span class="hljs-keyword">in</span> sourceDexList:<br>        dexfileLen = <span class="hljs-built_in">len</span>(dexfile)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(dexfileLen))<br>        <span class="hljs-comment"># é¦–å…ˆå­˜æ”¾å½“å‰dexçš„å¤§å°ï¼Œå››å­—èŠ‚ï¼Œå°ç«¯å­˜å‚¨</span><br>        combinedDex += <span class="hljs-built_in">bytearray</span>(dexfileLen.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>        <span class="hljs-comment"># ç„¶åå­˜æ”¾å½“å‰dex</span><br>        combinedDex += dexfile<br>    <span class="hljs-keyword">return</span> combinedDex<br><span class="hljs-comment"># å¾…å®ç°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">forkShellLibIntoSourceApk</span>():<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    sourceApkPath = <span class="hljs-string">&quot;sourceApk.apk&quot;</span><br>    shellApkPath = <span class="hljs-string">&quot;shellApk.apk&quot;</span><br>    newApkPath = <span class="hljs-string">&quot;newApk.apk&quot;</span><br>    <span class="hljs-comment"># è¯»å–æºAPKä¸­çš„dexæ–‡ä»¶,å¯ä»¥æ¥å—å¤šdex</span><br>    sourceDexList = readDexsSourceApk(sourceApkPath)<br>    <span class="hljs-comment"># è¯»å–å£³ç¨‹åºdex,åªèƒ½æœ‰ä¸€ä¸ªdex</span><br>    shellDex = readDexFromShellApk(shellApkPath)<br>    <span class="hljs-comment"># åˆå¹¶æºç¨‹åºdex</span><br>    combineSourceDex = combineSourceDexs(sourceDexList)<br>    <span class="hljs-comment"># åŠ å¯†æºç¨‹åºdex</span><br>    encSourceDex = encrypto(combineSourceDex)<br>    encSourceDexLen = <span class="hljs-built_in">len</span>(encSourceDex)<br>    <span class="hljs-comment"># æ–°çš„dexæ–‡ä»¶å†…å®¹ = å£³dex + åŠ å¯†çš„æºdex + å››å­—èŠ‚æ ‡è¯†åŠ å¯†åæºdexå¤§å°é•¿åº¦</span><br>    newDex = shellDex + encSourceDex + <span class="hljs-built_in">bytearray</span>(encSourceDexLen.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>    newDexLen = <span class="hljs-built_in">len</span>(newDex)<br>    <span class="hljs-comment"># é¦–å…ˆä¿®æ”¹filesize</span><br>    fixFileSize(newDex, newDexLen)<br>    <span class="hljs-comment"># å…¶æ¬¡ä¿®æ”¹signature</span><br>    fixSignature(newDex)<br>    <span class="hljs-comment"># æœ€åä¿®æ”¹checksum</span><br>    fixCheckSum(newDex)<br>    <br>    <span class="hljs-comment"># æœ¬æƒ³ç”¨ä»£ç å®ç°æ›¿æ¢apkä¸­çš„dexï¼ˆå…ˆåˆ é™¤å†å†™å…¥ï¼‰ï¼Œä½†zipfileåº“æ²¡æœ‰ç°æˆçš„æ–¹æ³•ï¼Œè¿˜æ˜¯ç®—äº†</span><br>    <span class="hljs-comment"># å¯¼å‡ºæˆæ–°çš„dexæ–‡ä»¶</span><br>    <br>    <span class="hljs-comment"># å…¶å®è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯éœ€è¦æŠŠè„±å£³APKä¸­çš„libåº“å¤åˆ¶è¿‡æ¥ï¼</span><br>    <span class="hljs-comment"># å¾…å®ç°ï¼ˆè§£å‹ç¼©ï¼Œæ›¿æ¢ï¼Œå†å‹ç¼©ï¼Ÿï¼Ÿï¼Ÿï¼‰</span><br>    <span class="hljs-comment"># forkShellLibIntoSourceApk()</span><br>    <br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;classes.dex&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(<span class="hljs-built_in">bytes</span>(newDex))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    start()<br></code></pre></td></tr></table></figure><p>å¯¹äºæºç¨‹åºå¤šdexçš„æƒ…å†µï¼Œå…ˆå°†åˆå¹¶æºç¨‹åºçš„dexä¸ºå•ç‹¬ä¸€ä¸ªdexï¼Œä¹‹åçš„æ“ä½œå°±è·Ÿä¹‹å‰çš„ä¸€æ ·ã€‚</p><h3 id="è„±å£³ç¨‹åº"><a href="#è„±å£³ç¨‹åº" class="headerlink" title="è„±å£³ç¨‹åº"></a>è„±å£³ç¨‹åº</h3><p>RefInvokeç±»æ˜¯æˆ‘ä¹‹å‰å°è£…å¥½çš„åå°„ç±»ï¼Œè¯¦ç»†è§Githubä»“åº“ï¼š<a href="https://github.com/gal2xy/RefInvoke%E3%80%82">https://github.com/gal2xy/RefInvokeã€‚</a></p><h4 id="attachBaseContext"><a href="#attachBaseContext" class="headerlink" title="attachBaseContext()"></a>attachBaseContext()</h4><p>é¦–å…ˆå±•ç¤ºä»¥ä¸‹ä»£ç†Applicationç±»ä¸­çš„<code>attachBaseContext()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachBaseContext</span><span class="hljs-params">(Context base)</span> &#123;<br>    <span class="hljs-built_in">super</span>.attachBaseContext(base);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//è¯»å–Classes.dexæ–‡ä»¶</span><br>        <span class="hljs-type">byte</span>[] shellDexData = readDexFromApk();<br>        Log.d(TAG, <span class="hljs-string">&quot;æˆåŠŸä»æºAPKä¸­è¯»å–classes.dex&quot;</span>);<br>        <span class="hljs-comment">//ä»ä¸­åˆ†ç†å‡ºæºdexæ–‡ä»¶</span><br>        ByteBuffer[] byteBuffers = splitSourceApkFromShellDex(shellDexData);<br>        Log.d(TAG, <span class="hljs-string">&quot;æˆåŠŸåˆ†ç¦»å‡ºæºdexé›†åˆ&quot;</span>);<br>        <span class="hljs-comment">//é…ç½®åŠ è½½æºç¨‹åºçš„åŠ¨æ€ç¯å¢ƒ,å³æ›¿æ¢mClassLoader</span><br>        replaceClassLoaderInLoadedApk(byteBuffers);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        Log.d(TAG, Log.getStackTraceString(e));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><code>readDexFromApk()</code>æ–¹æ³•è·Ÿä¹‹å‰ä¸€ä»£å£³ä¸­ä½¿ç”¨çš„æ–¹æ³•ä¸€æ ·ï¼Œè¿™é‡Œä¸å†å±•ç¤ºã€‚</p><p>ç”±äºæˆ‘ä»¬çš„ç›®æ ‡æ˜¯é€‚é…å¤šdexçš„æƒ…å†µï¼Œæ‰€ä»¥<code>splitSourceApkFromShellDex()</code>æ–¹æ³•éœ€è¦ä¿®æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">private</span> ByteBuffer[] splitSourceApkFromShellDex(<span class="hljs-type">byte</span>[] shellDexData) <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">shellDexlength</span> <span class="hljs-operator">=</span> shellDexData.length;<br>    <span class="hljs-comment">//å¼€å§‹è§£ædexæ–‡ä»¶</span><br>    <span class="hljs-type">byte</span>[] sourceDexsSizeByte = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];<br>    <span class="hljs-comment">//è¯»å–æºdexsçš„å¤§å°</span><br>    System.arraycopy(shellDexData,shellDexlength - <span class="hljs-number">4</span>, sourceDexsSizeByte,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>);<br>    <span class="hljs-comment">//è½¬æˆbytebuffer,æ–¹ä¾¿4byteè½¬int</span><br>    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">wrap</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(sourceDexsSizeByte);<br>    <span class="hljs-comment">//å°†byteè½¬æˆint, åŠ å£³æ—¶,é•¿åº¦æˆ‘æ˜¯æŒ‰å°ç«¯å­˜å‚¨çš„</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">sourceDexsSizeInt</span> <span class="hljs-operator">=</span> wrap.order(ByteOrder.LITTLE_ENDIAN).getInt();<br>    Log.d(TAG, <span class="hljs-string">&quot;æºdexé›†åˆçš„å¤§å°: &quot;</span> + sourceDexsSizeInt);<br>    <span class="hljs-comment">//è¯»å–æºdexs</span><br>    <span class="hljs-type">byte</span>[] sourceDexsData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[sourceDexsSizeInt];<br>    System.arraycopy(shellDexData,shellDexlength - sourceDexsSizeInt - <span class="hljs-number">4</span>, sourceDexsData, <span class="hljs-number">0</span>, sourceDexsSizeInt);<br>    <span class="hljs-comment">//è§£å¯†æºdexs</span><br>    sourceDexsData = decryptoSourceApk(sourceDexsData);<br><br>    <span class="hljs-comment">//æ›´æ–°éƒ¨åˆ†</span><br>    <span class="hljs-comment">//ä»æºdexsä¸­åˆ†ç¦»dex</span><br>    ArrayList&lt;<span class="hljs-type">byte</span>[]&gt; sourceDexList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(pos &lt; sourceDexsSizeInt)&#123;<br>        <span class="hljs-comment">//å…ˆæå–å››ä¸ªå­—èŠ‚ï¼Œæè¿°å½“å‰dexçš„å¤§å°</span><br>        <span class="hljs-comment">//å¼€å§‹è§£ædexæ–‡ä»¶</span><br>        <span class="hljs-type">byte</span>[] singleDexSizeByte = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];<br>        <span class="hljs-comment">//è¯»å–æºdexsçš„å¤§å°</span><br>        System.arraycopy(sourceDexsData, pos, singleDexSizeByte,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>);<br>        <span class="hljs-comment">//è½¬æˆbytebuffer,æ–¹ä¾¿4byteè½¬int</span><br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">singleDexwrap</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(singleDexSizeByte);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">singleDexSizeInt</span> <span class="hljs-operator">=</span> singleDexwrap.order(ByteOrder.LITTLE_ENDIAN).getInt();<br>        Log.d(TAG, <span class="hljs-string">&quot;å½“å‰singleDexçš„å¤§å°: &quot;</span> + singleDexSizeInt);<br>        <span class="hljs-comment">//è¯»å–å•ç‹¬dex</span><br>        <span class="hljs-type">byte</span>[] singleDexData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[singleDexSizeInt];<br>        System.arraycopy(sourceDexsData,pos + <span class="hljs-number">4</span>, singleDexData, <span class="hljs-number">0</span>, singleDexSizeInt);<br>        <span class="hljs-comment">//åŠ å…¥åˆ°dexlistä¸­</span><br>        sourceDexList.add(singleDexData);<br>        <span class="hljs-comment">//æ›´æ–°pos</span><br>        pos += <span class="hljs-number">4</span> + singleDexSizeInt;<br>    &#125;<br><br>    <span class="hljs-comment">//å°†dexliståŒ…è£…æˆByteBuffer</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">dexNum</span> <span class="hljs-operator">=</span> sourceDexList.size();<br>    Log.d(TAG, <span class="hljs-string">&quot;æºdexçš„æ•°é‡: &quot;</span> + dexNum);<br>    ByteBuffer[] dexBuffers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuffer</span>[dexNum];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; dexNum; i++)&#123;<br>        dexBuffers[i] = ByteBuffer.wrap(sourceDexList.get(i));<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dexBuffers;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¤šäº†å°†æºdexé›†åˆåˆ†ç¦»å¼€æ¥ï¼Œå¹¶å°†å®ƒä»¬å°è£…æˆByteBufferã€‚</p><p><code>replaceClassLoaderInLoadedApk()</code>æ–¹æ³•å¤§å·®ä¸å·®ï¼Œåªä¸è¿‡æ˜¯å°†ç±»åŠ è½½å™¨æ¢æˆInMemoryDexClassLoaderè€Œå·²ï¼Œå½“ç„¶ï¼Œåœ¨ä»£ç ä¸­ï¼Œæˆ‘æ²¡æœ‰é€šè¿‡ActivityThreadå®ä¾‹ä¸­çš„mPackagesè·å–LoadedApkå®ä¾‹ï¼Œè€Œæ˜¯é€šè¿‡ActivityThreadå®ä¾‹ä¸­çš„mBoundApplicationè·å–ï¼Œè¯¦ç»†åŸå› è§<a href="https://gal2xy.github.io/2023/12/02/%E5%85%B3%E4%BA%8E%E4%B8%80%E4%BB%A3%E5%A3%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/">å…³äºä¸€ä»£å£³çš„ä¸€äº›ç†è§£</a>ã€‚</p><h4 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate()"></a>onCreate()</h4><p>æ¥ä¸‹æ¥æ˜¯ä»£ç†Applicationç±»ä¸­çš„<code>onCreate()</code>æ–¹æ³•ï¼Œè¯¥éƒ¨åˆ†å¤„ç†çš„æ˜¯Applicationå®ä¾‹çš„æ›¿æ¢ï¼Œåšæ³•è·Ÿä¸€ä»£å£³çš„åšæ³•ä¸€æ ·ï¼Œåªä¸è¿‡åœ¨è¿™é‡Œæˆ‘å°è£…äº†ä¸€ä¸‹ï¼Œå…·ä½“ä»£ç å°±ä¸å±•ç¤ºäº†ï¼Œç›´æ¥å»ä»“åº“çœ‹ä»£ç å°±è¡Œäº†.</p><h2 id="Android-8ä»¥ä¸‹-ARTç¯å¢ƒä¸‹"><a href="#Android-8ä»¥ä¸‹-ARTç¯å¢ƒä¸‹" class="headerlink" title="Android 8ä»¥ä¸‹ (ARTç¯å¢ƒä¸‹)"></a>Android 8ä»¥ä¸‹ (ARTç¯å¢ƒä¸‹)</h2><p>è¿™ä¸­ç¯å¢ƒä¸‹è¿˜æ˜¯æŒºéš¾çš„ï¼Œå› ä¸ºæ²¡æœ‰ä¸€å¥—ç”¨äºåŠ è½½å†…å­˜dexçš„ç±»åŠ è½½å™¨ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å»å®ç°ï¼Œé‚£ä¹ˆä¹Ÿå°±é¢ä¸´ç±»åŠ è½½å™¨çš„å®ç°å’Œå†…å­˜dexåŠ è½½å®ç°ã€‚è¯¥å°èŠ‚ä¸»è¦å±•ç¤ºè¿™ä¸¤éƒ¨åˆ†çš„ä»£ç ã€‚</p><h3 id="ç±»åŠ è½½å™¨çš„å®ç°"><a href="#ç±»åŠ è½½å™¨çš„å®ç°" class="headerlink" title="ç±»åŠ è½½å™¨çš„å®ç°"></a>ç±»åŠ è½½å™¨çš„å®ç°</h3><p>ç”±äº<code>defineNative()</code>å’Œ<code>getClassNameList()</code>çš„å‚æ•°åœ¨ä¸€äº›ç‰ˆæœ¬ä¸­æœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­ä¸€ä¸‹è®¾å¤‡çš„SDKç‰ˆæœ¬ï¼Œæ ¹æ®ä¸åŒç‰ˆæœ¬ç¼–å†™ç›¸åº”çš„åå°„è°ƒç”¨ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DexClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;demo&quot;</span>;<br>    <span class="hljs-keyword">private</span> ArrayList&lt;Object&gt; cookieArray;<br>    <span class="hljs-keyword">private</span> Context mContext;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.loadLibrary(<span class="hljs-string">&quot;androidsecondshell2&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//nativeå±‚é€šè¿‡è°ƒç”¨libart.soä¸­çš„openMemoryå‡½æ•°åŠ è½½dex</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Object <span class="hljs-title function_">OpenMemory</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] dex, <span class="hljs-type">long</span> dexlen, <span class="hljs-type">int</span> sdkInt)</span>;<br><br>    <span class="hljs-comment">/*æ„é€ å‡½æ•°</span><br><span class="hljs-comment">    * librarySearchPathã€dexPathã€optimizedDirectoryä¼ å…¥ä¸ºnullå°±è¡Œï¼Œ</span><br><span class="hljs-comment">    * åä¸¤è€…ä¸éœ€è¦è§£é‡Šï¼ˆéƒ½åŠ è½½å†…å­˜dexï¼Œè¿™ä¸¤å‚æ•°å°±æ²¡å•¥ç”¨ï¼‰</span><br><span class="hljs-comment">    * librarySearchPathåœ¨çˆ¶ç±»åŠ è½½å™¨ä¸­åŠ è½½è¿‡ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—å¯ä»¥ä¸ºnull</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyClassLoader</span><span class="hljs-params">(Context context, ByteBuffer[] dexBuffers, String librarySearchPath,</span><br><span class="hljs-params">                         ClassLoader parent, String dexPath, String optimizedDirectory)</span>&#123;<br>        <span class="hljs-built_in">super</span>(dexPath, optimizedDirectory, librarySearchPath, parent);<br>        setContext(context);<br><br>        <span class="hljs-comment">//åå°„è°ƒç”¨openMemoryæ–¹æ³•åŠ è½½å¤šä¸ªdex</span><br>        <span class="hljs-keyword">for</span>(ByteBuffer dexbuffer : dexBuffers)&#123;<br>            <span class="hljs-comment">//è·å–é•¿åº¦</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">dexlen</span> <span class="hljs-operator">=</span> dexbuffer.limit() - dexbuffer.position();<br>            Log.d(TAG, <span class="hljs-string">&quot;dexbuffer.capacity(): &quot;</span> + dexlen);<br>            <span class="hljs-type">byte</span>[] dex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[dexlen];<br>            <span class="hljs-comment">//è½¬byte[]</span><br>            dexbuffer.get(dex);<br>            Log.d(TAG, <span class="hljs-string">&quot;dexå‰3ä¸ªå­—èŠ‚: &quot;</span> + dex[<span class="hljs-number">0</span>] + dex[<span class="hljs-number">1</span>] + dex[<span class="hljs-number">2</span>]);<br>            <span class="hljs-comment">//è°ƒç”¨nativeå±‚æ–¹æ³•, OpenMemoryè¿”å›çš„æ˜¯DexFileå¯¹è±¡ï¼Œè¿™æ˜¯ä¸æ˜¯è¯´æ˜cookieå…¶å®å°±æ˜¯DexFileçš„åœ°å€ï¼Ÿå°¤å…¶æ˜¯å¯¹intå‹çš„cookieæ¥è¯´</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> OpenMemory(dex, dexlen, Build.VERSION.SDK_INT);<br>            <span class="hljs-comment">//åŠ å…¥åˆ°cookieArrayæ•°ç»„ä¸­</span><br>            addIntoCookieArray(cookie);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//é‡å†™findClassæ–¹æ³•</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <br>        Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">//è·å–Dexä¸­çš„æ‰€æœ‰ç±»ï¼Œæ”¯æŒå¤šdex</span><br>        ArrayList&lt;String[]&gt; classNameList = getClassNameList(<span class="hljs-built_in">this</span>.cookieArray);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">classNameNum</span> <span class="hljs-operator">=</span> classNameList.size();<br>        Log.d(TAG, <span class="hljs-string">&quot;dex num: &quot;</span> + classNameNum);<br>        <span class="hljs-comment">//éå†æ¯ä¸ªdexè·å–classNameList</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">cookiePos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; cookiePos &lt; classNameNum; cookiePos++)&#123;<br>            String[] singleClassNameList = classNameList.get(cookiePos);<br>            <span class="hljs-comment">//éå†æ¯ä¸ªdexä¸­çš„classNameListï¼Œè·å–className</span><br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">classPos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; classPos &lt; singleClassNameList.length; classPos++)&#123;<br>                Log.d(TAG, <span class="hljs-string">&quot;className: &quot;</span> + singleClassNameList[classPos]);<br>                <span class="hljs-comment">//å¦‚æœæ‰¾åˆ°äº†éœ€è¦åŠ è½½çš„ç±»</span><br>                <span class="hljs-keyword">if</span> (singleClassNameList[classPos].equals(name))&#123;<br>                    clazz = defineClassNative(<br>                            name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>),<br>                            <span class="hljs-built_in">this</span>.mContext.getClassLoader(),<br>                            <span class="hljs-built_in">this</span>.cookieArray.get(cookiePos)<br>                    );<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//è¿™ä¸€æ­¥å­˜ç–‘ï¼Œéƒ½ä¸æ˜¯è¦åŠ è½½çš„ç±»ä¸ºä»€ä¹ˆè¿˜æœ‰åŠ è½½ï¼Ÿï¼Ÿï¼Ÿ</span><br>                    clazz = defineClassNative(<br>                            singleClassNameList[classPos].replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>),<br>                            <span class="hljs-built_in">this</span>.mContext.getClassLoader(),<br>                            <span class="hljs-built_in">this</span>.cookieArray.get(cookiePos)<br>                    );<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-built_in">super</span>.findClass(name);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-comment">//å…¶å®å¹¶ä¸éœ€è¦æ”¹å†™ï¼Œå°±æ˜¯æ·»åŠ å‡ ä¸ªæ—¥å¿—è¯­å¥</span><br>        Log.d(TAG, <span class="hljs-string">&quot;loadClass: &quot;</span> + name + <span class="hljs-string">&quot;resolve: &quot;</span> + resolve);<br>        Class&lt;?&gt; clazz = <span class="hljs-built_in">super</span>.loadClass(name, resolve);<br>        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>)&#123;<br>            Log.e(TAG, <span class="hljs-string">&quot;loadClass failed&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br><br>    <span class="hljs-comment">//åå°„è°ƒç”¨defineNativeæ–¹æ³•åŠ è½½ç±»</span><br>    <span class="hljs-keyword">private</span> Class <span class="hljs-title function_">defineClassNative</span><span class="hljs-params">(String name, ClassLoader loader, Object cookie)</span> &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        * Android5~6çš„defineClassNativeæ²¡æœ‰DexFileå‚æ•°</span><br><span class="hljs-comment">        * Android7~ çš„defineClassNativeå¤šäº†DexFileå‚æ•°</span><br><span class="hljs-comment">        * */</span><br>        Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-comment">//ç³»ç»ŸAPIåˆ¤æ–­</span><br>        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="hljs-number">23</span>)&#123;<br>            <span class="hljs-comment">// ~ Android5</span><br>            clazz = (Class) RefInvoke.invokeMethod(<br>                    <span class="hljs-string">&quot;dalvik.system.DexFile&quot;</span>,<br>                    <span class="hljs-string">&quot;defineClassNative&quot;</span>,<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, ClassLoader.class, <span class="hljs-type">long</span>.class&#125;,<br>                    <span class="hljs-literal">null</span>,<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;name, loader, (<span class="hljs-type">long</span>) cookie&#125;<br>            );<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT == <span class="hljs-number">23</span>)&#123;<br>            <span class="hljs-comment">//Android 6</span><br>            clazz = (Class) RefInvoke.invokeMethod(<br>                    <span class="hljs-string">&quot;dalvik.system.DexFile&quot;</span>,<br>                    <span class="hljs-string">&quot;defineClassNative&quot;</span>,<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, ClassLoader.class, Object.class&#125;,<br>                    <span class="hljs-literal">null</span>,<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;name, loader, cookie&#125;<br>            );<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//Android 7 ~</span><br>            clazz = (Class) RefInvoke.invokeMethod(<br>                    <span class="hljs-string">&quot;dalvik.system.DexFile&quot;</span>,<br>                    <span class="hljs-string">&quot;defineClassNative&quot;</span>,<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, ClassLoader.class, Object.class, DexFile.class&#125;,<br>                    <span class="hljs-literal">null</span>,<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;name, loader, cookie, <span class="hljs-literal">null</span>&#125; <span class="hljs-comment">/*è®¾ç½®ä¸ºç©ºåº”è¯¥æ²¡é—®é¢˜å§ï¼Œåæ­£ä¹Ÿä¸ä¼šç”¨åˆ°ç±»åŠ è½½å™¨*/</span><br>            );<br>        &#125;<br>        <span class="hljs-keyword">return</span> clazz;<br><br>    &#125;<br>    <span class="hljs-comment">//è·å–dexä¸­çš„ç±»åé›†åˆ</span><br>    <span class="hljs-keyword">private</span> ArrayList&lt;String[]&gt; getClassNameList(ArrayList&lt;Object&gt; cookieArray) &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * æ³¨æ„ï¼ï¼ï¼Android5 ä¸­æ˜¯longç±»å‹çš„cookieï¼ŒAndroid6ã€7æ˜¯Objectç±»å‹çš„cookie</span><br><span class="hljs-comment">         * */</span><br>        ArrayList&lt;String[]&gt; classNameList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String[]&gt;();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">cookieNum</span> <span class="hljs-operator">=</span> cookieArray.size();<br><br>        <span class="hljs-comment">//ç³»ç»ŸAPIåˆ¤æ–­</span><br>        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="hljs-number">23</span>)&#123;<br>            <span class="hljs-comment">// ~ Android 5</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; cookieNum; i++)&#123;<br>                String[] singleDexClassNameList = (String[]) RefInvoke.invokeMethod(<br>                        <span class="hljs-string">&quot;dalvik.system.DexFile&quot;</span>,<br>                        <span class="hljs-string">&quot;getClassNameList&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">long</span>.class&#125;,<br>                        <span class="hljs-literal">null</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;(<span class="hljs-type">long</span>)cookieArray.get(i)&#125;<br>                );<br>                classNameList.add(singleDexClassNameList);<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">// Android 6 ~</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; cookieNum; i++)&#123;<br>                String[] singleDexClassNameList = (String[]) RefInvoke.invokeMethod(<br>                        <span class="hljs-string">&quot;dalvik.system.DexFile&quot;</span>,<br>                        <span class="hljs-string">&quot;getClassNameList&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class&#125;,<br>                        <span class="hljs-literal">null</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;cookieArray.get(i)&#125;<br>                );<br>                classNameList.add(singleDexClassNameList);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> classNameList;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContext</span><span class="hljs-params">(Context context)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mContext = context;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addIntoCookieArray</span><span class="hljs-params">(Object cookie)</span>&#123;<br>        <span class="hljs-built_in">this</span>.cookieArray.add(cookie);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å†…å­˜dexåŠ è½½å®ç°-Nativeå±‚"><a href="#å†…å­˜dexåŠ è½½å®ç°-Nativeå±‚" class="headerlink" title="å†…å­˜dexåŠ è½½å®ç°(Nativeå±‚)"></a>å†…å­˜dexåŠ è½½å®ç°(Nativeå±‚)</h3><p>å¤§éƒ¨åˆ†éƒ½æ˜¯å‚è€ƒ<a href="https://github.com/Frezrik/Jiagu">Frezrik&#x2F;Jiagu: Android apk jiagu (github.com)</a>çš„ã€‚</p><p>ä½¿ç”¨libart.soä¸­çš„<code>openMemory</code>æ–¹æ³•éœ€è¦ä½¿ç”¨åˆ°ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼š</p><ol><li><code>dlopen()</code>ï¼šdlopenå‡½æ•°ä»¥æŒ‡å®šæ¨¡å¼æ‰“å¼€æŒ‡å®šçš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¥æŸ„ä¾›<code>dlsym()</code>ä½¿ç”¨ã€‚</li><li><code>dlsym()</code>ï¼šæ ¹æ®åŠ¨æ€é“¾æ¥åº“æ“ä½œå¥æŸ„ä¸ç¬¦å·ï¼Œè¿”å›ç¬¦å·å¯¹åº”çš„åœ°å€ã€‚ä½¿ç”¨è¿™ä¸ªå‡½æ•°ä¸ä½†å¯ä»¥è·å–å‡½æ•°åœ°å€ï¼Œä¹Ÿå¯ä»¥è·å–å˜é‡åœ°å€ã€‚</li></ol><p><code>dlsym()</code>ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æ˜¯<code>JNINativeMethod</code>æˆ–<code>DalvikNativeMethod </code>ç»“æ„ä½“ï¼ˆå­˜æ”¾Native æ–¹æ³•ä¸ JNI å±‚å‡½æ•°çš„å¯¹åº”å…³ç³»ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å‡½æ•°åœ¨å†…å­˜ä¸­çš„æ–¹æ³•åã€‚ç”±äº<code>openMemory</code>æ–¹æ³•æ‰€åœ¨çš„<code>/art/runtime/dex_file.cc</code>ä¸­å¹¶æ²¡æœ‰è¿™ç§ç»“æ„ä½“ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚è‡³äºæ€ä¹ˆè·å–å‡½æ•°åœ¨å†…å­˜ä¸­çš„æ–¹æ³•åï¼Œå¯ä»¥å‚è€ƒ<a href="https://blog.csdn.net/qq409732112/article/details/109391210">hookåŠ è½½libart.soä¸­çš„OpenMemoryå‡½æ•°</a>ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯IDAæ‰“å¼€<code>libart.so</code>æ–‡ä»¶ï¼Œæ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ï¼Œå³é”®<code>Edit function</code>å°±å¯ä»¥çŸ¥é“äº†ã€‚</p><blockquote><p>ä¸çŸ¥é“å¯¹ä¸å¯¹ï¼Œå› ä¸ºå®‰è£…ä¸äº†æ‰€ä»¥æ— æ³•æµ‹è¯•ï¼Œè§ä¸‹ä¸€å°èŠ‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;jni.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdint&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, <span class="hljs-string">&quot;Tag&quot;</span>, __VA_ARGS__)</span><br><br><span class="hljs-comment">/* ä»¥ä¸‹æ˜¯ OpenMemoryå‡½æ•°åœ¨å†…å­˜ä¸­å¯¹å¤–çš„æ–¹æ³•å */</span><br><span class="hljs-comment">/*Android 5*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OpenMemory21 <span class="hljs-string">&quot;_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPS9_&quot;</span></span><br><span class="hljs-comment">/*Android 5.1*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OpenMemory22 <span class="hljs-string">&quot;_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPKNS_7OatFileEPS9_&quot;</span></span><br><span class="hljs-comment">/*Android 6*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OpenMemory23 <span class="hljs-string">&quot;_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPKNS_10OatDexFileEPS9_&quot;</span></span><br><span class="hljs-comment">/*Android 7.1, ä¸Android 6ä¸€è‡´*/</span><br><span class="hljs-comment">//#define openMemory25 &quot;_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPKNS_10OatDexFileEPS9_&quot;</span><br><br><span class="hljs-comment">/*å®šä¹‰å‡½æ•°æŒ‡é’ˆ*/</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *(*org_artDexFileOpenMemory21)(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *base,<br>                                            <span class="hljs-type">size_t</span> size,<br>                                            <span class="hljs-type">const</span> std::string &amp;location,<br>                                            <span class="hljs-type">uint32_t</span> location_checksum,<br>                                            <span class="hljs-type">void</span> *mem_map,<br>                                            std::string *error_msg);<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *(*org_artDexFileOpenMemory22)(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *base,<br>                                            <span class="hljs-type">size_t</span> size,<br>                                            <span class="hljs-type">const</span> std::string &amp;location,<br>                                            <span class="hljs-type">uint32_t</span> location_checksum,<br>                                            <span class="hljs-type">void</span> *mem_map,<br>                                            <span class="hljs-type">const</span> <span class="hljs-type">void</span> *oat_file,<br>                                            std::string *error_msg);<br><br><span class="hljs-keyword">typedef</span> std::<span class="hljs-built_in">unique_ptr</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">void</span> *&gt; (*org_artDexFileOpenMemory23)(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *base,<br>                                                                    <span class="hljs-type">size_t</span> size,<br>                                                                    <span class="hljs-type">const</span> std::string &amp;location,<br>                                                                    <span class="hljs-type">uint32_t</span> location_checksum,<br>                                                                    <span class="hljs-type">void</span> *mem_map,<br>                                                                    <span class="hljs-type">const</span> <span class="hljs-type">void</span> *oat_dex_file,<br>                                                                    std::string *error_msg);<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kSha1DigestSize = <span class="hljs-number">20</span>;<br><span class="hljs-comment">//æ”¾å¤´æ–‡ä»¶ä¸­ä¸€å †é”™è¯¯ï¼?</span><br><span class="hljs-comment">// Raw header_item.</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Header</span><br>&#123;<br>    <span class="hljs-type">uint8_t</span>  magic_[<span class="hljs-number">8</span>];<br>    <span class="hljs-type">uint32_t</span> checksum_;        <span class="hljs-comment">// See also location_checksum_</span><br>    <span class="hljs-type">uint8_t</span>  signature_[kSha1DigestSize];<br>    <span class="hljs-type">uint32_t</span> file_size_;       <span class="hljs-comment">// size of entire file</span><br>    <span class="hljs-type">uint32_t</span> header_size_;     <span class="hljs-comment">// offset to start of next section</span><br>    <span class="hljs-type">uint32_t</span> endian_tag_;<br>    <span class="hljs-type">uint32_t</span> link_size_;       <span class="hljs-comment">// unused</span><br>    <span class="hljs-type">uint32_t</span> link_off_;        <span class="hljs-comment">// unused</span><br>    <span class="hljs-type">uint32_t</span> map_off_;         <span class="hljs-comment">// unused</span><br>    <span class="hljs-type">uint32_t</span> string_ids_size_; <span class="hljs-comment">// number of StringIds</span><br>    <span class="hljs-type">uint32_t</span> string_ids_off_;  <span class="hljs-comment">// file offset of StringIds array</span><br>    <span class="hljs-type">uint32_t</span> type_ids_size_;   <span class="hljs-comment">// number of TypeIds, we don&#x27;t support more than 65535</span><br>    <span class="hljs-type">uint32_t</span> type_ids_off_;    <span class="hljs-comment">// file offset of TypeIds array</span><br>    <span class="hljs-type">uint32_t</span> proto_ids_size_;  <span class="hljs-comment">// number of ProtoIds, we don&#x27;t support more than 65535</span><br>    <span class="hljs-type">uint32_t</span> proto_ids_off_;   <span class="hljs-comment">// file offset of ProtoIds array</span><br>    <span class="hljs-type">uint32_t</span> field_ids_size_;  <span class="hljs-comment">// number of FieldIds</span><br>    <span class="hljs-type">uint32_t</span> field_ids_off_;   <span class="hljs-comment">// file offset of FieldIds array</span><br>    <span class="hljs-type">uint32_t</span> method_ids_size_; <span class="hljs-comment">// number of MethodIds</span><br>    <span class="hljs-type">uint32_t</span> method_ids_off_;  <span class="hljs-comment">// file offset of MethodIds array</span><br>    <span class="hljs-type">uint32_t</span> class_defs_size_; <span class="hljs-comment">// number of ClassDefs</span><br>    <span class="hljs-type">uint32_t</span> class_defs_off_;  <span class="hljs-comment">// file offset of ClassDef array</span><br>    <span class="hljs-type">uint32_t</span> data_size_;       <span class="hljs-comment">// unused</span><br>    <span class="hljs-type">uint32_t</span> data_off_;        <span class="hljs-comment">// unused</span><br>&#125;;<br><br><span class="hljs-comment">//libart.soæŒ‡é’ˆ</span><br><span class="hljs-type">void</span>* artHandle = <span class="hljs-literal">nullptr</span>;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">loadDexInAndroid5</span><span class="hljs-params">(<span class="hljs-type">int</span> sdk_int, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *base, <span class="hljs-type">size_t</span> size)</span></span>;<br><span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-type">void</span> *&gt; <span class="hljs-title">loadDexAboveAndroid6</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *base, <span class="hljs-type">size_t</span> size)</span></span>;<br><br><span class="hljs-comment">/*åŠ è½½å†…å­˜dex*/</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span><br><span class="hljs-function">JNIEXPORT jobject * JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_androidsecondshell2_MyClassLoader_OpenMemory</span><span class="hljs-params">(JNIEnv *env, jclass clazz,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                              jbyteArray dex, jlong dexlen, jint sdk_int)</span> </span>&#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> implement OpenMemory()</span><br>    <span class="hljs-type">void</span>* value;<br><br>    <span class="hljs-keyword">if</span> (sdk_int &lt; <span class="hljs-number">22</span>) &#123;<span class="hljs-comment">/* android 5.0, 5.1*/</span><br>        value =  <span class="hljs-built_in">loadDexInAndroid5</span>(sdk_int,(<span class="hljs-type">char</span>*)dex,(<span class="hljs-type">size_t</span>)dexlen);<br>    &#125; <span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">/* android 6.0 7.0 7.1 */</span><br>        value = <span class="hljs-built_in">loadDexAboveAndroid6</span>((<span class="hljs-type">char</span>*)dex,(<span class="hljs-type">size_t</span>)dexlen).<span class="hljs-built_in">get</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!value)&#123;<br>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;fail to load dex&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> (jobject*) value;<br><br>&#125;<br><span class="hljs-comment">/* åŠ è½½å†…å­˜dexï¼Œé€‚ç”¨äºandroid 5, 5.1 */</span><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">loadDexInAndroid5</span><span class="hljs-params">(<span class="hljs-type">int</span> sdk_int, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *base, <span class="hljs-type">size_t</span> size)</span></span>&#123;<br>    std::string location = <span class="hljs-string">&quot;Anonymous-DexFile&quot;</span>;<br>    std::string err_msg;<br>    <span class="hljs-type">void</span>* value;<br><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> *dex_header = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> Header *&gt;(base);<br><br>    <span class="hljs-keyword">if</span> (sdk_int == <span class="hljs-number">21</span>) &#123;<span class="hljs-comment">/* android 5.0 */</span><br>        <span class="hljs-keyword">auto</span> func21 = (org_artDexFileOpenMemory21) <span class="hljs-built_in">dlsym</span>(artHandle, OpenMemory21);<br>        value = <span class="hljs-built_in">func21</span>((<span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) base,<br>                       (<span class="hljs-type">size_t</span>)size,<br>                       location,<br>                       dex_header-&gt;checksum_,<br>                       <span class="hljs-literal">nullptr</span>,<br>                       &amp;err_msg);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sdk_int == <span class="hljs-number">22</span>) &#123;<span class="hljs-comment">/* android 5.1 */</span><br>        <span class="hljs-keyword">auto</span> func22 = (org_artDexFileOpenMemory22) <span class="hljs-built_in">dlsym</span>(artHandle, OpenMemory22);<br>        value = <span class="hljs-built_in">func22</span>((<span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) base,<br>                       size,<br>                       location,<br>                       dex_header-&gt;checksum_,<br>                       <span class="hljs-literal">nullptr</span>,<br>                       <span class="hljs-literal">nullptr</span>,<br>                       &amp;err_msg);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!value)&#123;<br>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;fail to load dex in Android 5&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> value;<br><br>&#125;<br><br><span class="hljs-comment">/* åŠ è½½å†…å­˜dexï¼Œé€‚ç”¨äºandroid 6.0 7.0 7.1 */</span><br><span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-type">void</span> *&gt; <span class="hljs-title">loadDexAboveAndroid6</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *base, <span class="hljs-type">size_t</span> size)</span></span>&#123;<br><br>    std::string location = <span class="hljs-string">&quot;Anonymous-DexFile&quot;</span>;<br>    std::string err_msg;<br>    std::unique_ptr&lt;<span class="hljs-type">const</span> <span class="hljs-type">void</span> *&gt; value;<br><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> *dex_header = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> Header *&gt;(base);<br><br>    <span class="hljs-keyword">auto</span> func23 = (org_artDexFileOpenMemory23) <span class="hljs-built_in">dlsym</span>(artHandle, OpenMemory23);<br>    value = <span class="hljs-built_in">func23</span>((<span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) base,<br>                   size,<br>                   location,<br>                   dex_header-&gt;checksum_,<br>                   <span class="hljs-literal">nullptr</span>,<br>                   <span class="hljs-literal">nullptr</span>,<br>                   &amp;err_msg);<br><br>    <span class="hljs-keyword">if</span> (!value) &#123;<br>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;fail to load dex in Android 6 and above&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> value;<br><br>&#125;<br><br><span class="hljs-function">JNIEXPORT jint <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM* vm, <span class="hljs-type">void</span>* reserved)</span></span>&#123;<br>    <span class="hljs-comment">//æ‰“å¼€libart.soæ–‡ä»¶</span><br>    artHandle = (<span class="hljs-type">void</span>*)<span class="hljs-built_in">dlopen</span>(<span class="hljs-string">&quot;libart.so&quot;</span>, RTLD_LAZY);<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¸‰ã€å‡ºç°çš„é—®é¢˜"><a href="#ä¸‰ã€å‡ºç°çš„é—®é¢˜" class="headerlink" title="ä¸‰ã€å‡ºç°çš„é—®é¢˜"></a>ä¸‰ã€å‡ºç°çš„é—®é¢˜</h1><p>åœ¨Android 8ä»¥ä¸‹çš„ç¯å¢ƒä¸‹ï¼Œå› ä¸ºè„±å£³ç¨‹åºä¼šéœ€è¦libåº“ï¼Œæ‰€ä»¥æˆ‘å°†è„±å£³APKä¸­çš„libç›®å½•ç›´æ¥æ‹–åˆ°æºç¨‹åºAPKä¸­ï¼ˆåœ¨æ­¤ä¹‹å‰ï¼Œæºç¨‹åºAPKå¹¶æ²¡æœ‰libç›®å½•ï¼‰ï¼Œäºæ˜¯ä¹å°±å‡ºç°è¿™æ ·çš„é—®é¢˜ï¼š</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs subunit">adb: failed to install SourceApk_sign.apk: <br><span class="hljs-keyword">Failure </span>[INSTALL_FAILED_INVALID_APK: Failed to extract native libraries, res=<span class="hljs-string">-2</span>]<br></code></pre></td></tr></table></figure><p>å¯æˆ‘ä½¿ç”¨ zipalign å·¥å…·åï¼Œä»ç„¶å®‰è£…å¤±è´¥ï¼</p><p>ï¼ˆå…ˆæç½®ä¸€ä¸‹å§ğŸ˜”ï¼‰</p><p>â€”â€”â€”â€”â€”â€”</p><p>ç›´æ¥å¯¹æºç¨‹åºåŠ¨æ‰‹ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æºç¨‹åºï¼Œé€‰æ‹©æˆnativeå¼€å‘ï¼Œä»£ç å¤åˆ¶è¿‡æ¥ï¼Œå¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚</p><p>ä½†ä»ç„¶å­˜åœ¨æ–°çš„é—®é¢˜ï¼Œnativeå±‚çš„æˆåŠŸæ‰“å¼€libart.soæ–‡ä»¶ï¼Œä½†æ˜¯æŠ¥é”™ï¼š</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ada">open libart.so success//è¿™æ˜¯æˆ‘ç”¨LOGEè¾“å‡ºçš„<br>terminating <span class="hljs-keyword">with</span> uncaught <span class="hljs-keyword">exception</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">type</span> <span class="hljs-type">std::bad_alloc: </span><br><span class="hljs-type"></span>Fatal signal <span class="hljs-number">6</span> (SIGABRT), code -<span class="hljs-number">6</span> <span class="hljs-keyword">in</span> tid <span class="hljs-number">27489</span> (ample.sourceapk)<br>Build fingerprint: <span class="hljs-symbol">&#x27;google</span>/marlin/marlin:<span class="hljs-number">7</span><br>...æ‰‹æœºæŒ‡çº¹...<br></code></pre></td></tr></table></figure><p>å¯æ˜¯æˆ‘æ²¡åˆ†é…å†…å­˜å•Šï¼Ÿå“ªæ¥çš„bad_allocï¼Ÿ</p><hr><p>å‚è€ƒï¼š</p><p><a href="http://www.520monkey.com/archives/629">Androidä¸­apkåŠ å›ºå®Œå–„ç¯‡ä¹‹å†…å­˜åŠ è½½dexæ–¹æ¡ˆå®ç°åŸç†(ä¸è½åœ°æ–¹å¼åŠ è½½) | å°¼å¤æ‹‰æ–¯.èµµå›› (520monkey.com)</a></p><p><a href="https://bbs.kanxue.com/thread-277298.htm">AndroidåŠ å£³ä¸è„±å£³ï¼ˆ11ï¼‰â€”â€”ä¸è½åœ°åŠ è½½çš„å¯¹æŠ—ç ”ç©¶</a></p><p><a href="https://github.com/Frezrik/Jiagu">Frezrik&#x2F;Jiagu: Android apk jiagu (github.com)</a></p><p>[<a href="https://bbs.kanxue.com/thread-261939.htm#msg_header_h1_2">åŸåˆ›]å®‰å“åŠ å›ºæ–¹æ¡ˆä»è½åœ°åŠ è½½åˆ°ç±»æŒ‡ä»¤æŠ½å–ç¼–å†™æŠ¥å‘Š-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p>[<a href="https://bbs.kanxue.com/thread-260124.htm#msg_header_h2_1">åŸåˆ›]Android AppåŠ å›ºåŸç†ä¸æŠ€æœ¯å†ç¨‹-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p><a href="">å®‰å“å„ç‰ˆæœ¬æºç </a></p><p><a href="https://blog.csdn.net/rzleilei/article/details/102911506">Androidæœ€æ–°ç‰ˆæœ¬å·ä¸APIçº§åˆ«å¯¹åº”å…³ç³»ï¼ˆæ›´æ–°åˆ°android13ï¼‰_android 13 apiç‰ˆæœ¬-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/qq409732112/article/details/109391210">hookåŠ è½½libart.soä¸­çš„OpenMemoryå‡½æ•°</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AndroidåŠ å›º</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JNIåŸç†</title>
    <link href="/2023/12/10/JNI%E5%8E%9F%E7%90%86/"/>
    <url>/2023/12/10/JNI%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>åœ¨ Android é€†å‘è¿‡ç¨‹ä¸­ï¼Œå¸¸å¸¸å¯ä»¥è§åˆ° java å±‚ä½¿ç”¨ native å‡½æ•°ï¼Œä½† native å‡½æ•°å¹¶æ²¡æœ‰åœ¨ java å±‚å®ç°ï¼Œè€Œæ˜¯åœ¨ native å±‚å®ç°ï¼Œjava å±‚é€šè¿‡åŠ è½½åº“æ–‡ä»¶æ¥æ­£å¸¸ä½¿ç”¨è¯¥å‡½æ•°ã€‚java å±‚ä¹‹æ‰€ä»¥å¯ä»¥ä½¿ç”¨ native å±‚å®ç°çš„å‡½æ•°ï¼Œæ˜¯å› ä¸º JNI çš„å­˜åœ¨ã€‚</p><p>å¦‚æœæˆ‘ä»¬è¿›ä¸€æ­¥æ¢ç©¶ so æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°æœ‰çš„ so æ–‡ä»¶ä¸­å«æœ‰ JNI_OnLoad å‡½æ•°ï¼Œè€Œæœ‰çš„æ²¡æœ‰è¯¥å‡½æ•°ã€‚è¿™ä¸ªæ˜¯å› ä¸ºå‡½æ•°ç»„æ³¨å†Œçš„æ–¹å¼ä¸åŒï¼Œå…·ä½“è€Œè¨€å¯åˆ†ä¸ºé™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°†ä¸€èµ·å­¦ä¹  JNI ä»¥åŠnativeå‡½æ•°çš„æ³¨å†Œæ–¹æ³•ã€‚</p><h1 id="äºŒã€ä»€ä¹ˆæ˜¯JNIï¼Ÿ"><a href="#äºŒã€ä»€ä¹ˆæ˜¯JNIï¼Ÿ" class="headerlink" title="äºŒã€ä»€ä¹ˆæ˜¯JNIï¼Ÿ"></a>äºŒã€ä»€ä¹ˆæ˜¯JNIï¼Ÿ</h1><p>JNIï¼ˆJava Native Interfaceï¼‰è¯‘ä¸º java æœ¬åœ°æ¥å£ï¼Œæ˜¯ java ä¸å…¶ä»–è¯­è¨€é€šä¿¡çš„æ¡¥æ¢ã€‚å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ JNI æŠ€æœ¯æ¥å®Œæˆ java ç¼–ç¨‹æ— æ³•å¤„ç†çš„ä»»åŠ¡æˆ–è€…ä¸ä¾¿å¤„ç†çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š</p><ol><li>è°ƒç”¨ Java è¯­è¨€ä¸æ”¯æŒçš„ä¾èµ–äºæ“ä½œç³»ç»Ÿå¹³å°ç‰¹æ€§çš„åŠŸèƒ½ã€‚</li><li>æ•´åˆä»¥å‰çš„é Java è¯­è¨€å¼€å‘çš„ç³»ç»Ÿã€‚</li><li>èŠ‚çœç¨‹åºçš„è¿è¡Œæ—¶é—´ï¼Œé‡‡ç”¨å…¶ä»–è¯­è¨€ï¼ˆå¦‚ C&#x2F;C++ï¼‰æ¥æå‡è¿è¡Œæ•ˆç‡ã€‚</li></ol><h1 id="ä¸‰ã€Nativeæ³¨å†Œæ–¹æ³•"><a href="#ä¸‰ã€Nativeæ³¨å†Œæ–¹æ³•" class="headerlink" title="ä¸‰ã€Nativeæ³¨å†Œæ–¹æ³•"></a>ä¸‰ã€Nativeæ³¨å†Œæ–¹æ³•</h1><p>Native æ–¹æ³•æ³¨å†Œå¯åˆ†ä¸ºé™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œï¼Œå…¶ä¸­é™æ€æ³¨å†Œå¤šç”¨äº NDK å¼€å‘ï¼Œè€ŒåŠ¨æ€æ³¨å†Œå¤šç”¨äº Framework å¼€å‘ã€‚</p><h2 id="3-1-é™æ€æ³¨å†Œ"><a href="#3-1-é™æ€æ³¨å†Œ" class="headerlink" title="3.1 é™æ€æ³¨å†Œ"></a>3.1 é™æ€æ³¨å†Œ</h2><p>Android Studioä¸­åˆ›å»ºä¸€ä¸ªnativeé¡¹ç›®ï¼Œä¼šè‡ªåŠ¨å®šä¹‰ä¸€ä¸ª JNI å‡½æ•°<code>stringFromJNI</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.mynative;<br><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.widget.TextView;<br><br><span class="hljs-keyword">import</span> com.example.mynative.databinding.ActivityMainBinding;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-comment">//åŠ è½½nativeåº“</span><br>        System.loadLibrary(<span class="hljs-string">&quot;mynative&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> ActivityMainBinding binding;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br><br>        binding = ActivityMainBinding.inflate(getLayoutInflater());<br>        setContentView(binding.getRoot());<br><br>        <span class="hljs-type">TextView</span> <span class="hljs-variable">tv</span> <span class="hljs-operator">=</span> binding.sampleText;<br>        <span class="hljs-comment">//è°ƒç”¨stringFromJNIæ–¹æ³•</span><br>        tv.setText(stringFromJNI());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å£°æ˜nativeåº“ä¸­çš„stringFromJNIæ–¹æ³•ï¼Œä»¥ä¾›Javaå±‚è°ƒç”¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">stringFromJNI</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„<code>stringFromJNI</code>æ–¹æ³•åœ¨Nativeå±‚çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;jni.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <br><span class="hljs-function">JNIEXPORT jstring JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_mynative_MainActivity_stringFromJNI</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">        jobject <span class="hljs-comment">/* this */</span>)</span> </span>&#123;<br>    std::string hello = <span class="hljs-string">&quot;Hello from C++&quot;</span>;<br>    <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(hello.<span class="hljs-built_in">c_str</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„å‡½æ•°åä¸º<code>Java_com_example_mynative_MainActivity_stringFromJNI</code>ï¼Œè¯¥å‡½æ•°åç‰¹ç‚¹ä¸ºï¼š</p><ol><li>å¸¦æœ‰<code>JNIEXPORT</code>å’Œ<code>JNICALL</code>ä¸¤ä¸ªå®å®šä¹‰ã€‚</li><li>ç¬¦åˆå‡½æ•°å‘½åè§„åˆ™ï¼šä»¥å­—ç¬¦ä¸² â€œJavaâ€ ä¸ºå‰ç¼€ï¼Œç”¨ â€œ_â€ ä¸‹åˆ’çº¿å°†åŒ…åã€ç±»åä»¥åŠæ–¹æ³•åè¿æ¥èµ·æ¥ã€‚</li></ol><p>å½“æˆ‘ä»¬åœ¨ Java å±‚è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œå°±ä¼šæ ¹æ®ä»¥ä¸Šç‰¹å¾ä» JNI ä¸­å¯»æ‰¾å¯¹åº”å‡½æ•°ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ä¼šä¸º Java å±‚ å’Œ Native å±‚çš„ç›¸åº”å‡½æ•°å»ºå…³è”ï¼Œå³ä¿å­˜ JNI çš„å‡½æ•°æŒ‡é’ˆï¼Œä»¥åè°ƒç”¨å°±å¯ä»¥ç›´æ¥ä½¿ç”¨å‡½æ•°æŒ‡é’ˆå³å¯ã€‚é™æ€æ³¨å†Œå°±æ˜¯æ ¹æ®æ–¹æ³•åï¼Œå°†Javaæ–¹æ³•å’ŒJNIå‡½æ•°å»ºç«‹å…³è”ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€äº›ç¼ºé™·ï¼š</p><ul><li>JNIå±‚çš„å‡½æ•°åè¿‡é•¿ã€‚</li><li>åˆæ¬¡è°ƒç”¨Nativeæ–¹æ³•æ—¶éœ€è¦å»ºç«‹å…³è”ï¼Œå½±å“æ•ˆç‡ã€‚</li></ul><p>æˆ‘ä»¬çŸ¥é“ï¼Œé™æ€æ³¨å†Œå°±æ˜¯Javaçš„Nativeæ–¹æ³•é€šè¿‡æ–¹æ³•æŒ‡é’ˆæ¥ä¸JNIè¿›è¡Œå…³è”ï¼Œå¦‚æœJavaçš„Nativeæ–¹æ³•çŸ¥é“å®ƒåœ¨JNIä¸­å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆï¼Œå°±å¯ä»¥é¿å…ä¸Šè¿°çš„ç¼ºç‚¹ï¼Œè¿™å°±æ˜¯åŠ¨æ€æ³¨å†Œã€‚</p><h2 id="3-2-åŠ¨æ€æ³¨å†Œ"><a href="#3-2-åŠ¨æ€æ³¨å†Œ" class="headerlink" title="3.2 åŠ¨æ€æ³¨å†Œ"></a>3.2 åŠ¨æ€æ³¨å†Œ</h2><p>åœ¨åŠ¨æ€æ³¨å†Œä¸­ï¼ŒJNI ä¸­ä¼šä½¿ç”¨ JNINativeMethod ç»“æ„ä½“æ¥è®°å½• Java çš„Native æ–¹æ³•å’Œ JNI æ–¹æ³•çš„å…³è”å…³ç³»ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span>* name;<span class="hljs-comment">//Javaæ–¹æ³•çš„åå­—</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>* signature;<span class="hljs-comment">//Javaæ–¹æ³•çš„ç­¾åä¿¡æ¯ï¼ˆå‚æ•°ç±»å‹+è¿”å›å€¼ç±»å‹ï¼‰</span><br><span class="hljs-type">void</span>* fnPtr;<span class="hljs-comment">//JNIä¸­å¯¹åº”çš„æ–¹æ³•æŒ‡é’ˆ</span><br>&#125;JNINativeMethod;<br></code></pre></td></tr></table></figure><p>ä»¥ Android ç³»ç»Ÿä¸­çš„ MediaRecorder ä¸ºä¾‹ï¼Œæ¥æ¢ç©¶åŠ¨æ€æ³¨å†Œçš„è¿‡ç¨‹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//frameworks/base/media/jni/android_media_MediaRecorder.cpp</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> JNINativeMethod gMethods[] = &#123;<br>...<br>    &#123;<span class="hljs-string">&quot;start&quot;</span>,            <span class="hljs-string">&quot;()V&quot;</span>,      (<span class="hljs-type">void</span> *)android_media_MediaRecorder_start&#125;,<span class="hljs-comment">//1</span><br>    &#123;<span class="hljs-string">&quot;stop&quot;</span>,             <span class="hljs-string">&quot;()V&quot;</span>,      (<span class="hljs-type">void</span> *)android_media_MediaRecorder_stop&#125;,<br>    &#123;<span class="hljs-string">&quot;pause&quot;</span>,            <span class="hljs-string">&quot;()V&quot;</span>,      (<span class="hljs-type">void</span> *)android_media_MediaRecorder_pause&#125;,<br>    &#123;<span class="hljs-string">&quot;resume&quot;</span>,           <span class="hljs-string">&quot;()V&quot;</span>,      (<span class="hljs-type">void</span> *)android_media_MediaRecorder_resume&#125;,<br>    &#123;<span class="hljs-string">&quot;native_reset&quot;</span>,     <span class="hljs-string">&quot;()V&quot;</span>,      (<span class="hljs-type">void</span> *)android_media_MediaRecorder_native_reset&#125;,<br>    &#123;<span class="hljs-string">&quot;release&quot;</span>,          <span class="hljs-string">&quot;()V&quot;</span>,      (<span class="hljs-type">void</span> *)android_media_MediaRecorder_release&#125;,<br>    &#123;<span class="hljs-string">&quot;native_init&quot;</span>,      <span class="hljs-string">&quot;()V&quot;</span>,      (<span class="hljs-type">void</span> *)android_media_MediaRecorder_native_init&#125;,<br>   ...<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ JNINativeMethod ç±»å‹çš„ gMethods æ•°ç»„ï¼Œå­˜æ”¾çš„éƒ½æ˜¯ MediaRecorder çš„ Native æ–¹æ³•ä¸ JNI å±‚å‡½æ•°çš„å¯¹åº”å…³ç³»ï¼ˆå³ JNINativeMethod ç»“æ„ä½“ï¼‰ã€‚</p><p>è¿™é‡Œåªæ˜¯å®šä¹‰äº† JNINativeMethod ç±»å‹çš„æ•°ç»„ï¼Œè¿˜éœ€è¦æ³¨å†Œå®ƒï¼Œæ³¨å†Œçš„å‡½æ•°ä¸º register_android_media_MediaRecorderï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢« JNI_OnLoad å‡½æ•°è°ƒç”¨ï¼Œè€Œ JNI_OnLoad å‡½æ•°æ˜¯åœ¨ java å±‚è°ƒç”¨ System.loadLibrary å‡½æ•°æ—¶è¢«è°ƒç”¨ã€‚ MediaRecorder å¯¹åº”çš„ JNI_OnLoad å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//frameworks/base/media/jni/android_media_MediaPlayer.cpp</span><br><span class="hljs-function">jint <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM* vm, <span class="hljs-type">void</span>* <span class="hljs-comment">/* reserved */</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    JNIEnv* env = <span class="hljs-literal">NULL</span>;<br>    jint result = <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-keyword">if</span> (vm-&gt;<span class="hljs-built_in">GetEnv</span>((<span class="hljs-type">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;ERROR: GetEnv failed\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> bail;<br>    &#125;<br>    <span class="hljs-built_in">assert</span>(env != <span class="hljs-literal">NULL</span>);<br>...<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">register_android_media_MediaPlayer</span>(env) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;ERROR: MediaPlayer native registration failed\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> bail;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">register_android_media_MediaRecorder</span>(env) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;ERROR: MediaRecorder native registration failed\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> bail;<br>    &#125;<br>...<br>    <span class="hljs-comment">/* success -- return valid version number */</span><br>    result = JNI_VERSION_1_4;<br><br>bail:<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ JNI_OnLoad å‡½æ•°ä¸­è°ƒç”¨äº†æ•´ä¸ªå¤šåª’ä½“æ¡†æ¶çš„æ³¨å†Œ JNINativeMethod æ•°ç»„çš„å‡½æ•°ã€‚è·Ÿéš register_android_media_MediaRecorder å‡½æ•°è¿›ä¸€æ­¥æ·±å…¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//frameworks/base/media/jni/android_media_MediaRecorder.cpp</span><br><br><span class="hljs-comment">// This function only registers the native methods, and is called from</span><br><span class="hljs-comment">// JNI_OnLoad in android_media_MediaPlayer.cpp</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">register_android_media_MediaRecorder</span><span class="hljs-params">(JNIEnv *env)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> AndroidRuntime::<span class="hljs-built_in">registerNativeMethods</span>(env,<br>                <span class="hljs-string">&quot;android/media/MediaRecorder&quot;</span>, gMethods, <span class="hljs-built_in">NELEM</span>(gMethods));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸­è°ƒç”¨äº† AndroidRuntime çš„ registerNativeMethods å‡½æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//frameworks/base/core/jni/AndroidRuntime.cpp</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Register native methods using JNI.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/*static*/</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AndroidRuntime::registerNativeMethods</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* className, <span class="hljs-type">const</span> JNINativeMethod* gMethods, <span class="hljs-type">int</span> numMethods)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">jniRegisterNativeMethods</span>(env, className, gMethods, numMethods);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è°ƒç”¨äº† jniRegisterNativeMethods å‡½æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//libnativehelper/JNIHelp.cpp</span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">jniRegisterNativeMethods</span><span class="hljs-params">(C_JNIEnv* env, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* className,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> JNINativeMethod* gMethods, <span class="hljs-type">int</span> numMethods)</span></span><br><span class="hljs-function"></span>&#123;<br>    JNIEnv* e = <span class="hljs-built_in">reinterpret_cast</span>&lt;JNIEnv*&gt;(env);<br><br>    <span class="hljs-built_in">ALOGV</span>(<span class="hljs-string">&quot;Registering %s&#x27;s %d native methods...&quot;</span>, className, numMethods);<br><span class="hljs-comment">//æ‰¾è¦åŠ è½½çš„ç±»</span><br>    <span class="hljs-function">scoped_local_ref&lt;jclass&gt; <span class="hljs-title">c</span><span class="hljs-params">(env, findClass(env, className))</span></span>;<br>    <span class="hljs-keyword">if</span> (c.<span class="hljs-built_in">get</span>() == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-type">char</span>* tmp;<br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">asprintf</span>(&amp;tmp,<br>                     <span class="hljs-string">&quot;Native registration unable to find class &#x27;%s&#x27;; aborting...&quot;</span>,<br>                     className) == <span class="hljs-number">-1</span>) &#123;<br>            <span class="hljs-comment">// Allocation failed, print default warning.</span><br>            msg = <span class="hljs-string">&quot;Native registration unable to find class; aborting...&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            msg = tmp;<br>        &#125;<br>        e-&gt;<span class="hljs-built_in">FatalError</span>(msg);<br>    &#125;<br><span class="hljs-comment">//è¿›è¡Œæ³¨å†Œ</span><br>    <span class="hljs-keyword">if</span> ((*env)-&gt;<span class="hljs-built_in">RegisterNatives</span>(e, c.<span class="hljs-built_in">get</span>(), gMethods, numMethods) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">char</span>* tmp;<br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">asprintf</span>(&amp;tmp, <span class="hljs-string">&quot;RegisterNatives failed for &#x27;%s&#x27;; aborting...&quot;</span>, className) == <span class="hljs-number">-1</span>) &#123;<br>            <span class="hljs-comment">// Allocation failed, print default warning.</span><br>            msg = <span class="hljs-string">&quot;RegisterNatives failed; aborting...&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            msg = tmp;<br>        &#125;<br>        e-&gt;<span class="hljs-built_in">FatalError</span>(msg);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡è°ƒç”¨ JNIEnv çš„ RegisterNatives å‡½æ•°æ¥å®Œæˆ JNI çš„æ³¨å†Œã€‚ JNIEnv åœ¨ JNI ä¸­éå¸¸é‡è¦ï¼Œä¸‹ä¸€å°èŠ‚å°†ä¼šè®²è¿°å®ƒã€‚</p><h1 id="å››ã€æ•°æ®ç±»å‹çš„è½¬æ¢"><a href="#å››ã€æ•°æ®ç±»å‹çš„è½¬æ¢" class="headerlink" title="å››ã€æ•°æ®ç±»å‹çš„è½¬æ¢"></a>å››ã€æ•°æ®ç±»å‹çš„è½¬æ¢</h1><p>Javaå±‚çš„æ•°æ®ç±»å‹åˆ†ä¸ºä¸¤ç±»ï¼šåŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨æ•°æ®ç±»å‹ï¼ŒJNIå±‚ä¹Ÿåšäº†ç›¸åº”çš„æ•°æ®ç±»å‹åˆ’åˆ†ã€‚</p><h2 id="4-1-åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢"><a href="#4-1-åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢" class="headerlink" title="4.1 åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢"></a>4.1 åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢</h2><table><thead><tr><th align="center">Java</th><th align="center">Native</th><th align="center">Signature</th></tr></thead><tbody><tr><td align="center">byte</td><td align="center">jbyte</td><td align="center">B</td></tr><tr><td align="center">char</td><td align="center">jchar</td><td align="center">C</td></tr><tr><td align="center">double</td><td align="center">jdouble</td><td align="center">D</td></tr><tr><td align="center">float</td><td align="center">jfloat</td><td align="center">F</td></tr><tr><td align="center">int</td><td align="center">jint</td><td align="center">I</td></tr><tr><td align="center">short</td><td align="center">jshort</td><td align="center">S</td></tr><tr><td align="center">long</td><td align="center">jlong</td><td align="center">J</td></tr><tr><td align="center">boolean</td><td align="center">jboolean</td><td align="center">Z</td></tr><tr><td align="center">void</td><td align="center">void</td><td align="center">V</td></tr></tbody></table><p>å¯ä»¥çœ‹å‡ºï¼ŒåŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢ï¼Œé™¤äº†voidç±»å‹ä»¥å¤–ï¼Œå…¶ä»–çš„æ•°æ®ç±»å‹éƒ½åªè¦åœ¨å‰é¢åŠ ä¸Šâ€jâ€å°±è¡Œäº†ã€‚</p><h2 id="4-2-å¼•ç”¨æ•°æ®ç±»å‹çš„è½¬æ¢"><a href="#4-2-å¼•ç”¨æ•°æ®ç±»å‹çš„è½¬æ¢" class="headerlink" title="4.2 å¼•ç”¨æ•°æ®ç±»å‹çš„è½¬æ¢"></a>4.2 å¼•ç”¨æ•°æ®ç±»å‹çš„è½¬æ¢</h2><table><thead><tr><th align="center">Java</th><th align="center">Native</th><th align="center">Signature</th></tr></thead><tbody><tr><td align="center">æ‰€æœ‰å¯¹è±¡</td><td align="center">jobject</td><td align="center">L + classname + ;</td></tr><tr><td align="center">Class</td><td align="center">jclass</td><td align="center">Ljava&#x2F;lang&#x2F;Class;</td></tr><tr><td align="center">String</td><td align="center">jstring</td><td align="center">Ljava&#x2F;lang&#x2F;String;</td></tr><tr><td align="center">Throwable</td><td align="center">jthrowable</td><td align="center">Ljava&#x2F;lang&#x2F;Throwable;</td></tr><tr><td align="center">Object[]</td><td align="center">jobjectArray</td><td align="center">[L + classname + ;</td></tr><tr><td align="center">byte[]</td><td align="center">jbyteArray</td><td align="center">[B</td></tr><tr><td align="center">char[]</td><td align="center">jcharArray</td><td align="center">[C</td></tr><tr><td align="center">double[]</td><td align="center">jdoubleArray</td><td align="center">[D</td></tr><tr><td align="center">float[]</td><td align="center">jfloatArray</td><td align="center">[F</td></tr><tr><td align="center">int[]</td><td align="center">jintArray</td><td align="center">[I</td></tr><tr><td align="center">short[]</td><td align="center">jshortArray</td><td align="center">[S</td></tr><tr><td align="center">long[]</td><td align="center">jlongArray</td><td align="center">[J</td></tr><tr><td align="center">boolean[]</td><td align="center">jbooleanArray</td><td align="center">[Z</td></tr></tbody></table><p>å…¶ä¸­jclassã€jstringã€jarrayå’Œjthrowableéƒ½ç»§æ‰¿è‡ªjobjectï¼Œè€ŒjobjectArrayã€jbyteArrayç­‰éƒ½ç»§æ‰¿jarrayã€‚</p><h1 id="äº”ã€æ–¹æ³•ç­¾å"><a href="#äº”ã€æ–¹æ³•ç­¾å" class="headerlink" title="äº”ã€æ–¹æ³•ç­¾å"></a>äº”ã€æ–¹æ³•ç­¾å</h1><p>åœ¨å‰é¢ä¸¤ä¸ªè¡¨æ ¼ä¸­ï¼Œéƒ½åˆ—ä¸¾äº†æ•°æ®ç±»å‹çš„ç­¾åæ ¼å¼ï¼ˆSignatureï¼‰ï¼Œæ–¹æ³•ç­¾åå°±æ˜¯ç”±ç­¾åæ ¼å¼ç»„æˆçš„ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-type">const</span> JNINativeMethod gMethods[] = &#123;<br>    ...<br>    &#123;<span class="hljs-string">&quot;native_init&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>, (<span class="hljs-type">void</span> *)android_media_MediaRecorder_native_init&#125;,<br>    &#123;<span class="hljs-string">&quot;native_setup&quot;</span>, <span class="hljs-string">&quot;(Ljava/lang/Object;Ljava/lang/String;Ljava/lang/String;)V&quot;</span>,<br>     (<span class="hljs-type">void</span> *)android_media_MediaRecorder_native_setup&#125;,<br>     ...<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¯ä¸ªæ–¹æ³•æ•°ç»„ä¸­çš„ç¬¬äºŒä¸ªå°±æ˜¯æ–¹æ³•ç­¾åã€‚Javaä¸­æ˜¯å¯ä»¥å®šä¹‰é‡è½½æ–¹æ³•ï¼Œæ–¹æ³•åç›¸åŒä½†å‚æ•°ä¸åŒã€‚æ­£å› å¦‚æ­¤ï¼Œåœ¨JNIä¸­ä»…ä»…é€šè¿‡æ–¹æ³•åæ˜¯æ— æ³•æ‰¾åˆ°Javaä¸­å¯¹åº”çš„å…·ä½“æ–¹æ³•çš„ï¼ŒJNIä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜å°±å°†å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ç»„åˆåœ¨ä¸€èµ·ä½œä¸ºæ–¹æ³•ç­¾åã€‚é€šè¿‡æ–¹æ³•ç­¾åå’Œæ–¹æ³•åå°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„Javaæ–¹æ³•ã€‚JNIçš„æ–¹æ³•ç­¾åæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">(å‚æ•°ç­¾åæ ¼å¼...)</span>è¿”å›å€¼ç­¾åæ ¼å¼<br></code></pre></td></tr></table></figure><h1 id="å…­ã€è§£æ-JNIEnv"><a href="#å…­ã€è§£æ-JNIEnv" class="headerlink" title="å…­ã€è§£æ JNIEnv"></a>å…­ã€è§£æ JNIEnv</h1><p>JNIEnv æ˜¯ Native å±‚ä¸­ Java ç¯å¢ƒçš„ä»£è¡¨ï¼Œé€šè¿‡ JNIEnv* æŒ‡é’ˆå°±å¯ä»¥åœ¨ Native å±‚ä¸­è®¿é—® Java å±‚çš„ä»£ç å¹¶è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚è°ƒç”¨ Java çš„æ–¹æ³•ã€æ“ä½œ Java çš„å˜é‡å’Œå¯¹è±¡ç­‰ã€‚ä½†æ˜¯å®ƒåªåœ¨åˆ›å»ºå®ƒçš„çº¿ç¨‹ä¸­æœ‰æ•ˆï¼Œä¸èƒ½è·¨çº¿ç¨‹ä¼ é€’ï¼Œ å› æ­¤ä¸åŒçº¿ç¨‹çš„ JNIEnv æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ã€‚</p><p>JNIEnv çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//libnativehelper/include/nativehelper/jni.h</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">_JNIEnv</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">_JavaVM</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNINativeInterface</span>* C_JNIEnv;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__cplusplus)</span><br><span class="hljs-keyword">typedef</span> _JNIEnv JNIEnv;<br><span class="hljs-keyword">typedef</span> _JavaVM JavaVM;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNINativeInterface</span>* JNIEnv;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNIInvokeInterface</span>* JavaVM;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p><code>_JNIEnv </code>å’Œ <code>_JavaVM</code> ç»“æ„ä½“å­˜æ”¾äº†å„ç§å‡½æ•°çš„å®šä¹‰ã€‚è¿™é‡Œä½¿ç”¨äº†é¢„å®šä¹‰å® <code>__cplusplus </code>æ¥åŒºåˆ† C å’Œ C++ä¸¤ç§ä»£ç ã€‚<code>_JavaVM</code>æ˜¯ <code>Java </code>è™šæ‹Ÿæœºåœ¨ <code>JNI </code>å±‚çš„ä»£è¡¨ï¼Œåœ¨ä¸€ä¸ªè™šæ‹Ÿæœºè¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ª <code>JVM</code>ï¼Œå› æ­¤è¯¥è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ª <code>JVM</code>ã€‚é€šè¿‡ <code>JVM</code> çš„ <code>AttachCurrentThread</code>å‡½æ•°å¯ä»¥è·å–è¿™ä¸ªçº¿ç¨‹çš„ <code>JNIEnv</code>ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è°ƒç”¨ <code>Java</code> æ–¹æ³•äº†ã€‚</p><p><code>_JNIEnv </code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//libnativehelper/include/nativehelper/jni.h</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">_JNIEnv</span> &#123;<br>    <span class="hljs-comment">/* do not rename this; it does not seem to be entirely opaque */</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNINativeInterface</span>* functions;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__cplusplus)</span><br>    ...<br><span class="hljs-function">jclass <span class="hljs-title">FindClass</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-keyword">this</span>, name); &#125;<br>    ...<br><span class="hljs-function">jmethodID <span class="hljs-title">GetMethodID</span><span class="hljs-params">(jclass clazz, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* sig)</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">GetMethodID</span>(<span class="hljs-keyword">this</span>, clazz, name, sig); &#125;<br>    ...<br><span class="hljs-function">jfieldID <span class="hljs-title">GetFieldID</span><span class="hljs-params">(jclass clazz, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* sig)</span></span><br><span class="hljs-function">    </span>&#123; <span class="hljs-keyword">return</span> functions-&gt;<span class="hljs-built_in">GetFieldID</span>(<span class="hljs-keyword">this</span>, clazz, name, sig); &#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>_JNIEnv</code>æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶å†…éƒ¨åŒ…å«äº† <code>JNINativeInterface</code>ã€‚åœ¨<code>_JNIEnv</code>ä¸­å®šä¹‰äº†è®¸å¤šå‡½æ•°ï¼Œå…¶ä¸­æœ‰ä¸‰ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å‡½æ•°ï¼š</p><ol><li><strong>FindClass</strong>ï¼šæ ¹æ®å‚æ•°<code>name</code>è·å–<code>Java</code>ä¸­çš„ç±»ã€‚</li><li><strong>GetMethodID</strong>ï¼šæ ¹æ®å‚æ•°<code>clazz</code>å’Œå‚æ•°<code>name</code>è·å–<code>Java</code>ä¸­çš„ç±»ä¸­çš„æ–¹æ³•ã€‚</li><li><strong>GetFieldID</strong>ï¼šæ ¹æ®å‚æ•°<code>clazz</code>å’Œå‚æ•°<code>name</code>è·å–<code>Java</code>ä¸­çš„ç±»ä¸­çš„æˆå‘˜å˜é‡ã€‚</li></ol><p>è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†<code>JNINativeInterface</code>ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œå› æ­¤C&#x2F;C++å¯¹åº”çš„<code>JNIEnv</code>çš„ç±»å‹éƒ½å’Œ<code>JNINativeInterface</code>ç»“æ„ä½“æœ‰å…³ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼šlibnativehelper/include/nativehelper/jni.h</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">JNINativeInterface</span> &#123;<br>...<br>    <span class="hljs-built_in">jclass</span>      (*GetObjectClass)(JNIEnv*, jobject);<br>...<br>    <span class="hljs-built_in">jmethodID</span>   (*GetMethodID)(JNIEnv*, jclass, <span class="hljs-type">const</span> <span class="hljs-type">char</span>*, <span class="hljs-type">const</span> <span class="hljs-type">char</span>*);<br>...<br>    <span class="hljs-built_in">jfieldID</span>    (*GetStaticFieldID)(JNIEnv*, jclass, <span class="hljs-type">const</span> <span class="hljs-type">char</span>*, <span class="hljs-type">const</span> <span class="hljs-type">char</span>*);<br>...<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨<code>JNINativeInterface</code>ç»“æ„ä½“ä¸­å®šä¹‰äº†å¾ˆå¤šå’Œ<code>JNIEnv</code>ç»“æ„ä½“å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆã€‚é€šè¿‡è¿™äº›å‡½æ•°æŒ‡é’ˆï¼Œå°±èƒ½å¤Ÿå®šä½åˆ°è™šæ‹Ÿæœºä¸­çš„ JNI å‡½æ•°è¡¨ï¼Œä»è€Œå®ç° JNI å±‚åœ¨è™šæ‹Ÿæœºä¸­çš„å‡½æ•°è°ƒç”¨ï¼Œè¿™æ ·å°± JNI å±‚å°±å¯ä»¥è°ƒç”¨ Java å±‚çš„æ–¹æ³•äº†ã€‚</p><h1 id="ä¸ƒã€å¼•ç”¨ç±»å‹"><a href="#ä¸ƒã€å¼•ç”¨ç±»å‹" class="headerlink" title="ä¸ƒã€å¼•ç”¨ç±»å‹"></a>ä¸ƒã€å¼•ç”¨ç±»å‹</h1><p>å’ŒJavaçš„å¼•ç”¨ç±»å‹ä¸€æ ·ï¼ŒJNIä¹Ÿæœ‰å¼•ç”¨ç±»å‹ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯æœ¬åœ°å¼•ç”¨ï¼ˆLocal Referencesï¼‰ã€å…¨å±€å¼•ç”¨ï¼ˆGlobal Referencesï¼‰å’Œå¼±å…¨å±€å¼•ç”¨ï¼ˆWeak Global Referencesï¼‰ã€‚</p><h2 id="7-1-æœ¬åœ°å¼•ç”¨"><a href="#7-1-æœ¬åœ°å¼•ç”¨" class="headerlink" title="7.1 æœ¬åœ°å¼•ç”¨"></a>7.1 æœ¬åœ°å¼•ç”¨</h2><p>JNIEnvæä¾›çš„å‡½æ•°æ‰€è¿”å›çš„å¼•ç”¨åŸºæœ¬ä¸Šéƒ½æ˜¯æœ¬åœ°å¼•ç”¨ï¼Œå› æ­¤æœ¬åœ°å¼•ç”¨ä¹Ÿæ˜¯JNIä¸­æœ€å¸¸è§çš„å¼•ç”¨ç±»å‹ã€‚æœ¬åœ°å¼•ç”¨å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>å½“Nativeå‡½æ•°è¿”å›æ—¶ï¼Œè¿™ä¸ªæœ¬åœ°å¼•ç”¨å°±ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚ï¼ˆä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨JNIEnvçš„DeleteLocalRefå‡½æ•°æ¥åˆ é™¤æœ¬åœ°å¼•ç”¨ï¼‰</li><li>åªåœ¨åˆ›å»ºå®ƒçš„çº¿ç¨‹ä¸­æœ‰æ•ˆï¼Œä¸èƒ½å¤Ÿè·¨çº¿ç¨‹ä½¿ç”¨ã€‚</li><li>å±€éƒ¨å¼•ç”¨æ˜¯JVMè´Ÿè´£çš„å¼•ç”¨ç±»å‹ï¼Œå—JVMç®¡ç†ã€‚</li></ul><h2 id="7-2-å…¨å±€å¼•ç”¨"><a href="#7-2-å…¨å±€å¼•ç”¨" class="headerlink" title="7.2 å…¨å±€å¼•ç”¨"></a>7.2 å…¨å±€å¼•ç”¨</h2><p>å…¨å±€å¼•ç”¨ä¸æœ¬åœ°å¼•ç”¨ç›¸åï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>åœ¨nativeå‡½æ•°è¿”å›æ—¶ä¸ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œå› æ­¤å…¨å±€å¼•ç”¨éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œå¹¶ä¸”ä¸ä¼šè¢«GCå›æ”¶ã€‚</li><li>å…¨å±€å¼•ç”¨æ˜¯å¯ä»¥è·¨çº¿ç¨‹ä½¿ç”¨çš„ã€‚</li><li>å…¨å±€å¼•ç”¨ä¸å—åˆ°JVMç®¡ç†ã€‚</li></ul><p>å…¨å±€å¼•ç”¨é€šè¿‡JNIEnvçš„NewGlobalRefå‡½æ•°åˆ›å»ºï¼Œé€šè¿‡JNIEnvçš„DeleteGlobalRefå‡½æ•°é‡Šæ”¾ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">jclass clazz = env-&gt;<span class="hljs-constructor">GetObjectClass(<span class="hljs-params">classname</span>)</span>;<br>jcalss mClass = (jcalss)env-&gt;<span class="hljs-constructor">NewGlobalRef(<span class="hljs-params">clazz</span>)</span>;<br>env-&gt;<span class="hljs-constructor">DeleteGlobalRef(<span class="hljs-params">mClass</span>)</span><br></code></pre></td></tr></table></figure><h2 id="7-3-å¼±å…¨å±€å¼•ç”¨"><a href="#7-3-å¼±å…¨å±€å¼•ç”¨" class="headerlink" title="7.3 å¼±å…¨å±€å¼•ç”¨"></a>7.3 å¼±å…¨å±€å¼•ç”¨</h2><p>å¼±å…¨å±€å¼•ç”¨æ˜¯ä¸€ç§ç‰¹æ®Šçš„å…¨å±€å¼•ç”¨ï¼Œå®ƒå’Œå…¨å±€å¼•ç”¨çš„ç‰¹ç‚¹ç›¸ä¼¼ï¼Œä½†æ˜¯å¼±å…¨å±€å¼•ç”¨æ˜¯å¯ä»¥è¢«GCå›æ”¶çš„ã€‚å¼±å…¨å±€å¼•ç”¨è¢«GCå›æ”¶ä¹‹åä¼šæŒ‡å‘NULLï¼Œå› æ­¤åœ¨è°ƒç”¨å‰éœ€è¦åˆ¤æ–­å®ƒæ˜¯å¦è¢«å›æ”¶äº†ï¼ˆé€šè¿‡JNIEnvçš„IsSameObjectå‡½æ•°æ¥åˆ¤æ–­ï¼‰ã€‚å¼±å…¨å±€å¼•ç”¨é€šè¿‡JNIEnvçš„NewWeakGlobalRefå‡½æ•°æ¥åˆ›å»ºå¼±å…¨å±€å¼•ç”¨ï¼Œé€šè¿‡JNIEnvçš„DeleteWeakGlobalRefå‡½æ•°é‡Šæ”¾ã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">jclass clazz = env-&gt;<span class="hljs-constructor">GetObjectClass(<span class="hljs-params">classname</span>)</span>;<br>jcalss mClass = (jcalss)env-&gt;<span class="hljs-constructor">NewWeakGlobalRef(<span class="hljs-params">clazz</span>)</span>;<br>env-&gt;<span class="hljs-constructor">DeleteWeakGlobalRef(<span class="hljs-params">mClass</span>)</span><br><span class="hljs-comment">//ä½¿ç”¨æ—¶</span><br><span class="hljs-keyword">if</span>(env-&gt;<span class="hljs-constructor">IsSameObject(<span class="hljs-params">mClass</span>,NULL)</span>)&#123;<br><span class="hljs-comment">//ä¸èƒ½ä½¿ç”¨</span><br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-comment">//å¯ä»¥ä½¿ç”¨</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å…«ã€æ€»ç»“"><a href="#å…«ã€æ€»ç»“" class="headerlink" title="å…«ã€æ€»ç»“"></a>å…«ã€æ€»ç»“</h1><p>JNI æ˜¯ Java å’Œå…¶ä»–è¯­è¨€é€šä¿¡çš„æ¡¥æ¢ã€‚JNI æ³¨å†Œåˆåˆ†ä¸ºé™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œã€‚é™æ€æ³¨å†Œåˆ™æ˜¯åœ¨æ–¹æ³•è¢«è°ƒç”¨æ—¶å°† Java æ–¹æ³•å’ŒJNIå‡½æ•°å»ºç«‹å…³è”ï¼›è€ŒåŠ¨æ€æ³¨å†Œåˆ™æ˜¯åœ¨æ–¹æ³•è¢«è°ƒç”¨å‰å°±ä¾é  JNI_OnLoad æ–¹æ³•å»ºç«‹è”ç³»ã€‚ä½†ä¸ç®¡æ˜¯å“ªç§æ³¨å†Œæ–¹å¼ï¼Œå®ƒä»¬åœ¨ Java å±‚çš„ä»£ç ç¼–å†™éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>Java å±‚èƒ½å¤Ÿè°ƒç”¨ Native å±‚çš„å‡½æ•°ï¼Œé‚£åè¿‡æ¥ä¹ŸåŒæ ·å¯ä»¥ã€‚è¿™éœ€è¦ä¾é  JNIEnv å’Œ JavaVMï¼Œé€šè¿‡ JavaVM è·å–å½“å‰çº¿ç¨‹çš„ JNIEnvï¼Œç„¶åé€šè¿‡è°ƒç”¨ JNIEnv ä¸­çš„ä¸€ç³»åˆ—å‡½æ•°å°±å¯ä»¥è®¿é—®åˆ° Java å±‚çš„ç±»ã€æ–¹æ³•ã€å˜é‡ã€å¯¹è±¡ç­‰ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="http://liuwangshu.cn/framework/jni/1-mediarecorder_register.html">Androidæ·±å…¥ç†è§£JNIï¼ˆä¸€ï¼‰JNIåŸç†ä¸é™æ€ã€åŠ¨æ€æ³¨å†Œ | BATcoder - åˆ˜æœ›èˆ’ (liuwangshu.cn)</a></p><p><a href="https://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/design.html">Design Overview (oracle.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/357885076">Android NDKå¼€å‘â€”â€”é™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>Androidæºç è§£æ</tag>
      
      <tag>JNI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>InMemoryDexClassLoaderåŠ è½½å†…å­˜dexçš„æµç¨‹</title>
    <link href="/2023/12/06/InMemoryDexClassLoader%E5%8A%A0%E8%BD%BD%E5%86%85%E5%AD%98dex%E7%9A%84%E6%B5%81%E7%A8%8B/"/>
    <url>/2023/12/06/InMemoryDexClassLoader%E5%8A%A0%E8%BD%BD%E5%86%85%E5%AD%98dex%E7%9A%84%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>åœ¨ä¹‹å‰åˆ†ædexæ–‡ä»¶åŠ è½½æµç¨‹ä¸­ï¼ˆ<a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%80)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸€)(äºŒ)(ä¸‰)</a>ï¼‰ï¼Œæˆ‘ä»¬åˆ†æè¿‡äº†DexClassLoaderå’ŒPathClassLoaderè¿™ä¸¤ä¸ªç±»åŠ è½½å™¨åŠ è½½dexçš„æµç¨‹ã€‚å®ƒä»¬ä¸¤ä¸ªéƒ½æ˜¯ç”¨æ¥è®°è½½æ–‡ä»¶dexçš„ï¼Œä½†æ˜¯åœ¨Android 8æ–°å¢äº†InMemoryDexClassLoaderï¼Œä¸“é—¨ç”¨äºåŠ è½½å†…å­˜dexï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ ¹æ®æºç æ¥å‰–æå†…å­˜dexçš„åŠ è½½æµç¨‹ã€‚</p><h1 id="äºŒã€InMemoryDexClassLoaderåŠ è½½å†…å­˜dexçš„æµç¨‹"><a href="#äºŒã€InMemoryDexClassLoaderåŠ è½½å†…å­˜dexçš„æµç¨‹" class="headerlink" title="äºŒã€InMemoryDexClassLoaderåŠ è½½å†…å­˜dexçš„æµç¨‹"></a>äºŒã€InMemoryDexClassLoaderåŠ è½½å†…å­˜dexçš„æµç¨‹</h1><h2 id="2-1-InMemoryDexClassLoader"><a href="#2-1-InMemoryDexClassLoader" class="headerlink" title="2.1 InMemoryDexClassLoader"></a>2.1 InMemoryDexClassLoader</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/InMemoryDexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InMemoryDexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Create an in-memory DEX class loader with the given dex buffers.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dexBuffers array of buffers containing DEX files between</span><br><span class="hljs-comment">     *                       &lt;tt&gt;buffer.position()&lt;/tt&gt; and &lt;tt&gt;buffer.limit()&lt;/tt&gt;.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> parent the parent class loader for delegation.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@hide</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InMemoryDexClassLoader</span><span class="hljs-params">(ByteBuffer[] dexBuffers, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexBuffers, parent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InMemoryDexClassLoader</span><span class="hljs-params">(ByteBuffer dexBuffer, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuffer</span>[] &#123; dexBuffer &#125;, parent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>InMemoryDexClassLoaderç»§æ‰¿è‡ªBaseDexClassLoaderï¼Œæ˜¯ä¸“é—¨ç”¨æ¥åŠ è½½å†…å­˜dexçš„ï¼Œ<strong>å…¶ä¸­ç¬¬ä¸€ä¸ªæ„é€ æ–¹æ³•æ¥å—ByteBufferæ•°ç»„ï¼Œå› æ­¤æ˜¯å¯ä»¥æ”¯æŒå¤šdexçš„</strong>ã€‚å®ƒçš„æ–¹æ³•éƒ½åœ¨çˆ¶ç±»ä¸­å®ç°ï¼Œå…¶ä¸­å¯¹åº”çš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Constructs an instance.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * dexFile must be an in-memory representation of a full dexFile.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dexFiles the array of in-memory dex files containing classes.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> parent the parent class loader</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@hide</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(ByteBuffer[] dexFiles, ClassLoader parent)</span> &#123;<br>    <span class="hljs-built_in">super</span>(parent);<br>    <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexFiles);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šåˆ›å»ºä¸€ä¸ªDexPathListå¯¹è±¡ã€‚</p><h2 id="2-2-DexPathListå®ä¾‹åŒ–"><a href="#2-2-DexPathListå®ä¾‹åŒ–" class="headerlink" title="2.2 DexPathListå®ä¾‹åŒ–"></a>2.2 DexPathListå®ä¾‹åŒ–</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">DexPathList</span><span class="hljs-params">(ClassLoader definingContext, ByteBuffer[] dexFiles)</span> &#123;<br>    <span class="hljs-comment">//æ ¡éªŒå‚æ•°</span><br>    <span class="hljs-keyword">if</span> (definingContext == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;definingContext == null&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (dexFiles == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;dexFiles == null&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (Arrays.stream(dexFiles).anyMatch(v -&gt; v == <span class="hljs-literal">null</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;dexFiles contains a null Buffer!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.definingContext = definingContext;<br>    <span class="hljs-comment">// åŠ è½½æœ¬åœ°åº“</span><br>    <span class="hljs-built_in">this</span>.nativeLibraryDirectories = Collections.emptyList();<br>    <span class="hljs-built_in">this</span>.systemNativeLibraryDirectories = splitPaths(System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>), <span class="hljs-literal">true</span>);<br>    <span class="hljs-built_in">this</span>.nativeLibraryPathElements = makePathElements(<span class="hljs-built_in">this</span>.systemNativeLibraryDirectories);<br><br>    ArrayList&lt;IOException&gt; suppressedExceptions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;IOException&gt;();<br>    <span class="hljs-comment">// åŠ è½½dex</span><br>    <span class="hljs-built_in">this</span>.dexElements = makeInMemoryDexElements(dexFiles, suppressedExceptions);<br>    <span class="hljs-keyword">if</span> (suppressedExceptions.size() &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">this</span>.dexElementsSuppressedExceptions =<br>            suppressedExceptions.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>[suppressedExceptions.size()]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        dexElementsSuppressedExceptions = <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®ƒåœ¨è¿™é‡Œè°ƒç”¨çš„æ˜¯<code>makeInMemoryDexElements()</code>æ–¹æ³•ï¼Œè€Œåœ¨DexClassLoaderå’ŒPathClassLoaderæµç¨‹ä¸­ï¼Œè°ƒç”¨çš„æ˜¯<code>makeDexElements()</code>æ–¹æ³•ã€‚</p><h2 id="2-3-makeInMemoryDexElements"><a href="#2-3-makeInMemoryDexElements" class="headerlink" title="2.3 makeInMemoryDexElements()"></a>2.3 makeInMemoryDexElements()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Element[] makeInMemoryDexElements(ByteBuffer[] dexFiles,<br>                                                 List&lt;IOException&gt; suppressedExceptions) &#123;<br>    <span class="hljs-comment">//æ ¹æ®ä¼ å…¥çš„å†…å­˜dexä¸ªæ•°åˆ›å»ºElementå¯¹è±¡</span><br>    Element[] elements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>[dexFiles.length];<br>    <span class="hljs-type">int</span> <span class="hljs-variable">elementPos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//éå†å†…å­˜dexæ•°ç»„</span><br>    <span class="hljs-keyword">for</span> (ByteBuffer buf : dexFiles) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//ç»™å†…å­˜dexåˆ›å»ºDexFileå¯¹è±¡</span><br>            <span class="hljs-type">DexFile</span> <span class="hljs-variable">dex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexFile</span>(buf);<br>            <span class="hljs-comment">//å°†åˆšåˆ›å»ºçš„DexFileå°è£…æˆElementå¯¹è±¡</span><br>            elements[elementPos++] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>(dex);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException suppressed) &#123;<br>            System.logE(<span class="hljs-string">&quot;Unable to load dex file: &quot;</span> + buf, suppressed);<br>            suppressedExceptions.add(suppressed);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (elementPos != elements.length) &#123;<br>        elements = Arrays.copyOf(elements, elementPos);<br>    &#125;<br>    <span class="hljs-keyword">return</span> elements;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯éå†å†…å­˜dexæ•°ç»„ï¼Œç»™æ¯ä¸ªå†…å­˜dexåˆ›å»ºä¸€ä¸ªDexFileå¯¹è±¡ï¼Œå¹¶å°è£…æˆElementå¯¹è±¡ã€‚</p><h2 id="2-4-DexFileå®ä¾‹åŒ–"><a href="#2-4-DexFileå®ä¾‹åŒ–" class="headerlink" title="2.4 DexFileå®ä¾‹åŒ–"></a>2.4 DexFileå®ä¾‹åŒ–</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><br>DexFile(ByteBuffer buf) <span class="hljs-keyword">throws</span> IOException &#123;<br>    mCookie = openInMemoryDexFile(buf);<br>    mInternalCookie = mCookie;<br>    mFileName = <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>openInMemoryDexFile()</code>æ–¹æ³•ï¼Œè¿”å›çš„cookieæ˜¯ç”¨äºæ“ä½œdexæ–‡ä»¶çš„å”¯ä¸€å‡­è¯ï¼Œå¯ä»¥ç†è§£ä¸ºâ€èº«ä»½ç â€ã€‚</p><h2 id="2-5-openInMemoryDexFile"><a href="#2-5-openInMemoryDexFile" class="headerlink" title="2.5 openInMemoryDexFile()"></a>2.5 openInMemoryDexFile()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">openInMemoryDexFile</span><span class="hljs-params">(ByteBuffer buf)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//ByteBuffer.isDirect()ç”¨äºåˆ¤æ–­å½“å‰ç¼“å†²åŒºæ˜¯å¦æ˜¯ç›´æ¥ç¼“å†²åŒº</span><br>    <span class="hljs-keyword">if</span> (buf.isDirect()) &#123;<br>        <span class="hljs-comment">//å•dex</span><br>        <span class="hljs-keyword">return</span> createCookieWithDirectBuffer(buf, buf.position(), buf.limit());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//å¤šdex</span><br>        <span class="hljs-keyword">return</span> createCookieWithArray(buf.array(), buf.position(), buf.limit());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Object <span class="hljs-title function_">createCookieWithDirectBuffer</span><span class="hljs-params">(ByteBuffer buf, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Object <span class="hljs-title function_">createCookieWithArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] buf, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span>;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨ä¸¤ä¸ªnativeå±‚çš„æ–¹æ³•ï¼Œå®ƒä»¬éƒ½åœ¨<code>art/runtime/native/dalvik_system_DexFile.cc</code>ä¸­å®ç°ã€‚</p><h3 id="2-5-1-createCookieWithDirectBuffer"><a href="#2-5-1-createCookieWithDirectBuffer" class="headerlink" title="2.5.1 createCookieWithDirectBuffer()"></a>2.5.1 createCookieWithDirectBuffer()</h3><p><code>createCookieWithDirectBuffer()</code>å¯¹åº”<code>DexFile_createCookieWithDirectBuffer()</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/native/dalvik_system_DexFile.cc</span><br><span class="hljs-function"><span class="hljs-type">static</span> jobject <span class="hljs-title">DexFile_createCookieWithDirectBuffer</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                    jclass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                    jobject buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                    jint start,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                    jint end)</span> </span>&#123;<br>    <span class="hljs-comment">//è·å–èµ·å§‹åœ°å€</span><br>    <span class="hljs-type">uint8_t</span>* base_address = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span>*&gt;(env-&gt;<span class="hljs-built_in">GetDirectBufferAddress</span>(buffer));<br>    <span class="hljs-keyword">if</span> (base_address == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;<br>        <span class="hljs-built_in">ThrowWrappedIOException</span>(<span class="hljs-string">&quot;dexFileBuffer not direct&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><span class="hljs-comment">//åˆ†é…å†…å­˜</span><br>    <span class="hljs-function">std::unique_ptr&lt;MemMap&gt; <span class="hljs-title">dex_mem_map</span><span class="hljs-params">(AllocateDexMemoryMap(env, start, end))</span></span>;<br>    <span class="hljs-keyword">if</span> (dex_mem_map == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">DCHECK</span>(Thread::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">IsExceptionPending</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> length = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">size_t</span>&gt;(end - start);<br>    <span class="hljs-comment">//å¤åˆ¶åˆ°dex_mem_mapä¸­</span><br>    <span class="hljs-built_in">memcpy</span>(dex_mem_map-&gt;<span class="hljs-built_in">Begin</span>(), base_address, length);<br><span class="hljs-comment">//è°ƒç”¨CreateSingleDexFileCookieåˆ›å»ºCookie</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">CreateSingleDexFileCookie</span>(env, std::<span class="hljs-built_in">move</span>(dex_mem_map));<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å°†javaå±‚çš„æ•°æ®è½¬æ¢æˆnativeå±‚çš„æ•°æ®ï¼Œæœ€åè°ƒç”¨<code>CreateSingleDexFileCookie()</code>æ–¹æ³•ã€‚</p><h3 id="2-5-2-createCookieWithArray"><a href="#2-5-2-createCookieWithArray" class="headerlink" title="2.5.2 createCookieWithArray()"></a>2.5.2 createCookieWithArray()</h3><p><code>createCookieWithArray()</code>å¯¹åº”<code>DexFile_createCookieWithArray()</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/native/dalvik_system_DexFile.cc</span><br><span class="hljs-function"><span class="hljs-type">static</span> jobject <span class="hljs-title">DexFile_createCookieWithArray</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             jclass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             jbyteArray buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             jint start,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             jint end)</span> </span>&#123;<br>    <span class="hljs-comment">//åˆ†é…å†…å­˜</span><br>    <span class="hljs-function">std::unique_ptr&lt;MemMap&gt; <span class="hljs-title">dex_mem_map</span><span class="hljs-params">(AllocateDexMemoryMap(env, start, end))</span></span>;<br>    <span class="hljs-keyword">if</span> (dex_mem_map == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">DCHECK</span>(Thread::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">IsExceptionPending</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><span class="hljs-comment">//è·å–dex_mem_mapçš„é¦–åœ°å€</span><br>    <span class="hljs-keyword">auto</span> destination = <span class="hljs-built_in">reinterpret_cast</span>&lt;jbyte*&gt;(dex_mem_map.<span class="hljs-built_in">get</span>()-&gt;<span class="hljs-built_in">Begin</span>());<br>    <span class="hljs-comment">//å¤åˆ¶åˆ°destinationæŒ‡å‘çš„å†…å­˜</span><br>    env-&gt;<span class="hljs-built_in">GetByteArrayRegion</span>(buffer, start, end - start, destination);<br>    <span class="hljs-comment">//è°ƒç”¨CreateSingleDexFileCookieåˆ›å»ºCookie</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">CreateSingleDexFileCookie</span>(env, std::<span class="hljs-built_in">move</span>(dex_mem_map));<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨<code>CreateSingleDexFileCookie()</code>æ–¹æ³•ã€‚</p><h2 id="2-6-CreateSingleDexFileCookie"><a href="#2-6-CreateSingleDexFileCookie" class="headerlink" title="2.6 CreateSingleDexFileCookie()"></a>2.6 CreateSingleDexFileCookie()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/native/dalvik_system_DexFile.cc</span><br><span class="hljs-function"><span class="hljs-type">static</span> jobject <span class="hljs-title">CreateSingleDexFileCookie</span><span class="hljs-params">(JNIEnv* env, std::unique_ptr&lt;MemMap&gt; data)</span> </span>&#123;<br>    <span class="hljs-comment">//è°ƒç”¨CreateDexFile()åˆ›å»ºDexFileå¯¹è±¡</span><br>    <span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">dex_file</span><span class="hljs-params">(CreateDexFile(env, std::move(data)))</span></span>;<br>    <span class="hljs-keyword">if</span> (dex_file.<span class="hljs-built_in">get</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">DCHECK</span>(env-&gt;<span class="hljs-built_in">ExceptionCheck</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-comment">//DexFileæ•°ç»„</span><br>    std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt; dex_files;<br>    <span class="hljs-comment">//å°†åˆšåˆšåˆ›å»ºçš„dex_fileæ”¾å…¥æ•°ç»„ä¸­</span><br>    dex_files.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(dex_file));<br>    <span class="hljs-comment">//è°ƒç”¨ConvertDexFilesToJavaArray()æ–¹æ³•è½¬æˆå¯ä¾›Javaå±‚ä½¿ç”¨çš„æ•°æ®</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ConvertDexFilesToJavaArray</span>(env, <span class="hljs-literal">nullptr</span>, dex_files);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è°ƒç”¨<code>CreateDexFile()</code>æ–¹æ³•ä¸ºå†…å­˜dexåˆ›å»ºDexFileå¯¹è±¡ï¼Œç„¶åç§»å…¥DexFileæ•°ç»„ä¸­ï¼Œæœ€åè°ƒç”¨<code>ConvertDexFilesToJavaArray()</code>æ–¹æ³•å°†DexFileæ•°ç»„è½¬æˆJavaæ•°ç»„ã€‚è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨<code>CreateDexFile()</code>æ–¹æ³•ã€‚</p><h2 id="2-7-CreateDexFile"><a href="#2-7-CreateDexFile" class="headerlink" title="2.7 CreateDexFile()"></a>2.7 CreateDexFile()</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/native/dalvik_system_DexFile.cc</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">const</span> DexFile* <span class="hljs-title">CreateDexFile</span><span class="hljs-params">(JNIEnv* env, std::unique_ptr&lt;MemMap&gt; dex_mem_map)</span> </span>&#123;<br>    <span class="hljs-comment">//StringPrintfæ ¼å¼åŒ–å­—ç¬¦ä¸²</span><br>    std::string location = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Anonymous-DexFile@%p-%p&quot;</span>,<br>                                        dex_mem_map-&gt;<span class="hljs-built_in">Begin</span>(),<br>                                        dex_mem_map-&gt;<span class="hljs-built_in">End</span>());<br>    std::string error_message;<br>    <span class="hljs-comment">//è°ƒç”¨DexFile::Open()åˆ›å»ºDexFileå¯¹è±¡</span><br>    <span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">dex_file</span><span class="hljs-params">(DexFile::Open(location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                          <span class="hljs-number">0</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                          std::move(dex_mem_map),</span></span><br><span class="hljs-params"><span class="hljs-function">                                                          <span class="hljs-comment">/* verify */</span> <span class="hljs-literal">true</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                          <span class="hljs-comment">/* verify_location */</span> <span class="hljs-literal">true</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                          &amp;error_message))</span></span>;<br>    <span class="hljs-keyword">if</span> (dex_file == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;<br>        <span class="hljs-built_in">ThrowWrappedIOException</span>(<span class="hljs-string">&quot;%s&quot;</span>, error_message.<span class="hljs-built_in">c_str</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!dex_file-&gt;<span class="hljs-built_in">DisableWrite</span>()) &#123;<br>        <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;<br>        <span class="hljs-built_in">ThrowWrappedIOException</span>(<span class="hljs-string">&quot;Failed to make dex file read-only&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><span class="hljs-comment">//è°ƒç”¨release()é‡Šæ”¾dex_fileæ‰€æ‹¥æœ‰çš„å†…å­˜</span><br>    <span class="hljs-keyword">return</span> dex_file.<span class="hljs-built_in">release</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è°ƒç”¨<code>DexFile::Open()</code>æ–¹æ³•ï¼Œä¹‹åçš„æµç¨‹å°±è·ŸDexClassLoaderå’ŒPathClassLoaderä¸€æ ·äº†ï¼Œå¯ä»¥è¯¦è§<a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%89)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸‰)</a>ï¼Œæœ¬æ–‡å°±ä¸å†è¯¦ç»†åˆ†æäº†ã€‚</p><h2 id="2-8-DexFile-Open"><a href="#2-8-DexFile-Open" class="headerlink" title="2.8 DexFile::Open()"></a>2.8 DexFile::Open()</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file.cc</span><br><span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">DexFile::Open</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">uint32_t</span> location_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             std::unique_ptr&lt;MemMap&gt; map,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">bool</span> verify,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             std::string* error_msg)</span> </span>&#123;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(std::string(<span class="hljs-string">&quot;Open dex file from mapped-memory &quot;</span>) + location)</span></span>;<br>    <span class="hljs-built_in">CHECK</span>(map.<span class="hljs-built_in">get</span>() != <span class="hljs-literal">nullptr</span>);<br><span class="hljs-comment">//å†…å­˜dexçš„é•¿åº¦ä¸èƒ½å°äºå®ƒçš„dexæ–‡ä»¶å¤´é•¿åº¦</span><br>    <span class="hljs-keyword">if</span> (map-&gt;<span class="hljs-built_in">Size</span>() &lt; <span class="hljs-built_in">sizeof</span>(DexFile::Header)) &#123;<br>        *error_msg = <span class="hljs-built_in">StringPrintf</span>(<br>            <span class="hljs-string">&quot;DexFile: failed to open dex file &#x27;%s&#x27; that is too short to have a header&quot;</span>,<br>            location.<span class="hljs-built_in">c_str</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><span class="hljs-comment">//è°ƒç”¨OpenCommon()åˆ›å»ºDexFile</span><br>    std::unique_ptr&lt;DexFile&gt; dex_file = <span class="hljs-built_in">OpenCommon</span>(map-&gt;<span class="hljs-built_in">Begin</span>(),<br>                                                   map-&gt;<span class="hljs-built_in">Size</span>(),<br>                                                   location,<br>                                                   location_checksum,<br>                                                   kNoOatDexFile,<br>                                                   verify,<br>                                                   verify_checksum,<br>                                                   error_msg);<br>    <span class="hljs-keyword">if</span> (dex_file != <span class="hljs-literal">nullptr</span>) &#123;<br>        dex_file-&gt;mem_map_.<span class="hljs-built_in">reset</span>(map.<span class="hljs-built_in">release</span>());<br>    &#125;<br>    <span class="hljs-keyword">return</span> dex_file;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è°ƒç”¨<code>OpenCommon()</code>æ–¹æ³•ã€‚</p><h2 id="2-9-OpenCommon"><a href="#2-9-OpenCommon" class="headerlink" title="2.9 OpenCommon()"></a>2.9 OpenCommon()</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file.cc</span><br><span class="hljs-function">std::unique_ptr&lt;DexFile&gt; <span class="hljs-title">DexFile::OpenCommon</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* base,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">size_t</span> size,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">uint32_t</span> location_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">const</span> OatDexFile* oat_dex_file,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">bool</span> verify,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             std::string* error_msg,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             VerifyResult* verify_result)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (verify_result != <span class="hljs-literal">nullptr</span>) &#123;<br>        *verify_result = VerifyResult::kVerifyNotAttempted;<br>    &#125;<br>    <span class="hljs-comment">//è°ƒç”¨DexFileçš„æ„é€ æ–¹æ³•çœŸæ­£ä¸ºå†…å­˜dexåˆ›å»ºDexFileå®ä¾‹ï¼Œé‡Œé¢ä¼šè§£ædex</span><br>    <span class="hljs-function">std::unique_ptr&lt;DexFile&gt; <span class="hljs-title">dex_file</span><span class="hljs-params">(<span class="hljs-keyword">new</span> DexFile(base,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  size,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  location_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  oat_dex_file))</span></span>;<br>    <span class="hljs-keyword">if</span> (dex_file == <span class="hljs-literal">nullptr</span>) &#123;<br>        *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Failed to open dex file &#x27;%s&#x27; from memory: %s&quot;</span>, location.<span class="hljs-built_in">c_str</span>(),<br>                                  error_msg-&gt;<span class="hljs-built_in">c_str</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-comment">//æ£€æŸ¥magic</span><br>    <span class="hljs-keyword">if</span> (!dex_file-&gt;<span class="hljs-built_in">Init</span>(error_msg)) &#123;<br>        dex_file.<span class="hljs-built_in">reset</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-comment">//æ£€æŸ¥dexæ–‡ä»¶çš„ç»“æ„</span><br>    <span class="hljs-keyword">if</span> (verify &amp;&amp; !DexFileVerifier::<span class="hljs-built_in">Verify</span>(dex_file.<span class="hljs-built_in">get</span>(),<br>                                           dex_file-&gt;<span class="hljs-built_in">Begin</span>(),<br>                                           dex_file-&gt;<span class="hljs-built_in">Size</span>(),<br>                                           location.<span class="hljs-built_in">c_str</span>(),<br>                                           verify_checksum,<br>                                           error_msg)) &#123;<br>        <span class="hljs-keyword">if</span> (verify_result != <span class="hljs-literal">nullptr</span>) &#123;<br>            *verify_result = VerifyResult::kVerifyFailed;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (verify_result != <span class="hljs-literal">nullptr</span>) &#123;<br>        *verify_result = VerifyResult::kVerifySucceeded;<br>    &#125;<br>    <span class="hljs-keyword">return</span> dex_file;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œä¸ç®¡æ˜¯DexClassLoaderã€PathClassLoaderï¼Œè¿˜æ˜¯InMemoryDexClassLoaderï¼Œå°½ç®¡å®ƒä»¬çš„æµç¨‹å¯èƒ½ä¼šä¸å¤ªä¸€æ ·ï¼Œä½†æœ€ç»ˆéƒ½ä¼šè°ƒç”¨<code>OpenCommon()</code>æ–¹æ³•åˆ›å»ºdexfileï¼Œè€Œä¸”è¯¥æ–¹æ³•çš„å‚æ•°å«æœ‰dexçš„èµ·å§‹åœ°å€ï¼ˆbaseï¼‰å’Œå¤§å°ï¼ˆsizeï¼‰ï¼Œå› æ­¤è¿™é‡Œå¯ä»¥ä½œä¸ºä¸€ä¸ªéå¸¸å¥½çš„è„±å£³ç‚¹ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="http://aospxref.com/android-8.0.0_r36">http://aospxref.com/android-8.0.0_r36</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidæºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¯¹Javaåå°„æ–¹æ³•è¿›è¡Œå°è£…</title>
    <link href="/2023/12/04/%E5%AF%B9Java%E5%8F%8D%E5%B0%84%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E5%B0%81%E8%A3%85/"/>
    <url>/2023/12/04/%E5%AF%B9Java%E5%8F%8D%E5%B0%84%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E5%B0%81%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<p>åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ†æä¸€ä¸‹å°è£…Javaåå°„æ–¹æ³•æ˜¯ä¸ºäº†å¹²ä»€ä¹ˆã€‚</p><p>æ˜¾ç„¶åœ¨<a href="https://gal2xy.github.io/2023/12/01/Android%E7%AC%AC%E4%B8%80%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/">Androidç¬¬ä¸€ä»£åŠ å›ºå£³çš„åŸç†åŠå®ç°</a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬é‡å¤åœ°ä½¿ç”¨åˆ°äº†Javaåå°„æ¥è·å–ç±»ã€å­—æ®µã€æ–¹æ³•ï¼Œæ— ä¸€ä¾‹å¤–ï¼Œè·å–å®ƒä»¬çš„æœ€ç»ˆç›®çš„æ˜¯è·å–å­—æ®µå€¼ã€ä¿®æ”¹å­—æ®µå€¼ã€è°ƒç”¨æ–¹æ³•ã€‚ä¸ºäº†å®ç°è¿™äº›ç›®çš„ï¼Œæˆ‘ä»¬å†™äº†å¾ˆè‡ƒè‚¿çš„ä»£ç ï¼Œå› ä¸ºå¤ªå¤šé‡å¤çš„åå°„è·å–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†è¿™äº›ä»£ç å°è£…èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒåŠ å›ºçš„ä»£ç å°±å¯ä»¥å˜å¾—è½»å·§äº†ï¼Œä¸”è¿™ä¸ªå°è£…ç±»ä»¥åè¿˜å¯ä»¥è¢«é‡å¤åˆ©ç”¨ã€‚</p><p>åˆ†æå®Œäº†å°è£…ç›®çš„ä¹‹åï¼Œæˆ‘ä»¬ä¹Ÿå¾—åˆ°äº†ä¸‰ä¸ªç›®çš„ï¼š</p><ol><li>è·å–å­—æ®µå€¼</li><li>è®¾ç½®å­—æ®µå€¼</li><li>è°ƒç”¨æ–¹æ³•ï¼ˆæ„é€ æ–¹æ³•å’Œéæ„é€ æ–¹æ³•ï¼Œæˆ‘è¿™é‡Œç»Ÿç§°ä¸ºæ–¹æ³•ï¼‰</li></ol><p>å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦é’ˆå¯¹ä»¥ä¸Šç›®çš„ï¼Œåˆ†åˆ«å®ç°å®ƒä»¬å°±è¡Œäº†ã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RefInvoke</span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åå°„è·å–æŒ‡å®šå­—æ®µçš„å€¼</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> className: å®ä¾‹å¯¹åº”çš„ç±»</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> field: æ‰€è¦è·å–å®ä¾‹ä¸­çš„å­—æ®µ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> instanceObj: å®ä¾‹å¯¹è±¡ï¼Œè·å–é™æ€å˜é‡æ—¶è®¾ç½®ä¸ºnull</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldObject</span><span class="hljs-params">(String className, String field, Object instanceObj)</span>&#123;<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            Class&lt;?&gt; aClass = Class.forName(className);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(field);<br>            declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> declaredField.get(instanceObj);<br>            <span class="hljs-keyword">return</span> obj;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åå°„è®¾ç½®æŒ‡å®šå­—æ®µçš„å€¼</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> className: å®ä¾‹å¯¹åº”çš„ç±»</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> field: æ‰€è¦è®¾ç½®å®ä¾‹ä¸­çš„å­—æ®µ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> instanceObj: å®ä¾‹å¯¹è±¡ï¼Œè®¾ç½®é™æ€å˜é‡æ—¶è®¾ç½®ä¸ºnull</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fieldValue: å­—æ®µæ‰€è¦è®¾ç½®æˆçš„å€¼</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldObject</span><span class="hljs-params">(String className, String field, Object instanceObj ,Object fieldValue)</span>&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            Class&lt;?&gt; aClass = Class.forName(className);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(field);<br>            declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>            declaredField.set(instanceObj, fieldValue);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åå°„è°ƒç”¨æŒ‡å®šæ–¹æ³•</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> className: æƒ³è¦è°ƒç”¨çš„æ–¹æ³•æ‰€åœ¨çš„ç±»å</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> methodName: æ‰€è¦è°ƒç”¨æ–¹æ³•çš„æ–¹æ³•å</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> paramTypes: æ‰€è¦è°ƒç”¨æ–¹æ³•çš„å‚æ•°ç±»å‹æ•°ç»„ï¼Œå¤–éƒ¨å¯é€šè¿‡åŒ¿åæ•°ç»„ä¼ å…¥new Class[]&#123;paramTypes that the method need&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> instanceObj: ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œè°ƒç”¨é™æ€é™æ€æ–¹æ³•æ—¶è®¾ç½®ä¸ºnull</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> paramValues: è°ƒç”¨æ–¹æ³•æ—¶æ‰€è¦ä¼ å…¥çš„å…·ä½“å‚æ•°å€¼ï¼Œå¤–éƒ¨å¯é€šè¿‡åŒ¿åæ•°ç»„ä¼ å…¥new Obj[]&#123;paramValues that the method need&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">invokeMethod</span><span class="hljs-params">(String className, String methodName, Class[] paramTypes, Object instanceObj , Object[] paramValues)</span>&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            Class&lt;?&gt; aClass = Class.forName(className);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">declaredMethod</span> <span class="hljs-operator">=</span> aClass.getDeclaredMethod(methodName, paramTypes);<br>            declaredMethod.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> declaredMethod.invoke(instanceObj, paramValues);<br>            <span class="hljs-keyword">return</span> obj;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åå°„è°ƒç”¨æŒ‡å®šæ„é€ æ–¹æ³•æ¥åˆ›å»ºå¯¹è±¡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> className:</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> paramTypes:</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> paramValues:</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">creatObject</span><span class="hljs-params">(String className, Class[] paramTypes,Object[] paramValues)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class&lt;?&gt; aClass = Class.forName(className);<br>            Constructor&lt;?&gt; declaredConstructor = aClass.getDeclaredConstructor(paramTypes);<br>            declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> declaredConstructor.newInstance(paramValues);<br>            <span class="hljs-keyword">return</span> obj;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (InstantiationException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><hr><p>å†™å®Œè¿™ä¸ªä¹‹åï¼Œæˆ‘ä¹Ÿæ˜ç™½äº†ä¹‹å‰å†™åŠ å›ºä»£ç æ—¶çš„ä¸€ä¸ªé—®é¢˜ï¼šä¸ºåœ¨è·å–<code>ActivityThread</code>å®ä¾‹æ—¶ï¼ˆ<code>get()</code>ã€<code>invoke()</code>ï¼‰ï¼Œå‚æ•°å¯¹è±¡è®¾ç½®ä¸ºnulläº†ã€‚</p><p>å› ä¸ºé™æ€æ–¹æ³•ã€é™æ€å­—æ®µï¼Œè¿™äº›å¯ä»¥é€šè¿‡ç±»åç‚¹å‡ºæ¥ï¼Œä¸éœ€è¦ç±»çš„å®ä¾‹ä¹Ÿèƒ½æ“ä½œå®ƒä»¬ã€‚ï¼ˆJavaå­¦è‰ºä¸ç²¾ğŸ˜­ï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaåå°„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…³äºä¸€ä»£å£³çš„ä¸€äº›ç†è§£</title>
    <link href="/2023/12/02/%E5%85%B3%E4%BA%8E%E4%B8%80%E4%BB%A3%E5%A3%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/"/>
    <url>/2023/12/02/%E5%85%B3%E4%BA%8E%E4%B8%80%E4%BB%A3%E5%A3%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>æƒ³è§£é‡Šä¸€ä¸‹ä¸€ä»£å£³çš„è„±å£³ä»£ç ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼Œä»¥åŠä¸€äº›ä»£ç ä¸­çš„ç»†èŠ‚ï¼Œ<strong>è§£é‡Šå…¨åœ¨ä»£ç æ³¨é‡Šä¸­ï¼ï¼ï¼</strong></p><p>æ€ç»´æœ‰ç‚¹ä¹±ï¼Œå¯èƒ½æœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œçƒ¦è¯·å‘ŠçŸ¥ï¼Œè°¢è°¢ï¼</p><hr><p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥çœ‹<code>handleBindApplication()</code>ï¼Œæƒ³è¦è¯¦ç»†è·Ÿè¸ªApplicationçš„åˆ›å»ºè¯·é˜…è¯»<a href="https://gal2xy.github.io/2023/11/27/Android%E4%B8%ADApplication%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B/">Androidä¸­Applicationçš„åˆ›å»ºæµç¨‹</a>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(AppBindData data)</span> &#123;<br>    ...<br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment">    è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨åŠ å£³æ—¶ï¼Œåœ¨attachBaseContext()æ–¹æ³•ä¸­æ›¿æ¢classLoaderæ—¶ï¼Œå¯ä»¥å€ŸåŠ©mBoundApplicationè·å–loadedApkå®ä¾‹ï¼Œ</span><br><span class="hljs-comment">    è¿™æ˜¯å› ä¸ºmBoundApplication.infoå°±åŒ…å«åˆ›å»ºå¥½çš„loadedApkå®ä¾‹ï¼Œ</span><br><span class="hljs-comment">    ä¸”åœ¨è¿è¡ŒmakeApplication()æ–¹æ³•å‰å°±èµ‹å€¼å¥½äº†ï¼ˆè¿›ä¸€æ­¥è¯´ï¼Œæ˜¯è°ƒç”¨Applicationçš„attachBaseContext()ä¹‹å‰ï¼‰ï¼Œ</span><br><span class="hljs-comment">    å°±ä¸ä¼šå­˜åœ¨ä¸ºç©ºçš„æƒ…å†µï¼Œè€ŒmInitialApplicationä¾‹å¤–ã€‚</span><br><span class="hljs-comment">    */</span><br>    mBoundApplication = data;<br>    ...<br>    <span class="hljs-comment">/* åˆ›å»ºå¹¶è·å–å£³ç¨‹åºçš„LoadedApkå¯¹è±¡ */</span><br>    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);<br>...<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, data.info);<br>    ...<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        æ­¤å¤„data.infoæŒ‡LoadedApk</span><br><span class="hljs-comment">        makeApplication()é‡Œé¢ä¼šè°ƒç”¨attachBaseContext()æ–¹æ³•</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> data.info.makeApplication(data.restrictedBackupMode, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        è¿™é‡Œå°†å£³Applicationå®ä¾‹èµ‹å€¼åˆ°ActivityThreadå®ä¾‹çš„mInitialApplicationå­—æ®µ</span><br><span class="hljs-comment">        è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸åœ¨attachBaseContext()æ–¹æ³•æ›¿æ¢Applicationå®ä¾‹ï¼Œ</span><br><span class="hljs-comment">        å› ä¸ºå°±ç®—ä½ æ›¿æ¢äº†ï¼Œåé¢å£³ç¨‹åºæ‰§è¡Œå®Œä¸Šé¢çš„makeApplication()æ–¹æ³•åï¼ˆåŒ…æ‹¬attachBaseContext()æ–¹æ³•ï¼‰ï¼Œ</span><br><span class="hljs-comment">        è¿”å›åˆ°å½“å‰æ–¹æ³•ï¼Œç„¶åå°†å£³Applicationå®ä¾‹èµ‹å€¼ç»™mInitialApplicationå­—æ®µ</span><br><span class="hljs-comment">        è¿™æ ·å°±ç›´æ¥æ›¿æ¢äº†æˆ‘ä»¬çš„æºApplicationå®ä¾‹</span><br><span class="hljs-comment">        ï¼ˆæˆ‘å°è¯•äº†ä¸€ä¸‹è¿™ä¹ˆåšï¼Œç¨‹åºæ­£å¸¸æ‰§è¡Œäº†,æ˜¯æºç¨‹åºå¤ªç®€å•çš„ç¼˜æ•…?ï¼‰</span><br><span class="hljs-comment">        </span><br><span class="hljs-comment">        ç”±äºActivityThreadå®ä¾‹çš„mInitialApplicationå­—æ®µä¸æ˜¯åœ¨makeApplication()ä¸­èµ‹å€¼çš„</span><br><span class="hljs-comment">    æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç»™mInitialApplicationå­—æ®µå­—æ®µèµ‹å€¼æºç¨‹åºApplicationã€‚</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    å¦å¤–è¯·æ³¨æ„ï¼Œåœ¨åŠ å£³æ—¶ï¼Œåœ¨attachBaseContext()æ–¹æ³•ä¸­ä¸è¦é€šè¿‡mInitialApplicationè·å–loadedApkå®ä¾‹ï¼Œå› ä¸ºæ­¤æ—¶</span><br><span class="hljs-comment">    ä»£ç é€»è¾‘è¿˜åœ¨ä¸Šé¢çš„makeApplication()ä¸­ï¼Œä¸‹é¢çš„mInitialApplication = app;æ˜¯æ²¡æœ‰è¢«æ‰§è¡Œçš„ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ</span><br><span class="hljs-comment">    æˆ‘ä»¬è·å–çš„mInitialApplicationæ˜¯ç©ºçš„ï¼è€Œåº”è¯¥é€šè¿‡mBoundApplicationè·å–ï¼</span><br><span class="hljs-comment">        */</span><br>        mInitialApplication = app;<br>        ...<br>        <span class="hljs-keyword">try</span> &#123;<br>            mInstrumentation.onCreate(data.instrumentationArgs);<br>        &#125;<br>        ...<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            callApplicationOnCreate()æ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨Applicationçš„onCreate()æ–¹æ³•</span><br><span class="hljs-comment">            è€ŒmakeApplication()æ–¹æ³•é‡Œé¢ä¼šè°ƒç”¨Applicationçš„attachBaseContext()æ–¹æ³•</span><br><span class="hljs-comment">            æ ¹æ®æµç¨‹å¯ä»¥çŸ¥é“ï¼šApplicationçš„attachBaseContext()æ–¹æ³•æ‰§è¡Œæ—¶é—´æ—©äºonCreate()æ–¹æ³•</span><br><span class="hljs-comment">            </span><br><span class="hljs-comment">            å› ä¸ºè¿™é‡Œæ˜¯å¿…èµ°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è°ƒç”¨makeApplication()æ–¹æ³•åˆ›å»ºæºç¨‹åºApplicationå®ä¾‹æ—¶ï¼Œ</span><br><span class="hljs-comment">            è®¾ç½®ç¬¬äºŒä¸ªå‚æ•°ä¸ºnullï¼Œè¿™æ ·åœ¨makeApplication()æ–¹æ³•å°±ä¸ä¼šè°ƒç”¨callApplicationOnCreate()</span><br><span class="hljs-comment">            å¦åˆ™é‡Œé¢è°ƒç”¨äº†ï¼Œå¤–é¢å†è°ƒç”¨å°±ä¼šæŠ›å¼‚å¸¸</span><br><span class="hljs-comment">            å½“ç„¶ä¹Ÿå¯ä»¥ç®€å•ç†è§£ï¼Œæ¯•ç«Ÿæºç ä¸­è°ƒç”¨makeApplication()éƒ½è®¾ç½®ç¬¬äºŒä¸ªå‚æ•°ä¸ºnullï¼Œç…§æŠ„è‚¯å®šä¸ä¼šé”™ã€‚</span><br><span class="hljs-comment">            */</span><br>            mInstrumentation.callApplicationOnCreate(app);<br>        &#125; <br>        ...<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹<code>makeApplication()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="hljs-keyword">public</span> Application <span class="hljs-title function_">makeApplication</span><span class="hljs-params">(<span class="hljs-type">boolean</span> forceDefaultAppClass,</span><br><span class="hljs-params">                                   Instrumentation instrumentation)</span> &#123;<br>    <span class="hljs-comment">//è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦å…ˆç½®mApplicationä¸ºnullï¼Œå¦è€…è°ƒç”¨äº†ä¹Ÿä¸ä¼šåˆ›å»ºæºAPKçš„Application</span><br>    <span class="hljs-keyword">if</span> (mApplication != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> mApplication;<br>    &#125;<br><br>    <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">åˆ›å»ºApplicationçš„å®ä¾‹éœ€è¦ç±»åæ‰èƒ½åå°„</span><br><span class="hljs-comment">æ˜¾ç„¶mApplicationInfoæŒ‡çš„æ˜¯å£³ç¨‹åºçš„Applicationç±»åï¼Œ</span><br><span class="hljs-comment">æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¿®æ”¹LoadedApkå®ä¾‹ä¸­çš„mApplicationInfo.classNameçš„å€¼ä¸ºæºç¨‹åºApplicationç±»å </span><br><span class="hljs-comment">*/</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">appClass</span> <span class="hljs-operator">=</span> mApplicationInfo.className;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆéœ€è¦å…ˆæ›¿æ¢ClassLoaderå†æ›¿æ¢Application</span><br><span class="hljs-comment">        å› ä¸ºåˆ›å»ºApplicationéœ€è¦ClassLoaderï¼ŒClassLoaerä¸å¯¹é‚£è‚¯å®šåˆ›å»ºå¤±è´¥</span><br><span class="hljs-comment">        */</span><br>        java.lang.<span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> getClassLoader();<br>        ...<br>        <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(mActivityThread, <span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        é‡Œé¢ä¼šè°ƒç”¨attachBaseContext()æ–¹æ³•</span><br><span class="hljs-comment">        */</span><br>        app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext);<br>        appContext.setOuterContext(app);<br>    &#125; <br>    ...<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ·»åŠ åˆ°ActivityThreadå®ä¾‹çš„mAllApplicationsæ•°ç»„ä¸­</span><br><span class="hljs-comment">    æ‰€ä»¥éœ€è¦å°†å£³ç¨‹åºçš„Applicationä»mAllApplicationsæ•°ç»„ä¸­åˆ é™¤</span><br><span class="hljs-comment">    */</span><br>    mActivityThread.mAllApplications.add(app);<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    è¿™é‡Œæ˜¯èµ‹å€¼ç»™LoadedApkå®ä¾‹çš„mApplicationå­—æ®µï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æ‰‹</span><br><span class="hljs-comment">    åŠ¨ä¿®æ”¹LoadedApkå®ä¾‹çš„mApplicationå­—æ®µçš„å€¼ã€‚</span><br><span class="hljs-comment">    */</span><br>    mApplication = app;<br><br>    <span class="hljs-comment">/*ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°instrumentationä¸ºnullï¼Œä¸èµ°è¿™é‡Œ*/</span><br>    <span class="hljs-keyword">if</span> (instrumentation != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            instrumentation.callApplicationOnCreate(app);<br>        &#125;<br>        ...<br>    &#125;<br>    ...<br>    <span class="hljs-keyword">return</span> app;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹<code>getPackageInfoNoCheck()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> LoadedApk <span class="hljs-title function_">getPackageInfoNoCheck</span><span class="hljs-params">(ApplicationInfo ai, CompatibilityInfo compatInfo)</span> &#123;<br>    <span class="hljs-keyword">return</span> getPackageInfo(ai, compatInfo, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-keyword">private</span> LoadedApk <span class="hljs-title function_">getPackageInfo</span><span class="hljs-params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span><br><span class="hljs-params">                                 ClassLoader baseLoader, <span class="hljs-type">boolean</span> securityViolation, <span class="hljs-type">boolean</span> includeCode,</span><br><span class="hljs-params">                                 <span class="hljs-type">boolean</span> registerPackage)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">differentUser</span> <span class="hljs-operator">=</span> (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));<br>    <span class="hljs-keyword">synchronized</span> (mResourcesManager) &#123;<br>        WeakReference&lt;LoadedApk&gt; ref;<br>        <span class="hljs-comment">// æ ¹æ®ä¸åŒçš„æƒ…å†µè·å–ç¼“å­˜çš„LoadedApkå¯¹è±¡</span><br>        ...<br><br>        <span class="hljs-type">LoadedApk</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span> ref != <span class="hljs-literal">null</span> ? ref.get() : <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (packageInfo == <span class="hljs-literal">null</span> || (packageInfo.mResources != <span class="hljs-literal">null</span> &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) &#123;<br>            ...<br>            <span class="hljs-comment">//åˆ›å»ºLoadedApkå¯¹è±¡</span><br>            packageInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadedApk</span>(<span class="hljs-built_in">this</span>, aInfo, compatInfo, baseLoader,<br>                              securityViolation, includeCode &amp;&amp;<br>                              (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="hljs-number">0</span>, registerPackage);<br><br>            <span class="hljs-keyword">if</span> (mSystemThread &amp;&amp; <span class="hljs-string">&quot;android&quot;</span>.equals(aInfo.packageName)) &#123;<br>                packageInfo.installSystemApplicationInfo(aInfo,<br>                                                         getSystemContext().mPackageInfo.getClassLoader());<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (differentUser) &#123;<br>                <span class="hljs-comment">// Caching not supported across users</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (includeCode) &#123;<br>                <span class="hljs-comment">/*æ›´æ–°mPackagesï¼Œå³å°†åˆšåˆ›å»ºçš„packageInfoåŠ å…¥</span><br><span class="hljs-comment">                  è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥é€šè¿‡ActivityThreadå®ä¾‹ä¸­çš„mPackageså­—æ®µè·å–loadedApkå®ä¾‹ï¼Œ</span><br><span class="hljs-comment">                  å› ä¸ºåœ¨è¿è¡ŒmakeApplication()ä¹‹å‰ï¼ˆè¿›ä¸€æ­¥è¯´ï¼Œæ˜¯è°ƒç”¨Applicationçš„attachBaseContext()ä¹‹å‰ï¼‰ï¼Œ</span><br><span class="hljs-comment">                  å°±å·²ç»å°†åˆ›å»ºå¥½çš„loadedApkå®ä¾‹åŠ å…¥åˆ°mPackagesä¸­äº†ã€‚</span><br><span class="hljs-comment">                */</span><br>                mPackages.put(aInfo.packageName,<br>                              <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;LoadedApk&gt;(packageInfo));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                mResourcePackages.put(aInfo.packageName,<br>                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;LoadedApk&gt;(packageInfo));<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> packageInfo;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AndroidåŠ å›º</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidç¬¬ä¸€ä»£åŠ å›ºå£³çš„åŸç†åŠå®ç° â€”â€” è½åœ°åŠ è½½</title>
    <link href="/2023/12/01/Android%E7%AC%AC%E4%B8%80%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/12/01/Android%E7%AC%AC%E4%B8%80%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>å­¦ä¹ åŠ å£³ä¹‹å‰ï¼Œå»ºè®®å…ˆæŠŠå‰ç½®çŸ¥è¯†å­¦ä¹ å†è¯´ã€‚æˆ‘ä»¬éœ€è¦å…ˆå­¦ä¹ dexæ–‡ä»¶ç»“æ„ã€javaåå°„ã€Androidä¸­çš„ClassLoaderã€Applicationä»¥åŠå®ƒçš„åŠ è½½æµç¨‹ã€Appå¯åŠ¨æµç¨‹ã€‚</p><p>ä¸ç„¶æˆ‘çœŸä¸å»ºè®®ç›´æ¥è½å®ƒï¼Œä¸æ‡‚åŸç†åªèƒ½å­¦åˆ°çš®æ¯›ï¼</p><h1 id="äºŒã€ç¬¬ä¸€ä»£åŠ å›ºå£³åŸç†"><a href="#äºŒã€ç¬¬ä¸€ä»£åŠ å›ºå£³åŸç†" class="headerlink" title="äºŒã€ç¬¬ä¸€ä»£åŠ å›ºå£³åŸç†"></a>äºŒã€ç¬¬ä¸€ä»£åŠ å›ºå£³åŸç†</h1><p>ç¬¬ä¸€ä»£åŠ å›ºå£³åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012216295.png"></p><p>åœ¨å›¾ä¸­æ¶‰åŠåˆ°ä¸‰ä¸ªç¨‹åºï¼š</p><ol><li>å¾…åŠ å£³ç¨‹åºçš„APKï¼ˆæºç¨‹åºAPKï¼‰</li><li>ï¼ˆè„±ï¼‰å£³ç¨‹åºAPKï¼ˆè´Ÿè´£è§£å¯†æºç¨‹åºAPKå¹¶åŠ è½½è¿è¡Œå®ƒï¼‰</li><li>åŠ å£³ç¨‹åºï¼ˆå°†æºç¨‹åºAPKè¿›è¡ŒåŠ å¯†å¹¶ä¸å£³ç¨‹åºçš„dexåˆå¹¶æˆæ–°çš„dexï¼‰ã€‚</li></ol><p>ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆåˆ©ç”¨åŠ å¯†ç®—æ³•å¯¹æºç¨‹åºAPKè¿›è¡ŒåŠ å¯†ï¼Œç„¶åä¸è„±å£³ç¨‹åºAPKåˆå¹¶å¾—åˆ°æ–°çš„dexæ–‡ä»¶ï¼Œæœ€åæ›¿æ¢è„±å£³ç¨‹åºä¸­çš„dexæ–‡ä»¶å³å¯ã€‚ä¹‹åè¿è¡Œåˆå¹¶åçš„ç¨‹åºæ—¶ï¼Œä¼šé€šè¿‡å£³ç¨‹åºå¯¹æºç¨‹åºè¿›è¡Œè§£å¯†å’Œè¿è¡Œæ—¶åŠ è½½ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæºç¨‹åºå°±èƒ½æ­£å¸¸è¿è¡Œã€‚åˆå¹¶ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012216659.png"></p><p>å­¦è¿‡dexæ–‡ä»¶ç»“æ„åï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼šå¯¹äºåˆå¹¶åçš„dexæ–‡ä»¶ï¼Œéœ€è¦ä¿®æ”¹å…¶dex_headerä¸­çš„ä¸‰ä¸ªå­—æ®µï¼š</p><ol><li>checksumï¼šdexæ–‡ä»¶ï¼ˆé™¤ <code>magic</code>ã€<code>checksum</code>ï¼‰çš„æ ¡éªŒå’Œï¼ˆä½¿ç”¨adler32ç®—æ³•ï¼‰ï¼Œé€šè¿‡å®ƒæ¥åˆ¤æ–­dexæ–‡ä»¶æ˜¯å¦è¢«æŸåæˆ–ç¯¡æ”¹ã€‚</li><li>signatureï¼šdexæ–‡ä»¶ï¼ˆé™¤ <code>magic</code>ã€<code>checksum</code> å’Œ<code>signature</code>ä¹‹å¤–çš„æ‰€æœ‰å†…å®¹ï¼‰çš„ SHA-1 ç­¾åï¼ˆå“ˆå¸Œï¼‰ï¼Œç”¨äºå¯¹æ–‡ä»¶è¿›è¡Œå”¯ä¸€æ ‡è¯†ã€‚</li><li>file_sizeï¼šæ•´ä¸ªdexæ–‡ä»¶çš„å¤§å°ã€‚</li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡æ¡ˆä¾‹æ¥æ·±å…¥å­¦ä¹ ä¸€ä¸‹ã€‚</p><h1 id="ä¸‰ã€æ¡ˆä¾‹"><a href="#ä¸‰ã€æ¡ˆä¾‹" class="headerlink" title="ä¸‰ã€æ¡ˆä¾‹"></a>ä¸‰ã€æ¡ˆä¾‹</h1><h2 id="3-1-æºç¨‹åºAPK"><a href="#3-1-æºç¨‹åºAPK" class="headerlink" title="3.1 æºç¨‹åºAPK"></a>3.1 æºç¨‹åºAPK</h2><p>éšä¾¿æ¥ä¸€ä¸ªç®€å•çš„apkã€‚<code>activity_main.xml</code>æ–‡ä»¶ä¸­ç®€ç®€å•å•å¡«ä¸€ä¸ªtextviewæ§ä»¶å±•ç¤ºæ–‡å­—å³å¯ã€‚MainActivityä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;demo&quot;</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        Log.d(TAG, <span class="hljs-string">&quot;SourceMainActivity onCreate: &quot;</span> + getApplicationContext());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦å¤–éœ€è¦ä¸€ä¸ªApplicationç±»ï¼ˆä¸éœ€è¦åœ¨æºç¨‹åºçš„<code>ActivityManifest.xml</code>æ–‡ä»¶ä¸­æ³¨å†Œï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;demo&quot;</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate();<br>        Log.d(TAG, <span class="hljs-string">&quot;SourceApk onCreate: &quot;</span> + <span class="hljs-built_in">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰Applicationç±»å‘¢ï¼Ÿ</p><p>å…¶å®Applicationå³ä½¿ä¸åˆ›å»ºï¼Œç³»ç»Ÿä¹Ÿä¼šå¸®æˆ‘ä»¬åˆ›å»ºçš„ã€‚ä½†æ˜¯åˆ›å»ºè‡ªå®šä¹‰Applicationç±»æ˜¯ä¸ºäº†æ–¹ä¾¿åå°„è·å–Applicationç±»ï¼Œè¿›è€Œåˆ›å»ºæºç¨‹åºçš„Applicationå®ä¾‹æ¥æ›¿æ¢åŸæœ‰çš„å£³ç¨‹åºçš„Applicationå®ä¾‹ã€‚</p><h2 id="3-2-åŠ å£³ç¨‹åº"><a href="#3-2-åŠ å£³ç¨‹åº" class="headerlink" title="3.2 åŠ å£³ç¨‹åº"></a>3.2 åŠ å£³ç¨‹åº</h2><p>æ ¹æ®åŠ å£³æµç¨‹ï¼Œå¾ˆå®¹æ˜“å®ç°è¿™éƒ¨åˆ†ï¼Œä¸»è¦åŠŸèƒ½æ˜¯åŠ å¯†æºç¨‹åºAPKã€åˆå¹¶æˆæ–°çš„dexæ–‡ä»¶ã€ä¿®æ­£ä¸‰ä¸ªå­—æ®µã€‚è¿™é‡Œæˆ‘è§‰å¾—ç”¨pythonæ¥å®ç°æ›´ç®€ä¾¿ç‚¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> zlib <span class="hljs-keyword">import</span> adler32<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha1<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> unhexlify<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixCheckSum</span>(<span class="hljs-params">dexBytesArray</span>):<br>    <span class="hljs-comment"># dexfile[8:12]</span><br>    <span class="hljs-comment"># å°ç«¯å­˜å‚¨</span><br>    value = adler32(<span class="hljs-built_in">bytes</span>(dexBytesArray[<span class="hljs-number">12</span>:]))<br>    valueArray = <span class="hljs-built_in">bytearray</span>(value.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(valueArray)):<br>        dexBytesArray[<span class="hljs-number">8</span> + i] = valueArray[i]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixSignature</span>(<span class="hljs-params">dexBytesArray</span>):<br>    <span class="hljs-comment"># dexfile[12:32]</span><br>    sha_1 = sha1()<br>    sha_1.update(<span class="hljs-built_in">bytes</span>(dexBytesArray[<span class="hljs-number">32</span>:]))<br>    value = sha_1.hexdigest()<br>    valueArray = <span class="hljs-built_in">bytearray</span>(unhexlify(value))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(valueArray)):<br>        dexBytesArray[<span class="hljs-number">12</span> + i] = valueArray[i]<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixFileSize</span>(<span class="hljs-params">dexBytesArray, fileSize</span>):<br>    <span class="hljs-comment"># dexfile[32:36]</span><br>    <span class="hljs-comment"># å°ç«¯å­˜å‚¨</span><br>    fileSizeArray = <span class="hljs-built_in">bytearray</span>(fileSize.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;little&quot;</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(fileSizeArray)):<br>        dexBytesArray[<span class="hljs-number">32</span> + i] = fileSizeArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypto</span>(<span class="hljs-params">file</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(file)):<br>        file[i] ^= <span class="hljs-number">0xff</span><br><br>    <span class="hljs-keyword">return</span> file<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-comment"># è¯»å–æºç¨‹åºapk, è½¬æˆbyteæ•°ç»„ï¼Œæ–¹ä¾¿åç»­ä¿®æ”¹</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;SourceApk.apk&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        SourceApkArray = <span class="hljs-built_in">bytearray</span>(f.read())<br>    <span class="hljs-comment"># è¯»å–å£³ç¨‹åºdex</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;shellApk.dex&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        shellDexArray = <span class="hljs-built_in">bytearray</span>(f.read())<br><br>    SourceApkLen = <span class="hljs-built_in">len</span>(SourceApkArray)<br>    shellDexLen = <span class="hljs-built_in">len</span>(shellDexArray)<br>    <span class="hljs-comment"># æ–°çš„dexæ–‡ä»¶é•¿åº¦</span><br>    newDexLen = shellDexLen + SourceApkLen + <span class="hljs-number">4</span><br>    <span class="hljs-comment"># åŠ å¯†æºæ–‡ä»¶</span><br>    enApkArray = encrypto(SourceApkArray)<br>    <span class="hljs-comment"># æ–°çš„dexæ–‡ä»¶å†…å®¹ = å£³dex + åŠ å¯†çš„æºapk + å››å­—èŠ‚æ ‡è¯†åŠ å¯†åæºapkå¤§å°é•¿åº¦</span><br>    newDexArray = shellDexArray + enApkArray + <span class="hljs-built_in">bytearray</span>(SourceApkLen.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br><br>    <span class="hljs-comment"># é¦–å…ˆä¿®æ”¹filesize</span><br>    fixFileSize(newDexArray, newDexLen)<br>    <span class="hljs-comment"># å…¶æ¬¡ä¿®æ”¹signature</span><br>    fixSignature(newDexArray)<br>    <span class="hljs-comment"># æœ€åä¿®æ”¹checksum</span><br>    fixCheckSum(newDexArray)<br><br>    <span class="hljs-comment"># å¯¼å‡ºæ–‡ä»¶</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;classes.dex&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(<span class="hljs-built_in">bytes</span>(newDexArray))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    start()<br></code></pre></td></tr></table></figure><h2 id="3-3-è„±å£³ç¨‹åº"><a href="#3-3-è„±å£³ç¨‹åº" class="headerlink" title="3.3 è„±å£³ç¨‹åº"></a>3.3 è„±å£³ç¨‹åº</h2><h3 id="3-3-1-å…ˆåˆ†æä¸€æ³¢"><a href="#3-3-1-å…ˆåˆ†æä¸€æ³¢" class="headerlink" title="3.3.1 å…ˆåˆ†æä¸€æ³¢"></a>3.3.1 å…ˆåˆ†æä¸€æ³¢</h3><p>è¿™éƒ¨åˆ†ç†è§£èµ·æ¥å¾ˆéš¾ä¹Ÿæ˜¯æ•´ä¸ªé¡¹ç›®æœ€å…³é”®çš„éƒ¨åˆ†ï¼</p><p>è¿™éƒ¨åˆ†ä¸»è¦æ˜¯åœ¨å£³Applicationç±»ä¸­åšå¦‚ä¸‹äº‹æƒ…ï¼š</p><ol><li>åˆ›å»ºæºç¨‹åºçš„DexClassLoaderå®ä¾‹æ›¿æ¢LoadedApkä¸­çš„mClassLoaderã€‚</li><li>åˆ›å»ºæºç¨‹åºçš„Applicationå®ä¾‹æ›¿æ¢å£³ç¨‹åºçš„Applicationå®ä¾‹ã€‚</li></ol><p>æ¥ä¸‹æ¥å°±è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™ä¹ˆåšã€‚</p><ol><li><p>ä¸ºä»€ä¹ˆè¦æ›¿æ¢LoadedApkä¸­çš„mClassLoaderï¼Ÿ</p><p>å› ä¸ºæˆ‘ä»¬çš„æºç¨‹åºè‚¯å®šæ˜¯è¦ä¾é ClassLoaderåŠ¨æ€åŠ è½½çš„ï¼Œè€ŒClassLoaderå­˜æ”¾äº†åº”ç”¨æ‰€éœ€çš„ç±»åº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gradle">dalvik.system.DexClassLoader[<br>DexPathList[<br>[zip <span class="hljs-keyword">file</span> <span class="hljs-string">&quot;/data/user/0/com.example.shellapk/app_payload_dex/Source.apk&quot;</span>],<br>nativeLibraryDirectories<br>= [<span class="hljs-regexp">/data/u</span>ser<span class="hljs-regexp">/0/</span>com.example.shellapk<span class="hljs-regexp">/app_payload_lib, /</span>system<span class="hljs-regexp">/lib64, /</span>product/lib64]<br>]<br>]<br></code></pre></td></tr></table></figure><p>å½“éœ€è¦åŠ è½½æŸäº›ç±»æ—¶ï¼Œå°±ä¼šå¼€å§‹åŒäº²å§”æ‰˜æ¨¡å¼å¯»æ‰¾ï¼Œè€Œçˆ¶ç±»åŠ è½½å™¨ä»¥åŠç¥–å…ˆåŠ è½½å™¨é‡Œé¢è‚¯å®šæ˜¯æ²¡æœ‰æºç¨‹åºæ‰€éœ€è¦çš„ç±»çš„ï¼Œå› è€Œä¹Ÿä¸å¯èƒ½åŠ è½½æˆåŠŸï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„DexClassLoaderæ¥æ›¿æ¢å£³ç¨‹åºçš„ClassLoaderï¼Œç”±äºé‡Œé¢åŒ…å«æºç¨‹åºçš„ç±»ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±å¯ä»¥æˆåŠŸåŠ è½½æºç¨‹åºã€‚</p></li><li><p>æ€ä¹ˆæ›¿æ¢LoadedApkä¸­çš„mClassLoaderï¼Ÿ</p><p>è‡³äºæ€ä¹ˆæ›¿æ¢ï¼Œå°±æœ‰å¥½å‡ ç§æ–¹æ³•äº†ï¼Œä¾‹å¦‚ï¼š</p><ul><li><p>æ›¿æ¢ç±»åŠ è½½å™¨</p><p>æ›¿æ¢å£³ç¨‹åºçš„ClassLoaderä¸ºæºç¨‹åºçš„DexClassLoaderï¼ŒåŒæ—¶è®¾ç½®æºç¨‹åºçš„DexClassLoaderçš„çˆ¶åŠ è½½å™¨ä¸ºå£³ç¨‹åºçš„ClassLoaderçš„çˆ¶åŠ è½½å™¨ã€‚</p></li><li><p>æ’å…¥ç±»åŠ è½½å™¨</p><p>æ‰“ç ´åŸæœ‰çš„åŒäº²å…³ç³»ï¼Œåœ¨å£³ç¨‹åºçš„ClassLoaderå’Œå…¶çˆ¶åŠ è½½å™¨ä¹‹é—´æ’å…¥æºç¨‹åºçš„DexClassLoaderã€‚</p></li><li><p>åˆå¹¶dexElements</p><p>å°†å£³ç¨‹åºçš„ClassLoaderä¸­çš„dexElementsä¸æºç¨‹åºçš„DexClassLoaderä¸­çš„dexElementsåˆå¹¶ï¼Œä»ä½¿ç”¨å£³ç¨‹åºçš„ClassLoaderã€‚</p></li></ul><p>è¯¦ç»†å¯å‚è€ƒ<a href="https://blog.svip.dev/posts/%E5%8A%A0%E5%A3%B3app%E7%9A%84%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%8F%8Aclassloader%E4%BF%AE%E6%AD%A3">åŠ å£³Appçš„è¿è¡Œæµç¨‹åŠClassLoaderä¿®æ­£ | Security (svip.dev)</a></p></li><li><p>ä¸ºä»€ä¹ˆè¦æ›¿æ¢Applicationï¼Ÿ</p><p>å› ä¸ºApplicationåšä¸ºæ•´ä¸ªåº”ç”¨çš„ä¸Šä¸‹æ–‡ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒè¿˜ä¼šä¸Activityã€Serviceç­‰ç»„ä»¶æœ‰äº¤äº’å…³ç³»ã€‚å¯¹äºå£³ç¨‹åºå’Œæºç¨‹åºï¼Œå®ƒä»¬å¯¹åº”çš„Applicationå®ä¾‹ä¸ä¸€å®šç›¸åŒï¼Œä¸ºäº†ç»´æŠ¤åº”ç”¨çš„æ­£å¸¸ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œæ›¿æ¢ã€‚</p><p>ä½ å¯ä»¥è®¤ä¸ºApplicationå°±ä»£è¡¨ç€æ•´ä¸ªAPPï¼ŒApplicationéƒ½ä¸åŒï¼Œé‚£è¿è¡Œçš„Appèƒ½æ˜¯ä¸€æ ·çš„å—ï¼Ÿ</p></li><li><p>æ€ä¹ˆæ›¿æ¢Applicationï¼Ÿ</p><p>å¤šç¢ç£¨ä»£ç ä½ æ‰èƒ½æ˜ç™½ã€‚æˆ‘è¿™é‡Œå°±ç®€è¦è¯´æ˜ä¸€ä¸‹ï¼š</p><p>æˆ‘ä»¬éœ€è¦å°†å£³ç¨‹åºçš„Applicationï¼ˆä¹Ÿå°±æ˜¯mApplicationï¼‰ä»ActivityThreadå®ä¾‹ä¸­çš„mAllApplicationsä¸­åˆ é™¤ã€‚ä¹‹åè®¾ç½®LoadedApkå®ä¾‹ä¸­çš„mApplicationå­—æ®µä¸ºnullï¼Œè¿™æ ·æ‰èƒ½è°ƒç”¨LoadedApkç±»çš„<code>makeApplication()</code>æ–¹æ³•åˆ›å»ºæºç¨‹åºçš„Applicationå®ä¾‹ï¼ˆä¹Ÿæ˜¯åå°„ï¼Œéœ€è¦è·å–åˆ°æºApplicationç±»åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å£³ç¨‹åºçš„<code>ActivityManifest.xml</code>ä¸­ä½¿ç”¨<code>&lt;meta-data&gt;</code>æ ‡ç­¾å¡«å†™å¹¶åœ¨ä»£ç ä¸­è·å–ï¼‰ã€‚å½“ç„¶ContentProviderä¹Ÿä¼šæœ‰Applicationå®ä¾‹ï¼Œä¹Ÿæ˜¯éœ€è¦æ›¿æ¢çš„ã€‚æœ€åè¿è¡Œæºç¨‹åºçš„Applicationå®ä¾‹çš„<code>onCreate()</code>æ–¹æ³•ï¼Œè¿™æ ·æºç¨‹åºæ‰å¼€å§‹å®ƒçš„è¿è¡Œç”Ÿå‘½å‘¨æœŸã€‚è¯¦ç»†å¯å‚è€ƒ<a href="https://github.com/13767004362/HookDemo/blob/master/document/%E6%8F%92%E4%BB%B6%E5%8C%96%E4%B9%8B%E5%8A%A8%E6%80%81%E6%9B%BF%E6%8D%A2application.md">æ’ä»¶åŒ–ä¹‹åŠ¨æ€æ›¿æ¢application.md</a>ã€‚</p></li><li><p>ä¸ºä»€ä¹ˆé€‰æ‹©Applicationç±»ä½œä¸ºè„±å£³ä»£ç æ‰§è¡Œçš„åœ°æ–¹ï¼Ÿ</p><p>å› ä¸ºApplicationæ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ï¼Œå®ƒçš„åˆ›å»ºæ—©äºä»»ä½•ä¸€ä¸ªActivityã€Serviceçš„åˆ›å»ºï¼ˆContentProviderä¾‹å¤–ï¼‰ï¼Œå› æ­¤å£³ç¨‹åºå¿…é¡»åœ¨Androidç³»ç»Ÿå¯åŠ¨ç»„ä»¶ä¹‹å‰è¿è¡Œï¼Œå®Œæˆæºç¨‹åºçš„è§£å¯†å’ŒåŠ¨æ€åŠ è½½ï¼Œå¦åˆ™ä¼šä½¿ç¨‹åºå‡ºç°åŠ è½½ç±»å¤±è´¥çš„å¼‚å¸¸ï¼Œæ‰€ä»¥é€‰æ‹©è¿™é‡Œä½œä¸ºè„±å£³ä»£ç æ‰§è¡Œçš„åœ°æ–¹ã€‚</p><p>å…¶æ¬¡ï¼ŒApplicationç±»çš„<code>attachBaseContext()</code>æ–¹æ³•æ¯”<code>onCreate()</code>æ–¹æ³•å…ˆæ‰§è¡Œï¼ˆçœ‹Applicationåˆ›å»ºçš„æºç æˆ–è€…è‡ªå®šä¹‰Applicationç±»å¹¶åˆ©ç”¨logè¾“å‡ºè¯•ä¸€è¯•ï¼‰ã€‚</p><p><del>åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨<code>attachBaseContext()</code>æ–¹æ³•ä¸­æ›¿æ¢å£³ç¨‹åºçš„ClassLoaderï¼Œåœ¨<code>onCreate()</code>æ–¹æ³•ä¸­æ›¿æ¢Applicationã€‚ï¼ˆä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘æ˜¯è§£é‡Šä¸å‡ºæ¥ã€‚ç›´æ¥å…¨åœ¨attachBaseContextä¸­å®Œæˆä¸è¡Œå—ï¼Ÿï¼‰</del></p><blockquote><p>å°è¯•äº†ä¸€ä¸‹ï¼Œå…¶å®å…¨åœ¨<code>attachBaseContext()</code>æ–¹æ³•æˆ–è€…å…¨åœ¨<code>onCreate()</code>æ–¹æ³•ä¸­æ‰§è¡Œéƒ½è¡Œçš„ï¼</p><p>ä½†éƒ½åœ¨<code>attachBaseContext()</code>æ–¹æ³•æ‰§è¡Œä¼šæœ‰ç¼ºé™·ï¼Œå°±æ˜¯ActivityThreadå®ä¾‹ä¸­çš„mInitialApplicationåˆä¼šè¢«å£³ç¨‹åºçš„Applicationæ›¿æ¢æ‰ï¼Œå¯ä»¥å‚è€ƒ<a href="https://gal2xy.github.io/2023/12/02/%E5%85%B3%E4%BA%8E%E4%B8%80%E4%BB%A3%E5%A3%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/">å…³äºä¸€ä»£å£³çš„ä¸€äº›ç†è§£</a>çš„åˆ†æ</p></blockquote></li></ol><p>æœ‰äº†ä¸Šè¿°çš„è§£é‡Šä¹‹åï¼Œæˆ‘æƒ³æ¥ä¸‹æ¥è§£æä»£ç å°±ç®€å•ä¸€äº›äº†ï¼</p><h3 id="3-3-2-attachBaseContext-ä¸­æ‰€éœ€è¦åšçš„å·¥ä½œ"><a href="#3-3-2-attachBaseContext-ä¸­æ‰€éœ€è¦åšçš„å·¥ä½œ" class="headerlink" title="3.3.2 attachBaseContext()ä¸­æ‰€éœ€è¦åšçš„å·¥ä½œ"></a>3.3.2 attachBaseContext()ä¸­æ‰€éœ€è¦åšçš„å·¥ä½œ</h3><p>é¦–å…ˆè¦åœ¨Applicationç±»çš„<code>attachBaseContext()</code>æ–¹æ³•ä¸­å®Œæˆå¯¹æºç¨‹åºçš„è§£å¯†å’Œåˆ†ç¦»ï¼Œå¹¶åŠ¨æ€åŠ è½½æºç¨‹åºapkã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachBaseContext</span><span class="hljs-params">(Context base)</span> &#123;<br>    <span class="hljs-built_in">super</span>.attachBaseContext(base);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//åœ¨åº”ç”¨ç¨‹åºçš„æ•°æ®å­˜å‚¨ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå…·ä½“è·¯å¾„ä¸ºdata/user/0/åŒ…å/app_payload_dex(æ€ä¹ˆå¤šäº†app_?)</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">dex</span> <span class="hljs-operator">=</span> getDir(<span class="hljs-string">&quot;payload_dex&quot;</span>, MODE_PRIVATE);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">lib</span> <span class="hljs-operator">=</span> getDir(<span class="hljs-string">&quot;payload_lib&quot;</span>, MODE_PRIVATE);<br>        dexPath = dex.getAbsolutePath();<br>        libPath = lib.getAbsolutePath();<br>        Log.d(TAG, <span class="hljs-string">&quot;dexPath: &quot;</span> + dexPath);<br>        Log.d(TAG, <span class="hljs-string">&quot;libPath: &quot;</span> + libPath);<br>        apkFileName = dex.getAbsolutePath() + File.separator + <span class="hljs-string">&quot;Source.apk&quot;</span>;<br>        Log.d(TAG, <span class="hljs-string">&quot;apkFileName: &quot;</span> + apkFileName);<br>        <span class="hljs-comment">// æ ¹æ®æ–‡ä»¶è·¯å¾„åˆ›å»ºFileå¯¹è±¡</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">dexFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(apkFileName);<br>        <span class="hljs-keyword">if</span> (!dexFile.exists()) &#123;<br>            <span class="hljs-comment">// æ ¹æ®è·¯å¾„åˆ›å»ºæ–‡ä»¶ï¼Œå³åœ¨payload_dexç›®å½•ä¸‹åˆ›å»ºSource.apkæ–‡ä»¶</span><br>            dexFile.createNewFile();<br>            <span class="hljs-comment">//è¯»å–Classes.dexæ–‡ä»¶</span><br>            <span class="hljs-type">byte</span>[] shellDexData = readDexFromApk();<br>            <span class="hljs-comment">//ä»ä¸­åˆ†ç†å¤„æºapkæ–‡ä»¶</span><br>            splitSourceApkFromShellDex(shellDexData);<br>        &#125;<br>        <span class="hljs-comment">//é…ç½®åŠ è½½æºç¨‹åºçš„åŠ¨æ€ç¯å¢ƒ,å³æ›¿æ¢mClassLoader</span><br>        replaceClassLoaderInLoadedApk();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;attachBaseContext: &quot;</span> + Log.getStackTraceString(e));<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-2-1-readDexFromApk"><a href="#3-3-2-1-readDexFromApk" class="headerlink" title="3.3.2.1 readDexFromApk()"></a>3.3.2.1 readDexFromApk()</h4><p>ä¸»è¦åŠŸèƒ½æ˜¯ä»å£³APKä¸­æ‰¾åˆ°dexæ–‡ä»¶å¹¶è¯»å–å‡ºæ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] readDexFromApk() <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-comment">//è·å–å½“å‰åº”ç”¨ç¨‹åºçš„æºç è·¯å¾„(apk),ä¸€èˆ¬æ˜¯data/appç›®å½•ä¸‹,è¯¥ç›®å½•ç”¨äºå­˜æ”¾ç”¨æˆ·å®‰è£…çš„è½¯ä»¶</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">sourceDir</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getApplicationInfo().sourceDir;<br>    Log.d(TAG, <span class="hljs-string">&quot;this.getApplicationInfo().sourceDir: &quot;</span> + <span class="hljs-built_in">this</span>.getApplicationInfo().sourceDir);<br>    <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(sourceDir);<br>    <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bufferedInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(fileInputStream);<br>    <span class="hljs-type">ZipInputStream</span> <span class="hljs-variable">zipInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipInputStream</span>(bufferedInputStream);<br>    <span class="hljs-comment">//ç”¨äºå­˜æ”¾è¯»å–åˆ°çš„dexæ–‡ä»¶</span><br>    <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-comment">//è·å–apkä¸­çš„ä¸€ä¸ªä¸ªæ–‡ä»¶</span><br>        <span class="hljs-type">ZipEntry</span> <span class="hljs-variable">zipEntry</span> <span class="hljs-operator">=</span> zipInputStream.getNextEntry();<br>        <span class="hljs-comment">//éå†å®Œäº†apkä¸­çš„æ–‡ä»¶</span><br>        <span class="hljs-keyword">if</span> (zipEntry == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-comment">// æå–å‡ºçš„æ–‡ä»¶æ˜¯classes.dexæ–‡ä»¶,åˆ™è¯»å–åˆ°bytearrayä¸­,æ˜¾ç„¶è¿™é‡Œåªèƒ½å¤„ç†å«å•dexæ–‡ä»¶çš„apk,å¤šdexçš„apkå¾…å®ç°</span><br>        <span class="hljs-keyword">if</span> (zipEntry.getName().equals(<span class="hljs-string">&quot;classes.dex&quot;</span>))&#123;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>                <span class="hljs-comment">//æ¯æ¬¡è¯»å–1024byte,è¿”å›çš„æ˜¯è¯»å–åˆ°çš„byteæ•°</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> zipInputStream.read(bytes);<br>                <span class="hljs-keyword">if</span> (i == -<span class="hljs-number">1</span>)&#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-comment">//å­˜æ”¾åˆ°å¼€è¾Ÿçš„byteArrayOutputStreamä¸­</span><br>                byteArrayOutputStream.write(bytes,<span class="hljs-number">0</span>, i);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//å…³é—­å½“å‰æ¡ç›®å¹¶å®šä½åˆ°apkä¸­çš„ä¸‹ä¸€ä¸ªæ–‡ä»¶</span><br>        zipInputStream.closeEntry();<br>    &#125;<br>    zipInputStream.close();<br><br>    <span class="hljs-comment">//è¿”å›è¯»å–åˆ°çš„dexæ–‡ä»¶</span><br>    <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-2-2-splitSourceApkFromShellDex"><a href="#3-3-2-2-splitSourceApkFromShellDex" class="headerlink" title="3.3.2.2 splitSourceApkFromShellDex()"></a>3.3.2.2 splitSourceApkFromShellDex()</h4><p>ä¸»è¦åŠŸèƒ½æ˜¯ä»å£³dexä¸­åˆ†ç†å¤„æºç¨‹åºapkï¼Œå­˜å‚¨æºç¨‹åºapkï¼Œæå–æºapkä¸­çš„æœ¬åœ°åº“æ–‡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">splitSourceApkFromShellDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] shellDexData)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">shellDexlength</span> <span class="hljs-operator">=</span> shellDexData.length;<br>    <span class="hljs-comment">//å¼€å§‹è§£ædexæ–‡ä»¶</span><br>    <span class="hljs-type">byte</span>[] sourceApkSizeByte = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];<br>    <span class="hljs-comment">//è¯»å–æºapkçš„å¤§å°</span><br>    System.arraycopy(shellDexData,shellDexlength - <span class="hljs-number">4</span>, sourceApkSizeByte,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>);<br>    <span class="hljs-comment">//è½¬æˆbytebuffer,æ–¹ä¾¿4byteè½¬int</span><br>    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">wrap</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(sourceApkSizeByte);<br>    <span class="hljs-comment">//å°†byteè½¬æˆint, åŠ å£³æ—¶,é•¿åº¦æˆ‘æ˜¯æŒ‰å°ç«¯å­˜å‚¨çš„</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">sourceApkSizeInt</span> <span class="hljs-operator">=</span> wrap.order(ByteOrder.LITTLE_ENDIAN).getInt();<br>    <span class="hljs-comment">//è¯»å–æºapk</span><br>    <span class="hljs-type">byte</span>[] sourceApkData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[sourceApkSizeInt];<br>    <span class="hljs-comment">//å¿˜è®°å‡4äº†ï¼</span><br>    System.arraycopy(shellDexData,shellDexlength - sourceApkSizeInt - <span class="hljs-number">4</span>, sourceApkData, <span class="hljs-number">0</span>, sourceApkSizeInt);<br>    <span class="hljs-comment">//è§£å¯†æºapk</span><br>    sourceApkData = decryptoSourceApk(sourceApkData);<br>    <span class="hljs-comment">//å†™å…¥æ–°å»ºçš„apkæ–‡ä»¶ä¸­</span><br>    <span class="hljs-type">File</span> <span class="hljs-variable">apkfile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(apkFileName);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">apkfileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(apkfile);<br>        apkfileOutputStream.write(sourceApkData);<br>        apkfileOutputStream.close();<br>    &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(e);<br>    &#125;<br><br>    <span class="hljs-comment">//åˆ†ææºapk,å–å‡ºsoæ–‡ä»¶æ”¾å…¥libPathç›®å½•ä¸­</span><br>    <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(apkfile);<br>    <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bufferedInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(fileInputStream);<br>    <span class="hljs-type">ZipInputStream</span> <span class="hljs-variable">zipInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipInputStream</span>(bufferedInputStream);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-type">ZipEntry</span> <span class="hljs-variable">nextEntry</span> <span class="hljs-operator">=</span> zipInputStream.getNextEntry();<br>        <span class="hljs-keyword">if</span> (nextEntry == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> nextEntry.getName();<br>        <span class="hljs-keyword">if</span> (name.startsWith(<span class="hljs-string">&quot;lib/&quot;</span>) &amp;&amp; name.endsWith(<span class="hljs-string">&quot;.so&quot;</span>))&#123;<br>            <span class="hljs-comment">//è·å–æ–‡ä»¶åå¹¶åˆ›å»ºç›¸åº”æ–‡ä»¶</span><br>            String[] nameSplit = name.split(<span class="hljs-string">&quot;/&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">soFileStorePath</span> <span class="hljs-operator">=</span> libPath + File.separator + nameSplit[nameSplit.length - <span class="hljs-number">1</span>];<br>            <span class="hljs-type">File</span> <span class="hljs-variable">storeFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(soFileStorePath);<br>            storeFile.createNewFile();<br>            <span class="hljs-comment">//è¯»æ•°æ®åˆ°ç›¸åº”soæ–‡ä»¶ä¸­</span><br>            <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(storeFile);<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> zipInputStream.read(bytes);<br>                <span class="hljs-keyword">if</span>(i == -<span class="hljs-number">1</span>)&#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                fileOutputStream.write(bytes,<span class="hljs-number">0</span>,i);<br>            &#125;<br>            <span class="hljs-comment">//å­˜å‚¨ç©soæ–‡ä»¶å,å…³é—­soæ–‡ä»¶çš„è¾“å‡ºç¼“å­˜åŒº</span><br>            fileOutputStream.flush();<br>            fileOutputStream.close();<br>        &#125;<br>        zipInputStream.closeEntry();<br>    &#125;<br>    zipInputStream.close();<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-2-3-decryptoSourceApk"><a href="#3-3-2-3-decryptoSourceApk" class="headerlink" title="3.3.2.3 decryptoSourceApk()"></a>3.3.2.3 decryptoSourceApk()</h4><p>ä¸»è¦åŠŸèƒ½å°±æ˜¯è§£å¯†æºAPKï¼Œè¿™æ²¡å•¥å¥½è§£é‡Šçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] decryptoSourceApk(<span class="hljs-type">byte</span>[] sourceApkdata) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; sourceApkdata.length; i++)&#123;<br>        sourceApkdata[i] ^= <span class="hljs-number">0xff</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> sourceApkdata;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-2-4-replaceClassLoaderInLoadedApk"><a href="#3-3-2-4-replaceClassLoaderInLoadedApk" class="headerlink" title="3.3.2.4 replaceClassLoaderInLoadedApk()"></a>3.3.2.4 replaceClassLoaderInLoadedApk()</h4><p>ä¸»è¦åŠŸèƒ½æ˜¯æ›¿æ¢å£³ç¨‹åºçš„ClassLoaderä¸ºæ–°å»ºçš„æºç¨‹åºçš„DexClassLoaderã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceClassLoaderInLoadedApk</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">// è·å–åº”ç”¨ç¨‹åºå½“å‰çš„classloader</span><br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClassLoader();<br>    Log.d(TAG, <span class="hljs-string">&quot;classLoader get: &quot;</span> + classLoader.toString());<br>    Log.d(TAG, <span class="hljs-string">&quot;parent classLoader get: &quot;</span> + classLoader.getParent().toString());<br>    <span class="hljs-comment">// è·å–ActivityThreadç±»</span><br>    Class&lt;?&gt; ActivityThreadClass = classLoader.loadClass(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>);<br>    Log.d(TAG, <span class="hljs-string">&quot;ActivityThreadClass: &quot;</span> + ActivityThreadClass.toString());<br>    <span class="hljs-comment">// ActivityThreadå·²ç»å®ä¾‹åŒ–äº†ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡åå°„currentActivityThread()æ–¹æ³•è·å–å®ä¾‹ï¼Œè€Œä¸æ˜¯é€šè¿‡ç±»åå°„åˆ›å»ºå®ä¾‹ï¼ˆä»–éƒ½ä¸æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œåˆ›å»ºæ²¡å±ç”¨ï¼‰</span><br>    <span class="hljs-comment">// 1.é€šè¿‡åå°„è·å–æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è·å–ActivityThreadå®ä¾‹</span><br>    <span class="hljs-comment">//            Method currentActivityThreadMethod = ActivityThreadClass.getDeclaredMethod(&quot;currentActivityThread&quot;);</span><br>    <span class="hljs-comment">//            Log.d(TAG, &quot;currentActivityThreadMethod: &quot; + currentActivityThreadMethod.toString());</span><br>    <span class="hljs-comment">//            currentActivityThreadMethod.setAccessible(true);</span><br>    <span class="hljs-comment">//            Object sCurrentActivityThreadObj = currentActivityThreadMethod.invoke(null);//ä¸ºä»€ä¹ˆè¿™é‡Œå¯ä»¥è®¾ç½®ä¸ºnull</span><br>    <span class="hljs-comment">//            Log.d(TAG, &quot;åå°„è·å–æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è·å–ActivityThreadå®ä¾‹: &quot; + sCurrentActivityThreadObj.toString());</span><br>    <span class="hljs-comment">// 2.ç›´æ¥åå°„è·å–ActivityThreadå­—æ®µ</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">sCurrentActivityThreadField</span> <span class="hljs-operator">=</span> ActivityThreadClass.getDeclaredField(<span class="hljs-string">&quot;sCurrentActivityThread&quot;</span>);<br>    Log.d(TAG, <span class="hljs-string">&quot;sCurrentActivityThread: &quot;</span> + sCurrentActivityThreadField.toString());<br>    sCurrentActivityThreadField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">sCurrentActivityThreadObj</span> <span class="hljs-operator">=</span> sCurrentActivityThreadField.get(<span class="hljs-literal">null</span>);<span class="hljs-comment">//ä¸ºä»€ä¹ˆè¿™é‡Œå¯ä»¥è®¾ç½®ä¸ºnull</span><br>    Log.d(TAG, <span class="hljs-string">&quot;ç›´æ¥åå°„è·å–ActivityThreadå­—æ®µ: &quot;</span> + sCurrentActivityThreadObj.toString());<br><br>    <span class="hljs-comment">//è·å–mPackages,ç±»å‹ä¸ºArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;, é‡Œé¢å­˜æ”¾äº†å½“å‰åº”ç”¨çš„LoadedApkå¯¹è±¡</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">mPackagesField</span> <span class="hljs-operator">=</span> ActivityThreadClass.getDeclaredField(<span class="hljs-string">&quot;mPackages&quot;</span>);<br>    mPackagesField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">//è·å–å½“å‰ActivityThreadå®ä¾‹çš„mPackageså­—æ®µ</span><br>    <span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mPackagesObj</span> <span class="hljs-operator">=</span> (ArrayMap) mPackagesField.get(sCurrentActivityThreadObj);<br>    Log.d(TAG, <span class="hljs-string">&quot;mPackagesObj: &quot;</span> + mPackagesObj.toString());<br><br>    <span class="hljs-comment">//è·å–mPackagesä¸­çš„å½“å‰åº”ç”¨åŒ…å</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">currentPackageName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getPackageName();<br>    Log.d(TAG, <span class="hljs-string">&quot;currentPackageName: &quot;</span> + currentPackageName);<br><br>    <span class="hljs-comment">// è·å–loadedApkå®ä¾‹ä¹Ÿæœ‰å¥½å‡ ç§,mInitialApplication mAllApplications mPackages</span><br>    <span class="hljs-comment">// é€šè¿‡åŒ…åè·å–å½“å‰åº”ç”¨çš„loadedApkå®ä¾‹</span><br>    <span class="hljs-type">WeakReference</span> <span class="hljs-variable">weakReference</span> <span class="hljs-operator">=</span> (WeakReference) mPackagesObj.get(currentPackageName);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">loadedApkObj</span> <span class="hljs-operator">=</span> weakReference.get();<br>    Log.d(TAG, <span class="hljs-string">&quot;loadedApkObj: &quot;</span> + loadedApkObj.toString());<br><br>    <span class="hljs-comment">//åŠ¨æ€åŠ è½½æºç¨‹åºçš„dexæ–‡ä»¶,ä»¥å½“å‰classloaderçš„çˆ¶åŠ è½½å™¨ä½œä¸ºparent</span><br>    <span class="hljs-type">DexClassLoader</span> <span class="hljs-variable">dexClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexClassLoader</span>(apkFileName,dexPath,libPath, classLoader.getParent());<br>    Log.d(TAG, <span class="hljs-string">&quot;dexClassLoader: &quot;</span> + dexClassLoader.toString());<br>    <span class="hljs-comment">//æ›¿æ¢loadedApkå®ä¾‹ä¸­çš„mClassLoaderå­—æ®µ</span><br>    Class&lt;?&gt; LoadedApkClass = classLoader.loadClass(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>);<br>    Log.d(TAG, <span class="hljs-string">&quot;LoadedApkClass: &quot;</span> + LoadedApkClass.toString());<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">mClassLoaderField</span> <span class="hljs-operator">=</span> LoadedApkClass.getDeclaredField(<span class="hljs-string">&quot;mClassLoader&quot;</span>);<br>    mClassLoaderField.setAccessible(<span class="hljs-literal">true</span>);<br>    mClassLoaderField.set(loadedApkObj, dexClassLoader);<br><br>    <span class="hljs-comment">//åŠ è½½æºç¨‹åºçš„ç±»</span><br>    <span class="hljs-comment">//å¯æœ‰å¯æ— ï¼Œåªæ˜¯æµ‹è¯•çœ‹çœ‹æœ‰æ²¡æœ‰è¿™ä¸ªç±»</span><br>    <span class="hljs-keyword">try</span>&#123;<br>        dexClassLoader.loadClass(<span class="hljs-string">&quot;com.example.sourceapk.MainActivity&quot;</span>);<br>        Log.d(TAG, <span class="hljs-string">&quot;com.example.sourceapk.MainActivity: ç±»åŠ è½½æˆåŠŸ&quot;</span>);<br>    &#125;<span class="hljs-keyword">catch</span> (ClassNotFoundException e)&#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;com.example.sourceapk.MainActivity: &quot;</span> + Log.getStackTraceString(e));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-3-onCreate-ä¸­æ‰€éœ€è¦åšçš„å·¥ä½œ"><a href="#3-3-3-onCreate-ä¸­æ‰€éœ€è¦åšçš„å·¥ä½œ" class="headerlink" title="3.3.3 onCreate()ä¸­æ‰€éœ€è¦åšçš„å·¥ä½œ"></a>3.3.3 onCreate()ä¸­æ‰€éœ€è¦åšçš„å·¥ä½œ</h3><p>ä¹‹åæ˜¯Applicationçš„<code>onCreate()</code>æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ›¿æ¢å£³ç¨‹åºçš„Applicationï¼Œéœ€è¦äº‹å…ˆç½®LoadedApkä¸­çš„mApplicationä¸ºnullï¼Œè¿™æ ·æ‰èƒ½è°ƒç”¨<code>makeApplication()</code>æ–¹æ³•åˆ›å»ºå‡ºæºç¨‹åºçš„Applicationã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">super</span>.onCreate();<br>    Log.d(TAG, <span class="hljs-string">&quot;SourceApk Application onCreate: &quot;</span> + <span class="hljs-built_in">this</span>);<br><br>    <span class="hljs-comment">//Applicationå®ä¾‹å­˜åœ¨äº: LoadedApkä¸­çš„mApplicationå­—æ®µ</span><br>    <span class="hljs-comment">// ä»¥åŠActivityThreadä¸­çš„mInitialApplicationå’ŒmAllApplicationså’ŒmBoundApplicationå­—æ®µ</span><br>    <span class="hljs-comment">//æ›¿æ¢Application</span><br><br>    <span class="hljs-comment">//è·å–æºç¨‹åºçš„Applicationç±»å</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">appClassName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//è·å–AndroidManifest.xml æ–‡ä»¶ä¸­çš„ &lt;meta-data&gt; å…ƒç´ </span><br>        <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">applicationInfo</span> <span class="hljs-operator">=</span> getPackageManager().getApplicationInfo(<span class="hljs-built_in">this</span>.getPackageName(), PackageManager.GET_META_DATA);<br>        <span class="hljs-type">Bundle</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> applicationInfo.metaData;<br>        <span class="hljs-comment">//è·å–xmlæ–‡ä»¶å£°æ˜çš„Applicationç±»</span><br>        <span class="hljs-keyword">if</span> (metaData != <span class="hljs-literal">null</span> &amp;&amp; metaData.containsKey(<span class="hljs-string">&quot;APPLICATION_CLASS_NAME&quot;</span>))&#123;<br>            appClassName = metaData.getString(<span class="hljs-string">&quot;APPLICATION_CLASS_NAME&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Log.d(TAG, <span class="hljs-string">&quot;xmlæ–‡ä»¶ä¸­æ²¡æœ‰å£°æ˜Applicationç±»å&quot;</span>);<br>            <span class="hljs-comment">//æ˜¯å› ä¸ºæ²¡æœ‰è‡ªå®šä¹‰applicationå°±ä¸å¥½åŠ¨æ€åŠ è½½æºç¨‹åºçš„applicationå—?</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;<br>        Log.d(TAG, Log.getStackTraceString(e));<br>    &#125;<br>    <span class="hljs-comment">//xmlæ–‡ä»¶ä¸­å­˜åœ¨è‡ªå®šä¹‰applicationç±»</span><br>    <span class="hljs-comment">//å¼€å§‹æ›¿æ¢</span><br><br>    <span class="hljs-comment">//è·å–ActivityThreadå®ä¾‹</span><br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClassLoader();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//è·å–ActivityThreadç±»</span><br>        Class&lt;?&gt; ActivityThreadClass = classLoader.loadClass(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>);<br>        Log.d(TAG, <span class="hljs-string">&quot;ActivityThreadClass: &quot;</span> + ActivityThreadClass.toString());<br>        <span class="hljs-comment">//åå°„è·å–sCurrentActivityThreadå®ä¾‹</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">sCurrentActivityThreadField</span> <span class="hljs-operator">=</span> ActivityThreadClass.getDeclaredField(<span class="hljs-string">&quot;sCurrentActivityThread&quot;</span>);<br>        Log.d(TAG, <span class="hljs-string">&quot;sCurrentActivityThread: &quot;</span> + sCurrentActivityThreadField.toString());<br>        sCurrentActivityThreadField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">sCurrentActivityThreadObj</span> <span class="hljs-operator">=</span> sCurrentActivityThreadField.get(<span class="hljs-literal">null</span>);<span class="hljs-comment">//ä¸ºä»€ä¹ˆè¿™é‡Œå¯ä»¥è®¾ç½®ä¸ºnull</span><br>        Log.d(TAG, <span class="hljs-string">&quot;ç›´æ¥åå°„è·å–ActivityThreadå­—æ®µ: &quot;</span> + sCurrentActivityThreadObj.toString());<br><br>        <span class="hljs-comment">//è·å–mBoundApplicationå­—æ®µ (AppBindDataå¯¹è±¡)</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">mBoundApplicationField</span> <span class="hljs-operator">=</span> ActivityThreadClass.getDeclaredField(<span class="hljs-string">&quot;mBoundApplication&quot;</span>);<br>        mBoundApplicationField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">mBoundApplicationObj</span> <span class="hljs-operator">=</span> mBoundApplicationField.get(sCurrentActivityThreadObj);<br><br>        <span class="hljs-comment">//è·å–mBoundApplicationå¯¹è±¡ä¸­çš„info (LoadedApkå¯¹è±¡)</span><br>        <span class="hljs-comment">//æ‰€ä»¥è¿™ä¸ªå’Œä¹‹å‰é€šè¿‡mPackageså­—æ®µè·å–LoadedApkæœ‰ä»€ä¹ˆä¸åŒ???</span><br>        <span class="hljs-comment">//é¦–å…ˆè·å–AppBindDataç±»,å®ƒä½äºActivityThreadç±»å†…éƒ¨</span><br>        Class&lt;?&gt; AppBindDataClass = classLoader.loadClass(<span class="hljs-string">&quot;android.app.ActivityThread$AppBindData&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">infoField</span> <span class="hljs-operator">=</span> AppBindDataClass.getDeclaredField(<span class="hljs-string">&quot;info&quot;</span>);<br>        infoField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">infoObj</span> <span class="hljs-operator">=</span> infoField.get(mBoundApplicationObj);<br>        Log.d(TAG, <span class="hljs-string">&quot;infoObj: &quot;</span> + infoObj.toString());<br><br>        <span class="hljs-comment">//æŠŠinfoObj (LoadedApkå¯¹è±¡)ä¸­çš„mApplicationè®¾ç½®ä¸ºnull,è¿™æ ·åç»­æ‰èƒ½è°ƒç”¨makeApplication()!!!</span><br>        Class&lt;?&gt; LoadedApkClass = classLoader.loadClass(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">mApplicationField</span> <span class="hljs-operator">=</span> LoadedApkClass.getDeclaredField(<span class="hljs-string">&quot;mApplication&quot;</span>);<br>        mApplicationField.setAccessible(<span class="hljs-literal">true</span>);<br>        Log.d(TAG, <span class="hljs-string">&quot;mApplication: &quot;</span> + mApplicationField.get(infoObj).toString());<br>        mApplicationField.set(infoObj, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//è·å–ActivityThreadå®ä¾‹ä¸­çš„mInitialApplicationå­—æ®µ,æ‹¿åˆ°æ—§çš„Application(å¯¹äºè¦åŠ è½½çš„Applicationæ¥è®²)</span><br>        <span class="hljs-comment">//ä¸ºä»€ä¹ˆä¸ç›´æ¥é€šè¿‡åˆšæ‰çš„infoè·å–???</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">mInitialApplicationField</span> <span class="hljs-operator">=</span> ActivityThreadClass.getDeclaredField(<span class="hljs-string">&quot;mInitialApplication&quot;</span>);<br>        mInitialApplicationField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">mInitialApplicationObj</span> <span class="hljs-operator">=</span> mInitialApplicationField.get(sCurrentActivityThreadObj);<br>        Log.d(TAG, <span class="hljs-string">&quot;mInitialApplicationObj: &quot;</span> + mInitialApplicationObj.toString());<br><br>        <span class="hljs-comment">//è·å–ActivityThreadå®ä¾‹ä¸­çš„mAllApplicationså­—æ®µ,ç„¶ååˆ é™¤mInitialApplication,ä¹Ÿå°±æ˜¯æ—§çš„application</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">mAllApplicationsField</span> <span class="hljs-operator">=</span> ActivityThreadClass.getDeclaredField(<span class="hljs-string">&quot;mAllApplications&quot;</span>);<br>        mAllApplicationsField.setAccessible(<span class="hljs-literal">true</span>);<br>        ArrayList&lt;Application&gt; mAllApplicationsObj = (ArrayList&lt;Application&gt;)mAllApplicationsField.get(sCurrentActivityThreadObj);<br>        mAllApplicationsObj.remove(mInitialApplicationObj);<br>        Log.d(TAG, <span class="hljs-string">&quot;mInitialApplication ä» mAllApplications ä¸­ç§»é™¤æˆåŠŸ&quot;</span>);<br><br>        <span class="hljs-comment">//è¿™æ˜¯è¦å¹²å˜›???</span><br>        <span class="hljs-comment">//è·å–LoadedApkçš„mApplicationInfoå­—æ®µ</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">mApplicationInfoField</span> <span class="hljs-operator">=</span> LoadedApkClass.getDeclaredField(<span class="hljs-string">&quot;mApplicationInfo&quot;</span>);<br>        mApplicationInfoField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">appinfoInLoadedApk</span> <span class="hljs-operator">=</span> (ApplicationInfo) mApplicationInfoField.get(infoObj);<br>        Log.d(TAG, <span class="hljs-string">&quot;appinfoInLoadedApk: &quot;</span> + appinfoInLoadedApk.toString());<br><br><br>        <span class="hljs-comment">//è·å–mBoundApplicationå¯¹è±¡ä¸­çš„appInfo</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appInfoField</span> <span class="hljs-operator">=</span> AppBindDataClass.getDeclaredField(<span class="hljs-string">&quot;appInfo&quot;</span>);<br>        appInfoField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">appinfoInAppBindData</span> <span class="hljs-operator">=</span> (ApplicationInfo) appInfoField.get(mBoundApplicationObj);<br>        Log.d(TAG, <span class="hljs-string">&quot;appinfoInLoadedApk: &quot;</span> + appinfoInAppBindData.toString());<br><br><br>        <span class="hljs-comment">//è®¾ç½®ä¸¤ä¸ªappinfoçš„classnameä¸ºæºç¨‹åºçš„applicationç±»å,ä»¥ä¾¿åç»­è°ƒç”¨makeApplication()åˆ›å»ºæºç¨‹åºçš„application</span><br>        appinfoInLoadedApk.className = appClassName;<br>        appinfoInAppBindData.className = appClassName;<br>        Log.d(TAG, <span class="hljs-string">&quot;è¦åŠ è½½çš„æºç¨‹åºapplicationç±»ä¸º: &quot;</span> + appClassName);<br><br>        <span class="hljs-comment">//åå°„è°ƒç”¨makeApplicationæ–¹æ³•åˆ›å»ºæºç¨‹åºçš„application</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">makeApplicationMethod</span> <span class="hljs-operator">=</span> LoadedApkClass.getDeclaredMethod(<span class="hljs-string">&quot;makeApplication&quot;</span>, <span class="hljs-type">boolean</span>.class, Instrumentation.class);<br>        Log.d(TAG, <span class="hljs-string">&quot;makeApplicationMethod: &quot;</span> + makeApplicationMethod.toString());<br>        makeApplicationMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> (Application) makeApplicationMethod.invoke(infoObj, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>        Log.d(TAG, <span class="hljs-string">&quot;åˆ›å»ºæºç¨‹åºapplicationæˆåŠŸ&quot;</span>);<br><br>        <span class="hljs-comment">//å°†åˆšåˆ›å»ºçš„Applicationè®¾ç½®åˆ°ActivityThreadçš„mInitialApplicationå­—æ®µ</span><br>        mInitialApplicationField.set(sCurrentActivityThreadObj, app);<br>        Log.d(TAG, <span class="hljs-string">&quot;æºç¨‹åºçš„applicationæˆåŠŸè®¾ç½®åˆ°mInitialApplicationå­—æ®µ&quot;</span>);<br><br>        <span class="hljs-comment">//ContentProviderä¼šæŒæœ‰ä»£ç†çš„Application,éœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">mProviderMapField</span> <span class="hljs-operator">=</span> ActivityThreadClass.getDeclaredField(<span class="hljs-string">&quot;mProviderMap&quot;</span>);<br>        Log.d(TAG, <span class="hljs-string">&quot;mProviderMapField: &quot;</span> + mProviderMapField.toString());<br>        mProviderMapField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mProviderMapObj</span> <span class="hljs-operator">=</span> (ArrayMap) mProviderMapField.get(sCurrentActivityThreadObj);<br>        Log.d(TAG, <span class="hljs-string">&quot;mProviderMapObj: &quot;</span> + mProviderMapObj.toString());<br>        <span class="hljs-comment">//è·å–æ‰€æœ‰provider,è£…è¿›è¿­ä»£å™¨ä¸­éå†</span><br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">iterator</span> <span class="hljs-operator">=</span> mProviderMapObj.values().iterator();<br>        Log.d(TAG, <span class="hljs-string">&quot;iterator: &quot;</span> + iterator.toString());<br>        <span class="hljs-keyword">while</span>(iterator.hasNext())&#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">providerClientRecord</span> <span class="hljs-operator">=</span> iterator.next();<br>            <span class="hljs-comment">//è·å–ProviderClientRecordä¸­çš„mLocalProviderå­—æ®µ</span><br>            Class&lt;?&gt; ProviderClientRecordClass = classLoader.loadClass(<span class="hljs-string">&quot;android.app.ActivityThread$ProviderClientRecord&quot;</span>);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">mLocalProviderField</span> <span class="hljs-operator">=</span> ProviderClientRecordClass.getDeclaredField(<span class="hljs-string">&quot;mLocalProvider&quot;</span>);<br>            Log.d(TAG, <span class="hljs-string">&quot;mLocalProviderField: &quot;</span> + mLocalProviderField.toString());<br>            mLocalProviderField.setAccessible(<span class="hljs-literal">true</span>);<br><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">mLocalProviderObj</span> <span class="hljs-operator">=</span> mLocalProviderField.get(providerClientRecord);<br>            <span class="hljs-comment">//mLocalProviderObjå¯èƒ½ä¸ºç©º</span><br>            <span class="hljs-keyword">if</span>(mLocalProviderObj != <span class="hljs-literal">null</span>)&#123;<br>                Log.d(TAG, <span class="hljs-string">&quot;mLocalProviderObj: &quot;</span> + mLocalProviderObj.toString());<br>                <span class="hljs-comment">//è·å–ContentProviderä¸­çš„mContextå­—æ®µ,è®¾ç½®ä¸ºæ–°å»ºçš„Application</span><br>                Class&lt;?&gt; ContentProviderClass = classLoader.loadClass(<span class="hljs-string">&quot;android.content.ContentProvider&quot;</span>);<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">mContextField</span> <span class="hljs-operator">=</span> ContentProviderClass.getDeclaredField(<span class="hljs-string">&quot;mContext&quot;</span>);<br>                mContextField.setAccessible(<span class="hljs-literal">true</span>);<br>                mContextField.set(mLocalProviderObj,app);<br>            &#125;<br><br>        &#125;<br>        Log.d(TAG, <span class="hljs-string">&quot;app: &quot;</span> + app);<br>        <span class="hljs-comment">//å¼€å§‹Applicationçš„åˆ›å»º,æºç¨‹åºå¯åŠ¨!</span><br>        app.onCreate();<br><br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        Log.e(TAG, Log.getStackTraceString(e));<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å››ã€é¡¹ç›®è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜"><a href="#å››ã€é¡¹ç›®è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜" class="headerlink" title="å››ã€é¡¹ç›®è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜"></a>å››ã€é¡¹ç›®è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜</h1><p><strong>æ³¨æ„ï¼æ¯æ¬¡å®‰è£…ç©æ–°çš„apkåï¼Œè®°å¾—æŠŠä¹‹å‰ä»£ç åˆ›å»ºçš„ä¸¤ä¸ªç›®å½•åˆ é™¤ï¼Œå¦åˆ™å°±æ˜¯å¯åŠ¨ä¹‹å‰å­˜åœ¨çš„æºapkã€‚</strong></p><h2 id="4-1-é—®é¢˜ä¸€"><a href="#4-1-é—®é¢˜ä¸€" class="headerlink" title="4.1 é—®é¢˜ä¸€"></a>4.1 é—®é¢˜ä¸€</h2><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012217971.png"></p><p>æŸ¥çœ‹äº†ä¸€ä¸‹æå–å‡ºçš„æºç¨‹åºï¼Œå®ƒä¸èƒ½è¢«æ­£å¸¸è¯†åˆ«æˆapkï¼Œè€Œä¸”æ‹–åˆ°jadxä¸­åç¼–è¯‘å¤±è´¥ï¼Bandzipæ‰“å¼€æŠ¥é”™è¯¥æ–‡ä»¶å·²æŸåï¼</p><p>010editoræ‰“å¼€ï¼Œå‘ç°è¿pkå¤´éƒ½æ²¡æœ‰ï¼ä¼°è®¡æ˜¯å–æºç¨‹åºçš„æ—¶å€™å®šä½é”™äº†ï¼</p><p>é¢ï¼Œè¿˜çœŸæ˜¯ï¼Œå®šä½åˆå§‹ä½ç½®çš„æ—¶å€™å°‘å‡äº†4bytesï¼ˆå­˜å‚¨æºAPKå¤§å°çš„é•¿åº¦ï¼‰</p><p>ï¼ˆè¿™ä¸æ˜¯é”™è¯¯å‡ºç°çš„åŸå› ï¼ï¼‰</p><p>ä¹‹åæå–å‡ºæ¥çš„æºç¨‹åºæ˜¯æ­£å¸¸çš„ï¼Œèƒ½è¢«æ­£å¸¸è¯†åˆ«ï¼Œèƒ½è¢«jadxåç¼–è¯‘å‡ºåŸæœ¬ä»£ç ï¼Œä½†æ˜¯ä»ç„¶ä¸Šå›¾çš„è¿™ä¸ªé”™è¯¯ã€‚</p><p>éš¾é“æ˜¯å£³APKä¸­çš„ActivityMainfest.xmlä¸­æ²¡å£°æ˜è¯¥Activityå¯¼è‡´çš„ï¼Ÿï¼Ÿï¼Ÿ</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012217020.png"></p><p>æœç„¶æ˜¯è¿™æ ·ï¼æˆ‘ä»¬éœ€è¦æŠŠæºç¨‹åºçš„Activityå£°æ˜æ¬åˆ°å£³ç¨‹åºä¸­ï¼Œä¹‹åæˆ‘çš„å£³ç¨‹åºçš„ActivityMainfest.xmlæ–‡ä»¶å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012217912.png"></p><h2 id="4-2-é—®é¢˜äºŒ"><a href="#4-2-é—®é¢˜äºŒ" class="headerlink" title="4.2 é—®é¢˜äºŒ"></a>4.2 é—®é¢˜äºŒ</h2><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012218279.png"></p><p>æ— æ³•åˆ›å»ºapplicationï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012218894.png"></p><p>æºç¨‹åºçš„applicationç±»æ‰¾ä¸åˆ°ï¼Ÿï¼Ÿï¼Ÿ</p><p>æˆ‘æµ‹ï¼æˆ‘å¤§å†™äº†ï¼Œ<meta-data>æ ‡ç­¾ä¸­åŒ…applicationç±»åå¤§å†™äº†ï¼Œåº”è¯¥æ˜¯sourceapkè€Œä¸æ˜¯sourcApkï¼ğŸ¥²</p><h2 id="4-3-é—®é¢˜ä¸‰"><a href="#4-3-é—®é¢˜ä¸‰" class="headerlink" title="4.3 é—®é¢˜ä¸‰"></a>4.3 é—®é¢˜ä¸‰</h2><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012218547.png"></p><p>æœ‰çš„providerClientRecordå¯¹è±¡ä¸­çš„mLocalProviderå­—æ®µæ˜¯ç©ºçš„ï¼ï¼Ÿï¼Ÿ</p><p>è¿˜ä»¥ä¸ºæ˜¯æˆ‘çš„åŸå› é€ æˆçš„å‘¢ã€‚å…¶å®æ˜¯å¯ä»¥ä¸ºç©ºçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨è·å–åˆ°mLocalProviderå¯¹è±¡åç”¨åŠ ä¸€å±‚åˆ¤æ–­å°±è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·å–æ‰€æœ‰provider,è£…è¿›è¿­ä»£å™¨ä¸­éå†</span><br><span class="hljs-type">Iterator</span> <span class="hljs-variable">iterator</span> <span class="hljs-operator">=</span> mProviderMapObj.values().iterator();<br>Log.d(TAG, <span class="hljs-string">&quot;iterator: &quot;</span> + iterator.toString());<br><span class="hljs-keyword">while</span>(iterator.hasNext())&#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">providerClientRecord</span> <span class="hljs-operator">=</span> iterator.next();<br>    <span class="hljs-comment">//è·å–ProviderClientRecordä¸­çš„mLocalProviderå­—æ®µ</span><br>    Class&lt;?&gt; ProviderClientRecordClass = classLoader.loadClass(<span class="hljs-string">&quot;android.app.ActivityThread$ProviderClientRecord&quot;</span>);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">mLocalProviderField</span> <span class="hljs-operator">=</span> ProviderClientRecordClass.getDeclaredField(<span class="hljs-string">&quot;mLocalProvider&quot;</span>);<br>    Log.d(TAG, <span class="hljs-string">&quot;mLocalProviderField: &quot;</span> + mLocalProviderField.toString());<br>    mLocalProviderField.setAccessible(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">mLocalProviderObj</span> <span class="hljs-operator">=</span> mLocalProviderField.get(providerClientRecord);<br>    <span class="hljs-comment">//mLocalProviderObjå¯èƒ½ä¸ºç©º</span><br>    <span class="hljs-keyword">if</span>(mLocalProviderObj != <span class="hljs-literal">null</span>)&#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;mLocalProviderObj: &quot;</span> + mLocalProviderObj.toString());<br>        <span class="hljs-comment">//è·å–ContentProviderä¸­çš„mContextå­—æ®µ,è®¾ç½®ä¸ºæ–°å»ºçš„Application</span><br>        Class&lt;?&gt; ContentProviderClass = classLoader.loadClass(<span class="hljs-string">&quot;android.content.ContentProvider&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">mContextField</span> <span class="hljs-operator">=</span> ContentProviderClass.getDeclaredField(<span class="hljs-string">&quot;mContext&quot;</span>);<br>        mContextField.setAccessible(<span class="hljs-literal">true</span>);<br>        mContextField.set(mLocalProviderObj,app);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-4-é—®é¢˜å››"><a href="#4-4-é—®é¢˜å››" class="headerlink" title="4.4. é—®é¢˜å››"></a>4.4. é—®é¢˜å››</h2><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012218409.png"></p><p>æœç´¢äº†ä¸€ä¸‹ï¼Œæºç¨‹åºçš„MainActivityä¸åº”è¯¥ç»§æ‰¿è‡ªAppCompatActivityç±»ï¼Œéœ€è¦æ”¹æˆç»§æ‰¿è‡ªActivityç±»ï¼Œæˆ–è€…ä¿®æ”¹AndroidManifest.xmlæ–‡ä»¶çš„ä¸»é¢˜ã€‚ï¼ˆå‚è€ƒ<a href="https://blog.csdn.net/lady_zhou/article/details/99590037">è§£å†³You need to use a Theme.AppCompat theme (or descendant) with this activity.-CSDNåšå®¢</a>ï¼‰</p><p>æˆ‘æ˜¯ç›´æ¥æ”¹æˆç»§æ‰¿è‡ªActivityç±»ã€‚</p><p>ä¹‹åæˆåŠŸå¯åŠ¨äº†ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012218172.png"></p><p>å…¶å®åˆ°è¿™é‡Œå°±å·²ç»å¯ä»¥è¯´åŠ å£³è„±å£³æˆåŠŸäº†ã€‚ä½†æ˜¯ï¼ï¼ï¼å¯åŠ¨åçš„ç•Œé¢ä¸å®¹ä¹è§‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012218163.jpg"></p><p>å¹¶éæºç¨‹åºçš„<code>activity_main.xml</code>ä¸­çš„ç•Œé¢ã€‚æ‰€ä»¥æˆ‘å°†æºç¨‹åº<code>activity_main.xml</code>æ–‡ä»¶å¤åˆ¶åˆ°å£³ç¨‹åºçš„<code>/res/layout</code>ç›®å½•ä¸‹ï¼Œä½†æ˜¯ä¸‹ä¸€ä¸ªé—®é¢˜æ¥è¸µè€Œæ¥ã€‚</p><h2 id="4-5-é—®é¢˜äº”"><a href="#4-5-é—®é¢˜äº”" class="headerlink" title="4.5 é—®é¢˜äº”"></a>4.5 é—®é¢˜äº”</h2><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012219334.png"></p><p>å¤åˆ¶ç²˜è´´è¿‡æ¥çš„<code>activity_main.xml</code>æœ‰é—®é¢˜ï¼Œå­—ç¬¦ä¸²ç´¢å¼•æœ‰é—®é¢˜ï¼Ÿï¼Ÿå¯æ˜¯æˆ‘æ˜¯ç›´æ¥å¡«å­—ç¬¦ä¸²å¸¸é‡è¿›å»çš„å•Šï¼Œå°±æ ¹æœ¬æ²¡ç”¨å­—ç¬¦ä¸²ç´¢å¼•ã€‚</p><p>å°è¯•ä¹‹åï¼Œæ˜¯æŠŠå®¹å™¨æ ‡ç­¾<code>&lt;androidx.constraintlayout.widget.ConstraintLayout&gt;</code>æ¢æˆå…¶ä»–çš„å°±è¡Œï¼Œæˆ‘æ¢æˆäº†<code>&lt;LinearLayout&gt;</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;com.example.sourceapk.MainActivity&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;è¿™æ˜¯æºç¨‹åºï¼&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æœ€ç»ˆæˆåŠŸå¯åŠ¨å¹¶å±•ç¤ºå‡ºäº†æºç¨‹åºç•Œé¢ï¼š</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012219334.jpg" style="zoom:30%;" /><p>æ˜¾ç„¶ï¼Œåœ¨ä¸Šè¿°é—®é¢˜ä¸­ï¼Œç»å¤§æ•°æ˜¯æˆ‘ç²—å¿ƒé€ æˆçš„ï¼ğŸ˜¢</p><h1 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h1><p>èŠ±è´¹äº†å¤§æ¦‚ä¸€å‘¨çš„æ—¶é—´ï¼Œä»ä¸€å¼€å§‹æ¥è§¦ç¬¬ä¸€ä»£å£³ï¼Œå‰å‰ååå­¦äº†ä¸å°‘åŠ å£³æ‰€éœ€çš„å‰ç½®çŸ¥è¯†ï¼Œç»ˆäºåœ¨ä»Šæ—¥ä¹Ÿæ˜¯æˆåŠŸçš„åˆ¶ä½œå‡ºäº†ä¸€ä»£å£³ã€‚</p><p>åœ¨åˆ¶ä½œçš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šç²—å¿ƒçš„åœ°æ–¹ï¼Œä¸€äº›å¤§å°å†™çš„é—®é¢˜å¯¼è‡´åŠ¨æ€åŠ è½½ç±»å¤±è´¥ï¼Œå½“ç„¶ä¹Ÿæ³¨æ„åˆ°åå°„æ‰€ç”¨çš„ä»£ç éå¸¸é›·åŒï¼Œå› æ­¤å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåå°„ç±»ï¼Œåƒé‚£äº›æ‰€å‚è€ƒçš„æ–‡ç« ä¸€æ ·ï¼Œè¿™æ ·ä»£ç å°±éå¸¸ç®€æ´äº†ã€‚å¦ä¸€ä¸ªæ–¹é¢å°±æ˜¯ï¼Œæˆ‘è§‰å¾—ä¸Šé¢çš„ä»£ç ï¼ˆæˆ–è€…è¯´æˆ‘æ‰€å‚è€ƒçš„ä»£ç ï¼‰è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œæœ‰ä¸€äº›ä»£ç ä¸ºä»€ä¹ˆè¿™ä¹ˆåšæˆ‘æä¸æ¸…æ¥šï¼Œå°šå¾…è€ƒç©¶ã€‚</p><p>è¿˜æœ‰å°±æ˜¯åœ¨ä»£ç ä¸­åå°„æ¥åå°„å»çš„ï¼Œé‚£äº›æ‰€è·å–çš„å®ä¾‹æˆ‘çŒœæµ‹åº”è¯¥éƒ½æ˜¯åŒä¸€ä¸ªï¼Œä¾‹å¦‚LoadedApkã€Applicationå®ä¾‹ï¼Œå­˜å‚¨ä»–ä»¬çš„å­—æ®µæœ‰å¾ˆå¤šï¼Œæ‰€ä»¥æˆ‘æƒ³ï¼Œæ¥ä¸‹æ¥å¯ä»¥éªŒè¯ä¸€ä¸‹æ˜¯ä¸æ˜¯å¦‚çŒœæƒ³ä¸€æ ·ã€‚</p><p>ä¸è¿‡æˆ‘ä¼¼ä¹ç†è§£äº†ä¸ºä»€ä¹ˆç¬¬ä¸€ä»£å£³åˆè¢«ç§°ä¸ºè½åœ°åŠ è½½å£³ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä¼šæŠŠæºç¨‹åºä»å£³ç¨‹åºä¸­åˆ†ç¦»å‡ºæ¥å¹¶å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ‰€ä»¥æ‰å«â€è½åœ°â€œã€‚ç”±äºè¿™ä¸€ç‰¹æ€§ï¼Œæ”»å‡»è€…å¯ä»¥ä»æ–‡ä»¶ç³»ç»Ÿä¸­è·å–æºç¨‹åºã€‚å³ä½¿æˆ‘ä»¬å¯¹æºæ–‡ä»¶åŠ è½½ååˆ é™¤ï¼Œæ”»å‡»è€…ä»ç„¶å¯ä»¥é€šè¿‡æ‹¦æˆªå¯¹åº”çš„åˆ é™¤å‡½æ•°é˜»æ­¢åˆ é™¤ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://github.com/13767004362/HookDemo/blob/master/document/%E6%8F%92%E4%BB%B6%E5%8C%96%E4%B9%8B%E5%8A%A8%E6%80%81%E6%9B%BF%E6%8D%A2application.md">æ’ä»¶åŒ–ä¹‹åŠ¨æ€æ›¿æ¢application.md</a></p><p><a href="https://blog.svip.dev/posts/%E5%8A%A0%E5%A3%B3app%E7%9A%84%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%8F%8Aclassloader%E4%BF%AE%E6%AD%A3">åŠ å£³Appçš„è¿è¡Œæµç¨‹åŠClassLoaderä¿®æ­£ | Security (svip.dev)</a></p><p><a href="https://blog.csdn.net/xiangzhihong8/article/details/79724978">https://blog.csdn.net/xiangzhihong8/article/details/79724978</a></p><p>[<a href="https://bbs.kanxue.com/thread-261939.htm">åŸåˆ›]å®‰å“åŠ å›ºæ–¹æ¡ˆä»è½åœ°åŠ è½½åˆ°ç±»æŒ‡ä»¤æŠ½å–ç¼–å†™æŠ¥å‘Š-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p><a href="https://www.jianshu.com/p/ae66be381e6f">Android ä¸€äºŒä¸‰ä»£å£³åŠ å›ºåŸç†åˆ†æ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="http://www.520monkey.com/archives/553">Androidä¸­çš„Apkçš„åŠ å›º(åŠ å£³)åŸç†è§£æå’Œå®ç° | å°¼å¤æ‹‰æ–¯.èµµå›› (520monkey.com)</a></p><p>[<a href="https://bbs.kanxue.com/thread-260124.htm">åŸåˆ›]Android AppåŠ å›ºåŸç†ä¸æŠ€æœ¯å†ç¨‹-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p><a href="https://zhuanlan.zhihu.com/p/398931026">ä»ç¬¬ä¸€ä»£åˆ°ç¬¬äº”ä»£ï¼ŒAppåŠ å›ºæŠ€æœ¯è¯¦è§£ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AndroidåŠ å›º</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidä¸­çš„Applicationç±»</title>
    <link href="/2023/12/01/Android%E4%B8%AD%E7%9A%84Application%E7%B1%BB/"/>
    <url>/2023/12/01/Android%E4%B8%AD%E7%9A%84Application%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€Applicationæ˜¯ä»€ä¹ˆ"><a href="#ä¸€ã€Applicationæ˜¯ä»€ä¹ˆ" class="headerlink" title="ä¸€ã€Applicationæ˜¯ä»€ä¹ˆ"></a>ä¸€ã€Applicationæ˜¯ä»€ä¹ˆ</h1><p>ApplicationåŒActivityã€Serviceä¸€æ ·ï¼Œéƒ½æ˜¯Androidç³»ç»Ÿçš„ç»„ä»¶ã€‚å½“åº”ç”¨ç¨‹åºå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæœ€å…ˆåˆ›å»ºçš„æ˜¯Applicationå®ä¾‹ï¼ˆæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªï¼‰ï¼Œå®ƒçš„åˆ›å»ºæ—©äºåº”ç”¨ç¨‹åºå¯åŠ¨ä»¥åŠä»»ä½•Activityã€Serviceæˆ–æ¥æ”¶è€…å¯¹è±¡ï¼ˆä¸åŒ…æ‹¬ContentProviderï¼‰çš„åˆ›å»ºã€‚Applicationçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­æœ€é•¿çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå°±ç­‰äºåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>åœ¨<a href="https://gal2xy.github.io/2023/11/27/Android%E4%B8%ADApplication%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B/">Androidä¸­Applicationçš„åˆ›å»ºæµç¨‹(gal2xy.github.io)</a>ä¸€æ–‡ä¸­ï¼Œåº”ç”¨ç¨‹åºå¯åŠ¨ä¼šåˆ›å»ºä¸»çº¿ç¨‹ActivityThreadï¼Œç„¶åé€šè¿‡AMSçš„<code>attachApplication()</code>æ–¹æ³•ç»‘å®šApplicationï¼ˆæ·±å…¥è¯¥æ–¹æ³•ä¼šæœ‰ä¸€ç³»åˆ—è°ƒç”¨ï¼Œè¿™é‡Œåªç®€å•æè¿°ï¼‰ï¼Œæœ€ç»ˆä¼šåˆ›å»ºApplicationï¼Œå¹¶èµ‹å€¼ç»™åˆšåˆšåˆ›å»ºçš„ActivityThreadçš„<code>mInitialApplication </code>å­—æ®µï¼Œå› æ­¤è¿™ä¸ªApplicationæ˜¯å…¨å±€çš„ä¸”å•ä¾‹çš„ï¼Œè€Œæ‰€æœ‰çš„Activityã€Serviceç­‰ç»„ä»¶å—ActivityThreadçš„ç®¡ç†ï¼Œæ‰€ä»¥åœ¨ä¸åŒçš„Activityã€Serviceä¸­è·å¾—çš„Applicationå¯¹è±¡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡Applicationæ¥è¿›è¡Œä¸€äº›æ“ä½œï¼Œå¦‚æ•°æ®ä¼ é€’ã€æ•°æ®å…±äº«å’Œæ•°æ®ç¼“å­˜ç­‰ã€‚</p><p>Applicationçš„å½¢è±¡ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202312012213170.png"></p><h2 id="äºŒã€Applicationç±»çš„ä¸€äº›æ–¹æ³•"><a href="#äºŒã€Applicationç±»çš„ä¸€äº›æ–¹æ³•" class="headerlink" title="äºŒã€Applicationç±»çš„ä¸€äº›æ–¹æ³•"></a>äºŒã€Applicationç±»çš„ä¸€äº›æ–¹æ³•</h2><ul><li><p>getProcessName()</p><p>è·å–å½“å‰è¿›ç¨‹çš„åç§°ã€‚</p></li><li><p>onConfigurationChanged()</p><p>ç›‘å¬appçš„é…ç½®ä¿¡æ¯æ”¹å˜äº‹ä»¶ï¼Œå¦‚æ‰‹æœºå±å¹•æ—‹è½¬ç­‰ã€‚å½“é…ç½®ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶è¢«è°ƒç”¨ã€‚</p></li><li><p>onCreate()</p><p>Applicationåˆå§‹åŒ–æ—¶è¢«è°ƒç”¨ï¼Œè°ƒç”¨æ—¶æœºæ—©äºä»»ä½•ä¸€ä¸ªActivityã€Serviceã€‚</p></li><li><p>onLowmemory()</p><p>ç›‘å¬ç³»ç»Ÿå†…å­˜æƒ…å†µï¼Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶è°ƒç”¨è¯¥æ–¹æ³•æ¥é‡Šæ”¾ä¸€äº›ä¸é‡è¦çš„èµ„æºï¼Œä»¥ä¿è¯appèƒ½å¤Ÿç»§ç»­è¿è¡Œè€Œä¸è¢«ç³»ç»Ÿæ€æ‰ã€‚</p></li><li><p>onTerminate()</p><p>åº”ç”¨ç¨‹åºç»“æŸæ—¶è¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨äºæ¨¡æ‹Ÿè¿‡ç¨‹ç¯å¢ƒä¸­ã€‚</p></li><li><p>onTrimMemory()ï¼š</p><p>é€šçŸ¥åº”ç”¨çš„ä¸åŒå†…å­˜æƒ…å†µã€‚</p></li><li><p>registerActivityLifecycleCallbacks()å’ŒunregisterActivityLifecycleCallbacks()</p><p>æ³¨å†Œæˆ–è€…æ³¨é”€å¯¹APPå†…æ‰€æœ‰Activityçš„ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œå½“appå†…Activityçš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–çš„æ—¶å€™å°±ä¼šè°ƒç”¨ActivityLifecycleCallbacksé‡Œé¢çš„æ–¹æ³•ã€‚</p></li><li><p>registerComponentCallbacks()å’ŒunregisterComponentCallbacks()</p><p>ç”¨äºæ³¨å†Œå’Œæ³¨é”€ComponentCallbacksæˆ–ComponentCallbacks2å›è°ƒæ¥å£ã€‚</p></li></ul><h1 id="ä¸‰ã€Applicationçš„åº”ç”¨"><a href="#ä¸‰ã€Applicationçš„åº”ç”¨" class="headerlink" title="ä¸‰ã€Applicationçš„åº”ç”¨"></a>ä¸‰ã€Applicationçš„åº”ç”¨</h1><p>Application ä½œä¸ºæ•´ä¸ª App çš„ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œå…¶ä½œç”¨å¦‚ä¸‹ï¼š</p><ol><li>ä½œä¸º App çš„å…¥å£ï¼Œå¯ç”¨æ¥åˆå§‹åŒ–åŸºæœ¬é…ç½®ï¼Œå¦‚ç¬¬ä¸‰æ–¹ SDK çš„åˆå§‹åŒ–ã€‚</li><li>å¯ä»¥åœ¨ Application ä¸­å®šä¹‰ä¾›å…¨å±€ä½¿ç”¨çš„å˜é‡ï¼Œä¸è¿‡å½“åº”ç”¨è¢«å¼ºæ€ä¹‹åæœ‰å¯èƒ½å‡ºç°ç©ºæŒ‡é’ˆçš„é—®é¢˜ï¼Œå¯¼è‡´å†æ¬¡æ‰“å¼€åº”ç”¨çš„æ—¶å€™å´©æºƒï¼Œå¦‚æœç¡®å®šè¦è¿™æ ·ä½¿ç”¨ï¼Œä¸€å®šè¦å¤„ç†å¥½è¿™ç§æƒ…å†µã€‚</li><li>å¯ä»¥å€ŸåŠ© Application ç®¡ç† Activity çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ä»¥åŠåˆ¤æ–­åº”ç”¨å¤„äºå‰å°è¿˜æ˜¯åå°ç­‰ï¼Œå¯æ ¹æ®å†…å­˜ä¼˜å…ˆçº§é™ä½è‡ªèº«åº”ç”¨æ‰€å å†…å­˜ï¼Œå‡å°è‡ªèº«åº”ç”¨è¢«ç³»ç»Ÿå¼ºæ€çš„å¯èƒ½æ€§ã€‚</li></ol><h2 id="3-1-è‡ªå®šä¹‰Application"><a href="#3-1-è‡ªå®šä¹‰Application" class="headerlink" title="3.1 è‡ªå®šä¹‰Application"></a>3.1 è‡ªå®šä¹‰Application</h2><p>åœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨å®ç°åº”ç”¨çš„Applicationï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰Applicationï¼Œé‚£ä¹ˆåªéœ€è¦åˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿Applicationå¹¶åœ¨AndroidManifest.xmlæ–‡ä»¶ä¸­ä½¿ç”¨<code>&lt;application/&gt;</code>æ ‡ç­¾è¿›è¡Œæ³¨å†Œå³å¯ï¼ˆnameå±æ€§æŒ‡å®šApplicationçš„å…¨é™å®šç±»åï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.example.shellapk;<br><br><span class="hljs-keyword">import</span> android.app.Application;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate();<br>        <span class="hljs-comment">//å¯ä»¥è¿›è¡Œä¸€äº›å…¨å±€é…ç½®</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä¸»è¦é‡å†™é‡Œé¢çš„<code>onCreate()</code>æ–¹æ³•ï¼ˆ<strong>Applicationçš„<code>onCreate()</code>æ‰æ˜¯çœŸæ­£çš„Androidç¨‹åºçš„å…¥å£ç‚¹</strong>ï¼‰ï¼Œå¯ä»¥åœ¨é‡Œé‡Œé¢åˆå§‹åŒ–ä¸€äº›å…¨å±€å˜é‡ï¼Œç„¶ååœ¨æ•´ä¸ªåº”ç”¨ä¸­çš„å„ä¸ªæ–‡ä»¶ä¸­å°±å¯ä»¥å¯¹è¿™äº›å˜é‡è¿›è¡Œæ“ä½œäº†ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!-- å…¨å±€å”¯ä¸€ï¼Œåˆ é™¤é»˜è®¤çš„application --&gt;</span><br><span class="hljs-comment">&lt;!--    &lt;application--&gt;</span><br><span class="hljs-comment">&lt;!--        android:allowBackup=&quot;true&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--        android:fullBackupContent=&quot;@xml/backup_rules&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--        android:icon=&quot;@mipmap/ic_launcher&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--        android:label=&quot;@string/app_name&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--        android:supportsRtl=&quot;true&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--        android:theme=&quot;@style/Theme.ShellApk&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--        tools:targetApi=&quot;31&quot; /&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!-- æ³¨å†Œè‡ªå·±è‡ªå®šä¹‰çš„application --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">application</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.example.shellapk.ProxyApplication&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p>Applicationæ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒæ˜¯æœ€å…ˆåˆ›å»ºçš„ï¼ˆæ—©äºä»»ä½•ä¸€ä¸ªActivityã€Serviceç­‰ç»„ä»¶ï¼‰ï¼Œå› è€Œæ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªå…¨å±€çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œåœ¨è¿™ä¸ªApplicationç±»ä¸­å¯ä»¥è®¿é—®å’Œç®¡ç†åº”ç”¨ç¨‹åºä¸­çš„å…¶ä»–ç»„ä»¶ï¼Œå³ä¸å…¶ä»–ç»„ä»¶ä¹‹é—´æœ‰ç‰¹å®šçš„äº¤äº’é€»è¾‘å’Œæ•°æ®å…±äº«æœºåˆ¶ã€‚ï¼ˆæˆ‘ä¼¼ä¹å·²ç»æ˜ç™½äº†ä¸ºä»€ä¹ˆå£³ç¨‹åºé‡Œé¢éœ€è¦æ›¿æ¢æ‰å·²æœ‰çš„Applicationå®ä¾‹ä¸ºæºç¨‹åºçš„Applicationï¼Œå› ä¸ºApplicationå¯ä»¥è®¤ä¸ºæ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æŠ½è±¡ï¼Œå¦‚æœä¸æ›¿æ¢æ‰å£³ç¨‹åºçš„Applicationï¼Œå³ä½¿é€šè¿‡DexClassLoaderåŠ è½½æºç¨‹åºAPKï¼Œä»ä¼šæ— æ³•æ­£å¸¸è¿è¡Œï¼‰</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://guides.codepath.com/android/Understanding-the-Android-Application-Class">https://guides.codepath.com/android/Understanding-the-Android-Application-Class</a></p><p><a href="https://developer.android.com/reference/android/app/Application">https://developer.android.com/reference/android/app/Application</a></p><p><a href="https://www.jianshu.com/p/d21a65e06cdb">Android-Applicationè¯¦è§£ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/383410949">Androidç»„ä»¶åŒ–ä¹‹Application - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Androidä¸­Applicationçš„åˆ›å»ºæµç¨‹</title>
    <link href="/2023/11/27/Android%E4%B8%ADApplication%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B/"/>
    <url>/2023/11/27/Android%E4%B8%ADApplication%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>Systemè¿›ç¨‹å’ŒAppè¿›ç¨‹éƒ½è¿è¡Œç€ä¸€ä¸ªæˆ–å¤šä¸ªAppï¼Œæ¯ä¸ªAppéƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„Applicationå¯¹è±¡(è¯¥å¯¹è±¡è·ŸLoadedApkä¸€ä¸€å¯¹åº”)ã€‚ä¸‹é¢åˆ†åˆ«è§£æä»¥ä¸‹ä¸¤ç§è¿›ç¨‹åˆ›å»ºApplicationçš„è¿‡ç¨‹ï¼š</p><ul><li>System Serverè¿›ç¨‹</li><li>Appè¿›ç¨‹</li></ul><h1 id="äºŒã€System-Serverè¿›ç¨‹"><a href="#äºŒã€System-Serverè¿›ç¨‹" class="headerlink" title="äºŒã€System Serverè¿›ç¨‹"></a>äºŒã€System Serverè¿›ç¨‹</h1><p>åœ¨<a href="https://gal2xy.github.io/2023/07/04/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">Androidç³»ç»Ÿå¯åŠ¨æµç¨‹</a>ä¸€æ–‡ä¸­ï¼Œè®²åˆ°è¿‡Zygoteé€šè¿‡å›è°ƒå‡½æ•°è¿›å…¥åˆ°System Serveré˜¶æ®µï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†System Serverçš„<code>main()</code>æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨<code>run()</code>æ–¹æ³•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/java/com/android/server/SystemServer.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemServer</span>().run();<span class="hljs-comment">//è§2.1 </span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-1-SystemServer-run"><a href="#2-1-SystemServer-run" class="headerlink" title="2.1 SystemServer.run()"></a>2.1 SystemServer.run()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/java/com/android/server/SystemServer.java  </span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        ......<br>        <span class="hljs-comment">//åˆ›å»ºæ¶ˆæ¯Looper</span><br>        Looper.prepareMainLooper();<br>        <span class="hljs-comment">//åŠ è½½åŠ¨æ€åº“libandroid_servers.so</span><br>        System.loadLibrary(<span class="hljs-string">&quot;android_servers&quot;</span>);<br>        performPendingShutdown();<br>        <span class="hljs-comment">//åˆ›å»ºç³»ç»Ÿçš„Context</span><br>        createSystemContext();<span class="hljs-comment">//è§2.2</span><br>        <span class="hljs-comment">//åˆ›å»ºSystemServiceManager</span><br>        mSystemServiceManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemServiceManager</span>(mSystemContext);<br>        mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);<br>        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);<br>        <span class="hljs-comment">// Prepare the thread pool for init tasks that can be parallelized</span><br>        SystemServerInitThreadPool.get();<br>    &#125;<br>    ...<br>    <span class="hljs-keyword">try</span> &#123;<br>        traceBeginAndSlog(<span class="hljs-string">&quot;StartServices&quot;</span>);<br>        <span class="hljs-comment">//å¯åŠ¨å¼•å¯¼æœåŠ¡</span><br>        startBootstrapServices();<br>        <span class="hljs-comment">//å¯åŠ¨æ ¸å¿ƒæœåŠ¡</span><br>        startCoreServices();<br>        <span class="hljs-comment">//å¯åŠ¨å…¶ä»–æœåŠ¡</span><br>        startOtherServices();<br>        SystemServerInitThreadPool.shutdown();<br>    &#125; <br>......<br>    Looper.loop();<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨System Serverçš„<code>run()</code>æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨<code>createSystemContext()</code>æ¥åˆ›å»ºç³»ç»Ÿçš„ä¸Šä¸‹æ–‡ã€‚</p><h2 id="2-2-createSystemContext"><a href="#2-2-createSystemContext" class="headerlink" title="2.2 createSystemContext()"></a>2.2 createSystemContext()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/java/com/android/server/SystemServer.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createSystemContext</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">activityThread</span> <span class="hljs-operator">=</span> ActivityThread.systemMain();<span class="hljs-comment">//è§[2.3]</span><br>    mSystemContext = activityThread.getSystemContext();<span class="hljs-comment">//è·å–ç³»ç»Ÿä¸Šä¸‹æ–‡</span><br>    mSystemContext.setTheme(DEFAULT_SYSTEM_THEME);<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Context</span> <span class="hljs-variable">systemUiContext</span> <span class="hljs-operator">=</span> activityThread.getSystemUiContext();<span class="hljs-comment">//è·å–ç³»ç»ŸUIä¸Šä¸‹æ–‡</span><br>    systemUiContext.setTheme(DEFAULT_SYSTEM_THEME);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>ActivityThread.systemMain()</code>æ–¹æ³•ï¼Œä»¥åŠ<code>getSystemContext()</code>è·å–ç³»ç»Ÿä¸Šä¸‹æ–‡ã€<code>getSystemUiContext()</code>è·å–ç³»ç»ŸUIä¸Šä¸‹æ–‡ã€‚</p><h2 id="2-3-ActivityThread-systemMain"><a href="#2-3-ActivityThread-systemMain" class="headerlink" title="2.3 ActivityThread.systemMain()"></a>2.3 ActivityThread.systemMain()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ActivityThread <span class="hljs-title function_">systemMain</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// é«˜å†…å­˜è®¾å¤‡è¿›è¡Œç¡¬ä»¶åŠ é€Ÿç»˜å›¾</span><br>    <span class="hljs-keyword">if</span> (!ActivityManager.isHighEndGfx()) &#123;<br>        ThreadedRenderer.disable(<span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ThreadedRenderer.enableForegroundTrimming();<br>    &#125;<br>    <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();<span class="hljs-comment">//è§2.4</span><br>    thread.attach(<span class="hljs-literal">true</span>);<span class="hljs-comment">//è§2.5</span><br>    <span class="hljs-keyword">return</span> thread;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-4-ActivityThreadåˆå§‹åŒ–"><a href="#2-4-ActivityThreadåˆå§‹åŒ–" class="headerlink" title="2.4 ActivityThreadåˆå§‹åŒ–"></a>2.4 ActivityThreadåˆå§‹åŒ–</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityThread</span> &#123;<br><span class="hljs-keyword">private</span> ContextImpl mSystemContext;<span class="hljs-comment">//è®°å½•systemè¿›ç¨‹çš„ContextImplå¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> ContextImpl mSystemUiContext;<span class="hljs-comment">//ç³»ç»Ÿ UI çš„ä¸Šä¸‹æ–‡å¯¹è±¡</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ApplicationThread</span> <span class="hljs-variable">mAppThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationThread</span>();<span class="hljs-comment">//åˆ›å»ºApplicationThreadå¯¹è±¡</span><br>    AppBindData mBoundApplication;<span class="hljs-comment">//ç”¨äºç»‘å®šåº”ç”¨ç¨‹åºçš„ç›¸å…³ä¿¡æ¯</span><br>    Application mInitialApplication;<span class="hljs-comment">//å½“å‰è¿›ç¨‹ä¸­é¦–æ¬¡åˆå§‹åŒ–çš„appå¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> ActivityThread sCurrentActivityThread;<span class="hljs-comment">//è®°å½•å½“å‰ActivityThread</span><br>    Instrumentation mInstrumentation;<span class="hljs-comment">//ç”¨äºç›‘æ§å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„æ‰§è¡Œç¯å¢ƒã€‚å®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å‘åº”ç”¨ç¨‹åºæ³¨å…¥ä»£ç ï¼Œç›‘è§†å’Œæ§åˆ¶åº”ç”¨ç¨‹åºçš„è¡Œä¸º</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">mSystemThread</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<span class="hljs-comment">//æ ‡è®°å½“å‰è¿›ç¨‹æ˜¯å¦ä¸ºsystemè¿›ç¨‹</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Handler sMainThreadHandler;<span class="hljs-comment">//å¤„ç†ä¸»çº¿ç¨‹æ¶ˆæ¯çš„å¥æŸ„</span><br>    ...<br>    ActivityThread() &#123;<br>        mResourcesManager = ResourcesManager.getInstance();<span class="hljs-comment">//è·å–èµ„æºç®¡ç†å®ä¾‹</span><br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºActivityThreadå®ä¾‹æ—¶ï¼Œä¼šåˆå§‹åŒ–å¾ˆå¤šå˜é‡ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªApplicationç±»çš„mInitialApplicationå¯¹è±¡ï¼Œå®ƒçš„åˆå§‹åŒ–åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ol><li>System Serverè¿›ç¨‹åˆ™æ˜¯ç”±<code>ActivityThread.attach()</code>è¿‡ç¨‹èµ‹å€¼ã€‚</li><li>æ™®é€šAppè¿›ç¨‹åˆ™æ˜¯ç”±<code>ActivityThread.handleBindApplication()</code>è¿‡ç¨‹èµ‹å€¼ã€‚</li></ol><h2 id="2-5-ActivityThread-attach"><a href="#2-5-ActivityThread-attach" class="headerlink" title="2.5 ActivityThread.attach()"></a>2.5 ActivityThread.attach()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(<span class="hljs-type">boolean</span> system)</span> &#123;<br>    sCurrentActivityThread = <span class="hljs-built_in">this</span>;<br>    mSystemThread = system;<span class="hljs-comment">//ä¼ å…¥çš„å‚æ•°ä¸ºtrue,å³è®¾ç½®mSystemThreadä¸ºtrueï¼Œè¿™æ„å‘³ç€å½“å‰è¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›ç¨‹</span><br>    <span class="hljs-keyword">if</span> (!system) &#123;<span class="hljs-comment">//éç³»ç»Ÿè¿›ç¨‹æ‰§è¡Œè¯¥åˆ†æ”¯</span><br>        ...<br>    &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//ç³»ç»Ÿè¿›ç¨‹æ‰§è¡Œè¯¥åˆ†æ”¯</span><br>        ...<br>        <span class="hljs-keyword">try</span> &#123;<br>            mInstrumentation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Instrumentation</span>();<span class="hljs-comment">//åˆ›å»ºInstrumentationå¯¹åƒ</span><br>            <span class="hljs-comment">//getSystemContextè§[2.6]</span><br>            <span class="hljs-comment">//createAppContextè§[2.7]</span><br>            <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, getSystemContext().mPackageInfo);<br>            <span class="hljs-comment">//makeApplicationè§[2.8]</span><br>            mInitialApplication = context.mPackageInfo.makeApplication(<span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);<br>            mInitialApplication.onCreate();<span class="hljs-comment">//åˆ›å»ºApplicationå¯¹è±¡</span><br>        &#125; <br>        ...<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ å…¥çš„systemå‚æ•°ä¸ºtrueï¼Œè¿™æ„å‘³ç€å½“å‰è¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›ç¨‹ï¼Œå¯¹åº”è¿›å…¥elseåˆ†æ”¯ï¼Œä¼šå®ä¾‹åŒ–mInstrumentationå’ŒmInitialApplicationå¯¹è±¡ã€‚</p><h2 id="2-6-getSystemContext"><a href="#2-6-getSystemContext" class="headerlink" title="2.6 getSystemContext()"></a>2.6 getSystemContext()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> ContextImpl <span class="hljs-title function_">getSystemContext</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (mSystemContext == <span class="hljs-literal">null</span>) &#123;<br>            mSystemContext = ContextImpl.createSystemContext(<span class="hljs-built_in">this</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> mSystemContext;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>createSystemContext()</code>åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡ã€‚</p><h3 id="2-6-1-createSystemContext"><a href="#2-6-1-createSystemContext" class="headerlink" title="2.6.1 createSystemContext()"></a>2.6.1 createSystemContext()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ContextImpl.java</span><br><span class="hljs-keyword">static</span> ContextImpl <span class="hljs-title function_">createSystemContext</span><span class="hljs-params">(ActivityThread mainThread)</span> &#123;<br><span class="hljs-comment">//åˆ›å»ºLoadedApkå¯¹è±¡ï¼Œè§[2.6.1.1]</span><br>    <span class="hljs-type">LoadedApk</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadedApk</span>(mainThread);<br>    <span class="hljs-comment">//åˆ›å»ºContextImplå¯¹è±¡ï¼Œè§[2.6.1.2]</span><br>    <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextImpl</span>(<span class="hljs-literal">null</span>, mainThread, packageInfo, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>);<br><span class="hljs-comment">//è®¾ç½®èµ„æºå¹¶æ›´æ–°èµ„æºé…ç½®</span><br>    context.setResources(packageInfo.getResources());<br>    context.mResources.updateConfiguration(context.mResourcesManager.getConfiguration(),<br>                                           context.mResourcesManager.getDisplayMetrics());<br>    <span class="hljs-keyword">return</span> context;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºLoadedApkå¯¹è±¡å’ŒContextImplå¯¹è±¡ï¼Œå¹¶è®¾ç½®èµ„æºã€æ›´æ–°èµ„æºé…ç½®ã€‚</p><h4 id="2-6-1-1-LoadedApkåˆå§‹åŒ–"><a href="#2-6-1-1-LoadedApkåˆå§‹åŒ–" class="headerlink" title="2.6.1.1 LoadedApkåˆå§‹åŒ–"></a>2.6.1.1 LoadedApkåˆå§‹åŒ–</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadedApk</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActivityThread mActivityThread;<br>    <span class="hljs-keyword">final</span> String mPackageName;<br>    <span class="hljs-keyword">private</span> ApplicationInfo mApplicationInfo;<br>    <span class="hljs-keyword">private</span> String mAppDir;<br>    <span class="hljs-keyword">private</span> String mResDir;<br>    <span class="hljs-keyword">private</span> String[] mOverlayDirs;<br>    <span class="hljs-keyword">private</span> String[] mSharedLibraries;<br>    <span class="hljs-keyword">private</span> String mDataDir;<br>    <span class="hljs-keyword">private</span> String mLibDir;<br>    <span class="hljs-keyword">private</span> File mDataDirFile;<br>    <span class="hljs-keyword">private</span> File mDeviceProtectedDataDirFile;<br>    <span class="hljs-keyword">private</span> File mCredentialProtectedDataDirFile;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassLoader mBaseClassLoader;<br>    ...<br>    Resources mResources;<br>    <span class="hljs-keyword">private</span> ClassLoader mClassLoader;<br>    <span class="hljs-keyword">private</span> Application mApplication;<br>    ...<br>    <span class="hljs-comment">// Create information about a new .apk</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LoadedApk</span><span class="hljs-params">(ActivityThread activityThread, ApplicationInfo aInfo,</span><br><span class="hljs-params">            CompatibilityInfo compatInfo, ClassLoader baseLoader,</span><br><span class="hljs-params">            <span class="hljs-type">boolean</span> securityViolation, <span class="hljs-type">boolean</span> includeCode, <span class="hljs-type">boolean</span> registerPackage)</span> &#123;<br>        mActivityThread = activityThread;<br>        setApplicationInfo(aInfo);<br>        mPackageName = aInfo.packageName;<br>        mBaseClassLoader = baseLoader;<br>        mSecurityViolation = securityViolation;<br>        mIncludeCode = includeCode;<br>        mRegisterPackage = registerPackage;<br>        mDisplayAdjustments.setCompatibilityInfo(compatInfo);<br>    &#125;<br>    <br>    LoadedApk(ActivityThread activityThread) &#123;<br>        mActivityThread = activityThread;<span class="hljs-comment">//å¯¹åº”ActivityThreadå®ä¾‹</span><br>        mApplicationInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationInfo</span>();<span class="hljs-comment">//åˆ›å»ºApplicationInfoå¯¹è±¡ï¼Œé‡Œé¢å•¥ä¹Ÿæ²¡å¹²</span><br>        mApplicationInfo.packageName = <span class="hljs-string">&quot;android&quot;</span>;<span class="hljs-comment">//é»˜è®¤åŒ…åä¸º&quot;android&quot;</span><br>        mPackageName = <span class="hljs-string">&quot;android&quot;</span>;<br>        ...<br>        mClassLoader = ClassLoader.getSystemClassLoader();<span class="hljs-comment">//è§https://gal2xy.github.io/2023/11/25/Androidä¸­çš„ClassLoader/</span><br>        mResources = Resources.getSystem();<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>LoadedApkä¸»è¦æ˜¯ç”¨æ¥åˆ›å»ºapkçš„ç›¸å…³ä¿¡æ¯ï¼Œå¹¶é›†åˆæˆä¸€ä¸ªLoadedApkå¯¹è±¡ï¼Œå…¶ä¸­ç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šæ´»åŠ¨çº¿ç¨‹ã€åŒ…åã€èµ„æºç›®å½•ã€å…±äº«åº“ç›®å½•ã€ç±»åŠ è½½å™¨ç­‰ç­‰ã€‚System Serverè¿›ç¨‹èµ°çš„æ˜¯å¸¦ä¸€ä¸ªå‚æ•°çš„LoadedApkæ„é€ å‡½æ•°ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯å°†ä¹‹å‰åˆ›å»ºçš„ActivityThreadå®ä¾‹èµ‹å€¼mActivityThreadå­—æ®µã€åˆ›å»ºApplicationInfoå¯¹è±¡ã€è·å–ç±»åŠ è½½å™¨ã€‚</p><h4 id="2-6-1-2-ContextImplåˆå§‹åŒ–"><a href="#2-6-1-2-ContextImplåˆå§‹åŒ–" class="headerlink" title="2.6.1.2 ContextImplåˆå§‹åŒ–"></a>2.6.1.2 ContextImplåˆå§‹åŒ–</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ContextImpl.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">ContextImpl</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ContextImpl container, <span class="hljs-meta">@NonNull</span> ActivityThread mainThread,</span><br><span class="hljs-params">                    <span class="hljs-meta">@NonNull</span> LoadedApk packageInfo, <span class="hljs-meta">@Nullable</span> String splitName,</span><br><span class="hljs-params">                    <span class="hljs-meta">@Nullable</span> IBinder activityToken, <span class="hljs-meta">@Nullable</span> UserHandle user, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">                    <span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>    mOuterContext = <span class="hljs-built_in">this</span>;<br>    <span class="hljs-keyword">if</span> ((flags &amp; (Context.CONTEXT_CREDENTIAL_PROTECTED_STORAGE<br>                  | Context.CONTEXT_DEVICE_PROTECTED_STORAGE)) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">dataDir</span> <span class="hljs-operator">=</span> packageInfo.getDataDirFile();<br>        <span class="hljs-keyword">if</span> (Objects.equals(dataDir, packageInfo.getCredentialProtectedDataDirFile())) &#123;<br>            flags |= Context.CONTEXT_CREDENTIAL_PROTECTED_STORAGE;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Objects.equals(dataDir, packageInfo.getDeviceProtectedDataDirFile())) &#123;<br>            flags |= Context.CONTEXT_DEVICE_PROTECTED_STORAGE;<br>        &#125;<br>    &#125;<br>    mMainThread = mainThread;<br>    mActivityToken = activityToken;<br>    mFlags = flags;<br><span class="hljs-comment">//è®¾ç½®å½“å‰è¿›ç¨‹çš„ç”¨æˆ·</span><br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        user = Process.myUserHandle();<br>    &#125;<br>    mUser = user;<br><span class="hljs-comment">//å°†åˆšåˆšåˆ›å»ºçš„LoadedApkå®ä¾‹èµ‹ç»™mPackageInfo</span><br>    mPackageInfo = packageInfo;<br>    mSplitName = splitName;<br>    mClassLoader = classLoader;<br>    mResourcesManager = ResourcesManager.getInstance();<br><span class="hljs-comment">//æ ¹æ®ä¼ å…¥çš„ä¸Šä¸‹æ–‡å¯¹è±¡containeræ˜¯å¦ä¸ºç©ºæ¥è¿›è¡Œä¸åŒæ“ä½œ</span><br>    <span class="hljs-keyword">if</span> (container != <span class="hljs-literal">null</span>) &#123;<br>        mBasePackageName = container.mBasePackageName;<br>        mOpPackageName = container.mOpPackageName;<br>        setResources(container.mResources);<br>        mDisplay = container.mDisplay;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//å°†åˆšåˆšåˆ›å»ºçš„LoadedApkå®ä¾‹çš„ä¿¡æ¯èµ‹å€¼æŸäº›å­—æ®µ</span><br>        mBasePackageName = packageInfo.mPackageName;<br>        <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">ainfo</span> <span class="hljs-operator">=</span> packageInfo.getApplicationInfo();<span class="hljs-comment">//å®é™…ä¸Šæ˜¯ç©ºçš„å¯¹è±¡</span><br>        <span class="hljs-keyword">if</span> (ainfo.uid == Process.SYSTEM_UID &amp;&amp; ainfo.uid != Process.myUid()) &#123;<br>            mOpPackageName = ActivityThread.currentPackageName();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            mOpPackageName = mBasePackageName;<br>        &#125;<br>    &#125;<br>    mContentResolver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationContentResolver</span>(<span class="hljs-built_in">this</span>, mainThread, user);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ å…¥çš„å‚æ•°mainThreadä¸ºä¹‹å‰åˆ›å»ºçš„ActivityThreadå®ä¾‹ã€å‚æ•°packageInfoä¸ºåˆšåˆšåˆ›å»ºçš„LoadedApkå®ä¾‹ã€‚</p><p>æ•´ä¸ªä»£ç å®é™…ä¸Šæ˜¯åˆ©ç”¨åˆšåˆšåˆ›å»ºçš„LoadedApkå®ä¾‹æ¥åˆ›å»ºContextImplå®ä¾‹ã€‚</p><h2 id="2-7-ContextImpl-createAppContext"><a href="#2-7-ContextImpl-createAppContext" class="headerlink" title="2.7 ContextImpl.createAppContext()"></a>2.7 ContextImpl.createAppContext()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ContextImpl.java</span><br><span class="hljs-keyword">static</span> ContextImpl <span class="hljs-title function_">createAppContext</span><span class="hljs-params">(ActivityThread mainThread, LoadedApk packageInfo)</span> &#123;<br>    <span class="hljs-keyword">if</span> (packageInfo == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;packageInfo&quot;</span>);<br>    <span class="hljs-comment">//è§[2.6.1.2]</span><br>    <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextImpl</span>(<span class="hljs-literal">null</span>, mainThread, packageInfo, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>);<br>    context.setResources(packageInfo.getResources());<span class="hljs-comment">//è®¾ç½®appèµ„æº</span><br>    <span class="hljs-keyword">return</span> context;<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ï¼Œä¼ å…¥çš„å‚æ•°mainThreadä¸ºä¹‹å‰åˆ›å»ºçš„ActivityThreadå®ä¾‹ï¼Œå‚æ•°packageInfoæ˜¯ContextImplå®ä¾‹ï¼ˆåœ¨2.6.1.2ä¸­åˆ›å»ºçš„ï¼‰ä¸­çš„mpackageInfoï¼ˆåœ¨2.6.1.1ä¸­åˆ›å»ºçš„ï¼‰ã€‚</p><p>è°ƒç”¨ContextImplçš„æ„é€ å‡½æ•°å†åˆ›å»ºä¸€æ¬¡ContextImplå®ä¾‹ï¼ï¼Ÿæ˜¯å› ä¸ºä¸€ä¸ªæ˜¯SystemContextä¸€ä¸ªæ˜¯AppContextçš„ç¼˜æ•…ï¼Ÿ</p><h2 id="2-8-makeApplication"><a href="#2-8-makeApplication" class="headerlink" title="2.8 makeApplication()"></a>2.8 makeApplication()</h2><p>åœ¨2.5ä¸­é€šè¿‡<code>context.mPackageInfo.makeApplication(true, null)</code>è°ƒç”¨è¯¥æ–¹æ³•ï¼Œcontext.mPackageInfoæ˜¯åˆšåˆšåˆ›å»ºçš„LoadedApkå®ä¾‹ï¼ˆåœ¨2.6.1.1ä¸­åˆ›å»ºçš„ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="hljs-keyword">public</span> Application <span class="hljs-title function_">makeApplication</span><span class="hljs-params">(<span class="hljs-type">boolean</span> forceDefaultAppClass,</span><br><span class="hljs-params">                                   Instrumentation instrumentation)</span> &#123;<br>    <span class="hljs-comment">//ä¿è¯ä¸€ä¸ªLoadedApkå¯¹è±¡åªåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„Applicationå¯¹è±¡</span><br>    <span class="hljs-keyword">if</span> (mApplication != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> mApplication;<br>    &#125;<br>...<br>    <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">appClass</span> <span class="hljs-operator">=</span> mApplicationInfo.className;<br>    <span class="hljs-keyword">if</span> (forceDefaultAppClass || (appClass == <span class="hljs-literal">null</span>)) &#123;<span class="hljs-comment">//ä¼ å…¥çš„å‚æ•°ä¸ºtrueï¼Œè¿›å…¥è¯¥åˆ†æ”¯</span><br>        appClass = <span class="hljs-string">&quot;android.app.Application&quot;</span>;<span class="hljs-comment">//system_serverè¿›ç¨‹è¿›å…¥è¯¥åˆ†æ”¯</span><br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//è·å–ç±»åŠ è½½å™¨ï¼Œè§[2.9]</span><br>        java.lang.<span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> getClassLoader();<br>        <span class="hljs-keyword">if</span> (!mPackageName.equals(<span class="hljs-string">&quot;android&quot;</span>)) &#123;<span class="hljs-comment">//åœ¨ä¹‹å‰æµç¨‹å¯çŸ¥é»˜è®¤androidï¼Œæ˜¾ç„¶ä¸è¿›å…¥æ­¤åˆ†æ”¯</span><br>            initializeJavaContextClassLoader();<br>        &#125;<br>        <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(mActivityThread, <span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">//åˆ›å»ºApplicationå¯¹è±¡ï¼Œè§[2.10]</span><br>        app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext);<br>        appContext.setOuterContext(app);<br>    &#125; <br>    ...<br>    mActivityThread.mAllApplications.add(app);<span class="hljs-comment">//åŠ å…¥åˆ°Applicationåˆ—è¡¨ä¸­ï¼Œä¹‹å‰è¯´ä¸ªä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªapp</span><br>    mApplication = app;<span class="hljs-comment">//å°†åˆšåˆšåˆ›å»ºçš„Applicationå¯¹è±¡appèµ‹å€¼ç»™mApplication</span><br>    <span class="hljs-keyword">if</span> (instrumentation != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//ä¼ å…¥çš„instrumentationä¸ºnullï¼Œä¸è¿›å…¥æ­¤åˆ†æ”¯</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            instrumentation.callApplicationOnCreate(app);<br>        &#125; <br>        ...<br>    &#125;<br>    ...<br>    <span class="hljs-keyword">return</span> app;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è·å–appClassã€åˆ›å»ºç±»åŠ è½½å™¨å’ŒappContextï¼Œåˆ©ç”¨è¿™äº›æ¥åˆ›å»ºApplicationå¯¹è±¡ã€‚</p><h2 id="2-9-getClassLoader"><a href="#2-9-getClassLoader" class="headerlink" title="2.9 getClassLoader()"></a>2.9 getClassLoader()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="hljs-keyword">public</span> ClassLoader <span class="hljs-title function_">getClassLoader</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (mClassLoader == <span class="hljs-literal">null</span>) &#123;<br>            createOrUpdateClassLoaderLocked(<span class="hljs-literal">null</span> <span class="hljs-comment">/*addedPaths*/</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> mClassLoader;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœç±»åŠ è½½å™¨ä¸ä¸ºç©ºåˆ™è°ƒç”¨<code>createOrUpdateClassLoaderLocked()</code>æ–¹æ³•ã€‚</p><h3 id="2-9-1-createOrUpdateClassLoaderLocked"><a href="#2-9-1-createOrUpdateClassLoaderLocked" class="headerlink" title="2.9.1 createOrUpdateClassLoaderLocked()"></a>2.9.1 createOrUpdateClassLoaderLocked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrUpdateClassLoaderLocked</span><span class="hljs-params">(List&lt;String&gt; addedPaths)</span> &#123;<br>        <span class="hljs-keyword">if</span> (mPackageName.equals(<span class="hljs-string">&quot;android&quot;</span>)) &#123;<span class="hljs-comment">//System Serverè¿›ç¨‹è¿›å…¥è¯¥åˆ†æ”¯</span><br>            <span class="hljs-keyword">if</span> (mClassLoader != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (mBaseClassLoader != <span class="hljs-literal">null</span>) &#123;<br>                mClassLoader = mBaseClassLoader;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                mClassLoader = ClassLoader.getSystemClassLoader();<span class="hljs-comment">//å¦‚æœæ˜¯System Serverè¿›ç¨‹åˆ™åˆ°è¿™</span><br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    <span class="hljs-comment">//mPackageNameä¸ä¸º&quot;android&quot;</span><br>        ...<br>        <span class="hljs-keyword">if</span> (mRegisterPackage) &#123;<br>            ...<br>                <span class="hljs-comment">//æ·»åŠ åŒ…ä¾èµ–ï¼Œè§[2.9.2]</span><br>                ActivityManager.getService().addPackageDependency(mPackageName);<br>            ...<br>        &#125;<br>        <span class="hljs-comment">// Lists for the elements of zip/code and native libraries.</span><br>        <span class="hljs-keyword">final</span> List&lt;String&gt; zipPaths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">final</span> List&lt;String&gt; libPaths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isBundledApp</span> <span class="hljs-operator">=</span> mApplicationInfo.isSystemApp() &amp;&amp; !mApplicationInfo.isUpdatedSystemApp();<br>        <span class="hljs-comment">//æ„å»ºè·¯å¾„ï¼Œè§[2.9.3]</span><br>    makePaths(mActivityThread, isBundledApp, mApplicationInfo, zipPaths, libPaths);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">libraryPermittedPath</span> <span class="hljs-operator">=</span> mDataDir;<br>        <span class="hljs-keyword">if</span> (isBundledApp) &#123;<br>            libraryPermittedPath += File.pathSeparator + System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">librarySearchPath</span> <span class="hljs-operator">=</span> TextUtils.join(File.pathSeparator, libPaths);<br>        <span class="hljs-keyword">if</span> (!mIncludeCode) &#123;<span class="hljs-comment">//æ„é€ å‡½æ•°ä¸­mIncludeCodeä¸ºtrue</span><br>            ...<br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">zip</span> <span class="hljs-operator">=</span> (zipPaths.size() == <span class="hljs-number">1</span>) ? zipPaths.get(<span class="hljs-number">0</span>) : TextUtils.join(File.pathSeparator, zipPaths);<br>...<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">needToSetupJitProfiles</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (mClassLoader == <span class="hljs-literal">null</span>) &#123;<br>            ...<br>            <span class="hljs-comment">////è§[2.9.4]</span><br>            mClassLoader = ApplicationLoaders.getDefault().getClassLoader(zip,<br>                    mApplicationInfo.targetSdkVersion, isBundledApp, librarySearchPath,<br>                    libraryPermittedPath, mBaseClassLoader);<br>            ...<br>        &#125;<br>    ...<br>        <span class="hljs-comment">// Setup jit profile support.</span><br>        ...<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="2-9-2-ActivityManagerService-addPackageDependency"><a href="#2-9-2-ActivityManagerService-addPackageDependency" class="headerlink" title="2.9.2 ActivityManagerService.addPackageDependency()"></a>2.9.2 ActivityManagerService.addPackageDependency()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPackageDependency</span><span class="hljs-params">(String packageName)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-comment">//è·å–è°ƒç”¨è¯¥æ–¹æ³•çš„è¿›ç¨‹id</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();<br>        <span class="hljs-comment">//è°ƒç”¨è¯¥æ–¹æ³•çš„è¿›ç¨‹çš„ PID å’Œå½“å‰è¿›ç¨‹çš„ PID ç›¸åŒï¼Œè¯´æ˜æ˜¯åœ¨å½“å‰è¿›ç¨‹å†…éƒ¨è°ƒç”¨è¯¥æ–¹æ³•ï¼Œç›´æ¥è¿”å›</span><br>        <span class="hljs-keyword">if</span> (callingPid == myPid()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        ProcessRecord proc;<br>        <span class="hljs-keyword">synchronized</span> (mPidsSelfLocked) &#123;<br>            <span class="hljs-comment">//æ ¹æ®è°ƒç”¨è¯¥æ–¹æ³•çš„è¿›ç¨‹idè·å–å¯¹åº”è¿›ç¨‹è®°å½•</span><br>            proc = mPidsSelfLocked.get(Binder.getCallingPid());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (proc != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//æˆåŠŸè·å–åˆ°è¯¥è¿›ç¨‹çš„è®°å½•</span><br>            <span class="hljs-keyword">if</span> (proc.pkgDeps == <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//è¯¥è¿›ç¨‹çš„åŒ…åä¾èµ–ä¸ºç©º</span><br>                proc.pkgDeps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;String&gt;(<span class="hljs-number">1</span>);<br>            &#125;<br>            proc.pkgDeps.add(packageName);<span class="hljs-comment">//æ·»åŠ åŒ…åä¾èµ–</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-9-3-makePaths"><a href="#2-9-3-makePaths" class="headerlink" title="2.9.3 makePaths()"></a>2.9.3 makePaths()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makePaths</span><span class="hljs-params">(ActivityThread activityThread,</span><br><span class="hljs-params">                             <span class="hljs-type">boolean</span> isBundledApp,</span><br><span class="hljs-params">                             ApplicationInfo aInfo,</span><br><span class="hljs-params">                             List&lt;String&gt; outZipPaths,</span><br><span class="hljs-params">                             List&lt;String&gt; outLibPaths)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">appDir</span> <span class="hljs-operator">=</span> aInfo.sourceDir;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">libDir</span> <span class="hljs-operator">=</span> aInfo.nativeLibraryDir;<br>    <span class="hljs-keyword">final</span> String[] sharedLibraries = aInfo.sharedLibraryFiles;<br><br>    outZipPaths.clear();<br>    outZipPaths.add(appDir);<br><br>    <span class="hljs-comment">// Do not load all available splits if the app requested isolated split loading.</span><br>    <span class="hljs-keyword">if</span> (aInfo.splitSourceDirs != <span class="hljs-literal">null</span> &amp;&amp; !aInfo.requestsIsolatedSplitLoading()) &#123;<br>        Collections.addAll(outZipPaths, aInfo.splitSourceDirs);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (outLibPaths != <span class="hljs-literal">null</span>) &#123;<br>        outLibPaths.clear();<br>    &#125;<br><br>    String[] instrumentationLibs = <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// activityThread will be null when called from the WebView zygote; just assume</span><br>    <span class="hljs-comment">// no instrumentation applies in this case.</span><br>    <span class="hljs-keyword">if</span> (activityThread != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">instrumentationPackageName</span> <span class="hljs-operator">=</span> activityThread.mInstrumentationPackageName;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">instrumentationAppDir</span> <span class="hljs-operator">=</span> activityThread.mInstrumentationAppDir;<br>        String[] instrumentationSplitAppDirs = activityThread.mInstrumentationSplitAppDirs;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">instrumentationLibDir</span> <span class="hljs-operator">=</span> activityThread.mInstrumentationLibDir;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">instrumentedAppDir</span> <span class="hljs-operator">=</span> activityThread.mInstrumentedAppDir;<br>        String[] instrumentedSplitAppDirs = activityThread.mInstrumentedSplitAppDirs;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">instrumentedLibDir</span> <span class="hljs-operator">=</span> activityThread.mInstrumentedLibDir;<br><br>        <span class="hljs-keyword">if</span> (appDir.equals(instrumentationAppDir)<br>            || appDir.equals(instrumentedAppDir)) &#123;<br>            outZipPaths.clear();<br>            outZipPaths.add(instrumentationAppDir);<br><br>            <span class="hljs-comment">// Only add splits if the app did not request isolated split loading.</span><br>            <span class="hljs-keyword">if</span> (!aInfo.requestsIsolatedSplitLoading()) &#123;<br>                <span class="hljs-keyword">if</span> (instrumentationSplitAppDirs != <span class="hljs-literal">null</span>) &#123;<br>                    Collections.addAll(outZipPaths, instrumentationSplitAppDirs);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (!instrumentationAppDir.equals(instrumentedAppDir)) &#123;<br>                    outZipPaths.add(instrumentedAppDir);<br>                    <span class="hljs-keyword">if</span> (instrumentedSplitAppDirs != <span class="hljs-literal">null</span>) &#123;<br>                        Collections.addAll(outZipPaths, instrumentedSplitAppDirs);<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (outLibPaths != <span class="hljs-literal">null</span>) &#123;<br>                outLibPaths.add(instrumentationLibDir);<br>                <span class="hljs-keyword">if</span> (!instrumentationLibDir.equals(instrumentedLibDir)) &#123;<br>                    outLibPaths.add(instrumentedLibDir);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (!instrumentedAppDir.equals(instrumentationAppDir)) &#123;<br>                instrumentationLibs = getLibrariesFor(instrumentationPackageName);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (outLibPaths != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (outLibPaths.isEmpty()) &#123;<br>            outLibPaths.add(libDir);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (aInfo.primaryCpuAbi != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//ç›®æ ‡sdkç‰ˆæœ¬ &lt; Android 7çš„sdkç‰ˆæœ¬</span><br>            <span class="hljs-keyword">if</span> (aInfo.targetSdkVersion &lt; Build.VERSION_CODES.N) &#123;<br>                outLibPaths.add(<span class="hljs-string">&quot;/system/fake-libs&quot;</span> + (VMRuntime.is64BitAbi(aInfo.primaryCpuAbi) ? <span class="hljs-string">&quot;64&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>            &#125;<br>            <span class="hljs-keyword">for</span> (String apk : outZipPaths) &#123;<br>                outLibPaths.add(apk + <span class="hljs-string">&quot;!/lib/&quot;</span> + aInfo.primaryCpuAbi);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (isBundledApp) &#123;<br>            outLibPaths.add(System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>));<br>        &#125;<br>    &#125;<br><span class="hljs-comment">//éå†sharedLibrariesçš„Libåº“ï¼ŒæœªåŒ…å«åœ¨å…¶ä¸­çš„åˆ™æ·»åŠ åˆ°outZipPathsä¸­ï¼Œå¦‚æœéœ€è¦è¿˜å¯ä»¥æ·»åŠ åˆ°outLibPaths</span><br>    <span class="hljs-keyword">if</span> (sharedLibraries != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (String lib : sharedLibraries) &#123;<br>            <span class="hljs-keyword">if</span> (!outZipPaths.contains(lib)) &#123;<br>                outZipPaths.add(<span class="hljs-number">0</span>, lib);<br>                appendApkLibPathIfNeeded(lib, aInfo, outLibPaths);<br>            &#125;<br>        &#125;<br>    &#125;<br><span class="hljs-comment">//éå†instrumentationçš„Libåº“ï¼ŒæœªåŒ…å«åœ¨å…¶ä¸­çš„åˆ™æ·»åŠ åˆ°outZipPathsä¸­ï¼Œå¦‚æœéœ€è¦è¿˜å¯ä»¥æ·»åŠ åˆ°outLibPaths</span><br>    ...é€»è¾‘åŒä¸Š<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-9-4-ApplicationLoader-getClassLoader"><a href="#2-9-4-ApplicationLoader-getClassLoader" class="headerlink" title="2.9.4 ApplicationLoader.getClassLoader()"></a>2.9.4 ApplicationLoader.getClassLoader()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ApplicationLoaders.java</span><br>ClassLoader <span class="hljs-title function_">getClassLoader</span><span class="hljs-params">(String zip, <span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">boolean</span> isBundled, String librarySearchPath, String libraryPermittedPath, ClassLoader parent)</span> &#123;<br>    <span class="hljs-keyword">return</span> getClassLoader(zip, targetSdkVersion, isBundled, librarySearchPath, libraryPermittedPath, parent, zip);<br>&#125;<br><br><span class="hljs-keyword">private</span> ClassLoader <span class="hljs-title function_">getClassLoader</span><span class="hljs-params">(String zip, <span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">boolean</span> isBundled,</span><br><span class="hljs-params">                                   String librarySearchPath, String libraryPermittedPath,</span><br><span class="hljs-params">                                   ClassLoader parent, String cacheKey)</span> &#123;<br><span class="hljs-comment">//è·å–çˆ¶åŠ è½½å™¨</span><br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">baseParent</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader().getParent();<br><br>    <span class="hljs-keyword">synchronized</span> (mLoaders) &#123;<br>        <span class="hljs-keyword">if</span> (parent == <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//èµ°è¿™</span><br>            parent = baseParent;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (parent == baseParent) &#123;<span class="hljs-comment">//è¿›è€Œèµ°è¿™</span><br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> mLoaders.get(cacheKey);<br>            <span class="hljs-keyword">if</span> (loader != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> loader;<br>            &#125;<br>            <span class="hljs-comment">//åˆ›å»ºpathClassloaderå¯¹è±¡</span><br>            <span class="hljs-type">PathClassLoader</span> <span class="hljs-variable">pathClassloader</span> <span class="hljs-operator">=</span> PathClassLoaderFactory.createClassLoader(<br>                zip,<br>                librarySearchPath,<br>                libraryPermittedPath,<br>                parent,<br>                targetSdkVersion,<br>                isBundled);<br>            <span class="hljs-comment">//nativeæ–¹æ³•</span><br>            setupVulkanLayerPath(pathClassloader, librarySearchPath);<br>            mLoaders.put(cacheKey, pathClassloader);<br>            <span class="hljs-keyword">return</span> pathClassloader;<br>        &#125;<br>        <span class="hljs-type">PathClassLoader</span> <span class="hljs-variable">pathClassloader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathClassLoader</span>(zip, parent);<br>        <span class="hljs-keyword">return</span> pathClassloader;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ å…¥çš„å‚æ•°parentï¼ˆClassLoaderå¯¹è±¡ï¼‰ä¸ºmBaseClassLoaderï¼Œåœ¨SystemServerè¿›ç¨‹ä¸­LoadedApkåˆå§‹åŒ–æ—¶æ˜¯ä¸ºnullçš„ï¼Œæ‰€ä»¥èµ°<code>if (parent == null) </code>åˆ†æ”¯ï¼Œè¿›è€Œèµ°<code>if (parent == baseParent) </code>åˆ†æ”¯ã€‚</p><h2 id="2-10-newApplication"><a href="#2-10-newApplication" class="headerlink" title="2.10 newApplication()"></a>2.10 newApplication()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="hljs-keyword">public</span> Application <span class="hljs-title function_">newApplication</span><span class="hljs-params">(ClassLoader cl, String className, Context context)</span> <span class="hljs-keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException &#123;<br>    <span class="hljs-keyword">return</span> newApplication(cl.loadClass(className), context);<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> Application <span class="hljs-title function_">newApplication</span><span class="hljs-params">(Class&lt;?&gt; clazz, Context context)</span> <span class="hljs-keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException &#123;<br>    <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> (Application)clazz.newInstance();<br>    app.attach(context);<br>    <span class="hljs-keyword">return</span> app;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ å…¥çš„å‚æ•°clæ˜¯åœ¨ 2.9 å¤„è·å¾—çš„PathClassLoaderå¯¹è±¡ï¼Œå‚æ•°classNameå¯¹åº”è¦åŠ è½½çš„Applicationç±»ï¼ˆâ€android.app.Applicationâ€ï¼‰ï¼Œæœ€åé€šè¿‡åå°„è·å–åˆ°è¯¥ç±»ï¼Œç„¶åè°ƒç”¨<code>newInstance()</code>æ–¹æ³•å®ä¾‹åŒ–Applicationã€‚</p><h3 id="2-10-1-Application-attach"><a href="#2-10-1-Application-attach" class="headerlink" title="2.10.1 Application.attach()"></a>2.10.1 Application.attach()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/Application.java</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(Context context)</span> &#123;<br>    attachBaseContext(context);<br>    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;<br>&#125;<br><br><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/content/ContextWrapper.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachBaseContext</span><span class="hljs-params">(Context base)</span> &#123;<br>    <span class="hljs-keyword">if</span> (mBase != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Base context already set&quot;</span>);<br>    &#125;<br>    mBase = base;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸»è¦åŠŸèƒ½:</p><ol><li>å°†æ–°åˆ›å»ºçš„ContextImplå¯¹è±¡ï¼ˆ2.8ä¸­åˆ›å»ºçš„appContextï¼‰ä¿å­˜åˆ°Applicationçš„çˆ¶ç±»æˆå‘˜å˜é‡mBase;</li><li>å°†æ–°åˆ›å»ºçš„LoadedApkå¯¹è±¡ï¼ˆ2.8ä¸­åˆ›å»ºçš„appContextä¸­çš„mPackageInfoå¯¹è±¡ï¼‰ä¿å­˜åˆ°Applicationçš„çˆ¶å‘˜å˜é‡mLoadedApk;</li></ol><h1 id="ä¸‰ã€Appè¿›ç¨‹"><a href="#ä¸‰ã€Appè¿›ç¨‹" class="headerlink" title="ä¸‰ã€Appè¿›ç¨‹"></a>ä¸‰ã€Appè¿›ç¨‹</h1><p>åœ¨<a href="https://gal2xy.github.io/2023/07/17/Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B(%E4%B8%80)/">Androidåº”ç”¨ç¨‹åºå¯åŠ¨æµç¨‹(ä¸€)</a>ä¸€æ–‡ä¸­ï¼Œåº”ç”¨ç¨‹åºåŒæ ·ä¹Ÿé€šè¿‡å›è°ƒå‡½æ•°<code>Zygote.MethodAndArgsCaller()</code>è¿›å…¥åˆ°Appè¿è¡Œé˜¶æ®µï¼Œå³å›è°ƒ<code>ActivityThread.main()</code>æ–¹æ³•ã€‚</p><h2 id="3-1-ActivityThread-main"><a href="#3-1-ActivityThread-main" class="headerlink" title="3.1 ActivityThread.main()"></a>3.1 ActivityThread.main()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    ...<br><span class="hljs-comment">//åˆ›å»ºçº¿ç¨‹å¹¶å°†å½“å‰çº¿ç¨‹é™„åŠ åˆ°ActivityThreadï¼Œå‚æ•°falseè¡¨ç¤ºä¸ä½¿ç”¨æ–°çº¿ç¨‹</span><br>    <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();<br>    thread.attach(<span class="hljs-literal">false</span>);<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†<code>thread.attach()</code>æ–¹æ³•ã€‚</p><h2 id="3-2-ActivityThread-attach"><a href="#3-2-ActivityThread-attach" class="headerlink" title="3.2 ActivityThread.attach()"></a>3.2 ActivityThread.attach()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(<span class="hljs-type">boolean</span> system)</span> &#123;<br>    sCurrentActivityThread = <span class="hljs-built_in">this</span>;<br>    mSystemThread = system;<br>    <span class="hljs-keyword">if</span> (!system) &#123;<span class="hljs-comment">//éç³»ç»Ÿè¿›ç¨‹è¿›å…¥æ­¤åˆ†æ”¯</span><br>        <span class="hljs-comment">//åˆå§‹åŒ–RuntimeInit.mApplicationObjectå€¼</span><br>        RuntimeInit.setApplicationObject(mAppThread.asBinder());<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">IActivityManager</span> <span class="hljs-variable">mgr</span> <span class="hljs-operator">=</span> ActivityManager.getService();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è§[3.3]</span><br>            mgr.attachApplication(mAppThread);<br>        &#125; <br>        ...<br>    &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//ç³»ç»Ÿè¿›ç¨‹è¿›å…¥æ­¤åˆ†æ”¯</span><br>        ...<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>é‡ç‚¹æ˜¯<code>mgr.attachApplication(mAppThread)</code>ã€‚</p><h2 id="3-3-ActivityManagerService-attachApplication"><a href="#3-3-ActivityManagerService-attachApplication" class="headerlink" title="3.3 ActivityManagerService.attachApplication()"></a>3.3 ActivityManagerService.attachApplication()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachApplication</span><span class="hljs-params">(IApplicationThread thread)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-comment">//è·å–è°ƒç”¨è¯¥æ–¹æ³•çš„è¿›ç¨‹çš„pid</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();<br>        <span class="hljs-comment">//ä¸´æ—¶æ¸…é™¤è°ƒç”¨è€…çš„èº«ä»½ä¿¡æ¯,è¿”å›å”¯ä¸€æ ‡è¯†ç¬¦ä»¥ä¾¿åç»­æ¢å¤è°ƒç”¨è€…èº«ä»½</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">origId</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();<br>        <span class="hljs-comment">//ç»™è¿›ç¨‹é™„åŠ Applicationï¼Œè§[3.4]</span><br>        attachApplicationLocked(thread, callingPid);<br>        <span class="hljs-comment">//æ¢å¤ä¹‹å‰æ¸…é™¤çš„è°ƒç”¨è€…èº«ä»½</span><br>        Binder.restoreCallingIdentity(origId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€è°ƒç”¨<code>attachApplicationLocked()</code>æ–¹æ³•ç»™è¿›ç¨‹é™„åŠ Applicationã€‚</p><h2 id="3-4-attachApplicationLocked"><a href="#3-4-attachApplicationLocked" class="headerlink" title="3.4 attachApplicationLocked()"></a>3.4 attachApplicationLocked()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">attachApplicationLocked</span><span class="hljs-params">(IApplicationThread thread, <span class="hljs-type">int</span> pid)</span> &#123;<br>    ProcessRecord app;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> SystemClock.uptimeMillis();<br>    <span class="hljs-keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">synchronized</span> (mPidsSelfLocked) &#123;<br>            app = mPidsSelfLocked.get(pid);<span class="hljs-comment">//æ ¹æ®pidè·å–application record</span><br>        &#125;<br>    &#125;<br>    ...<br>    <span class="hljs-keyword">try</span> &#123;<br>        ...<br>        <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">appInfo</span> <span class="hljs-operator">=</span> app.instr != <span class="hljs-literal">null</span> ? app.instr.mTargetInfo : app.info;<br>        ...<br>        <span class="hljs-keyword">if</span> (app.instr != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//è§[3.5]</span><br>            thread.bindApplication(processName, appInfo, providers,<br>                                   app.instr.mClass,<br>                                   profilerInfo, app.instr.mArguments,<br>                                   app.instr.mWatcher,<br>                                   app.instr.mUiAutomationConnection, testMode,<br>                                   mBinderTransactionTrackingEnabled, enableTrackAllocation,<br>                                   isRestrictedBackupMode || !normalMode, app.persistent,<br>                                   <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(getGlobalConfiguration()), app.compat,<br>                                   getCommonServicesLocked(app.isolated),<br>                                   mCoreSettingsObserver.getCoreSettingsLocked(),<br>                                   buildSerial);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//ä¹Ÿæ˜¯è°ƒç”¨thread.bindApplication(),åªä¸è¿‡å‚æ•°ä¸åŒ</span><br>            ...<br>        &#125;<br><br>        ...<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç å¾ˆé•¿ï¼Œè¿™é‡Œåªå…³æ³¨<code>thread.bindApplication()</code>æ–¹æ³•ã€‚</p><h2 id="3-5-ActivityThread-bindApplication"><a href="#3-5-ActivityThread-bindApplication" class="headerlink" title="3.5 ActivityThread.bindApplication()"></a>3.5 ActivityThread.bindApplication()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindApplication</span><span class="hljs-params">(String processName, ApplicationInfo appInfo,</span><br><span class="hljs-params">                                  List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</span><br><span class="hljs-params">                                  ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span><br><span class="hljs-params">                                  IInstrumentationWatcher instrumentationWatcher,</span><br><span class="hljs-params">                                  IUiAutomationConnection instrumentationUiConnection, <span class="hljs-type">int</span> debugMode,</span><br><span class="hljs-params">                                  <span class="hljs-type">boolean</span> enableBinderTracking, <span class="hljs-type">boolean</span> trackAllocation,</span><br><span class="hljs-params">                                  <span class="hljs-type">boolean</span> isRestrictedBackupMode, <span class="hljs-type">boolean</span> persistent, Configuration config,</span><br><span class="hljs-params">                                  CompatibilityInfo compatInfo, Map services, Bundle coreSettings,</span><br><span class="hljs-params">                                  String buildSerial)</span> &#123;<br><br>    <span class="hljs-comment">//ç»™AppBindDataå®ä¾‹ï¼ˆdataï¼‰è¿›è¡Œä¸€ç³»åˆ—èµ‹å€¼</span><br>    ...<br>    <br>    sendMessage(H.BIND_APPLICATION, data);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹dataå¯¹è±¡è¿›è¡Œäº†ä¸€ç³»åˆ—çš„èµ‹å€¼ï¼Œæœ€ç»ˆè°ƒç”¨<code>sendMessage()</code>æ–¹æ³•å°†<code>BIND_APPLICATION</code>æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ¥ç€æˆ‘ä»¬å°±éœ€è¦çœ‹ActivityThreadçš„<code>handleMessage()</code>æ–¹æ³•äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (msg.what) &#123;<br>        ...<br>        <span class="hljs-keyword">case</span> BIND_APPLICATION:<br><span class="hljs-type">AppBindData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> (AppBindData)msg.obj;<br>            <span class="hljs-comment">//è§[3.6]</span><br>            handleBindApplication(data);<br>            <span class="hljs-keyword">break</span>;<br>        ...<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»çº¿ç¨‹æ¥æ”¶åˆ°<code>BIND_APPLICATION</code>æ¶ˆæ¯ï¼Œæ‰§è¡Œ<code>handleBindApplication()</code>æ–¹æ³•ã€‚</p><h2 id="3-6-handleBindApplication"><a href="#3-6-handleBindApplication" class="headerlink" title="3.6 handleBindApplication()"></a>3.6 handleBindApplication()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(AppBindData data)</span> &#123;<br>    ...<br>    mBoundApplication = data;<br>    ...<br>    <span class="hljs-comment">//è·å–LoadedApkå¯¹è±¡,è§[3.7]</span><br>    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);<br>...<br>    <span class="hljs-comment">//åˆ›å»ºappContextï¼Œè§[2.7]</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, data.info);<br>    ...<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//æ­¤å¤„data.infoæŒ‡LoadedApk, é€šè¿‡åå°„åˆ›å»ºç›®æ ‡åº”ç”¨Applicationå¯¹è±¡ï¼Œè§[2.8]</span><br>        <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> data.info.makeApplication(data.restrictedBackupMode, <span class="hljs-literal">null</span>);<br>        mInitialApplication = app;<br>        ...<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è°ƒç”¨çš„æ˜¯ç©ºæ–¹æ³•ï¼Œå•¥ä¹Ÿæ²¡å¹²,è§[3.6.1]</span><br>            mInstrumentation.onCreate(data.instrumentationArgs);<br>        &#125;<br>        ...<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è§[3.6.1]</span><br>            mInstrumentation.callApplicationOnCreate(app);<br>        &#125; <br>        ...<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        StrictMode.setThreadPolicy(savedPolicy);<br>    &#125;<br>    <span class="hljs-comment">// Preload fonts resources</span><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è·å–LoadedApkå¯¹è±¡ï¼Œå€Ÿæ­¤åˆ›å»ºContextImplå¯¹è±¡ï¼ˆappContextï¼‰ä»¥åŠApplicationå¯¹è±¡ï¼ˆappï¼‰ï¼Œå¹¶å°†åˆ›å»ºå¥½çš„appèµ‹å€¼ç»™ActivityThreadçš„mInitialApplicationå­—æ®µã€‚</p><h3 id="3-6-1-callApplicationOnCreate"><a href="#3-6-1-callApplicationOnCreate" class="headerlink" title="3.6.1 callApplicationOnCreate()"></a>3.6.1 callApplicationOnCreate()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">/frameworks/base/core/java/android/app/Instrumentation.java<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callApplicationOnCreate</span><span class="hljs-params">(Application app)</span> &#123;<br>    app.onCreate();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle arguments)</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-7-getPackageInfoNoCheck"><a href="#3-7-getPackageInfoNoCheck" class="headerlink" title="3.7 getPackageInfoNoCheck()"></a>3.7 getPackageInfoNoCheck()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> LoadedApk <span class="hljs-title function_">getPackageInfoNoCheck</span><span class="hljs-params">(ApplicationInfo ai, CompatibilityInfo compatInfo)</span> &#123;<br>    <span class="hljs-keyword">return</span> getPackageInfo(ai, compatInfo, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-keyword">private</span> LoadedApk <span class="hljs-title function_">getPackageInfo</span><span class="hljs-params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span><br><span class="hljs-params">                                 ClassLoader baseLoader, <span class="hljs-type">boolean</span> securityViolation, <span class="hljs-type">boolean</span> includeCode,</span><br><span class="hljs-params">                                 <span class="hljs-type">boolean</span> registerPackage)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">differentUser</span> <span class="hljs-operator">=</span> (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));<br>    <span class="hljs-keyword">synchronized</span> (mResourcesManager) &#123;<br>        WeakReference&lt;LoadedApk&gt; ref;<br>        <span class="hljs-comment">// æ ¹æ®ä¸åŒçš„æƒ…å†µè·å–ç¼“å­˜çš„LoadedApkå¯¹è±¡</span><br>        <span class="hljs-keyword">if</span> (differentUser) &#123;<br>            <span class="hljs-comment">// Caching not supported across users</span><br>            ref = <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (includeCode) &#123;<br>            ref = mPackages.get(aInfo.packageName);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ref = mResourcePackages.get(aInfo.packageName);<br>        &#125;<br><br>        <span class="hljs-type">LoadedApk</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span> ref != <span class="hljs-literal">null</span> ? ref.get() : <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (packageInfo == <span class="hljs-literal">null</span> || (packageInfo.mResources != <span class="hljs-literal">null</span><br>                                    &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) &#123;<br>            ...<br>            <span class="hljs-comment">//åˆ›å»ºLoadedApkå¯¹è±¡</span><br>            packageInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadedApk</span>(<span class="hljs-built_in">this</span>, aInfo, compatInfo, baseLoader,<br>                              securityViolation, includeCode &amp;&amp;<br>                              (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="hljs-number">0</span>, registerPackage);<br><br>            <span class="hljs-keyword">if</span> (mSystemThread &amp;&amp; <span class="hljs-string">&quot;android&quot;</span>.equals(aInfo.packageName)) &#123;<br>               <span class="hljs-comment">//è§[3.7.1]</span><br>                packageInfo.installSystemApplicationInfo(aInfo,<br>                                                         getSystemContext().mPackageInfo.getClassLoader());<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (differentUser) &#123;<br>                <span class="hljs-comment">// Caching not supported across users</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (includeCode) &#123;<br>                <span class="hljs-comment">//æ›´æ–°mPackagesï¼Œå³å°†åˆšåˆ›å»ºçš„packageInfoåŠ å…¥</span><br>                mPackages.put(aInfo.packageName,<br>                              <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;LoadedApk&gt;(packageInfo));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                mResourcePackages.put(aInfo.packageName,<br>                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;LoadedApk&gt;(packageInfo));<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> packageInfo;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºLoadedApkå¯¹è±¡ï¼Œå¹¶å°†å°†æ–°åˆ›å»ºçš„LoadedApkåŠ å…¥åˆ°mPackagesã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªappéƒ½ä¼šåˆ›å»ºå”¯ä¸€çš„LoadedApkå¯¹è±¡ã€‚æ­¤å¤„aInfoæ¥æºäºProcessRecord.infoå˜é‡ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹ä¸­çš„ç¬¬ä¸€ä¸ªappã€‚</p><h3 id="3-7-1-installSystemApplicationInfo"><a href="#3-7-1-installSystemApplicationInfo" class="headerlink" title="3.7.1 installSystemApplicationInfo()"></a>3.7.1 installSystemApplicationInfo()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">installSystemApplicationInfo</span><span class="hljs-params">(ApplicationInfo info, ClassLoader classLoader)</span> &#123;<br>    <span class="hljs-keyword">assert</span> info.packageName.equals(<span class="hljs-string">&quot;android&quot;</span>);<br>    mApplicationInfo = info;<br>    mClassLoader = classLoader;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªå‚æ•°é€šè¿‡<code>getSystemContext().mPackageInfo.getClassLoader()</code>è·å–çš„ï¼Œå¯¹åº”LoadedApkå¯¹è±¡ä¸­çš„ClassLoaderã€‚ä»£ç ä¸­å¾ˆæ˜æ˜¾çš„ä¸€ä¸ªç‰¹å¾å°±æ˜¯æ¯”å¯¹packageNameæ˜¯å¦ä¸ºâ€androidâ€ï¼Œè€Œåœ¨System Serverè¿›ç¨‹ä¸­åˆ›å»ºçš„LoadedApkå¯¹è±¡é»˜è®¤packageNameä¸ºâ€androidâ€ã€‚</p><h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p>LoadedApkä¸Applicationä¸€ä¸€å¯¹åº”ï¼ŒApplicationå€ŸåŠ©LoadedApkåˆ›å»ºçš„ï¼Œå¹¶å­˜æ”¾åœ¨LoadedApkçš„mApplicationå­—æ®µï¼Œè€Œåœ¨åˆ›å»ºApplicationçš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå°†LoadedApkå­˜æ”¾åœ¨Applicationçš„mLoadedApkå­—æ®µï¼ˆäº’ç›¸åŒ…å«ï¼ï¼Ÿï¼‰ã€‚æœ€åè¿”å›Applicationçš„æ—¶å€™ï¼Œä¹Ÿå°†Applicationå­˜æ”¾åœ¨ActivityThreadä¸­çš„mInitialApplicationå­—æ®µã€‚</p><p>æ¥ä¸‹æ¥å€Ÿç”¨gityuançš„ä¸¤ç§æµç¨‹å›¾ï¼š</p><ul><li><p>System Serverè¿›ç¨‹åˆ›å»ºApplication</p><p><img src="https://gityuan.com/images/application/system_application.jpg"></p></li><li><p>Appè¿›ç¨‹åˆ›å»ºApplication</p><p><img src="https://gityuan.com/images/application/app_application.jpg"></p></li></ul><hr><p>å‚è€ƒï¼š</p><p><a href="http://androidxref.com/8.0.0_r4/xref/">http://androidxref.com/8.0.0_r4/xref/</a></p><p><a href="https://gityuan.com/2017/04/02/android-application/">https://gityuan.com/2017/04/02/android-application/</a></p><p><a href="https://phantomvk.github.io/2019/07/23/Android_Application_class/">https://phantomvk.github.io/2019/07/23/Android_Application_class/</a></p><p><a href="https://ljd1996.github.io/2019/12/16/Android-Application/">https://ljd1996.github.io/2019/12/16/Android-Application/</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Application</tag>
      
      <tag>Androidæºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidä¸­çš„ClassLoader</title>
    <link href="/2023/11/25/Android%E4%B8%AD%E7%9A%84ClassLoader/"/>
    <url>/2023/11/25/Android%E4%B8%AD%E7%9A%84ClassLoader/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ClassLoaderçš„ç±»å‹"><a href="#ä¸€ã€ClassLoaderçš„ç±»å‹" class="headerlink" title="ä¸€ã€ClassLoaderçš„ç±»å‹"></a>ä¸€ã€ClassLoaderçš„ç±»å‹</h1><p>javaä¸­çš„ClassLoaderå’ŒAndroidä¸­çš„ClassLoaderå¹¶ä¸å®Œå…¨ç›¸åŒï¼Œå› ä¸ºjavaçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸ºclassæ–‡ä»¶ï¼Œè€ŒAndroidçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸ºdexæ–‡ä»¶ï¼Œä»–ä»¬æ‰€åŠ è½½çš„æ–‡ä»¶ä¸åŒï¼Œå› è€Œæ‰€ä½¿ç”¨çš„ClassLoaderä¹Ÿä¸ç›¸åŒã€‚</p><p>Androidä¸­çš„ClassLoaderåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p><ol><li>ç³»ç»Ÿç±»åŠ è½½å™¨ï¼šBootClassLoaderã€PathClassLoaderã€DexClassLoaderã€‚</li><li>è‡ªå®šä¹‰åŠ è½½å™¨ï¼Œå³ç»§æ‰¿è‡ªç³»ç»Ÿçš„ç±»åŠ è½½å™¨ã€‚</li></ol><h2 id="1-1-BootClassLoader"><a href="#1-1-BootClassLoader" class="headerlink" title="1.1 BootClassLoader"></a>1.1 BootClassLoader</h2><p>Androidç³»ç»Ÿå¯åŠ¨æ—¶ä¼šä½¿ç”¨BootClassLoaderæ¥é¢„åŠ è½½å¸¸ç”¨ç±»ï¼Œå®ƒç”±Javaå®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BootClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BootClassLoader instance;<br><br>    <span class="hljs-meta">@FindBugsSuppressWarnings(&quot;DP_CREATE_CLASSLOADER_INSIDE_DO_PRIVILEGED&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> BootClassLoader <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BootClassLoader</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br><br>    ......<br>&#125;<br></code></pre></td></tr></table></figure><p>BootClassLoaderæ˜¯ClassLoaderçš„å†…éƒ¨ç±»ï¼Œå¹¶ç»§æ‰¿è‡ªClassLoaderã€‚ç”±äºBootClassLoaderçš„æƒé™å£°æ˜æ˜¯é»˜è®¤çš„ï¼Œåªæœ‰åœ¨åŒä¸€åŒ…ä¸­æ‰èƒ½è®¿é—®ï¼Œå› æ­¤æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­æ˜¯æ— æ³•ç›´æ¥è°ƒç”¨çš„ã€‚</p><h2 id="1-2-DexClassLoader"><a href="#1-2-DexClassLoader" class="headerlink" title="1.2 DexClassLoader"></a>1.2 DexClassLoader</h2><p>DexClassLoaderæ˜¯ç”¨æ¥åŠ è½½dexæ–‡ä»¶ä»¥åŠåŒ…å«dexæ–‡ä»¶çš„å‹ç¼©åŒ…ï¼ˆapkã€jarï¼‰ã€‚å®ƒçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DexClassLoader</span><span class="hljs-params">(String dexPath, String optimizedDirectory,</span><br><span class="hljs-params">            String librarySearchPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(optimizedDirectory), librarySearchPath, parent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚æ•°è§£æå¦‚ä¸‹ï¼š</p><ul><li><code>dexPath</code>ï¼šdexæ–‡ä»¶æˆ–åŒ…å«dexæ–‡ä»¶çš„jar&#x2F;apkæ–‡ä»¶çš„è·¯å¾„é›†åˆï¼Œå¤šä¸ªè·¯å¾„ç”¨æ–‡ä»¶åˆ†éš”ç¬¦åˆ†éš”ï¼Œé»˜è®¤æ–‡ä»¶åˆ†éš”ç¬¦ä¸ºâ€:â€ã€‚</li><li><code>optimizedDirectory</code>ï¼šdexä¼˜åŒ–åäº§ç”Ÿçš„æ–‡ä»¶æ‰€å­˜æ”¾çš„è·¯å¾„ã€‚</li><li><code>librarySearchPath</code>ï¼šnativeåº“çš„è·¯å¾„é›†åˆï¼Œå¤šä¸ªè·¯å¾„ç”¨æ–‡ä»¶åˆ†éš”ç¬¦åˆ†éš”ã€‚</li><li><code>parent</code>ï¼šçˆ¶åŠ è½½å™¨</li></ul><p>DexClassLoaderç»§æ‰¿è‡ªBaseDexClassLoaderï¼Œå®ƒçš„æ–¹æ³•å‡åœ¨BaseDexClassLoaderä¸­å®ç°ã€‚DexClassLoaderé€šå¸¸ç”¨æ¥åŠ è½½å·²å®‰è£…çš„jarã€apkã€dexä»¥åŠSDå¡ä¸­åŠ è½½æœªå®‰è£…çš„apkã€‚</p><h2 id="1-3-PathClassLoader"><a href="#1-3-PathClassLoader" class="headerlink" title="1.3 PathClassLoader"></a>1.3 PathClassLoader</h2><p>Androidç³»ç»Ÿä½¿ç”¨PathClassLoaderæ¥åŠ è½½ç³»ç»Ÿç±»å’Œåº”ç”¨ç¨‹åºçš„ç±»ï¼Œå®ƒçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/PathClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PathClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PathClassLoader</span><span class="hljs-params">(String dexPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, parent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PathClassLoader</span><span class="hljs-params">(String dexPath, String librarySearchPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-literal">null</span>, librarySearchPath, parent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒDexClassLoaderä¸€æ ·ï¼ŒPathClassLoaderç»§æ‰¿è‡ªBaseDexClassLoaderï¼Œæ–¹æ³•ä¹Ÿéƒ½åœ¨çˆ¶ç±»ä¸­å®ç°ã€‚</p><p>å¯ä»¥æ³¨æ„åˆ°ï¼ŒPathClassLoaderçš„æ„é€ æ–¹æ³•ä¸­éƒ½æ²¡æœ‰optimizedDirectoryå‚æ•°ï¼Œè¿™æ˜¯å› ä¸ºPathClassLoaderä¸­é»˜è®¤optimizedDirectoryçš„å€¼ä¸º<code>/data/dalvik-cache</code>ï¼ˆæ˜¯çš„ï¼Œé»˜è®¤dexä¼˜åŒ–æ–‡ä»¶çš„å­˜æ”¾ç›®å½•ï¼‰ï¼Œå› æ­¤PathClassLoaderæ˜¯ç”¨æ¥åŠ è½½ç³»ç»Ÿä¸­å·²ç»å®‰è£…è¿‡çš„apkçš„dexæ–‡ä»¶ã€‚</p><h2 id="1-4-BaseDexClassLoader"><a href="#1-4-BaseDexClassLoader" class="headerlink" title="1.4 BaseDexClassLoader"></a>1.4 BaseDexClassLoader</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DexPathList pathList;  <span class="hljs-comment">//è®°å½•dexæ–‡ä»¶è·¯å¾„ä¿¡æ¯</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(String dexPath, File optimizedDirectory, String libraryPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexPath, libraryPath, optimizedDirectory);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>BaseDexClassLoaderç»§æ‰¿è‡ªClassLoaderï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–äº†DexPathListå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ¯”è¾ƒå…³é”®ï¼Œåç»­ä¼šè®²è§£åˆ°ã€‚</p><h2 id="1-5-ClassLoader"><a href="#1-5-ClassLoader" class="headerlink" title="1.5 ClassLoader"></a>1.5 ClassLoader</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> ClassLoader parent;  <span class="hljs-comment">//è®°å½•çˆ¶ç±»åŠ è½½å™¨</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Void <span class="hljs-title function_">checkCreateClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">(Void unused, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">this</span>.parent = parent;<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>(checkCreateClassLoader(), getSystemClassLoader());<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">(ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">this</span>(checkCreateClassLoader(), parent);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>ClassLoaderæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>getSystemClassLoader()</code>æ–¹æ³•ï¼Œè·å–SystemClassLoaderï¼Œå®ƒçš„ä»£ç åŒæ ·åœ¨ClassLoaderç±»ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemClassLoader</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> ClassLoader.createSystemClassLoader();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title function_">getSystemClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SystemClassLoader.loader;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title function_">createSystemClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.class.path&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">librarySearchPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathClassLoader</span>(classPath, librarySearchPath, BootClassLoader.getInstance());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯è§SystemClassLoaderå¯¹åº”çš„æ˜¯PathClassLoaderã€‚</p><p>ä»ClassLoaderçš„ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯åˆ›å»ºä¸€ä¸ªClassLoaderå®ä¾‹ï¼Œéƒ½éœ€è¦ä¸€ä¸ªç°æœ‰çš„ClassLoaderå®ä¾‹ä½œä¸ºæ–°åˆ›å»ºçš„å®ä¾‹çš„Parentï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰çš„ClassLoaderä¹‹é—´çš„å…³è”å°±åƒä¸€æ£µæ ‘ä¸€æ ·ï¼Œè¿™ä¹Ÿæ˜¯ClassLoaderçš„ åŒäº²ä»£ç†æ¨¡å‹çš„ç‰¹ç‚¹ã€‚</p><h1 id="äºŒã€ClassLoaderçš„ç»§æ‰¿å…³ç³»"><a href="#äºŒã€ClassLoaderçš„ç»§æ‰¿å…³ç³»" class="headerlink" title="äºŒã€ClassLoaderçš„ç»§æ‰¿å…³ç³»"></a>äºŒã€ClassLoaderçš„ç»§æ‰¿å…³ç³»</h1><p>å®ƒä»¬ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="E:\LearningLibrary\é€†å‘\AndroidåŸºç¡€çŸ¥è¯†\pic\19.Androidä¸­çš„ClassLoader\a.drawio.png" alt="a.drawio"></p><ul><li>ClassLoaderï¼šå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶ä¸­å®šä¹‰äº†ClassLoaderçš„ä¸»è¦åŠŸèƒ½ã€‚</li><li>BootClassLoaderï¼šå®ƒæ˜¯ClassLoaderçš„å†…éƒ¨ç±»ï¼Œå¹¶ç»§æ‰¿è‡ªClassLoaderï¼Œç”¨æ¥åœ¨Androidç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½å¸¸ç”¨ç±»ã€‚</li><li>SecureClassLoaderï¼šå®ƒä¸JDK 8 ä¸­çš„SecureClassLoaderç±»çš„ä»£ç æ˜¯ä¸€æ ·çš„ï¼Œå®ƒç»§æ‰¿è‡ªClassLoaderã€‚SecureClassLoaderæ‰©å±•äº†ClassLoaderç±»çš„æƒé™æ–¹é¢çš„åŠŸèƒ½ï¼ŒåŠ å¼ºäº†ClassLoaderçš„å®‰å…¨æ€§ã€‚</li><li>URLClassLoaderï¼šå®ƒä¸JDK 8 ä¸­çš„URLClassLoaderç±»çš„ä»£ç æ˜¯ä¸€æ ·çš„ï¼Œå®ƒç»§æ‰¿è‡ªSecureClassLoaderï¼Œç”¨æ¥é€šè¿‡URLè·¯å¾„ä»jaræ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä¸­åŠ è½½ç±»å’Œèµ„æºã€‚</li><li>BaseDexClassLoaderï¼šå®ƒç»§æ‰¿è‡ªClassLoaderï¼Œæ˜¯æŠ½è±¡ç±»ClassLoaderçš„å…·ä½“å®ç°ç±»ã€‚</li><li>InMemoryDexClassLoaderï¼šå®ƒæ˜¯Android 8.0 æ–°å¢çš„ç±»åŠ è½½å™¨ï¼Œç»§æ‰¿è‡ªBaseDexClassLoaderï¼Œç”¨äºåŠ è½½å†…å­˜ä¸­çš„dexæ–‡ä»¶ã€‚</li><li>PathClassLoaderï¼šå®ƒç»§æ‰¿è‡ªBaseDexClassLoaderï¼Œç”¨æ¥åŠ è½½ç³»ç»Ÿä¸­å·²ç»å®‰è£…è¿‡çš„apkçš„dexæ–‡ä»¶ã€‚</li><li>DexClassLoaderï¼šå®ƒç»§æ‰¿è‡ªBaseDexClassLoaderï¼Œç”¨æ¥åŠ è½½å·²å®‰è£…çš„jarã€apkã€dexä»¥åŠSDå¡ä¸­åŠ è½½æœªå®‰è£…çš„apkã€‚</li></ul><p>åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ˜¯ä½¿ç”¨DexClassLoaderå’ŒPathClassLoaderè¿™ä¸¤ä¸ªç±»åŠ è½½å™¨æ¥åŠ è½½ç±»ã€‚</p><h1 id="ä¸‰ã€ç±»åŠ è½½å™¨çš„åŒäº²å§”æ‰˜æ¨¡å¼"><a href="#ä¸‰ã€ç±»åŠ è½½å™¨çš„åŒäº²å§”æ‰˜æ¨¡å¼" class="headerlink" title="ä¸‰ã€ç±»åŠ è½½å™¨çš„åŒäº²å§”æ‰˜æ¨¡å¼"></a>ä¸‰ã€ç±»åŠ è½½å™¨çš„åŒäº²å§”æ‰˜æ¨¡å¼</h1><p>ç±»åŠ è½½å™¨æŸ¥æ‰¾Classæ‰€é‡‡ç”¨çš„æ˜¯åŒäº²å§”æ‰˜æ¨¡å¼ï¼Œå…·ä½“ä¸ºï¼šé¦–å…ˆåˆ¤æ–­è¯¥Classæ˜¯å¦å·²ç»åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨è¿›è¡ŒæŸ¥æ‰¾è€Œä¸æ˜¯è‡ªå·±å…ˆå»æŸ¥æ‰¾ï¼Œè¿™æ ·ä¾æ¬¡é€’å½’ï¼Œç›´åˆ°å§”æ‰˜åˆ°æœ€é¡¶å±‚çš„ClassLoaderï¼Œå¦‚æœæœ€é¡¶å±‚çš„ClassLoaderæ‰¾åˆ°äº†è¯¥Classï¼Œå°±ä¼šç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™äº¤è¿˜ç»™å­åŠ è½½å™¨æŸ¥æ‰¾ï¼Œä¾æ¬¡é€’å½’ï¼Œå¦‚æœè¿˜æ²¡æ‰¾åˆ°åˆ™æœ€åä¼šäº¤è¿˜ç»™è‡ªå·±å»æŸ¥æ‰¾ã€‚</p><p>è¯·æ³¨æ„ï¼Œçˆ¶ç±»åŠ è½½å™¨å’Œå­ç±»åŠ è½½å™¨ä¹‹é—´<strong>å¹¶ä¸æ˜¯ç»§æ‰¿å…³ç³»çš„</strong>ï¼Œè€Œæ˜¯ä½¿ç”¨ç»„åˆå…³ç³»æ¥è°ƒç”¨çˆ¶ç±»åŠ è½½å™¨ï¼Œå³åˆ›å»ºç±»åŠ è½½å™¨æ—¶ä¼ å…¥çš„parentå‚æ•°ã€‚</p><p>å¯¹åº”ClassLoaderä¸­çš„æ ¸å¿ƒä»£ç <code>loadClass()</code>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡äº†è¯¥ç±»</span><br>    Class&lt;?&gt; c = findLoadedClass(name);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//æ²¡æœ‰åŠ è½½è¯¥ç±»ï¼Œä¸”å­˜åœ¨çˆ¶åŠ è½½å™¨ï¼Œäº¤ç»™çˆ¶åŠ è½½å™¨å¤„ç†</span><br>                c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//æ²¡æœ‰åŠ è½½è¯¥ç±»ï¼Œä¸”ä¸å­˜åœ¨çˆ¶åŠ è½½å™¨</span><br>                c = findBootstrapClassOrNull(name);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>            <span class="hljs-comment">// from the non-null parent class loader</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//çˆ¶åŠ è½½å™¨å¤„ç†å¤±è´¥ï¼Œè‡ªå·±æ¥æ‰¾</span><br>            c = findClass(name);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">private</span> Class&lt;?&gt; findBootstrapClassOrNull(String name)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å°±å¾ˆå¥½çš„è¯ é‡Šäº†åŒäº²å§”æ‰˜æ¨¡å¼ã€‚</p><p>åŒäº²å§”æ‰˜æ¨¡å¼ä¼˜ç‚¹ï¼š</p><ol><li>é¿å…é‡å¤åŠ è½½ã€‚</li><li>æ›´åŠ å®‰å…¨ã€‚å¦‚æœä¸ä½¿ç”¨åŒäº²å§”æ‰˜æ¨¡å¼ï¼Œå°±å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªStringç±»æ¥æ›¿ä»£ç³»ç»Ÿçš„Stringç±»ï¼Œè¿™æ˜¾ç„¶ä¼šé€ æˆå®‰å…¨éšæ‚£ã€‚ï¼ˆä¸¤ä¸ªç±»åä¸€è‡´ä¸”è¢«åŒä¸€ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ï¼ŒJVMæ‰ä¼šè®¤ä¸ºå®ƒä»¬æ˜¯åŒä¸€ä¸ªç±»ï¼‰</li></ol><h1 id="å››ã€ClassLoaderåŠ è½½ç±»çš„è¿‡ç¨‹"><a href="#å››ã€ClassLoaderåŠ è½½ç±»çš„è¿‡ç¨‹" class="headerlink" title="å››ã€ClassLoaderåŠ è½½ç±»çš„è¿‡ç¨‹"></a>å››ã€ClassLoaderåŠ è½½ç±»çš„è¿‡ç¨‹</h1><p>ClassLoaderåŠ è½½ç±»çš„æ–¹æ³•ä¸º<code>loadClass()</code>ï¼Œå®ƒè¢«å®šä¹‰åœ¨æŠ½è±¡ç±»ClassLoaderä¸­ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡äº†è¯¥ç±»</span><br>    Class&lt;?&gt; c = findLoadedClass(name);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//æ²¡æœ‰åŠ è½½è¯¥ç±»ï¼Œä¸”å­˜åœ¨çˆ¶åŠ è½½å™¨ï¼Œäº¤ç»™çˆ¶åŠ è½½å™¨å¤„ç†</span><br>                c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//æ²¡æœ‰åŠ è½½è¯¥ç±»ï¼Œä¸”ä¸å­˜åœ¨çˆ¶åŠ è½½å™¨</span><br>                c = findBootstrapClassOrNull(name);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>            <span class="hljs-comment">// from the non-null parent class loader</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//çˆ¶åŠ è½½å™¨å¤„ç†å¤±è´¥ï¼Œè‡ªå·±æ¥æ‰¾</span><br>            c = findClass(name);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">private</span> Class&lt;?&gt; findBootstrapClassOrNull(String name)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨<code>findLoadedClass()</code>æ–¹æ³•æŸ¥çœ‹æœ¬èº«æœ‰æ²¡æœ‰åŠ è½½è¿‡è¯¥ç±»ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; findLoadedClass(String name) &#123;<br>    ClassLoader loader;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == BootClassLoader.getInstance())<br>        loader = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">else</span><br>        loader = <span class="hljs-built_in">this</span>;<br>    <span class="hljs-keyword">return</span> VMClassLoader.findLoadedClass(loader, name);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»§è€Œè°ƒç”¨VMClassLoaderçš„<code>findLoadedClass()</code>æ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/libart/src/main/java/java/lang/VMClassLoader.java</span><br><span class="hljs-keyword">native</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">findLoadedClass</span><span class="hljs-params">(ClassLoader cl, String name)</span>;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨nativeå±‚å®ç°ã€‚</p><p>OKï¼å›åˆ°<code>loadClass()</code>çš„æµç¨‹ä¸­ï¼Œä¹‹åæ˜¯è°ƒç”¨çˆ¶åŠ è½½å™¨çš„<code>loadClass()</code>æ–¹æ³•ï¼ˆå¦‚æœå­˜åœ¨çˆ¶åŠ è½½å™¨ï¼‰ï¼Œå…¶å®å°±æ˜¯è¿™ä¸ªæ–¹æ³•æœ¬èº«ã€‚</p><p>æ¥ä¸‹æ¥çœ‹<code>findClass()</code>æ–¹æ³•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(name);<br>&#125;  <br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">return</span> Class.classForName(name, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>&#125;<br><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/Class.java</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; classForName(String className, <span class="hljs-type">boolean</span> shouldInitialize,<br>                                    ClassLoader classLoader) <span class="hljs-keyword">throws</span> ClassNotFoundException;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ª<code>findClass()</code>æ–¹æ³•ç›´æ¥æŠ›å¼‚å¸¸ï¼Œè¿™è¯´æ˜éœ€è¦å­ç±»æ¥å®ç°ï¼›ç¬¬äºŒä¸ª<code>findClass()</code>æ–¹æ³•åˆ™è°ƒç”¨çš„æ˜¯Classç±»ä¸­çš„<code>classForName()</code>æ–¹æ³•ï¼Œæ˜¯ä¸ªnativeæ–¹æ³•ã€‚</p><p>å›åˆ°ç¬¬ä¸€ä¸ª<code>findClass()</code>æ–¹æ³•ï¼Œå®ƒçš„å®ç°åœ¨BaseDexClassLoaderç±»ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    List&lt;Throwable&gt; suppressedExceptions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Throwable&gt;();<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> pathList.findClass(name, suppressedExceptions);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">ClassNotFoundException</span> <span class="hljs-variable">cnfe</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(<span class="hljs-string">&quot;Didn&#x27;t find class \&quot;&quot;</span> + name + <span class="hljs-string">&quot;\&quot; on path: &quot;</span> + pathList);<br>        <span class="hljs-keyword">for</span> (Throwable t : suppressedExceptions) &#123;<br>            cnfe.addSuppressed(t);<br>        &#125;<br>        <span class="hljs-keyword">throw</span> cnfe;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(String dexPath, File optimizedDirectory, String librarySearchPath, ClassLoader parent)</span> &#123;<br>    <span class="hljs-built_in">super</span>(parent);<br>    <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexPath, librarySearchPath, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (reporter != <span class="hljs-literal">null</span>) &#123;<br>        reporter.report(<span class="hljs-built_in">this</span>.pathList.getDexPaths());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(ByteBuffer[] dexFiles, ClassLoader parent)</span> &#123;<br>    <span class="hljs-built_in">super</span>(parent);<br>    <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexFiles);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†pathListçš„<code>findClass()</code>æ–¹æ³•ï¼Œè¿™ä¸ªpathListå®åœ¨BaseDexClassLoaderå®ä¾‹åˆå§‹åŒ–æ—¶åˆ›å»ºçš„ï¼Œæ˜¯ä¸€ä¸ªDexPathListå¯¹è±¡ï¼Œå¯¹åº”çš„<code>findClass()</code>æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">public</span> Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) &#123;<br>    <span class="hljs-keyword">for</span> (Element element : dexElements) &#123;<br>        Class&lt;?&gt; clazz = element.findClass(name, definingContext, suppressed);<br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (dexElementsSuppressedExceptions != <span class="hljs-literal">null</span>) &#123;<br>        suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>éå†Elementæ•°ç»„dexElementsï¼Œå¹¶å¯¹æ¯ä¸ªå…ƒç´ è°ƒç”¨å…¶<code>findClass()</code>æ–¹æ³•ã€‚</p><p>æ•´ä¸ªä»£ç å…¶å®å°±æ˜¯éå†åŠ è½½è¿‡çš„æ‰€æœ‰dexæ–‡ä»¶ï¼Œçœ‹å®ƒä»¬é‡Œé¢æ˜¯å¦å­˜åœ¨éœ€è¦åŠ è½½çš„ç±»ã€‚è‡³äºä¸ºä»€ä¹ˆæ˜¯dexæ–‡ä»¶ï¼Œè¯¦è§æ–‡ç« <a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%80)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸€)</a>ä¸­çš„DexPathListçš„åˆ›å»ºã€‚</p><blockquote><p>çƒ­ä¿®å¤æ ¸å¿ƒé€»è¾‘ï¼šåœ¨DexPathList.findClass()è¿‡ç¨‹ï¼Œä¸€ä¸ªClassloaderå¯ä»¥åŒ…å«å¤šä¸ªdexæ–‡ä»¶ï¼Œæ¯ä¸ªdexæ–‡ä»¶è¢«å°è£…åˆ°ä¸€ä¸ªElementå¯¹è±¡ï¼Œè¿™äº›Elementå¯¹è±¡æ’åˆ—æˆæœ‰åºçš„æ•°ç»„dexElementsã€‚å½“æŸ¥æ‰¾æŸä¸ªç±»æ—¶ï¼Œä¼šéå†æ‰€æœ‰çš„dexæ–‡ä»¶ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥è¿”å›ï¼Œä¸å†ç»§ç»­éå†dexElementsã€‚ä¹Ÿå°±æ˜¯è¯´å½“ä¸¤ä¸ªç±»ä¸åŒçš„dexä¸­å‡ºç°ï¼Œä¼šä¼˜å…ˆå¤„ç†æ’åœ¨å‰é¢çš„dexæ–‡ä»¶ï¼Œè¿™ä¾¿æ˜¯çƒ­ä¿®å¤çš„æ ¸å¿ƒç²¾é«“ï¼Œå°†éœ€è¦ä¿®å¤çš„ç±»æ‰€æ‰“åŒ…çš„dexæ–‡ä»¶æ’å…¥åˆ°dexElementså‰é¢ã€‚â€”â€”gityuan</p></blockquote><p>OKï¼æ¥ä¸‹æ¥å°±æ˜¯æŸ¥çœ‹Elementç±»çš„<code>findClass()</code>æ–¹æ³•ï¼ŒElementç±»æ˜¯DexPathListç±»ä¸­çš„ä¸€ä¸ªé™æ€ç±»ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Element</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DexFile dexFile;<br>    ......<br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; findClass(String name, ClassLoader definingContext,<br>                              List&lt;Throwable&gt; suppressed) &#123;<br>        <span class="hljs-keyword">return</span> dexFile != <span class="hljs-literal">null</span> ? dexFile.loadClassBinaryName(name, definingContext, suppressed)<br>            : <span class="hljs-literal">null</span>;<br>    &#125;<br>    ......<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>findClass()</code>æ–¹æ³•ä¸­è°ƒç”¨äº†DexFileçš„<code>loadClassBinaryName()</code>æ–¹æ³•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><br><span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClassBinaryName</span><span class="hljs-params">(String name, ClassLoader loader, List&lt;Throwable&gt; suppressed)</span> &#123;<br>    <span class="hljs-keyword">return</span> defineClass(name, loader, mCookie, <span class="hljs-built_in">this</span>, suppressed);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»§è€Œè°ƒç”¨<code>defineClass()</code>æ–¹æ³•ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(String name, ClassLoader loader, Object cookie,</span><br><span class="hljs-params">                                 DexFile dexFile, List&lt;Throwable&gt; suppressed)</span> &#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        result = defineClassNative(name, loader, cookie, dexFile);<br>    &#125; <span class="hljs-keyword">catch</span> (NoClassDefFoundError e) &#123;<br>        <span class="hljs-keyword">if</span> (suppressed != <span class="hljs-literal">null</span>) &#123;<br>            suppressed.add(e);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        <span class="hljs-keyword">if</span> (suppressed != <span class="hljs-literal">null</span>) &#123;<br>            suppressed.add(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class <span class="hljs-title function_">defineClassNative</span><span class="hljs-params">(String name, ClassLoader loader, Object cookie,</span><br><span class="hljs-params">                                              DexFile dexFile)</span><br>    <span class="hljs-keyword">throws</span> ClassNotFoundException, NoClassDefFoundError;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨çš„æ˜¯<code>defineClassNative()</code>æ–¹æ³•æ¥æŸ¥æ‰¾æ‰€éœ€è¦åŠ è½½çš„ç±»ï¼Œè€Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸ªnativeæ–¹æ³•ï¼Œè¿™é‡Œå°±ä¸å†åˆ†æäº†ã€‚</p><p>è¿™é‡Œå€Ÿç”¨huanzhiyaziçš„æ–‡ç« ä¸­çš„ä¸€å¥è¯æ¥æ¦‚æ‹¬ä¸€ä¸‹nativeå±‚åšçš„äº‹ï¼š<strong>å…ˆä»å·²åŠ è½½ç±»çš„ class_table ä¸­æŸ¥è¯¢ï¼Œè‹¥æ‰¾åˆ°åˆ™ç›´æ¥è¿”å›ï¼›è‹¥æ‰¾ä¸åˆ°åˆ™è¯´æ˜è¯¥ç±»æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œåˆ™æ‰§è¡ŒåŠ è½½æµç¨‹ï¼Œå…¶ä¸­å¯èƒ½éœ€è¦ç©¿æ’åŠ è½½ä¾èµ–çš„ç±»ï¼ŒåŠ è½½å®Œæˆåå°†å…¶ç¼“å­˜åˆ° class_table ä¸­ã€‚</strong></p><h1 id="äº”ã€é¢„åŠ è½½ç±»çš„æµç¨‹"><a href="#äº”ã€é¢„åŠ è½½ç±»çš„æµç¨‹" class="headerlink" title="äº”ã€é¢„åŠ è½½ç±»çš„æµç¨‹"></a>äº”ã€é¢„åŠ è½½ç±»çš„æµç¨‹</h1><p>åœ¨ZygoteInitçš„<code>main()</code>æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨<code>preload()</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String argv[])</span> &#123;<br>    ......<br>    <br>    <span class="hljs-keyword">try</span> &#123;<br>        ......<br>        <span class="hljs-comment">// In some configurations, we avoid preloading resources and classes eagerly.</span><br>        <span class="hljs-comment">// In such cases, we will preload things prior to our first fork.</span><br>        <span class="hljs-keyword">if</span> (!enableLazyPreload) &#123;<br>            ......<br>            preload(bootTimingsTraceLog);<br>            ......<br>        &#125; <br>        ......<br>    &#125; <br>    ......<br>&#125;<br></code></pre></td></tr></table></figure><p><code>preload()</code>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preload</span><span class="hljs-params">(TimingsTraceLog bootTimingsTraceLog)</span> &#123;<br>    Log.d(TAG, <span class="hljs-string">&quot;begin preload&quot;</span>);<br>    bootTimingsTraceLog.traceBegin(<span class="hljs-string">&quot;BeginIcuCachePinning&quot;</span>);<br>    beginIcuCachePinning();<br>    bootTimingsTraceLog.traceEnd(); <span class="hljs-comment">// BeginIcuCachePinning</span><br>    bootTimingsTraceLog.traceBegin(<span class="hljs-string">&quot;PreloadClasses&quot;</span>);<br>    preloadClasses();<br>    bootTimingsTraceLog.traceEnd(); <span class="hljs-comment">// PreloadClasses</span><br>    bootTimingsTraceLog.traceBegin(<span class="hljs-string">&quot;PreloadResources&quot;</span>);<br>    preloadResources();<br>    bootTimingsTraceLog.traceEnd(); <span class="hljs-comment">// PreloadResources</span><br>    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="hljs-string">&quot;PreloadAppProcessHALs&quot;</span>);<br>    nativePreloadAppProcessHALs();<br>    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br>    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="hljs-string">&quot;PreloadOpenGL&quot;</span>);<br>    preloadOpenGL();<br>    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br>    preloadSharedLibraries();<br>    preloadTextResources();<br>    <span class="hljs-comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span><br>    <span class="hljs-comment">// for memory sharing purposes.</span><br>    WebViewFactory.prepareWebViewInZygote();<br>    endIcuCachePinning();<br>    warmUpJcaProviders();<br>    Log.d(TAG, <span class="hljs-string">&quot;end preload&quot;</span>);<br><br>    sPreloadComplete = <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>preload()</code>æ–¹æ³•ä¸­ï¼Œä¼šé¢„åŠ è½½ç±»ã€èµ„æºã€å…±äº«åº“ç­‰ç­‰ã€‚å…¶ä¸­<code>preloadClasses()</code>æ–¹æ³•ç”¨äºZygoteè¿›ç¨‹åˆå§‹åŒ–æ—¶é¢„åŠ è½½å¸¸ç”¨ç±»ï¼Œè¯¥æ–¹æ³•å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preloadClasses</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">VMRuntime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> VMRuntime.getRuntime();<br>        InputStream is;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//å°†/system/etc/preloaded-classesæ–‡ä»¶å°è£…æˆFileInputStream</span><br>            is = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(PRELOADED_CLASSES);<br>        &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br>            ...<br>        &#125;<br>        ...<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//å°†FileInputStreamå°è£…æˆBufferedReader</span><br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(is), <span class="hljs-number">256</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            String line;<br>            <span class="hljs-comment">//è¯»å–é¢„åŠ è½½ç±»è®°å½•</span><br>            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// Skip comments and blank lines.</span><br>                line = line.trim();<br>                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">&quot;#&quot;</span>) || line.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                Trace.traceBegin(Trace.TRACE_TAG_DALVIK, line);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) &#123;<br>                        Log.v(TAG, <span class="hljs-string">&quot;Preloading &quot;</span> + line + <span class="hljs-string">&quot;...&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-comment">//é€šè¿‡Class.forName()æ¥åŠ è½½å’Œåˆå§‹åŒ–ç»™å®šçš„ç±»</span><br>                    Class.forName(line, <span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);<br>                    count++;<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                    Log.w(TAG, <span class="hljs-string">&quot;Class not found for preloading: &quot;</span> + line);<br>                &#125; <span class="hljs-keyword">catch</span> (UnsatisfiedLinkError e) &#123;<br>                    Log.w(TAG, <span class="hljs-string">&quot;Problem preloading &quot;</span> + line + <span class="hljs-string">&quot;: &quot;</span> + e);<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                    ...<br>                &#125;<br>                Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br>            &#125;<br>            ...<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            ...<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            ...<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å¸¸é‡<code>PRELOADED_CLASSES</code>çš„å€¼ä¸º<code>/system/etc/preloaded-classes</code>ï¼Œåœ¨<code>preloaded-classes</code>æ–‡ä»¶ä¸­å­˜æœ‰é¢„åŠ è½½è®°å½•ï¼Œè¿™ä¸ªæ–‡ä»¶åœ¨Androidæºç ä¸­çš„ç›®å½•ä¸º<code>/frameworks/base/preloaded-classes</code>ï¼Œè¿™é‡Œä¸¾ä¾‹ä¸€äº›æ–‡ä»¶ä¸­çš„é¢„åŠ è½½ç±»ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.ApplicationLoaders</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.ApplicationPackageManager</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.ContentProviderHolder</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.DexLoadReporter</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.Dialog</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.DownloadManager</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.Fragment</span><br>android<span class="hljs-selector-class">.animation</span><span class="hljs-selector-class">.Animator</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.Activity</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.ActivityManager</span><br>android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.ActivityThread</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span><br>java<span class="hljs-selector-class">.lang</span>.Thread<br></code></pre></td></tr></table></figure><p>å¾ˆçœ¼ç†Ÿå§ï¼Œä¸ç„¶æ€ä¹ˆå«å¸¸è§ç±»å‘¢ï¼</p><p>å›åˆ°<code>preloadClasses()</code>æ–¹æ³•ä¸­ï¼Œéå†é¢„åŠ è½½ç±»è®°å½•ï¼Œå¯¹æ¯ä¸ªé¢„åŠ è½½ç±»è°ƒç”¨<code>Class.forName()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/Class.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; forName(String name, <span class="hljs-type">boolean</span> initialize,<br>                               ClassLoader loader)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-keyword">if</span> (loader == <span class="hljs-literal">null</span>) &#123;<br>        loader = BootClassLoader.getInstance();<span class="hljs-comment">//åˆ›å»ºBootClassLoaderå®ä¾‹</span><br>    &#125;<br>    Class&lt;?&gt; result;<br>    <span class="hljs-keyword">try</span> &#123;<br>        result = classForName(name, initialize, loader);<span class="hljs-comment">//è°ƒç”¨nativeæ–¹æ³•</span><br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> e.getCause();<br>        <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> LinkageError) &#123;<br>            <span class="hljs-keyword">throw</span> (LinkageError) cause;<br>        &#125;<br>        <span class="hljs-keyword">throw</span> e;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰å°±é€šè¿‡<code>BootClassLoader.getInstance()</code>åˆ›å»ºBootClassLoaderå®ä¾‹ï¼Œè¯¥æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> BootClassLoader <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>        instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BootClassLoader</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> instance;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºå¥½çš„BootClassLoaderå®ä¾‹ä½œä¸ºå‚æ•°ä¼ å…¥<code>classForName()</code>æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•æ˜¯nativeæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/ojluni/src/main/java/java/lang/Class.java</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; classForName(String className, <span class="hljs-type">boolean</span> shouldInitialize,<br>                                    ClassLoader classLoader) <span class="hljs-keyword">throws</span> ClassNotFoundException;<br></code></pre></td></tr></table></figure><p>Javaå±‚åˆ°æ­¤ä¸ºæ­¢ï¼Œæ¥ä¸‹æ¥æ˜¯Nativeå±‚ï¼Œä¸åœ¨è¿™é‡Œåˆ†æã€‚</p><p>å›é¡¾æ•´ä¸ªé¢„åŠ è½½ç±»çš„æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒBootClassLoaderæ˜¯åœ¨Zygoteè¿›ç¨‹çš„Zygoteå…¥å£æ–¹æ³•ï¼ˆmainï¼‰ä¸­è¢«åˆ›å»ºçš„ï¼Œå¹¶ç”¨æ¥åŠ è½½preloaded-classesæ–‡ä»¶ä¸­å­˜æ”¾çš„ä¸åŠ è½½ç±»ã€‚</p><h1 id="å…­ã€PathClassLoaderçš„åˆ›å»º"><a href="#å…­ã€PathClassLoaderçš„åˆ›å»º" class="headerlink" title="å…­ã€PathClassLoaderçš„åˆ›å»º"></a>å…­ã€PathClassLoaderçš„åˆ›å»º</h1><p>PathClassLoaderçš„åˆ›å»ºä¹Ÿå¾—ä»Zygoteè¿›ç¨‹å¼€å§‹è¯´èµ·ï¼ŒZygoteè¿›ç¨‹å¯åŠ¨SystemServerè¿›ç¨‹æ˜¯ä¼šè°ƒç”¨ZygoteInitçš„<code>startSystemServer()</code>æ–¹æ³•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startSystemServer</span><span class="hljs-params">(String abiList, String socketName, ZygoteServer zygoteServer)</span><br>    <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller, RuntimeException &#123;<br>    ...<br>    <span class="hljs-type">int</span> pid;<br>    <span class="hljs-keyword">try</span> &#123;<br>        parsedArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteConnection</span>.Arguments(args);<br>        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);<br>        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);<br>        <span class="hljs-comment">/* Request to fork the system server process */</span><br>        pid = Zygote.forkSystemServer(<br>            parsedArgs.uid, parsedArgs.gid,<br>            parsedArgs.gids,<br>            parsedArgs.debugFlags,<br>            <span class="hljs-literal">null</span>,<br>            parsedArgs.permittedCapabilities,<br>            parsedArgs.effectiveCapabilities);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);<br>    &#125;<br>    <span class="hljs-comment">/* For child process */</span><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (hasSecondZygote(abiList)) &#123;<br>            waitForSecondaryZygote(socketName);<br>        &#125;<br><br>        zygoteServer.closeServerSocket();<br>        handleSystemServerProcess(parsedArgs);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Zygoteé€šè¿‡<code>forkSystemServer()</code>æ–¹æ³•forkè‡ªèº«æ¥åˆ›å»ºå­è¿›ç¨‹ï¼ˆSystemServerè¿›ç¨‹ï¼‰ï¼Œå¦‚æœè¿”å›çš„pid&#x3D;0ï¼Œè¯´æ˜å½“å‰ä»£ç æ˜¯åœ¨æ–°åˆ›å»ºçš„SystemServerè¿›ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œæ¥ç€å°±ä¼šè°ƒç”¨<code>handleSystemServerProcess()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSystemServerProcess</span><span class="hljs-params">(ZygoteConnection.Arguments parsedArgs)</span> <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>...<br>    <span class="hljs-keyword">if</span> (parsedArgs.invokeWith != <span class="hljs-literal">null</span>) &#123;<br>        ...<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (systemServerClasspath != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//åˆ›å»ºPathClassLoader</span><br>            cl = createPathClassLoader(systemServerClasspath, parsedArgs.targetSdkVersion);<br><span class="hljs-comment">//è®¾ç½®æˆçº¿ç¨‹çš„ä¸Šä¸‹æ–‡çš„ç±»åŠ è½½å™¨</span><br>            Thread.currentThread().setContextClassLoader(cl);<br>        &#125;<br>        ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>createPathClassLoader()</code>æ–¹æ³•åˆ›å»ºPathClassLoaderï¼Œ<u>ç„¶åè·å–å½“å‰çº¿ç¨‹å®ä¾‹ï¼Œè®¾ç½®æ–°åˆ›å»ºçš„PathClassLoaderä¸ºä¸Šä¸‹æ–‡çš„ç±»åŠ è½½å™¨</u>ã€‚<code>createPathClassLoader()</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">static</span> PathClassLoader <span class="hljs-title function_">createPathClassLoader</span><span class="hljs-params">(String classPath, <span class="hljs-type">int</span> targetSdkVersion)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">libraryPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>);<br>    <span class="hljs-keyword">return</span> PathClassLoaderFactory.createClassLoader(classPath,<br>                                                    libraryPath,<br>                                                    libraryPath,<br>                                                    ClassLoader.getSystemClassLoader(),<br>                                                    targetSdkVersion,<br>                                                    <span class="hljs-literal">true</span> <span class="hljs-comment">/* isNamespaceShared */</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>java.library.path </code>æ˜¯ä¸€ä¸ªç³»ç»Ÿå±æ€§ï¼Œå®ƒæŒ‡å®šäº† Java è™šæ‹Ÿæœº (JVM) åœ¨åŠ è½½æœ¬åœ°åº“æ—¶åº”æœç´¢çš„è·¯å¾„ã€‚ä¸Šè¿°ä»£ç é€šè¿‡<code>System.getProperty(&quot;java.library.path&quot;)</code>è·å–æœ¬åœ°åº“ä¿¡æ¯ï¼Œç„¶åè°ƒç”¨PathClassLoaderFactoryç±»çš„<code>createClassLoader()</code>æ–¹æ³•åˆ›å»ºPathClassLoaderã€‚<code>createClassLoader()</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/PathClassLoaderFactory.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PathClassLoader <span class="hljs-title function_">createClassLoader</span><span class="hljs-params">(String dexPath,</span><br><span class="hljs-params">                                                String librarySearchPath,</span><br><span class="hljs-params">                                                String libraryPermittedPath,</span><br><span class="hljs-params">                                                ClassLoader parent,</span><br><span class="hljs-params">                                                <span class="hljs-type">int</span> targetSdkVersion,</span><br><span class="hljs-params">                                                <span class="hljs-type">boolean</span> isNamespaceShared)</span> &#123;<br>    <span class="hljs-comment">//åˆ›å»ºPathClassLoader</span><br>    <span class="hljs-type">PathClassLoader</span> <span class="hljs-variable">pathClassloader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathClassLoader</span>(dexPath, librarySearchPath, parent);<br><br>    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;createClassloaderNamespace&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">errorMessage</span> <span class="hljs-operator">=</span> createClassloaderNamespace(pathClassloader,<br>                                                     targetSdkVersion,<br>                                                     librarySearchPath,<br>                                                     libraryPermittedPath,<br>                                                     isNamespaceShared);<br>    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br><br>    <span class="hljs-keyword">if</span> (errorMessage != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsatisfiedLinkError</span>(<span class="hljs-string">&quot;Unable to create namespace for the classloader &quot;</span> +<br>                                       pathClassloader + <span class="hljs-string">&quot;: &quot;</span> + errorMessage);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> pathClassloader;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ç›´æ¥é€šè¿‡newåˆ›å»ºPathClassLoaderå®ä¾‹ã€‚</p><p>å›é¡¾æ•´ä¸ªé¢„åŠ è½½ç±»çš„æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒPathClassLoaderæ˜¯åœ¨SystemServerè¿›ç¨‹ä¸­é‡‡ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºçš„ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="http://aospxref.com/android-8.0.0_r36/">http://aospxref.com/android-8.0.0_r36/</a></p><p><a href="https://github.com/huanzhiyazi/articles/issues/30">https://github.com/huanzhiyazi/articles/issues/30</a></p><p><a href="http://liuwangshu.cn/application/classloader/2-android-classloader.html">http://liuwangshu.cn/application/classloader/2-android-classloader.html</a></p><p><a href="http://gityuan.com/2017/03/19/android-classloader/">http://gityuan.com/2017/03/19/android-classloader/</a></p><p><a href="https://segmentfault.com/a/1190000004062880">AndroidåŠ¨æ€åŠ è½½åŸºç¡€ ClassLoaderå·¥ä½œæœºåˆ¶ - ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ANDROID - SegmentFault æ€å¦</a></p><p><a href="https://segmentfault.com/a/1190000004062866">AndroidåŠ¨æ€åŠ è½½æŠ€æœ¯ ç®€å•æ˜“æ‡‚çš„ä»‹ç»æ–¹å¼ - ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ANDROID - SegmentFault æ€å¦</a></p><p><a href="https://segmentfault.com/a/1190000004062952">AndroidåŠ¨æ€åŠ è½½å…¥é—¨ ç®€å•åŠ è½½æ¨¡å¼ - ä¸­äºŒç—…ä¹Ÿè¦å¼€å‘ANDROID - SegmentFault æ€å¦</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidæºç è§£æ</tag>
      
      <tag>ClassLoader</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>javaåå°„æŠ€æœ¯å­¦ä¹ </title>
    <link href="/2023/11/23/java%E5%8F%8D%E5%B0%84%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/"/>
    <url>/2023/11/23/java%E5%8F%8D%E5%B0%84%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯åå°„"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯åå°„" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯åå°„"></a>ä¸€ã€ä»€ä¹ˆæ˜¯åå°„</h1><p>åå°„æ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åœ°è·å–ç±»çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»åã€å­—æ®µã€æ–¹æ³•ç­‰ã€‚Javaæä¾›äº†ä¸€ç³»åˆ—åå°„æ–¹æ³•æ¥æ“ä½œï¼ˆå¦‚è·å–ã€åˆ›å»ºã€ä¿®æ”¹ã€è°ƒç”¨ï¼‰Classå¯¹è±¡ã€æ„é€ å‡½æ•°ã€æ–¹æ³•ã€å­—æ®µç­‰ã€‚é€šè¿‡åå°„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ–¹æ³•å’Œè®¿é—®å­—æ®µï¼Œè€Œä¸éœ€è¦æå‰çŸ¥é“ç±»çš„å…·ä½“å®šä¹‰ã€‚åŒæ—¶åå°„ä¹Ÿæ˜¯ä¸€ç§å®ç°åŠ¨æ€åŠ è½½çš„æŠ€æœ¯ä¹‹ä¸€ã€‚</p><h1 id="äºŒã€åŸºäºåå°„è¿›è¡ŒåŠ¨æ€åŠ è½½"><a href="#äºŒã€åŸºäºåå°„è¿›è¡ŒåŠ¨æ€åŠ è½½" class="headerlink" title="äºŒã€åŸºäºåå°„è¿›è¡ŒåŠ¨æ€åŠ è½½"></a>äºŒã€åŸºäºåå°„è¿›è¡ŒåŠ¨æ€åŠ è½½</h1><p>è´´ä¸€æ®µç”¨äºè¾…åŠ©æµ‹è¯•çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.uu;<br><span class="hljs-keyword">import</span> com.test.wtf.Dog;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String publicStr;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">privateStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;abc&quot;</span>;<br><br>    Dog dog;<span class="hljs-comment">//å¦ä¸€ä¸ªç±»ï¼Œå…·ä½“ä»£ç å°±ä¸è´´äº†</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">(String publicStr)</span> &#123;<br>        <span class="hljs-built_in">this</span>.publicStr = publicStr;<br>        <span class="hljs-built_in">this</span>.dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">&quot;ww&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPublicStr</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> publicStr;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPublicStr</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> &#123;<br>        <span class="hljs-keyword">return</span> publicStr;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>åŸºäºä¸Šé¢è¿™æ®µä»£ç ï¼Œ æ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨Javaåå°„ã€‚</p><h2 id="2-1-ç±»åå°„"><a href="#2-1-ç±»åå°„" class="headerlink" title="2.1 ç±»åå°„"></a>2.1 ç±»åå°„</h2><h3 id="2-1-1-è·å–ç±»"><a href="#2-1-1-è·å–ç±»" class="headerlink" title="2.1.1 è·å–ç±»"></a>2.1.1 è·å–ç±»</h3><ul><li><code>Class.forName(ClassName)</code>ï¼šåŠ¨æ€åŠ è½½ç±»ï¼Œ<code>ClassName</code>æŒ‡å®šè¦åŠ è½½çš„ç±»åã€‚</li><li><code>ClassLoaderçš„loaderclass()</code>ï¼šåŠ¨æ€åŠ è½½ç±»ï¼Œ<code>ClassName</code>æŒ‡å®šè¦åŠ è½½çš„ç±»åã€‚</li><li><code>ç±»å.class</code>ï¼šéåŠ¨æ€åŠ è½½ã€‚</li><li><code>ç±»å¯¹è±¡.getClass()</code>ï¼šéåŠ¨æ€åŠ è½½ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.Class.forName()</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.example.uu.Test&quot;</span>);<br><span class="hljs-comment">//2.ClassLoader</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader().loadClass(<span class="hljs-string">&quot;com.example.uu.Test&quot;</span>);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¾“å‡ºï¼š</span><br><span class="hljs-comment">class com.example.uu.Test</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">//3.ç±»å.class</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">sClass</span> <span class="hljs-operator">=</span> String.class;<br>System.out.println(sClass);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¾“å‡ºï¼š</span><br><span class="hljs-comment">class java.lang.String</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">//4.ç±»å¯¹è±¡.getClass()</span><br><span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span>;<br><span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> a.getClass();<br>System.out.println(aClass);<br></code></pre></td></tr></table></figure><h3 id="2-1-2-é€šè¿‡ç±»è·å–ç±»å®ä¾‹"><a href="#2-1-2-é€šè¿‡ç±»è·å–ç±»å®ä¾‹" class="headerlink" title="2.1.2 é€šè¿‡ç±»è·å–ç±»å®ä¾‹"></a>2.1.2 é€šè¿‡ç±»è·å–ç±»å®ä¾‹</h3><ul><li><code>class.newInstrance()</code>ï¼šæ‰§è¡Œæ— å‚æ„é€ è·å–ç±»å®ä¾‹ï¼Œè¯¥æ–¹æ³•è¦æ±‚<code>class</code>ç±»æœ‰æ— å‚æ„é€ æ–¹æ³•ã€‚</li></ul><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.è·å–ç±»</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.example.uu.Test&quot;</span>);<br><span class="hljs-comment">//æ‰§è¡Œç±»çš„æ— å‚æ„é€ æ–¹æ³•æ¥è·å–ç±»å®ä¾‹ï¼ˆå¿…é¡»è¦æ±‚è¯¥ç±»å«æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼‰</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> cl.newInstance();<br></code></pre></td></tr></table></figure><h2 id="2-2-æ„é€ æ–¹æ³•åå°„"><a href="#2-2-æ„é€ æ–¹æ³•åå°„" class="headerlink" title="2.2 æ„é€ æ–¹æ³•åå°„"></a>2.2 æ„é€ æ–¹æ³•åå°„</h2><h3 id="2-2-1-è·å–æ„é€ æ–¹æ³•"><a href="#2-2-1-è·å–æ„é€ æ–¹æ³•" class="headerlink" title="2.2.1 è·å–æ„é€ æ–¹æ³•"></a>2.2.1 è·å–æ„é€ æ–¹æ³•</h3><ul><li><code>class.getConstructor(...ParameterTypes)</code>ï¼šè·å–<code>class</code>ç±»ä¸­çš„publicæƒé™çš„æ„é€ æ–¹æ³•ï¼Œ<code>ParameterTypes</code>æŒ‡å®šæ‰€è·å–çš„æ„é€ æ–¹æ³•ä¸­çš„å‚æ•°çš„ç±»å‹ï¼Œæ²¡æœ‰åˆ™è¡¨ç¤ºæ— å‚ã€‚</li><li><code>class.getConstructors()</code>ï¼šè·å–<code>class</code>ç±»ä¸­çš„æ‰€æœ‰publicæƒé™çš„æ„é€ æ–¹æ³•ã€‚</li><li><code>class.getDeclaredConstructor(...ParameterTypes)</code> ï¼šè·å–<code>class</code>ç±»ä¸­çš„ä»»æ„æ„é€ æ–¹æ³•ã€‚</li><li><code>class.getDeclaredConstructors()</code>ï¼šè·å–<code>class</code>ç±»ä¸­çš„æ‰€æœ‰æ„é€ æ–¹æ³•ã€‚</li></ul><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1. è·å–æ— å‚æ„é€ æ–¹æ³•</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cl.getConstructor();<br>System.out.println(constructor);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¾“å‡ºï¼š</span><br><span class="hljs-comment">public com.example.uu.Test()</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">//2. è·å–å¸¦ä¸€ä¸ªå‚æ•°ä¸”ä¸ºstringç±»å‹çš„æ„é€ æ–¹æ³•</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cl.getConstructor(String.class);<br>System.out.println(constructor);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¾“å‡ºï¼š</span><br><span class="hljs-comment">public com.example.uu.Test(java.lang.String)</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">//3. è·å–è¯¥ç±»çš„æ‰€æœ‰æ„é€ æ–¹æ³•</span><br>Constructor[] constructors = cl.getConstructors();<br><span class="hljs-keyword">for</span> (Constructor con:constructors) &#123;<br>    System.out.println(con);<br>    System.out.println(con.getName() + <span class="hljs-string">&quot;||&quot;</span> + con.getModifiers() + <span class="hljs-string">&quot;||&quot;</span><br>                       + Arrays.toString(con.getParameters()) + <span class="hljs-string">&quot;||&quot;</span><br>                       + Arrays.toString(con.getParameterTypes()));<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¾“å‡º</span><br><span class="hljs-comment">public com.example.uu.Test(java.lang.String)</span><br><span class="hljs-comment">com.example.uu.Test||1||[java.lang.String arg0]||[class java.lang.String]</span><br><span class="hljs-comment">public com.example.uu.Test()</span><br><span class="hljs-comment">com.example.uu.Test||1||[]||[]</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h3 id="2-2-2-é€šè¿‡æ„é€ æ–¹æ³•è·å–ç±»å®ä¾‹"><a href="#2-2-2-é€šè¿‡æ„é€ æ–¹æ³•è·å–ç±»å®ä¾‹" class="headerlink" title="2.2.2 é€šè¿‡æ„é€ æ–¹æ³•è·å–ç±»å®ä¾‹"></a>2.2.2 é€šè¿‡æ„é€ æ–¹æ³•è·å–ç±»å®ä¾‹</h3><ul><li><code>constructor.newInstance(...args)</code>ï¼šé€šè¿‡<code>constructor</code>æ„é€ æ–¹æ³•æ„é€ ç±»å®ä¾‹å¯¹è±¡ï¼Œæ ¹æ®è·å–åˆ°çš„<code>constructor</code>æ„é€ æ–¹æ³•æ¥å†³å®šæ˜¯å¦éœ€è¦ä¼ å…¥å‚æ•°<code>args</code>ã€‚</li><li><code>constructor.setAccessible(bool)</code>ï¼šè®¾ç½®<code>constructor</code>æ„é€ å‡½æ•°çš„è®¿é—®æƒé™ï¼Œè‹¥<code>bool</code>ä¸ºtrueåˆ™è¡¨ç¤ºå–æ¶ˆæ„é€ å‡½æ•°çš„è®¿é—®æƒé™æ§åˆ¶ï¼Œè¿™æ„å‘³ç€privateå£°æ˜çš„æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥è¿›è¡Œè®¿é—®ã€‚</li></ul><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//1.æ— å‚æ„é€ </span><br><span class="hljs-type">Class</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.example.uu.Test&quot;</span>);<span class="hljs-comment">//è·å–ç±»</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cl.getConstructor();<span class="hljs-comment">//é€šè¿‡ç±»è·å–æ— å‚æ„é€ æ–¹æ³•</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance();<span class="hljs-comment">//æ‰§è¡Œæ„é€ æ–¹æ³•è·å¾—ç±»å®ä¾‹</span><br><br><span class="hljs-comment">//2.æœ‰å‚æ„é€ </span><br>Class cl= Class.forName(<span class="hljs-string">&quot;com.example.uu.Test&quot;</span>);<span class="hljs-comment">//è·å–ç±»</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cl.getConstructor(String.class);<span class="hljs-comment">///è·å–å¸¦ä¸€ä¸ªå‚æ•°ä¸”å‚æ•°ç±»å‹ä¸ºStringç±»å‹çš„æ„é€ æ–¹æ³•</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(<span class="hljs-string">&quot;aaaaaaaaaaaaaaaa&quot;</span>);<span class="hljs-comment">//æ‰§è¡Œæ„é€ æ–¹æ³•è·å¾—ç±»å®ä¾‹</span><br></code></pre></td></tr></table></figure><h2 id="2-3-å­—æ®µåå°„"><a href="#2-3-å­—æ®µåå°„" class="headerlink" title="2.3 å­—æ®µåå°„"></a>2.3 å­—æ®µåå°„</h2><h3 id="2-3-1-è·å–å­—æ®µ"><a href="#2-3-1-è·å–å­—æ®µ" class="headerlink" title="2.3.1 è·å–å­—æ®µ"></a>2.3.1 è·å–å­—æ®µ</h3><ul><li><p><code>class.getField(FieldName)</code> ï¼šè·å–<code>class</code>ç±»ä¸­çš„å¸¦publicå£°æ˜çš„<code>FieldName</code>å˜é‡ã€‚</p></li><li><p><code>class.getFields()</code>ï¼šè·å–<code>class</code>ç±»ä¸­çš„å¸¦publicå£°æ˜å˜é‡ã€‚</p></li><li><p><code>class.getDeclaredField(FieldName)</code>ï¼šè·å–<code>class</code>ç±»ä¸­çš„<code>FieldName</code>å˜é‡ã€‚</p></li><li><p><code>class.getDeclaredFields()</code>ï¼šè·å–<code>class</code>ç±»ä¸­çš„æ‰€æœ‰å˜é‡ã€‚</p></li></ul><p>ç¤ºä¾‹ä»£ç ï¼š</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1. è·å–è¯¥ç±»çš„publicStrå­—æ®µ</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> cl.getField(<span class="hljs-string">&quot;publicStr&quot;</span>);<span class="hljs-comment">//åªèƒ½è·å–publicå£°æ˜çš„å˜é‡ï¼Œè·å–privateStrå¤±è´¥</span><br>System.out.println(field);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¾“å‡ºï¼š</span><br><span class="hljs-comment">public java.lang.String com.example.uu.Test.publicStr</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">//2.è·å–è¯¥ç±»ä¸­æ‰€æœ‰å­—æ®µ</span><br>Field[] declaredFields = cl.getDeclaredFields();<br><span class="hljs-keyword">for</span>(Field dec : declaredFields)&#123;<br>    System.out.println(dec);<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">public java.lang.String com.example.uu.Test.publicStr</span><br><span class="hljs-comment">private java.lang.String com.example.uu.Test.privateStr</span><br><span class="hljs-comment">com.test.wtf.Dog com.example.uu.Test.dog</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h3 id="2-3-2-æ“ä½œå­—æ®µ"><a href="#2-3-2-æ“ä½œå­—æ®µ" class="headerlink" title="2.3.2 æ“ä½œå­—æ®µ"></a>2.3.2 æ“ä½œå­—æ®µ</h3><ul><li><code>field.getXxx(obj)</code>ï¼šè·å–<code>obj</code>å¯¹è±¡çš„<code>field</code>å­—æ®µçš„å±æ€§å€¼ã€‚<code>Xxx</code>ä»£æŒ‡8ä¸ªåŸºæœ¬æ•°æ®ç±»å‹ï¼Œå¦‚æœè¯¥å±æ€§ç±»å‹æ˜¯å¼•ç”¨ç±»å‹åˆ™ç›´æ¥ä½¿ç”¨<code>Field.get(obj)</code>ã€‚</li><li><code>field.setXxx(obj, value)</code>ï¼šå°†<code>obj</code>å¯¹è±¡çš„Fieldå­—æ®µèµ‹å€¼ä¸º<code>value</code>ã€‚<code>Xxx</code>ä»£æŒ‡8ä¸ªåŸºæœ¬æ•°æ®ç±»å‹ï¼Œå¦‚æœè¯¥å­—æ®µç±»å‹æ˜¯å¼•ç”¨ç±»å‹åˆ™ç›´æ¥ä½¿ç”¨<code>Field.set(obj, value)</code>ã€‚</li><li><code>field.setAccessible(bool)</code>ï¼šè®¾ç½®<code>field</code>å­—æ®µçš„è®¿é—®æƒé™ï¼Œè‹¥<code>bool</code>ä¸ºtrueåˆ™è¡¨ç¤ºå–æ¶ˆå­—æ®µçš„è®¿é—®æƒé™æ§åˆ¶ï¼Œè¿™æ„å‘³ç€privateå£°æ˜çš„å­—æ®µä¹Ÿå¯ä»¥è¿›è¡Œè®¿é—®ã€‚</li></ul><p>   ä»£ç ç¤ºä¾‹ï¼š</p>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.è·å–ç±»</span><br>Class cl= Class.forName(<span class="hljs-string">&quot;com.example.uu.Test&quot;</span>);<br><span class="hljs-comment">//2.è·å–æ„é€ å‡½æ•°</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cl.getConstructor(String.class);<br><span class="hljs-comment">//3.åˆ›å»ºç±»å¯¹è±¡</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">newtest</span> <span class="hljs-operator">=</span> constructor.newInstance(<span class="hljs-string">&quot;ousasf&quot;</span>);<br><span class="hljs-comment">//4.è·å–privateStrå­—æ®µ</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">privateStr</span> <span class="hljs-operator">=</span> cl.getDeclaredField(<span class="hljs-string">&quot;privateStr&quot;</span>);<br><span class="hljs-comment">//5.å› ä¸ºè¯¥å­—æ®µæ˜¯Privateæƒé™ï¼Œæ‰€ä»¥éœ€è¦å–æ¶ˆå±æ€§çš„è®¿é—®æƒé™æ§åˆ¶</span><br>privateStr.setAccessible(<span class="hljs-literal">true</span>);<br>System.out.println(privateStr.get(newtest));<br><span class="hljs-comment">//6.ä¿®æ”¹privateStrå­—æ®µçš„å€¼</span><br>privateStr.set(newtest,<span class="hljs-string">&quot;ahlsdfjpasp&quot;</span>);<br>System.out.println(privateStr.get(newtest));<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¾“å‡ºï¼š</span><br><span class="hljs-comment">abc</span><br><span class="hljs-comment">ahlsdfjpasp</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h2 id="2-4-æ–¹æ³•åå°„"><a href="#2-4-æ–¹æ³•åå°„" class="headerlink" title="2.4 æ–¹æ³•åå°„"></a>2.4 æ–¹æ³•åå°„</h2><h3 id="2-4-1-è·å–æ–¹æ³•"><a href="#2-4-1-è·å–æ–¹æ³•" class="headerlink" title="2.4.1 è·å–æ–¹æ³•"></a>2.4.1 è·å–æ–¹æ³•</h3><ul><li><code>class.getMethod(MethodName,...ParameterTypes)</code>ï¼šè·å–<code>class</code>ç±»ä¸­çš„publicæƒé™çš„æ–¹æ³•ï¼Œ<code>MethodName</code>æŒ‡å®šæ‰€è¦è·å–çš„æ–¹æ³•çš„æ–¹æ³•åï¼Œ<code>ParameterTypes</code>æŒ‡å®šæ‰€è·å–çš„æ–¹æ³•ä¸­çš„å‚æ•°çš„ç±»å‹ï¼Œæ²¡æœ‰åˆ™è¡¨ç¤ºæ— å‚ã€‚</li><li><code>class.getMethods()</code>ï¼šè·å–<code>class</code>ç±»ä¸­æ‰€æœ‰publicæƒé™çš„æ–¹æ³•ã€‚</li><li><code>class.getDeclaredMethod(MethodName,...ParameterTypes)</code>ï¼šè·å–<code>class</code>ç±»ä¸­ä»»æ„æ–¹æ³•ã€‚</li><li><code>class.getDeclaredMethods()</code>ï¼šè·å–<code>class</code>ç±»çš„æ‰€æœ‰æ–¹æ³•ã€‚</li></ul><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·å–å¸¦ä¸€ä¸ªå‚æ•°çš„ä¸”ä¸ºintç±»å‹çš„getPublicStræ–¹æ³•</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cl.getMethod(<span class="hljs-string">&quot;getPublicStr&quot;</span>,<span class="hljs-type">int</span>.class);<br>System.out.println(method);<br></code></pre></td></tr></table></figure><h3 id="2-4-2-æ‰§è¡Œæ–¹æ³•"><a href="#2-4-2-æ‰§è¡Œæ–¹æ³•" class="headerlink" title="2.4.2 æ‰§è¡Œæ–¹æ³•"></a>2.4.2 æ‰§è¡Œæ–¹æ³•</h3><ul><li><code>method.invoke(obj,...args)</code>ï¼šè°ƒç”¨<code>obj</code>å¯¹è±¡çš„<code>method</code>æ–¹æ³•ï¼Œ<code>args</code>æŒ‡å®šä¼ å…¥çš„å‚æ•°ï¼Œæ²¡æœ‰åˆ™è¡¨ç¤ºæ— å‚ã€‚</li><li><code>method.setAccessible(bool)</code>ï¼šè®¾ç½®<code>method</code>æ–¹æ³•çš„è®¿é—®æƒé™ï¼Œè‹¥<code>bool</code>ä¸ºtrueåˆ™è¡¨ç¤ºå–æ¶ˆæ–¹æ³•çš„è®¿é—®æƒé™æ§åˆ¶ï¼Œè¿™æ„å‘³ç€privateå£°æ˜çš„æ–¹æ³•ä¹Ÿå¯ä»¥è¢«è°ƒç”¨ã€‚</li></ul><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.è·å–ç±»</span><br>Class cl= Class.forName(<span class="hljs-string">&quot;com.example.uu.Test&quot;</span>);<br><span class="hljs-comment">//2.è·å–å¸¦ä¸€ä¸ªå‚æ•°ä¸”ä¸ºStringç±»å‹çš„æ„é€ æ–¹æ³•</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cl.getConstructor(String.class);<br><span class="hljs-comment">//3.é€šè¿‡æ„é€ æ–¹æ³•ï¼Œæ„é€ ç±»å¯¹è±¡</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">newtest</span> <span class="hljs-operator">=</span> constructor.newInstance(<span class="hljs-string">&quot;abcdedfg&quot;</span>);<br><span class="hljs-comment">//4.è·å–getPublicStr()æ–¹æ³•</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cl.getDeclaredMethod(<span class="hljs-string">&quot;getPublicStr&quot;</span>);<br>System.out.println(method);<br><span class="hljs-comment">//5.å–æ¶ˆè®¿é—®æ§åˆ¶</span><br><span class="hljs-comment">//method.setAccessible(true);</span><br><span class="hljs-comment">//6.è°ƒç”¨è¯¥æ–¹æ³•</span><br>System.out.println(method.invoke(newtest));<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è¾“å‡ºï¼š</span><br><span class="hljs-comment">public java.lang.String com.example.uu.Test.getPublicStr()</span><br><span class="hljs-comment">abcdedfg</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/405325823">Javaåå°„æœºåˆ¶-ååˆ†é’Ÿææ‡‚ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaåå°„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸‰)</title>
    <link href="/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%89)/"/>
    <url>/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%89)/</url>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šæ–‡<a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%BA%8C)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(äºŒ) (gal2xy.github.io)</a>ã€‚</p><h1 id="ä¸€ã€DexFile-Open"><a href="#ä¸€ã€DexFile-Open" class="headerlink" title="ä¸€ã€DexFile::Open()"></a>ä¸€ã€DexFile::Open()</h1><p>æ ¹æ®ä¸Šä¸€ç¯‡æ–‡ç« çš„å­¦ä¹ å¯çŸ¥ï¼Œåœ¨<code>OpenDexFilesFromOat()</code>æ–¹æ³•ä¸­ï¼Œå¦‚æœèƒ½å¤Ÿä»oatæ–‡ä»¶ä¸­åŠ è½½dexæ–‡ä»¶ï¼Œåˆ™æœ€ç»ˆåœ¨<code>OatFile::OatDexFile::OpenDexFile()</code>æ–¹æ³•ä¸­è°ƒç”¨å¸¦8ä¸ªå‚æ•°çš„<code>DexFile::Open()</code>æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">DexFile::<span class="hljs-built_in">Open</span>(dex_file_pointer_,<br>              <span class="hljs-built_in">FileSize</span>(),<br>              dex_file_location_,<br>              dex_file_location_checksum_,<br>              <span class="hljs-keyword">this</span>,<br>              kVerify,<br>              kVerifyChecksum,<br>              error_msg);<br></code></pre></td></tr></table></figure><p>å¦åˆ™ç›´æ¥è°ƒç”¨å¸¦5ä¸ªå‚æ•°çš„<code>DexFile::Open()</code>æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">DexFile::<span class="hljs-built_in">Open</span>(dex_location, dex_location, kVerifyChecksum, <span class="hljs-comment">/*out*/</span> &amp;error_msg, &amp;dex_files)<br></code></pre></td></tr></table></figure><h2 id="1-1-å¸¦8ä¸ªå‚æ•°çš„DexFile-Open"><a href="#1-1-å¸¦8ä¸ªå‚æ•°çš„DexFile-Open" class="headerlink" title="1.1 å¸¦8ä¸ªå‚æ•°çš„DexFile::Open()"></a>1.1 å¸¦8ä¸ªå‚æ•°çš„DexFile::Open()</h2><p>å¸¦8ä¸ªå‚æ•°çš„<code>DexFile::Open()</code>æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œç›´æ¥è°ƒç”¨<code>OpenCommon()</code>æ–¹æ³•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file.cc</span><br><span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">DexFile::Open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* base,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">size_t</span> size,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">uint32_t</span> location_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">const</span> OatDexFile* oat_dex_file,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">bool</span> verify,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             std::string* error_msg)</span> </span>&#123;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(std::string(<span class="hljs-string">&quot;Open dex file from RAM &quot;</span>) + location)</span></span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">OpenCommon</span>(base,<br>                      size,<br>                      location,<br>                      location_checksum,<br>                      oat_dex_file,<br>                      verify,<br>                      verify_checksum,<br>                      error_msg);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹<code>DexFile::Open()</code>çš„å‚æ•°è¿›è¡Œè¯´æ˜ï¼š</p><ul><li>baseï¼šæŒ‡å‘dexæ–‡ä»¶çš„å†…å­˜åœ°å€ã€‚</li><li>sizeï¼šdexæ–‡ä»¶çš„å¤§å°ã€‚</li><li>locationï¼šdexæ–‡ä»¶çš„ä½ç½®ã€‚</li><li>location_checksumï¼šdexæ–‡ä»¶ä½ç½®çš„æ ¡éªŒå’Œã€‚</li><li>oat_dex_fileï¼šæŒ‡å‘OatDexFileå¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li>verifyï¼šè¡¨ç¤ºæ˜¯å¦è¦å¯¹dexæ–‡ä»¶è¿›è¡ŒéªŒè¯ã€‚</li><li>verify_checksumï¼šè¡¨ç¤ºæ˜¯å¦è¦éªŒè¯dexæ–‡ä»¶çš„æ ¡éªŒå’Œã€‚</li><li>error_msgï¼šæŒ‡å‘é”™è¯¯ä¿¡æ¯å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚</li></ul><h2 id="1-2-å¸¦5ä¸ªå‚æ•°çš„DexFile-Open"><a href="#1-2-å¸¦5ä¸ªå‚æ•°çš„DexFile-Open" class="headerlink" title="1.2 å¸¦5ä¸ªå‚æ•°çš„DexFile::Open()"></a>1.2 å¸¦5ä¸ªå‚æ•°çš„DexFile::Open()</h2><p>å¸¦5ä¸ªå‚æ•°çš„<code>DexFile::Open()</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file.cc</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DexFile::Open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename,</span></span><br><span class="hljs-params"><span class="hljs-function">                   <span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                   <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                   std::string* error_msg,</span></span><br><span class="hljs-params"><span class="hljs-function">                   std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt;* dex_files)</span> </span>&#123;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(std::string(<span class="hljs-string">&quot;Open dex file &quot;</span>) + std::string(location))</span></span>;<br>    <span class="hljs-built_in">DCHECK</span>(dex_files != <span class="hljs-literal">nullptr</span>) &lt;&lt; <span class="hljs-string">&quot;DexFile::Open: out-param is nullptr&quot;</span>;<br>    <span class="hljs-type">uint32_t</span> magic;<br>    <span class="hljs-comment">//æ‰“å¼€æ–‡ä»¶è¯»å–magic[8]ï¼ŒOpenAndReadMagicå¯ä½œä¸ºä¸€ä¸ªå¸¸ç”¨è„±å£³ç‚¹</span><br>    File fd = <span class="hljs-built_in">OpenAndReadMagic</span>(filename, &amp;magic, error_msg);<br>    <span class="hljs-keyword">if</span> (fd.<span class="hljs-built_in">Fd</span>() == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">DCHECK</span>(!error_msg-&gt;<span class="hljs-built_in">empty</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">//å¦‚æœæ˜¯zipæ–‡ä»¶å¤´</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsZipMagic</span>(magic)) &#123;<br>        <span class="hljs-comment">//é€šè¿‡DexFile::OpenZip()æ‰“å¼€zipæ–‡ä»¶</span><br>        <span class="hljs-keyword">return</span> DexFile::<span class="hljs-built_in">OpenZip</span>(fd.<span class="hljs-built_in">Release</span>(), location, verify_checksum, error_msg, dex_files);<br>    &#125;<br>    <span class="hljs-comment">//å¦‚æœæ˜¯dexæ–‡ä»¶å¤´</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsDexMagic</span>(magic)) &#123;<br><span class="hljs-comment">//é€šè¿‡DexFile::OpenFile()æ‰“å¼€dexæ–‡ä»¶</span><br>        <span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">dex_file</span><span class="hljs-params">(DexFile::OpenFile(fd.Release(),</span></span><br><span class="hljs-params"><span class="hljs-function">                                                                  location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                                  <span class="hljs-comment">/* verify */</span> <span class="hljs-literal">true</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                                  verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                                  error_msg))</span></span>;<br>        <span class="hljs-keyword">if</span> (dex_file.<span class="hljs-built_in">get</span>() != <span class="hljs-literal">nullptr</span>) &#123;<br>            dex_files-&gt;<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(dex_file));<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>    *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Expected valid zip or dex file: &#x27;%s&#x27;&quot;</span>, filename);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹<code>DexFile::Open()</code>çš„å‚æ•°è¿›è¡Œè¯´æ˜ï¼š</p><ul><li>filenameï¼šdexæ–‡ä»¶åã€‚</li><li>locationï¼šdexæ–‡ä»¶çš„ä½ç½®ã€‚</li><li>verify_checksumï¼šè¡¨ç¤ºæ˜¯å¦è¦éªŒè¯dexæ–‡ä»¶çš„æ ¡éªŒå’Œã€‚</li><li>error_msgï¼šæŒ‡å‘é”™è¯¯ä¿¡æ¯å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚</li><li>dex_filesï¼šå­˜å‚¨dex fileçš„DexFileæ•°ç»„ã€‚</li></ul><p>æ•´ä¸ªä»£ç é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆé€šè¿‡<code>OpenAndReadMagic()</code>è·å–æ–‡ä»¶å¤´ï¼Œç„¶åæ ¹æ®æ–‡ä»¶å¤´åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œæ‰§è¡Œä¸åŒä»£ç ï¼šå¦‚æœæ˜¯zipæ–‡ä»¶ï¼Œåˆ™è°ƒç”¨<code>DexFile::OpenZip()</code>æ‰“å¼€zipæ–‡ä»¶ï¼Œå¦‚æœæ˜¯dexæ–‡ä»¶ï¼Œåˆ™è°ƒç”¨<code>DexFile::OpenFile()</code>æ‰“å¼€dexæ–‡ä»¶ã€‚</p><p>å…¶ä¸­<code>OpenAndReadMagic()</code>å¯ä»¥ä½œä¸ºä¸€ä¸ªè„±å£³ç‚¹ï¼Œä½†å¹¶ä¸æ˜¯å¾ˆé€‚åˆï¼Œå› ä¸ºæ­¤æ—¶dexæ–‡ä»¶è¿˜æ²¡æœ‰åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h3 id="1-2-1-DexFile-OpenZip"><a href="#1-2-1-DexFile-OpenZip" class="headerlink" title="1.2.1 DexFile::OpenZip()"></a>1.2.1 DexFile::OpenZip()</h3><p>é¦–å…ˆæ¥çœ‹<code>DexFile::OpenZip()</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DexFile::OpenZip</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,</span></span><br><span class="hljs-params"><span class="hljs-function">                      <span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                      <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                      std::string* error_msg,</span></span><br><span class="hljs-params"><span class="hljs-function">                      std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt;* dex_files)</span> </span>&#123;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(<span class="hljs-string">&quot;Dex file open Zip &quot;</span> + std::string(location))</span></span>;<br>    <span class="hljs-built_in">DCHECK</span>(dex_files != <span class="hljs-literal">nullptr</span>) &lt;&lt; <span class="hljs-string">&quot;DexFile::OpenZip: out-param is nullptr&quot;</span>;<br>    <span class="hljs-comment">//é€šè¿‡ZipArchive::OpenFromFd()æ‰“å¼€zipæ–‡ä»¶</span><br>    <span class="hljs-function">std::unique_ptr&lt;ZipArchive&gt; <span class="hljs-title">zip_archive</span><span class="hljs-params">(ZipArchive::OpenFromFd(fd, location.c_str(), error_msg))</span></span>;<br>    <span class="hljs-keyword">if</span> (zip_archive.<span class="hljs-built_in">get</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">DCHECK</span>(!error_msg-&gt;<span class="hljs-built_in">empty</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">//é€šè¿‡DexFile::OpenAllDexFilesFromZip()æ‰“å¼€zipä¸­çš„æ‰€æœ‰dexæ–‡ä»¶</span><br>    <span class="hljs-keyword">return</span> DexFile::<span class="hljs-built_in">OpenAllDexFilesFromZip</span>(*zip_archive,<br>                                           location,<br>                                           verify_checksum,<br>                                           error_msg,<br>                                           dex_files);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è°ƒç”¨<code>DexFile::OpenAllDexFilesFromZip()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file.cc</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DexFile::OpenAllDexFilesFromZip</span><span class="hljs-params">(<span class="hljs-type">const</span> ZipArchive&amp; zip_archive,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     std::string* error_msg,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt;* dex_files)</span> </span>&#123;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(<span class="hljs-string">&quot;Dex file open from Zip &quot;</span> + std::string(location))</span></span>;<br>    <span class="hljs-built_in">DCHECK</span>(dex_files != <span class="hljs-literal">nullptr</span>) &lt;&lt; <span class="hljs-string">&quot;DexFile::OpenFromZip: out-param is nullptr&quot;</span>;<br>    ZipOpenErrorCode error_code;<br>    <span class="hljs-comment">//è°ƒç”¨OpenOneDexFileFromZip()ä»zipæ–‡ä»¶ä¸­æ‰“å¼€dexæ–‡ä»¶</span><br>    <span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">dex_file</span><span class="hljs-params">(OpenOneDexFileFromZip(zip_archive, kClassesDex, location, verify_checksum, error_msg, &amp;error_code))</span></span>;<br>    <span class="hljs-keyword">if</span> (dex_file.<span class="hljs-built_in">get</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        dex_files-&gt;<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(dex_file));<br><span class="hljs-comment">//zipæ–‡ä»¶ä¸­å­˜åœ¨å¤šä¸ªdexæ–‡ä»¶</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">1</span>; ; ++i) &#123;<br>            std::string name = <span class="hljs-built_in">GetMultiDexClassesDexName</span>(i);<br>            std::string fake_location = <span class="hljs-built_in">GetMultiDexLocation</span>(i, location.<span class="hljs-built_in">c_str</span>());<br>            <span class="hljs-comment">//è°ƒç”¨OpenOneDexFileFromZip()</span><br>            <span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">next_dex_file</span><span class="hljs-params">(OpenOneDexFileFromZip(zip_archive, name.c_str(), fake_location, verify_checksum, error_msg, &amp;error_code))</span></span>;<br>            <span class="hljs-keyword">if</span> (next_dex_file.<span class="hljs-built_in">get</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>                <span class="hljs-keyword">if</span> (error_code != ZipOpenErrorCode::kEntryNotFound) &#123;<br>                    <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">&quot;Zip open failed: &quot;</span> &lt;&lt; *error_msg;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dex_files-&gt;<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(next_dex_file));<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (i == kWarnOnManyDexFilesThreshold) &#123;<br>                <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; location &lt;&lt; <span class="hljs-string">&quot; has in excess of &quot;</span> &lt;&lt; kWarnOnManyDexFilesThreshold<br>                    &lt;&lt; <span class="hljs-string">&quot; dex files. Please consider coalescing and shrinking the number to &quot;</span><br>                    <span class="hljs-string">&quot; avoid runtime overhead.&quot;</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (i == std::numeric_limits&lt;<span class="hljs-type">size_t</span>&gt;::<span class="hljs-built_in">max</span>()) &#123;<br>                <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Overflow in number of dex files!&quot;</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è°ƒç”¨<code>OpenOneDexFileFromZip()</code>æ–¹æ³•å•ç‹¬æ‰“å¼€zipæ–‡ä»¶ä¸­çš„dexæ–‡ä»¶ï¼Œè¯¥æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file.cc</span><br><span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">DexFile::OpenOneDexFileFromZip</span><span class="hljs-params">(<span class="hljs-type">const</span> ZipArchive&amp; zip_archive,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                              <span class="hljs-type">const</span> <span class="hljs-type">char</span>* entry_name,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                              <span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                              <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                              std::string* error_msg,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                              ZipOpenErrorCode* error_code)</span> </span>&#123;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(<span class="hljs-string">&quot;Dex file open from Zip Archive &quot;</span> + std::string(location))</span></span>;<br>    <span class="hljs-built_in">CHECK</span>(!location.<span class="hljs-built_in">empty</span>());<br>    <br>    <span class="hljs-comment">//è°ƒç”¨zip_archive.Find()æ‰¾åˆ°ç»™å®šçš„dexæ–‡ä»¶</span><br>    <span class="hljs-function">std::unique_ptr&lt;ZipEntry&gt; <span class="hljs-title">zip_entry</span><span class="hljs-params">(zip_archive.Find(entry_name, error_msg))</span></span>;<br>    <span class="hljs-keyword">if</span> (zip_entry == <span class="hljs-literal">nullptr</span>) &#123;<br>        *error_code = ZipOpenErrorCode::kEntryNotFound;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (zip_entry-&gt;<span class="hljs-built_in">GetUncompressedLength</span>() == <span class="hljs-number">0</span>) &#123;<br>        *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Dex file &#x27;%s&#x27; has zero length&quot;</span>, location.<span class="hljs-built_in">c_str</span>());<br>        *error_code = ZipOpenErrorCode::kDexFileError;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    std::unique_ptr&lt;MemMap&gt; map;<br>    <span class="hljs-keyword">if</span> (zip_entry-&gt;<span class="hljs-built_in">IsUncompressed</span>()) &#123;<br>        <span class="hljs-comment">//æ˜¯å¦æ–‡ä»¶å¯¹é½</span><br>        <span class="hljs-keyword">if</span> (!zip_entry-&gt;<span class="hljs-built_in">IsAlignedTo</span>(<span class="hljs-built_in">alignof</span>(Header))) &#123;<br>            ......<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// dexæ–‡ä»¶è§£å‹ç¼©?</span><br>            map.<span class="hljs-built_in">reset</span>(zip_entry-&gt;<span class="hljs-built_in">MapDirectlyFromFile</span>(location.<span class="hljs-built_in">c_str</span>(), <span class="hljs-comment">/*out*/</span>error_msg));<br>            <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">nullptr</span>) &#123;<br>                <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">&quot;Can&#x27;t mmap dex file &quot;</span> &lt;&lt; location &lt;&lt; <span class="hljs-string">&quot;!&quot;</span> &lt;&lt; entry_name &lt;&lt; <span class="hljs-string">&quot; directly; &quot;</span><br>                    &lt;&lt; <span class="hljs-string">&quot;is your ZIP file corrupted? Falling back to extraction.&quot;</span>;<br>                <span class="hljs-comment">// Try again with Extraction which still has a chance of recovery.</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-comment">// Default path for compressed ZIP entries,</span><br>        <span class="hljs-comment">// and fallback for stored ZIP entries.</span><br>        map.<span class="hljs-built_in">reset</span>(zip_entry-&gt;<span class="hljs-built_in">ExtractToMemMap</span>(location.<span class="hljs-built_in">c_str</span>(), entry_name, error_msg));<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">nullptr</span>) &#123;<br>        *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Failed to extract &#x27;%s&#x27; from &#x27;%s&#x27;: %s&quot;</span>, entry_name, location.<span class="hljs-built_in">c_str</span>(), error_msg-&gt;<span class="hljs-built_in">c_str</span>());<br>        *error_code = ZipOpenErrorCode::kExtractToMemoryError;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    VerifyResult verify_result;<br>    std::unique_ptr&lt;DexFile&gt; dex_file = <span class="hljs-built_in">OpenCommon</span>(map-&gt;<span class="hljs-built_in">Begin</span>(),<br>                                                   map-&gt;<span class="hljs-built_in">Size</span>(),<br>                                                   location,<br>                                                   zip_entry-&gt;<span class="hljs-built_in">GetCrc32</span>(),<br>                                                   kNoOatDexFile,<br>                                                   <span class="hljs-comment">/* verify */</span> <span class="hljs-literal">true</span>,<br>                                                   verify_checksum,<br>                                                   error_msg,<br>                                                   &amp;verify_result);<br>    <span class="hljs-keyword">if</span> (dex_file == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">if</span> (verify_result == VerifyResult::kVerifyNotAttempted) &#123;<br>            *error_code = ZipOpenErrorCode::kDexFileError;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            *error_code = ZipOpenErrorCode::kVerifyError;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    dex_file-&gt;mem_map_.<span class="hljs-built_in">reset</span>(map.<span class="hljs-built_in">release</span>());<br>    <span class="hljs-keyword">if</span> (!dex_file-&gt;<span class="hljs-built_in">DisableWrite</span>()) &#123;<br>        *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Failed to make dex file &#x27;%s&#x27; read only&quot;</span>, location.<span class="hljs-built_in">c_str</span>());<br>        *error_code = ZipOpenErrorCode::kMakeReadOnlyError;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-built_in">CHECK</span>(dex_file-&gt;<span class="hljs-built_in">IsReadOnly</span>()) &lt;&lt; location;<br>    <span class="hljs-keyword">if</span> (verify_result != VerifyResult::kVerifySucceeded) &#123;<br>        *error_code = ZipOpenErrorCode::kVerifyError;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    *error_code = ZipOpenErrorCode::kNoError;<br>    <span class="hljs-keyword">return</span> dex_file;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨<code>OpenCommon()</code>æ–¹æ³•ã€‚</p><h3 id="1-2-2-DexFile-OpenFile"><a href="#1-2-2-DexFile-OpenFile" class="headerlink" title="1.2.2 DexFile::OpenFile()"></a>1.2.2 DexFile::OpenFile()</h3><p>ç„¶åæ˜¯<code>DexFile::OpenFile()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file.cc</span><br><span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; <span class="hljs-title">DexFile::OpenFile</span><span class="hljs-params">(<span class="hljs-type">int</span> fd,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                 <span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                 <span class="hljs-type">bool</span> verify,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                 <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                 std::string* error_msg)</span> </span>&#123;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(std::string(<span class="hljs-string">&quot;Open dex file &quot;</span>) + std::string(location))</span></span>;<br>    <span class="hljs-built_in">CHECK</span>(!location.<span class="hljs-built_in">empty</span>());<br>    std::unique_ptr&lt;MemMap&gt; map;<br>    &#123;<br>        <span class="hljs-function">File <span class="hljs-title">delayed_close</span><span class="hljs-params">(fd, <span class="hljs-comment">/* check_usage */</span> <span class="hljs-literal">false</span>)</span></span>;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> sbuf;<br>        <span class="hljs-built_in">memset</span>(&amp;sbuf, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(sbuf));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fstat</span>(fd, &amp;sbuf) == <span class="hljs-number">-1</span>) &#123;<br>            *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;DexFile: fstat &#x27;%s&#x27; failed: %s&quot;</span>, location.<span class="hljs-built_in">c_str</span>(),<br>                                      <span class="hljs-built_in">strerror</span>(errno));<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISDIR</span>(sbuf.st_mode)) &#123;<br>            *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Attempt to mmap directory &#x27;%s&#x27;&quot;</span>, location.<span class="hljs-built_in">c_str</span>());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>        &#125;<br>        <span class="hljs-type">size_t</span> length = sbuf.st_size;<br>        <span class="hljs-comment">//å°†dexæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­</span><br>        map.<span class="hljs-built_in">reset</span>(MemMap::<span class="hljs-built_in">MapFile</span>(length,<br>                                  PROT_READ,<br>                                  MAP_PRIVATE,<br>                                  fd,<br>                                  <span class="hljs-number">0</span>,<br>                                  <span class="hljs-comment">/*low_4gb*/</span><span class="hljs-literal">false</span>,<br>                                  location.<span class="hljs-built_in">c_str</span>(),<br>                                  error_msg));<br>        <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-built_in">DCHECK</span>(!error_msg-&gt;<span class="hljs-built_in">empty</span>());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (map-&gt;<span class="hljs-built_in">Size</span>() &lt; <span class="hljs-built_in">sizeof</span>(DexFile::Header)) &#123;<br>        *error_msg = <span class="hljs-built_in">StringPrintf</span>(<br>            <span class="hljs-string">&quot;DexFile: failed to open dex file &#x27;%s&#x27; that is too short to have a header&quot;</span>,<br>            location.<span class="hljs-built_in">c_str</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-type">const</span> Header* dex_header = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> Header*&gt;(map-&gt;<span class="hljs-built_in">Begin</span>());<br><br>    std::unique_ptr&lt;DexFile&gt; dex_file = <span class="hljs-built_in">OpenCommon</span>(map-&gt;<span class="hljs-built_in">Begin</span>(),<br>                                                   map-&gt;<span class="hljs-built_in">Size</span>(),<br>                                                   location,<br>                                                   dex_header-&gt;checksum_,<br>                                                   kNoOatDexFile,<br>                                                   verify,<br>                                                   verify_checksum,<br>                                                   error_msg);<br>    <span class="hljs-keyword">if</span> (dex_file != <span class="hljs-literal">nullptr</span>) &#123;<br>        dex_file-&gt;mem_map_.<span class="hljs-built_in">reset</span>(map.<span class="hljs-built_in">release</span>());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dex_file;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨<code>OpenCommon()</code>æ–¹æ³•ã€‚</p><p>ç”±æ­¤çœ‹è§ï¼Œæ— è®ºdexæ–‡ä»¶çš„æ‰“å¼€è¿‡ç¨‹å¤šä¹ˆæ›²æŠ˜å’Œå¤šæ ·ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨<code>OpenCommon()</code>æ–¹æ³•ï¼Œå› æ­¤è¯¥æ–¹æ³•å¯ä½œä¸º<strong>è„±å£³ç‚¹</strong>ä½¿ç”¨ï¼ˆAndroid 7å¯¹åº”çš„æ˜¯<code>OpenMemory()</code>ï¼‰</p><h1 id="äºŒã€OpenCommon"><a href="#äºŒã€OpenCommon" class="headerlink" title="äºŒã€OpenCommon()"></a>äºŒã€OpenCommon()</h1><p><code>OpenCommon()</code>æ–¹æ³•å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file.cc</span><br><span class="hljs-function">std::unique_ptr&lt;DexFile&gt; <span class="hljs-title">DexFile::OpenCommon</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* base,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">size_t</span> size,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">const</span> std::string&amp; location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">uint32_t</span> location_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">const</span> OatDexFile* oat_dex_file,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">bool</span> verify,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             std::string* error_msg,</span></span><br><span class="hljs-params"><span class="hljs-function">                                             VerifyResult* verify_result)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (verify_result != <span class="hljs-literal">nullptr</span>) &#123;<br>        *verify_result = VerifyResult::kVerifyNotAttempted;<br>    &#125;<br>    <span class="hljs-comment">//åˆ›å»ºDexFileå¯¹è±¡</span><br>    <span class="hljs-function">std::unique_ptr&lt;DexFile&gt; <span class="hljs-title">dex_file</span><span class="hljs-params">(<span class="hljs-keyword">new</span> DexFile(base,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  size,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  location_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  oat_dex_file))</span></span>;<br>    <span class="hljs-keyword">if</span> (dex_file == <span class="hljs-literal">nullptr</span>) &#123;<br>        *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Failed to open dex file &#x27;%s&#x27; from memory: %s&quot;</span>, location.<span class="hljs-built_in">c_str</span>(),<br>                                  error_msg-&gt;<span class="hljs-built_in">c_str</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-comment">//Init()åˆå§‹åŒ–dex file</span><br>    <span class="hljs-keyword">if</span> (!dex_file-&gt;<span class="hljs-built_in">Init</span>(error_msg)) &#123;<br>        dex_file.<span class="hljs-built_in">reset</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-comment">//Verify()å¯¹dex fileè¿›è¡ŒéªŒè¯</span><br>    <span class="hljs-keyword">if</span> (verify &amp;&amp; !DexFileVerifier::<span class="hljs-built_in">Verify</span>(dex_file.<span class="hljs-built_in">get</span>(),<br>                                           dex_file-&gt;<span class="hljs-built_in">Begin</span>(),<br>                                           dex_file-&gt;<span class="hljs-built_in">Size</span>(),<br>                                           location.<span class="hljs-built_in">c_str</span>(),<br>                                           verify_checksum,<br>                                           error_msg)) &#123;<br>        <span class="hljs-keyword">if</span> (verify_result != <span class="hljs-literal">nullptr</span>) &#123;<br>            *verify_result = VerifyResult::kVerifyFailed;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (verify_result != <span class="hljs-literal">nullptr</span>) &#123;<br>        *verify_result = VerifyResult::kVerifySucceeded;<br>    &#125;<br>    <span class="hljs-keyword">return</span> dex_file;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è°ƒç”¨<code>DexFile()</code>åˆ›å»ºDexFileå¯¹è±¡ï¼Œç„¶åè°ƒç”¨<code>Init()</code>æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œæœ€åè°ƒç”¨<code>Verify()</code>æ–¹æ³•å¯¹dexæ–‡ä»¶è¿›è¡ŒéªŒè¯ã€‚</p><h2 id="2-1-DexFile"><a href="#2-1-DexFile" class="headerlink" title="2.1 DexFile()"></a>2.1 DexFile()</h2><p><code>DexFile()</code>æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp">DexFile::<span class="hljs-built_in">DexFile</span>(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* base,<br>                 <span class="hljs-type">size_t</span> size,<br>                 <span class="hljs-type">const</span> std::string&amp; location,<br>                 <span class="hljs-type">uint32_t</span> location_checksum,<br>                 <span class="hljs-type">const</span> OatDexFile* oat_dex_file)<br>    : <span class="hljs-built_in">begin_</span>(base),<br>      <span class="hljs-built_in">size_</span>(size),<br>      <span class="hljs-built_in">location_</span>(location),<br>      <span class="hljs-built_in">location_checksum_</span>(location_checksum),<br>      <span class="hljs-built_in">header_</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> Header*&gt;(base)),<br>      <span class="hljs-built_in">string_ids_</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> StringId*&gt;(base + header_-&gt;string_ids_off_)),<br>      <span class="hljs-built_in">type_ids_</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> TypeId*&gt;(base + header_-&gt;type_ids_off_)),<br>      <span class="hljs-built_in">field_ids_</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> FieldId*&gt;(base + header_-&gt;field_ids_off_)),<br>      <span class="hljs-built_in">method_ids_</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> MethodId*&gt;(base + header_-&gt;method_ids_off_)),<br>      <span class="hljs-built_in">proto_ids_</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> ProtoId*&gt;(base + header_-&gt;proto_ids_off_)),<br>      <span class="hljs-built_in">class_defs_</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> ClassDef*&gt;(base + header_-&gt;class_defs_off_)),<br>      <span class="hljs-built_in">method_handles_</span>(<span class="hljs-literal">nullptr</span>),<br>      <span class="hljs-built_in">num_method_handles_</span>(<span class="hljs-number">0</span>),<br>      <span class="hljs-built_in">call_site_ids_</span>(<span class="hljs-literal">nullptr</span>),<br>      <span class="hljs-built_in">num_call_site_ids_</span>(<span class="hljs-number">0</span>),<br>      <span class="hljs-built_in">oat_dex_file_</span>(oat_dex_file) &#123;<br><br>    <span class="hljs-built_in">CHECK</span>(begin_ != <span class="hljs-literal">nullptr</span>) &lt;&lt; <span class="hljs-built_in">GetLocation</span>();<br>    <span class="hljs-built_in">CHECK_GT</span>(size_, <span class="hljs-number">0U</span>) &lt;&lt; <span class="hljs-built_in">GetLocation</span>();<br>    <span class="hljs-comment">// Check base (=header) alignment.</span><br>    <span class="hljs-comment">// Must be 4-byte aligned to avoid undefined behavior when accessing</span><br>    <span class="hljs-comment">// any of the sections via a pointer.</span><br>    <span class="hljs-built_in">CHECK_ALIGNED</span>(begin_, <span class="hljs-built_in">alignof</span>(Header));<br><br>    <span class="hljs-built_in">InitializeSectionsFromMapList</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p><code>DexFile()</code>å‡½æ•°åé¢åŠ <code>:</code>æ˜¯èµ‹å€¼çš„æ„æ€ï¼Œå³æŠŠ<code>()</code>ä¸­çš„å˜é‡èµ‹å€¼ç»™<code>()</code>å‰çš„å˜é‡ã€‚å› ä¸ºè¯¥æ–¹æ³•å¸¦æœ‰dexçš„baseå’Œsizeå‚æ•°ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªè„±å£³ç‚¹ã€‚</p><p>æ•´ä¸ªå‡½æ•°ä¸»è¦æ˜¯è°ƒç”¨äº†<code>InitializeSectionsFromMapList()</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DexFile::InitializeSectionsFromMapList</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">const</span> MapList* map_list = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> MapList*&gt;(begin_ + header_-&gt;map_off_);<br>    <span class="hljs-keyword">if</span> (header_-&gt;map_off_ == <span class="hljs-number">0</span> || header_-&gt;map_off_ &gt; size_) &#123;<br>        <span class="hljs-comment">// Bad offset. The dex file verifier runs after this method and will reject the file.</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> count = map_list-&gt;size_;<br><br>    <span class="hljs-type">size_t</span> map_limit = header_-&gt;map_off_ + count * <span class="hljs-built_in">sizeof</span>(MapItem);<br>    <span class="hljs-keyword">if</span> (header_-&gt;map_off_ &gt;= map_limit || map_limit &gt; size_) &#123;<br>        <span class="hljs-comment">// Overflow or out out of bounds. The dex file verifier runs after</span><br>        <span class="hljs-comment">// this method and will reject the file as it is malformed.</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) &#123;<br>        <span class="hljs-type">const</span> MapItem&amp; map_item = map_list-&gt;list_[i];<br>        <span class="hljs-keyword">if</span> (map_item.type_ == kDexTypeMethodHandleItem) &#123;<br>            method_handles_ = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> MethodHandleItem*&gt;(begin_ + map_item.offset_);<br>            num_method_handles_ = map_item.size_;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (map_item.type_ == kDexTypeCallSiteIdItem) &#123;<br>            call_site_ids_ = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> CallSiteIdItem*&gt;(begin_ + map_item.offset_);<br>            num_call_site_ids_ = map_item.size_;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç é€»è¾‘ä¸ºï¼šé€šè¿‡dexæ–‡ä»¶ä¸­çš„map_listç»“æ„æ¥è§£ædexæ–‡ä»¶ã€‚</p><h2 id="2-2-Init"><a href="#2-2-Init" class="headerlink" title="2.2 Init()"></a>2.2 Init()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">bool DexFile::Init(std::string* error_msg) &#123;<br>    <span class="hljs-keyword">if</span> (!CheckMagicAndVersion(error_msg)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>CheckMagicAndVersion()</code>æ–¹æ³•æ£€æŸ¥magicï¼Œå³æ–‡ä»¶å¤´å’Œç‰ˆæœ¬å·ã€‚</p><h2 id="2-3-DexFileVerifier-Verify"><a href="#2-3-DexFileVerifier-Verify" class="headerlink" title="2.3 DexFileVerifier::Verify()"></a>2.3 DexFileVerifier::Verify()</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file_verifier.cc</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DexFileVerifier::Verify</span><span class="hljs-params">(<span class="hljs-type">const</span> DexFile* dex_file,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* begin,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-type">size_t</span> size,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-type">const</span> <span class="hljs-type">char</span>* location,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-type">bool</span> verify_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                             std::string* error_msg)</span> </span>&#123;<br>    <span class="hljs-function">std::unique_ptr&lt;DexFileVerifier&gt; <span class="hljs-title">verifier</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-keyword">new</span> DexFileVerifier(dex_file, begin, size, location, verify_checksum))</span></span>;<br>    <span class="hljs-keyword">if</span> (!verifier-&gt;<span class="hljs-built_in">Verify</span>()) &#123;<br>        *error_msg = verifier-&gt;<span class="hljs-built_in">FailureReason</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç åŠŸèƒ½ä¸»è¦æ˜¯åˆ›å»ºDexFileVerifierå¯¹è±¡ï¼Œå¹¶è°ƒç”¨<code>Verify()</code>æ–¹æ³•éªŒè¯dexæ–‡ä»¶ç»“æ„ã€‚<code>Verify()</code>æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/dex_file_verifier.cc</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DexFileVerifier::Verify</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// æ£€æŸ¥dexheaer</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CheckHeader</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æ£€æŸ¥map_list</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CheckMap</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æ£€æŸ¥å‰©ä½™éƒ¨åˆ†ï¼Œå¦‚string_idsã€type_idsç­‰</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CheckIntraSection</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Check references from one section to another.</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CheckInterSection</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¸‰ã€æ€»è§ˆå›¾"><a href="#ä¸‰ã€æ€»è§ˆå›¾" class="headerlink" title="ä¸‰ã€æ€»è§ˆå›¾"></a>ä¸‰ã€æ€»è§ˆå›¾</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202311202114333.png"></p><hr><p>å‚è€ƒï¼š</p><p><a href="http://aospxref.com/android-8.0.0_r36/">http://aospxref.com/android-8.0.0_r36/</a></p><p>[<a href="https://bbs.kanxue.com/thread-257917.htm">åŸåˆ›]èœé¸Ÿå­¦8.1ç‰ˆæœ¬dexåŠ è½½æµç¨‹ç¬”è®°â€“ç¬¬äºŒç¯‡:DexFile::Openæµç¨‹ä¸ç®€å•è„±å£³åŸç†-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p>[<a href="https://bbs.kanxue.com/thread-277771.htm#msg_header_h2_2">åŸåˆ›]ARTç¯å¢ƒä¸‹dexåŠ è½½æµç¨‹åˆ†æåŠfrida dump dexæ–¹æ¡ˆ-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidæºç è§£æ</tag>
      
      <tag>dex</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dexæ–‡ä»¶åŠ è½½æµç¨‹(äºŒ)</title>
    <link href="/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%BA%8C)/"/>
    <url>/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%BA%8C)/</url>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šæ–‡<a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%80)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸€)(gal2xy.github.io)</a>ã€‚</p><h1 id="ä¸€ã€DexFile-openDexFileNative"><a href="#ä¸€ã€DexFile-openDexFileNative" class="headerlink" title="ä¸€ã€DexFile_openDexFileNative()"></a>ä¸€ã€DexFile_openDexFileNative()</h1><p>å­¦ä¹ å®Œä¸Šä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬çŸ¥é“ï¼šä¸ç®¡æ˜¯ç”¨PathClassLoaderè¿˜æ˜¯DexClassLoaderåŠ è½½dexæ–‡ä»¶ï¼Œå®ƒä»¬æœ€ç»ˆéƒ½ä¼šè°ƒç”¨<code>openDexFileNative()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯¹åº”<code>art/runtime/native/dalivk_system_DexFile.cc</code>ç›®å½•ä¸‹çš„<code>DexFile_openDexFileNative()</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼šart/runtime/native/dalivk_system_DexFile.cc</span><br><span class="hljs-function"><span class="hljs-type">static</span> jobject <span class="hljs-title">DexFile_openDexFileNative</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         jclass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         jstring javaSourceName,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         jstring javaOutputName ATTRIBUTE_UNUSED,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         jint flags ATTRIBUTE_UNUSED,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         jobject class_loader,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         jobjectArray dex_elements)</span> </span>&#123;<br>    <span class="hljs-function">ScopedUtfChars <span class="hljs-title">sourceName</span><span class="hljs-params">(env, javaSourceName)</span></span>;<br>    <span class="hljs-keyword">if</span> (sourceName.<span class="hljs-built_in">c_str</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    Runtime* <span class="hljs-type">const</span> runtime = Runtime::<span class="hljs-built_in">Current</span>();<br>    ClassLinker* linker = runtime-&gt;<span class="hljs-built_in">GetClassLinker</span>();<br>    std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt; dex_files;<br>    std::vector&lt;std::string&gt; error_msgs;<br>    <span class="hljs-type">const</span> OatFile* oat_file = <span class="hljs-literal">nullptr</span>;<br><span class="hljs-comment">//æ‰“å¼€oatæ–‡ä»¶</span><br>    dex_files = runtime-&gt;<span class="hljs-built_in">GetOatFileManager</span>().<span class="hljs-built_in">OpenDexFilesFromOat</span>(sourceName.<span class="hljs-built_in">c_str</span>(),<br>                                                                 class_loader,<br>                                                                 dex_elements,<br>                                                                 <span class="hljs-comment">/*out*/</span> &amp;oat_file,<br>                                                                 <span class="hljs-comment">/*out*/</span> &amp;error_msgs);<br><br>    <span class="hljs-keyword">if</span> (!dex_files.<span class="hljs-built_in">empty</span>()) &#123;<br>        jlongArray array = <span class="hljs-built_in">ConvertDexFilesToJavaArray</span>(env, oat_file, dex_files);<br>        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; dex_file : dex_files) &#123;<br>                <span class="hljs-keyword">if</span> (linker-&gt;<span class="hljs-built_in">IsDexFileRegistered</span>(soa.<span class="hljs-built_in">Self</span>(), *dex_file)) &#123;<br>                    dex_file.<span class="hljs-built_in">release</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> array;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>       ......<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•´ä¸ªä»£ç å…³é”®éƒ¨åˆ†æ˜¯è°ƒç”¨äº†<code>OpenDexFilesFromOat()</code>æ–¹æ³•ã€‚</p><h1 id="äºŒã€OpenDexFilesFromOat"><a href="#äºŒã€OpenDexFilesFromOat" class="headerlink" title="äºŒã€OpenDexFilesFromOat()"></a>äºŒã€OpenDexFilesFromOat()</h1><p>å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/oat_file_manager.cc</span><br>std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt; OatFileManager::<span class="hljs-built_in">OpenDexFilesFromOat</span>(<br>                                            <span class="hljs-type">const</span> <span class="hljs-type">char</span>* dex_location,<br>                                            jobject class_loader,<br>                                            jobjectArray dex_elements,<br>                                            <span class="hljs-type">const</span> OatFile** out_oat_file,<br>                                            std::vector&lt;std::string&gt;* error_msgs) &#123;<br>    ......<br><span class="hljs-comment">//è·å–oat_file_assistant</span><br>    <span class="hljs-function">OatFileAssistant <span class="hljs-title">oat_file_assistant</span><span class="hljs-params">(dex_location, kRuntimeISA, !runtime-&gt;IsAotCompiler())</span></span>;<br><br>    ......<br><br>    <span class="hljs-type">const</span> OatFile* source_oat_file = <span class="hljs-literal">nullptr</span>;<br><span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦æœ‰ç”Ÿæˆ oat æ–‡ä»¶</span><br>    <span class="hljs-keyword">if</span> (!oat_file_assistant.<span class="hljs-built_in">IsUpToDate</span>()) &#123;<br>        <span class="hljs-comment">//æ‰§è¡ŒMakeUpToDateç”Ÿæˆoatæ–‡ä»¶</span><br>        <span class="hljs-keyword">switch</span> (oat_file_assistant.<span class="hljs-built_in">MakeUpToDate</span>(<span class="hljs-comment">/*profile_changed*/</span><span class="hljs-literal">false</span>, <span class="hljs-comment">/*out*/</span> &amp;error_msg)) &#123;<br>            ......<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// é€šè¿‡oat_file_assistant.GetBestOatFile()è·å–oatæ–‡ä»¶</span><br>    <span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">const</span> OatFile&gt; <span class="hljs-title">oat_file</span><span class="hljs-params">(oat_file_assistant.GetBestOatFile().release())</span></span>;<br><br>    <span class="hljs-keyword">if</span> (oat_file != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-type">bool</span> accept_oat_file = !<span class="hljs-built_in">HasCollisions</span>(oat_file.<span class="hljs-built_in">get</span>(), class_loader, dex_elements, <span class="hljs-comment">/*out*/</span> &amp;error_msg);<br>        <span class="hljs-keyword">if</span> (!accept_oat_file) &#123;<br>            <span class="hljs-comment">// å†²çªæ£€æµ‹å¤±è´¥ï¼Œæ‰“å°è­¦å‘Š</span><br>            ......<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (accept_oat_file) &#123;<br>            <span class="hljs-built_in">VLOG</span>(class_linker) &lt;&lt; <span class="hljs-string">&quot;Registering &quot;</span> &lt;&lt; oat_file-&gt;<span class="hljs-built_in">GetLocation</span>();<br>            source_oat_file = <span class="hljs-built_in">RegisterOatFile</span>(std::<span class="hljs-built_in">move</span>(oat_file));<br>            *out_oat_file = source_oat_file;<br>        &#125;<br>    &#125;<br><br>    std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt; dex_files;<br><br>    <span class="hljs-comment">// ä»oatæ–‡ä»¶ä¸­åŠ è½½dexæ–‡ä»¶</span><br>    <span class="hljs-keyword">if</span> (source_oat_file != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-type">bool</span> added_image_space = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">//ifè¯­å¥è¿™ä¸€å¤§å—çš„ä½œç”¨æ˜¯ç»™oatæ–‡ä»¶å¼€è¾Ÿé•œåƒç©ºé—´?</span><br>        <span class="hljs-keyword">if</span> (source_oat_file-&gt;<span class="hljs-built_in">IsExecutable</span>()) &#123;<br>            std::unique_ptr&lt;gc::space::ImageSpace&gt; image_space = kEnableAppImage ? oat_file_assistant.<span class="hljs-built_in">OpenImageSpace</span>(source_oat_file) : <span class="hljs-literal">nullptr</span>;<br>            <span class="hljs-keyword">if</span> (image_space != <span class="hljs-literal">nullptr</span>) &#123;<br>                <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(self)</span></span>;<br>                <span class="hljs-function">StackHandleScope&lt;1&gt; <span class="hljs-title">hs</span><span class="hljs-params">(self)</span></span>;<br>                <span class="hljs-function">Handle&lt;mirror::ClassLoader&gt; <span class="hljs-title">h_loader</span><span class="hljs-params">(hs.NewHandle(soa.Decode&lt;mirror::ClassLoader&gt;(class_loader)))</span></span>;<br>                <span class="hljs-comment">// Can not load app image without class loader.</span><br>                <span class="hljs-keyword">if</span> (h_loader != <span class="hljs-literal">nullptr</span>) &#123;<br>                    std::string temp_error_msg;<br>                    <span class="hljs-comment">// Add image space has a race condition since other threads could be reading from the</span><br>                    <span class="hljs-comment">// spaces array.</span><br>                    &#123;<br>                        <span class="hljs-function">ScopedThreadSuspension <span class="hljs-title">sts</span><span class="hljs-params">(self, kSuspended)</span></span>;<br>                        <span class="hljs-function">gc::ScopedGCCriticalSection <span class="hljs-title">gcs</span><span class="hljs-params">(self,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                        gc::kGcCauseAddRemoveAppImageSpace,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                        gc::kCollectorTypeAddRemoveAppImageSpace)</span></span>;<br>                        <span class="hljs-function">ScopedSuspendAll <span class="hljs-title">ssa</span><span class="hljs-params">(<span class="hljs-string">&quot;Add image space&quot;</span>)</span></span>;<br>                        runtime-&gt;<span class="hljs-built_in">GetHeap</span>()-&gt;<span class="hljs-built_in">AddSpace</span>(image_space.<span class="hljs-built_in">get</span>());<br>                    &#125;<br>                    &#123;<br>                        <span class="hljs-function">ScopedTrace <span class="hljs-title">trace2</span><span class="hljs-params">(StringPrintf(<span class="hljs-string">&quot;Adding image space for location %s&quot;</span>, dex_location))</span></span>;<br>                        added_image_space = runtime-&gt;<span class="hljs-built_in">GetClassLinker</span>()-&gt;<span class="hljs-built_in">AddImageSpace</span>(image_space.<span class="hljs-built_in">get</span>(),<br>                                                                                     h_loader,<br>                                                                                     dex_elements,<br>                                                                                     dex_location,<br>                                                                                     <span class="hljs-comment">/*out*/</span>&amp;dex_files,<br>                                                                                     <span class="hljs-comment">/*out*/</span>&amp;temp_error_msg);<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (added_image_space) &#123;<br>                        image_space.<span class="hljs-built_in">release</span>();<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;Failed to add image file &quot;</span> &lt;&lt; temp_error_msg;<br>                        dex_files.<span class="hljs-built_in">clear</span>();<br>                        &#123;<br>                            <span class="hljs-function">ScopedThreadSuspension <span class="hljs-title">sts</span><span class="hljs-params">(self, kSuspended)</span></span>;<br>                            <span class="hljs-function">gc::ScopedGCCriticalSection <span class="hljs-title">gcs</span><span class="hljs-params">(self,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                            gc::kGcCauseAddRemoveAppImageSpace,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                            gc::kCollectorTypeAddRemoveAppImageSpace)</span></span>;<br>                            <span class="hljs-function">ScopedSuspendAll <span class="hljs-title">ssa</span><span class="hljs-params">(<span class="hljs-string">&quot;Remove image space&quot;</span>)</span></span>;<br>                            runtime-&gt;<span class="hljs-built_in">GetHeap</span>()-&gt;<span class="hljs-built_in">RemoveSpace</span>(image_space.<span class="hljs-built_in">get</span>());<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!added_image_space) &#123;<br>            <span class="hljs-built_in">DCHECK</span>(dex_files.<span class="hljs-built_in">empty</span>());<br>            <span class="hljs-comment">//æ‰§è¡ŒLoadDexFilesåŠ è½½dexæ–‡ä»¶</span><br>            dex_files = oat_file_assistant.<span class="hljs-built_in">LoadDexFiles</span>(*source_oat_file, dex_location);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (dex_files.<span class="hljs-built_in">empty</span>()) &#123;<span class="hljs-comment">//è·å–dexæ–‡ä»¶å¤±è´¥</span><br>            error_msgs-&gt;<span class="hljs-built_in">push_back</span>(<span class="hljs-string">&quot;Failed to open dex files from &quot;</span> + source_oat_file-&gt;<span class="hljs-built_in">GetLocation</span>());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//ä»oatæ–‡ä»¶ä¸­åŠ è½½dexæ–‡ä»¶å¤±è´¥</span><br>    <span class="hljs-keyword">if</span> (dex_files.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (oat_file_assistant.<span class="hljs-built_in">HasOriginalDexFiles</span>()) &#123;<span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦æœ‰åŸå§‹dexæ–‡ä»¶</span><br>            <span class="hljs-keyword">if</span> (Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">IsDexFileFallbackEnabled</span>()) &#123;<span class="hljs-comment">//æ˜¯å¦å¯ç”¨äº†Dexæ–‡ä»¶çš„å›é€€æœºåˆ¶</span><br>                <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">bool</span> kVerifyChecksum = <span class="hljs-literal">true</span>;<br>                <span class="hljs-comment">//è°ƒç”¨DexFile::Open()æ‰“å¼€dexæ–‡ä»¶</span><br>                <span class="hljs-keyword">if</span> (!DexFile::<span class="hljs-built_in">Open</span>(dex_location, dex_location, kVerifyChecksum, <span class="hljs-comment">/*out*/</span> &amp;error_msg, &amp;dex_files)) &#123;<br>                    <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; error_msg;<br>                    error_msgs-&gt;<span class="hljs-built_in">push_back</span>(<span class="hljs-string">&quot;Failed to open dex files from &quot;</span> + std::<span class="hljs-built_in">string</span>(dex_location)  + <span class="hljs-string">&quot; because: &quot;</span> + error_msg);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                error_msgs-&gt;<span class="hljs-built_in">push_back</span>(<span class="hljs-string">&quot;Fallback mode disabled, skipping dex files.&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            error_msgs-&gt;<span class="hljs-built_in">push_back</span>(<span class="hljs-string">&quot;No original dex files found for dex location &quot;</span> + std::<span class="hljs-built_in">string</span>(dex_location));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dex_files;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é€šè¿‡<code>oat_file_assistant()</code>è·å–oat_file_assistantå¯¹è±¡ã€‚</li><li>é€šè¿‡<code>oat_file_assistant.IsUpToDate()</code>åˆ¤æ–­æ˜¯å¦æœ‰oatæ–‡ä»¶ï¼Œæ²¡æœ‰è°ƒç”¨<code>oat_file_assistant.MakeUpToDate()</code>åˆ™ç”Ÿæˆoatæ–‡ä»¶ã€‚</li><li>é€šè¿‡<code>oat_file_assistant.GetBestOatFile()</code>è·å–oatæ–‡ä»¶</li><li>è°ƒç”¨<code>oat_file_assistant.LoadDexFiles()</code>ä»oatæ–‡ä»¶ä¸­åŠ è½½dexæ–‡ä»¶ã€‚</li><li>å¦‚æœä»oatæ–‡ä»¶ä¸­åŠ è½½dexæ–‡ä»¶å¤±è´¥ï¼Œåˆ™è°ƒç”¨<code>DexFile::Open()</code>åŠ è½½dexæ–‡ä»¶ã€‚</li></ol><h2 id="2-1-GetBestOatFile"><a href="#2-1-GetBestOatFile" class="headerlink" title="2.1 GetBestOatFile()"></a>2.1 GetBestOatFile()</h2><p>å…ˆæ¥çœ‹<code>GetBestOatFile()</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/oat_file_assistant.cc</span><br><span class="hljs-function">std::unique_ptr&lt;OatFile&gt; <span class="hljs-title">OatFileAssistant::GetBestOatFile</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetBestInfo</span>().<span class="hljs-built_in">ReleaseFileForUse</span>();<br>&#125;<br><br><span class="hljs-function">OatFileAssistant::OatFileInfo&amp; <span class="hljs-title">OatFileAssistant::GetBestInfo</span><span class="hljs-params">()</span> </span>&#123;<br><br>    <span class="hljs-keyword">if</span> (dex_parent_writable_) &#123;<span class="hljs-comment">//dexæ–‡ä»¶çˆ¶ç›®å½•å¯å†™åˆ™é€‰æ‹©odex</span><br>        <span class="hljs-keyword">return</span> odex_;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (oat_.<span class="hljs-built_in">IsUseable</span>()) &#123;<span class="hljs-comment">//oatæ–‡ä»¶å¯ç”¨é€‰æ‹©oat</span><br>        <span class="hljs-keyword">return</span> oat_;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (odex_.<span class="hljs-built_in">Status</span>() == kOatUpToDate) &#123;<span class="hljs-comment">//odexæ–‡ä»¶æœ€æ–°</span><br>        <span class="hljs-keyword">return</span> odex_;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HasOriginalDexFiles</span>()) &#123;<span class="hljs-comment">//å¦‚æœæœ‰åŸå§‹dexæ–‡ä»¶</span><br>        <span class="hljs-keyword">return</span> oat_;<br>    &#125;<br><span class="hljs-comment">//æœ€ç³Ÿç³•çš„æƒ…å†µï¼Œæœ‰å•¥å°±é€‰å•¥</span><br>    <span class="hljs-keyword">return</span> (odex_.<span class="hljs-built_in">Status</span>() == kOatCannotOpen) ? oat_ : odex_;<br>&#125;<br><br>std::unique_ptr&lt;OatFile&gt; OatFileAssistant::OatFileInfo::<span class="hljs-built_in">ReleaseFileForUse</span>() &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Status</span>() == kOatUpToDate) &#123;<span class="hljs-comment">//oatæ–‡ä»¶æ˜¯æœ€æ–°çš„åˆ™é‡Šæ”¾æ–‡ä»¶ä»¥ä¾›ç›´æ¥ä½¿ç”¨</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ReleaseFile</span>();<br>    &#125;<br><br>    <span class="hljs-built_in">VLOG</span>(oat) &lt;&lt; <span class="hljs-string">&quot;Oat File Assistant: No relocated oat file found,&quot;</span> &lt;&lt; <span class="hljs-string">&quot; attempting to fall back to interpreting oat file instead.&quot;</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Status</span>() == kOatRelocationOutOfDate &amp;&amp; !<span class="hljs-built_in">IsExecutable</span>()) &#123;<span class="hljs-comment">//oatéœ€è¦é‡å®šä½ä¸”ä¸å¯æ‰§è¡Œ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ReleaseFile</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Status</span>() == kOatRelocationOutOfDate) &#123;<span class="hljs-comment">//oatéœ€è¦é‡å®šä½</span><br>        <span class="hljs-comment">// è®¾ç½®åŠ è½½ä¸å¯æ‰§è¡Œï¼Œä»¥ç¡®ä¿èƒ½å¤Ÿè§£æoatä¸­çš„dexä»£ç </span><br>        oat_file_assistant_-&gt;load_executable_ = <span class="hljs-literal">false</span>;<br>        <span class="hljs-built_in">Reset</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsUseable</span>()) &#123;<br>            <span class="hljs-built_in">CHECK</span>(!<span class="hljs-built_in">IsExecutable</span>());<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">ReleaseFile</span>();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">unique_ptr</span>&lt;OatFile&gt;();<br>&#125;<br><br>std::unique_ptr&lt;OatFile&gt; OatFileAssistant::OatFileInfo::<span class="hljs-built_in">ReleaseFile</span>() &#123;<br>  file_released_ = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">move</span>(file_);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>GetBestOatFile()</code>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè°ƒç”¨<code>GetBestInfo()</code>æ¥è·å–æœ€ä½³çš„oatæ–‡ä»¶ï¼ˆä»£ç ä¸­çš„<code>oat_</code>å’Œ<code>oat_</code>åœ¨<code>/art/runtime/oat_file_assistant.cc</code>å®šä¹‰ï¼‰ï¼Œç„¶åè°ƒç”¨<code>ReleaseFileForUse()</code>æ–¹æ³•æ ¹æ®oatæ–‡ä»¶çš„çŠ¶æ€é‡Šæ”¾æ–‡ä»¶ä»¥ä¾›ä½¿ç”¨ã€‚</p><h3 id="2-1-1-Status"><a href="#2-1-1-Status" class="headerlink" title="2.1.1 Status()"></a>2.1.1 Status()</h3><p><code>GetBestInfo()</code>ä¸­ä½¿ç”¨çš„<code>Status()</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/oat_file_assistant.cc</span><br>OatFileAssistant::OatStatus OatFileAssistant::OatFileInfo::<span class="hljs-built_in">Status</span>() &#123;<br>    <span class="hljs-keyword">if</span> (!status_attempted_) &#123;<br>        status_attempted_ = <span class="hljs-literal">true</span>;<br>        <span class="hljs-comment">//æ‰“å¼€oatæ–‡ä»¶</span><br>        <span class="hljs-type">const</span> OatFile* file = <span class="hljs-built_in">GetFile</span>();<br>        <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-comment">// Check to see if there is a vdex file we can make use of.</span><br>            std::string error_msg;<br>            std::string vdex_filename = <span class="hljs-built_in">GetVdexFilename</span>(filename_);<br>            <span class="hljs-comment">//æ‰“å¼€vdexæ–‡ä»¶</span><br>            std::unique_ptr&lt;VdexFile&gt; vdex = VdexFile::<span class="hljs-built_in">Open</span>(vdex_filename,<br>                                                            <span class="hljs-comment">/*writeable*/</span><span class="hljs-literal">false</span>,<br>                                                            <span class="hljs-comment">/*low_4gb*/</span><span class="hljs-literal">false</span>,<br>                                                            <span class="hljs-comment">/*unquicken*/</span><span class="hljs-literal">false</span>,<br>                                                            &amp;error_msg);<br>            <span class="hljs-keyword">if</span> (vdex == <span class="hljs-literal">nullptr</span>) &#123;<br>                status_ = kOatCannotOpen;<br>                <span class="hljs-built_in">VLOG</span>(oat) &lt;&lt; <span class="hljs-string">&quot;unable to open vdex file &quot;</span> &lt;&lt; vdex_filename &lt;&lt; <span class="hljs-string">&quot;: &quot;</span> &lt;&lt; error_msg;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//æ£€æŸ¥vdexæ–‡ä»¶æ˜¯å¦æ˜¯æœ€æ–°çš„</span><br>                <span class="hljs-keyword">if</span> (oat_file_assistant_-&gt;<span class="hljs-built_in">DexChecksumUpToDate</span>(*vdex, &amp;error_msg)) &#123;<br>                    <span class="hljs-comment">// The vdex file does not contain enough information to determine</span><br>                    <span class="hljs-comment">// whether it is up to date with respect to the boot image, so we</span><br>                    <span class="hljs-comment">// assume it is out of date.</span><br>                    <span class="hljs-built_in">VLOG</span>(oat) &lt;&lt; error_msg;<br>                    status_ = kOatBootImageOutOfDate;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    status_ = kOatDexOutOfDate;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            status_ = oat_file_assistant_-&gt;<span class="hljs-built_in">GivenOatFileStatus</span>(*file);<br>            <span class="hljs-built_in">VLOG</span>(oat) &lt;&lt; file-&gt;<span class="hljs-built_in">GetLocation</span>() &lt;&lt; <span class="hljs-string">&quot; is &quot;</span> &lt;&lt; status_<br>                &lt;&lt; <span class="hljs-string">&quot; with filter &quot;</span> &lt;&lt; file-&gt;<span class="hljs-built_in">GetCompilerFilter</span>();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> status_;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡<code>GetFile()</code>æ–¹æ³•æ‰“å¼€oatæ–‡ä»¶ï¼Œå¦‚æœæœ‰vdexæ–‡ä»¶ï¼Œåˆ™è°ƒç”¨<code>VdexFile::Open()</code>æ–¹æ³•æ‰“å¼€vdexæ–‡ä»¶ã€‚</p><h4 id="2-1-1-1-GetFile"><a href="#2-1-1-1-GetFile" class="headerlink" title="2.1.1.1 GetFile()"></a>2.1.1.1 GetFile()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> OatFile* OatFileAssistant::OatFileInfo::<span class="hljs-built_in">GetFile</span>() &#123;<br>    <span class="hljs-built_in">CHECK</span>(!file_released_) &lt;&lt; <span class="hljs-string">&quot;GetFile called after oat file released.&quot;</span>;<br>    <span class="hljs-keyword">if</span> (!load_attempted_) &#123;<br>        load_attempted_ = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (filename_provided_) &#123;<br>            std::string error_msg;<br>            file_.<span class="hljs-built_in">reset</span>(OatFile::<span class="hljs-built_in">Open</span>(filename_.<span class="hljs-built_in">c_str</span>(),<br>                                      filename_.<span class="hljs-built_in">c_str</span>(),<br>                                      <span class="hljs-literal">nullptr</span>,<br>                                      <span class="hljs-literal">nullptr</span>,<br>                                      oat_file_assistant_-&gt;load_executable_,<br>                                      <span class="hljs-comment">/*low_4gb*/</span><span class="hljs-literal">false</span>,<br>                                      oat_file_assistant_-&gt;dex_location_.<span class="hljs-built_in">c_str</span>(),<br>                                      &amp;error_msg));<br>            <span class="hljs-keyword">if</span> (file_.<span class="hljs-built_in">get</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>                <span class="hljs-built_in">VLOG</span>(oat) &lt;&lt; <span class="hljs-string">&quot;OatFileAssistant test for existing oat file &quot;</span><br>                    &lt;&lt; filename_ &lt;&lt; <span class="hljs-string">&quot;: &quot;</span> &lt;&lt; error_msg;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> file_.<span class="hljs-built_in">get</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>OatFile::Open()</code>æ‰“å¼€oatæ–‡ä»¶ã€‚</p><p><code>OatFile::Open()</code>å’Œ<code>VdexFile::Open()</code>ç­‰è®²è§£oatå’Œvdexæ–‡ä»¶åŠ è½½æ—¶å†è¯¦ç»†åˆ†æï¼Œè¿™é‡Œå…ˆæ‰“ä½ï¼Œæ¯•ç«Ÿæˆ‘ä»¬ç°åœ¨è·Ÿè¸ªçš„æ˜¯dexæ–‡ä»¶åŠ è½½ã€‚</p><h2 id="2-2-LoadDexFiles"><a href="#2-2-LoadDexFiles" class="headerlink" title="2.2 LoadDexFiles()"></a>2.2 LoadDexFiles()</h2><p>å†æ¥çœ‹<code>LoadDexFiles()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/oat_file_assistant.cc</span><br>std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt; OatFileAssistant::<span class="hljs-built_in">LoadDexFiles</span>(<br>    <span class="hljs-type">const</span> OatFile&amp; oat_file, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* dex_location) &#123;<br>    std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt; dex_files;<br><br>    <span class="hljs-comment">// Load the main dex file.</span><br>    std::string error_msg;<br>    <br>    <span class="hljs-comment">//é€šè¿‡oat_file.GetOatDexFile()è·å¾—oatã€dexæ–‡ä»¶</span><br>    <span class="hljs-type">const</span> OatFile::OatDexFile* oat_dex_file = oat_file.<span class="hljs-built_in">GetOatDexFile</span>(dex_location, <span class="hljs-literal">nullptr</span>, &amp;error_msg);<br>    <span class="hljs-keyword">if</span> (oat_dex_file == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; error_msg;<br>        <span class="hljs-keyword">return</span> std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt;();<br>    &#125;<br>    <br><span class="hljs-comment">//é€šè¿‡oat_dex_file-&gt;OpenDexFile()æ‰“å¼€dexæ–‡ä»¶</span><br>    std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; dex_file = oat_dex_file-&gt;<span class="hljs-built_in">OpenDexFile</span>(&amp;error_msg);<br>    <span class="hljs-keyword">if</span> (dex_file.<span class="hljs-built_in">get</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">&quot;Failed to open dex file from oat dex file: &quot;</span> &lt;&lt; error_msg;<br>        <span class="hljs-keyword">return</span> std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt;();<br>    &#125;<br>    <span class="hljs-comment">//æ·»åŠ dexæ–‡ä»¶åˆ°dex_filesæ•°ç»„ä¸­</span><br>    dex_files.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(dex_file));<br><br>    <span class="hljs-comment">// çœ‹æ˜¯å¦å­˜åœ¨å¤šä¸ªdexæ–‡ä»¶</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">1</span>; ; i++) &#123;<br>        std::string multidex_dex_location = DexFile::<span class="hljs-built_in">GetMultiDexLocation</span>(i, dex_location);<br><span class="hljs-comment">//ä»oatä¸­è·å–ç¬¬iä¸ªdexæ–‡ä»¶</span><br>        oat_dex_file = oat_file.<span class="hljs-built_in">GetOatDexFile</span>(multidex_dex_location.<span class="hljs-built_in">c_str</span>(), <span class="hljs-literal">nullptr</span>);<br>        <span class="hljs-keyword">if</span> (oat_dex_file == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-comment">// There are no more multidex entries to load.</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><span class="hljs-comment">//æ‰“å¼€ç¬¬iä¸ªdexæ–‡ä»¶</span><br>        dex_file = oat_dex_file-&gt;<span class="hljs-built_in">OpenDexFile</span>(&amp;error_msg);<br>        <span class="hljs-keyword">if</span> (dex_file.<span class="hljs-built_in">get</span>() == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">&quot;Failed to open dex file from oat dex file: &quot;</span> &lt;&lt; error_msg;<br>            <span class="hljs-keyword">return</span> std::vector&lt;std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt;&gt;();<br>        &#125;<br>        <span class="hljs-comment">//æ·»åŠ dexæ–‡ä»¶åˆ°dex_filesæ•°ç»„ä¸­</span><br>        dex_files.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(dex_file));<br>    &#125;<br>    <span class="hljs-keyword">return</span> dex_files;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯<code>GetOatDexFile()</code>ã€<code>OpenDexFile()</code>ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¸<code>OpenDexFilesFromOat()</code>æ–¹æ³•ä¸­è°ƒç”¨çš„<code>Open()</code>æ–¹æ³•åŒåœ¨<code>oat_file.cc</code>æ–‡ä»¶ä¸­ã€‚</p><h3 id="2-2-1-GetOatDexFile"><a href="#2-2-1-GetOatDexFile" class="headerlink" title="2.2.1 GetOatDexFile()"></a>2.2.1 GetOatDexFile()</h3><p>å…ˆæ¥çœ‹<code>GetOatDexFile()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//è·¯å¾„ï¼š/art/runtime/oat_file.cc</span><br><span class="hljs-function"><span class="hljs-type">const</span> OatFile::OatDexFile* <span class="hljs-title">OatFile::GetOatDexFile</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* dex_location,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                 <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span>* dex_location_checksum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                 std::string* error_msg)</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-type">const</span> OatFile::OatDexFile* oat_dex_file = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-function">StringPiece <span class="hljs-title">key</span><span class="hljs-params">(dex_location)</span></span>;<br>    <span class="hljs-comment">//é€šè¿‡keyåœ¨oat_dex_files_mapä¸­æ‰¾åˆ°dexæ–‡ä»¶æ‰€åœ¨ä½ç½®</span><br>    <span class="hljs-keyword">auto</span> primary_it = oat_dex_files_.<span class="hljs-built_in">find</span>(key);<br>    <span class="hljs-keyword">if</span> (primary_it != oat_dex_files_.<span class="hljs-built_in">end</span>()) &#123;<span class="hljs-comment">//dexæ–‡ä»¶ä¸å”¯ä¸€</span><br>        oat_dex_file = primary_it-&gt;second;<br>        <span class="hljs-built_in">DCHECK</span>(oat_dex_file != <span class="hljs-literal">nullptr</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// This dex_location is not one of the dex locations directly mentioned in the</span><br>        <span class="hljs-comment">// oat file. The correct lookup is via the canonical location but first see in</span><br>        <span class="hljs-comment">// the secondary_oat_dex_files_ whether we&#x27;ve looked up this location before.</span><br>        MutexLock <span class="hljs-built_in">mu</span>(Thread::<span class="hljs-built_in">Current</span>(), secondary_lookup_lock_);<br>        <span class="hljs-keyword">auto</span> secondary_lb = secondary_oat_dex_files_.<span class="hljs-built_in">lower_bound</span>(key);<br>        <span class="hljs-keyword">if</span> (secondary_lb != secondary_oat_dex_files_.<span class="hljs-built_in">end</span>() &amp;&amp; key == secondary_lb-&gt;first) &#123;<br>            oat_dex_file = secondary_lb-&gt;second;  <span class="hljs-comment">// May be null.</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// We haven&#x27;t seen this dex_location before, we must check the canonical location.</span><br>            std::string dex_canonical_location = DexFile::<span class="hljs-built_in">GetDexCanonicalLocation</span>(dex_location);<br>            <span class="hljs-keyword">if</span> (dex_canonical_location != dex_location) &#123;<br>                <span class="hljs-function">StringPiece <span class="hljs-title">canonical_key</span><span class="hljs-params">(dex_canonical_location)</span></span>;<br>                <span class="hljs-keyword">auto</span> canonical_it = oat_dex_files_.<span class="hljs-built_in">find</span>(canonical_key);<br>                <span class="hljs-keyword">if</span> (canonical_it != oat_dex_files_.<span class="hljs-built_in">end</span>()) &#123;<br>                    oat_dex_file = canonical_it-&gt;second;<br>                &#125;  <span class="hljs-comment">// else keep null.</span><br>            &#125;  <span class="hljs-comment">// else keep null.</span><br><br>            <span class="hljs-comment">// Copy the key to the string_cache_ and store the result in secondary map.</span><br>            string_cache_.<span class="hljs-built_in">emplace_back</span>(key.<span class="hljs-built_in">data</span>(), key.<span class="hljs-built_in">length</span>());<br>            <span class="hljs-function">StringPiece <span class="hljs-title">key_copy</span><span class="hljs-params">(string_cache_.back())</span></span>;<br>            secondary_oat_dex_files_.<span class="hljs-built_in">PutBefore</span>(secondary_lb, key_copy, oat_dex_file);<br>        &#125;<br>    &#125;<br><span class="hljs-comment">//oat_dex_fileè·å–å¤±è´¥</span><br>    <span class="hljs-keyword">if</span> (oat_dex_file == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">if</span> (error_msg != <span class="hljs-literal">nullptr</span>) &#123;<br>            std::string dex_canonical_location = DexFile::<span class="hljs-built_in">GetDexCanonicalLocation</span>(dex_location);<br>            *error_msg = <span class="hljs-string">&quot;Failed to find OatDexFile for DexFile &quot;</span> + std::<span class="hljs-built_in">string</span>(dex_location)  + <span class="hljs-string">&quot; (canonical path &quot;</span> + dex_canonical_location + <span class="hljs-string">&quot;) in OatFile &quot;</span> + <span class="hljs-built_in">GetLocation</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><span class="hljs-comment">//éªŒè¯oat_dex_fileæ–‡ä»¶çš„æ ¡éªŒç </span><br>    <span class="hljs-keyword">if</span> (dex_location_checksum != <span class="hljs-literal">nullptr</span> &amp;&amp; oat_dex_file-&gt;<span class="hljs-built_in">GetDexFileLocationChecksum</span>() != *dex_location_checksum) &#123;<br>        <span class="hljs-keyword">if</span> (error_msg != <span class="hljs-literal">nullptr</span>) &#123;<br>            std::string dex_canonical_location = DexFile::<span class="hljs-built_in">GetDexCanonicalLocation</span>(dex_location);<br>            std::string checksum = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;0x%08x&quot;</span>, oat_dex_file-&gt;<span class="hljs-built_in">GetDexFileLocationChecksum</span>());<br>            std::string required_checksum = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;0x%08x&quot;</span>, *dex_location_checksum);<br>            *error_msg = <span class="hljs-string">&quot;OatDexFile for DexFile &quot;</span> + std::<span class="hljs-built_in">string</span>(dex_location) + <span class="hljs-string">&quot; (canonical path &quot;</span> + dex_canonical_location + <span class="hljs-string">&quot;) in OatFile &quot;</span> + <span class="hljs-built_in">GetLocation</span>() + <span class="hljs-string">&quot; has checksum &quot;</span> + checksum + <span class="hljs-string">&quot; but &quot;</span> + required_checksum + <span class="hljs-string">&quot; was required&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> oat_dex_file;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-2-OpenDexFile"><a href="#2-2-2-OpenDexFile" class="headerlink" title="2.2.2 OpenDexFile()"></a>2.2.2 OpenDexFile()</h3><p>ç„¶åæ˜¯<code>OpenDexFile()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::unique_ptr&lt;<span class="hljs-type">const</span> DexFile&gt; OatFile::OatDexFile::<span class="hljs-built_in">OpenDexFile</span>(std::string* error_msg) <span class="hljs-type">const</span> &#123;<br>    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(__PRETTY_FUNCTION__)</span></span>;<br>    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">bool</span> kVerify = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">bool</span> kVerifyChecksum = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> DexFile::<span class="hljs-built_in">Open</span>(dex_file_pointer_,<br>                         <span class="hljs-built_in">FileSize</span>(),<br>                         dex_file_location_,<br>                         dex_file_location_checksum_,<br>                         <span class="hljs-keyword">this</span>,<br>                         kVerify,<br>                         kVerifyChecksum,<br>                         error_msg);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨<code>DexFile::Open()</code>æ–¹æ³•å®ç°ã€‚</p><p>é€šè¿‡ä¸Šè¿°åˆ†æå¯çŸ¥ï¼Œåœ¨<code>OpenDexFilesFromOat()</code>ä¸­ï¼Œæ— è®ºæ˜¯è°ƒç”¨<code>LoadDexFiles()</code>æ–¹æ³•åŠ è½½dexæ–‡ä»¶ï¼Œè¿˜æ˜¯è°ƒç”¨<code>DexFile::Open()</code>åŠ è½½dexæ–‡ä»¶ï¼Œæœ€ç»ˆæ®Šé€”åŒå½’ï¼Œéƒ½è°ƒç”¨<code>DexFile::Open()</code>æ–¹æ³•ï¼Œåªä¸è¿‡å‚æ•°ä¸ªæ•°ä¸åŒã€‚</p><p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å°†æ²¿ç€<code>DexFile::Open()</code>æ–¹æ³•ç»§ç»­åˆ†ædexæ–‡ä»¶åŠ è½½æµç¨‹ã€‚</p><h1 id="ä¸‰ã€æ€»è§ˆå›¾"><a href="#ä¸‰ã€æ€»è§ˆå›¾" class="headerlink" title="ä¸‰ã€æ€»è§ˆå›¾"></a>ä¸‰ã€æ€»è§ˆå›¾</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202311202114264.png"></p><hr><p>å‚è€ƒï¼š</p><p>[<a href="https://bbs.kanxue.com/thread-257893.htm">åŸåˆ›]èœé¸Ÿå­¦8.1ç‰ˆæœ¬dexåŠ è½½æµç¨‹ç¬”è®°â€“ç¬¬ä¸€ç¯‡ï¼šoat_file_managerä¸oat_file_assistant-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p><a href="https://www.jianshu.com/p/b89d0b03e82c">å…¥é—¨ARTè™šæ‹Ÿæœº(2)â€”â€”åŠ è½½DEXæ–‡ä»¶ç»­ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="http://aospxref.com/android-8.0.0_r36/">http://aospxref.com/android-8.0.0_r36/</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidæºç è§£æ</tag>
      
      <tag>dex</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸€)</title>
    <link href="/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%80)/"/>
    <url>/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%80)/</url>
    
    <content type="html"><![CDATA[<blockquote><p>dexæ–‡ä»¶åŠ è½½ç³»åˆ—æ–‡ç« é“¾æ¥ï¼š</p><ol><li><p>PathClassLoaderã€DexClassLoader</p><p><a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%80)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸€)</a></p><p><a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%BA%8C)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(äºŒ)</a></p><p><a href="https://gal2xy.github.io/2023/11/20/dex%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B(%E4%B8%89)/">dexæ–‡ä»¶åŠ è½½æµç¨‹(ä¸‰)</a></p></li><li><p>InMemoryDexClassLoader</p><p><a href="https://gal2xy.github.io/2023/12/06/InMemoryDexClassLoader%E5%8A%A0%E8%BD%BD%E5%86%85%E5%AD%98dex%E7%9A%84%E6%B5%81%E7%A8%8B/">InMemoryDexClassLoaderåŠ è½½å†…å­˜dexçš„æµç¨‹</a></p></li></ol></blockquote><h1 id="ä¸€ã€PathClassLoaderå’ŒDexClassLoader"><a href="#ä¸€ã€PathClassLoaderå’ŒDexClassLoader" class="headerlink" title="ä¸€ã€PathClassLoaderå’ŒDexClassLoader"></a>ä¸€ã€PathClassLoaderå’ŒDexClassLoader</h1><p>Androidå¯åŠ¨APPæ—¶ï¼Œä¼šåŠ è½½dexæ–‡ä»¶ï¼Œè€Œä¸åŠ è½½dexæ–‡ä»¶ç›¸å…³çš„æ˜¯ä¸¤ä¸ªClassLoaderï¼š</p><ol><li><p>PathClassLoader</p><p>åªèƒ½åŠ è½½ç³»ç»Ÿä¸­å·²ç»å®‰è£…è¿‡çš„apk</p></li><li><p>DexClassLoader</p><p>å¯ä»¥åŠ è½½jarã€apkã€dexï¼Œä¹Ÿå¯ä»¥ä»SDå¡ä¸­åŠ è½½æœªå®‰è£…çš„apk</p></li></ol><p>PathClassLoaderå’ŒDexClassLoaderå¯¹åº”ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/PathClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PathClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PathClassLoader</span><span class="hljs-params">(String dexPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, parent);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PathClassLoader</span><span class="hljs-params">(String dexPath, String librarySearchPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-literal">null</span>, librarySearchPath, parent);<br>    &#125;<br>    <br>&#125;<br><br><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DexClassLoader</span><span class="hljs-params">(String dexPath, String optimizedDirectory,</span><br><span class="hljs-params">            String librarySearchPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(optimizedDirectory), librarySearchPath, parent);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸¤è€…çš„çˆ¶ç±»éƒ½æ˜¯BaseDexClassLoaderï¼Œä¸”éƒ½æ˜¯ç”¨çˆ¶ç±»çš„å››ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(String dexPath, File optimizedDirectory,</span><br><span class="hljs-params">                          String librarySearchPath, ClassLoader parent)</span> &#123;<br>    <span class="hljs-built_in">super</span>(parent);<br>    <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexPath, librarySearchPath, <span class="hljs-literal">null</span>);<br><br>    <span class="hljs-keyword">if</span> (reporter != <span class="hljs-literal">null</span>) &#123;<br>        reporter.report(<span class="hljs-built_in">this</span>.pathList.getDexPaths());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªDexPathListå®ä¾‹ã€‚</p><h1 id="äºŒã€DexPathList"><a href="#äºŒã€DexPathList" class="headerlink" title="äºŒã€DexPathList()"></a>äºŒã€DexPathList()</h1><p>DexPathListä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">DexPathList</span><span class="hljs-params">(ClassLoader definingContext, String dexPath, String librarySearchPath, File optimizedDirectory)</span> &#123;<br>    ......<br>    <span class="hljs-built_in">this</span>.definingContext = definingContext;<br><br>    ArrayList&lt;IOException&gt; suppressedExceptions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;IOException&gt;();<br>    <span class="hljs-comment">// save dexPath for BaseDexClassLoader</span><br>    <span class="hljs-built_in">this</span>.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,<br>                                       suppressedExceptions, definingContext);<span class="hljs-comment">//</span><br><br>    <span class="hljs-built_in">this</span>.nativeLibraryDirectories = splitPaths(librarySearchPath, <span class="hljs-literal">false</span>);<br>    <span class="hljs-built_in">this</span>.systemNativeLibraryDirectories = splitPaths(System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>), <span class="hljs-literal">true</span>);<br>    List&lt;File&gt; allNativeLibraryDirectories = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(nativeLibraryDirectories);<br>    allNativeLibraryDirectories.addAll(systemNativeLibraryDirectories);<br><br>    <span class="hljs-built_in">this</span>.nativeLibraryPathElements = makePathElements(allNativeLibraryDirectories);<span class="hljs-comment">//</span><br><br>    <span class="hljs-keyword">if</span> (suppressedExceptions.size() &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">this</span>.dexElementsSuppressedExceptions =<br>            suppressedExceptions.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>[suppressedExceptions.size()]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        dexElementsSuppressedExceptions = <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯è°ƒç”¨äº†<code>makeDexElements()</code>æ–¹æ³•ï¼ˆ<code>makePathElements()</code>å…ˆä¸è®²ï¼‰ï¼Œèµ‹å€¼ç»™<code>this.dexElements</code>ï¼Œè¯¥ç±»å‹ä¸ºElementæ•°ç»„ï¼ŒæŸ¥çœ‹Elementç±»çš„ä»£ç å¯çŸ¥ï¼Œç±»ä¸­æœ‰DexFileç±»å‹çš„dexFileå­—æ®µã€‚</p><h1 id="ä¸‰ã€makeDexElements"><a href="#ä¸‰ã€makeDexElements" class="headerlink" title="ä¸‰ã€makeDexElements()"></a>ä¸‰ã€makeDexElements()</h1><p>å›åˆ°<code>makeDexElements()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,<br>                                         List&lt;IOException&gt; suppressedExceptions, ClassLoader loader) &#123;<br>    Element[] elements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>[files.size()];<br>    <span class="hljs-type">int</span> <span class="hljs-variable">elementsPos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-comment">//éå†æ‰€æœ‰æ–‡ä»¶</span><br>    <span class="hljs-keyword">for</span> (File file : files) &#123;<br>        <span class="hljs-keyword">if</span> (file.isDirectory()) &#123;<span class="hljs-comment">//æ–‡ä»¶å¤¹</span><br>            elements[elementsPos++] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>(file);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.isFile()) &#123;<span class="hljs-comment">//æ–‡ä»¶</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> file.getName();<br><br>            <span class="hljs-keyword">if</span> (name.endsWith(DEX_SUFFIX)) &#123;<span class="hljs-comment">// åˆ¤æ–­æ–‡ä»¶åç¼€åï¼ŒDEX_SUFFIX = &quot;.dex&quot;</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//è°ƒç”¨loadDexFileåŠ è½½dexæ–‡ä»¶</span><br>                    <span class="hljs-type">DexFile</span> <span class="hljs-variable">dex</span> <span class="hljs-operator">=</span> loadDexFile(file, optimizedDirectory, loader, elements);<br>                    <span class="hljs-keyword">if</span> (dex != <span class="hljs-literal">null</span>) &#123;<br>                        elements[elementsPos++] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>(dex, <span class="hljs-literal">null</span>);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException suppressed) &#123;<br>                    System.logE(<span class="hljs-string">&quot;Unable to load dex file: &quot;</span> + file, suppressed);<br>                    suppressedExceptions.add(suppressed);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//zip file?</span><br>                <span class="hljs-type">DexFile</span> <span class="hljs-variable">dex</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    dex = loadDexFile(file, optimizedDirectory, loader, elements);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException suppressed) &#123;<span class="hljs-comment">//zipä¸­æ²¡æœ‰dexæ–‡ä»¶</span><br>                    suppressedExceptions.add(suppressed);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (dex == <span class="hljs-literal">null</span>) &#123;<br>                    elements[elementsPos++] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>(file);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    elements[elementsPos++] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>(dex, file);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            System.logW(<span class="hljs-string">&quot;ClassLoader referenced unknown path: &quot;</span> + file);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (elementsPos != elements.length) &#123;<br>        elements = Arrays.copyOf(elements, elementsPos);<br>    &#125;<br>    <span class="hljs-keyword">return</span> elements;<br>&#125;<br></code></pre></td></tr></table></figure><p>éå†æ‰€æœ‰æ–‡ä»¶ï¼Œå¯»æ‰¾dexæ–‡ä»¶å¹¶è°ƒç”¨<code>loadDexFile()</code>åŠ è½½dexæ–‡ä»¶ã€‚</p><h1 id="å››ã€loadDexFile"><a href="#å››ã€loadDexFile" class="headerlink" title="å››ã€loadDexFile()"></a>å››ã€loadDexFile()</h1><p>è¯¥æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DexFile <span class="hljs-title function_">loadDexFile</span><span class="hljs-params">(File file, File optimizedDirectory, ClassLoader loader,</span><br><span class="hljs-params">                                   Element[] elements)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">if</span> (optimizedDirectory == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexFile</span>(file, loader, elements);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">optimizedPath</span> <span class="hljs-operator">=</span> optimizedPathFor(file, optimizedDirectory);<br>        <span class="hljs-keyword">return</span> DexFile.loadDex(file.getPath(), optimizedPath, <span class="hljs-number">0</span>, loader, elements);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå†æ¬¡è®²è§£ä¸€ä¸‹dexæ–‡ä»¶ä¼˜åŒ–ã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºé¦–æ¬¡å¯åŠ¨ï¼Œä¼šå¯¹åº”ç”¨çš„dexæ–‡ä»¶è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶åœ¨<code>cache/dalvik-cache</code>ç›®å½•ä¸‹ç”Ÿæˆç¼“å­˜æ–‡ä»¶ï¼Œä»¥åŠ å¿«åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ã€‚ä»£ç ä¸­<code>optimizedDirectory</code>å³æŒ‡ç¼“å­˜æ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼Œé»˜è®¤<code>cache/dalvik-cache</code>ç›®å½•ã€‚</p><p>å›åˆ°ä»£ç ä¸­ï¼Œå¦‚æœAPPæ²¡æœ‰ç›¸åº”çš„ç¼“å­˜æ–‡ä»¶ï¼Œåˆ™é€šè¿‡è°ƒç”¨<code>DexFile()</code>æ¥è§£ædexæ–‡ä»¶ï¼Œå¦åˆ™è°ƒç”¨<code>DexFile.loadDex()</code>æ–¹æ³•è§£æç¼“å­˜æ–‡ä»¶ã€‚</p><h2 id="4-1-DexFile"><a href="#4-1-DexFile" class="headerlink" title="4.1 DexFile()"></a>4.1 DexFile()</h2><p>å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><br>DexFile(File file, ClassLoader loader, DexPathList.Element[] elements)<br>    <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-built_in">this</span>(file.getPath(), loader, elements);<br>&#125;<br><br><span class="hljs-comment">//è¿›è€Œè°ƒç”¨</span><br>DexFile(String fileName, ClassLoader loader, DexPathList.Element[] elements) <span class="hljs-keyword">throws</span> IOException &#123;<br>    mCookie = openDexFile(fileName, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, loader, elements);<br>    mInternalCookie = mCookie;<br>    mFileName = fileName;<br>    <span class="hljs-comment">//System.out.println(&quot;DEX FILE cookie is &quot; + mCookie + &quot; fileName=&quot; + fileName);</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨<code>openDexFile()</code>æ–¹æ³•ï¼Œç°åœ¨è¿™é‡Œåœä¸‹ã€‚</p><h2 id="4-2-DexFile-loadDex"><a href="#4-2-DexFile-loadDex" class="headerlink" title="4.2 DexFile.loadDex()"></a>4.2 DexFile.loadDex()</h2><p>å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><br><span class="hljs-keyword">static</span> DexFile <span class="hljs-title function_">loadDex</span><span class="hljs-params">(String sourcePathName, String outputPathName,</span><br><span class="hljs-params">                       <span class="hljs-type">int</span> flags, ClassLoader loader, DexPathList.Element[] elements)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexFile</span>(sourcePathName, outputPathName, flags, loader, elements);<br>&#125;<br><br><span class="hljs-comment">//è¿›è€Œè°ƒç”¨</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">DexFile</span><span class="hljs-params">(String sourceName, String outputName, <span class="hljs-type">int</span> flags, ClassLoader loader,</span><br><span class="hljs-params">                DexPathList.Element[] elements)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    ......<br>    mCookie = openDexFile(sourceName, outputName, flags, loader, elements);<br>    mInternalCookie = mCookie;<br>    mFileName = sourceName;<br>    <span class="hljs-comment">//System.out.println(&quot;DEX FILE cookie is &quot; + mCookie + &quot; sourceName=&quot; + sourceName + &quot; outputName=&quot; + outputName);</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡è°ƒç”¨çš„æ˜¯<code>new DexFile()</code>è¿˜æ˜¯<code>DexFile.loadDex() </code>ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨<code>openDexFile()</code>ã€‚</p><h1 id="äº”ã€openDexFile"><a href="#äº”ã€openDexFile" class="headerlink" title="äº”ã€openDexFile()"></a>äº”ã€openDexFile()</h1><p>å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/libcore/dalvik/src/main/java/dalvik/system/DexFile.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">openDexFile</span><span class="hljs-params">(String sourceName, String outputName, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">                                  ClassLoader loader, DexPathList.Element[] elements)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// Use absolute paths to enable the use of relative paths when testing on host.</span><br>    <span class="hljs-keyword">return</span> openDexFileNative(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(sourceName).getAbsolutePath(),<br>                             (outputName == <span class="hljs-literal">null</span>)<br>                             ? <span class="hljs-literal">null</span><br>                             : <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(outputName).getAbsolutePath(),<br>                             flags,<br>                             loader,<br>                             elements);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨<code>openDexFileNative()</code>æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ä¸ªnativeæ–¹æ³•ï¼Œåœ¨ç›®å½•<code>art/runtime/native/dalvik_system_DexFile.cc</code>ä¸‹ã€‚</p><p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œå°†ç»§ç»­æ²¿ç€<code>openDexFileNative()</code>æ–¹æ³•åˆ†ædexæ–‡ä»¶åŠ è½½æµç¨‹ã€‚</p><h1 id="å…­ã€æ€»è§ˆå›¾"><a href="#å…­ã€æ€»è§ˆå›¾" class="headerlink" title="å…­ã€æ€»è§ˆå›¾"></a>å…­ã€æ€»è§ˆå›¾</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202311202112869.png"></p><hr><p>å‚è€ƒï¼š</p><p><a href="https://www.jianshu.com/p/20dcfcf27004">å…¥é—¨ARTè™šæ‹Ÿæœº(1)â€”â€”åŠ è½½DEXæ–‡ä»¶ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://blog.csdn.net/weixin_42011443/article/details/106129466">Dexæ–‡ä»¶åŠ è½½ä»¥åŠç±»åŠ è½½æµç¨‹_ä¸¤ä¸ªdexé—´èƒ½å¼•ç”¨ç±»å—-CSDNåšå®¢</a></p><p><a href="http://aospxref.com/android-8.0.0_r36/">http://aospxref.com/android-8.0.0_r36/</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidæºç è§£æ</tag>
      
      <tag>dex</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidä¸­dex odex oat vdex artæ–‡ä»¶æ ¼å¼åŒºåˆ«</title>
    <link href="/2023/11/17/Android%E4%B8%ADdex%20odex%20oat%20vdex%20art%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%8C%BA%E5%88%AB/"/>
    <url>/2023/11/17/Android%E4%B8%ADdex%20odex%20oat%20vdex%20art%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h1 id="1-dex"><a href="#1-dex" class="headerlink" title="1. dex"></a>1. dex</h1><p>dexæ˜¯Androidå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚javaæ–‡ä»¶å…ˆç¼–è¯‘æˆclassæ–‡ä»¶ï¼ˆjavaå­—èŠ‚ç ï¼‰ï¼Œå†é€šè¿‡dxæˆ–d8å·¥å…·è½¬æ¢æˆdexæ–‡ä»¶ã€‚</p><p>classæ–‡ä»¶æ—¶javaè™šæ‹Ÿæœºçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸ä¹‹ç›¸å¯¹çš„ï¼Œdexæ–‡ä»¶æ˜¯Dalvikè™šæ‹Ÿæœºçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œdexæ–‡ä»¶ä¸­å­˜æ”¾çš„è‡ªç„¶å°±æ˜¯Dalvikå­—èŠ‚ç ã€‚</p><p>Androidåº”ç”¨å®‰è£…åŒ…ï¼Œå³apkæ–‡ä»¶ä¸­å°±å«æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªdexæ–‡ä»¶ï¼Œå‘½åå¦‚ä¸‹ï¼š</p><ul><li>classes.dex</li><li>classes1.dex</li><li>classes2.dex</li><li>â€¦â€¦</li></ul><h1 id="2-odex"><a href="#2-odex" class="headerlink" title="2. odex"></a>2. odex</h1><p>odexä¹Ÿæ˜¯Androidå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>åœ¨Android 5ä¹‹å‰ï¼ˆä¹Ÿè®¸ï¼‰ï¼Œä¸ºäº†åŠ å¿«åº”ç”¨çš„è¿è¡Œé€Ÿåº¦ï¼Œå¯¹apkä¸­çš„dexæ–‡ä»¶è¿›è¡Œä¼˜åŒ–ï¼ˆä¼˜åŒ–å·¥å…·ï¼šdexopt-wrapperï¼‰ï¼Œç”Ÿæˆodexæ–‡ä»¶ï¼Œä¿å­˜åœ¨data&#x2F;dalvik-cacheç›®å½•ä¸‹æˆ–ä¸apkåŒç›®å½•ä¸‹ï¼Œå¹¶åˆ é™¤apkä¸­çš„dexæ–‡ä»¶ã€‚ä¹‹åè¿è¡Œç¨‹åºæ—¶ï¼Œç›´æ¥åŠ è½½odexæ–‡ä»¶ï¼Œé¿å…é‡å¤éªŒè¯å’Œä¼˜åŒ–ã€‚</p><p>ä¸è¿‡åœ¨Android 5ä¹‹åï¼Œ.odexå°±ä¸å†æ˜¯odexæ–‡ä»¶äº†ï¼Œè€Œæ˜¯oatæ–‡ä»¶ï¼Œç”¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨æ‰“å¼€ï¼Œå¯ä»¥å‘ç°æ–‡ä»¶å¤´æ˜¯â€ELFâ€ï¼Œå³ELFæ–‡ä»¶æ ¼å¼ã€‚</p><h1 id="3-oat"><a href="#3-oat" class="headerlink" title="3. oat"></a>3. oat</h1><p>oatä¹Ÿæ˜¯Androidå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ˜¯ä¸€ç§elfæ–‡ä»¶æ ¼å¼ã€‚</p><p>åœ¨Android 5ä¹‹åï¼Œåœ¨å®‰è£…apkçš„è¿‡ç¨‹ä¸­ï¼ŒAndroidç³»ç»Ÿä¼šå¯¹åº”ç”¨ç¨‹åºè¿›è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨dex2oatå·¥å…·ç”Ÿæˆoatæ–‡ä»¶ã€‚å®ƒä¸ä»…åŒ…å«dexæ–‡ä»¶çš„å†…å®¹ï¼Œä¹Ÿå°†ä¸€äº›DalvikæŒ‡ä»¤ç¼–è¯‘æˆäº†æœ¬åœ°æœºå™¨æŒ‡ä»¤ã€‚</p><p>oatæ–‡ä»¶ç»“æ„ä¼šéšAndroidç‰ˆæœ¬å˜åŒ–ï¼Œä¸”æ²¡æœ‰å‘åå…¼å®¹æ€§ã€‚oatæ–‡ä»¶ç»“æ„å¯è§<a href="http://romainthomas.fr/oat/%E3%80%82">http://romainthomas.fr/oat/ã€‚</a></p><h1 id="4-vdex"><a href="#4-vdex" class="headerlink" title="4. vdex"></a>4. vdex</h1><p>vdexæ–‡ä»¶ä¸æ˜¯Androidå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>åœ¨Android 8ä¹‹ååŠ å…¥çš„ï¼Œvdexæ–‡ä»¶åŒ…å«apkçš„æœªå‹ç¼©dexä»£ç ï¼Œä»¥åŠä¸€äº›æ—¨åœ¨åŠ å¿«éªŒè¯é€Ÿåº¦çš„å…ƒæ•°æ®ï¼Œå…¶ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†è·³è¿‡verifiedæµç¨‹ï¼Œå‡å°‘dex2oatæ‰§è¡Œæ—¶é—´ã€‚</p><p>åŒoatæ–‡ä»¶ä¸€æ ·ï¼Œvdexæ–‡ä»¶ç»“æ„ä¹Ÿä¼šéšAndroidç‰ˆæœ¬å˜åŒ–ï¼Œä¸”æ²¡æœ‰å‘åå…¼å®¹æ€§ã€‚vdexæ–‡ä»¶ç»“æ„å¯è§<a href="https://romainthomas.fr/vdex/%E3%80%82">https://romainthomas.fr/vdex/ã€‚</a></p><h1 id="5-art"><a href="#5-art" class="headerlink" title="5. art"></a>5. art</h1><p>oatä¹Ÿæ˜¯Androidå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ˜¯ä¸€ç§elfæ–‡ä»¶æ ¼å¼ã€‚</p><p>å€ŸåŠ©odexæ–‡ä»¶è¿›è¡Œä¼˜åŒ–ç”Ÿæˆçš„ï¼Œè®°å½•åº”ç”¨å¯åŠ¨çš„çƒ­ç‚¹å‡½æ•°ç›¸å…³åœ°å€ï¼Œæ–¹ä¾¿å¯»å€ã€‚</p><p>åŒoatæ–‡ä»¶ä¸€æ ·ï¼Œartæ–‡ä»¶ç»“æ„ä¹Ÿä¼šéšAndroidç‰ˆæœ¬å˜åŒ–ï¼Œä¸”æ²¡æœ‰å‘åå…¼å®¹æ€§ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://lief-project.github.io/doc/latest/tutorials/10_android_formats.html">https://lief-project.github.io/doc/latest/tutorials/10_android_formats.html</a></p><p><a href="https://www.wuyifei.cc/dex-vdex-odex-art/">https://www.wuyifei.cc/dex-vdex-odex-art/</a></p><p><a href="https://www.eefocus.com/article/525061.html">https://www.eefocus.com/article/525061.html</a></p><p><a href="https://source.android.com/docs/core/runtime/configure?hl=zh-cn">https://source.android.com/docs/core/runtime/configure?hl=zh-cn</a></p><p><a href="https://medium.com/@_sushil/oat2dex-android-pentesting-6f99e9c57198">https://medium.com/@_sushil/oat2dex-android-pentesting-6f99e9c57198</a></p><p><a href="https://newandroidbook.com/files/ArtOfDalvik.pdf">https://newandroidbook.com/files/ArtOfDalvik.pdf</a></p><p><a href="https://newandroidbook.com/files/%EF%BC%88%E9%87%8C%E9%9D%A2%E6%9C%89%E5%BE%88%E5%A4%9A%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%E7%9A%84pdf%EF%BC%89">https://newandroidbook.com/files/ï¼ˆé‡Œé¢æœ‰å¾ˆå¤šå¯ä»¥å‚è€ƒçš„pdfï¼‰</a></p><p><a href="http://romainthomas.fr/oat/">http://romainthomas.fr/oat/</a></p><p><a href="https://romainthomas.fr/vdex/">https://romainthomas.fr/vdex/</a></p><p><a href="https://www.blackhat.com/docs/asia-15/materials/asia-15-Sabanal-Hiding-Behind-ART-wp.pdf">https://www.blackhat.com/docs/asia-15/materials/asia-15-Sabanal-Hiding-Behind-ART-wp.pdf</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ODEXæ–‡ä»¶æ ¼å¼è§£æ</title>
    <link href="/2023/11/17/ODEX%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/11/17/ODEX%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯odexæ–‡ä»¶"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯odexæ–‡ä»¶" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯odexæ–‡ä»¶"></a>ä¸€ã€ä»€ä¹ˆæ˜¯odexæ–‡ä»¶</h1><h2 id="1-1-å®šä¹‰"><a href="#1-1-å®šä¹‰" class="headerlink" title="1.1 å®šä¹‰"></a>1.1 å®šä¹‰</h2><p>odexæ–‡ä»¶æ˜¯Androidä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚odexæ–‡ä»¶æ˜¯ç”±apkä¸­çš„dexæ–‡ä»¶ä¼˜åŒ–ç”Ÿæˆçš„ï¼Œå­˜æ”¾åœ¨cache&#x2F;dalvik-cacheç›®å½•ä¸‹æˆ–è€…ä¸apkåŒä¸€ç›®å½•ä¸‹ï¼Œæœ€ååˆ é™¤apkæ–‡ä»¶ä¸­çš„classes.dexæ–‡ä»¶ã€‚</p><blockquote><p>æ³¨æ„ï¼ï¼ï¼ä¸è¦è¢«æ–‡ä»¶åç¼€åéª—äº†ï¼ <code>.dex</code>åç¼€çš„æ–‡ä»¶å¯ä»¥æ˜¯DEXæ–‡ä»¶æˆ–è€…OATæ–‡ä»¶ï¼Œ<code>.odex</code>ä¸å†æ˜¯ODEXæ–‡ä»¶ï¼ˆåº”è¯¥æ˜¯Android 5ä¹‹åï¼‰ï¼Œè€Œæ˜¯OATæ–‡ä»¶ï¼Œ<code>.oat</code>æ˜¯OATæ–‡ä»¶</p></blockquote><h2 id="1-2-ä¼˜åŠ¿"><a href="#1-2-ä¼˜åŠ¿" class="headerlink" title="1.2 ä¼˜åŠ¿"></a>1.2 ä¼˜åŠ¿</h2><ol><li>åŠ å¿«åº”ç”¨çš„è¿è¡Œé€Ÿåº¦ï¼Œå› ä¸ºæœ‰äº†odexæ–‡ä»¶åŒ…å«äº†åŠ è½½æ‰€éœ€è¦çš„ä¾èµ–åº“æ–‡ä»¶åˆ—è¡¨ï¼ŒDVMåªéœ€è¦æ£€æµ‹å¹¶åŠ è½½æ‰€éœ€ä¾èµ–åº“å³å¯æ‰§è¡Œodexæ–‡ä»¶ï¼Œå¤§å¤§ç¼©çŸ­äº†è¯»å–dexæ–‡ä»¶æ‰€éœ€çš„æ—¶é—´ã€‚</li><li>å‡å°‘ç©ºé—´å ç”¨ã€‚å› ä¸ºå¦‚æœæ²¡æœ‰odexï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æå–dexï¼Œè¿™æ—¶ä¸ä»…apkå†…æœ‰dexï¼Œ&#x2F;data&#x2F;dalvik-cacheç›®å½•ä¸‹ä¹Ÿæœ‰dexã€‚</li><li>åç¼–è¯‘APKæ–‡ä»¶ï¼Œåªèƒ½æ‹¿åˆ°èµ„æºæ–‡ä»¶ï¼Œèµ·åˆ°äº†ä¸€å®šçš„ä¿æŠ¤ä½œç”¨ã€‚</li></ol><h1 id="äºŒã€odexæ–‡ä»¶ç»“æ„"><a href="#äºŒã€odexæ–‡ä»¶ç»“æ„" class="headerlink" title="äºŒã€odexæ–‡ä»¶ç»“æ„"></a>äºŒã€odexæ–‡ä»¶ç»“æ„</h1><h2 id="2-1-æ•´ä½“ç»“æ„"><a href="#2-1-æ•´ä½“ç»“æ„" class="headerlink" title="2.1 æ•´ä½“ç»“æ„"></a>2.1 æ•´ä½“ç»“æ„</h2><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/aaa.png"></p><p>odexæ–‡ä»¶åœ¨dexæ–‡ä»¶å¤´éƒ¨æ·»åŠ äº†ä¸€ä¸ªodexæ–‡ä»¶å¤´ï¼Œç„¶ååœ¨dexæœ«å°¾æ·»åŠ äº†dexæ–‡ä»¶çš„ä¾èµ–åº“ä»¥åŠä¸€äº›è¾…åŠ©æ•°æ®ã€‚</p><p>ç”±äºodexæ–‡ä»¶åœ¨Androidæºç ä¸­å¹¶æ²¡æœ‰å®šä¹‰å¾ˆå¤šæ•°æ®ç»“æ„ï¼Œä»…æœ‰å¯¥å¯¥å‡ ä¸ªï¼Œæ‰€ä»¥åœ¨æœ¬æ–‡ä¸­ä¼šè‡ªå®šä¹‰ä¸€äº›æ•°æ®ç»“æ„ï¼Œæ–¹ä¾¿ç†è§£çŸ¥è¯†ç‚¹ã€‚</p><p>åœ¨è§£ædexæ–‡ä»¶ä¸­ï¼Œæ•´ä¸ªæ–‡ä»¶ç»“æ„åœ¨æºç ä¸­çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexFile</span> &#123;<br>    <span class="hljs-comment">/* directly-mapped &quot;opt&quot; header */</span><br>    <span class="hljs-type">const</span> DexOptHeader* pOptHeader;<br><br>    <span class="hljs-comment">/* pointers to directly-mapped structs and arrays in base DEX */</span><br>    <span class="hljs-type">const</span> DexHeader*    pHeader;<br>    <span class="hljs-type">const</span> DexStringId*  pStringIds;<br>    <span class="hljs-type">const</span> DexTypeId*    pTypeIds;<br>    <span class="hljs-type">const</span> DexFieldId*   pFieldIds;<br>    <span class="hljs-type">const</span> DexMethodId*  pMethodIds;<br>    <span class="hljs-type">const</span> DexProtoId*   pProtoIds;<br>    <span class="hljs-type">const</span> DexClassDef*  pClassDefs;<br>    <span class="hljs-type">const</span> DexLink*      pLinkData;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * These are mapped out of the &quot;auxillary&quot; section, and may not be</span><br><span class="hljs-comment">     * included in the file.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">const</span> DexClassLookup* pClassLookup;<br>    <span class="hljs-type">const</span> <span class="hljs-type">void</span>*         pRegisterMapPool;       <span class="hljs-comment">// RegisterMapClassPool</span><br><br>    <span class="hljs-comment">/* points to start of DEX file data */</span><br>    <span class="hljs-type">const</span> u1*           baseAddr;<br><br>    <span class="hljs-comment">/* track memory overhead for auxillary structures */</span><br>    <span class="hljs-type">int</span>                 overhead;<br><br>    <span class="hljs-comment">/* additional app-specific data structures associated with the DEX */</span><br>    <span class="hljs-comment">//void*               auxData;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ˜¯çš„ï¼Œåœ¨è§£ædexæ–‡ä»¶æ—¶ï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯æ²¡æœ‰æåŠåˆ°çš„ã€‚å…¶ä¸­DexOptHeaderå°±æ˜¯odexå¤´ï¼ŒDexLinkä»¥ä¸‹çš„éƒ¨åˆ†è¢«ç§°ä¸ºauxillary sectionï¼Œå³è¾…åŠ©æ•°æ®æ®µï¼Œå®ƒè®°å½•äº†dexæ–‡ä»¶è¢«ä¼˜åŒ–åæ·»åŠ çš„ä¸€äº›ä¿¡æ¯ã€‚</p><h2 id="2-2-odexæ–‡ä»¶å¤´"><a href="#2-2-odexæ–‡ä»¶å¤´" class="headerlink" title="2.2 odexæ–‡ä»¶å¤´"></a>2.2 odexæ–‡ä»¶å¤´</h2><p>odexæ–‡ä»¶å¤´çš„æ•°æ®ç»“æ„å®šä¹‰åœ¨æºç ç›®å½•&#x2F;dalvik&#x2F;libdex&#x2F;DexFile.hä¸­ï¼Œå¯¹åº”DexOptHeaderç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexOptHeader</span> &#123;<br>    u1  magic[<span class="hljs-number">8</span>];           <span class="hljs-comment">/* odexæ ‡è¯†(dey)+ç‰ˆæœ¬å· */</span><br><br>    u4  dexOffset;          <span class="hljs-comment">/* dexæ–‡ä»¶å¤´çš„æ–‡ä»¶åç§»é‡ */</span><br>    u4  dexLength;<span class="hljs-comment">/* dexæ–‡ä»¶çš„æ€»é•¿åº¦ */</span><br>    u4  depsOffset;         <span class="hljs-comment">/* odexä¾èµ–åº“åˆ—è¡¨çš„æ–‡ä»¶åç§»é‡ */</span><br>    u4  depsLength;<span class="hljs-comment">/* ä¾èµ–åº“åˆ—è¡¨çš„æ€»é•¿åº¦ */</span><br>    u4  optOffset;          <span class="hljs-comment">/* odexè¾…åŠ©æ•°æ®çš„æ–‡ä»¶åç§»é‡ */</span><br>    u4  optLength;<span class="hljs-comment">/* è¾…åŠ©æ•°æ®çš„æ€»é•¿åº¦ */</span><br><br>    u4  flags;              <span class="hljs-comment">/* æ ‡è¯†DVMåŠ è½½odexæ—¶çš„ä¼˜åŒ–ä¸éªŒè¯é€‰é¡¹ */</span><br>    u4  checksum;           <span class="hljs-comment">/* ä¾èµ–åº“ä¸è¾…åŠ©æ•°æ®çš„æ ¡éªŒå’Œ(ç®—æ³•adler32) */</span><br><br>    <span class="hljs-comment">/* pad for 64-bit alignment if necessary */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>odexæ ‡è¯†å…·ä½“å€¼ä¸ºdeyï¼</p><h2 id="2-3-dexæ–‡ä»¶"><a href="#2-3-dexæ–‡ä»¶" class="headerlink" title="2.3 dexæ–‡ä»¶"></a>2.3 dexæ–‡ä»¶</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²è¿‡ï¼Œè¯¦è§<a href="https://gal2xy.github.io/2023/11/10/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/">dexæ–‡ä»¶æ ¼å¼è§£æ - gla2xyâ€™s blog (gal2xy.github.io)</a>ã€‚</p><p>ç„¶è€Œï¼Œåœ¨ä¼˜åŒ–æˆodexçš„è¿‡ç¨‹ä¸­ï¼Œè¯¥éƒ¨åˆ†æœ‰äº›å†…å®¹ä¼šè¢«ä¿®æ”¹ã€‚</p><h2 id="2-4-ä¾èµ–åº“"><a href="#2-4-ä¾èµ–åº“" class="headerlink" title="2.4 ä¾èµ–åº“"></a>2.4 ä¾èµ–åº“</h2><p>ä¾èµ–åº“å¯¹åº”çš„æ•°æ®ç»“æ„åœ¨Androidæºç ä¸­æ²¡æœ‰æ˜ç¡®å®šä¹‰ï¼Œå€ŸåŠ©ã€ŠAndroidè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹ä¸­çš„å®šä¹‰ï¼š</p><blockquote><p>åœ¨Androidæºç ä¸­æ²¡æœ‰å®šä¹‰çš„ç»“æ„ä½“ï¼Œå‡æ¥è‡ªã€ŠAndroidè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Dependences</span>&#123;<br>    u4 modWhen;<span class="hljs-comment">/* ä¼˜åŒ–å‰dexæ–‡ä»¶çš„æ—¶é—´æˆ³ */</span><br>    u4 crc;<span class="hljs-comment">/* ä¼˜åŒ–å‰dexæ–‡ä»¶çš„crcæ ¡éªŒå€¼ */</span><br>    u4 DALVIK_VM_BUILD;<span class="hljs-comment">/* Dalvikè™šæ‹Ÿæœºç‰ˆæœ¬å· */</span><br>    u4 numDeps;<span class="hljs-comment">/* ä¾èµ–åº“ä¸ªæ•° */</span><br>    <span class="hljs-keyword">struct</span>&#123;<span class="hljs-comment">/* ä¾èµ–åº“ç»“æ„ä½“ */</span><br>        u4 len;<span class="hljs-comment">/* nameå­—ç¬¦ä¸²çš„é•¿åº¦ */</span><br>        u1 name[len];<span class="hljs-comment">/* ä¾èµ–åº“çš„å®Œæ•´è·¯å¾„å */</span><br>        u1 signature[kSHA1DigestLen];<span class="hljs-comment">/* sha-1å“ˆå¸Œå€¼ */</span><br>    &#125;tabel[numDeps];<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¾èµ–åº“ç»“æ„çš„å…·ä½“æ“ä½œå‡½æ•°åœ¨Android 2.x~4.xç‰ˆæœ¬çš„æºç æ‰æœ‰ï¼ˆåº”è¯¥ï¼Œåæ­£5åŠä»¥ä¸Šæ²¡è§è¿‡ï¼‰ï¼Œç›®å½•ä¸ºdalvik\vm\analysis\DexPrepare.cppï¼Œè¿™é‡Œæ‰‹æ‰“ä¸€ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">writeDependencies</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, u4 modWhen, u4 crc)</span></span>&#123;<br>    ......<br>    buf = (u1*)<span class="hljs-built_in">malloc</span>(bufLen);<span class="hljs-comment">//åˆ†é…ä¾èµ–åº“çš„ç©ºé—´</span><br>    <span class="hljs-built_in">set4LE</span>(buf + <span class="hljs-number">0</span>, modWhen);<span class="hljs-comment">//å†™å…¥crcæ ¡éªŒ</span><br>    <span class="hljs-built_in">set4LE</span>(buf + <span class="hljs-number">4</span>, crc);<span class="hljs-comment">//å†™å…¥crcæ£€éªŒ</span><br>    <span class="hljs-built_in">set4LE</span>(buf + <span class="hljs-number">8</span>, DALVIK_VM_BUILD);<span class="hljs-comment">//å†™å…¥Dalvikè™šæ‹Ÿæœºç‰ˆæœ¬å· </span><br>    <span class="hljs-built_in">set4LE</span>(buf + <span class="hljs-number">12</span>, numDeps);<span class="hljs-comment">//å†™å…¥ä¾èµ–åº“ä¸ªæ•°</span><br>    ......<br>u1* ptr = buf + <span class="hljs-number">16</span>;<span class="hljs-comment">//è·³è¿‡å‰å››ä¸ªå­—æ®µ</span><br>    <span class="hljs-keyword">for</span>(cpe = gDvm.bootClassPath; cpe-&gt;ptr != <span class="hljs-literal">NULL</span>; cpe++)&#123;<span class="hljs-comment">//å¾ªç¯å†™å…¥ä¾èµ–åº“</span><br>        ......<br>        <span class="hljs-type">const</span> u1* signature = <span class="hljs-built_in">getSignature</span>(cpe);<span class="hljs-comment">//è®¡ç®—SHA-1å“ˆå¸Œå€¼</span><br>        <span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(cacheFileName) + <span class="hljs-number">1</span>;<span class="hljs-comment">//&#x27;\0&#x27;å ä¸€å­—èŠ‚</span><br>        ......<br>        <span class="hljs-built_in">set4LE</span>(ptr, len);<br>        ptr += <span class="hljs-number">4</span>;<br>        <span class="hljs-built_in">memcpy</span>(ptr, cacheFileName, len); <span class="hljs-comment">//å†™å…¥ä¾èµ–åº“æ–‡ä»¶å</span><br>        ptr += len;<br>        <span class="hljs-built_in">memcpy</span>(ptr, signature, KSHA1DigestLen); <span class="hljs-comment">//å†™å…¥SHA-1å“ˆå¸Œå€¼</span><br>        ptr += KSHA1DigestLen;<br>        ......<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-5-è¾…åŠ©æ•°æ®"><a href="#2-5-è¾…åŠ©æ•°æ®" class="headerlink" title="2.5 è¾…åŠ©æ•°æ®"></a>2.5 è¾…åŠ©æ•°æ®</h2><p>è¯¥éƒ¨åˆ†æœ‰ä¸‰ä¸ªChunkå—ï¼Œå®ƒä»¬è¢«Dalvikè™šæ‹ŸæœºåŠ è½½åˆ°ä¸€ä¸ªç§°ä¸ºauxillartçš„æ®µä¸­ã€‚<strong>è¿™ä¸‰ä¸ªChunkå—ï¼Œéƒ½ä»¥ä¸€ä¸ªheaderè”åˆä½“å¼€å¤´</strong>ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">union</span>&#123;<br>    <span class="hljs-type">char</span> raw[<span class="hljs-number">8</span>];<br>    <span class="hljs-keyword">struct</span>&#123;<br>        u4 type;<br>        u4 size;<br>    &#125;ts;<br>&#125;header;<br></code></pre></td></tr></table></figure><p>unionæ˜¯è”åˆä½“ï¼Œé‡Œé¢çš„å˜é‡å…±ç”¨åŒä¸€ç©ºé—´ï¼Œæ‰€ä»¥å¤§å°ä¸º8å­—èŠ‚ã€‚å…¶ä¸­typeå­—æ®µä¸ºæšä¸¾å¸¸é‡ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++">eum&#123;<br>    kDexChunkClassLookup = <span class="hljs-number">0x434c4b50</span>,<span class="hljs-comment">/* å¯¹åº”å­—ç¬¦ä¸²CLKP */</span><br>    kDexChunkRegisterMaps = <span class="hljs-number">0x524d4150</span>,<span class="hljs-comment">/* å¯¹åº”å­—ç¬¦ä¸²RMAP */</span><br>    kDexChunkEnd = <span class="hljs-number">0x41454e44</span>,<span class="hljs-comment">/* å¯¹åº”å­—ç¬¦ä¸²AEND */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>sizeå­—æ®µè¡¨ç¤ºéœ€è¦å¡«å……çš„æ•°æ®çš„å­—èŠ‚æ•°ã€‚</p><p>åœ¨è¿™ä¸‰ä¸ªChunkå—ä¸­ï¼Œé¦–å…ˆæ˜¯ChunkClassLookupç»“æ„ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChunkClassLookup</span>&#123;<br>    <br>    headerè”åˆä½“;<br>    <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexClassLookup</span>&#123;<br>        <span class="hljs-type">int</span> size;<span class="hljs-comment">/* DexClassLookupç»“æ„ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼ŒåŒ…æ‹¬sizeå­—æ®µåœ¨å†… */</span><br>        <span class="hljs-type">int</span> numEntries;<span class="hljs-comment">/* æ¥ä¸‹æ¥çš„tabelç»“æ„çš„ä¸ªæ•° */</span><br>        <span class="hljs-keyword">struct</span> &#123;<span class="hljs-comment">/* æè¿°ç±»çš„ä¿¡æ¯çš„ç»“æ„ä½“ */</span><br>            u4 classDescriptorHash;<span class="hljs-comment">/* ç±»çš„å“ˆå¸Œå€¼ */</span><br>            <span class="hljs-type">int</span> classDescriptorOffset;<span class="hljs-comment">/* ç±»çš„æè¿°ï¼Œå€¼ä¸ºæ–‡ä»¶åç§»é‡ */</span><br>            <span class="hljs-type">int</span> classDefOffset;<span class="hljs-comment">/* æŒ‡å‘DexClassDefç»“æ„ï¼Œå€¼ä¸ºæ–‡ä»¶åç§»é‡ */</span><br>        &#125; table[<span class="hljs-number">1</span>];<br>    &#125;;<br>&#125;;<br><br></code></pre></td></tr></table></figure><p>Dalvikè™šæ‹Ÿæœºé€šè¿‡DexClassLookupç»“æ„æ¥æ£€ç´¢dexæ–‡ä»¶ä¸­æ‰€æœ‰çš„ç±»ã€‚</p><p>ç„¶åæ˜¯ChunkRegisterMapPoolç»“æ„ä½“ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChunkRegisterMapPool</span> &#123;<br><br>    headerè”åˆä½“;<br><br><span class="hljs-keyword">struct</span>&#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RegisterMapClassPool</span>&#123;<br>            u4 numClasses;<span class="hljs-comment">/* ç±»çš„ä¸ªæ•° */</span><br>            u4 classDataOffset[<span class="hljs-number">1</span>];<span class="hljs-comment">/* æŒ‡å‘ç±»çš„æ˜ å°„ä¿¡æ¯çš„åç§»é‡ */</span><br>        &#125;classpool;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RegisterMapMethodPool</span>&#123;<br>            u2 methodCount;<span class="hljs-comment">/* æ–¹æ³•çš„ä¸ªæ•° */</span><br>            u4 methodData[<span class="hljs-number">1</span>];<span class="hljs-comment">/* æ–¹æ³•çš„æ˜ å°„ä¿¡æ¯ï¼ˆè¿ç»­å­˜å‚¨ï¼‰ */</span><br>        &#125;;<br>&#125;MapPool;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­methodDataå¯¹åº”RegisterMapç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RegisterMap</span> &#123;<br>    u1      format;<br>    u1      regWidth;<br>    u1      numEntries[<span class="hljs-number">2</span>];<br>    u1      data[<span class="hljs-number">1</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>formatå­—æ®µç”¨æ¥æŒ‡æ˜éœ€è¦ç”¨å¤šå°‘å­—èŠ‚æ¥è¡¨ç¤ºæ–¹æ³•å†…çš„æŒ‡ä»¤åœ°å€ã€‚</p><p>regWidthå­—æ®µç”¨æ¥æŒ‡æ˜éœ€è¦ç”¨å¤šå°‘å­—èŠ‚æ¥è¡¨ç¤ºæ–¹æ³•å†…å„ä¸ªå¯„å­˜å™¨çš„çŠ¶æ€ã€‚</p><p>numEntrieså­—æ®µç”¨æ¥æŒ‡æ˜ä¿å­˜äº†å¤šå°‘æ¡å¯„å­˜å™¨çŠ¶æ€çš„è®°å½•ã€‚</p><p>dataå­—æ®µç”¨æ¥æŒ‡å‘ä¿å­˜å®é™…æ•°æ®çš„åœ°æ–¹ã€‚</p><p>æœ€åæ˜¯ChunkEndç»“æ„ä½“ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span>&#123;<br>    headerè”åˆä½“;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="2-6-æ•´ä¸ªodexæ–‡ä»¶ç»“æ„æ€»è§ˆå›¾"><a href="#2-6-æ•´ä¸ªodexæ–‡ä»¶ç»“æ„æ€»è§ˆå›¾" class="headerlink" title="2.6 æ•´ä¸ªodexæ–‡ä»¶ç»“æ„æ€»è§ˆå›¾"></a>2.6 æ•´ä¸ªodexæ–‡ä»¶ç»“æ„æ€»è§ˆå›¾</h2><p>å‚è€ƒå…¶ä»–äººçš„å›¾ï¼Œå¹¶æ ¹æ®è‡ªå·±çš„ç†è§£ç”»äº†ä¸ªæ€»è§ˆå›¾ï¼Œå…¶ä¸­æœ‰è¯¯çš„åœ°æ–¹çƒ¦è¯·å‘ŠçŸ¥ï¼æ„Ÿè°¢ï¼</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/odex.drawio.png"></p><hr><p>å‚è€ƒï¼š</p><p><a href="https://lief-project.github.io/doc/latest/tutorials/10_android_formats.html">https://lief-project.github.io/doc/latest/tutorials/10_android_formats.html</a></p><p><a href="https://newandroidbook.com/files/ArtOfDalvik.pdf">https://newandroidbook.com/files/ArtOfDalvik.pdf</a></p><p><a href="https://blog.csdn.net/roland_sun/article/details/47183119">Androidç³»ç»ŸODEXæ–‡ä»¶æ ¼å¼è§£æ-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/roland_sun/article/details/46832341">Dalvikè™šæ‹Ÿæœºä¸­RegisterMapç»“æ„è§£æ-CSDNåšå®¢</a></p><p><a href="https://baike.baidu.com/item/ODEX">https://baike.baidu.com/item/ODEX</a></p><p><a href="https://www.wuyifei.cc/dex-vdex-odex-art/">https://www.wuyifei.cc/dex-vdex-odex-art/</a></p><p>ã€ŠAndroidè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>odex</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dexæ–‡ä»¶æ ¼å¼è§£æ</title>
    <link href="/2023/11/10/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/11/10/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€dexæ–‡ä»¶ä¸­çš„æ•°æ®ç»“æ„"><a href="#ä¸€ã€dexæ–‡ä»¶ä¸­çš„æ•°æ®ç»“æ„" class="headerlink" title="ä¸€ã€dexæ–‡ä»¶ä¸­çš„æ•°æ®ç»“æ„"></a>ä¸€ã€dexæ–‡ä»¶ä¸­çš„æ•°æ®ç»“æ„</h1><h2 id="1-1-æ•°æ®ç±»å‹"><a href="#1-1-æ•°æ®ç±»å‹" class="headerlink" title="1.1 æ•°æ®ç±»å‹"></a>1.1 æ•°æ®ç±»å‹</h2><table><thead><tr><th align="center">ç±»å‹</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">u1</td><td align="center">è¡¨ç¤º1byteçš„æ— ç¬¦å·æ•°</td></tr><tr><td align="center">u2</td><td align="center">è¡¨ç¤º2bytesçš„æ— ç¬¦å·æ•°</td></tr><tr><td align="center">u4</td><td align="center">è¡¨ç¤º4bytesçš„æ— ç¬¦å·æ•°</td></tr><tr><td align="center">u8</td><td align="center">è¡¨ç¤º8bytesçš„æ— ç¬¦å·æ•°</td></tr><tr><td align="center">sleb128</td><td align="center">æœ‰ç¬¦å·LEB128ï¼Œå¯å˜é•¿åº¦ä¸º1~5bytes</td></tr><tr><td align="center">uleb128</td><td align="center">æ— ç¬¦å·LEB128ï¼Œå¯å˜é•¿åº¦ä¸º1~5bytes</td></tr><tr><td align="center">uleb128p1</td><td align="center">&#x3D;æ— ç¬¦å·LEB128å€¼ + 1ï¼Œå¯å˜é•¿åº¦ä¸º1~5bytes</td></tr></tbody></table><p>å‰ç¼€uè¡¨ç¤ºæ— ç¬¦å·ï¼Œsè¡¨ç¤ºæœ‰ç¬¦å·ã€‚<strong>LEB128æ˜¯ä¸€ç§å˜é•¿ç¼–ç æ ¼å¼ï¼Œæ¯ä¸ªLEB128ç”±1~5ä¸ªå­—èŠ‚ç»„æˆï¼Œæ‰€æœ‰çš„å­—èŠ‚ç»„åˆåœ¨ä¸€èµ·è¡¨ç¤ºä¸€ä¸ª32ä½çš„æ•°æ®ã€‚æ¯ä¸ªå­—èŠ‚åªæœ‰7bitæœ‰æ•ˆä½ï¼Œæœ€é«˜ä½bitè¡¨ç¤ºåä¸€ä¸ªå­—èŠ‚æ˜¯å¦éœ€è¦ï¼ˆ1è¡¨ç¤ºéœ€è¦ï¼Œ0è¡¨ç¤ºä¸éœ€è¦ï¼‰</strong>ï¼Œå› ä¸ºLEB128æœ€å¤š5å­—èŠ‚ï¼Œæ‰€ä»¥å½“è¯»å–åˆ°çš„ç¬¬5ä¸ªå­—èŠ‚çš„æœ€é«˜ä½ä¸º1æ—¶ï¼Œåˆ™è¡¨ç¤ºè¯¥dexæ–‡ä»¶æ— æ•ˆï¼ŒDalvikè™šæ‹ŸæœºéªŒè¯å¤±è´¥ã€‚</p><p>LEB128çš„å®ç°å¯åœ¨Androidæºç ç›®å½•&#x2F;dalvik&#x2F;libdex&#x2F;Leb128.hä¸­æ‰¾åˆ°ã€‚ï¼ˆéœ€è¦æ³¨æ„æ•°æ®å­˜å‚¨æ¨¡å¼æ˜¯<strong>å°ç«¯å­˜å‚¨</strong>ï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Reads an unsigned LEB128 value, updating the given pointer to point</span><br><span class="hljs-comment"> * just past the end of the read value. This function tolerates</span><br><span class="hljs-comment"> * non-zero high-order bits in the fifth encoded byte.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">DEX_INLINE <span class="hljs-type">int</span> <span class="hljs-title">readUnsignedLeb128</span><span class="hljs-params">(<span class="hljs-type">const</span> u1** pStream)</span> </span>&#123;<br>    <span class="hljs-type">const</span> u1* ptr = *pStream;<br>    <span class="hljs-type">int</span> result = *(ptr++);<span class="hljs-comment">//å–ä½å­—èŠ‚</span><br><br>    <span class="hljs-keyword">if</span> (result &gt; <span class="hljs-number">0x7f</span>) &#123;<span class="hljs-comment">//å¤§äºè¯´æ˜æœ€é«˜ä½ä¸º1ï¼Œéœ€è¦è·Ÿåä¸€å­—èŠ‚æ‹¼æ¥</span><br>        <span class="hljs-type">int</span> cur = *(ptr++);<br>        result = (result &amp; <span class="hljs-number">0x7f</span>) | ((cur &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">7</span>);<span class="hljs-comment">//è¯»å–uleb128,å­—èŠ‚çš„æœ€é«˜ä½ä¸éœ€è¦åŠ è¿›æ¥</span><br>        <span class="hljs-keyword">if</span> (cur &gt; <span class="hljs-number">0x7f</span>) &#123;<br>            cur = *(ptr++);<br>            result |= (cur &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">14</span>;<br>            <span class="hljs-keyword">if</span> (cur &gt; <span class="hljs-number">0x7f</span>) &#123;<br>                cur = *(ptr++);<br>                result |= (cur &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">21</span>;<br>                <span class="hljs-keyword">if</span> (cur &gt; <span class="hljs-number">0x7f</span>) &#123;<br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     * Note: We don&#x27;t check to see if cur is out of</span><br><span class="hljs-comment">                     * range here, meaning we tolerate garbage in the</span><br><span class="hljs-comment">                     * high four-order bits.</span><br><span class="hljs-comment">                     */</span><br>                    cur = *(ptr++);<br>                    result |= cur &lt;&lt; <span class="hljs-number">28</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    *pStream = ptr;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Reads a signed LEB128 value, updating the given pointer to point</span><br><span class="hljs-comment"> * just past the end of the read value. This function tolerates</span><br><span class="hljs-comment"> * non-zero high-order bits in the fifth encoded byte.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">DEX_INLINE <span class="hljs-type">int</span> <span class="hljs-title">readSignedLeb128</span><span class="hljs-params">(<span class="hljs-type">const</span> u1** pStream)</span> </span>&#123;<br>    <span class="hljs-type">const</span> u1* ptr = *pStream;<br>    <span class="hljs-type">int</span> result = *(ptr++);<br><br>    <span class="hljs-keyword">if</span> (result &lt;= <span class="hljs-number">0x7f</span>) &#123;<span class="hljs-comment">//ä¸éœ€è¦è·Ÿåä¸€å­—èŠ‚æ‹¼æ¥</span><br>        result = (result &lt;&lt; <span class="hljs-number">25</span>) &gt;&gt; <span class="hljs-number">25</span>;<span class="hljs-comment">//intä¸º32bitsï¼Œè€Œæˆ‘ä»¬åªéœ€è¦å–å­—èŠ‚çš„æœ‰æ•ˆä½7ä½ï¼Œæ‰€ä»¥&lt;&lt;25ç„¶å&gt;&gt;25æ˜¯å¯¹æœ€é«˜æœ‰æ•ˆä½è¿›è¡Œç¬¦å·æ‰©å±•</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">int</span> cur = *(ptr++);<br>        result = (result &amp; <span class="hljs-number">0x7f</span>) | ((cur &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">7</span>);<br>        <span class="hljs-keyword">if</span> (cur &lt;= <span class="hljs-number">0x7f</span>) &#123;<br>            result = (result &lt;&lt; <span class="hljs-number">18</span>) &gt;&gt; <span class="hljs-number">18</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            cur = *(ptr++);<br>            result |= (cur &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">14</span>;<br>            <span class="hljs-keyword">if</span> (cur &lt;= <span class="hljs-number">0x7f</span>) &#123;<br>                result = (result &lt;&lt; <span class="hljs-number">11</span>) &gt;&gt; <span class="hljs-number">11</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                cur = *(ptr++);<br>                result |= (cur &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">21</span>;<br>                <span class="hljs-keyword">if</span> (cur &lt;= <span class="hljs-number">0x7f</span>) &#123;<br>                    result = (result &lt;&lt; <span class="hljs-number">4</span>) &gt;&gt; <span class="hljs-number">4</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     * Note: We don&#x27;t check to see if cur is out of</span><br><span class="hljs-comment">                     * range here, meaning we tolerate garbage in the</span><br><span class="hljs-comment">                     * high four-order bits.</span><br><span class="hljs-comment">                     */</span><br>                    cur = *(ptr++);<br>                    result |= cur &lt;&lt; <span class="hljs-number">28</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    *pStream = ptr;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-encoded-value-ç¼–ç "><a href="#1-2-encoded-value-ç¼–ç " class="headerlink" title="1.2 encoded_value ç¼–ç "></a>1.2 encoded_value ç¼–ç </h2><p>åœ¨ annotation_element å’Œ encoded_array_item ä¸­ä¼šä½¿ç”¨åˆ°encoded_value ç¼–ç ã€‚encoded_valueæ˜¯ï¼ˆå‡ ä¹ï¼‰ä»»æ„å±‚æ¬¡ç»“æ„æ•°æ®çš„ç¼–ç ç‰‡ã€‚è¿™ç§ç¼–ç éå¸¸ç²¾ç®€ï¼Œæ˜“äºè§£æã€‚</p><table><thead><tr><th align="left">åç§°</th><th align="left">æ ¼å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">(value_arg &lt;&lt; 5) | value_type</td><td align="left">ubyte</td><td align="left">é«˜3ä½ä¸ºvalue_argçš„å€¼ï¼Œä½5ä½ä¸ºvalue_typeçš„å€¼ï¼Œvalue_typeæŒ‡å®švalueçš„æ ¼å¼ã€‚</td></tr><tr><td align="left">value</td><td align="left">ubyte[]</td><td align="left">ç”¨äºè¡¨ç¤ºå€¼çš„å­—èŠ‚ï¼Œä¸åŒ <code>value_type</code> å­—èŠ‚çš„é•¿åº¦ä¸åŒä¸”é‡‡ç”¨ä¸åŒçš„è§£è¯‘æ–¹å¼ï¼›ä¸è¿‡ä¸€å¾‹é‡‡ç”¨å°ç«¯å­—èŠ‚åºã€‚</td></tr></tbody></table><p>ä¸‹é¢å°†ä»‹ç»valueçš„æ ¼å¼ã€‚</p><h3 id="1-2-1-å€¼æ ¼å¼"><a href="#1-2-1-å€¼æ ¼å¼" class="headerlink" title="1.2.1 å€¼æ ¼å¼"></a>1.2.1 å€¼æ ¼å¼</h3><table><thead><tr><th align="left">ç±»å‹åç§°</th><th align="left">value_type</th><th align="left">value_arg æ ¼å¼</th><th align="left">value æ ¼å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">VALUE_BYTE</td><td align="left">0x00</td><td align="left">ï¼ˆæ— ï¼›å¿…é¡»ä¸º <code>0</code>ï¼‰</td><td align="left">ubyte[1]</td><td align="left">æœ‰ç¬¦å·çš„å•å­—èŠ‚æ•´æ•°å€¼</td></tr><tr><td align="left">VALUE_SHORT</td><td align="left">0x02</td><td align="left">size - 1 (0â€¦1)</td><td align="left">ubyte[size]</td><td align="left">æœ‰ç¬¦å·çš„åŒå­—èŠ‚æ•´æ•°å€¼ï¼Œç¬¦å·æ‰©å±•</td></tr><tr><td align="left">VALUE_CHAR</td><td align="left">0x03</td><td align="left">size - 1 (0â€¦1)</td><td align="left">ubyte[size]</td><td align="left">æ— ç¬¦å·çš„åŒå­—èŠ‚æ•´æ•°å€¼ï¼Œé›¶æ‰©å±•</td></tr><tr><td align="left">VALUE_INT</td><td align="left">0x04</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">æœ‰ç¬¦å·çš„å››å­—èŠ‚æ•´æ•°å€¼ï¼Œç¬¦å·æ‰©å±•</td></tr><tr><td align="left">VALUE_LONG</td><td align="left">0x06</td><td align="left">size - 1 (0â€¦7)</td><td align="left">ubyte[size]</td><td align="left">æœ‰ç¬¦å·çš„å…«å­—èŠ‚æ•´æ•°å€¼ï¼Œç¬¦å·æ‰©å±•</td></tr><tr><td align="left">VALUE_FLOAT</td><td align="left">0x10</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">å››å­—èŠ‚ä½æ¨¡å¼ï¼Œå‘å³é›¶æ‰©å±•ï¼Œç³»ç»Ÿä¼šå°†å…¶è§£è¯‘ä¸º IEEE754 32 ä½æµ®ç‚¹å€¼</td></tr><tr><td align="left">VALUE_DOUBLE</td><td align="left">0x11</td><td align="left">size - 1 (0â€¦7)</td><td align="left">ubyte[size]</td><td align="left">å…«å­—èŠ‚ä½æ¨¡å¼ï¼Œå‘å³é›¶æ‰©å±•ï¼Œç³»ç»Ÿä¼šå°†å…¶è§£è¯‘ä¸º IEEE754 64 ä½æµ®ç‚¹å€¼</td></tr><tr><td align="left">VALUE_METHOD_TYPE</td><td align="left">0x15</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">æ— ç¬¦å·ï¼ˆé›¶æ‰©å±•ï¼‰å››å­—èŠ‚æ•´æ•°å€¼ï¼Œä¼šè¢«è§£è¯‘ä¸ºè¦ç¼–å…¥ <code>proto_ids</code> åŒºæ®µçš„ç´¢å¼•ï¼›è¡¨ç¤ºæ–¹æ³•ç±»å‹å€¼</td></tr><tr><td align="left">VALUE_METHOD_HANDLE</td><td align="left">0x16</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">æ— ç¬¦å·ï¼ˆé›¶æ‰©å±•ï¼‰å››å­—èŠ‚æ•´æ•°å€¼ï¼Œä¼šè¢«è§£è¯‘ä¸ºè¦ç¼–å…¥ <code>method_handles</code> åŒºæ®µçš„ç´¢å¼•ï¼›è¡¨ç¤ºæ–¹æ³•å¥æŸ„å€¼</td></tr><tr><td align="left">VALUE_STRING</td><td align="left">0x17</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">æ— ç¬¦å·ï¼ˆé›¶æ‰©å±•ï¼‰å››å­—èŠ‚æ•´æ•°å€¼ï¼Œä¼šè¢«è§£è¯‘ä¸ºè¦ç¼–å…¥ <code>string_ids</code> åŒºæ®µçš„ç´¢å¼•ï¼›è¡¨ç¤ºå­—ç¬¦ä¸²å€¼</td></tr><tr><td align="left">VALUE_TYPE</td><td align="left">0x18</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">æ— ç¬¦å·ï¼ˆé›¶æ‰©å±•ï¼‰å››å­—èŠ‚æ•´æ•°å€¼ï¼Œä¼šè¢«è§£è¯‘ä¸ºè¦ç¼–å…¥ <code>type_ids</code> åŒºæ®µçš„ç´¢å¼•ï¼›è¡¨ç¤ºåå°„ç±»å‹&#x2F;ç±»å€¼</td></tr><tr><td align="left">VALUE_FIELD</td><td align="left">0x19</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">æ— ç¬¦å·ï¼ˆé›¶æ‰©å±•ï¼‰å››å­—èŠ‚æ•´æ•°å€¼ï¼Œä¼šè¢«è§£è¯‘ä¸ºè¦ç¼–å…¥ <code>field_ids</code> åŒºæ®µçš„ç´¢å¼•ï¼›è¡¨ç¤ºåå°„å­—æ®µå€¼</td></tr><tr><td align="left">VALUE_METHOD</td><td align="left">0x1a</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">æ— ç¬¦å·ï¼ˆé›¶æ‰©å±•ï¼‰å››å­—èŠ‚æ•´æ•°å€¼ï¼Œä¼šè¢«è§£è¯‘ä¸ºè¦ç¼–å…¥ <code>method_ids</code> åŒºæ®µçš„ç´¢å¼•ï¼›è¡¨ç¤ºåå°„æ–¹æ³•å€¼</td></tr><tr><td align="left">VALUE_ENUM</td><td align="left">0x1b</td><td align="left">size - 1 (0â€¦3)</td><td align="left">ubyte[size]</td><td align="left">æ— ç¬¦å·ï¼ˆé›¶æ‰©å±•ï¼‰å››å­—èŠ‚æ•´æ•°å€¼ï¼Œä¼šè¢«è§£è¯‘ä¸ºè¦ç¼–å…¥ <code>field_ids</code> åŒºæ®µçš„ç´¢å¼•ï¼›è¡¨ç¤ºæšä¸¾ç±»å‹å¸¸é‡çš„å€¼</td></tr><tr><td align="left">VALUE_ARRAY</td><td align="left">0x1c</td><td align="left">ï¼ˆæ— ï¼›å¿…é¡»ä¸º <code>0</code>ï¼‰</td><td align="left">encoded_array</td><td align="left">å€¼çš„æ•°ç»„ï¼Œé‡‡ç”¨ä¸‹æ–‡â€œ<code>encoded_array</code> æ ¼å¼â€æ‰€æŒ‡å®šçš„æ ¼å¼ã€‚<code>value</code> çš„å¤§å°éšå«åœ¨ç¼–ç ä¸­ã€‚</td></tr><tr><td align="left">VALUE_ANNOTATION</td><td align="left">0x1d</td><td align="left">ï¼ˆæ— ï¼›å¿…é¡»ä¸º <code>0</code>ï¼‰</td><td align="left">encoded_annotation</td><td align="left">å­æ³¨è§£ï¼Œé‡‡ç”¨ä¸‹æ–‡â€œ<code>encoded_annotation</code> æ ¼å¼â€æ‰€æŒ‡å®šçš„æ ¼å¼ã€‚<code>value</code> çš„å¤§å°éšå«åœ¨ç¼–ç ä¸­ã€‚</td></tr><tr><td align="left">VALUE_NULL</td><td align="left">0x1e</td><td align="left">ï¼ˆæ— ï¼›å¿…é¡»ä¸º <code>0</code>ï¼‰</td><td align="left">ï¼ˆæ— ï¼‰</td><td align="left"><code>null</code> å¼•ç”¨å€¼</td></tr><tr><td align="left">VALUE_BOOLEAN</td><td align="left">0x1f</td><td align="left">å¸ƒå°”å€¼ (0â€¦1)</td><td align="left">ï¼ˆæ— ï¼‰</td><td align="left">ä¸€ä½å€¼ï¼›<code>0</code> è¡¨ç¤º <code>false</code>ï¼Œ<code>1</code> è¡¨ç¤º <code>true</code>ã€‚è¯¥ä½åœ¨ <code>value_arg</code> ä¸­è¡¨ç¤ºã€‚</td></tr></tbody></table><p>ä¹‹åä¼šåœ¨ä¸‹é¢ç”¨åˆ°çš„æ—¶å€™å†ç»“åˆå®ä¾‹ä¸€èµ·åˆ†æã€‚</p><h1 id="äºŒã€dexæ–‡ä»¶ç»“æ„"><a href="#äºŒã€dexæ–‡ä»¶ç»“æ„" class="headerlink" title="äºŒã€dexæ–‡ä»¶ç»“æ„"></a>äºŒã€dexæ–‡ä»¶ç»“æ„</h1><h2 id="2-1-dexæ–‡ä»¶çš„æ•´ä½“ç»“æ„"><a href="#2-1-dexæ–‡ä»¶çš„æ•´ä½“ç»“æ„" class="headerlink" title="2.1 dexæ–‡ä»¶çš„æ•´ä½“ç»“æ„"></a>2.1 dexæ–‡ä»¶çš„æ•´ä½“ç»“æ„</h2><p>æ•´ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/1.png"></p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/2.png"></p><p>dexæ–‡ä»¶ç»“æ„ä½“çš„å®šä¹‰åœ¨Androidæºç ç›®å½•&#x2F;dalvik&#x2F;libdex&#x2F;DexFile.hä¸­å¯ä»¥æ‰¾åˆ°ï¼Œå…¶ä¸­å®šä¹‰çš„dexæ–‡ä»¶ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexFile</span> &#123;<br>    <span class="hljs-comment">/* directly-mapped &quot;opt&quot; header */</span><br>    <span class="hljs-type">const</span> DexOptHeader* pOptHeader;<br><br>    <span class="hljs-comment">/* pointers to directly-mapped structs and arrays in base DEX */</span><br>    <span class="hljs-type">const</span> DexHeader*    pHeader;<br>    <span class="hljs-type">const</span> DexStringId*  pStringIds;<br>    <span class="hljs-type">const</span> DexTypeId*    pTypeIds;<br>    <span class="hljs-type">const</span> DexFieldId*   pFieldIds;<br>    <span class="hljs-type">const</span> DexMethodId*  pMethodIds;<br>    <span class="hljs-type">const</span> DexProtoId*   pProtoIds;<br>    <span class="hljs-type">const</span> DexClassDef*  pClassDefs;<br>    <span class="hljs-type">const</span> DexLink*      pLinkData;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * These are mapped out of the &quot;auxillary&quot; section, and may not be</span><br><span class="hljs-comment">     * included in the file.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">const</span> DexClassLookup* pClassLookup;<br>    <span class="hljs-type">const</span> <span class="hljs-type">void</span>*         pRegisterMapPool;       <span class="hljs-comment">// RegisterMapClassPool</span><br><br>    <span class="hljs-comment">/* points to start of DEX file data */</span><br>    <span class="hljs-type">const</span> u1*           baseAddr;<br><br>    <span class="hljs-comment">/* track memory overhead for auxillary structures */</span><br>    <span class="hljs-type">int</span>                 overhead;<br><br>    <span class="hljs-comment">/* additional app-specific data structures associated with the DEX */</span><br>    <span class="hljs-comment">//void*               auxData;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢å°±å¯¹è¿™å‡ éƒ¨åˆ†è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p><h2 id="2-2-dex-headerï¼ˆDexHeaderï¼‰"><a href="#2-2-dex-headerï¼ˆDexHeaderï¼‰" class="headerlink" title="2.2 dex_headerï¼ˆDexHeaderï¼‰"></a>2.2 dex_headerï¼ˆDexHeaderï¼‰</h2><p>dex_headerå¯¹åº”DexHeaderç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexHeader</span> &#123;<br>    u1  magic[<span class="hljs-number">8</span>];<span class="hljs-comment">//dexæ ‡è¯†+ç‰ˆæœ¬å·</span><br>    u4  checksum;<span class="hljs-comment">//32ä½æ ¡éªŒç </span><br>    u1  signature[kSHA1DigestLen];<span class="hljs-comment">// SHA-1å“ˆå¸Œå€¼</span><br>    u4  fileSize;<span class="hljs-comment">//dexæ–‡ä»¶çš„å¤§å°</span><br>    u4  headerSize;<span class="hljs-comment">//dex headerçš„å¤§å°ï¼Œ009ç‰ˆæœ¬ä¸º0x5c,035ç‰ˆæœ¬ä¸º0x70</span><br>    u4  endianTag;<span class="hljs-comment">//æ ‡è¯†å­—èŠ‚é¡ºåºçš„å¸¸é‡</span><br>    <br>    u4  linkSize;<span class="hljs-comment">//é“¾æ¥æ®µçš„å¤§å°</span><br>    u4  linkOff;<span class="hljs-comment">//é“¾æ¥æ®µçš„åç§»é‡</span><br>    <br>    u4  mapOff;<span class="hljs-comment">//dex map listçš„åç§»é‡</span><br>    <br>    u4  stringIdsSize;<span class="hljs-comment">//dex string idçš„ä¸ªæ•°</span><br>    u4  stringIdsOff;<span class="hljs-comment">//dex string idçš„åç§»é‡</span><br>    <br>    u4  typeIdsSize;<br>    u4  typeIdsOff;<br>    <br>    u4  protoIdsSize;<br>    u4  protoIdsOff;<br>    <br>    u4  fieldIdsSize;<br>    u4  fieldIdsOff;<br>    <br>    u4  methodIdsSize;<br>    u4  methodIdsOff;<br>    <br>    u4  classDefsSize;<br>    u4  classDefsOff;<br>    <br>    u4  dataSize;<br>    u4  dataOff;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å„ä¸ªå­—æ®µè§£é‡Šå¦‚ä¸‹ï¼š</p><table><thead><tr><th>å­—æ®µ</th><th>åç§»é‡</th><th>é•¿åº¦</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>magic</td><td>0x0</td><td>8</td><td>é­”æ•°å­—æ®µï¼Œæ ¼å¼å¦‚â€œdex&#x2F;n035&#x2F;0â€ï¼Œå…¶ä¸­035è¡¨ç¤ºdexç»“æ„çš„ç‰ˆæœ¬å·</td></tr><tr><td>checksum</td><td>0x8</td><td>4</td><td>dexæ–‡ä»¶çš„æ ¡éªŒå’Œï¼Œé€šè¿‡å®ƒæ¥åˆ¤æ–­dexæ–‡ä»¶æ˜¯å¦è¢«æŸåæˆ–ç¯¡æ”¹</td></tr><tr><td>signature</td><td>0xC</td><td>20</td><td>æ–‡ä»¶å‰©ä½™å†…å®¹ï¼ˆé™¤ <code>magic</code>ã€<code>checksum</code> å’Œæ­¤å­—æ®µä¹‹å¤–çš„æ‰€æœ‰å†…å®¹ï¼‰çš„ SHA-1 ç­¾åï¼ˆå“ˆå¸Œï¼‰ï¼›ç”¨äºå¯¹æ–‡ä»¶è¿›è¡Œå”¯ä¸€æ ‡è¯†</td></tr><tr><td>fileSize</td><td>0x20</td><td>4</td><td>æ•´ä¸ªdexæ–‡ä»¶çš„å¤§å°ï¼ˆbyteæ•°ï¼‰</td></tr><tr><td>headerSize</td><td>0x24</td><td>4</td><td>dex_headerï¼ˆå³DexHeaderç»“æ„ä½“ï¼‰çš„å¤§å°</td></tr><tr><td>endianTag</td><td>0x28</td><td>4</td><td>æŒ‡å®šdexè¿è¡Œç¯å¢ƒçš„cpuå­—èŠ‚åºï¼ˆå³å¤§ç«¯è¿˜æ˜¯å°ç«¯ï¼‰ï¼Œæœ‰å°ç«¯å­—èŠ‚åºï¼ˆENDIAN_CONSTANT &#x3D; 0x12345678ï¼‰å’Œå¤§ç«¯å­—èŠ‚åºï¼ˆREVERSE_ENDIAN_CONSTANT &#x3D; 0x78563412ï¼‰ä¸¤ç§ã€‚</td></tr><tr><td>linkSize</td><td>0x2C</td><td>4</td><td>é“¾æ¥æ®µçš„å¤§å°</td></tr><tr><td>linkOff</td><td>0x30</td><td>4</td><td>é“¾æ¥æ®µçš„æ–‡ä»¶åç§»é‡</td></tr><tr><td>mapOff</td><td>0x34</td><td>4</td><td>dex_map_listï¼ˆå³DexMapListç»“æ„ä½“ï¼‰çš„æ–‡ä»¶åç§»é‡</td></tr><tr><td>stringIdsSize</td><td>0x38</td><td>4</td><td>string_idsåŒºä¸­çš„å­—ç¬¦ä¸²ç´¢å¼•çš„ä¸ªæ•°</td></tr><tr><td>stringIdsOff</td><td>0x3C</td><td>4</td><td>string_idsåŒºçš„æ–‡ä»¶åç§»é‡ï¼ˆä¸€èˆ¬ä¸headerSizeç›¸ç­‰ï¼‰</td></tr><tr><td>typeIdsSize</td><td>0x40</td><td>4</td><td>type_idsåŒºä¸­çš„ç±»å‹ç´¢å¼•çš„ä¸ªæ•°</td></tr><tr><td>typeIdsOff</td><td>0x44</td><td>4</td><td>type_idsåŒºçš„æ–‡ä»¶åç§»é‡</td></tr><tr><td>protoIdsSize</td><td>0x48</td><td>4</td><td>proto_idsåŒºä¸­çš„æ–¹æ³•åŸå‹ç´¢å¼•çš„ä¸ªæ•°</td></tr><tr><td>protoIdsOff</td><td>0x4C</td><td>4</td><td>proto_idsåŒºçš„æ–‡ä»¶åç§»é‡</td></tr><tr><td>fieldIdsSize</td><td>0x50</td><td>4</td><td>field_idsåŒºä¸­çš„åŸŸç´¢å¼•çš„ä¸ªæ•°</td></tr><tr><td>fieldIdsOff</td><td>0x54</td><td>4</td><td>field_idsåŒºçš„æ–‡ä»¶åç§»é‡</td></tr><tr><td>methodIdsSize</td><td>0x58</td><td>4</td><td>method_idsåŒºä¸­çš„æ–¹æ³•ç´¢å¼•çš„ä¸ªæ•°</td></tr><tr><td>methodIdsOff</td><td>0x5C</td><td>4</td><td>method_idsåŒºçš„æ–‡ä»¶åç§»é‡</td></tr><tr><td>classDefsSize</td><td>0x60</td><td>4</td><td>class_defåŒºä¸­çš„ç±»çš„ä¸ªæ•°</td></tr><tr><td>classDefsOff</td><td>0x64</td><td>4</td><td>class_defåŒºçš„æ–‡ä»¶åç§»é‡</td></tr><tr><td>dataSize</td><td>0x68</td><td>4</td><td>dataåŒºçš„å¤§å°ï¼Œå¿…é¡»ä¸º4å­—èŠ‚çš„æ•´æ•°å€</td></tr><tr><td>dataOff</td><td>0x6C</td><td>4</td><td>dataåŒºçš„æ–‡ä»¶åç§»é‡</td></tr></tbody></table><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…·ä½“å®ä¾‹çš„dex_headerå±•ç¤ºå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/3.png"></p><h2 id="2-3-string-idsï¼ˆDexStringIdåˆ—è¡¨ï¼‰"><a href="#2-3-string-idsï¼ˆDexStringIdåˆ—è¡¨ï¼‰" class="headerlink" title="2.3 string_idsï¼ˆDexStringIdåˆ—è¡¨ï¼‰"></a>2.3 string_idsï¼ˆDexStringIdåˆ—è¡¨ï¼‰</h2><p>string_idsä¸­çš„é¡¹ä¸ºDexStringIdç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;string_id_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexStringId</span> &#123;<br>    u4 stringDataOff;      <span class="hljs-comment">/* å­—ç¬¦ä¸²çš„æ–‡ä»¶åç§»é‡ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>DexStringIdç»“æ„ä½“ä¸­åªæœ‰ä¸€ä¸ªstringDataOffå­—æ®µï¼Œå¤§å°4å­—èŠ‚ï¼Œå­˜å‚¨æŒ‡å‘å­—ç¬¦ä¸²æ•°æ®çš„æ–‡ä»¶åç§»é‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å­—ç¬¦ä¸²é‡‡ç”¨çš„æ˜¯MUTF-8ç¼–ç è¡¨ç¤ºï¼Œå®ƒä¸UTF-8çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>MUTF-8ä½¿ç”¨1~3ä¸ªå­—èŠ‚ç¼–ç é•¿åº¦ã€‚</li><li>å¤§äº16ä½çš„Unicodeç¼–ç U+10000~U+10ffffä½¿ç”¨3å­—èŠ‚æ¥ç¼–ç ã€‚</li><li>U+000é‡‡ç”¨2å­—èŠ‚æ¥ç¼–ç ã€‚</li><li>é‡‡ç”¨ç±»ä¼¼Cè¯­è¨€ä¸­çš„ç©ºå­—ç¬¦ï¼ˆâ€™&#x2F;0x00â€™ï¼‰ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“å°¾ã€‚</li></ul><p><strong>MUTF-8å­—ç¬¦ä¸²çš„å¤´éƒ¨ï¼ˆ1byteï¼‰å­˜æ”¾çš„æ˜¯å­—ç¬¦ä¸²çš„å­—èŠ‚æ•°ã€‚</strong></p><p>æˆ‘ä»¬é€šè¿‡å…·ä½“çš„å®ä¾‹æ¥æ›´å¥½çš„ç†è§£ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œç¬¬4é¡¹DexStringIdç»“æ„ä½“ä¸­çš„stringDataOffçš„å€¼ä¸º0x615E7ï¼ŒæŒ‡å‘çš„å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xCï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ä¸º12bytesï¼Œåé¢ç´§è·Ÿç€çš„å°±æ˜¯å­—ç¬¦ä¸²å¹¶ä»¥0x00ä½œä¸ºç»“æŸç¬¦ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/4.png"></p><h2 id="2-4-type-idsï¼ˆDexTypeIdåˆ—è¡¨ï¼‰"><a href="#2-4-type-idsï¼ˆDexTypeIdåˆ—è¡¨ï¼‰" class="headerlink" title="2.4 type_idsï¼ˆDexTypeIdåˆ—è¡¨ï¼‰"></a>2.4 type_idsï¼ˆDexTypeIdåˆ—è¡¨ï¼‰</h2><p>type_idsä¸­çš„é¡¹ä¸ºDexTypeIdç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;type_id_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexTypeId</span> &#123;<br>    u4  descriptorIdx;      <span class="hljs-comment">/* æŒ‡å‘DexStringIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>DexTypeIdç»“æ„ä½“ä¸­åªæœ‰ä¸€ä¸ªdescriptorIdxå­—æ®µï¼Œå¤§å°4å­—èŠ‚ï¼Œå­˜å‚¨æŒ‡å‘DexStringIdåˆ—è¡¨çš„ç´¢å¼•ï¼Œå¯¹åº”çš„å­—ç¬¦ä¸²ä»£è¡¨å…·ä½“ç±»çš„ç±»å‹ï¼ˆ<strong>smaliè¯­æ³•ä¸­çš„ç±»å‹</strong>ï¼‰ã€‚ä¾‹å¦‚ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/5.png"></p><p>type_idsä¸­çš„ç¬¬ä¸€é¡¹çš„å€¼ä¸º0x4C7ï¼ˆå³åè¿›åˆ¶1223ï¼‰ï¼Œé‚£ä¹ˆå°±åº”è¯¥å¯»æ‰¾string_ids[1223]ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/6.png"></p><p>ä¹‹åçš„å­—ç¬¦ä¸²å¯»æ‰¾åœ¨ <code>2.3 string_ids</code>ä¸­è¯´è¿‡äº†ï¼Œè¿™é‡Œä¸å†é‡å¤ã€‚</p><h2 id="2-5-proto-idsï¼ˆDexProtoIdåˆ—è¡¨ï¼‰"><a href="#2-5-proto-idsï¼ˆDexProtoIdåˆ—è¡¨ï¼‰" class="headerlink" title="2.5 proto_idsï¼ˆDexProtoIdåˆ—è¡¨ï¼‰"></a>2.5 proto_idsï¼ˆDexProtoIdåˆ—è¡¨ï¼‰</h2><p>proto_idsä¸­çš„é¡¹ä¸ºDexProtoIdç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;proto_id_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexProtoId</span> &#123;<br>    u4  shortyIdx;          <span class="hljs-comment">/* æ–¹æ³•å£°æ˜ï¼ŒæŒ‡å‘DexStringIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>    u4  returnTypeIdx;      <span class="hljs-comment">/* æ–¹æ³•çš„è¿”å›ç±»å‹ï¼ŒæŒ‡å‘DexTypeIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>    u4  parametersOff;      <span class="hljs-comment">/* å‚æ•°ç±»å‹åˆ—è¡¨ï¼ŒæŒ‡å‘type_list(DextypeListç»“æ„ä½“)çš„æ–‡ä»¶åç§»é‡ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>DexFieldIdæ˜¯<strong>æ–¹æ³•å£°æ˜ï¼ˆæ–¹æ³•ç­¾åï¼‰</strong>çš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ä¸­æœ‰3ä¸ªå­—æ®µï¼ŒshortyIdxæœ€ç»ˆæŒ‡å‘æ–¹æ³•å£°æ˜å­—ç¬¦ä¸²ï¼ˆæ–¹æ³•å£°æ˜ç”±è¿”å›ç±»å‹å’Œå‚æ•°ç±»å‹åˆ—è¡¨ç»„æˆï¼‰ï¼ŒreturnTypeIdxæœ€ç»ˆæŒ‡å‘æ–¹æ³•çš„è¿”å›ç±»å‹å­—ç¬¦ä¸²ï¼ŒparametersOffæŒ‡å‘ä¸€ä¸ªDextypeListç»“æ„ä½“ï¼Œå­˜æ”¾äº†æ–¹æ³•çš„å‚æ•°ç±»å‹çš„åˆ—è¡¨ã€‚</p><h3 id="2-5-1-DexTypeList"><a href="#2-5-1-DexTypeList" class="headerlink" title="2.5.1 DexTypeList"></a>2.5.1 DexTypeList</h3><p>è¯¥ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;type_list&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexTypeList</span> &#123;<br>    u4  size;               <span class="hljs-comment">/* DexTypeItemçš„ä¸ªæ•°*/</span><br>    DexTypeItem list[<span class="hljs-number">1</span>];    <span class="hljs-comment">/* é¦–ä¸ªDexTypeItemçš„å€¼ï¼Œéåç§»é‡ */</span><br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;type_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexTypeItem</span> &#123;<br>    u2  typeIdx;            <span class="hljs-comment">/* æŒ‡å‘DexTypeIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç°åœ¨ç»“åˆå®ä¾‹æ¥è§£é‡Šproto_idsçš„å¯»æ‰¾è¿‡ç¨‹ã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­çš„proto_id[7]ã€‚shortyIdxçš„å€¼ä¸º0x5f2ï¼ŒæŒ‡å‘string_ids[1522]ï¼Œæœ€ç»ˆçš„å­—ç¬¦ä¸²ä¸ºâ€CLâ€ï¼›returnTypeIdxçš„å€¼ä¸º0x1ï¼ŒæŒ‡å‘type_ids[1]ï¼Œå€¼ä¸º0x5b6ï¼ŒæŒ‡å‘string_ids[1462]ï¼Œæœ€ç»ˆçš„å­—ç¬¦ä¸²ä¸ºâ€œCâ€ï¼›parametersOffçš„å€¼ä¸º0xE1A08ï¼ŒæŒ‡å‘çš„DexTypeListç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ä¸­å­—æ®µsizeçš„å€¼ä¸º1ï¼Œè¡¨ç¤ºåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ¥ç€å°±æ˜¯DexTypeItemç»“æ„ä½“ï¼Œå…¶ä¸­å­—æ®µtypeIdxçš„å€¼ä¸º0x7B9ï¼ŒæŒ‡å‘type_ids[1977]ï¼Œå€¼ä¸º0x14B3ï¼ŒæŒ‡å‘string_ids[5299]ï¼Œæœ€ç»ˆçš„å­—ç¬¦ä¸²ä¸ºâ€Ljava&#x2F;lang&#x2F;String;â€œã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/7.png"></p><h2 id="2-6-field-idsï¼ˆDexFieldIdåˆ—è¡¨ï¼‰"><a href="#2-6-field-idsï¼ˆDexFieldIdåˆ—è¡¨ï¼‰" class="headerlink" title="2.6 field_idsï¼ˆDexFieldIdåˆ—è¡¨ï¼‰"></a>2.6 field_idsï¼ˆDexFieldIdåˆ—è¡¨ï¼‰</h2><p>field_idsä¸­çš„é¡¹ä¸ºDexFieldIdç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;field_id_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexFieldId</span> &#123;<br>    u2  classIdx;           <span class="hljs-comment">/* ç±»çš„ç±»å‹ï¼ŒæŒ‡å‘DexTypeIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>    u2  typeIdx;            <span class="hljs-comment">/* å­—æ®µç±»å‹ï¼ŒæŒ‡å‘DexTypeIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>    u4  nameIdx;            <span class="hljs-comment">/* å­—æ®µåï¼ŒæŒ‡å‘DexStringIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>DexFieldIdç»“æ„ä½“æŒ‡æ˜äº†æˆå‘˜å˜é‡æ‰€åœ¨çš„ç±»ã€ç±»å‹ä»¥åŠå˜é‡åã€‚</p><p>è¿™é‡Œæ”¾ä¸€å¼ dex_fieldéƒ¨åˆ†çš„å›¾ï¼Œæ–¹ä¾¿ç†è§£ï¼Œé‡å¤çš„å¯»æ‰¾è¿‡ç¨‹å°±ä¸é‡è¿°ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/8.png"></p><h2 id="2-7-method-idsï¼ˆDexMethodIdåˆ—è¡¨ï¼‰"><a href="#2-7-method-idsï¼ˆDexMethodIdåˆ—è¡¨ï¼‰" class="headerlink" title="2.7 method_idsï¼ˆDexMethodIdåˆ—è¡¨ï¼‰"></a>2.7 method_idsï¼ˆDexMethodIdåˆ—è¡¨ï¼‰</h2><p>method_idsä¸­çš„é¡¹ä¸ºDexMethodIdç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;method_id_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexMethodId</span> &#123;<br>    u2  classIdx;           <span class="hljs-comment">/* æ–¹æ³•çš„æ‰€å±çš„ç±»ï¼ŒæŒ‡å‘DexTypeIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>    u2  protoIdx;           <span class="hljs-comment">/* å£°æ˜ç±»å‹ï¼ŒæŒ‡å‘DexProtoIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>    u4  nameIdx;            <span class="hljs-comment">/* æ–¹æ³•åï¼ŒæŒ‡å‘DexStringIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>DexMethodIdç»“æ„ä½“æŒ‡æ˜äº†æ–¹æ³•æ‰€åœ¨çš„ç±»ã€æ–¹æ³•çš„å£°æ˜ï¼ˆç­¾åï¼‰ä»¥åŠæ–¹æ³•åã€‚</p><p>åŒæ ·é™„å¸¦method_idséƒ¨åˆ†çš„ç¤ºä¾‹å›¾ä»¥ä¾›ç†è§£ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/9.png"></p><h2 id="2-8-class-defï¼ˆDexClassDefåˆ—è¡¨ï¼‰"><a href="#2-8-class-defï¼ˆDexClassDefåˆ—è¡¨ï¼‰" class="headerlink" title="2.8 class_defï¼ˆDexClassDefåˆ—è¡¨ï¼‰"></a>2.8 class_defï¼ˆDexClassDefåˆ—è¡¨ï¼‰</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;class_def_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexClassDef</span> &#123;<br>    u4  classIdx;           <span class="hljs-comment">/* ç±»çš„ç±»å‹ï¼ˆå³å…¨é™å®šç±»åï¼‰ï¼ŒæŒ‡å‘DexTypeIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>    u4  accessFlags;<span class="hljs-comment">/* è®¿é—®æ ‡å¿—ï¼Œå®ƒæ˜¯ä»¥ACC_å¼€å¤´çš„ä¸€ä¸ªæšä¸¾å€¼ï¼Œä¾‹å¦‚ACC_PUBLICï¼ˆ0x1ï¼‰ã€ACC_PRIVATEï¼ˆ0x2ï¼‰*/</span><br>    u4  superclassIdx;      <span class="hljs-comment">/* çˆ¶ç±»ç±»å‹ï¼ŒæŒ‡å‘DexTypeIdåˆ—è¡¨çš„ç´¢å¼•*/</span><br>    u4  interfacesOff;      <span class="hljs-comment">/* æ¥å£ï¼ŒæŒ‡å‘DexTypeListçš„æ–‡ä»¶åç§»ï¼Œå¦‚æœç±»ä¸­ä¸å«æœ‰æ¥å£å£°æ˜å’Œå®ç°ï¼Œåˆ™å€¼ä¸º0 */</span><br>    u4  sourceFileIdx;      <span class="hljs-comment">/* ç±»æ‰€åœ¨æºæ–‡ä»¶çš„æ–‡ä»¶åï¼ŒæŒ‡å‘DexStringIdåˆ—è¡¨çš„ç´¢å¼• */</span><br>    u4  annotationsOff;     <span class="hljs-comment">/* æ³¨è§£ï¼ŒæŒ‡å‘DexAnnotationsDirectoryItemç»“æ„ä½“ï¼Œæ ¹æ®ç±»å‹ä¸åŒä¼šæœ‰æ³¨è§£ç±»ã€æ³¨è§£æ–¹æ³•ã€æ³¨è§£å­—æ®µä¸æ³¨è§£å‚æ•°ï¼Œå¦‚æœç±»ä¸­æ²¡æœ‰æ³¨è§£ï¼Œåˆ™å€¼ä¸º0 */</span><br>    u4  classDataOff;       <span class="hljs-comment">/* æŒ‡å‘DexClassDataç»“æ„çš„æ–‡ä»¶åç§»ï¼ŒDexClassDataç»“æ„æ˜¯ç±»çš„æ•°æ®éƒ¨åˆ† */</span><br>    u4  staticValuesOff;    <span class="hljs-comment">/* æŒ‡å‘DexEncodedArrayç»“æ„çš„æ–‡ä»¶åç§»ï¼ŒDexEncodedArrayç»“æ„è®°å½•ç±»ä¸­çš„é™æ€æ•°æ® */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¾æ¬¡è§£æå…¶ä¸­æœªæ›¾å‡ºç°è¿‡çš„ç»“æ„ä½“ã€‚</p><h3 id="2-8-1-DexAnnotationsDirectoryItem"><a href="#2-8-1-DexAnnotationsDirectoryItem" class="headerlink" title="2.8.1 DexAnnotationsDirectoryItem"></a>2.8.1 DexAnnotationsDirectoryItem</h3><p>è¯¥ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;annotations_directory_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexAnnotationsDirectoryItem</span> &#123;<br>    u4  classAnnotationsOff;  <span class="hljs-comment">/* ç±»æ³¨é‡Šï¼Œå€¼ä¸ºDexAnnotationSetItemçš„æ–‡ä»¶åç§»é‡ */</span><br>    u4  fieldsSize;           <span class="hljs-comment">/* åŸŸæ³¨é‡Šï¼Œå€¼ä¸ºDexFieldAnnotationsItemçš„æ•°é‡ */</span><br>    u4  methodsSize;          <span class="hljs-comment">/* æ–¹æ³•æ³¨é‡Šï¼Œå€¼ä¸ºDexMethodAnnotationsItemçš„æ•°é‡ */</span><br>    u4  parametersSize;       <span class="hljs-comment">/* å‚æ•°æ³¨é‡Šã€‚å€¼ä¸ºDexParameterAnnotationsItemçš„æ•°é‡ */</span><br>    <span class="hljs-comment">/* å¦‚æœä¸Šè¿°åä¸‰è€…ä¸­å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œåˆ™åœ¨åé¢è¿½åŠ ä»¥ä¸‹æ•°æ®ï¼Œå¹¶æŒ‰ä¸‹åˆ—é¡ºåºæ’åˆ— */</span><br>    <span class="hljs-comment">/* followed by DexFieldAnnotationsItem[fieldsSize] */</span><br>    <span class="hljs-comment">/* followed by DexMethodAnnotationsItem[methodsSize] */</span><br>    <span class="hljs-comment">/* followed by DexParameterAnnotationsItem[parametersSize] */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>classAnnotationsOffæŒ‡å‘DexAnnotationSetItemç»“æ„ä½“ã€‚DexFieldAnnotationsItemã€DexMethodAnnotationsItemã€DexParameterAnnotationsItemå¦‚æœå­˜åœ¨ï¼Œåˆ™æŒ‰é¡ºåºæ’åˆ—åœ¨parametersSizeå­—æ®µåé¢ï¼</p><p>ä¸‹é¢ç»§ç»­è§£ææœªæ›¾å‡ºç°è¿‡çš„ç»“æ„ã€‚</p><h4 id="2-8-1-1-DexAnnotationSetItem"><a href="#2-8-1-1-DexAnnotationSetItem" class="headerlink" title="2.8.1.1 DexAnnotationSetItem"></a>2.8.1.1 DexAnnotationSetItem</h4><p>è¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;annotation_set_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexAnnotationSetItem</span> &#123;<br>    u4  size;<span class="hljs-comment">/* DexAnnotationItemçš„æ•°é‡ */</span><br>    u4  entries[<span class="hljs-number">1</span>];                 <span class="hljs-comment">/* ç¬¬ä¸€ä¸ªDexAnnotationItemçš„æ–‡ä»¶åç§»é‡ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<strong>DexAnnotationItem</strong>çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;annotation_item&quot;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">NOTE:</span> this structure is byte-aligned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexAnnotationItem</span> &#123;<br>    u1  visibility;<span class="hljs-comment">/* æ­¤æ³¨é‡Šçš„é¢„æœŸå¯è§æ€§ */</span><br>    u1  annotation[<span class="hljs-number">1</span>];              <span class="hljs-comment">/* encoded_annotationæ ¼å¼çš„æ³¨é‡Šå†…å®¹ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå­—æ®µvisibilityè¡¨ç¤ºæ³¨é‡Šçš„å¯è§æ€§ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><table><thead><tr><th align="left">åç§°</th><th align="left">å€¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">VISIBILITY_BUILD</td><td align="left">0x00</td><td align="left">é¢„è®¡ä»…åœ¨æ„å»ºï¼ˆä¾‹å¦‚ï¼Œåœ¨ç¼–è¯‘å…¶ä»–ä»£ç æœŸé—´ï¼‰æ—¶å¯è§</td></tr><tr><td align="left">VISIBILITY_RUNTIME</td><td align="left">0x01</td><td align="left">é¢„è®¡åœ¨è¿è¡Œæ—¶å¯è§</td></tr><tr><td align="left">VISIBILITY_SYSTEM</td><td align="left">0x02</td><td align="left">é¢„è®¡åœ¨è¿è¡Œæ—¶å¯è§ï¼Œä½†ä»…å¯¹åŸºæœ¬ç³»ç»Ÿï¼ˆè€Œä¸æ˜¯å¸¸è§„ç”¨æˆ·ä»£ç ï¼‰å¯è§</td></tr></tbody></table><p>ç¬¬äºŒä¸ªå­—æ®µannotationè¡¨ç¤ºé‡‡ç”¨encoded_annotationæ ¼å¼çš„æ³¨é‡Šå†…å®¹ã€‚<strong>encoded_annotationæ ¼å¼</strong>å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">åç§°</th><th align="left">æ ¼å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">type_idx</td><td align="left">uleb128</td><td align="left">æ³¨é‡Šçš„ç±»å‹ï¼ŒæŒ‡å‘DexTypeIdåˆ—è¡¨çš„ç´¢å¼•å€¼</td></tr><tr><td align="left">size</td><td align="left">uleb128</td><td align="left">æ­¤æ³¨è§£ä¸­ name-value æ˜ å°„çš„æ•°é‡</td></tr><tr><td align="left">elements</td><td align="left">annotation_element[size]</td><td align="left">æ³¨è§£çš„å…ƒç´ ï¼Œç›´æ¥ä»¥å†…åµŒå½¢å¼ï¼ˆä¸ä½œä¸ºåç§»é‡ï¼‰è¡¨ç¤ºã€‚å…ƒç´ å¿…é¡»æŒ‰ <code>string_id</code> ç´¢å¼•ä»¥å‡åºè¿›è¡Œæ’åºã€‚</td></tr></tbody></table><p><strong>annotation_elementæ ¼å¼</strong>å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">åç§°</th><th align="left">æ ¼å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">name_idx</td><td align="left">uleb128</td><td align="left">å…ƒç´ åç§°ï¼ŒæŒ‡å‘DexStringIdåˆ—è¡¨çš„ç´¢å¼•å€¼</td></tr><tr><td align="left">value</td><td align="left">encoded_value</td><td align="left">å…ƒç´ å€¼</td></tr></tbody></table><p>å¥½ï¼ç°åœ¨ç»“åˆå®ä¾‹æ¥åˆ†æã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œçº¢æ¡†ä¸­ä¸ºDexAnnotationSetItemç»“æ„ä½“ï¼ˆåŒ…æ‹¬çš„å®ƒåç§»é‡ï¼‰ï¼Œæ ¹æ®è¯¥ç»“æ„ä½“çš„å®šä¹‰ï¼Œé¦–å…ˆæ˜¯å››å­—èŠ‚çš„æ•°å€¼è¡¨ç¤ºå¤§å°ï¼Œå€¼ä¸º0x3ï¼Œæ¥ç€å°±æ˜¯å››å­—èŠ‚è¡¨ç¤ºDexAnnotationItemçš„æ–‡ä»¶åç§»é‡ï¼Œå€¼ä¸º0xE922Aã€‚é‚£ä¹ˆå°±åˆ°äº†DexAnnotationItemæ•°ç»„äº†ï¼Œè¿™é‡Œæˆ‘ä»¬åªåˆ†æannotation_item[0]å³å¯ï¼Œæ ¹æ®è¯¥ç»“æ„ä½“çš„å®šä¹‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºæ³¨é‡Šçš„å¯è§æ€§ï¼Œå€¼ä¸º0x2ï¼Œå¯¹åº”VISIBILITY_SYSTEMï¼Œç„¶åå°±æ˜¯encoded_annotationæ ¼å¼çš„æ•°æ®ã€‚æ ¹æ®encoded_annotationæ ¼å¼ï¼Œç¬¬ä¸€ä¸ªå­—æ®µtype_idxé‡‡ç”¨uleb128ç¼–ç ï¼Œé‚£ä¹ˆå€¼å°±æ˜¯0x0775ï¼Œä¹‹åæŒ‰ç…§ç´¢å¼•å€¼æŸ¥æ‰¾å³å¯ï¼Œç„¶åç¬¬äºŒä¸ªå­—æ®µsizeä¹Ÿé‡‡ç”¨uleb128ç¼–ç ï¼Œé‚£ä¹ˆå€¼å°±æ˜¯0x01ï¼Œè¡¨ç¤ºåªæœ‰ä¸€ä¸ª name-valueé”®å€¼å¯¹ï¼Œæ¥ä¸‹æ¥æ˜¯elementså­—æ®µï¼Œé‡‡ç”¨annotation_elementæ ¼å¼ï¼Œé‚£ä¹ˆé‡‡ç”¨uleb128ç¼–ç çš„name_idxçš„å€¼ä¸º0x5185ï¼Œæ¥ä¸‹æ¥çš„valueé‡‡ç”¨encoded_valueç¼–ç ï¼Œæ ¹æ®1.2èŠ‚æ‰€è®²çš„ï¼Œé«˜3ä½ä¸ºvalue_argçš„å€¼ï¼ˆ0x1ï¼‰ï¼Œä½5ä½ä¸ºvalue_typeçš„å€¼ï¼ˆ0x18ï¼‰ï¼Œæ ¹æ®value_typeçš„å€¼æŸ¥è¡¨ï¼Œå¯çŸ¥æ˜¯åé¢è·Ÿéšæ— ç¬¦å·ï¼ˆé›¶æ‰©å±•ï¼‰å››å­—èŠ‚æ•´æ•°å€¼ï¼Œä¸”æ˜¯DexTypeIdåˆ—è¡¨çš„ç´¢å¼•ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨åé¢å–å››å­—èŠ‚å°±æ˜¯valueäº†ï¼Œå€¼ä¸º0x11Dï¼Œç„¶åæ ¹æ®ç´¢å¼•å€¼æŸ¥æ‰¾å³å¯ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/10.png"></p><h4 id="2-8-1-2-DexFieldAnnotationsItem"><a href="#2-8-1-2-DexFieldAnnotationsItem" class="headerlink" title="2.8.1.2 DexFieldAnnotationsItem"></a>2.8.1.2 DexFieldAnnotationsItem</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;field_annotations_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexFieldAnnotationsItem</span> &#123;<br>    u4  fieldIdx;<span class="hljs-comment">/* æŒ‡å‘DexFieldIdåˆ—è¡¨çš„ç´¢å¼•å€¼ */</span><br>    u4  annotationsOff;             <span class="hljs-comment">/* DexAnnotationSetItemçš„æ–‡ä»¶åç§»é‡ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>DexAnnotationSetItemç»“æ„åœ¨<code>2.8.1.1</code>ä¸­è§£æè¿‡ï¼Œä¸å†é‡å¤ã€‚</p><h4 id="2-8-1-3-DexMethodAnnotationsItem"><a href="#2-8-1-3-DexMethodAnnotationsItem" class="headerlink" title="2.8.1.3 DexMethodAnnotationsItem"></a>2.8.1.3 DexMethodAnnotationsItem</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;method_annotations_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexMethodAnnotationsItem</span> &#123;<br>    u4  methodIdx;<span class="hljs-comment">/* æŒ‡å‘DexMethodIdåˆ—è¡¨çš„ç´¢å¼•å€¼ */</span><br>    u4  annotationsOff;             <span class="hljs-comment">/* DexAnnotationSetItemçš„æ–‡ä»¶åç§»é‡ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>DexAnnotationSetItemç»“æ„åœ¨<code>2.8.1.1</code>ä¸­è§£æè¿‡ï¼Œä¸å†é‡å¤ã€‚</p><h4 id="2-8-1-4-DexParameterAnnotationsItem"><a href="#2-8-1-4-DexParameterAnnotationsItem" class="headerlink" title="2.8.1.4 DexParameterAnnotationsItem"></a>2.8.1.4 DexParameterAnnotationsItem</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;parameter_annotations_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexParameterAnnotationsItem</span> &#123;<br>    u4  methodIdx;<span class="hljs-comment">/* æŒ‡å‘DexMethodIdåˆ—è¡¨çš„ç´¢å¼•å€¼ */</span><br>    u4  annotationsOff;             <span class="hljs-comment">/* DexAnotationSetRefListçš„æ–‡ä»¶åç§»é‡ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­DexAnotationSetRefListç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;annotation_set_ref_list&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexAnnotationSetRefList</span> &#123;<br>    u4  size;<span class="hljs-comment">/* åˆ—è¡¨ä¸­å…ƒç´ ä¸ªæ•°ï¼Œå³DexAnnotationSetRefItemçš„ä¸ªæ•° */</span><br>    DexAnnotationSetRefItem list[<span class="hljs-number">1</span>];<span class="hljs-comment">/* ç¬¬ä¸€ä¸ªDexAnnotationSetRefItemçš„å†…å®¹ï¼Œéåç§»é‡ */</span><br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;annotation_set_ref_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexAnnotationSetRefItem</span> &#123;<br>    u4  annotationsOff;             <span class="hljs-comment">/* DexAnnotationSetItemçš„åç§»é‡ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆåˆç»•å›åˆ°äº†DexAnnotationSetItemç»“æ„ä½“ã€‚</p><h3 id="2-8-2-DexClassData"><a href="#2-8-2-DexClassData" class="headerlink" title="2.8.2 DexClassData"></a>2.8.2 DexClassData</h3><p>DexClassDataç»“æ„çš„å£°æ˜åœ¨DexClass.hæ–‡ä»¶ä¸­ï¼Œè¯¥ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* expanded form of class_data_item. Note: If a particular item is</span><br><span class="hljs-comment"> * absent (e.g., no static fields), then the corresponding pointer</span><br><span class="hljs-comment"> * is set to NULL. */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexClassData</span> &#123;<br>    DexClassDataHeader header;<span class="hljs-comment">/* æŒ‡å®šå­—æ®µä¸æ–¹æ³•çš„ä¸ªæ•°çš„DexClassDataHeaderç»“æ„ä½“ */</span><br>    DexField*          staticFields;<span class="hljs-comment">/* é™æ€å­—æ®µï¼ŒDexFieldç»“æ„ä½“ */</span><br>    DexField*          instanceFields;<span class="hljs-comment">/* å®ä¾‹å­—æ®µï¼ŒDexFieldç»“æ„ä½“ */</span><br>    DexMethod*         directMethods;<span class="hljs-comment">/* ç›´æ¥æ–¹æ³•ï¼ŒDexMethodç»“æ„ä½“ */</span><br>    DexMethod*         virtualMethods;<span class="hljs-comment">/* è™šæ–¹æ³•ï¼ŒDexMethodç»“æ„ä½“ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ¥ç€åˆ†æDexClassDataHeaderã€DexFieldã€DexMethodç»“æ„ä½“ã€‚</p><h4 id="2-8-2-1-DexClassDataHeader"><a href="#2-8-2-1-DexClassDataHeader" class="headerlink" title="2.8.2.1 DexClassDataHeader"></a>2.8.2.1 DexClassDataHeader</h4><p>è¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* expanded form of a class_data_item header */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexClassDataHeader</span> &#123;<br>    u4 staticFieldsSize;<span class="hljs-comment">/* é™æ€å­—æ®µä¸ªæ•° */</span><br>    u4 instanceFieldsSize;<span class="hljs-comment">/* å®ä¾‹å­—æ®µä¸ªæ•° */</span><br>    u4 directMethodsSize;<span class="hljs-comment">/* ç›´æ¥æ–¹æ³•ä¸ªæ•° */</span><br>    u4 virtualMethodsSize;<span class="hljs-comment">/* è™šæ–¹æ³•ä¸ªæ•° */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªå±æ€§éƒ½æ˜¯ç»™DexClassDataç»“æ„ä½“ä¸­çš„ä¸‹é¢å››ä¸ªç»“æ„ä½“åšè¾…åŠ©ï¼Œæ–¹ä¾¿å®šä½æŸ¥æ‰¾ã€‚</p><blockquote><p><span style="color:red"><strong>è¯·æ³¨æ„ï¼DexClass.hæ–‡ä»¶ä¸­æ‰€æœ‰ç»“æ„ä½“çš„u4ç±»å‹å…¶å®éƒ½æ˜¯uleb128ç±»å‹ï¼ï¼ï¼</strong></span></p></blockquote><h4 id="2-8-2-2-DexField"><a href="#2-8-2-2-DexField" class="headerlink" title="2.8.2.2 DexField"></a>2.8.2.2 DexField</h4><p>è¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* expanded form of encoded_field */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexField</span> &#123;<br>    u4 fieldIdx;    <span class="hljs-comment">/* æŒ‡å‘DexFieldIdçš„ç´¢å¼• */</span><br>    u4 accessFlags;<span class="hljs-comment">/* è®¿é—®æ ‡å¿— */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­accessFlagså­—æ®µä¸DexClassDefä¸­çš„ç›¸åº”å­—æ®µçš„ç±»å‹ç›¸åŒã€‚</p><h4 id="2-8-2-3-DexMethod"><a href="#2-8-2-3-DexMethod" class="headerlink" title="2.8.2.3 DexMethod"></a>2.8.2.3 DexMethod</h4><p>DexMethodç»“æ„ä½“æè¿°æ–¹æ³•çš„åŸå‹ã€åç§°ã€è®¿é—®æ ‡å¿—ä»¥åŠä»£ç æ•°æ®å—ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* expanded form of encoded_method */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexMethod</span> &#123;<br>    u4 methodIdx;    <span class="hljs-comment">/* æŒ‡å‘DexMethodIdçš„ç´¢å¼• */</span><br>    u4 accessFlags;<span class="hljs-comment">/* è®¿é—®æ ‡å¿— */</span><br>    u4 codeOff;    <span class="hljs-comment">/* DexCodeç»“æ„çš„æ–‡ä»¶åç§»é‡ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­codeOffæŒ‡å‘DexCodeç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ç”¨äºè¿›ä¸€æ­¥æè¿°æ–¹æ³•æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ä»¥åŠæ–¹æ³•ä¸­çš„æŒ‡ä»¤ï¼Œè¯¥ç»“æ„ä½“åœ¨DexFile.hæ–‡ä»¶ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;code_item&quot;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The &quot;catches&quot; table is used when throwing an exception,</span><br><span class="hljs-comment"> * &quot;debugInfo&quot; is used when displaying an exception stack trace or</span><br><span class="hljs-comment"> * debugging. An offset of zero indicates that there are no entries.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexCode</span> &#123;<br>    u2  registersSize;<span class="hljs-comment">/* ä½¿ç”¨çš„å¯„å­˜å™¨ä¸ªæ•° */</span><br>    u2  insSize;<span class="hljs-comment">/* å‚æ•°ä¸ªæ•° */</span><br>    u2  outsSize;<span class="hljs-comment">/* è°ƒç”¨å…¶ä»–æ–¹æ³•æ—¶ä½¿ç”¨çš„å¯„å­˜å™¨ä¸ªæ•° */</span><br>    u2  triesSize;<span class="hljs-comment">/* try_itemçš„ä¸ªæ•° */</span><br>    u4  debugInfoOff;       <span class="hljs-comment">/* æŒ‡å‘è°ƒè¯•ä¿¡æ¯çš„æ–‡ä»¶åç§»é‡ */</span><br>    u4  insnsSize;          <span class="hljs-comment">/* æŒ‡ä»¤é›†ä¸ªæ•°ï¼Œä»¥2å­—èŠ‚ä¸ºå•ä½ */</span><br>    u2  insns[<span class="hljs-number">1</span>];<span class="hljs-comment">/* æŒ‡ä»¤é›†ï¼Œinsns æ•°ç»„ä¸­çš„ä»£ç æ ¼å¼ç”±éšé™„æ–‡æ¡£ Dalvik å­—èŠ‚ç æŒ‡å®š */</span><br>    <span class="hljs-comment">/* å¦‚æœ triesSize ä¸ä¸ºé›¶ï¼Œä¸‹é¢å­˜åœ¨*/</span><br>    <span class="hljs-comment">/* ä¸¤å­—èŠ‚å¡«å……ï¼Œä½¿ä¸‹é¢çš„try_itemå®ç°4å­—èŠ‚å¯¹é½ */</span><br>    <span class="hljs-comment">/* followed by try_item[triesSize]ï¼Œç”¨äºè¡¨ç¤ºä»£ç ä¸­æ•è·å¼‚å¸¸çš„ä½ç½®ä»¥åŠå¦‚ä½•å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†çš„æ•°ç»„ */</span><br>    <span class="hljs-comment">/* followed by uleb128 handlersSize */</span><br>    <span class="hljs-comment">/* followed by catch_handler_item[handlersSize]ï¼Œç”¨äºè¡¨ç¤ºâ€œæ•è·ç±»å‹åˆ—è¡¨å’Œå…³è”å¤„ç†ç¨‹åºåœ°å€â€çš„åˆ—è¡¨çš„å­—èŠ‚ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æœ‰æ›´ä¸ºç»†èŠ‚çš„ç»“æ„ï¼Œä½†ä¸å†æ·±å…¥ï¼Œå…ˆåœ¨è¿™é‡Œåœä¸€åœã€‚ï¼ˆåµŒå¥—çš„ä¹Ÿå¤ªæ·±äº†å§ï¼ğŸ¥²ï¼‰</p><h3 id="2-8-3-DexEncodedArray"><a href="#2-8-3-DexEncodedArray" class="headerlink" title="2.8.3 DexEncodedArray"></a>2.8.3 DexEncodedArray</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;encoded_array&quot;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">NOTE:</span> this structure is byte-aligned.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexEncodedArray</span> &#123;<br>    u1  array[<span class="hljs-number">1</span>];                   <span class="hljs-comment">/* encoded_arrayæ ¼å¼çš„æ•°æ® */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è§£é‡Šencoded_arrayæ ¼å¼ã€‚</p><h4 id="2-8-3-1-encoded-arrayæ ¼å¼"><a href="#2-8-3-1-encoded-arrayæ ¼å¼" class="headerlink" title="2.8.3.1 encoded_arrayæ ¼å¼"></a>2.8.3.1 encoded_arrayæ ¼å¼</h4><p>è¯¥æ ¼å¼å®šä¹‰å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">åç§°</th><th align="left">æ ¼å¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">size</td><td align="left">uleb128</td><td align="left">è¡¨ç¤ºæ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡</td></tr><tr><td align="left">values</td><td align="left">encoded_value[size]</td><td align="left">é‡‡ç”¨encoded_valueç¼–ç çš„æ•°æ®</td></tr></tbody></table><p>DexEncodedArrayéƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œä¸”encoded_valueç¼–ç åœ¨2.8.1.1å°èŠ‚å®ä¾‹åˆ†æè¿‡ï¼Œè¿™é‡Œä¸å†é‡å¤ã€‚</p><h2 id="2-9-DexMapList"><a href="#2-9-DexMapList" class="headerlink" title="2.9 DexMapList"></a>2.9 DexMapList</h2><p>Dalvikè™šæ‹Ÿæœºè§£ædexæ–‡ä»¶çš„å†…å®¹åï¼Œæœ€ç»ˆå°†å…¶æ˜ å°„æˆDexMapListæ•°æ®ç»“æ„ã€‚DexMapListç”±DexHeaderä¸­çš„mapOffå­—æ®µæŒ‡æ˜ï¼Œè¯¥ç»“æ„ä½“çš„å®šä¹‰åœ¨DexFile.hæ–‡ä»¶ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;map_list&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexMapList</span> &#123;<br>    u4  size;               <span class="hljs-comment">/* DexMapItemä¸ªæ•° */</span><br>    DexMapItem list[<span class="hljs-number">1</span>];     <span class="hljs-comment">/* DexMapItemæ•°ç»„ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>DexMapItemç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Direct-mapped &quot;map_item&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DexMapItem</span> &#123;<br>    u2 type;              <span class="hljs-comment">/* KDexTypeå¼€å¤´çš„ç±»å‹ */</span><br>    u2 unused;  <span class="hljs-comment">/* æœªä½¿ç”¨ï¼Œç”¨äºå­—èŠ‚å¯¹é½ */</span><br>    u4 size;              <span class="hljs-comment">/* ç±»å‹çš„ä¸ªæ•° */</span><br>    u4 offset;            <span class="hljs-comment">/* ç±»å‹æ•°æ®çš„æ–‡ä»¶åç§» */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå­—æ®µtypeæ˜¯ä¸€ä¸ªæšä¸¾å¸¸é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œé€šè¿‡ç±»å‹åç§°å¾ˆå®¹æ˜“åˆ¤æ–­å®ƒçš„å…·ä½“ç±»å‹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* map item type codes */</span><br><span class="hljs-keyword">enum</span> &#123;<br>    kDexTypeHeaderItem               = <span class="hljs-number">0x0000</span>,<br>    kDexTypeStringIdItem             = <span class="hljs-number">0x0001</span>,<br>    kDexTypeTypeIdItem               = <span class="hljs-number">0x0002</span>,<br>    kDexTypeProtoIdItem              = <span class="hljs-number">0x0003</span>,<br>    kDexTypeFieldIdItem              = <span class="hljs-number">0x0004</span>,<br>    kDexTypeMethodIdItem             = <span class="hljs-number">0x0005</span>,<br>    kDexTypeClassDefItem             = <span class="hljs-number">0x0006</span>,<br>    kDexTypeCallSiteIdItem           = <span class="hljs-number">0x0007</span>,<br>    kDexTypeMethodHandleItem         = <span class="hljs-number">0x0008</span>,<br>    kDexTypeMapList                  = <span class="hljs-number">0x1000</span>,<br>    kDexTypeTypeList                 = <span class="hljs-number">0x1001</span>,<br>    kDexTypeAnnotationSetRefList     = <span class="hljs-number">0x1002</span>,<br>    kDexTypeAnnotationSetItem        = <span class="hljs-number">0x1003</span>,<br>    kDexTypeClassDataItem            = <span class="hljs-number">0x2000</span>,<br>    kDexTypeCodeItem                 = <span class="hljs-number">0x2001</span>,<br>    kDexTypeStringDataItem           = <span class="hljs-number">0x2002</span>,<br>    kDexTypeDebugInfoItem            = <span class="hljs-number">0x2003</span>,<br>    kDexTypeAnnotationItem           = <span class="hljs-number">0x2004</span>,<br>    kDexTypeEncodedArrayItem         = <span class="hljs-number">0x2005</span>,<br>    kDexTypeAnnotationsDirectoryItem = <span class="hljs-number">0x2006</span>,<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªå­—æ®µsizeæŒ‡å®šäº†ç‰¹å®šç±»å‹çš„ä¸ªæ•°ï¼Œå®ƒä»¬ä»¥ç‰¹å®šçš„ç±»å‹åœ¨dexæ–‡ä»¶ä¸­è¿ç»­å­˜æ”¾ã€‚ç¬¬ä¸‰ä¸ªå­—æ®µoffsetåˆ™æ˜¯è¯¥ç±»å‹çš„æ–‡ä»¶èµ·å§‹åç§»åœ°å€ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯ç»“åˆå®ä¾‹å…·ä½“åˆ†æã€‚åœ¨å¤§çº¢æ¡†ä¸­çš„æ˜¯DexMapListç»“æ„ï¼Œå¯ä»¥çœ‹å‡ºä¸€å…±æœ‰11ä¸ªDexMapItemï¼Œæ‹¿map_item[1]è¿›è¡Œåˆ†æï¼Œtypeçš„å€¼ä¸º0x0001ï¼Œå¯¹åº”kDexTypeStringIdItemï¼Œä¹Ÿå°±æ˜¯å¯¹åº”string_id_itemç±»å‹ï¼Œsizeçš„å€¼ä¸º0x52F4ï¼ˆåè¿›åˆ¶21236ï¼‰ï¼Œæ­£å¥½ä¸string_id_itemçš„ä¸ªæ•°ç›¸åŒï¼ˆå›¾ä¸­å°çº¢æ¡†ä¸­ï¼Œç´¢å¼•å€¼ä»0å¼€å§‹ï¼‰ï¼Œæœ€åæ˜¯offsetçš„å€¼ä¸º0x70ï¼Œå¯¹åº”string_idsç»“æ„çš„æ–‡ä»¶åç§»é‡ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/11.png"></p><h1 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h1><p>æ•´ä¸ªdexæ–‡ä»¶åˆ†ä¸ºdex_headerã€string_idsã€type_idsã€proto_idsã€field_idsã€method_idsã€class_defsã€map_listè¿™8éƒ¨åˆ†ã€‚è™½ç„¶åˆ†äº†è¿™ä¹ˆå¤šå—ï¼Œä½†å®ƒä»¬ä¹‹é—´çš„è”ç³»éå¸¸ç´§å¯†ï¼Œå…¶ä¸­map_listæŒ‡æ˜äº†å„éƒ¨åˆ†çš„å¤§å°å’Œæ–‡ä»¶åç§»é‡ã€‚æ‰€æœ‰çš„å¸¸é‡å’Œå­—ç¬¦ä¸²éƒ½åœ¨string_idsä¸­ï¼Œå…¶ä»–éƒ¨åˆ†éœ€è¦é€šè¿‡ç´¢å¼•åœ¨string_idsä¸­æŸ¥æ‰¾æ‰èƒ½è·å¾—å…·ä½“çš„æ•°æ®ã€‚</p><p>æ•´ä¸ªdexæ–‡ä»¶ä¸­æœ€å¤æ‚çš„è¿˜å¾—æ˜¯class_defséƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†ç»“æ„å¤ªå¤šäº†ï¼ŒåµŒå¥—çš„å¤ªæ·±äº†ï¼Œéœ€è¦æ—¥ååœ¨æ·±å…¥è¯¥éƒ¨åˆ†ï¼Œç„¶åè¡¥å……è¯¥éƒ¨åˆ†çŸ¥è¯†ã€‚</p><p>ç›®å‰éå¸¸æœ‰å¿…è¦åšçš„äº‹æƒ…å°±æ˜¯ç¼–å†™dexæ–‡ä»¶åˆ†æä»£ç æ¥åŠ æ·±è¿™æ–¹é¢çš„çŸ¥è¯†ï¼</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://source.android.google.cn/docs/core/dalvik/dex-format?hl=zh-cn">Dalvik å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼  | Android å¼€æºé¡¹ç›®  | Android Open Source Project (google.cn)</a></p><p><a href="https://source.android.google.cn/docs/core/runtime/dalvik-bytecode?hl=zh-cn">Dalvik å­—èŠ‚ç   | Android å¼€æºé¡¹ç›®  | Android Open Source Project (google.cn)</a></p><p><a href="https://cloud.tencent.com/developer/article/2065063">dexæ–‡ä»¶è§£æ(ç¬¬ä¸‰ç¯‡)ã€Œå»ºè®®æ”¶è—ã€-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p><p>[<a href="https://bbs.kanxue.com/thread-203417.htm">åŸåˆ›]androidä¸­Dexæ–‡ä»¶ç»“æ„è¯¦è§£-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>dex</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidä¸­çš„Dalvikå’ŒARTè™šæ‹Ÿæœº</title>
    <link href="/2023/09/13/Android%E4%B8%AD%E7%9A%84Dalvik%E5%92%8CART%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    <url>/2023/09/13/Android%E4%B8%AD%E7%9A%84Dalvik%E5%92%8CART%E8%99%9A%E6%8B%9F%E6%9C%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="Dalvik"><a href="#Dalvik" class="headerlink" title="Dalvik"></a>Dalvik</h1><p>Dalvikè™šæ‹Ÿæœºï¼ˆDalvik Virtual Machineï¼‰ï¼Œç®€ç§° DVMï¼Œæ˜¯ Google ä¸“é—¨ä¸º Android å¹³å°å¼€å‘çš„è™šæ‹Ÿæœºï¼Œå®ƒè¿è¡Œåœ¨ Android è¿è¡Œæ—¶åº“ä¸­ã€‚</p><h2 id="DVM-ä¸-JVM-çš„åŒºåˆ«"><a href="#DVM-ä¸-JVM-çš„åŒºåˆ«" class="headerlink" title="DVM ä¸ JVM çš„åŒºåˆ«"></a>DVM ä¸ JVM çš„åŒºåˆ«</h2><ul><li><p><strong>æ¶æ„ä¸åŒ</strong></p><p>JVMåŸºäºæ ˆæ¶æ„ï¼Œéœ€è¦é¢‘ç¹åœ°ä»æ ˆä¸Šè¯»å†™æ•°æ®ï¼Œå› æ­¤éœ€è¦æ›´å¤šçš„æŒ‡ä»¤åˆ†æ´¾å’Œå†…å­˜è®¿é—®æ¬¡æ•°ï¼Œè¿™æ ·å°±ä¼šè€—è´¹ä¸å°‘ CPU æ—¶é—´ã€‚</p><p>DVMåŸºäºå¯„å­˜å™¨æ¶æ„ï¼Œæ•°æ®çš„è®¿é—®é€šè¿‡å¯„å­˜å™¨é—´çš„ç›´æ¥ä¼ é€’ï¼Œç›¸æ¯”åŸºäºæ ˆçš„æ–¹å¼æ›´å¿«ã€‚</p></li><li><p><strong>æ‰§è¡Œçš„å­—èŠ‚ç ä¸åŒ</strong></p><p>ä¼ ç»Ÿçš„ Java ç¨‹åºç»è¿‡ç¼–è¯‘ç”Ÿæˆ Java å­—èŠ‚ç ä¿å­˜åœ¨ class æ–‡ä»¶ä¸­ï¼ŒJVM é€šè¿‡è§£é‡Š class æ–‡ä»¶æ¥è¿è¡Œç¨‹åºã€‚</p><p>è€Œ DVM ä¼šå°†æ‰€æœ‰ class æ–‡ä»¶è½¬æ¢æˆä¸€ä¸ª dex æ–‡ä»¶ï¼ˆå­˜å‚¨ Dalvik å­—èŠ‚ç ï¼‰ï¼ŒDVMé€šè¿‡è§£é‡Š dex æ–‡ä»¶æ¥æ‰§è¡Œç¨‹åºã€‚</p></li><li><p><strong>dexæ–‡ä»¶ä½“ç§¯æ›´å°</strong></p><p>javaå­—èŠ‚ç è½¬æ¢åˆ°Dalvikå­—èŠ‚ç çš„è¿‡ç¨‹ä¸­ï¼Œä¼šç”¨åˆ°dxå·¥å…·ã€‚è¯¥å·¥å…·ä¼šå¯¹æ‰€æœ‰çš„Javaç±»æ–‡ä»¶ä¸­çš„å¸¸é‡æ± è¿›è¡Œåˆ†è§£ï¼Œæ¶ˆé™¤å…¶ä¸­çš„å†—ä½™ä¿¡æ¯ï¼Œé‡æ–°ç»„æˆä¸€ä¸ªå¸¸é‡æ± ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/pic/jar%E5%92%8Cdex%E7%9A%84%E5%B7%AE%E5%BC%82.png" alt="jarå’Œdexçš„å·®å¼‚"></p></li><li><p><strong>DVMå…è®¸åœ¨æœ‰é™çš„å†…å­˜ä¸­åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹</strong></p><p> DVMç»è¿‡ä¼˜åŒ–ï¼Œå…è®¸åœ¨æœ‰é™çš„å†…å­˜ä¸­åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ã€‚åœ¨Androidä¸­çš„æ¯ä¸€ä¸ªåº”ç”¨éƒ½è¿è¡Œåœ¨ä¸€ä¸ªDVMå®ä¾‹ä¸­ï¼Œæ¯ä¸€ä¸ªDVMå®ä¾‹éƒ½è¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´ã€‚ç‹¬ç«‹çš„è¿›ç¨‹å¯ä»¥é˜²æ­¢åœ¨è™šæ‹Ÿæœºå´©æºƒçš„æ—¶å€™æ‰€æœ‰ç¨‹åºéƒ½è¢«å…³é—­ã€‚</p></li><li><p><strong>DVMç”±Zygoteåˆ›å»ºå’Œåˆå§‹åŒ–</strong></p><p>Zygoteæ˜¯ä¸€ä¸ªDVMè¿›ç¨‹ï¼ŒåŒæ—¶ä¹Ÿç”¨æ¥åˆ›å»ºå’Œåˆå§‹åŒ–DVMå®ä¾‹ã€‚æ¯å½“ç³»ç»Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¶ï¼ŒZygoteå°±ä¼šfockè‡ªèº«ï¼Œå¿«é€Ÿçš„åˆ›å»ºå’Œåˆå§‹åŒ–ä¸€ä¸ªDVMå®ä¾‹ï¼Œç”¨äºåº”ç”¨ç¨‹åºçš„è¿è¡Œã€‚å¯¹äºä¸€äº›åªè¯»çš„ç³»ç»Ÿåº“ï¼Œæ‰€æœ‰çš„DVMå®ä¾‹éƒ½ä¼šå’ŒZygoteå…±äº«ä¸€å—å†…å­˜åŒºåŸŸã€‚</p></li><li><p><strong>DVMæœ‰å…±äº«æœºåˆ¶</strong></p><p>DVMæ‹¥æœ‰é¢„åŠ è½½-å…±äº«çš„æœºåˆ¶ï¼Œä¸åŒåº”ç”¨ä¹‹é—´åœ¨è¿è¡Œæ—¶å¯ä»¥å…±äº«ç›¸åŒçš„ç±»ï¼Œæ‹¥æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚è€ŒJVMä¸å­˜åœ¨è¿™ç§å…±äº«æœºåˆ¶ï¼Œä¸åŒçš„ç¨‹åºéƒ½æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ï¼Œæ— æ³•è¿›è¡Œå…±äº«ã€‚</p></li></ul><h2 id="DVMçš„è¿è¡Œæ—¶å †"><a href="#DVMçš„è¿è¡Œæ—¶å †" class="headerlink" title="DVMçš„è¿è¡Œæ—¶å †"></a>DVMçš„è¿è¡Œæ—¶å †</h2><p>DVMçš„è¿è¡Œæ—¶å †ä¸»è¦ç”±ä¸¤ä¸ªSpaceä»¥åŠå¤šä¸ªè¾…åŠ©æ•°æ®ç»“æ„ç»„æˆï¼Œä¸¤ä¸ªSpaceåˆ†åˆ«æ˜¯Zygote Spaceï¼ˆZygote Heapï¼‰å’ŒAllocation Spaceï¼ˆActive Heapï¼‰ã€‚Zygote Spaceç”¨æ¥ç®¡ç†Zygoteè¿›ç¨‹åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­é¢„åŠ è½½å’Œåˆ›å»ºçš„å„ç§å¯¹è±¡ï¼ŒZygote Spaceä¸­ä¸ä¼šè§¦å‘GCï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½å…±äº«è¯¥åŒºåŸŸï¼Œæ¯”å¦‚ç³»ç»Ÿèµ„æºã€‚Allocation Spaceæ˜¯åœ¨Zygoteè¿›ç¨‹forkç¬¬ä¸€ä¸ªå­è¿›ç¨‹ä¹‹å‰åˆ›å»ºçš„ï¼Œä»¥åçš„å¯¹è±¡éƒ½ä¼šåœ¨Allocation Spaceä¸Šè¿›è¡Œåˆ†é…å’Œé‡Šæ”¾ã€‚<strong>Allocation Spaceä¸æ˜¯è¿›ç¨‹é—´å…±äº«çš„ï¼Œåœ¨æ¯ä¸ªè¿›ç¨‹ä¸­éƒ½ç‹¬ç«‹æ‹¥æœ‰ä¸€ä»½</strong>ã€‚é™¤äº†è¿™ä¸¤ä¸ªSpaceï¼Œè¿˜åŒ…å«ä»¥ä¸‹æ•°æ®ç»“æ„ï¼š</p><ul><li>Card Tableï¼šç”¨äºDVM Concurrent GCï¼Œå½“ç¬¬ä¸€æ¬¡è¿›è¡Œåƒåœ¾æ ‡è®°åï¼Œè®°å½•åƒåœ¾ä¿¡æ¯ã€‚</li><li>Heap Bitmapï¼šæœ‰ä¸¤ä¸ªHeap Bitmapï¼Œä¸€ä¸ªç”¨æ¥è®°å½•ä¸Šæ¬¡GCå­˜æ´»çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªç”¨æ¥è®°å½•è¿™æ¬¡GCå­˜æ´»çš„å¯¹è±¡ã€‚</li><li>Mark Stackï¼šDVMçš„è¿è¡Œæ—¶å †ä½¿ç”¨æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰ç®—æ³•è¿›è¡ŒGCï¼ŒMark Stackå°±æ˜¯åœ¨GCçš„æ ‡è®°é˜¶æ®µä½¿ç”¨çš„ï¼Œå®ƒç”¨æ¥éå†å­˜æ´»çš„å¯¹è±¡ã€‚</li></ul><p><img src="/pic/DVM%E8%BF%90%E8%A1%8C%E6%97%B6%E5%A0%86.png" alt="DVMè¿è¡Œæ—¶å †"></p><h1 id="ART"><a href="#ART" class="headerlink" title="ART"></a>ART</h1><p>åœ¨Android5.0ç‰ˆæœ¬ï¼ŒARTï¼ˆAndroid Runtimeï¼‰è™šæ‹Ÿæœºå®Œå…¨æ›¿ä»£äº†DVMã€‚</p><h2 id="ARTå’ŒDVMçš„åŒºåˆ«"><a href="#ARTå’ŒDVMçš„åŒºåˆ«" class="headerlink" title="ARTå’ŒDVMçš„åŒºåˆ«"></a>ARTå’ŒDVMçš„åŒºåˆ«</h2><ul><li>DVMä¸­åº”ç”¨æ¯æ¬¡è¿è¡Œæ—¶ï¼Œéƒ½è¦è¿›è¡Œ JIT ç¼–è¯‘ï¼ˆJust In Time Compilationï¼Œå³æ—¶ç¼–è¯‘ï¼‰ã€‚è€Œåœ¨ARTä¸­ï¼Œç³»ç»Ÿåœ¨å®‰è£…åº”ç”¨ç¨‹åºæ—¶ä¼šè¿›è¡Œä¸€æ¬¡AOTç¼–è¯‘ï¼ˆAhead Of Time Compilationï¼Œé¢„ç¼–è¯‘ï¼‰ï¼Œå°†å­—èŠ‚ç é¢„å…ˆç¼–è¯‘æˆæœºå™¨ç å¹¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œè¿™æ ·åº”ç”¨ç¨‹åºæ¯æ¬¡è¿è¡Œæ—¶å°±ä¸éœ€è¦å†ç¼–è¯‘äº†ï¼Œä½†è¿™ä¹Ÿä¼šé€ æˆåº”ç”¨ç¨‹åºçš„å®‰è£…æ—¶é—´å˜é•¿ï¼Œæ‰€å å­˜å‚¨ç©ºé—´å˜å¤šã€‚å› æ­¤åœ¨Android7.0ç‰ˆæœ¬ä¸­ï¼ŒARTåŠ å…¥äº† JIT ç¼–è¯‘ï¼Œä½œä¸ºAOTçš„ä¸€ä¸ªè¡¥å……ï¼Œåœ¨åº”ç”¨ç¨‹åºå®‰è£…æ—¶å¹¶ä¸ä¼šå°†å­—èŠ‚ç å…¨éƒ¨ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯å°†çƒ­ç‚¹ä»£ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œä»è€Œç¼©çŸ­åº”ç”¨ç¨‹åºçš„å®‰è£…æ—¶é—´å¹¶èŠ‚çœäº†å­˜å‚¨ç©ºé—´ã€‚</li><li>DVMåªæ”¯æŒ32ä½CPUï¼Œè€ŒARTæ”¯æŒ64ä½å¹¶å…¼å®¹32ä½CPUã€‚</li><li>ARTå¯¹åƒåœ¾å›æ”¶æœºåˆ¶è¿›è¡Œäº†æ”¹è¿›ï¼Œæ¯”å¦‚æ›´é¢‘ç¹åœ°æ‰§è¡Œå¹¶è¡Œåƒåœ¾æ”¶é›†ã€‚</li><li>ARTçš„è¿è¡Œæ—¶å †ç©ºé—´åˆ’åˆ†å’ŒDVMä¸åŒã€‚</li></ul><h2 id="ARTçš„è¿è¡Œæ—¶å †"><a href="#ARTçš„è¿è¡Œæ—¶å †" class="headerlink" title="ARTçš„è¿è¡Œæ—¶å †"></a>ARTçš„è¿è¡Œæ—¶å †</h2><p>ARTçš„è¿è¡Œæ—¶å †ä¸»è¦ç”±å››ä¸ªSpaceå’Œå¤šä¸ªè¾…åŠ©æ•°æ®ç»“æ„ç»„æˆï¼Œå››ä¸ªSpaceåˆ†åˆ«æ˜¯Zygote Spaceã€Allocation Spaceã€Image Spaceã€Large Object Spaceã€‚Zygote Spaceå’ŒAllocation Spaceçš„ä½œç”¨åŒDVMä¸­çš„ä¸€è‡´ï¼ŒImage Spaceç”¨æ¥å­˜æ”¾ä¸€äº›é¢„åŠ è½½ç±»ï¼ŒLarge Object Spaceç”¨æ¥åˆ†é…ä¸€äº›å¤§å¯¹è±¡ï¼Œå…¶ä¸­Zygote Spaceå’ŒImage Spaceæ˜¯è¿›ç¨‹é—´å…±äº«çš„ã€‚è¾…åŠ©æ•°æ®ç»“æ„åŒ…æ‹¬ä¸¤ä¸ªMod Union Tableã€ä¸€ä¸ªCard Tableã€ä¸¤ä¸ªHeap Bitmapã€ä¸¤ä¸ªObject Mapã€ä¸‰ä¸ªObject Stackã€‚</p><p><img src="/pic/ART%E8%BF%90%E8%A1%8C%E6%97%B6%E5%A0%86.png" alt="ARTè¿è¡Œæ—¶å †"></p><hr><p>å‚è€ƒï¼š</p><p><a href="http://liuwangshu.cn/application/performance/ram-1-dvm-art.html">Androidå†…å­˜ä¼˜åŒ–ï¼ˆä¸€ï¼‰DVMå’ŒARTåŸç†åˆæ¢ | BATcoder - åˆ˜æœ›èˆ’ (liuwangshu.cn)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20230913æ—¥æŠ¥</title>
    <link href="/2023/09/13/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/13%E6%97%A5%E6%8A%A5/"/>
    <url>/2023/09/13/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/13%E6%97%A5%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<p>å»¶ç»­æ˜¨å¤©çš„DVMå’ŒARTçš„å­¦ä¹ ç¬”è®°ï¼Œç„¶ååˆå­¦ä¹ äº†apkçš„æ‰“åŒ…æµç¨‹ï¼Œä¹‹åæ˜¯apkçš„å®‰è£…æµç¨‹æºç åˆ†æï¼Œæ²¡æƒ³åˆ°è¿™éƒ¨åˆ†å¾ˆé•¿å¾ˆé•¿ï¼Œå¯ä»¥æŠŠè¿™éƒ¨åˆ†åˆ†ä¸º3éƒ¨åˆ†ï¼š</p><ol><li>PackageInstalleråº”ç”¨çš„åˆå§‹åŒ–ï¼Œè¿™éƒ¨åˆ†åœ¨UIç•Œé¢ä¸Šä½“ç°å°±æ˜¯æˆ‘ä»¬å¸¸çœ‹åˆ°çš„å®‰è£…ç¡®è®¤ç•Œé¢ï¼ŒåŒ…å«éœ€è¦ä½¿ç”¨åˆ°çš„æƒé™ä¿¡æ¯ç­‰ã€‚</li><li>PackageInstallerå®‰è£…apkï¼Œè¿™éƒ¨åˆ†å¹¶ä¸æ˜¯çœŸæ­£çš„å®‰è£…ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªæ³¨å†Œä¸€ä¸ªInstallEventReceiverè§‚å¯Ÿè€… ï¼Œç”¨äºæ¥å—å®‰è£…æˆåŠŸå’Œå¤±è´¥çš„å›è°ƒï¼Œç„¶åé€šè¿‡è°ƒç”¨PackageInstaller.Sessionçš„commitæ–¹æ³•ï¼Œäº¤ç”±PMSæ¥å®‰è£…ã€‚</li><li>PMSå®‰è£…apkã€‚</li></ol><p>çœ‹ä¸å®Œï¼Œæ ¹æœ¬çœ‹ä¸å®Œï¼</p>]]></content>
    
    
    <categories>
      
      <category>æ—¥æŠ¥</category>
      
      <category>2023å¹´09æœˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¥æŠ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20230912æ—¥æŠ¥</title>
    <link href="/2023/09/12/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/12%E6%97%A5%E6%8A%A5/"/>
    <url>/2023/09/12/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/12%E6%97%A5%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©è·Ÿç€ä¹¦ç±å­¦ä¹ äº†ä¸€ä¸‹DVMã€ARTä»¥åŠsmaliè¯­æ³•ï¼Œåå¤çœ‹äº†ä¸¤ä¸‰éï¼Œä½†è¯´å®åœ¨çš„ï¼Œè‚¯å®šè¿˜æ˜¯è®°ä¸ä½çš„ã€‚ç„¶åä¹Ÿæ˜¯å¯¹è¿™éƒ¨åˆ†å­¦ä¹ å†™åšå®¢ï¼Œåªå®Œæˆäº†smaliè¯­æ³•çš„å­¦ä¹ ç¬”è®°ï¼ŒDVMå’ŒARTçš„éƒ¨åˆ†æ‰æ„æ€äº†ä¸€ç‚¹ï¼Œå†™æ–‡ç« æŒºè´¹æ—¶é—´çš„ï¼Œä½†æ˜¯å¿…é¡»å¾—å†™ï¼Œä¸èƒ½å…»æˆæƒ°æ€§ï¼</p>]]></content>
    
    
    <categories>
      
      <category>æ—¥æŠ¥</category>
      
      <category>2023å¹´09æœˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¥æŠ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>smaliè¯­æ³•å­¦ä¹ </title>
    <link href="/2023/09/12/smali%E8%AF%AD%E6%B3%95%E6%91%98%E5%BD%95/"/>
    <url>/2023/09/12/smali%E8%AF%AD%E6%B3%95%E6%91%98%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ç±»å‹"><a href="#ä¸€ã€ç±»å‹" class="headerlink" title="ä¸€ã€ç±»å‹"></a>ä¸€ã€ç±»å‹</h1><p>Dalvik å­—èŠ‚ç åªæœ‰ä¸¤ç§ç±»å‹ï¼ŒåŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹ã€‚Dalvik ä½¿ç”¨è¿™ä¸¤ç§ç±»å‹æ¥è¡¨ç¤º Java è¯­è¨€çš„å…¨éƒ¨ç±»å‹ï¼Œé™¤äº†å¯¹è±¡ä¸æ•°ç»„å±äºå¼•ç”¨å¯¹è±¡å¤–ï¼Œå…¶ä»–çš„ Java ç±»å‹éƒ½æ˜¯åŸºæœ¬ç±»å‹ã€‚</p><table><thead><tr><th align="center">è¯­æ³•</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">V</td><td align="center">voidï¼Œåªç”¨äºè¿”å›å€¼ç±»å‹</td></tr><tr><td align="center">Z</td><td align="center">boolean</td></tr><tr><td align="center">B</td><td align="center">byte</td></tr><tr><td align="center">S</td><td align="center">short</td></tr><tr><td align="center">C</td><td align="center">char</td></tr><tr><td align="center">I</td><td align="center">int</td></tr><tr><td align="center">J</td><td align="center">long</td></tr><tr><td align="center">F</td><td align="center">float</td></tr><tr><td align="center">D</td><td align="center">double</td></tr><tr><td align="center">L</td><td align="center">Javaç±»ç±»å‹</td></tr><tr><td align="center">[</td><td align="center">æ•°ç»„ç±»å‹</td></tr></tbody></table><p><strong>æ¯ä¸ª Dalvik å¯„å­˜å™¨éƒ½æ˜¯ 32 ä½å¤§å°</strong>ï¼Œå¯¹äºè¶…è¿‡ 32 ä½çš„ï¼Œæ¯”å¦‚ Jã€D ç±»å‹ï¼Œå®ƒä»¬å°±éœ€è¦ä½¿ç”¨ä¸¤ä¸ªç›¸é‚»çš„å¯„å­˜å™¨ï¼ˆ<strong>å¯„å­˜å™¨å¯¹</strong>ï¼‰æ¥å­˜å‚¨å€¼ã€‚</p><p>è¿™é‡Œå¯¹äºæœ€åä¸¤ä¸ªç±»å‹è¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚</p><p>L ç±»å‹è¡¨ç¤º Java ç±»å‹ä¸­çš„ä»»ä½•ç±»ã€‚è¿™äº›ç±»åœ¨ Java ä»£ç ä¸­ä»¥ <code>package.name.ObjectName</code>æ–¹æ³•å¼•ç”¨ï¼Œä½†åœ¨ Dalvik æ±‡ç¼–ä»£ç ä¸­ï¼Œç±»ä»¥ <code>Lpackage/name/ObjectName; </code>å½¢å¼è¡¨ç¤ºï¼Œæ³¨æ„æœ€åé¢æœ‰ä¸ªåˆ†å·ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>javaä¸­<br>java.lang.String<br><span class="hljs-regexp">//</span>Dalvikä¸­<br>Ljava<span class="hljs-regexp">/lang/</span>String;<br></code></pre></td></tr></table></figure><p>[ ç±»å‹è¡¨ç¤ºæ‰€æœ‰åŸºæœ¬ç±»å‹çš„æ•°ç»„ã€‚[ åé¢ç´§è·ŸåŸºæœ¬ç±»å‹æè¿°ç¬¦ï¼Œä¾‹å¦‚ <code>[I</code> è¡¨ç¤º int ç±»å‹çš„ä¸€ç»´æ•°ç»„ï¼Œç›¸å½“äº Java ä¸­çš„ <code>int[]</code>ã€‚å¤šç»´æ•°ç»„çš„è¡¨ç¤ºåˆ™æ˜¯ä½¿ç”¨å¤šä¸ªå¤šä¸ª [ ï¼Œä¾‹å¦‚<code>[[I</code>è¡¨ç¤º<code>int[][]</code>ã€‚</p><p>L ä¸ [ å¯ä»¥åŒæ—¶ä½¿ç”¨æ¥è¡¨ç¤ºå¯¹è±¡æ•°ç»„ã€‚å¦‚ <code>[Ljava.lang.String;</code>è¡¨ç¤ºJavaä¸­çš„å­—ç¬¦ä¸²æ•°ç»„ã€‚</p><h1 id="äºŒã€æ–¹æ³•"><a href="#äºŒã€æ–¹æ³•" class="headerlink" title="äºŒã€æ–¹æ³•"></a>äºŒã€æ–¹æ³•</h1><p>Dalvik ä½¿ç”¨æ–¹æ³•åã€ç±»å‹å‚æ•°ä¸è¿”å›å€¼æ¥è¯¦ç»†æè¿°ä¸€ä¸ªæ–¹æ³•ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼š</p><ol><li>æ–¹ä¾¿ Dalvik è™šæ‹Ÿæœºåœ¨è¿è¡Œæ—¶ä»æ–¹æ³•è¡¨ä¸­å¿«é€Ÿåœ°æ‰¾åˆ°æ­£ç¡®çš„æ–¹æ³•</li><li>Dalvik è™šæ‹Ÿæœºå¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥åšä¸€äº›é™æ€åˆ†æï¼Œæ¯”å¦‚ Dalvik å­—èŠ‚ç çš„éªŒè¯ä¸ä¼˜åŒ–ã€‚</li></ol><p>æ–¹æ³•çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">L<span class="hljs-function"><span class="hljs-title">package</span>/<span class="hljs-keyword">name</span>/ObjectName;-&gt;</span>MethodName(III)Z<br></code></pre></td></tr></table></figure><p><code>Lpackage/name/ObjectName;</code>è¡¨ç¤ºç±»ï¼Œ<code>MethodName</code>è¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•ï¼Œ<code>(III)Z</code>æ˜¯æ–¹æ³•çš„ç­¾åéƒ¨åˆ†ï¼Œæ‹¬å·ä¸­çš„<code>III</code>è¡¨ç¤ºå‚æ•°ï¼ˆåœ¨è¿™é‡Œå…·ä½“ä¸ºä¸‰ä¸ªæ•´å‹å‚æ•°ï¼‰ï¼Œ<code>Z</code>è¡¨ç¤ºæ–¹æ³•çš„è¿”å›ç±»å‹ï¼ˆåœ¨è¿™é‡Œå…·ä½“ä¸ºå¸ƒå°”å‹ï¼‰ã€‚</p><p>æ¥ä¸€ä¸ªå¤æ‚çš„ä¾‹å­ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">.method <span class="hljs-keyword">public</span> M(I[[IILjava<span class="hljs-regexp">/lang/</span>String;[Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>String<br></code></pre></td></tr></table></figure><p>å¯¹åº” Java ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> <span class="hljs-built_in">String</span> <span class="hljs-title function_">M</span>(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>[][], <span class="hljs-type">int</span>, <span class="hljs-built_in">String</span>, <span class="hljs-built_in">Object</span>[])<br></code></pre></td></tr></table></figure><p>æ–¹æ³•ä»£ç ä»¥<code>.method</code>æŒ‡ä»¤å¼€å§‹ï¼Œä»¥<code> .end method</code>æŒ‡ä»¤ç»“æŸã€‚åœ¨<code>.method</code>æŒ‡ä»¤åé¢ä¼šè·Ÿéš<code>.registers num</code>è¡¨ç¤ºä½¿ç”¨åˆ°çš„å¯„å­˜å™¨ä¸ªæ•°ä¸º num ä¸ªï¼Œ<code>.parameter</code>æŒ‡å®šå‡½æ•°çš„ä¸€ä¸ªå‚æ•°ï¼Œ<code>.prologue</code>æŒ‡å®šå‡½æ•°ä»£ç çš„èµ·å§‹ä½ç½® ã€‚</p><h1 id="ä¸‰ã€å­—æ®µ"><a href="#ä¸‰ã€å­—æ®µ" class="headerlink" title="ä¸‰ã€å­—æ®µ"></a>ä¸‰ã€å­—æ®µ</h1><p>å­—æ®µä¸æ–¹æ³•å¾ˆç›¸ä¼¼ï¼Œåªæ˜¯å­—æ®µæ²¡æœ‰æ–¹æ³•ç­¾ååŸŸçš„å‚æ•°å’Œè¿”å›å€¼ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å­—æ®µçš„ç±»å‹ã€‚å­—æ®µæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">Lpackage<span class="hljs-regexp">/name/</span>ObjectName;-&gt;FieldName:Ljava<span class="hljs-regexp">/lang/</span>String;<br></code></pre></td></tr></table></figure><p>å­—æ®µç”±ç±»å‹ï¼ˆ<code>Lpackage/name/ObjectName;</code>ï¼‰ã€å­—æ®µåï¼ˆ<code>FieldName</code>ï¼‰ä¸å­—æ®µç±»å‹ï¼ˆ<code>Ljava/lang/String;</code>ï¼‰ç»„æˆï¼Œå¹¶ç”¨<code>:</code>å°†å­—æ®µåå’Œå­—æ®µç±»å‹éš”å¼€ã€‚</p><p>å­—æ®µä»£ç ä»¥<code>.field</code>æŒ‡ä»¤å¼€å¤´ã€‚</p><h1 id="å››ã€å¯„å­˜å™¨å‘½åæ–¹æ³•"><a href="#å››ã€å¯„å­˜å™¨å‘½åæ–¹æ³•" class="headerlink" title="å››ã€å¯„å­˜å™¨å‘½åæ–¹æ³•"></a>å››ã€å¯„å­˜å™¨å‘½åæ–¹æ³•</h1><p>vå‘½åæ³•ï¼šé‡‡ç”¨ä»¥<code>v</code>å¼€å¤´çš„æ–¹å¼è¡¨ç¤ºå‡½æ•°ä¸­ç”¨åˆ°çš„å±€éƒ¨å˜é‡å’Œå‚æ•°ï¼Œæ‰€æœ‰çš„å¯„å­˜å™¨å‘½åä» v0 å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ã€‚</p><p>på‘½åæ³•ï¼šé‡‡ç”¨ä»¥<code>p</code>å¼€å¤´çš„æ–¹å¼è¡¨ç¤ºå‡½æ•°ä¸­å¼•å…¥å‚æ•°ï¼Œä» p0 å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ã€‚ä½†å¯¹å‡½æ•°çš„å±€éƒ¨å˜é‡å¯„å­˜å™¨çš„å‘½åæ²¡æœ‰å½±å“ï¼Œå³ä»ç„¶ä½¿ç”¨ v å‘½åæ³•ã€‚</p><h1 id="äº”ã€æŒ‡ä»¤é›†"><a href="#äº”ã€æŒ‡ä»¤é›†" class="headerlink" title="äº”ã€æŒ‡ä»¤é›†"></a>äº”ã€æŒ‡ä»¤é›†</h1><h2 id="æŒ‡ä»¤ç‰¹ç‚¹"><a href="#æŒ‡ä»¤ç‰¹ç‚¹" class="headerlink" title="æŒ‡ä»¤ç‰¹ç‚¹"></a>æŒ‡ä»¤ç‰¹ç‚¹</h2><p>Dalvik æŒ‡ä»¤åœ¨è°ƒç”¨æ ¼å¼ä¸Šæ¨¡ä»¿äº† C è¯­è¨€çš„è°ƒç”¨çº¦å®šã€‚Dalvik æŒ‡ä»¤çš„è¯­æ³•å’ŒåŠ©è¯ç¬¦æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>å‚æ•°é‡‡ç”¨ä»ç›®æ ‡ï¼ˆdestinationï¼‰åˆ°æºï¼ˆsourceï¼‰çš„æ–¹å¼ã€‚</li><li>æ ¹æ®å­—èŠ‚ç çš„å¤§å°ä¸ç±»å‹ä¸åŒï¼Œä¸€äº›å­—èŠ‚ç æ·»åŠ äº†åç§°åç¼€ä»¥æ¶ˆé™¤æ­§ä¹‰ã€<ul><li>32ä½å¸¸è§„ç±»å‹çš„å­—èŠ‚ç ä¸æ·»åŠ ä»»ä½•åç¼€ã€‚</li><li>64ä½å¸¸è§„ç±»å‹çš„å­—èŠ‚ç æ·»åŠ  <code>-wide</code>åç¼€ã€‚</li><li>ç‰¹æ®Šç±»å‹çš„å­—èŠ‚ç æ ¹æ®å…·ä½“ç±»å‹æ·»åŠ åç¼€ã€‚å®ƒä»¬å¯ä»¥æ˜¯ <code>-boolean</code>ã€<code>-byte</code>ã€<code>-char</code>ã€<code>-short</code>ã€<code>-int</code>ã€<code>-long</code>ã€<code>-float</code>ã€<code>-double</code>ã€<code>-object</code>ã€<code>-string</code>ã€<code>-class</code>ã€<code>-void</code>ä¹‹ä¸€ã€‚</li></ul></li><li>æ ¹æ®å­—èŠ‚ç çš„å¸ƒå±€å’Œé€‰é¡¹ä¸åŒï¼Œä¸€äº›å­—èŠ‚ç æ·»åŠ äº†å­—èŠ‚ç åç¼€ä»¥æ¶ˆé™¤æ­§ä¹‰ã€‚è¿™äº›åç¼€é€šè¿‡åœ¨å­—èŠ‚ç ä¸»åç§°åæ·»åŠ <code>/</code>æ¥åˆ†éš”ã€‚</li></ul><p><strong>çº¦å®šï¼šåœ¨æŒ‡ä»¤é›†çš„æè¿°ä¸­ï¼Œå®½åº¦å€¼ä¸­æ¯ä¸ªå­—æ¯è¡¨ç¤ºå®½åº¦ä¸º4ä½ã€‚ä¾‹å¦‚</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">move-wide/from16 vAA,VBBBB<br></code></pre></td></tr></table></figure><p><strong>æ ¹æ®çº¦å®šï¼ŒvAAçš„å–å€¼èŒƒå›´ä½v0~v255ï¼›vBBBBçš„å–å€¼èŒƒå›´ä¸ºv0~v65535ã€‚ä»¥ä¸‹è°ˆåˆ°çš„å¯„å­˜å™¨å–å€¼ã€ä½æ•°ã€èŒƒå›´éƒ½æ˜¯æŒ‡å¯„å­˜å™¨ç¼–å·ã€‚</strong></p><h2 id="æ•°æ®å®šä¹‰æŒ‡ä»¤"><a href="#æ•°æ®å®šä¹‰æŒ‡ä»¤" class="headerlink" title="æ•°æ®å®šä¹‰æŒ‡ä»¤"></a>æ•°æ®å®šä¹‰æŒ‡ä»¤</h2><p>å£°æ˜å˜é‡ï¼ŒåŸºç¡€å­—èŠ‚ç ä¸º constã€‚</p><ul><li>const[&#x2F;4&#x2F;16&#x2F;high16] vA, xxï¼šè¡¨ç¤ºå°† xx èµ‹å€¼ç»™å¯„å­˜å™¨ vAã€‚<code>[]</code>è¡¨ç¤ºå¯é€‰å†…å®¹ï¼Œæ ¹æ® xx çš„é•¿åº¦é€‰æ‹©ï¼Œæ¯”å¦‚16ä½çš„å°±é€‰<code>/16</code>ï¼Œ32ä½å°±ä¸é€‰ã€‚<code>/high16</code>åˆ™æ˜¯å– xx çš„é«˜16ä½ï¼Œå³æ‰©å±•æˆ32ä½ã€‚</li><li>const-wide[&#x2F;16&#x2F;32&#x2F;high16] vA, xxï¼šè¡¨ç¤ºå°† xx èµ‹å€¼ç»™å¯„å­˜å™¨å¯¹vAã€‚</li><li>const-string[&#x2F;jumbo] vA, string@xxxxï¼šé€šè¿‡å­—ç¬¦ä¸²ç´¢å¼•ï¼ˆstring@xxxxï¼‰æ„é€ ä¸€ä¸ªå­—ç¬¦ä¸²ç»™å¯„å­˜å™¨ vAã€‚å­—ç¬¦ä¸²ç´¢å¼•è¾ƒå¤§æ—¶ä¼šæ·»åŠ æŒ‡ä»¤åç¼€<code>/jumbo</code>ã€‚</li><li>const-class[&#x2F;jumbo] vA, type@xxxxï¼šé€šè¿‡ç±»å‹ç´¢å¼•è·å–ä¸€ä¸ªç±»å‹å¼•ç”¨å¹¶èµ‹ç»™å¯„å­˜å™¨ vAã€‚</li></ul><h2 id="æ•°æ®æ“ä½œæŒ‡ä»¤"><a href="#æ•°æ®æ“ä½œæŒ‡ä»¤" class="headerlink" title="æ•°æ®æ“ä½œæŒ‡ä»¤"></a>æ•°æ®æ“ä½œæŒ‡ä»¤</h2><p>æ•°æ®æ“ä½œæŒ‡ä»¤ä¸ºmoveã€‚</p><ul><li>move[&#x2F;16&#x2F;from16] vA, vBï¼šå¯„å­˜å™¨èµ‹å€¼ï¼Œå°† vB å¯„å­˜å™¨çš„å€¼èµ‹å€¼ç»™ vA å¯„å­˜å™¨ã€‚æŒ‡ä»¤åç¼€<code>/16</code>è¡¨ç¤ºæºå¯„å­˜å™¨å’Œç›®çš„å¯„å­˜å™¨éƒ½æ˜¯16ä½ã€‚æŒ‡ä»¤åç¼€<code>/from16</code>è¡¨ç¤ºæºå¯„å­˜å™¨ä½16ä½ï¼Œç›®çš„å¯„å­˜å™¨ä¸º8ä½ã€‚</li><li>mov-wide[&#x2F;from16] vA, vBï¼šå¯„å­˜å™¨å¯¹èµ‹å€¼ã€‚</li><li>move-object[&#x2F;16&#x2F;from16] vA, vBï¼šå¯¹è±¡èµ‹å€¼ã€‚</li><li>move-result vAï¼šå°†ä¸Šä¸€ä¸ª invoke ç±»å‹æŒ‡ä»¤æ“ä½œçš„å•å­—éå¯¹è±¡ç»“æœèµ‹ç»™ vA å¯„å­˜å™¨ã€‚</li><li>move-result-wide vAï¼šå°†ä¸Šä¸€ä¸ª invoke ç±»å‹æŒ‡ä»¤æ“ä½œçš„åŒå­—éå¯¹è±¡ç»“æœèµ‹ç»™ vA å¯„å­˜å™¨ã€‚</li><li>move-result-object vAï¼šå°†ä¸Šä¸€ä¸ª invoke ç±»å‹æŒ‡ä»¤æ“ä½œçš„å¯¹è±¡ç»“æœèµ‹ç»™ vA å¯„å­˜å™¨ã€‚</li><li>move-exception vAï¼šä½¿ç”¨ vA å¯„å­˜å™¨ä¿å­˜ä¸€ä¸ªè¿è¡Œæ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚è¿™æ¡æŒ‡ä»¤å¿…é¡»æ˜¯å¼‚å¸¸å‘ç”Ÿæ—¶çš„å¼‚å¸¸å¤„ç†å™¨çš„ä¸€æ¡æŒ‡ä»¤ï¼Œå¦åˆ™è¯¥æŒ‡ä»¤æ— æ•ˆã€‚</li></ul><h2 id="æ•°æ®è½¬æ¢æŒ‡ä»¤"><a href="#æ•°æ®è½¬æ¢æŒ‡ä»¤" class="headerlink" title="æ•°æ®è½¬æ¢æŒ‡ä»¤"></a>æ•°æ®è½¬æ¢æŒ‡ä»¤</h2><p>æ•°æ®è½¬æ¢æŒ‡ä»¤ç”¨äºå°†ä¸€ç§ç±»å‹çš„æ•°å€¼è½¬æ¢æˆå¦ä¸€ç§ç±»å‹ã€‚ä»–çš„æ ¼å¼ä¸º<code>unop vA, vB</code>ï¼Œåè€…å­˜æ”¾éœ€è¦è½¬æ¢çš„æ•°æ®ï¼Œè½¬æ¢åçš„ç»“æœä¿å­˜åœ¨ vA å¯„å­˜å™¨ï¼ˆæˆ– vA å¯„å­˜å™¨å¯¹ï¼‰ä¸­ã€‚</p><ul><li>æ±‚è¡¥æŒ‡ä»¤<code>neg-xxx</code>ï¼šå¦‚ <code>neg-int</code> è¡¨ç¤ºå¯¹æ•´å‹æ•°æ±‚è¡¥ï¼Œ<code>neg-long</code>è¡¨ç¤ºå¯¹é•¿æ•´å‹æ•°æ±‚è¡¥ã€‚</li><li>æ±‚åæŒ‡ä»¤<code>not-xxx</code>ï¼šå¦‚ <code>not-int</code> è¡¨ç¤ºå¯¹æ•´å‹æ•°æ±‚åï¼Œ<code>not-long</code>è¡¨ç¤ºå¯¹é•¿æ•´å‹æ•°æ±‚åã€‚</li><li>æ•°æ®ç±»å‹è½¬æ¢æŒ‡ä»¤<code>xxx-to-xxx</code>ï¼šå¦‚<code>int-to-float</code>è¡¨ç¤ºå°†æ•´å‹æ•°è½¬æˆå•ç²¾åº¦æµ®ç‚¹å‹ï¼Œ<code>double-to-long</code>è¡¨ç¤ºå°†åŒç²¾åº¦æµ®ç‚¹å‹æ•°è½¬æˆé•¿æ•´å‹ã€‚<code>int</code>å‹é¢å¤–è¿˜æœ‰<code>int-to-byte</code>ã€<code>int-to-char</code>ã€<code>int-to-short</code>æŒ‡ä»¤ã€‚</li></ul><h2 id="æ•°æ®è¿ç®—æŒ‡ä»¤"><a href="#æ•°æ®è¿ç®—æŒ‡ä»¤" class="headerlink" title="æ•°æ®è¿ç®—æŒ‡ä»¤"></a>æ•°æ®è¿ç®—æŒ‡ä»¤</h2><p>æ•°æ®è¿ç®—æŒ‡ä»¤æœ‰å¦‚ä¸‹å››ç±»ï¼š</p><ul><li>binop vA, vB, vCï¼šå°† vB å¯„å­˜å™¨ä¸ vC å¯„å­˜å™¨è¿›è¡Œè¿ç®—ï¼Œç»“æœä¿å­˜åˆ° vA å¯„å­˜å™¨ä¸­ã€‚</li><li>binop&#x2F;2addr vA, vBï¼šå°† vA å¯„å­˜å™¨ä¸ vB å¯„å­˜å™¨è¿›è¡Œè¿ç®—ï¼Œç»“æœä¿å­˜åˆ° vA å¯„å­˜å™¨ä¸­ã€‚æŒ‡ä»¤åç¼€<code>/2addr</code>è¡¨ç¤ºä½¿ç”¨ä¸¤åœ°å€ï¼ˆå³ä¸¤ä¸ªå¯„å­˜å™¨ï¼‰çš„å½¢å¼è¿›è¡Œè¿ç®—ã€‚</li><li>binop&#x2F;lit16 vA, vB, xxï¼šå°† vB å¯„å­˜å™¨ä¸å¸¸é‡xx è¿›è¡Œè¿ç®—ï¼Œç»“æœä¿å­˜åˆ° vA å¯„å­˜å™¨ä¸­ã€‚æŒ‡ä»¤åç¼€<code>/lit16</code>æŒ‡æ˜å¸¸é‡æ˜¯16ä½çš„ã€‚</li><li>binop&#x2F;lit8 vA, vB, xxï¼šå°† vB å¯„å­˜å™¨ä¸å¸¸é‡xx è¿›è¡Œè¿ç®—ï¼Œç»“æœä¿å­˜åˆ° vA å¯„å­˜å™¨ä¸­ã€‚æŒ‡ä»¤åç¼€<code>/lit8</code>æŒ‡æ˜å¸¸é‡æ˜¯8ä½çš„ã€‚</li></ul><p>å…¶ä¸­ binop ä»£æŒ‡å¦‚ä¸‹è¿ç®—æŒ‡ä»¤ï¼š</p><table><thead><tr><th align="center">è¿ç®—æŒ‡ä»¤</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">add-type</td><td align="center">åŠ æ³•è¿ç®—ï¼Œåç¼€-typeä»£æŒ‡-intã€-longã€-floatã€-doubleã€‚</td></tr><tr><td align="center">sub-type</td><td align="center">å‡æ³•è¿ç®—</td></tr><tr><td align="center">mul-type</td><td align="center">ä¹˜æ³•è¿ç®—</td></tr><tr><td align="center">div-type</td><td align="center">é™¤æ³•è¿ç®—</td></tr><tr><td align="center">rem-type</td><td align="center">æ¨¡è¿ç®—</td></tr><tr><td align="center">and-type</td><td align="center">ä¸è¿ç®—</td></tr><tr><td align="center">or-type</td><td align="center">æˆ–è¿ç®—</td></tr><tr><td align="center">xor-type</td><td align="center">å¼‚æˆ–è¿ç®—</td></tr><tr><td align="center">shl-type</td><td align="center">æœ‰ç¬¦å·æ•°å·¦ç§»</td></tr><tr><td align="center">shr-type</td><td align="center">æœ‰ç¬¦å·æ•°å³ç§»</td></tr><tr><td align="center">ushr-type</td><td align="center">æ— ç¬¦å·æ•°å³ç§»</td></tr></tbody></table><h2 id="è·³è½¬æŒ‡ä»¤"><a href="#è·³è½¬æŒ‡ä»¤" class="headerlink" title="è·³è½¬æŒ‡ä»¤"></a>è·³è½¬æŒ‡ä»¤</h2><p>DalvikæŒ‡ä»¤é›†ä¸­æœ‰ä¸‰ç§è·³è½¬æŒ‡ä»¤ï¼šæ— æ¡ä»¶è·³è½¬ï¼ˆgotoï¼‰ã€åˆ†æ”¯è·³è½¬ï¼ˆswitchï¼‰ã€æ¡ä»¶è·³è½¬ï¼ˆifï¼‰ã€‚</p><h3 id="æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤"><a href="#æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤" class="headerlink" title="æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤"></a>æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤</h3><ul><li>goto xxx</li><li>goto&#x2F;16 xxx</li><li>goto&#x2F;32 xxx</li></ul><p>æŒ‡ä»¤åç¼€æ ¹æ®ç”±åç§»é‡ xxx çš„ä½æ•°å†³å®šï¼Œåç§»é‡ä¸èƒ½ä¸º0ã€‚</p><h3 id="åˆ†æ”¯è·³è½¬æŒ‡ä»¤"><a href="#åˆ†æ”¯è·³è½¬æŒ‡ä»¤" class="headerlink" title="åˆ†æ”¯è·³è½¬æŒ‡ä»¤"></a>åˆ†æ”¯è·³è½¬æŒ‡ä»¤</h3><ul><li>packed-switch vA, xxxï¼švA å¯„å­˜å™¨ä¸º switch åˆ†æ”¯ä¸­éœ€è¦åˆ¤æ–­çš„å€¼ï¼Œxxx æŒ‡å‘ä¸€ä¸ª <code>packed-switch-payload</code> æ ¼å¼çš„åç§»è¡¨ï¼ˆswitchæ±‡ç¼–ä¸­å¯¹åº”çš„çš„å°è¡¨ï¼Ÿï¼‰ï¼Œè¡¨ä¸­çš„å€¼æ˜¯æœ‰è§„å¾‹é€’å¢çš„ã€‚</li><li>sparse-switch vA, xxxï¼švA å¯„å­˜å™¨ä¸º switch åˆ†æ”¯ä¸­éœ€è¦åˆ¤æ–­çš„å€¼ï¼Œxxx æŒ‡å‘ä¸€ä¸ª <code>sparse-switch-payload</code> æ ¼å¼çš„åç§»è¡¨ï¼Œè¡¨ä¸­çš„å€¼æ˜¯æ— è§„å¾‹çš„åç§»é‡ã€‚</li></ul><h3 id="æ¡ä»¶è·³è½¬æŒ‡ä»¤"><a href="#æ¡ä»¶è·³è½¬æŒ‡ä»¤" class="headerlink" title="æ¡ä»¶è·³è½¬æŒ‡ä»¤"></a>æ¡ä»¶è·³è½¬æŒ‡ä»¤</h3><p>æœ‰ä¸¤ç§æŒ‡ä»¤æ ¼å¼ï¼Œç¬¬ä¸€ç§æŒ‡ä»¤æ ¼å¼ä¸º<code>if-test vA, vB, xxxx</code>ï¼Œè¡¨ç¤ºæ¯”è¾ƒ vA å¯„å­˜å™¨å’Œ vB å¯„å­˜å™¨çš„å€¼ï¼Œå¦‚æœæ¯”è¾ƒç»“æœæ»¡è¶³å°±è·³è½¬åˆ°xxxxæŒ‡å®šçš„åç§»å¤„ï¼Œåç§»é‡ä¸èƒ½ä¸º0ã€‚<code>if-test</code>ä»£æŒ‡å¦‚ä¸‹æŒ‡ä»¤ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">if-eq</td><td align="center">å¦‚æœvA &#x3D; vBåˆ™è·³è½¬</td></tr><tr><td align="center">if-ne</td><td align="center">å¦‚æœvA !&#x3D; vBåˆ™è·³è½¬</td></tr><tr><td align="center">if-lt</td><td align="center">å¦‚æœvA &lt; vBåˆ™è·³è½¬</td></tr><tr><td align="center">if-ge</td><td align="center">å¦‚æœvA &gt;&#x3D; vBåˆ™è·³è½¬</td></tr><tr><td align="center">if-gt</td><td align="center">å¦‚æœvA &gt; vBåˆ™è·³è½¬</td></tr><tr><td align="center">if-le</td><td align="center">å¦‚æœvA &lt;&#x3D; vBåˆ™è·³è½¬</td></tr></tbody></table><p>ç¬¬äºŒç§æŒ‡ä»¤æ ¼å¼ä¸º<code>if-testz vA,xxxx</code>ï¼Œè¡¨ç¤ºæ‹¿ vA å¯„å­˜å™¨çš„å€¼ä¸ 0 æ¯”è¾ƒï¼Œå¦‚æœæ¯”è¾ƒç»“æœæ»¡è¶³å°±è·³è½¬åˆ°xxxxæŒ‡å®šçš„åç§»å¤„ï¼Œåç§»é‡ä¸èƒ½ä¸º0ã€‚<code>if-testz</code>ä»£æŒ‡çš„æŒ‡ä»¤åŒä¸Šï¼Œåªä¸è¿‡åé¢å¤šäº†ä¸€ä¸ª<code>z</code>ã€‚</p><h2 id="æ¯”è¾ƒæŒ‡ä»¤"><a href="#æ¯”è¾ƒæŒ‡ä»¤" class="headerlink" title="æ¯”è¾ƒæŒ‡ä»¤"></a>æ¯”è¾ƒæŒ‡ä»¤</h2><p>æ¯”è¾ƒæŒ‡ä»¤çš„æ ¼å¼ä¸º<code>cmp-type vA, VB, vC</code>ï¼Œè¡¨ç¤º vB å¯„å­˜å™¨(å¯¹)ä¸ vC å¯„å­˜å™¨(å¯¹)è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”è¾ƒçš„ç»“æœå­˜æ”¾åœ¨ vA å¯„å­˜å™¨ä¸­ã€‚<code>cmp-type</code>ä»£æŒ‡å¦‚ä¸‹æŒ‡ä»¤ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">cmpl-float</td><td align="center">æ¯”è¾ƒä¸¤ä¸ªå•ç²¾åº¦æµ®ç‚¹æ•°ã€‚å¦‚æœvB &gt; vCï¼Œåˆ™ç»“æœä¸º-1ï¼Œç›¸ç­‰ç»“æœä¸º0ï¼Œå°äºç»“æœä¸º1ã€‚</td></tr><tr><td align="center">cmpg-float</td><td align="center">æ¯”è¾ƒä¸¤ä¸ªå•ç²¾åº¦æµ®ç‚¹æ•°ã€‚å¦‚æœvB &gt; vCï¼Œåˆ™ç»“æœä¸º1ï¼Œç›¸ç­‰ç»“æœä¸º0ï¼Œå°äºç»“æœä¸º-1ã€‚</td></tr><tr><td align="center">cmpl-double</td><td align="center">æ¯”è¾ƒä¸¤ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ã€‚å¦‚æœvB &gt; vCï¼Œåˆ™ç»“æœä¸º-1ï¼Œç›¸ç­‰ç»“æœä¸º0ï¼Œå°äºç»“æœä¸º1</td></tr><tr><td align="center">cmpg-double</td><td align="center">æ¯”è¾ƒä¸¤ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ã€‚å¦‚æœvB &gt; vCï¼Œåˆ™ç»“æœä¸º1ï¼Œç›¸ç­‰ç»“æœä¸º0ï¼Œå°äºç»“æœä¸º-1ã€‚</td></tr><tr><td align="center">cmp-long</td><td align="center">æ¯”è¾ƒä¸¤ä¸ªé•¿æ•´å‹æ•°ã€‚å¦‚æœvB &gt; vCï¼Œåˆ™ç»“æœä¸º1ï¼Œç›¸ç­‰ç»“æœä¸º0ï¼Œå°äºç»“æœä¸º-1ã€‚</td></tr></tbody></table><h2 id="æ–¹æ³•è°ƒç”¨æŒ‡ä»¤"><a href="#æ–¹æ³•è°ƒç”¨æŒ‡ä»¤" class="headerlink" title="æ–¹æ³•è°ƒç”¨æŒ‡ä»¤"></a>æ–¹æ³•è°ƒç”¨æŒ‡ä»¤</h2><p>æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ä¸º invokeï¼Œè´Ÿè´£è°ƒç”¨ç±»å®ä¾‹çš„æ–¹æ³•ã€‚è¯¥æŒ‡ä»¤æœ‰ä¸¤ç§æ ¼å¼ï¼Œåˆ†åˆ«ä¸º<code>invoke-type &#123;vA,vB,...&#125;, method@xxx</code>å’Œ<code>invoke-type/range &#123;vA...VN&#125;, method@xxx</code> ã€‚ä¸¤ç§ç±»å‹çš„æŒ‡ä»¤åœ¨ä½œç”¨ä¸Šæ— åŒºåˆ«ï¼Œåªæ˜¯å‰è€…æœ€å¤šæ¥æ”¶5ä¸ªå‚æ•°ï¼Œå¤§äº5ä¸ªå‚æ•°çš„æ–¹æ³•åˆ™ä½¿ç”¨åè€…è°ƒç”¨ã€‚</p><p><code>invoke-type</code>ä»£æŒ‡å¦‚ä¸‹æŒ‡ä»¤ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">invoke-virtual</td><td align="center">è°ƒç”¨å®ä¾‹çš„è™šæ–¹æ³•</td></tr><tr><td align="center">invoke-super</td><td align="center">è°ƒç”¨å®ä¾‹çš„çˆ¶ç±»æ–¹æ³•</td></tr><tr><td align="center">invoke-direct</td><td align="center">è°ƒç”¨å®ä¾‹çš„ç›´æ¥æ–¹æ³•</td></tr><tr><td align="center">invoke-static</td><td align="center">è°ƒç”¨å®ä¾‹çš„é™æ€æ–¹æ³•</td></tr><tr><td align="center">inovke-interface</td><td align="center">è°ƒç”¨å®ä¾‹çš„æ¥å£æ–¹æ³•</td></tr></tbody></table><p>æ–¹æ³•è°ƒç”¨æŒ‡ä»¤çš„è¿”å›å€¼å¿…é¡»ä½¿ç”¨<code>move-result[åç¼€]</code>æŒ‡ä»¤è·å–ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali">invoke-virtual      &#123;v3, v0&#125;, <span class="hljs-class">Lcom/ciscn/glass/MainActivity;</span>-&gt;checkFlag(<span class="hljs-class">Ljava/lang/String;</span>)Z <span class="hljs-comment"># method@3c66</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">move-result </span>        v3<br></code></pre></td></tr></table></figure><h2 id="è¿”å›æŒ‡ä»¤"><a href="#è¿”å›æŒ‡ä»¤" class="headerlink" title="è¿”å›æŒ‡ä»¤"></a>è¿”å›æŒ‡ä»¤</h2><p>è¿”å›æŒ‡ä»¤ä¸ºreturnã€‚</p><ul><li>return-voidï¼šè¡¨ç¤ºå‡½æ•°ä»ä¸€ä¸ª void æ–¹æ³•è¿”å›ã€‚</li><li>return vAï¼šè¡¨ç¤ºå‡½æ•°è¿”å›ä¸€ä¸ª32ä½çš„éå¯¹è±¡ç±»å‹çš„å€¼ã€‚</li><li>return-wide vAï¼šè¡¨ç¤ºå‡½æ•°è¿”å›ä¸€ä¸ª64ä½çš„éå¯¹è±¡ç±»å‹çš„å€¼ã€‚</li><li>return-object vAï¼šè¡¨ç¤ºå‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„å€¼ã€‚</li></ul><h2 id="å­—æ®µæ“ä½œæŒ‡ä»¤"><a href="#å­—æ®µæ“ä½œæŒ‡ä»¤" class="headerlink" title="å­—æ®µæ“ä½œæŒ‡ä»¤"></a>å­—æ®µæ“ä½œæŒ‡ä»¤</h2><p>å­—æ®µæ“ä½œæŒ‡ä»¤ç”¨æ¥å¯¹å¯¹è±¡å®ä¾‹çš„å­—æ®µè¿›è¡Œè¯»å†™æ“ä½œã€‚å¯¹æ™®é€šå­—æ®µä¸é™æ€å­—æ®µæ“ä½œæœ‰ä¸¤ç§æŒ‡ä»¤é›†ï¼Œåˆ†åˆ«æ˜¯<code>iinstanceop vA, vB, field@xxx</code>å’Œ<code>sstaticop vA, field@xxx</code>ã€‚</p><p>æ™®é€šå­—æ®µæŒ‡ä»¤çš„æŒ‡ä»¤å‰ç¼€ä¸º<code>i</code>ï¼Œæ¯”å¦‚å¯¹æ™®é€šå­—æ®µçš„è¯»æ“ä½œä½¿ç”¨<code>iget</code>æŒ‡ä»¤ã€‚</p><p>é™æ€å­—æ®µæŒ‡ä»¤çš„æŒ‡ä»¤å‰ç¼€ä¸º<code>s</code>ï¼Œæ¯”å¦‚å¯¹é™æ€å­—æ®µçš„è¯»æ“ä½œä½¿ç”¨<code>sget</code>æŒ‡ä»¤ã€‚</p><p>æ ¹æ®è®¿é—®çš„å­—æ®µç±»å‹ä¸åŒï¼Œå­—æ®µæ“ä½œæŒ‡ä»¤åé¢ä¼šè·Ÿéšå­—æ®µç±»å‹çš„åç¼€ï¼Œæ¯”å¦‚<code>iget-byte</code>æŒ‡ä»¤ç­‰ã€‚</p><p>æ™®é€šå­—æ®µæ“ä½œæŒ‡ä»¤æœ‰ï¼ˆåªä¸¾ä¾‹getæ“ä½œï¼Œputæ“ä½œç›¸åŒï¼Œæ›¿æ¢getå³å¯ï¼‰ï¼šigetã€iget-wideã€iget-objectã€iget-booleanã€iget-byteã€iget-charã€iget-shortã€‚</p><p>é™æ€å­—æ®µæ“ä½œæŒ‡ä»¤æœ‰ï¼ˆåªä¸¾ä¾‹getæ“ä½œï¼Œputæ“ä½œç›¸åŒï¼Œæ›¿æ¢getå³å¯ï¼‰ï¼šsgetã€sget-wideã€sget-objectã€sget-booleanã€sget-byteã€sget-charã€sget-shortã€‚</p><h2 id="æ•°ç»„æ“ä½œæŒ‡ä»¤"><a href="#æ•°ç»„æ“ä½œæŒ‡ä»¤" class="headerlink" title="æ•°ç»„æ“ä½œæŒ‡ä»¤"></a>æ•°ç»„æ“ä½œæŒ‡ä»¤</h2><p>æ•°ç»„æ“ä½œåŒ…æ‹¬è·å–æ•°ç»„é•¿åº¦ã€æ–°å»ºæ•°ç»„ã€æ•°ç»„èµ‹å€¼ã€æ•°ç»„å…ƒç´ å–å€¼ä¸èµ‹å€¼ç­‰æ“ä½œã€‚</p><ul><li><p>array-length vA, vBï¼šè¡¨ç¤ºè·å– vB å¯„å­˜å™¨ä¸­æ•°ç»„çš„é•¿åº¦å¹¶å°†å€¼èµ‹å€¼ç»™ vA å¯„å­˜å™¨ã€‚</p></li><li><p>new-array vA, vB, type@xxxï¼šè¡¨ç¤ºæ„é€ æŒ‡å®šç±»å‹ï¼ˆtype@xxxï¼‰ä¸å¤§å°ï¼ˆvBï¼‰çš„æ•°ç»„ï¼Œå¹¶èµ‹å€¼ç»™ vA å¯„å­˜å™¨ã€‚å¯æ·»åŠ æŒ‡ä»¤åç¼€<code>/jumbo</code>ã€‚</p></li><li><p>filled-new-array {vC, vD, vE, vF, vG}, type@xxxï¼šæ„é€ æŒ‡å®šç±»å‹ï¼ˆtype@xxxï¼‰ä¸å¤§å°ï¼ˆvAï¼‰çš„æ•°ç»„å¹¶å¡«å……æ•°ç»„å†…å®¹ã€‚vA å¯„å­˜å™¨æ˜¯éšå¼ä½¿ç”¨çš„ï¼Œé™¤äº†æŒ‡å®šæ•°ç»„çš„å¤§å°ä»¥å¤–ï¼Œè¿˜æŒ‡å®šäº†å‚æ•°çš„ä¸ªæ•°ï¼ŒvC~vG æ˜¯ä½¿ç”¨åˆ°çš„å‚æ•°å¯„å­˜å™¨åºåˆ—ã€‚</p><p>å¯æ·»åŠ æŒ‡ä»¤åç¼€<code>/range</code>ï¼ŒåŠŸèƒ½ç›¸åŒï¼Œåªæ˜¯æŒ‡å®šäº†å‚æ•°å¯„å­˜å™¨çš„å–å€¼èŒƒå›´ã€‚</p><p>å¯æ·»åŠ æŒ‡ä»¤åç¼€<code>/jumbo</code>ã€‚</p></li><li><p>filled-array-data vA, xxxï¼šç”¨æŒ‡å®šçš„æ•°æ®æ¥å¡«å……æ•°ç»„ï¼Œæ•°ç»„å¿…é¡»ä¸ºåŸºæœ¬ç±»å‹çš„æ•°ç»„ã€‚</p></li><li><p>æ ¼å¼arrayop vA, vB, vCï¼šè¡¨ç¤ºå¯¹ vB å¯„å­˜å™¨æŒ‡å®šçš„æ•°ç»„å…ƒç´ è¿›è¡Œå–å€¼å’Œèµ‹å€¼ï¼Œå…¶ä¸­ vC å¯„å­˜å™¨æŒ‡å®šæ•°ç»„å…ƒç´ ç´¢å¼•ï¼ŒvA å¯„å­˜å™¨æŒ‡å®šç”¨æ¥å­˜æ”¾è¯»å–æˆ–éœ€è¦è®¾ç½®çš„æ•°ç»„å…ƒç´ çš„å€¼ã€‚<code>arrayop</code>æŒ‡<code>aget</code>å’Œ<code>aput</code>ä¸¤å¤§ç±»æŒ‡ä»¤ï¼Œæ ¼å¼ä¸å­—æ®µæ“ä½œæŒ‡ä»¤çš„ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†ä¸¾ä¾‹ã€‚</p></li></ul><h2 id="å®ä¾‹æ“ä½œæŒ‡ä»¤"><a href="#å®ä¾‹æ“ä½œæŒ‡ä»¤" class="headerlink" title="å®ä¾‹æ“ä½œæŒ‡ä»¤"></a>å®ä¾‹æ“ä½œæŒ‡ä»¤</h2><p>ä¸å®ä¾‹ç›¸å…³çš„æ“ä½œåŒ…æ‹¬å®ä¾‹çš„ç±»å‹è½¬æ¢ã€æ£€æŸ¥ã€æ–°å»ºç­‰ã€‚</p><ul><li>check-cast vA, type@xxxï¼šè¡¨ç¤ºå°† vA å¯„å­˜å™¨ä¸­çš„å¯¹è±¡å¼•ç”¨è½¬æ¢æˆæŒ‡å®šçš„ç±»å‹ã€‚</li><li>instance-of vA, vB, type@xxxï¼šè¡¨ç¤ºåˆ¤æ–­ vB å¯„å­˜å™¨ä¸­çš„å¯¹è±¡å¼•ç”¨æ˜¯å¦å¯ä»¥è½¬æˆæŒ‡å®šçš„ç±»å‹ï¼Œå¦‚æœå¯ä»¥åˆ™ç»™ vA å¯„å­˜å™¨èµ‹å€¼ä¸º1ï¼Œå¦åˆ™èµ‹å€¼ä¸º0ã€‚</li><li>new-instance vA, type@xxxï¼šè¡¨ç¤ºæ„é€ ä¸€ä¸ªæŒ‡å®šç±»å‹å¯¹è±¡çš„æ–°å®ä¾‹ï¼Œå¹¶å°†å¯¹è±¡å¼•ç”¨èµ‹å€¼ç»™ vA å¯„å­˜å™¨ï¼Œç±»å‹ç¬¦ type ä¸èƒ½æ˜¯æ•°ç»„ç±»ã€‚</li></ul><p>ä»¥ä¸ŠæŒ‡ä»¤éƒ½å¯ä»¥æ·»åŠ æŒ‡ä»¤åç¼€<code>/jumbo</code>ï¼ŒåŠŸèƒ½ä¸å˜ï¼Œåªæ˜¯å¯„å­˜å™¨å€¼ä¸æŒ‡ä»¤çš„ç´¢å¼•å–å€¼èŒƒå›´æ›´å¤§ã€‚</p><h2 id="é”æŒ‡ä»¤"><a href="#é”æŒ‡ä»¤" class="headerlink" title="é”æŒ‡ä»¤"></a>é”æŒ‡ä»¤</h2><p>é”æŒ‡ä»¤å¤šç”¨äºå¤šçº¿ç¨‹ç¨‹åºä¸­å¯¹åŒä¸€å¯¹è±¡çš„æ“ä½œã€‚Dalvik æŒ‡ä»¤é›†ä¸­æœ‰ä¸¤æ¡é”æŒ‡ä»¤ï¼š</p><ul><li>monitor-enter vAè¡¨ç¤ºè·å–æŒ‡å®šå¯¹è±¡çš„é”ã€‚</li><li>monitor-exit vAè¡¨ç¤ºé‡Šæ”¾æŒ‡å®šå¯¹è±¡çš„é”ã€‚</li></ul><h2 id="å¼‚å¸¸æŒ‡ä»¤"><a href="#å¼‚å¸¸æŒ‡ä»¤" class="headerlink" title="å¼‚å¸¸æŒ‡ä»¤"></a>å¼‚å¸¸æŒ‡ä»¤</h2><p>DalvikæŒ‡ä»¤é›†ä¸­æœ‰ä¸€æ¡æŒ‡ä»¤ç”¨äºæŠ›å‡ºå¼‚å¸¸ï¼š</p><ul><li>throw vAï¼šè¡¨ç¤ºæŠ›å‡º vA å¯„å­˜å™¨å­˜æ”¾çš„å¼‚å¸¸ã€‚</li></ul><h2 id="ç©ºæ“ä½œæŒ‡ä»¤"><a href="#ç©ºæ“ä½œæŒ‡ä»¤" class="headerlink" title="ç©ºæ“ä½œæŒ‡ä»¤"></a>ç©ºæ“ä½œæŒ‡ä»¤</h2><p>ç©ºæ“ä½œæŒ‡ä»¤ä¸º nopï¼Œä»–çš„æœºå™¨ç ä¸º 0x00ï¼ˆä¸PCç«¯çš„nop(0x90)ä¸åŒï¼‰ã€‚è¯¥æŒ‡ä»¤ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚</p><hr><p>å‚è€ƒï¼š</p><p>ã€ŠAndroidè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>smali</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20230911æ—¥æŠ¥</title>
    <link href="/2023/09/11/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/11%E6%97%A5%E6%8A%A5/"/>
    <url>/2023/09/11/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/11%E6%97%A5%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<p>å•¥ä¹Ÿæ²¡å¹²æˆçš„ä¸€å¤©ã€‚</p><p>å»¶ç»­æ˜¨å¤©çš„jebå·¥å…·çš„é—®é¢˜ï¼Œæ¢äº†å¥½å‡ ä¸ªç‰ˆæœ¬çš„jebï¼Œä½†éƒ½æ²¡ç”¨ï¼Œè¦ä¹ˆæ˜¯é™„åŠ ç•Œé¢éƒ½æ‰“ä¸å¼€ï¼ˆç›´æ¥ç©ºç™½ï¼‰ï¼Œè¦ä¹ˆå°±æ˜¯æ˜¾ç¤ºå‡ºäº†å¯„å­˜å™¨ï¼Œä½†æ˜¯å¯„å­˜å™¨çš„å€¼å…¨ä¸ºç©ºï¼Œè¯¦è§<a href="https://www.52pojie.cn/thread-1832424-1-1.html">jebåŠ¨è°ƒå‡ºç°å¯„å­˜å™¨å…¨ä¸ºvoidæƒ…å†µ - ã€ç§»åŠ¨å®‰å…¨è®¨è®ºæ±‚åŠ©åŒºã€ - å¾çˆ±ç ´è§£ - LCG - LSG |å®‰å“ç ´è§£|ç—…æ¯’åˆ†æ|www.52pojie.cn</a>ã€‚çœŸå¤ŸæŠ˜ç£¨äººçš„ï¼</p><p>ç„¶åæ˜¯ç§‘ç ”ï¼Œé€†å‘å¾®ä¿¡çš„å°ç¨‹åºæœç´¢åŠŸèƒ½ï¼Œæˆ‘çš„æ–¹æ³•æ˜¯é€šè¿‡å¼€å‘åŠ©æ‰‹å·¥å…·æ¥å®šä½æœç´¢ç•Œé¢çš„æœç´¢æŒ‰é’®ï¼Œæ²¡æƒ³åˆ°æ˜¯ä¸€ä¸ªTextviewæ§ä»¶ã€‚ç„¶åæ ¹æ®æ˜¾ç¤ºçš„èµ„æºidä»¥åŠnameå®šä½ä»£ç ï¼Œæœ‰æ··æ·†ï¼Œå¾ˆéš¾å—ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ—¥æŠ¥</category>
      
      <category>2023å¹´09æœˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¥æŠ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20230910æ—¥æŠ¥</title>
    <link href="/2023/09/10/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/10%E6%97%A5%E6%8A%A5/"/>
    <url>/2023/09/10/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/10%E6%97%A5%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©å¹²çš„äº‹æƒ…æœ‰ç‚¹å°‘ï¼Œæ”¶å·¥ä¹Ÿæ¯”ä»¥å¾€æ—©ç‚¹ï¼Œæ¯•ç«Ÿæ˜¯æ˜ŸæœŸå¤©ï¼Œè®©è‡ªå·±æ”¾æ¾ä¸€ä¸‹ã€‚</p><p>å›é¡¾ä¸€ä¸‹ï¼Œè¿˜æ˜¯åœ¨nssctfä¸Šå†™ç‚¹mobileé¢˜ï¼Œé¢˜ç›®è´¨é‡ç¨å¾®å¥½ä¸€ä¸¢ä¸¢ï¼Œé‡åˆ°ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…ï¼Œå°±æ˜¯jadxå·¥å…·åˆ†ææŸé“é¢˜çš„apkï¼Œå‘ç°åç¼–è¯‘å‡ºæ¥çš„ç»“æœå­˜åœ¨å‡½æ•°ä¸ºç©ºçš„æƒ…å†µï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯ï¼ç”¨jebå·¥å…·åˆ†æapkå°±ä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚æ‰€ä»¥è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œjadxå·¥å…·æ¯”jebå·¥å…·æ‹‰ï¼Ÿæˆ‘ä»¬ä¸è®¨è®ºå·¥å…·çš„åŸå› ï¼Œå¦‚æœå‡ºç°è¿™ç§æƒ…å†µï¼Œä¹Ÿè®¸éœ€è¦é dumpå†…å­˜æå–æ–¹æ³•ã€‚</p><p>å¦å¤–ï¼Œæˆ‘çš„jebå·¥å…·åŠ¨è°ƒæœ‰ç‚¹é—®é¢˜å•Šï¼Œä»¥å¯„å­˜å™¨å­˜æ”¾çš„å±€éƒ¨å˜é‡å¹¶æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œæ˜¯æ˜¾ç¤ºäº†ä¸€å¤§å †å¥‡å¥‡æ€ªæ€ªçš„ä¸œè¥¿ï¼Œè€Œä¸”è¿˜ä¸èƒ½ä»é‡Œé¢æœç´¢æˆ‘æƒ³è¦çš„å±€éƒ¨å˜é‡ï¼Œä»–ç›´æ¥ç»™é€€å‡ºç¨‹åºäº†ï¼Œæˆ‘é ï¼</p><p>ä¹‹åå°±æ˜¯æ¨è¿›ç§‘ç ”ä»»åŠ¡å’¯ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…ï¼Œä¸¤ä¸ªä¸åŒçš„å°ç¨‹åºï¼Œå®ƒä»¬çš„éƒ¨åˆ†ç•Œé¢æ˜¯ä¸€è‡´çš„ï¼Œå…³é”®æ˜¯å®ƒä»¬çš„apié™¤hostä»¥å¤–ï¼Œéƒ½æ˜¯ç›¸åŒçš„ï¼äºæ˜¯å®ƒä»¬éƒ½å­˜åœ¨ç›¸åŒçš„æ¼æ´ã€‚å½“ç„¶ï¼Œæˆ‘è¿˜å‘ç°äº†å¦ä¸€ä¸ªå°ç¨‹åºçš„æ¼æ´ï¼Œæ˜¯åŸºäºç”¨æˆ·ä¿¡æ¯æ›´æ–°çš„æ¼æ´ï¼Œå¯ä»¥è®¿é—®åˆ°ç”¨æˆ·çš„ä¿¡æ¯ä»¥åŠç”¨äºé€šä¿¡çš„å…³é”®å‚æ•°ã€‚</p><p>æµ‹è¯•æœºå› ä¸ºä¹‹å‰çš„ç¼˜æ•…ï¼Œåˆå¾—é‡æ–°ä¹°ä¸€ä¸ªï¼Œä¸ç„¶éƒ½æ²¡æ³•è·Ÿç€å­¦ä¹ è§†é¢‘å¾€ä¸‹èµ°äº†ã€‚</p><p>å”‰ï¼æµ‹è¯•æœºæœ‰æ˜¯æœ‰ï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯ç”¨æ¥ç§‘ç ”çš„ï¼Œå¾—å¦å¤–å†ä¹°ä¸€ä¸ªã€‚è¯´å®è¯ï¼Œå­¦Androidå¾—å¤šä¹°ç‚¹æµ‹è¯•æœºç”¨ã€‚</p><p>okï¼Œæ—©ç‚¹ç¦»å¼€å·¥ä½œå®¤ï¼Œç»™è‡ªå·±å¤šç‚¹æ—¶é—´æ”¾æ¾æ”¾æ¾ï¼</p>]]></content>
    
    
    <categories>
      
      <category>æ—¥æŠ¥</category>
      
      <category>2023å¹´09æœˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¥æŠ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20230909æ—¥æŠ¥</title>
    <link href="/2023/09/09/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/09%E6%97%A5%E6%8A%A5/"/>
    <url>/2023/09/09/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/09%E6%97%A5%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©ä¸Šåˆå¸®åŒå­¦æä¸ªè‡ªåŠ¨é¢„çº¦è‡ªä¹ å®¤åº§ä½çš„ä»£ç ï¼Œç­‰åˆ°æ™šä¸Šå¼€æŠ¢æ—¶ï¼Œæ•ˆæœä¸æ˜¯å¾ˆå¥½ï¼Œå­¦æ ¡æœåŠ¡å™¨å¤ªåƒåœ¾çš„ï¼Œç™»å½•è¯·æ±‚éƒ½éœ€è¦å¥½ä¹…ï¼æ„Ÿè§‰è¿æ‰‹åŠ¨æŠ¢éƒ½æ¯”ä¸è¿‡ï¼Œç¡®å®éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–è„šæœ¬ã€‚</p><p>ä¸‹åˆå†™äº†äº›nssctfä¸Šçš„mobileä¸“é¢˜ï¼Œæ„Ÿè§‰ä¸Šé¢çš„é¢˜ç›®æ²¡å•¥è´¨é‡å•Šï¼Œéƒ½æ˜¯ç®€å•çš„é¢˜ç›®ï¼Œä¹Ÿå°±æœ‰ä¸€ä¸ªé¢˜ç›®æåŠåˆ°äº†åŠ å£³è„±å£³ã€‚apkçš„å£³è¿˜æ²¡è¯•è¿‡ï¼Œè¿™ä¸€ç‚¹éœ€è¦å­¦ä¹ å­¦ä¹ ã€‚</p><p>ä¹‹åå°±æ˜¯ç»™ç§‘ç ”æ‰“å·¥ï¼Œä¸è¿‡ä¹Ÿå¥½åœ¨å‘ç°äº†æŸå°ç¨‹åºçš„è¶Šæƒè¡Œä¸ºï¼Œæ„Ÿè§‰åªæœ‰æŒ–åˆ°æ´æ‰æ˜¯è¿™å­¤å•çš„ç§‘ç ”ä¸Šçš„å”¯ä¸€ä¹è¶£ï¼Œç›®å‰æ¥è¯´è‡³å°‘æ˜¯è¿™æ ·çš„ã€‚<del>ï¼ˆåªæœ‰æˆ‘ä¸€ä¸ªäººå¹²æ´»ï¼Œéº»äº†å•Šï¼‰</del></p>]]></content>
    
    
    <categories>
      
      <category>æ—¥æŠ¥</category>
      
      <category>2023å¹´09æœˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¥æŠ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20230908æ—¥æŠ¥</title>
    <link href="/2023/09/08/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/08%E6%97%A5%E6%8A%A5/"/>
    <url>/2023/09/08/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/08%E6%97%A5%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æ˜¯è·Ÿç€ä¹¦ç±å­¦ä¹ äº† JNI åŸç†ï¼Œå†™äº†ç›¸åº”çš„å­¦ä¹ ç¬”è®°ã€‚æœ‰ä¸€ç‚¹æˆ‘ä¸æ»¡æ„çš„æ˜¯ï¼Œæ¯æ¬¡å†™è¿™ç§ç±»å‹çš„åšå®¢ï¼Œæˆ‘éƒ½ä¼šèŠ±ä¸Šéå¸¸ä¹…çš„æ—¶é—´æ¥å®Œæˆï¼Œæ¯æ¬¡å†™å¾—éƒ½å’¬æ–‡åš¼å­—ï¼Œæ€»æ‹…å¿ƒå“ªé‡Œå†™çš„ä¸å¤ªå¯¹ï¼Œæƒ³æ ¹æ®è‡ªå·±çš„å¿ƒå¾—å†™ï¼Œä½†åˆæ€•æ˜¯é”™è¯¯çš„ï¼Œå¾ˆæ˜¯ç—›è‹¦ï¼</p><p>æˆ‘è§‰å¾—è¿™æ˜¯ä¸€ç§ç—…ï¼ä½œä¸ºåˆå­¦è€…ï¼Œå†™çš„å­¦ä¹ ç¬”è®°å­˜åœ¨é”™è¯¯æ˜¯å¯ä»¥ç†è§£çš„ï¼Œç­‰å­¦ä¹ ä¸€æ®µæ—¶é—´åï¼Œå›è¿‡å¤´æ¥çœ‹ï¼Œå¦‚æœå“ªé‡Œå†™çš„ä¸å¯¹ï¼Œæ›´æ”¹å°±è¡Œäº†ï¼Œå¹²å˜›éå¾—è¿™æ ·å‘¢ï¼</p><p>ç›´æ¥æŠŠåŸæœ¬ç”¨äºç§‘ç ”çš„æ—¶é—´ç»™å ç”¨äº†ã€‚å”‰ï¼</p><p>ä½ çœ‹ï¼Œæˆ‘å†™è¿™ç¯‡çš„æ—¶å€™ä¹Ÿæ˜¯è¿™ä¹ˆç´¯ï¼</p>]]></content>
    
    
    <categories>
      
      <category>æ—¥æŠ¥</category>
      
      <category>2023å¹´09æœˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¥æŠ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20230907æ—¥æŠ¥</title>
    <link href="/2023/09/07/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/07%E6%97%A5%E6%8A%A5/"/>
    <url>/2023/09/07/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/07%E6%97%A5%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨nssctfä¸Šå†™äº†ä¸€äº›mobileä¸“æ çš„é¢˜ç›®ã€‚éƒ½æ˜¯ä¸€äº›æ¯”è¾ƒç®€å•çš„ï¼Œæœ‰ç‚¹æ„æ€çš„è¿˜å¾—æ˜¯<code>[ç¾ŠåŸæ¯ 2021]Ez_android</code>ï¼Œå› ä¸ºè¿™é“é¢˜éœ€è¦ç”¨åˆ°jadxåŠ¨è°ƒï¼Œä¿®æ”¹smaliè¯­è¨€ï¼Œè¿™äº›çŸ¥è¯†è™½ç„¶ä¹‹å‰å­¦è¿‡ï¼Œä½†éƒ½å·®ä¸å¤šå¿˜å…‰äº†ï¼Œå› ä¸ºé‚£æ—¶è¿ç¬”è®°éƒ½æ²¡æœ‰åšï¼ˆè¿™ä¸ªæ˜¯éœ€è¦åæ€çš„ï¼‰ã€‚æ›´æœ‰æ„æ€çš„æ˜¯<code>[SWPU 2019]easyapp</code>è¿™é“é¢˜ï¼Œnativeå±‚å®ç°åŠ å¯†å‡½æ•°ï¼Œ JNIåŠ¨æ€æ³¨å†Œè¯¥å‡½æ•°ï¼Œæ— æ³•åŠ¨è°ƒï¼ˆå¯èƒ½æ˜¯æ‰‹æœºç‰ˆæœ¬é—®é¢˜ï¼‰ï¼Œç›®å‰æ˜¯æ²¡æœ‰å†™å‡ºæ¥çš„ã€‚</p><p>ä¹‹åæƒ³å­¦ä¹ JNIé™æ€æ³¨å†Œå‡½æ•°å’ŒåŠ¨æ€æ³¨å†Œå‡½æ•°ï¼Œæµ…çœ‹äº†ä¸€äº›æ–‡ç« ã€‚</p><p>æ²¡æƒ³åˆ°é«˜ä¸­åŒå­¦æ¥è¿™é‡Œï¼Œå°±é™ªä»–é€›é€›ã€‚</p><p>å†ä¹‹åå°±æ˜¯æ¨è¿›ç§‘ç ”å·¥ä½œã€‚<del>ï¼ˆè¯´æ˜¯ç§‘ç ”å·¥ä½œï¼Œå•å¹²çš„éƒ½æ˜¯æ²¡æœ‰æŠ€æœ¯çš„ï¼‰</del></p>]]></content>
    
    
    <categories>
      
      <category>æ—¥æŠ¥</category>
      
      <category>2023å¹´09æœˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¥æŠ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nssctf-mobileä¸“é¢˜(ä¸€)</title>
    <link href="/2023/09/07/nssctf-mobile%E4%B8%93%E9%A2%98(%E4%B8%80)/"/>
    <url>/2023/09/07/nssctf-mobile%E4%B8%93%E9%A2%98(%E4%B8%80)/</url>
    
    <content type="html"><![CDATA[<h1 id="CISCN-2022-ä¸œåŒ—-crackme-Android"><a href="#CISCN-2022-ä¸œåŒ—-crackme-Android" class="headerlink" title="[CISCN 2022 ä¸œåŒ—]crackme_Android"></a>[CISCN 2022 ä¸œåŒ—]crackme_Android</h1><p>æ•´ä¸ªåˆ†æå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://www.nssctf.cn/files/2023/9/7/18ebead836.jpg" alt="NSSIMAGE"></p><p>å¾ˆç®€å•ã€‚å°±æ˜¯å°†38bytesçš„flagå»æ‰æ ¼å¼åï¼Œæ¯4bytesä¸€ç»„è¿›è¡Œmd5åŠ å¯†ï¼Œå¾—åˆ°çš„ç»“æœç»„æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶äºå·²çŸ¥å­—ç¬¦ä¸²æ¯”è¾ƒã€‚<br>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†å·²çŸ¥å­—ç¬¦ä¸²åˆ†å¥½ç»„æ‹¿åˆ°<a href="https://www.cmd5.org/%E4%B8%8A%E8%A7%A3%E5%AF%86%E5%8D%B3%E5%8F%AF%E3%80%82%E5%88%86%E7%BB%84%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A">https://www.cmd5.org/ä¸Šè§£å¯†å³å¯ã€‚åˆ†ç»„ä»£ç å¦‚ä¸‹ï¼š</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">md5string = <span class="hljs-string">&#x27;8393931a16db5a00f464a24abe24b17a9040b57d9cb2cbfa6bdc61d12e9b51f2789e8a8ae9406c969118e75e9bc65c4327fbc7c3accdf2c54675b0ddf3e0a6099b1b81046d525495e3a14ff6eae76eddfa1740cd6bd483da0f7684b2e4ec84b371f07bf95f0113eefab12552181dd832af8d1eb220186400c494db7091e402b0&#x27;</span><br>flaglen = <span class="hljs-number">38</span> - <span class="hljs-number">6</span><br>group = flaglen / <span class="hljs-number">4</span><br>eachmd5len = <span class="hljs-built_in">len</span>(md5string) // <span class="hljs-number">8</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(md5string), eachmd5len):<br>    eachmd5 = md5string[i:i+eachmd5len]<br>    <span class="hljs-built_in">print</span>(eachmd5)<br></code></pre></td></tr></table></figure><h1 id="HGAME-2022-week1-flagchecker"><a href="#HGAME-2022-week1-flagchecker" class="headerlink" title="[HGAME 2022 week1]flagchecker"></a>[HGAME 2022 week1]flagchecker</h1><p>é¢˜ç›®æ¸…æ™°æ˜äº†ï¼Œå¤ªç®€å•äº†ï¼Œå°±è´´ä¸ªè„šæœ¬ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> ARC4<br><br>base64cipher = <span class="hljs-string">&quot;mg6CITV6GEaFDTYnObFmENOAVjKcQmGncF90WhqvCFyhhsyqq1s=&quot;</span><br>RC4cipher = b64decode(base64cipher)<br><span class="hljs-built_in">print</span>(RC4cipher)<br>key = <span class="hljs-string">&quot;carol&quot;</span><br><br>rc4 = ARC4.new(key.encode())<br>plaintext = rc4.decrypt(RC4cipher)<br><span class="hljs-built_in">print</span>(plaintext)<br><br></code></pre></td></tr></table></figure><h1 id="ç¾ŠåŸæ¯-2021-Ez-android"><a href="#ç¾ŠåŸæ¯-2021-Ez-android" class="headerlink" title="[ç¾ŠåŸæ¯ 2021]Ez_android"></a>[ç¾ŠåŸæ¯ 2021]Ez_android</h1><p>åˆ©ç”¨<code>jadx</code>å·¥å…·åˆ†æï¼Œ<code>MainActivity</code>ä¸­ä¸»è¦æ˜¯ç™»å½•éªŒè¯ã€‚çœŸå®çš„è´¦å·å­—ç¬¦ä¸²å¯ä»¥æ–‡æœ¬æœç´¢å‡ºæ¥ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨MTæ ¹æ®èµ„æºidæœç´¢å‡ºæ¥ï¼‰ï¼š</p><p><img src="https://www.nssctf.cn/files/2023/9/7/4d60c4f531.jpg" alt="NSSIMAGE"></p><blockquote><p>åŒç†å…¶ä»–å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥é€šè¿‡è¿™ç§æ–¹æ³•æœç´¢å‡ºæ¥ï¼Œåç»­ä¸å†æåŠã€‚</p></blockquote><p>å¯†ç éªŒè¯è¿™ä¸€å—è¿›è¡Œäº†åŠ å¯†å¤„ç†ï¼š</p><p><img src="https://www.nssctf.cn/files/2023/9/7/6924114160.jpg" alt="NSSIMAGE"></p><p>å¾ˆå®¹æ˜“é€†å‡ºæ¥ï¼Œè¿™é‡Œç›´æ¥è´´ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> hexlify, unhexlify<br><br>passwdCipher = <span class="hljs-string">&quot;c232666f1410b3f5010dc51cec341f58&quot;</span><br>bytePasswdCipher = unhexlify(passwdCipher.encode())<br>md5 = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> bytePasswdCipher:<br>    <span class="hljs-comment"># md5 += chr(each + 1).encode()#æœ‰çš„ä¼šå˜æˆä¸¤ä¸ªå­—èŠ‚ï¼Ÿï¼Ÿï¼Ÿï¼</span><br>    md5 += <span class="hljs-built_in">hex</span>(each + <span class="hljs-number">1</span>)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span>(md5)<br></code></pre></td></tr></table></figure><blockquote><p>å½“ç„¶ï¼Œç›´æ¥ä¿®æ”¹smaliè¯­è¨€ä¹Ÿå¯ä»¥ç»•è¿‡ç™»å½•éªŒè¯ï¼Œå¯ä»¥ä¿®æ”¹æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹checkUsernameå’ŒcheckPasswdæ–¹æ³•çš„è¿”å›å€¼ï¼ˆåœ¨return v2å‰é¢åŠ ä¸€ä¸ªèµ‹å€¼è¯­å¥ï¼šconst&#x2F;4 ,0x1ï¼‰ã€‚æœ‰å…´è¶£çš„å¯ä»¥è¯•è¯•ã€‚</p></blockquote><p>è´¦å·å¯†ç éªŒè¯é€šè¿‡åï¼Œè¿˜ä¼šè°ƒç”¨<code>getKeyAndRedirect</code>æ–¹æ³•ï¼Œä¸»è¦æ˜¯å¼€è¾Ÿçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè°ƒç”¨<code>lambda$getKeyAndRedirect$0$MainActivity</code>æ–¹æ³•è¿œç¨‹è·å–<code>key</code>ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>è¦åœ¨samilè¯­è¨€ä¸Šä¿®æ”¹<code>socket</code>çš„<code>ip</code>å’Œ<code>port</code>ä¸ºnssctfç»™çš„</strong>ï¼‰ï¼Œç„¶åé€šè¿‡<code>Intent</code>å¼€å¯<code>CheckFlagActivity</code>æ´»åŠ¨å¹¶ä¼ å…¥<code>key</code>ã€‚</p><p>è·Ÿè¿›<code>CheckFlagActivity</code>ï¼Œè¯¥æ´»åŠ¨ä¸»è¦æ˜¯é€šè¿‡Intentè·å–<code>key</code>å‚æ•°ï¼Œç„¶åè·å–æˆ‘ä»¬è¾“å…¥çš„flagï¼Œç„¶åè°ƒç”¨<code>checkFlag</code>æ–¹æ³•éªŒè¯ flagã€‚</p><p><img src="https://www.nssctf.cn/files/2023/9/7/da0923e536.jpg" alt="NSSIMAGE"></p><p>è¿™é‡Œè°ƒç”¨äº†<code>EncodeUtils.encode</code>æ–¹æ³•å¯¹ flag è¿›è¡Œäº†åŠ å¯†ï¼Œå†ä¸<code>encodeFlag</code>å­—ç¬¦ä¸²å¯¹æ¯”ï¼Œè¯¥å­—ç¬¦ä¸²é€šè¿‡æœç´¢å¯çŸ¥æ˜¯<code>3lkHi9iZNK87qw0p6U391t92qlC5rwn5iFqyMFDl1t92qUnL6FQjqln76l-P</code>ã€‚</p><p>æ¥ä¸‹æ¥æŸ¥çœ‹<code>EncodeUtils.encode</code>æ–¹æ³•ï¼š</p><p><img src="https://www.nssctf.cn/files/2023/9/7/896ff4ce5e.jpg" alt="NSSIMAGE"></p><p>å…¶å®å°±æ˜¯ä¸€ä¸ªbase64åŠ å¯†ï¼Œåªä¸è¿‡base64è¡¨é€šè¿‡æœåŠ¡å™¨ç»™å‡ºã€‚</p><p>æ•´ä¸ªè¿‡ç¨‹ç†æ¸…æ¥šä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦åŠ¨è°ƒæ¥è·å–base64è¡¨ï¼Œå› æ­¤åœ¨<code>EncodeUtils.encode</code>æ–¹æ³•è¢«è°ƒç”¨å¤„ä¸‹æ–­ç‚¹ï¼ˆå½“ç„¶ä½ å¦‚æœè§‰å¾—ä¸å¤ªé è°±ï¼Œå¯ä»¥å¾€å‰å‡ æ­¥å†ä¸‹æ–­ç‚¹ï¼Œå› ä¸ºsmaliè¯­è¨€çš„æ“ä½œéƒ½æ˜¯ç»è¿‡å¯„å­˜å™¨æ¥è¿›è¡Œçš„ï¼Œè¿‡å¤šæ‰§è¡Œå‡ æ­¥çš„è¯é‡Œé¢çš„æ•°æ®å°±å¯èƒ½è¢«æ›´æ”¹äº†ï¼‰ï¼ˆjadxéœ€è¦åœ¨smaliè¯­è¨€ä¸­æŒ‰<code>F2</code>ä¸‹æ–­ç‚¹ï¼‰ï¼Œç„¶åè¿›è¡ŒåŠ¨è°ƒã€‚</p><blockquote><p>åœ¨è½¬smailè¯­è¨€æ—¶ï¼Œtabé”®å¥½åƒä¸ä¼šå®šä½åˆ°å¯¹åº”ä»£ç ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡æ–¹æ³•åæŒ‰ctrl+Få®šä½</p></blockquote><p><img src="https://www.nssctf.cn/files/2023/9/7/d6b8e9a465.jpg" alt="NSSIMAGE"></p><p>è·å–åˆ°base64è¡¨åï¼Œå°±æ˜¯è§£å¯†äº†ï¼Œå¯¹åº”è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<br><span class="hljs-keyword">from</span> string <span class="hljs-keyword">import</span> ascii_uppercase, ascii_lowercase, digits<br><br>table1 = <span class="hljs-string">&#x27;TGtUnkaJD0frq61uCQYw3-FxMiRvNOB/EWjgVcpKSzbs8yHZ257X9LldIeh4APom&#x27;</span><br>table2 = ascii_uppercase  + ascii_lowercase + digits + <span class="hljs-string">&#x27;+/&#x27;</span><br>tarnstable = <span class="hljs-built_in">str</span>.maketrans(table1, table2)<br>cipher = <span class="hljs-string">&#x27;3lkHi9iZNK87qw0p6U391t92qlC5rwn5iFqyMFDl1t92qUnL6FQjqln76l-P&#x27;</span><br>plaintext = b64decode(cipher.translate(tarnstable))<br><span class="hljs-built_in">print</span>(plaintext)<br></code></pre></td></tr></table></figure><h1 id="é¹åŸæ¯-2022-baby-re"><a href="#é¹åŸæ¯-2022-baby-re" class="headerlink" title="[é¹åŸæ¯ 2022]baby_re"></a>[é¹åŸæ¯ 2022]baby_re</h1><p><code>jadx</code>åˆ†æï¼Œè¯¥åº”ç”¨è°ƒç”¨<code>baby_xor</code>æ–¹æ³•å¯¹æˆ‘ä»¬è¾“å…¥çš„flagè¿›è¡Œäº†åŠ å¯†ï¼Œè€Œè¯¥æ–¹æ³•æ˜¯é€šè¿‡<code>native</code>å±‚å®ç°çš„ï¼Œå¯¹åº”çš„åŠ è½½soæ–‡ä»¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> &#123;<br>        System.loadLibrary(<span class="hljs-string">&quot;createso&quot;</span>); <span class="hljs-comment">// åŠ è½½soæ–‡ä»¶ï¼ï¼ï¼</span><br>    &#125;<br><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆIDAåˆ†æsoæ–‡ä»¶å’¯ï¼Œç›´æ¥æ‰¾è¯¥å‡½æ•°åï¼ˆ<strong>å¯¹åº”çš„soå‡½æ•°åå‘½åæ˜¯æœ‰è§„åˆ™çš„</strong>ï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309072243587.png"></p><p>ä¸€ä¸ªç®€ç®€å•å•çš„å¼‚æˆ–ã€‚ä½†æ˜¯å•å•è¿™æ ·æ‹¿å»è§£è‚¯å®šè§£ä¸å‡ºæ¥ï¼Œå› ä¸ºä»–è¿˜ç»™å¯†é’¥è¿›è¡Œäº†åŠ å¯†ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309072243805.png"></p><p>åé¢é‚£å‡ ä¸ª<code>dword_xxxx</code>å…¶å®å°±æ˜¯<code>key[i]</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">cipher = [<span class="hljs-number">119</span>, <span class="hljs-number">9</span>, <span class="hljs-number">40</span>, <span class="hljs-number">44</span>, <span class="hljs-number">106</span>, <span class="hljs-number">83</span>, <span class="hljs-number">126</span>, <span class="hljs-number">123</span>, <span class="hljs-number">33</span>, <span class="hljs-number">87</span>, <span class="hljs-number">113</span>, <span class="hljs-number">123</span>, <span class="hljs-number">112</span>, <span class="hljs-number">93</span>, <span class="hljs-number">125</span>, <span class="hljs-number">127</span>, <span class="hljs-number">41</span>, <span class="hljs-number">82</span>, <span class="hljs-number">44</span>, <span class="hljs-number">127</span>, <span class="hljs-number">39</span>, <span class="hljs-number">3</span>, <span class="hljs-number">126</span>, <span class="hljs-number">125</span>, <span class="hljs-number">119</span>, <span class="hljs-number">87</span>, <span class="hljs-number">47</span>, <span class="hljs-number">125</span>, <span class="hljs-number">33</span>, <span class="hljs-number">6</span>, <span class="hljs-number">44</span>, <span class="hljs-number">127</span>, <span class="hljs-number">112</span>, <span class="hljs-number">0</span>, <span class="hljs-number">126</span>, <span class="hljs-number">123</span>, <span class="hljs-number">115</span>, <span class="hljs-number">24</span>]<br>key = [<span class="hljs-number">0x56</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x59</span>]<br><br>key[<span class="hljs-number">0</span>] ^= <span class="hljs-number">0x47</span><br>key[<span class="hljs-number">1</span>] ^= <span class="hljs-number">0x32</span><br>key[<span class="hljs-number">2</span>] ^= <span class="hljs-number">0x11</span><br>key[<span class="hljs-number">3</span>] ^= <span class="hljs-number">0x12</span><br><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(cipher)):<br>    flag += <span class="hljs-built_in">chr</span>(cipher[i] ^ key[i % <span class="hljs-number">4</span>])<br><br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20230906æ—¥æŠ¥</title>
    <link href="/2023/09/06/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/06%E6%97%A5%E6%8A%A5/"/>
    <url>/2023/09/06/%E6%97%A5%E6%8A%A5/2023%E5%B9%B409%E6%9C%88/06%E6%97%A5%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<p>åˆšåˆ°ä¸€éƒ¨nexus6pæ‰‹æœºï¼Œä¸‹äº†åŒæ ·çš„ç‰ˆæœ¬åˆ·æœºåŒ…ï¼Œæ²¡åˆ·æœºç›´æ¥rootï¼Œå‘ç°è¿™æ‰‹æœºæœ‰avbéªŒè¯ï¼Œåœ¨å¼€æœºçš„æ—¶å€™ä¼šéªŒè¯boot.imgæ˜¯å¦è¢«ä¿®æ”¹ï¼Œäºæ˜¯ä¹å¡åœ¨å¯åŠ¨ç•Œé¢è¿›ä¸å»ï¼ŒfastbootåŠå¤©ï¼Œç»“æœå‘ç°æ ¹æœ¬æ²¡è¿›bootloaderæ¨¡å¼ï¼ˆæœ¬ä»¥ä¸ºä¼šå‘ä¹‹å‰çš„æ‰‹æœºä¸€æ ·ç›´æ¥åœ¨bootloaderç•Œé¢ï¼‰ï¼Œè¿˜æ˜¯é æ±ªä½¬å‘ç°çš„ã€‚åé¢å°è¯•è§£avbé”ï¼Œå¯æƒœè¿å¯¹åº”çš„æ–‡ä»¶éƒ½æ²¡æœ‰ï¼ç´¢æ€§æ”¾å¼ƒäº†ã€‚</p><p>ä¹‹åå°±æ˜¯å°†æ˜¨å¤©æ™šä¸Šé—®æ±ªä½¬çš„é—®é¢˜é‡æ–°å¤ç°ä¸€éï¼Œä¹Ÿå°±æ˜¯å†™é¢˜ç›®æ—¶çš„ä¸€äº›å›°æƒ‘ï¼Œè¯¦è§<a href="https://gal2xy.github.io/2023/09/04/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-crakMe/">å®‰æ´µæ¯2019-crackMe - gla2xyâ€™s blog (gal2xy.github.io)</a>ä¸­çš„é¢˜å¤–è¯ã€‚</p><p>å†ä¹‹åå°±æ˜¯èŠ±ç‚¹æ—¶é—´æ¨è¿›ç§‘ç ”ä»»åŠ¡äº†ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ—¥æŠ¥</category>
      
      <category>2023å¹´09æœˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ—¥æŠ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IDAåŠ¨è°ƒSOæ–‡ä»¶</title>
    <link href="/2023/09/06/IDA%E5%8A%A8%E8%B0%83SO%E6%96%87%E4%BB%B6/"/>
    <url>/2023/09/06/IDA%E5%8A%A8%E8%B0%83SO%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="æ­¥éª¤ä¸€ï¼šå°†-android-server-æ–‡ä»¶-push-åˆ°æ‰‹æœºä¸­å¹¶æ‰§è¡Œ"><a href="#æ­¥éª¤ä¸€ï¼šå°†-android-server-æ–‡ä»¶-push-åˆ°æ‰‹æœºä¸­å¹¶æ‰§è¡Œ" class="headerlink" title="æ­¥éª¤ä¸€ï¼šå°† android_server æ–‡ä»¶ push åˆ°æ‰‹æœºä¸­å¹¶æ‰§è¡Œ"></a>æ­¥éª¤ä¸€ï¼šå°† android_server æ–‡ä»¶ push åˆ°æ‰‹æœºä¸­å¹¶æ‰§è¡Œ</h3><p>å¤åˆ¶IDAç›®å½•ä¸‹çš„<code>\dbgsrv</code>ç›®å½•ä¸‹çš„<code>android_server</code>å’Œ<code>android_server64</code>åˆ°çœŸæœºä¸­å¹¶æ‰§è¡Œï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>å¤åˆ¶åˆ°çœŸæœºä¸­<br>adb push android_server <span class="hljs-regexp">/data/</span>local/tmp<br>adb push android_server64 <span class="hljs-regexp">/data/</span>local/tmp<br><span class="hljs-regexp">//</span>ä¿®æ”¹åº”ç”¨æƒé™ä½¿å…¶å¯æ‰§è¡Œ<br>Cd <span class="hljs-regexp">/data/</span>local/tmp<br>chmod <span class="hljs-number">777</span> android_server android_server64<br><span class="hljs-regexp">//</span>æ‰§è¡Œæ‰€éœ€è¦çš„ç‰ˆæœ¬<br>./android_server64<br></code></pre></td></tr></table></figure><p>é»˜è®¤å¯åŠ¨ç«¯å£ä¸º23946ã€‚</p><h3 id="æ­¥éª¤äºŒï¼šç«¯å£è½¬å‘"><a href="#æ­¥éª¤äºŒï¼šç«¯å£è½¬å‘" class="headerlink" title="æ­¥éª¤äºŒï¼šç«¯å£è½¬å‘"></a>æ­¥éª¤äºŒï¼šç«¯å£è½¬å‘</h3><p>å¦å¼€ä¸€ä¸ªcmdæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">adb</span> forward tcp:<span class="hljs-number">23946</span> tcp:<span class="hljs-number">23946</span><br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªç«¯å£å¯¹åº”ç”µè„‘ç«¯ï¼Œç¬¬äºŒä¸ªç«¯å£å¯¹åº”æ‰‹æœºç«¯ã€‚</p><p>æ‰§è¡Œåï¼Œå°†ä¼šé€šè¿‡ç”µè„‘ç«¯çš„23946ç«¯å£è½¬å‘æ•°æ®åˆ°æ‰‹æœºç«¯çš„23946ç«¯å£ã€‚</p><h3 id="æ­¥éª¤ä¸‰ï¼šam-å¯åŠ¨è¦è°ƒè¯•çš„åº”ç”¨ç¨‹åº"><a href="#æ­¥éª¤ä¸‰ï¼šam-å¯åŠ¨è¦è°ƒè¯•çš„åº”ç”¨ç¨‹åº" class="headerlink" title="æ­¥éª¤ä¸‰ï¼šam å¯åŠ¨è¦è°ƒè¯•çš„åº”ç”¨ç¨‹åº"></a>æ­¥éª¤ä¸‰ï¼šam å¯åŠ¨è¦è°ƒè¯•çš„åº”ç”¨ç¨‹åº</h3><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯åŠ¨è¦è°ƒè¯•çš„åº”ç”¨ç¨‹åºï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">adb <span class="hljs-keyword">shell</span> <span class="hljs-keyword">am</span> start -D -n åŒ…å/æ´»åŠ¨å<br>//ä¾‹å¦‚<br>//adb <span class="hljs-keyword">shell</span> <span class="hljs-keyword">am</span> start -D -n <span class="hljs-keyword">com</span>.example.ndktest2/.MainActivity<br></code></pre></td></tr></table></figure><p>æˆåŠŸåæ‰‹æœºç«¯ä¼šå¼¹å‡ºå¦‚ä¸‹ç•Œé¢ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309061952139.jpg"></p><h3 id="æ­¥éª¤å››ï¼šä½¿ç”¨IDAé™„åŠ è¿›ç¨‹"><a href="#æ­¥éª¤å››ï¼šä½¿ç”¨IDAé™„åŠ è¿›ç¨‹" class="headerlink" title="æ­¥éª¤å››ï¼šä½¿ç”¨IDAé™„åŠ è¿›ç¨‹"></a>æ­¥éª¤å››ï¼šä½¿ç”¨IDAé™„åŠ è¿›ç¨‹</h3><p>ç”¨IDAæ‰“å¼€æƒ³è¦è°ƒè¯•çš„soåº“ï¼Œè°ƒè¯•å™¨é€‰æ‹©<code>Remote ARM Linux/Android debugger</code>ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309061952959.png"></p><p>åœ¨èœå•æ çš„Debugger -&gt; Debugger optionsä¸­è®¾ç½®ç¨‹åºæš‚åœçš„æ—¶æœºï¼ŒæŒ‰ä¸‹å›¾æ‰€ç¤ºå‹¾é€‰é€‰é¡¹æ¡†ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309061952630.png"></p><p>åœ¨èœå•æ çš„Debugger -&gt; Process optionsä¸­è®¾ç½®ä¸»æœºå’Œç«¯å£ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309061952733.png"></p><p>åœ¨èœå•æ çš„Debugger -&gt; Attach to Processä¸­é€‰æ‹©è¦è°ƒè¯•çš„è¿›ç¨‹è¿›è¡Œé™„åŠ ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309061953206.png"></p><p>é€‰æ‹©å®Œåï¼ŒIDAç•Œé¢ä¼šè¿›å…¥åˆ°åŠ¨è°ƒç•Œé¢ã€‚æŒ‰ F9 ç»§ç»­æ‰§è¡Œã€‚</p><h3 id="æ­¥éª¤äº”ï¼šjdbè¿æ¥"><a href="#æ­¥éª¤äº”ï¼šjdbè¿æ¥" class="headerlink" title="æ­¥éª¤äº”ï¼šjdbè¿æ¥"></a>æ­¥éª¤äº”ï¼šjdbè¿æ¥</h3><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">jdb -connect com.sun.jdi.SocketAttach:hostname=localhost,port=åº”ç”¨æ‰€åœ¨ç«¯å£å·<br></code></pre></td></tr></table></figure><p>åº”ç”¨æ‰€åœ¨ç«¯å£å·å¯é€šè¿‡DDMSå·¥å…·æ¥ç¡®å®šçš„ï¼ˆDDMSéœ€è¦çš„jdkç‰ˆæœ¬ä¸º1.8ï¼‰ï¼š</p><blockquote><p>å¯èƒ½ä¼šå‡ºç°<code>æ— æ³•é™„åŠ åˆ°ç›®æ ‡ VM</code>ã€‚å‡ºç°äº†å°±å¤šè¯•å‡ æ¬¡ï¼ˆå¯èƒ½æ˜¯å› ä¸ºandroidç‰ˆæœ¬å¤ªé«˜ï¼‰ã€‚</p></blockquote><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309061953001.png"></p><p>ä»¥ä¸Šæ‰§è¡ŒæˆåŠŸåï¼ŒDDMSä¸­çš„çº¢è‰²å°è™«å­å°±ä¼šå˜æˆç»¿è‰²ã€‚</p><h3 id="æ­¥éª¤ä¹ï¼šç»§ç»­æ‰§è¡Œç¨‹åº"><a href="#æ­¥éª¤ä¹ï¼šç»§ç»­æ‰§è¡Œç¨‹åº" class="headerlink" title="æ­¥éª¤ä¹ï¼šç»§ç»­æ‰§è¡Œç¨‹åº"></a>æ­¥éª¤ä¹ï¼šç»§ç»­æ‰§è¡Œç¨‹åº</h3><p>å†IDAç•Œé¢æŒ‰F9ä½¿ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œåœ¨åº•éƒ¨çš„çª—å£ä¼šæ˜¾ç¤ºå·²åŠ è½½çš„soæ–‡ä»¶ã€‚å½“åŠ è½½åˆ°ã€‚æ­¤åå¯ä»¥ä¸‹æ–­ç‚¹è¿›è¡Œè°ƒè¯•ã€‚</p><h3 id="æ’æ›²"><a href="#æ’æ›²" class="headerlink" title="æ’æ›²"></a>æ’æ›²</h3><p>è°ƒè¯•è¿‡ç¨‹ä¸­å‡ºç°äº†å¦‚ä¸‹æŠ¥é”™ï¼š</p><ol><li><code>Command &quot;ProcessStart&quot; failed</code>ã€‚</li><li><code>IDA could not create a temporary breakpoint for the next instruction.A temporary breakpoint is required in order to suspend the execution after a step.Please use F9 to continue the execution.If you have a breakpoint at the current address,please remove it before continuing.</code></li></ol><p>ä»¥ä¸Šæƒ…å†µï¼ŒF7ã€F8ã€F9å‡å¤±æ•ˆã€‚</p><p>åé¢ç”¨å¦ä¸€ä¸ªAndroidç‰ˆæœ¬çš„æ‰‹æœºæ‰è°ƒè¯•æˆåŠŸçš„ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/145383282">æ–°æ‰‹å‘æ€»ç»“ï¼šIDAåŠ¨æ€è°ƒè¯•Soçš„ä¸€äº›å‘ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/358496347">IDAåŠ¨æ€è°ƒè¯•soæ–‡ä»¶ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://blog.csdn.net/MarketAndTechnology/article/details/82116074">Android IDA åŠ¨æ€è°ƒè¯•æœ€å®Œå–„æ”»ç•¥ï¼Œè·¨è¿‡å„ç§å‘_idaè°ƒè¯•_é—½å†œçš„åšå®¢-CSDNåšå®¢</a></p><p>[<a href="https://bbs.kanxue.com/thread-268985.htm">æ±‚åŠ©]åŠ¨æ€è°ƒè¯•jdbæ— æ³•é™„åŠ åˆ°ç›®æ ‡VM-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WMCTF2020-easy_re</title>
    <link href="/2023/09/04/WMCTF2020-easy-re/"/>
    <url>/2023/09/04/WMCTF2020-easy-re/</url>
    
    <content type="html"><![CDATA[<p>è¿è¡Œç¨‹åºæœ‰â€please input the flag:â€æç¤ºï¼Œä½†æ˜¯ä½¿ç”¨IDAé™æ€åˆ†æå¹¶æ²¡æœ‰å‘ç°è¯¥å­—ç¬¦ä¸²ï¼Œè¯´æ˜è¯¥å­—ç¬¦ä¸²æ˜¯åŠ¨æ€ç”Ÿæˆçš„ã€‚é‚£ä¹ˆå°±ä½¿ç”¨x64dbgåŠ¨è°ƒä¸€ä¸‹ã€‚è™½ç„¶æ‰¾åˆ°äº†å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¯¥å­—ç¬¦ä¸²æ‰€åœ¨çš„æ±‡ç¼–ä»£ç å®Œå…¨çœ‹ä¸æ‡‚ï¼Œå°±æ¯”å¦‚æ‰“å°å­—ç¬¦ä¸²çš„å‡½æ•°éƒ½æ²¡è§ç€ã€‚<del>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä¸ä¼šï¼</del></p><p>çœ‹çœ‹åˆ«äººçš„wpå§ã€‚åŸæ¥è¿™ä¸ªåå­—æ˜¯ä¸€ç§è¯­è¨€ã€‚è¿™ä¸ªé¢˜ç›®åˆ©ç”¨perlappå°†perlç¨‹åºå‹ç¼©æ”¾åœ¨èµ„æºé‡Œé¢äº†ï¼Œæ‰§è¡Œçš„æ—¶å€™æ‰ä¼šè§£å‹å‡ºæ¥ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´åœ¨ç¨‹åºæ‰“å°å‡ºå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œperlç¨‹åºå·²ç»è¢«è§£å‹å‡ºæ¥äº†ã€‚<del>é‚£æˆ‘ä»¬å°±åªèƒ½ä»å¤´å¼€å§‹å•æ­¥æ‰§è¡Œä¸‹å»ï¼Œæœ€åæ‰¾åˆ°äº†å¯¹åº”çš„è§£å‹æŒ‡ä»¤(éº»çƒ¦)</del>ã€‚</p><p>ç›´æ¥å­—ç¬¦æœç´¢â€scriptâ€ï¼Œå‰å‡ ä¸ªéšä¾¿æ‰¾ä¸€ä¸ªä¸‹æ–­ç‚¹ï¼Œå•æ­¥è¿è¡Œï¼Œæœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042233784.png"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs perl">$flag = \<span class="hljs-string">&quot;WMCTF&#123;&#123;I_WAnt_dynam1c_F1ag&#125;&#125;\&quot;;</span><br><span class="hljs-string">print \&quot;please input the flag:\&quot;;</span><br><span class="hljs-string">$line = &lt;STDIN&gt;;</span><br><span class="hljs-string">chomp($line);</span><br><span class="hljs-string">if($line eq $flag)&#123;&#123;</span><br><span class="hljs-string">print \&quot;congratulation!\&quot;</span><br><span class="hljs-string">&#125;&#125;</span><br><span class="hljs-string">else&#123;&#123;</span><br><span class="hljs-string">print \&quot;no,wrong\&quot;</span><br><span class="hljs-string">&#125;&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UTCTF2020-babymips</title>
    <link href="/2023/09/04/UTCTF2020babymips/"/>
    <url>/2023/09/04/UTCTF2020babymips/</url>
    
    <content type="html"><![CDATA[<p>æ•´ä¸ªç¨‹åºæ˜¯ç”¨C++ç¼–å†™çš„ï¼Œä½†ä¸éš¾çœ‹å‡ºä»£ç çš„æ„æ€ï¼Œä¸”é€»è¾‘ç®€å•ï¼Œæ•´ä¸ªåˆ†æéƒ½åœ¨å›¾ä¸­ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042230647.png"></p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042230341.png"></p><p>å¯¹åº”è§£é¢˜ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><br><span class="hljs-comment">//len = 78</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> a1[] =&#123;<br><span class="hljs-number">0x62</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x7F</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x7A</span>, <span class="hljs-number">0x7B</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x50</span>, <br><span class="hljs-number">0x52</span>, <span class="hljs-number">0x7D</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x47</span>, <span class="hljs-number">0x4D</span>, <br><span class="hljs-number">0x74</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0x7B</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x0A</span>, <span class="hljs-number">0x4F</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x7D</span>, <span class="hljs-number">0x69</span>, <br><span class="hljs-number">0x4F</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x1E</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x03</span>, <br><span class="hljs-number">0x7C</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x7A</span>, <span class="hljs-number">0x62</span>, <br><span class="hljs-number">0x2C</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x17</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x0A</span>, <br><span class="hljs-number">0x6D</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x39</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x2E</span>, <span class="hljs-number">0x1C</span>, <span class="hljs-number">0x63</span>, <span class="hljs-number">0x78</span>, <br><span class="hljs-number">0x2B</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x19</span><br>&#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> a2[<span class="hljs-number">78</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">78</span>;i++)&#123;<br>a2[i] = a1[i] ^ (i+<span class="hljs-number">23</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c&quot;</span>,a2[i]);<br>&#125;<br><br>&#125;<br><span class="hljs-meta">#utflag&#123;mips_cpp_gang_5VDm:~`N]ze;\)5%vZ=C<span class="hljs-string">&#x27;C(r#$q=*efD&quot;ZNY_GX&gt;6&amp;sn.wF8$v*mvA@&#x27;</span>&#125;</span><br>#æ²¡é”™ï¼è¿™ä¸ªä¹±ä¸ƒå…«ç³Ÿçš„å°±æ˜¯flag<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GUET-CTF2019-encrypt</title>
    <link href="/2023/09/04/GUETCTF2019-encrypt/"/>
    <url>/2023/09/04/GUETCTF2019-encrypt/</url>
    
    <content type="html"><![CDATA[<p>æ¯”å¯¹RC4åŠ å¯†ç®—æ³•ï¼ˆ<a href="https://zhuanlan.zhihu.com/p/426345623">CRYPTO-RC4åŠ å¯† - çŸ¥ä¹ (zhihu.com)</a>ï¼‰ï¼Œå¯ä»¥ç¡®è®¤æ˜¯RC4åŠ å¯†ã€‚ç„¶åè¿˜æœ‰ä¸€ä¸ªé­”æ”¹base64ï¼Œå°±æ˜¯ç¼–ç çš„æ—¶å€™ç»™æ¯ä½æ•° +61ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042224961.png"></p><p>é¢˜ç›®éš¾å°±éš¾åœ¨åˆå§‹è¯†åˆ«RC4åŠ å¯†ï¼Œè§£å¯†è¿‡ç¨‹æ˜¯å¾ˆç®€å•ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> ARC4<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> unhexlify<br><br>v12 = [<br>  <span class="hljs-number">0x5A</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x7A</span>, <span class="hljs-number">0x7A</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x7C</span>, <span class="hljs-number">0x66</span>,<br>  <span class="hljs-number">0x51</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x5B</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0x56</span>, <span class="hljs-number">0x56</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x7C</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x6E</span>,<br>  <span class="hljs-number">0x65</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x6D</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x6B</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x56</span>,<br>  <span class="hljs-number">0x4A</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x5A</span>, <span class="hljs-number">0x70</span>,<br>  <span class="hljs-number">0x48</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x5C</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x5A</span>,<br>  <span class="hljs-number">0x45</span><br>]<span class="hljs-comment"># 0x3D</span><br><br>binstring = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v12)):<br>    binstring += <span class="hljs-built_in">bin</span>(v12[i] - <span class="hljs-number">61</span>)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">6</span>)<br><br><span class="hljs-built_in">print</span>(binstring)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(binstring))<br>s = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(binstring), <span class="hljs-number">8</span>):<br>    s.append(<span class="hljs-built_in">int</span>(binstring[i:i+<span class="hljs-number">8</span>], <span class="hljs-number">2</span>))<br><br>RC4_cipher = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">hex</span>(i)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s)<span class="hljs-comment">#zfill(2)è¡¥0ï¼Œæ¯•ç«Ÿ1byteç­‰äºä¸¤ä½</span><br><span class="hljs-built_in">print</span>(RC4_cipher)<br><br><span class="hljs-comment"># RC4 è§£å¯†</span><br>key = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">hex</span>(i)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">48</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">16</span>, <span class="hljs-number">64</span>])<br>RC4_cipher = unhexlify(RC4_cipher.encode())<br>key = unhexlify(key.encode())<br>rc4 = ARC4.new(key)<br>flag = rc4.decrypt(RC4_cipher)<br><span class="hljs-built_in">print</span>(flag)<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WUSTCTF2020-funnyre</title>
    <link href="/2023/09/04/WUSTCTF2020-funnyre/"/>
    <url>/2023/09/04/WUSTCTF2020-funnyre/</url>
    
    <content type="html"><![CDATA[<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>elfæ–‡ä»¶ï¼Œ<code>__libc_start_main</code>å‡½æ•°å¯åŠ¨ main å‡½æ•°ï¼Œinit å‡½æ•°ä¸­æ‰§è¡Œäº†ä¸‰ä¸ªå‡½æ•°ï¼Œä½†å¯¹æˆ‘ä»¬è¦æ±‚è§£çš„flagæ— å½±å“<del>ï¼Œå½±å“çš„æ˜¯byte_603049ï¼Œå¯¹åº”mainå‡½æ•°ä¸­æœ€åçš„ puts(s) ä¸­çš„ s å˜é‡ã€‚ï¼ˆåºŸè¯å’¯ï¼‰</del></p><p>ç›´æ¥æ¥çœ‹ main å‡½æ•°ï¼Œå‘ç°å­˜åœ¨èŠ±æŒ‡ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042221346.png"></p><p>ç¬¬ä¸€å¤„å¾ˆæ˜æ˜¾ï¼Œä¸¤ä¸ªè·³è½¬éƒ½å‡ ä¹æ˜¯é›¶è·ç¦»è·³è½¬ä¸”ç¬¬äºŒä¸ªæŒ‡ä»¤æ°¸å‡ï¼ˆæ ¹æœ¬ä¸ä¼šæ‰§è¡Œï¼‰ï¼Œnopæ‰è¿™ä¸¤ä¸ªæŒ‡ä»¤ã€‚ç„¶åæ˜¯ç¬¬äºŒå¤„çš„callæŒ‡ä»¤ï¼Œè·³è½¬åœ°å€å¾ˆæ˜æ˜¾æ˜¯é”™è¯¯çš„ï¼Œå°†å…¶è½¬æˆdataï¼Œå°†callçš„ç¡¬ç¼–ç ï¼ˆE8ï¼‰æ”¹æˆ90ï¼ˆnopï¼‰ï¼Œç„¶åå°†dataè½¬æˆcodeï¼ˆä¸€ç›´è½¬ï¼Œç›´åˆ°æ²¡æœ‰ä»£ç åŒºæ²¡æœ‰æ•°æ®ï¼‰ã€‚æœ€ç»ˆç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042221295.png"></p><p>èŠ±æŒ‡ä»¤æœ‰äº”å¤„ï¼Œä½†éƒ½ä¸€æ ·ã€‚ä¿®æ”¹å®Œåï¼Œmainå‡½æ•°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042221689.png"></p><p>é¦–å…ˆåˆ¤æ–­flagçš„æ ¼å¼å’Œé•¿åº¦ï¼Œç„¶åä¸€å †forå¾ªç¯è¿›è¡Œå¼‚æˆ–ã€åŠ ã€å–åè¿ç®—ï¼Œæœ€åä¸å·²çŸ¥å­—ç¬¦ä¸²ç›¸æ¯”è¾ƒã€‚</p><p>æ•´ä¸ªè¿‡ç¨‹æ‚è€Œä¸éš¾ã€‚æœ‰ä¸¤ç§æ¯”è¾ƒæ¨èçš„æ–¹æ³•ã€‚</p><h2 id="IDAPythonæ ¹æ®æŒ‡ä»¤å»é€†å‘"><a href="#IDAPythonæ ¹æ®æŒ‡ä»¤å»é€†å‘" class="headerlink" title="IDAPythonæ ¹æ®æŒ‡ä»¤å»é€†å‘"></a>IDAPythonæ ¹æ®æŒ‡ä»¤å»é€†å‘</h2><p>ç¬¬ä¸€ç§æ˜¯å†™ä»£ç è¯†åˆ«æŒ‡ä»¤æ¥è¿›è¡Œå“åº”çš„é€†æ“ä½œï¼ŒæŒ‡ä»¤ä¸­çš„æ“ä½œæ•°éƒ½ç”¨ç»Ÿä¸€çš„æ ¼å¼ï¼Œå³<code>byte ptr [rdx + rax +5]</code></p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042222761.png"></p><p>æˆ‘ä»¬è¦åšçš„å°±æ˜¯åœ¨mainå‡½æ•°èŒƒå›´å†…ä¸€è¡Œä¸€è¡Œçš„è¯»å–æ±‡ç¼–æŒ‡ä»¤ï¼Œé€šè¿‡<code>byte ptr [rdx + rax +5]</code>ï¼ˆå› ä¸ºè¿™éƒ¨åˆ†å­˜å‚¨äº†flagï¼‰æ‰¾åˆ°å¯¹flagè¿›è¡ŒåŠ å¯†çš„æŒ‡ä»¤ï¼Œç„¶åè¯†åˆ«æ“ä½œç ä»¥åŒºåˆ†ä¸åŒè¿ç®—ï¼Œæœ€åå–å‡ºå¦ä¸€ä¸ªæ“ä½œæ•°è¿›è¡Œé€†è¿ç®—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_add</span>(<span class="hljs-params">cipher, k</span>):<br>    <span class="hljs-keyword">return</span> [(each - k)&amp;<span class="hljs-number">0xff</span> <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> cipher]<span class="hljs-comment">#&amp;0xff é˜²æ­¢ byte æº¢å‡ºé€ æˆé”™è¯¯</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_xor</span>(<span class="hljs-params">cipher, k</span>):<br>    <span class="hljs-keyword">return</span> [each ^ k <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> cipher]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_not</span>(<span class="hljs-params">cipher</span>):<br>    <span class="hljs-keyword">return</span> [~each <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> cipher]<br><br>cipher = [<span class="hljs-number">0xD9</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0x27</span>, <span class="hljs-number">0xD6</span>, <span class="hljs-number">0xD8</span>, <span class="hljs-number">0x2A</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0x2D</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0xDC</span>, <span class="hljs-number">0xE1</span>, <span class="hljs-number">0xDB</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0xD9</span>, <span class="hljs-number">0xDD</span>, <span class="hljs-number">0x27</span>, <span class="hljs-number">0x2D</span>, <span class="hljs-number">0x2A</span>, <span class="hljs-number">0xDC</span>, <span class="hljs-number">0xDB</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0xE1</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0x2C</span>, <span class="hljs-number">0xDA</span>, <span class="hljs-number">0x2A</span>, <span class="hljs-number">0xD9</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0x2A</span>]<br>end = <span class="hljs-number">0x401DA9</span><br>start = <span class="hljs-number">0x400605</span><br>i = PrevHead(end)<br><span class="hljs-keyword">while</span> i &gt; start:<br>    <span class="hljs-keyword">if</span> GetMnem(i) == <span class="hljs-string">&#x27;xor&#x27;</span> <span class="hljs-keyword">and</span> GetOpnd(i, <span class="hljs-number">0</span>) == <span class="hljs-string">&quot;byte ptr [rdx+rax+5]&quot;</span>:<br>        k = <span class="hljs-built_in">int</span>(GetOpnd(i, <span class="hljs-number">1</span>).rstrip(<span class="hljs-string">&#x27;h&#x27;</span>), <span class="hljs-number">16</span>)<br>        cipher = _xor(cipher, k)<br>    <span class="hljs-keyword">if</span> GetMnem(i) == <span class="hljs-string">&#x27;add&#x27;</span> <span class="hljs-keyword">and</span> GetOpnd(i, <span class="hljs-number">0</span>) == <span class="hljs-string">&quot;byte ptr [rdx+rax+5]&quot;</span>:<br>        k = <span class="hljs-built_in">int</span>(GetOpnd(i, <span class="hljs-number">1</span>).rstrip(<span class="hljs-string">&#x27;h&#x27;</span>), <span class="hljs-number">16</span>)<br>        cipher = _add(cipher, k)<br>    <span class="hljs-keyword">if</span> GetMnem(i) == <span class="hljs-string">&#x27;not&#x27;</span> <span class="hljs-keyword">and</span> GetOpnd(i, <span class="hljs-number">0</span>) == <span class="hljs-string">&quot;byte ptr [rdx+rax+5]&quot;</span>:<br>        cipher = _<span class="hljs-keyword">not</span>(cipher)<br>    i = PrevHead(i)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">chr</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cipher))<br><span class="hljs-comment"># PrevHead(addr)ç”¨äºè·å–æŒ‡å®šåœ°å€ä¹‹å‰ä¸€æ¡æŒ‡ä»¤çš„èµ·å§‹åœ°å€</span><br><span class="hljs-comment"># GetMnem(addr) è·å–åœ°å€iå¤„çš„æ“ä½œæŒ‡ä»¤</span><br><span class="hljs-comment"># GetOpnd(addr, n)è·å–æŸåœ°å€å¤„çš„æ“ä½œæ•°(ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯æ“ä½œæ•°ç´¢å¼•)</span><br></code></pre></td></tr></table></figure><p>ç„¶åå†IDAç•Œé¢ä¸­çš„èœå•æ  File -&gt;Script fileï¼Œæ‰§è¡Œè¯¥pyæ–‡ä»¶ã€‚å¦‚æœè¯†åˆ«ä¸å‡ºä»£ç ä¸­ç”¨åˆ°çš„å‡½æ•°ï¼Œè¯·ä¿®æ”¹IDAæ‰€åœ¨ç›®å½•ä¸‹çš„\cfg\idapython.cfgæ–‡ä»¶ï¼Œå°†AUTOIMPORT_COMPAT_IDA695çš„å€¼ä¿®æ”¹ä¸ºYESã€‚ï¼ˆå‚è€ƒ<a href="https://www.52pojie.cn/thread-1403005-1-1.html">å…³äºIDA7.5 IDApython apiå·®å¼‚é—®é¢˜åŠè§£å†³åŠæ³• - ã€è„±å£³ç ´è§£åŒºã€ - å¾çˆ±ç ´è§£ - LCG - LSG |å®‰å“ç ´è§£|ç—…æ¯’åˆ†æ|www.52pojie.cn</a>ï¼‰</p><blockquote><p>å…¶ä»–æŒ‡ä»¤å‚è€ƒï¼š<a href="https://www.52pojie.cn/thread-1117330-1-1.html">æ€»ç»“idapythonåœ¨é€†å‘ä¸­çš„åº”ç”¨ - ã€è„±å£³ç ´è§£åŒºã€ - å¾çˆ±ç ´è§£ - LCG - LSG |å®‰å“ç ´è§£|ç—…æ¯’åˆ†æ|www.52pojie.cn</a></p></blockquote><h2 id="ç¬¦å·æ‰§è¡Œå·¥å…·çº¦æŸæ±‚è§£"><a href="#ç¬¦å·æ‰§è¡Œå·¥å…·çº¦æŸæ±‚è§£" class="headerlink" title="ç¬¦å·æ‰§è¡Œå·¥å…·çº¦æŸæ±‚è§£"></a>ç¬¦å·æ‰§è¡Œå·¥å…·çº¦æŸæ±‚è§£</h2><p>ç¬¬äºŒç§æ˜¯ä½¿ç”¨ç¬¦å·æ‰§è¡Œå·¥å…·çº¦æŸæ±‚è§£ï¼Œç®€å•æ¥è®²å°±æ˜¯ç¬¦å·åŒ–å¾…æ±‚è§£å˜é‡ï¼Œå¹¶å°†è¿™äº›åŠ å¯†è¿‡ç¨‹ç­‰ä»·ä¸ºæ–¹ç¨‹ï¼Œç„¶åè§£è¿™äº›æ–¹ç¨‹ç»„ã€‚</p><p>linuxä¸‹éœ€è¦ç”¨åˆ°pythonçš„angråº“ï¼ŒåŒæ—¶éœ€è¦é…ç½®pythonè™šæ‹Ÿç¯å¢ƒã€‚è™šæ‹Ÿç¯å¢ƒå®‰è£…çš„æŒ‡ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>å®‰è£…venvï¼Œvenvæ˜¯pythonç®¡ç†è™šæ‹Ÿç¯å¢ƒçš„æ¨èå·¥å…·<br>sudo apt install python3-venv<br><span class="hljs-regexp">//</span>åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒçš„æ–‡ä»¶å¤¹<br>python3 -m venv autoblue-envï¼ˆæ–‡ä»¶åï¼‰<br><span class="hljs-regexp">//</span>æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ<br>source autoblue-env<span class="hljs-regexp">/bin/</span>activate<br><span class="hljs-regexp">//</span>é€€å‡ºè™šæ‹Ÿç¯å¢ƒ<br>deactivate<br></code></pre></td></tr></table></figure><p>åœ¨è™šæ‹Ÿç¯å¢ƒä¸­ä¸‹è½½angrå³å¯æ­£å¸¸ä½¿ç”¨ã€‚ï¼ˆå‚è€ƒ[<a href="https://www.jianshu.com/p/569b51bac964">ç¯å¢ƒæ­å»º][Python]Kaliä¸­ä½¿ç”¨venv - ç®€ä¹¦ (jianshu.com)</a>ï¼‰</p><p>ç„¶åæ˜¯è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-comment"># åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶</span><br>p = angr.Project(<span class="hljs-string">&quot;./attachment&quot;</span>, load_options=&#123;<span class="hljs-string">&quot;auto_load_libs&quot;</span>: <span class="hljs-literal">False</span>&#125;)<br><span class="hljs-comment"># è·å–factoryæ¥å£ï¼Œè¯¥æ¥å£æä¾›é‡è¦åˆ†æå¯¹è±¡ï¼Œå¦‚ blocksï¼ˆç¨‹åºåŸºæœ¬å—ï¼‰ / stateï¼ˆå®ä¾‹é•œåƒï¼Œæ¨¡æ‹Ÿæ‰§è¡ŒæŸä¸ªæ—¶åˆ»çš„çŠ¶æ€ï¼‰ / SimulationManagerï¼ˆç®¡ç† stateï¼Œæ‰§è¡Œ è¿è¡Œã€æ¨¡æ‹Ÿç­‰æ“ä½œï¼‰ ç­‰</span><br>f = p.factory<br><span class="hljs-comment"># æ¨¡æ‹Ÿeip=0x400605æ—¶åˆ»çš„çŠ¶æ€</span><br>state = f.entry_state(addr=<span class="hljs-number">0x400605</span>)<br><span class="hljs-comment"># åˆ›å»ºç¬¦å·å˜é‡</span><br>flag = claripy.BVS(<span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-number">8</span>*<span class="hljs-number">32</span>)<br><span class="hljs-comment"># å°†ç¬¦å·å˜é‡å­˜æ”¾åˆ°æŒ‡å®šåœ°å€ä¸­</span><br>state.memory.store(<span class="hljs-number">0x603055</span>+<span class="hljs-number">0x300</span>+<span class="hljs-number">5</span>, flag)<br><span class="hljs-comment"># æŒ‡å®šæ‰€éœ€ä½¿ç”¨åˆ°çš„å¯„å­˜å™¨çš„å€¼ã€‚å› ä¸ºbyte ptr [rdx + rax +5]æŒ‡å‘flagï¼Œæ‰€ä»¥æŒ‡å®šrdxå’Œrax</span><br>state.regs.rdx = <span class="hljs-number">0x603055</span>+<span class="hljs-number">0x300</span><br>state.regs.rdi = <span class="hljs-number">0x603055</span>+<span class="hljs-number">0x300</span>+<span class="hljs-number">5</span><br><span class="hljs-comment"># åˆ›å»ºSM(Simulation Managers) ç”¨äºç®¡ç† stateï¼Œæ‰§è¡Œ è¿è¡Œã€æ¨¡æ‹Ÿç­‰æ“ä½œ</span><br>sm = p.factory.simulation_manager(state)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] init ok&quot;</span>)<br><span class="hljs-comment"># è°ƒç”¨ explore æ–¹æ³•ï¼Œæ¢ç´¢æ‰§è¡Œè·¯å¾„ï¼Œå¯ä»¥è®¾ç½® find å’Œ avoid å‚æ•°ï¼Œä»¥ä¾¿æ‰¾åˆ°ç¬¦åˆæˆ‘ä»¬é¢„æœŸçš„è·¯å¾„ã€‚</span><br><span class="hljs-comment"># 0x401DAEåœ¨ç¨‹åºä¸­æ˜¯puts(s)å¤„ï¼Œæ˜¯æˆ‘ä»¬æ‰€æœŸæœ›èƒ½æ‰§è¡Œåˆ°çš„è·¯å¾„ã€‚</span><br>sm.explore(find=<span class="hljs-number">0x401DAE</span>)<br><span class="hljs-keyword">if</span> sm.found:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] found!&quot;</span>)<br>    x = sm.found[<span class="hljs-number">0</span>].solver.<span class="hljs-built_in">eval</span>(flag, cast_to=<span class="hljs-built_in">bytes</span>)<span class="hljs-comment">#å­—èŠ‚ä¸ºå•ä½è½¬æ¢</span><br>    <span class="hljs-built_in">print</span>(x)<br></code></pre></td></tr></table></figure><p>angrä¸­æ›´å¤šæ–¹æ³•è¯·å‚è€ƒ<a href="https://xz.aliyun.com/t/7117">angr ç³»åˆ—æ•™ç¨‹(ä¸€ï¼‰æ ¸å¿ƒæ¦‚å¿µåŠæ¨¡å—è§£è¯» - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a>ã€‚</p><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042223884.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰æ´µæ¯2019-crackMe</title>
    <link href="/2023/09/04/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-crakMe/"/>
    <url>/2023/09/04/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-crakMe/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€é¢˜è§£"><a href="#ä¸€ã€é¢˜è§£" class="headerlink" title="ä¸€ã€é¢˜è§£"></a>ä¸€ã€é¢˜è§£</h1><p>ä¸»å‡½æ•°çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042213658.png"></p><p>å¯ä»¥çœ‹å‡ºæ•´ä¸ªæµç¨‹æ˜¯ï¼šå…ˆè¾“å…¥flagï¼Œç„¶åå¼¹å‡ºä¸€ä¸ªè­¦å‘Šå¼¹çª—ï¼Œä¹‹åæœ‰<code>sub_41100F</code>å’Œ<code>sub_411136</code>ä¸¤ä¸ªå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°æ¯”è¾ƒå¤æ‚ï¼Œå¯èƒ½æ˜¯ä¸€å †åŠ å¯†æ“ä½œï¼Œåœ¨æœ€åé¢ä¼šè¿›è¡Œåˆ†æã€‚ç¬¬äºŒä¸ªå‡½æ•°æ˜¯æœ€ç»ˆæ˜¯å°†ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸æ¯”è¾ƒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042215206.png"></p><p><code>Str2</code>å·²çŸ¥ï¼Œè€Œ<code>Str1</code>æœªçŸ¥ï¼Œä½†æ˜¯å¯ä»¥å‘ç°å®ƒåœ¨å¦ä¸€å¤„è¢«å¼•ç”¨äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042213535.png"></p><p>é—®é¢˜å°±æ¥äº†ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„å‘¢ï¼Œç›®å‰æ¥çœ‹æ˜¯ä¸å¯èƒ½æ‰§è¡Œè¿™ä¸ªå‡½æ•°çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸‹ä¸€æ­¥çš„ç›®æ ‡å°±æ˜¯åˆ†æå®ƒæ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚</p><p>åœ¨å­—ç¬¦ä¸²çª—å£ä¸­ï¼Œå¯ä»¥å‘ç°base64çš„å¯¹ç…§è¡¨ï¼Œè·Ÿéšè¯¥å­—ç¬¦ä¸²å¯ä»¥æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042216104.png"></p><p>è¯¥å‡½æ•°é¦–å…ˆæ˜¯å¯¹base64å¯¹ç…§è¡¨ä¸­çš„å°å†™å­—æ¯å¤§å†™åŒ–ï¼Œå¤§å†™å­—æ¯å°å†™åŒ–ï¼Œç„¶åå¼¹å‡ºæç¤ºhookæˆåŠŸçš„å¼¹çª—ï¼Œæœ€åæ‰§è¡Œ<code>AddVectoredExceptionHandler</code>å‡½æ•°ã€‚</p><p>è¿™åº”è¯¥è¯´æ˜äº†é€šè¿‡hookæŠ€æœ¯æ‰§è¡Œäº†åŸæœ¬ä¸åº”è¯¥æ‰§è¡Œçš„å‡½æ•°ã€‚</p><p><code>AddVectoredExceptionHandler</code>å‡½æ•°ç”¨äºæ³¨å†Œå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œç¬¬äºŒä¸ªå‚æ•°Handleræ˜¯è¦è°ƒç”¨çš„å¤„ç†ç¨‹åºçš„æŒ‡é’ˆï¼Œè¯¦ç»†ä»‹ç»å¯è§<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/errhandlingapi/nf-errhandlingapi-addvectoredexceptionhandler">AddVectoredExceptionHandler å‡½æ•° (errhandlingapi.h) - Win32 apps | Microsoft Learn</a>ã€‚</p><p>é‚£æˆ‘ä»¬è·Ÿè¿›è¿™ä¸ª<code>Handler</code>å‡½æ•°çœ‹ä¸€çœ‹ï¼Œä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042217193.png"></p><p><code>0xC0000005</code>æ˜¯ä¸€ä¸ªè®¿é—®å†²çªä»£ç ï¼ˆ<a href="https://learn.microsoft.com/zh-cn/shows/inside/c0000005">è®¿é—®å†²çª C0000005 | Microsoft Learn</a>ï¼‰ï¼Œä¹Ÿé—´æ¥è¯´æ˜äº†è¿™æ˜¯ä¸€ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°ã€‚æ•´ä¸ªä»£ç çš„æµç¨‹ä¸ºï¼šå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯è®¿é—®å†²çªé”™è¯¯ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†å·²çŸ¥å­—ç¬¦ä¸²çš„å‰16ä¸ªå­—èŠ‚å¤åˆ¶ç»™<code>v2</code>ï¼Œç„¶åè°ƒç”¨<code>sub_411172</code>å‡½æ•°è¿›è¡Œ<code>SM4</code>å¯†é’¥ç”Ÿæˆï¼Œ<code>dword_41A218</code>ï¼ˆåé¢ä¼šæåŠï¼‰ç”¨äºå­˜å‚¨ç”Ÿæˆåçš„å¯†é’¥ï¼Œ<code>v2</code>ä½œä¸ºåˆå§‹å¯†é’¥ä¼ å…¥ã€‚è¿™ä¸ªå‡½æ•°æ˜¯é <code>Findcrypt</code>æ’ä»¶è¯†åˆ«å‡ºæ¥çš„ï¼Œå…·ä½“åŠ å¯†ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042217636.png"></p><p>ï¼ˆè¿™é‡Œæˆ‘å‚è€ƒäº†<a href="https://zhuanlan.zhihu.com/p/363900323">ï¼ˆå…­ï¼‰å›½å¯†SM4ç®—æ³• - çŸ¥ä¹ (zhihu.com)</a>è¿›è¡Œæ¯”å¯¹ï¼‰</p><p>å›åˆ°<code>Handler</code>å‡½æ•°ä¸­ï¼Œ<code>SetUnhandledExceptionFilter</code>å‡½æ•°ä¼šåœ¨å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œè°ƒç”¨ç”±<code>TopLevelExceptionFilter</code>å‚æ•°æŒ‡å®šçš„å‡½æ•°ï¼Œè¯¦ç»†è§<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/errhandlingapi/nf-errhandlingapi-setunhandledexceptionfilter">SetUnhandledExceptionFilter å‡½æ•° (errhandlingapi.h) - Win32 apps | Microsoft Learn</a>ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è¿›å…¥åˆ°<code>TopLevelExceptionFilter</code>å‡½æ•°ä¸­æŸ¥çœ‹ï¼Œæœ€ç»ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042217322.png"></p><p>é¦–å…ˆæ˜¯å°†<code>Str2</code>ï¼ˆæœ€å¼€å§‹æåŠè¿‡ï¼‰å­—ç¬¦ä¸²ä¸¤ä¸¤å¯¹è°ƒã€‚ç„¶åæ˜¯<code>byte_41A180</code>å­—ç¬¦ä¸²ï¼ˆå¾…ä¼šè¿˜ä¼šæåŠåˆ°ï¼‰è¿›è¡Œéæ­£å¸¸base64åŠ å¯†å¾—åˆ°<code>Str1</code>ï¼ˆæœ€å¼€å§‹æåŠè¿‡ï¼‰ï¼Œä¹‹æ‰€ä»¥å«éæ­£å¸¸base64åŠ å¯†ï¼Œæ˜¯å› ä¸ºå®ƒæŠŠè¡¨è¿›è¡Œäº†å¾ªç¯å³ç§»24ä½ï¼Œå¹¶ä¸”å°† â€˜&#x3D;â€™ æ¢æˆ â€˜!â€™ ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042217869.png"></p><p>åˆ°è¿™é‡Œï¼Œhookçš„éƒ¨åˆ†å°±ç»“æŸäº†ã€‚</p><p>å¥‡æ€ªå§ï¼åšäº†è¿™ä¹ˆå¤šäº‹æƒ…ï¼Œä½†å¹¶æ²¡æœ‰å¯¹æˆ‘ä»¬çš„è¾“å…¥åšä»»ä½•å¤„ç†ï¼Œè€Œä¸”ä¹Ÿè¿˜å­˜åœ¨æœªçŸ¥çš„æ•°æ®ï¼Œä¾‹å¦‚ç”¨äºbase64åŠ å¯†çš„<code>byte_41A180</code>å­—ç¬¦ä¸²ã€‚é‚£ä¹ˆå°±çœ‹çœ‹è¿™ä¸ªå­—ç¬¦ä¸²è¿˜åœ¨å“ªé‡Œè¢«å¼•ç”¨äº†ã€‚å¯ä»¥å‘ç°å®æ˜¯åœ¨<code>sub_41100F</code>å‡½æ•°ä¸­è¢«å¼•ç”¨äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042218308.png"></p><p>è¿™äº›å‚æ•°æˆ‘ä»¬åœ¨ä¸Šé¢éƒ½æåŠè¿‡ï¼Œ<code>dword_41A218</code>æ˜¯ç”Ÿæˆçš„sm4å¯†é’¥ï¼Œ<code>unk_41A1E4</code>æ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œ<code>byte_41A180</code>ä¸ºç”Ÿæˆ<code>Str1</code>çš„æ˜æ–‡ã€‚</p><p><code>sub_411131</code>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯è¿›è¡ŒSM4åŠ å¯†ï¼Œ<code>unk_41A1E4</code>ä½œä¸ºæ˜æ–‡ï¼Œä½¿ç”¨<code>dword_41A218</code>å¯†é’¥ï¼Œç”Ÿæˆ<code>byte_41A180</code>å¯†æ–‡ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042218990.png"></p><p>ä¸Šå›¾ä¸­<code>sub_411700</code>å‡½æ•°ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042219334.png"></p><p>ä¸Šå›¾ä¸­<code>sub_4111760</code>å‡½æ•°</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042219810.png"></p><p>ä¸Šå›¾ä¸­ç”¨åˆ°çš„ s ç›’ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042219576.png"></p><p>æ€»ç»“ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ã€‚flagé€šè¿‡sm4åŠ å¯†ï¼Œå¾—åˆ°å¯†æ–‡ï¼Œå¯†æ–‡è¿›è¡Œbase64åŠ å¯†ï¼ˆæ³¨æ„å¯¹ç…§è¡¨è¢«æ”¹å˜äº†ï¼Œå¤§å°å†™å­—æ¯äº’æ¢ï¼Œå¾ªç¯å³ç§»24ä½ï¼Œâ€™!â€™ ä»£æ›¿ â€˜&#x3D;â€™ï¼‰ï¼Œå¾—åˆ°<code>Str1</code>ï¼Œå¹¶ä¸”<code>Str1</code>ä¸<code>Str2</code>ï¼ˆæ³¨æ„<code>Str2</code>ä¸¤ä¸¤äº¤æ¢äº†ï¼‰ç›¸ç­‰ã€‚</p><p>æ‰€ä»¥è§£å¯†è„šæœ¬æ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> hexlify, unhexlify<br><span class="hljs-keyword">from</span> string <span class="hljs-keyword">import</span> ascii_lowercase, ascii_uppercase, digits<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes<br><span class="hljs-keyword">from</span> pysm4 <span class="hljs-keyword">import</span> decrypt<br><br>Str1 = <span class="hljs-string">&#x27;&#x27;</span><br>Str2 = <span class="hljs-string">&#x27;1UTAOIkpyOSWGv/mOYFY4R!!&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(Str2), <span class="hljs-number">2</span>):<br>    Str1 += Str2[i:i+<span class="hljs-number">2</span>][::-<span class="hljs-number">1</span>]<br><span class="hljs-comment"># å¤§å°å†™äº’æ¢</span><br>table1 = ascii_lowercase + ascii_uppercase + digits + <span class="hljs-string">&#x27;+/&#x27;</span><br><span class="hljs-comment"># æ­£å¸¸base64è¡¨</span><br>table2 = <span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span><br><span class="hljs-comment"># å¾ªç¯å³ç§»</span><br>table1 = table1[<span class="hljs-number">24</span>:] + table1[:<span class="hljs-number">24</span>]<br>translatetable = <span class="hljs-built_in">str</span>.maketrans(table1, table2)<br><span class="hljs-comment"># ! -&gt; =</span><br>Str1 = Str1.replace(<span class="hljs-string">&#x27;!&#x27;</span>, <span class="hljs-string">&#x27;=&#x27;</span>)<br><span class="hljs-comment">#base64è§£å¯†</span><br>sm4cipher = base64.b64decode(Str1.translate(translatetable))<br><span class="hljs-comment"># print(sm4cipher)</span><br><span class="hljs-comment">#sm4è§£å¯†</span><br><span class="hljs-comment"># pysm4ä½¿ç”¨è¯´æ˜ï¼šhttps://pypi.org/project/pysm4/</span><br>key = <span class="hljs-string">&#x27;where_are_u_now?&#x27;</span><br>flag = decrypt(<span class="hljs-built_in">int</span>(hexlify(sm4cipher), <span class="hljs-number">16</span>), <span class="hljs-built_in">int</span>(hexlify(key.encode()), <span class="hljs-number">16</span>))<span class="hljs-comment">#å‚æ•°å¾—æ˜¯æ•°å­—</span><br><span class="hljs-built_in">print</span>(long_to_bytes(flag))<br></code></pre></td></tr></table></figure><h1 id="äºŒã€é¢˜å¤–è¯"><a href="#äºŒã€é¢˜å¤–è¯" class="headerlink" title="äºŒã€é¢˜å¤–è¯"></a>äºŒã€é¢˜å¤–è¯</h1><p>åœ¨å†™é¢˜è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ›¾å›°æƒ‘äºä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼Œåç»è¯¢é—®æ±ªä½¬æ‰å¾—çŸ¥æ˜¯æ€ä¹ˆå›äº‹ã€‚</p><h2 id="2-1-MessageBoxwæ˜¯æ€ä¹ˆè¢«hookçš„ï¼Ÿ"><a href="#2-1-MessageBoxwæ˜¯æ€ä¹ˆè¢«hookçš„ï¼Ÿ" class="headerlink" title="2.1 MessageBoxwæ˜¯æ€ä¹ˆè¢«hookçš„ï¼Ÿ"></a>2.1 MessageBoxwæ˜¯æ€ä¹ˆè¢«hookçš„ï¼Ÿ</h2><p>æˆ‘ä»¬å›åˆ°è¿™ä¸ªhookåä»£æ›¿æ‰§è¡Œçš„å‡½æ•°ä¸­ï¼Œå¯¹å‡½æ•°åæŒ‰ <code>x</code> è¿½æº¯æ¥æºï¼Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309062123765.jpg"></p><p>æˆ‘ä»¬æœ‰ç†ç”±æ€€ç–‘<code>GetModuleHandleW</code>å‡½æ•°æ˜¯åœ¨è·å–<code>User32.dll</code>æ¨¡å—ï¼Œç„¶åå†åœ¨è¯¥æ¨¡å—ä¸­å¯»æ‰¾<code>MessageBoxw</code>å‡½æ•°åœ°å€çš„åœ°å€ã€‚æœ€åä¿®æ”¹å‡½æ•°åœ°å€è¾¾åˆ°hookç›®çš„ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬è¿›è¡ŒåŠ¨è°ƒè¯•ä¸€è¯•ã€‚ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p>å›¾1ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309062123844.jpg"></p><p>å›¾2ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309062124360.jpg"></p><p>è¿™é‡Œå·²ç»éªŒè¯äº†ä¸€éƒ¨åˆ†çŒœæƒ³ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å†æ¬¡è¿½æº¯<code>a3</code>çš„æ¥æºï¼Œå› ä¸ºå®ƒæ˜¯ä½œä¸ºå‚æ•°ä¼ å…¥çš„ï¼Œæ‰€ä»¥ç›¸å½“äºè¿½æº¯å‡½æ•°è°ƒç”¨ã€‚è¿½æº¯ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309062124773.jpg"></p><p>åŒæ ·ä¹Ÿä¸‹æ–­ç‚¹è¿›è¡ŒåŠ¨è°ƒï¼Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309062124926.jpg"></p><p>é€šè¿‡<code>LoadLibraryA</code>è½½å…¥<code>User32.dll</code>åº“ï¼Œç„¶åå†é€šè¿‡<code>GetProcAddress</code>è·å–<code>MessageBoxw</code>å‡½æ•°çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯<code>a3</code>çš„æ¥æºã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±ç†æ¸…äº†<code>MessageBoxw</code>æ˜¯å¦‚ä½•è¢«hookçš„äº†ï¼</p><h2 id="2-2-æ˜æ˜åªæ˜¯èµ‹å€¼sub-41100Få‡½æ•°åœ°å€ï¼Œå®ƒæ€ä¹ˆå°±è¢«è°ƒç”¨äº†å‘¢ï¼Ÿ"><a href="#2-2-æ˜æ˜åªæ˜¯èµ‹å€¼sub-41100Få‡½æ•°åœ°å€ï¼Œå®ƒæ€ä¹ˆå°±è¢«è°ƒç”¨äº†å‘¢ï¼Ÿ" class="headerlink" title="2.2 æ˜æ˜åªæ˜¯èµ‹å€¼sub_41100Få‡½æ•°åœ°å€ï¼Œå®ƒæ€ä¹ˆå°±è¢«è°ƒç”¨äº†å‘¢ï¼Ÿ"></a>2.2 æ˜æ˜åªæ˜¯èµ‹å€¼sub_41100Få‡½æ•°åœ°å€ï¼Œå®ƒæ€ä¹ˆå°±è¢«è°ƒç”¨äº†å‘¢ï¼Ÿ</h2><p>åœ¨<code>main_0</code>å‡½æ•°ä¸­ï¼Œè·Ÿ<code>sub_41100F</code>å‡½æ•°æœ‰å…³å°±æ˜¯é‚£è¡Œèµ‹å€¼ä»£ç ï¼Œæ˜¾ç„¶ä¸å¯èƒ½è®©å®ƒæ‰§è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬æ¥çœ‹å®ƒçš„æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">push</span>    offset sub_5F100F//å¼‚å¸¸å¤„ç†ç¨‹åº<br><span class="hljs-keyword">push</span>    large <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> <span class="hljs-built_in">fs</span>:<span class="hljs-number">0</span>//SEH Linked Listå¤´<br><span class="hljs-keyword">mov</span>     large <span class="hljs-built_in">fs</span>:<span class="hljs-number">0</span>, <span class="hljs-built_in">esp</span>//æ·»åŠ é“¾è¡¨<br><span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-number">0</span><br><span class="hljs-keyword">mov</span>     <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">eax</span>], <span class="hljs-number">1</span><br><span class="hljs-keyword">pop</span>     small [large <span class="hljs-built_in">word</span> <span class="hljs-built_in">ptr</span> <span class="hljs-built_in">fs</span>:<span class="hljs-number">0</span>]<br><span class="hljs-keyword">add</span>     <span class="hljs-built_in">esp</span>, <span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªSEHå¼‚å¸¸å¤„ç†ã€‚è€Œ<code>sub_5F100F</code>æ­£å¥½ä½œä¸ºå¼‚å¸¸å¤„ç†ç¨‹åºè¢«è°ƒç”¨ã€‚</p><p>å€Ÿç”¨æŸç½‘å‹çš„ä¸€å¥è¯ï¼š<code>FSå¸¸ç”¨äºå¼‚å¸¸å¤„ç†ï¼Œè¿™é‡Œæ˜¯å¼‚å¸¸å¤„ç†ç¨‹åºçš„æŒ‡é’ˆå…¥æ ˆï¼Œä»¥ä¾¿STACK rewindã€‚</code></p><p>ä¹Ÿå‚è€ƒäº†[<a href="https://bbs.kanxue.com/thread-249592.htm">åŸåˆ›]windows-SEHè¯¦è§£-è½¯ä»¶é€†å‘-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a>ã€‚</p><p>è‡³äºå…·ä½“çš„ç»†èŠ‚è¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚<del>ï¼ˆå› ä¸ºæˆ‘ä¹Ÿä¸ä¼šï¼‰</del></p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NPUCTF2020-ä½ å¥½saoå•Š</title>
    <link href="/2023/09/04/NPUCTF2020-%E4%BD%A0%E5%A5%BDsao%E5%95%8A/"/>
    <url>/2023/09/04/NPUCTF2020-%E4%BD%A0%E5%A5%BDsao%E5%95%8A/</url>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042211131.png"></p><p>ä»£ç æ„æ€å¾ˆæ˜ç¡®ï¼Œè®©æˆ‘ä»¬è¾“å…¥ä¸€ä¸ª33bytesçš„å­—ç¬¦ä¸²ï¼Œè¿›è¡ŒåŠ å¯†åï¼Œè·Ÿå·²çŸ¥å­—ç¬¦ä¸²ç›¸æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰å°±æˆåŠŸï¼Œå¦åˆ™å¤±è´¥ã€‚</p><p>å› ä¸ºwindowsä¸Šæ•°æ®å­˜å‚¨æ˜¯å°ç«¯å­˜å‚¨ï¼Œæ‰€ä»¥å·²çŸ¥å­—ç¬¦ä¸²çš„é¡ºåºéœ€è¦æ‰‹åŠ¨è°ƒæ•´ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åŠ¨æ€è°ƒè¯•ä¹‹åç›´æ¥ä»å†…å­˜ä¸­å¤åˆ¶è¿‡æ¥ã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">unsigned char ida_chars[] =<br>&#123;<br>  <span class="hljs-number">0x9E</span>, <span class="hljs-number">0x9B</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0xB5</span>, <span class="hljs-number">0xFE</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">0xD3</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB2</span>, <span class="hljs-number">0xD1</span>, <br>  <span class="hljs-number">0x4F</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x7F</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0xDE</span>, <span class="hljs-number">0x59</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x63</span>, <span class="hljs-number">0xE7</span>, <br>  <span class="hljs-number">0x40</span>, <span class="hljs-number">0x9D</span>, <span class="hljs-number">0xCD</span>, <span class="hljs-number">0xFA</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span><br>&#125;<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯åˆ†æåŠ å¯†å‡½æ•°ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042211887.png"></p><p>å¤§æ¦‚å¯ä»¥çŒœæµ‹åˆ°è¿™æ˜¯ä¸€ä¸ªbase64è§£å¯†å‡½æ•°ï¼Œä½†æ˜¯å¯¹ç…§è¡¨å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿›å…¥åˆ°<code>find_posc()</code>å‡½æ•°ä¸­å¯ä»¥çŸ¥é“å¯¹ç…§è¡¨ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234</span>&#123;&#125;<span class="hljs-number">789</span>+/=<br></code></pre></td></tr></table></figure><p>æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªå˜è¡¨base64è§£å¯†ï¼Œæˆ‘ä»¬åªè¦è¿›è¡ŒåŠ å¯†å³å¯å¾—åˆ° flagã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">result = [<span class="hljs-number">0x9E</span>, <span class="hljs-number">0x9B</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0xB5</span>, <span class="hljs-number">0xFE</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">0xD3</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xB2</span>, <span class="hljs-number">0xD1</span>, <span class="hljs-number">0x4F</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x7F</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0xDE</span>, <span class="hljs-number">0x59</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x63</span>, <span class="hljs-number">0xE7</span>,  <span class="hljs-number">0x40</span>, <span class="hljs-number">0x9D</span>, <span class="hljs-number">0xCD</span>, <span class="hljs-number">0xFA</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>]<br>table = <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234&#123;&#125;789+/=&quot;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> result:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(i),end=<span class="hljs-string">&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><p>æ‰“å°å‡ºæ¥çš„å­—ç¬¦ä¸²æ‹¿å»è§£å¯†ï¼ˆè¿™ä¸ªå·¥å…·ä¸èƒ½ä»¥16è¿›åˆ¶ä½œä¸ºè¾“å…¥ï¼‰</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042212964.png"></p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GKCTF2021-QQQQT</title>
    <link href="/2023/09/04/GKCTF2021-QQQQT/"/>
    <url>/2023/09/04/GKCTF2021-QQQQT/</url>
    
    <content type="html"><![CDATA[<p><code>Exeinfo PE</code>æŸ¥çœ‹<code>exe</code>ä¿¡æ¯ï¼Œå‘ç°æ˜¯<code>Enigma Virtual Box</code>ã€‚è¿™æ˜¯å•¥ç©æ„ï¼Œç½‘ä¸Šæœç´¢åˆ°äº†ç›¸å…³ä¿¡æ¯ï¼š</p><blockquote><p>Enigma Virtual Boxæ˜¯è½¯ä»¶è™šæ‹ŸåŒ–å·¥å…·ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ªæ–‡ä»¶å°è£…åˆ°åº”ç”¨ç¨‹åºä¸»æ–‡ä»¶ï¼Œä»è€Œåˆ¶ä½œæˆä¸ºå•æ‰§è¡Œæ–‡ä»¶exe</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª<code>exe</code>æ–‡ä»¶æ˜¯é€šè¿‡æ‰“åŒ…å¾—åˆ°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¯¹å…¶è¿›è¡Œè§£åŒ…ï¼Œå·¥å…·ä¸‹è½½é“¾æ¥å¦‚ä¸‹ï¼š</p><p><a href="https://www.52pojie.cn/thread-1575691-1-1.html">EnigmaVBUnpacker v0.59ï¼ˆEnigma Virtual Box è§£åŒ…å·¥å…·ï¼‰ - ã€é€†å‘èµ„æºåŒºã€ - å¾çˆ±ç ´è§£ - LCG - LSG |å®‰å“ç ´è§£|ç—…æ¯’åˆ†æ|www.52pojie.cn</a></p><p>å¯¹è§£åŒ…å¾—åˆ°çš„<code>exe</code>æ–‡ä»¶ç”¨<code>IDA</code>åˆ†æã€‚<code>shift+F12</code>æ‰¾å­—ç¬¦ä¸²ï¼Œæ‰¾<code>56fkoP8KhwCf3v7CEz</code>å­—ç¬¦ä¸²ï¼ˆä¹Ÿè®¸ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œä¹Ÿå¯ä»¥å·¦ä¾§å‡½æ•°è¡¨ä¸­æŒ¨ä¸ªæ‰¾ï¼‰ï¼Œä¸Šé¢çš„å­—ç¬¦ä¸²æ˜¯æˆ‘ä»¬è¿è¡Œåº”ç”¨æ‰€çœ‹åˆ°çš„ç•Œé¢ä¸­çš„æ–‡æœ¬ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042209870.png"></p><p><a href="http://www.codebaoku.com/bcalg/bcalg-base58.html">base58 ç¼–ç åŸç†å’Œå®ç°æ–¹æ³• - ç¼–ç¨‹å®åº“ (codebaoku.com)</a></p><p><code>Base58</code>ç¼–ç ä¸åŒäº<code>base64</code>ç¼–ç ä¸­ä½¿ç”¨3ä¸ªå­—ç¬¦è½¬4ä¸ªå­—ç¬¦çš„æ–¹æ³•ï¼Œè€Œæ˜¯é‡‡ç”¨è¾—è½¬ç›¸é™¤æ³•ã€‚æœ¬è´¨ä¸Šï¼Œbase64ç¼–ç æ˜¯64è¿›åˆ¶ï¼Œbase58æ˜¯58è¿›åˆ¶ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>QCTF2018-Xman-babymips</title>
    <link href="/2023/09/04/QCTF2018-Xman-babymips/"/>
    <url>/2023/09/04/QCTF2018-Xman-babymips/</url>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042207989.png"></p><p>å¯ä»¥çœ‹åˆ°ä¸Šè¿°ä»£ç ä¸åŒäºæ±‡ç¼–ä»£ç ï¼Œæ˜¯<code>MIPS</code>æŒ‡ä»¤ï¼Œä¸è¿‡å¥½åœ¨IDAæœ‰ç›¸åº”çš„æ’ä»¶åæ±‡ç¼–è¿™ç§ä»£ç ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042207283.png"></p><p>æ•´ä¸ªä»£ç æµç¨‹ä¸ºï¼šæˆ‘ä»¬è¾“å…¥32bytesçš„å­—ç¬¦ä¸²ï¼Œå…ˆè¿›è¡Œå¼‚æˆ–ï¼Œç„¶åæ¯”è¾ƒå‰5bytesçš„å­—ç¬¦æ˜¯å¦ç›¸ç­‰ï¼Œç„¶åè¿›å…¥<code>sub_4007F0</code>å‡½æ•°ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042207942.png"></p><p>å°†å27byteså­—ç¬¦ä¸²è¿›è¡Œç§»ä½è¿ç®—ï¼Œç„¶åå†ä¸å­—ç¬¦ä¸²æ¯”è¾ƒã€‚</p><p>ç›¸åº”çš„é€†å‘æ¯”è¾ƒç®€å•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#include &lt;stdio.h&gt;</span><br><br><span class="hljs-built_in">int</span> main()&#123;<br><br>char v5[<span class="hljs-number">32</span>] = &#123;<span class="hljs-string">&#x27;Q&#x27;</span>,<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-string">&#x27;j&#x27;</span>,<span class="hljs-string">&#x27;&#123;&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>&#125;;<br><br>unsigned char off_410D04[] =&#123;<br><span class="hljs-number">0x52</span>, <span class="hljs-number">0xFD</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0xA4</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xBD</span>, <span class="hljs-number">0x92</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x41</span>, <br><span class="hljs-number">0x54</span>, <span class="hljs-number">0xA0</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xDE</span>, <span class="hljs-number">0xFC</span>, <span class="hljs-number">0x95</span>, <span class="hljs-number">0xF0</span>, <br><span class="hljs-number">0x16</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x5B</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x1F</span><br>&#125;;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i=<span class="hljs-number">5</span>;i&lt;<span class="hljs-number">32</span>;i++)&#123;<br><span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )&#123;<br>v5[i] = (off_410D04[i-<span class="hljs-number">5</span>] &gt;&gt; <span class="hljs-number">6</span>) | (off_410D04[i-<span class="hljs-number">5</span>] &lt;&lt; <span class="hljs-number">2</span>);<br>&#125;<br><span class="hljs-keyword">else</span>             <br>v5[i] = (off_410D04[i-<span class="hljs-number">5</span>] &lt;&lt; <span class="hljs-number">6</span>) | (off_410D04[i-<span class="hljs-number">5</span>] &gt;&gt; <span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">32</span>;i++)&#123;<br>v5[i] ^= <span class="hljs-number">32</span> - i;<br>printf(<span class="hljs-string">&quot;%c&quot;</span>,v5[i]);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¾ŠåŸæ¯2020-login</title>
    <link href="/2023/09/04/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020login/"/>
    <url>/2023/09/04/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020login/</url>
    
    <content type="html"><![CDATA[<p>é™„ä»¶æ˜¯ä¸ªpythonç¼–å†™çš„exeç¨‹åºï¼ˆä»å›¾æ ‡ä¸­å°±å¯ä»¥çœ‹å‡ºæ¥ï¼‰ï¼Œå…ˆè¿è¡Œä¸€ä¸‹ï¼Œç»™å‡ºäº†å­—ç¬¦ä¸²<code>input somthing</code>ï¼Œç„¶åå°è¯•ç”¨IDAåˆ†æï¼Œå¯æƒœä¸è¡Œï¼Œ<code>shift+F12</code>ä¹Ÿæ‰¾ä¸åˆ°ç›¸åº”çš„å­—ç¬¦ä¸²ã€‚</p><p>å› ä¸ºpythonä»£ç è¦é€šè¿‡æ‰“åŒ…æ‰èƒ½å˜æˆexeæ–‡ä»¶ï¼Œæ‰€ä»¥å€ŸåŠ©æµè§ˆå™¨æœç´¢pythonç¼–å†™çš„exeå¦‚ä½•åç¼–è¯‘pyæ–‡ä»¶ï¼Œæ‰¾åˆ°äº†ç›¸åº”çš„æ–‡ç« ï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/394049570">Pythonè§£åŒ…åŠåç¼–è¯‘: PyInstaller Extractor+uncompyle6 - çŸ¥ä¹ (zhihu.com)</a></p><p>æ­¥éª¤å°±ä¸è¯¦è¿°äº†ï¼Œé“¾æ¥æ–‡ç« ä¸­éƒ½æœ‰ã€‚æœ€ç»ˆå¾—åˆ°pyæ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># uncompyle6 version 3.9.0</span><br><span class="hljs-comment"># Python bytecode version base 3.6 (3379)</span><br><span class="hljs-comment"># Decompiled from: Python 3.7.0 (v3.7.0:1bf9cc5093, Jun 27 2018, 04:59:51) [MSC v.1914 64 bit (AMD64)]</span><br><span class="hljs-comment"># Embedded file name: login.py</span><br><span class="hljs-keyword">import</span> sys<br>input1 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;input something:&#x27;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(input1) != <span class="hljs-number">14</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Wrong length!&#x27;</span>)<br>    sys.exit()<br><span class="hljs-keyword">else</span>:<br>    code = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">13</span>):<br>        code.append(<span class="hljs-built_in">ord</span>(input1[i]) ^ <span class="hljs-built_in">ord</span>(input1[i + <span class="hljs-number">1</span>]))<br><br>    code.append(<span class="hljs-built_in">ord</span>(input1[<span class="hljs-number">13</span>]))<br>    a1 = code[<span class="hljs-number">2</span>]<br>    a2 = code[<span class="hljs-number">1</span>]<br>    a3 = code[<span class="hljs-number">0</span>]<br>    a4 = code[<span class="hljs-number">3</span>]<br>    a5 = code[<span class="hljs-number">4</span>]<br>    a6 = code[<span class="hljs-number">5</span>]<br>    a7 = code[<span class="hljs-number">6</span>]<br>    a8 = code[<span class="hljs-number">7</span>]<br>    a9 = code[<span class="hljs-number">9</span>]<br>    a10 = code[<span class="hljs-number">8</span>]<br>    a11 = code[<span class="hljs-number">10</span>]<br>    a12 = code[<span class="hljs-number">11</span>]<br>    a13 = code[<span class="hljs-number">12</span>]<br>    a14 = code[<span class="hljs-number">13</span>]<br>    <span class="hljs-keyword">if</span> (a1 * <span class="hljs-number">88</span> + a2 * <span class="hljs-number">67</span> + a3 * <span class="hljs-number">65</span> - a4 * <span class="hljs-number">5</span> + a5 * <span class="hljs-number">43</span> + a6 * <span class="hljs-number">89</span> + a7 * <span class="hljs-number">25</span> + a8 * <span class="hljs-number">13</span> - a9 * <span class="hljs-number">36</span> + a10 * <span class="hljs-number">15</span> + a11 * <span class="hljs-number">11</span> + a12 * <span class="hljs-number">47</span> - a13 * <span class="hljs-number">60</span> + a14 * <span class="hljs-number">29</span> == <span class="hljs-number">22748</span>) &amp; (a1 * <span class="hljs-number">89</span> + a2 * <span class="hljs-number">7</span> + a3 * <span class="hljs-number">12</span> - a4 * <span class="hljs-number">25</span> + a5 * <span class="hljs-number">41</span> + a6 * <span class="hljs-number">23</span> + a7 * <span class="hljs-number">20</span> - a8 * <span class="hljs-number">66</span> + a9 * <span class="hljs-number">31</span> + a10 * <span class="hljs-number">8</span> + a11 * <span class="hljs-number">2</span> - a12 * <span class="hljs-number">41</span> - a13 * <span class="hljs-number">39</span> + a14 * <span class="hljs-number">17</span> == <span class="hljs-number">7258</span>) &amp; (a1 * <span class="hljs-number">28</span> + a2 * <span class="hljs-number">35</span> + a3 * <span class="hljs-number">16</span> - a4 * <span class="hljs-number">65</span> + a5 * <span class="hljs-number">53</span> + a6 * <span class="hljs-number">39</span> + a7 * <span class="hljs-number">27</span> + a8 * <span class="hljs-number">15</span> - a9 * <span class="hljs-number">33</span> + a10 * <span class="hljs-number">13</span> + a11 * <span class="hljs-number">101</span> + a12 * <span class="hljs-number">90</span> - a13 * <span class="hljs-number">34</span> + a14 * <span class="hljs-number">23</span> == <span class="hljs-number">26190</span>) &amp; (a1 * <span class="hljs-number">23</span> + a2 * <span class="hljs-number">34</span> + a3 * <span class="hljs-number">35</span> - a4 * <span class="hljs-number">59</span> + a5 * <span class="hljs-number">49</span> + a6 * <span class="hljs-number">81</span> + a7 * <span class="hljs-number">25</span> + (a8 &lt;&lt; <span class="hljs-number">7</span>) - a9 * <span class="hljs-number">32</span> + a10 * <span class="hljs-number">75</span> + a11 * <span class="hljs-number">81</span> + a12 * <span class="hljs-number">47</span> - a13 * <span class="hljs-number">60</span> + a14 * <span class="hljs-number">29</span> == <span class="hljs-number">37136</span>) &amp; (a1 * <span class="hljs-number">38</span> + a2 * <span class="hljs-number">97</span> + a3 * <span class="hljs-number">35</span> - a4 * <span class="hljs-number">52</span> + a5 * <span class="hljs-number">42</span> + a6 * <span class="hljs-number">79</span> + a7 * <span class="hljs-number">90</span> + a8 * <span class="hljs-number">23</span> - a9 * <span class="hljs-number">36</span> + a10 * <span class="hljs-number">57</span> + a11 * <span class="hljs-number">81</span> + a12 * <span class="hljs-number">42</span> - a13 * <span class="hljs-number">62</span> - a14 * <span class="hljs-number">11</span> == <span class="hljs-number">27915</span>) &amp; (a1 * <span class="hljs-number">22</span> + a2 * <span class="hljs-number">27</span> + a3 * <span class="hljs-number">35</span> - a4 * <span class="hljs-number">45</span> + a5 * <span class="hljs-number">47</span> + a6 * <span class="hljs-number">49</span> + a7 * <span class="hljs-number">29</span> + a8 * <span class="hljs-number">18</span> - a9 * <span class="hljs-number">26</span> + a10 * <span class="hljs-number">35</span> + a11 * <span class="hljs-number">41</span> + a12 * <span class="hljs-number">40</span> - a13 * <span class="hljs-number">61</span> + a14 * <span class="hljs-number">28</span> == <span class="hljs-number">17298</span>) &amp; (a1 * <span class="hljs-number">12</span> + a2 * <span class="hljs-number">45</span> + a3 * <span class="hljs-number">35</span> - a4 * <span class="hljs-number">9</span> - a5 * <span class="hljs-number">42</span> + a6 * <span class="hljs-number">86</span> + a7 * <span class="hljs-number">23</span> + a8 * <span class="hljs-number">85</span> - a9 * <span class="hljs-number">47</span> + a10 * <span class="hljs-number">34</span> + a11 * <span class="hljs-number">76</span> + a12 * <span class="hljs-number">43</span> - a13 * <span class="hljs-number">44</span> + a14 * <span class="hljs-number">65</span> == <span class="hljs-number">19875</span>) &amp; (a1 * <span class="hljs-number">79</span> + a2 * <span class="hljs-number">62</span> + a3 * <span class="hljs-number">35</span> - a4 * <span class="hljs-number">85</span> + a5 * <span class="hljs-number">33</span> + a6 * <span class="hljs-number">79</span> + a7 * <span class="hljs-number">86</span> + a8 * <span class="hljs-number">14</span> - a9 * <span class="hljs-number">30</span> + a10 * <span class="hljs-number">25</span> + a11 * <span class="hljs-number">11</span> + a12 * <span class="hljs-number">57</span> - a13 * <span class="hljs-number">50</span> - a14 * <span class="hljs-number">9</span> == <span class="hljs-number">22784</span>) &amp; (a1 * <span class="hljs-number">8</span> + a2 * <span class="hljs-number">6</span> + a3 * <span class="hljs-number">64</span> - a4 * <span class="hljs-number">85</span> + a5 * <span class="hljs-number">73</span> + a6 * <span class="hljs-number">29</span> + a7 * <span class="hljs-number">2</span> + a8 * <span class="hljs-number">23</span> - a9 * <span class="hljs-number">36</span> + a10 * <span class="hljs-number">5</span> + a11 * <span class="hljs-number">2</span> + a12 * <span class="hljs-number">47</span> - a13 * <span class="hljs-number">64</span> + a14 * <span class="hljs-number">27</span> == <span class="hljs-number">9710</span>) &amp; (a1 * <span class="hljs-number">67</span> - a2 * <span class="hljs-number">68</span> + a3 * <span class="hljs-number">68</span> - a4 * <span class="hljs-number">51</span> - a5 * <span class="hljs-number">43</span> + a6 * <span class="hljs-number">81</span> + a7 * <span class="hljs-number">22</span> - a8 * <span class="hljs-number">12</span> - a9 * <span class="hljs-number">38</span> + a10 * <span class="hljs-number">75</span> + a11 * <span class="hljs-number">41</span> + a12 * <span class="hljs-number">27</span> - a13 * <span class="hljs-number">52</span> + a14 * <span class="hljs-number">31</span> == <span class="hljs-number">13376</span>) &amp; (a1 * <span class="hljs-number">85</span> + a2 * <span class="hljs-number">63</span> + a3 * <span class="hljs-number">5</span> - a4 * <span class="hljs-number">51</span> + a5 * <span class="hljs-number">44</span> + a6 * <span class="hljs-number">36</span> + a7 * <span class="hljs-number">28</span> + a8 * <span class="hljs-number">15</span> - a9 * <span class="hljs-number">6</span> + a10 * <span class="hljs-number">45</span> + a11 * <span class="hljs-number">31</span> + a12 * <span class="hljs-number">7</span> - a13 * <span class="hljs-number">67</span> + a14 * <span class="hljs-number">78</span> == <span class="hljs-number">24065</span>) &amp; (a1 * <span class="hljs-number">47</span> + a2 * <span class="hljs-number">64</span> + a3 * <span class="hljs-number">66</span> - a4 * <span class="hljs-number">5</span> + a5 * <span class="hljs-number">43</span> + a6 * <span class="hljs-number">112</span> + a7 * <span class="hljs-number">25</span> + a8 * <span class="hljs-number">13</span> - a9 * <span class="hljs-number">35</span> + a10 * <span class="hljs-number">95</span> + a11 * <span class="hljs-number">21</span> + a12 * <span class="hljs-number">43</span> - a13 * <span class="hljs-number">61</span> + a14 * <span class="hljs-number">20</span> == <span class="hljs-number">27687</span>) &amp; (a1 * <span class="hljs-number">89</span> + a2 * <span class="hljs-number">67</span> + a3 * <span class="hljs-number">85</span> - a4 * <span class="hljs-number">25</span> + a5 * <span class="hljs-number">49</span> + a6 * <span class="hljs-number">89</span> + a7 * <span class="hljs-number">23</span> + a8 * <span class="hljs-number">56</span> - a9 * <span class="hljs-number">92</span> + a10 * <span class="hljs-number">14</span> + a11 * <span class="hljs-number">89</span> + a12 * <span class="hljs-number">47</span> - a13 * <span class="hljs-number">61</span> - a14 * <span class="hljs-number">29</span> == <span class="hljs-number">29250</span>) &amp; (a1 * <span class="hljs-number">95</span> + a2 * <span class="hljs-number">34</span> + a3 * <span class="hljs-number">62</span> - a4 * <span class="hljs-number">9</span> - a5 * <span class="hljs-number">43</span> + a6 * <span class="hljs-number">83</span> + a7 * <span class="hljs-number">25</span> + a8 * <span class="hljs-number">12</span> - a9 * <span class="hljs-number">36</span> + a10 * <span class="hljs-number">16</span> + a11 * <span class="hljs-number">51</span> + a12 * <span class="hljs-number">47</span> - a13 * <span class="hljs-number">60</span> - a14 * <span class="hljs-number">24</span> == <span class="hljs-number">15317</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;flag is GWHT&#123;md5(your_input)&#125;&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Congratulations and have fun!&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Sorry,plz try again...&#x27;</span>)<br><span class="hljs-comment"># okay decompiling .\login.pyc</span><br></code></pre></td></tr></table></figure><p>æ•´ä¸ªä»£ç æ€è·¯æŒºæ¸…æ™°çš„ï¼Œæ²¡å•¥å¥½è¯´çš„ï¼Œè§£å¯†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br><br><span class="hljs-comment"># z3è§£æ–¹ç¨‹ç»„</span><br>eqstr = <span class="hljs-string">&#x27;(a1 * 88 + a2 * 67 + a3 * 65 - a4 * 5 + a5 * 43 + a6 * 89 + a7 * 25 + a8 * 13 - a9 * 36 + a10 * 15 + a11 * 11 + a12 * 47 - a13 * 60 + a14 * 29 == 22748) &amp; (a1 * 89 + a2 * 7 + a3 * 12 - a4 * 25 + a5 * 41 + a6 * 23 + a7 * 20 - a8 * 66 + a9 * 31 + a10 * 8 + a11 * 2 - a12 * 41 - a13 * 39 + a14 * 17 == 7258) &amp; (a1 * 28 + a2 * 35 + a3 * 16 - a4 * 65 + a5 * 53 + a6 * 39 + a7 * 27 + a8 * 15 - a9 * 33 + a10 * 13 + a11 * 101 + a12 * 90 - a13 * 34 + a14 * 23 == 26190) &amp; (a1 * 23 + a2 * 34 + a3 * 35 - a4 * 59 + a5 * 49 + a6 * 81 + a7 * 25 + (a8*2**7) - a9 * 32 + a10 * 75 + a11 * 81 + a12 * 47 - a13 * 60 + a14 * 29 == 37136) &amp; (a1 * 38 + a2 * 97 + a3 * 35 - a4 * 52 + a5 * 42 + a6 * 79 + a7 * 90 + a8 * 23 - a9 * 36 + a10 * 57 + a11 * 81 + a12 * 42 - a13 * 62 - a14 * 11 == 27915) &amp; (a1 * 22 + a2 * 27 + a3 * 35 - a4 * 45 + a5 * 47 + a6 * 49 + a7 * 29 + a8 * 18 - a9 * 26 + a10 * 35 + a11 * 41 + a12 * 40 - a13 * 61 + a14 * 28 == 17298) &amp; (a1 * 12 + a2 * 45 + a3 * 35 - a4 * 9 - a5 * 42 + a6 * 86 + a7 * 23 + a8 * 85 - a9 * 47 + a10 * 34 + a11 * 76 + a12 * 43 - a13 * 44 + a14 * 65 == 19875) &amp; (a1 * 79 + a2 * 62 + a3 * 35 - a4 * 85 + a5 * 33 + a6 * 79 + a7 * 86 + a8 * 14 - a9 * 30 + a10 * 25 + a11 * 11 + a12 * 57 - a13 * 50 - a14 * 9 == 22784) &amp; (a1 * 8 + a2 * 6 + a3 * 64 - a4 * 85 + a5 * 73 + a6 * 29 + a7 * 2 + a8 * 23 - a9 * 36 + a10 * 5 + a11 * 2 + a12 * 47 - a13 * 64 + a14 * 27 == 9710) &amp; (a1 * 67 - a2 * 68 + a3 * 68 - a4 * 51 - a5 * 43 + a6 * 81 + a7 * 22 - a8 * 12 - a9 * 38 + a10 * 75 + a11 * 41 + a12 * 27 - a13 * 52 + a14 * 31 == 13376) &amp; (a1 * 85 + a2 * 63 + a3 * 5 - a4 * 51 + a5 * 44 + a6 * 36 + a7 * 28 + a8 * 15 - a9 * 6 + a10 * 45 + a11 * 31 + a12 * 7 - a13 * 67 + a14 * 78 == 24065) &amp; (a1 * 47 + a2 * 64 + a3 * 66 - a4 * 5 + a5 * 43 + a6 * 112 + a7 * 25 + a8 * 13 - a9 * 35 + a10 * 95 + a11 * 21 + a12 * 43 - a13 * 61 + a14 * 20 == 27687) &amp; (a1 * 89 + a2 * 67 + a3 * 85 - a4 * 25 + a5 * 49 + a6 * 89 + a7 * 23 + a8 * 56 - a9 * 92 + a10 * 14 + a11 * 89 + a12 * 47 - a13 * 61 - a14 * 29 == 29250) &amp; (a1 * 95 + a2 * 34 + a3 * 62 - a4 * 9 - a5 * 43 + a6 * 83 + a7 * 25 + a8 * 12 - a9 * 36 + a10 * 16 + a11 * 51 + a12 * 47 - a13 * 60 - a14 * 24 == 15317)&#x27;</span><br>eqstrlist = eqstr.split(<span class="hljs-string">&#x27;&amp;&#x27;</span>)<br><br>a1, a2, a3, a4, a5, a6, a7, a8, a9, a10, a11, a12, a13, a14 = Ints(<span class="hljs-string">&#x27;a1 a2 a3 a4 a5 a6 a7 a8 a9 a10 a11 a12 a13 a14&#x27;</span>)<br><br>s = Solver()<br><span class="hljs-keyword">for</span> eq <span class="hljs-keyword">in</span> eqstrlist:<br>    s.add(<span class="hljs-built_in">eval</span>(eq))<br><br><span class="hljs-keyword">if</span> s.check() == sat:<br>    result = s.model()<br><br><span class="hljs-built_in">print</span>(result)<br><br><span class="hljs-comment"># æ¢å¤é¡ºåº</span><br>code = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">14</span>)]<br>code[<span class="hljs-number">2</span>] = result[a1].as_long()<br>code[<span class="hljs-number">1</span>] = result[a2].as_long()<br>code[<span class="hljs-number">0</span>] = result[a3].as_long()<br>code[<span class="hljs-number">3</span>] = result[a4].as_long()<br>code[<span class="hljs-number">4</span>] = result[a5].as_long()<br>code[<span class="hljs-number">5</span>] = result[a6].as_long()<br>code[<span class="hljs-number">6</span>] = result[a7].as_long()<br>code[<span class="hljs-number">7</span>] = result[a8].as_long()<br>code[<span class="hljs-number">9</span>] = result[a9].as_long()<br>code[<span class="hljs-number">8</span>] = result[a10].as_long()<br>code[<span class="hljs-number">10</span>] = result[a11].as_long()<br>code[<span class="hljs-number">11</span>] = result[a12].as_long()<br>code[<span class="hljs-number">12</span>] = result[a13].as_long()<br>code[<span class="hljs-number">13</span>] = result[a14].as_long()<br><br><span class="hljs-comment"># æ¢å¤å‰åå¼‚æˆ–</span><br>input1 = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">14</span>)]<br>input1[<span class="hljs-number">13</span>] = code[<span class="hljs-number">13</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">12</span>,-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>):<br>    input1[i] = code[i] ^ input1[i+<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">#è·å–md5</span><br>flag = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">chr</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> input1)<br><span class="hljs-built_in">print</span>(md5(flag.encode()).hexdigest())<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SWPU2019-ReverseMe</title>
    <link href="/2023/09/04/SWPU2019ReverseMe/"/>
    <url>/2023/09/04/SWPU2019ReverseMe/</url>
    
    <content type="html"><![CDATA[<h2 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h2><p>IDAæ‰“å¼€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆéƒ¨åˆ†åˆ†æåœ¨å›¾ä¸Šï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042159304.png"></p><p>åŸºæœ¬å¯ä»¥ç¡®å®šï¼Œæˆ‘ä»¬è¦è®©<code>v16=0</code>æ‰æ˜¯æ­£ç¡®çš„ï¼Œè€Œèƒ½ä½¿<code>v16=0</code>æœ‰ä¸¤æ¡è·¯å¾„ï¼Œç¬¬ä¸€æ¡æ˜¯ä¼ªä»£ç ä¸­ç¬¬89<del>103è¡Œçš„ <code>while</code> å¾ªç¯ï¼Œç¬¬äºŒæ¡æ˜¯ä¼ªä»£ç ä¸­ç¬¬105</del>111è¡Œçš„<code>if</code>è¯­å¥ã€‚æ˜¾ç„¶ï¼Œç¬¬äºŒæ¡è·¯å¾„æ˜¯èµ°ä¸é€šçš„ï¼Œå› ä¸ºä¸å¯èƒ½å­˜åœ¨åŒæ—¶æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">v17 = v18 &lt; *((_BYTE *)v13 + <span class="hljs-number">1</span>), v18 == *((_BYTE *)v13 + <span class="hljs-number">1</span>)<br>v17 = v19 &lt; *((_BYTE *)v13 + <span class="hljs-number">2</span>), v19 == *((_BYTE *)v13 + <span class="hljs-number">2</span>)<br>v17 = v20 &lt; *((_BYTE *)v13 + <span class="hljs-number">3</span>), v20 == *((_BYTE *)v13 + <span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å”¯ä¸€èƒ½è¡Œçš„æ˜¯é€šè¿‡<code>while</code>å¾ªç¯çš„è·¯å¾„ä½¿å¾—<code>v16=0</code>ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ä»å¤´å¼€å§‹åˆ†æä¼ªä»£ç ã€‚é¦–å…ˆæ˜¯è®©æˆ‘ä»¬è¾“å…¥é•¿åº¦ä¸º32bytesçš„å­—ç¬¦ä¸²ï¼Œå­˜æ”¾äº<code>Block</code>ä¸­ï¼Œç„¶åå°†å­—ç¬¦ä¸²â€SWPU_2019_CTFâ€å¤åˆ¶ç»™<code>v33</code>ï¼Œæ¥ç€æ˜¯ä¸€ä¸ª<code>while</code>å¾ªç¯ä½¿<code>Block</code>å¾ªç¯å¼‚æˆ–<code>v33</code>ã€‚ä¹‹åæœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°<code>sub_D625C0</code>ï¼ˆçº¦ç¬¬77è¡Œï¼‰ï¼Œç¨åè¯¦ç»†è¯´æ˜ã€‚åœ¨è¿™ä¹‹åï¼Œåˆæ˜¯<code>while</code>å¾ªç¯ï¼Œé‡Œé¢è®©<code>v12</code>ä¸<code>v13</code>ä½œæ¯”è¾ƒï¼Œ<code>v12</code>æ¥è‡ªæ•°ç»„<code>v34</code>ï¼ˆå·²çŸ¥ï¼‰,<code>v13</code>æ¥è‡ªæ•°ç»„<code>v28</code>ï¼Œç›®å‰æ¥çœ‹æ•°ç»„<code>v28</code>ä¸º0ï¼Œæ˜¾ç„¶<code>v12</code>ä¸<code>v13</code>ä¸å¯èƒ½ç›¸ç­‰ï¼Œä½†åœ¨åˆšæ‰çš„åˆ†æä¸­ï¼Œåˆå¿…é¡»æ˜¯è¿™é‡Œä½¿å¾—<code>v16=0</code>ï¼Œæ‰€ä»¥ææœ‰å¯èƒ½æ˜¯åˆšåˆšæåˆ°çš„å‡½æ•°<code>sub_D625C0</code>ï¼ˆçº¦ç¬¬77è¡Œï¼‰ä¿®æ”¹äº†æ•°ç»„<code>v28</code>ã€‚</p><p>è¿™é‡Œä½¿ç”¨åŠ¨æ€è°ƒè¯•æ¥åˆ†æã€‚é¦–å…ˆåœ¨<code>jnz</code>å¤„ä¸‹æ–­ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042159119.png"></p><p>éšä¾¿è¾“å…¥é•¿åº¦ä¸º32çš„å­—ç¬¦ä¸²ã€‚æ–­ç‚¹è§¦å‘åï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“<code>eax</code>ï¼ˆæ•°ç»„<code>v12</code>ï¼‰å’Œ<code>edx</code>ï¼ˆæ•°ç»„<code>v13</code>ï¼‰çš„å€¼ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> eax[] =<br>&#123;<br>  <span class="hljs-number">0xB3</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xF8</span>, <span class="hljs-number">0xBC</span>, <span class="hljs-number">0xBC</span>, <span class="hljs-number">0xAE</span>, <span class="hljs-number">0x5D</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x5A</span>, <br>  <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0xD3</span>, <span class="hljs-number">0x4F</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x16</span>, <br>  <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x9F</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x6D</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x6B</span>, <br>  <span class="hljs-number">0xC8</span>, <span class="hljs-number">0x67</span><br>&#125;;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> edx[] =<br>&#123;<br>  <span class="hljs-number">0xE4</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0xAE</span>, <span class="hljs-number">0xF6</span>, <span class="hljs-number">0xD4</span>, <span class="hljs-number">0xAF</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0xEA</span>, <span class="hljs-number">0x19</span>, <br>  <span class="hljs-number">0x19</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x1D</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0xD1</span>, <span class="hljs-number">0x0D</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0x04</span>, <br>  <span class="hljs-number">0x7A</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0x2D</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0xE7</span>, <span class="hljs-number">0x19</span>, <br>  <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x2B</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç”±äºæ•°ç»„<code>v12</code>å·²çŸ¥ï¼Œæ•°ç»„<code>v13</code>æœªçŸ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è·Ÿè¸ª<code>v13</code>æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042200798.png"></p><p>æ˜¾ç„¶åº”è¯äº†æˆ‘ä»¬çš„çŒœæµ‹ï¼Œ<code>v13</code>æ˜¯ç”±å‡½æ•°<code>sub_D625C0</code>æ‰€äº§ç”Ÿçš„ã€‚</p><p>å†è¿›è¡Œæ–°çš„åŠ¨è°ƒï¼Œå»é™¤åŸå…ˆçš„æ–­ç‚¹ï¼Œåœ¨<code>call</code>å¤„ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œåï¼Œå†ç»™<code>ebp+var_88</code>å¼€å§‹çš„32bytesçš„å†…å­˜ä¸‹å†…å­˜æ–­ç‚¹ï¼ˆé€‰ä¸­åæŒ‰<code>F2</code>ï¼‰ã€‚ç„¶åæŒ‰<code>F9</code>ï¼Œç¨‹åºè§¦å‘å†…å­˜æ–­ç‚¹åä¼šåœä¸‹æ¥ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042200851.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå°†<code>ecx</code>ç§»åŠ¨åˆ°ç›®æ ‡å†…å­˜ä¸­ï¼Œè€Œ<code>ecx</code>æ˜¯<code>[esi+eax]</code>å¼‚æˆ–<code>[eax -4]</code>å¾—åˆ°çš„ï¼Œ<code>esi+eax</code>å’Œ<code>eax -4</code>å¼€å§‹çš„å†…å­˜ä¸­çš„å€¼å¦‚ä¸‹ï¼ˆå› ä¸ºè§¦å‘æ–­ç‚¹çš„æ—¶å€™å·²ç»æ‰§è¡Œäº†ä¸€æ­¥ï¼Œæ‰€ä»¥ä¸è¦å°‘äº†å‰é¢4bytesï¼‰:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> esi_eax[] =<br>&#123;<br>  <span class="hljs-number">0x86</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x3E</span>, <span class="hljs-number">0xCA</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0xAE</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0xE2</span>, <span class="hljs-number">0x77</span>, <br>  <span class="hljs-number">0x6B</span>, <span class="hljs-number">0xA6</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0xA1</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xB0</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x05</span>, <br>  <span class="hljs-number">0x7A</span>, <span class="hljs-number">0xF9</span>, <span class="hljs-number">0x7B</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x5A</span>, <span class="hljs-number">0x4B</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x7D</span>, <br>  <span class="hljs-number">0xD4</span>, <span class="hljs-number">0x28</span><br>&#125;;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> eax_4[] =<br>&#123;<br>  <span class="hljs-number">0x62</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x6E</span>, <br>  <span class="hljs-number">0x72</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x01</span>, <br>  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x64</span>, <br>  <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x03</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œç°åœ¨æ— æ³•ç¡®å®šè¿™äº›å€¼æ˜¯ä¸æ˜¯å›ºå®šçš„ã€‚</p><p>è¿˜èƒ½åˆ©ç”¨çš„åº”è¯¥å°±æ˜¯<code>Block</code>ï¼ˆè¾“å…¥å­—ç¬¦ä¸²ï¼‰è·Ÿ<code>v33</code>ï¼ˆå·²çŸ¥å­—ç¬¦ä¸²ï¼‰å¼‚æˆ–åçš„ç»“æœï¼Œæ¯•ç«Ÿæˆ‘ä»¬æœ€ç»ˆå°±æ˜¯è·å–è¾“å…¥ï¼Œè€Œè·Ÿè¾“å…¥æœ‰å…³çš„å°±æ˜¯å¼‚æˆ–åçš„ç»“æœï¼ˆæ²¡æœ‰çš„è¯å¹²å˜›è¦è¿™ä¹ˆåšå‘¢ï¼Ÿï¼‰ã€‚</p><p>é‡æ–°ä¸‹æ–­ç‚¹ï¼Œåœ¨<code>cmp [ebp+var_8C],10h</code>å¤„ä¸‹æ–­ç‚¹ï¼ˆå³doâ€¦whileâ€¦ä¸€å¼€å§‹çš„åœ°æ–¹ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042200006.png"></p><p>æ‰§è¡Œåï¼Œ<code>shift+F12</code>æœç´¢æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼Œä»¥<code>\0</code>ç»“å°¾çš„æ‰æ˜¯ï¼Œæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042200849.png"></p><p>ä¾å›¾æ‰€ç¤ºï¼Œå°±æ˜¯å€’æ•°ç¬¬äºŒä¸ªã€‚ç»™è¿™ç‰‡å†…å­˜ä¸‹å†…å­˜æ–­ç‚¹ï¼Œ<code>F9</code>æ‰§è¡Œè§¦å‘æ–­ç‚¹ï¼ˆå¤šæ‰§è¡Œå‡ æ¬¡ï¼‰ï¼Œå¯ä»¥å‘ç°è¾“å…¥å­—ç¬¦ä¸²æ‰€åœ¨çš„å†…å­˜å‘ç”Ÿæ”¹å˜ï¼Œå³è¿›è¡Œäº†å¼‚æˆ–åŠ å¯†ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042200614.png"></p><p>åœ¨è¯¥éƒ¨åˆ†æ±‡ç¼–ä»£ç ä¸­ï¼Œå¯ä»¥çŸ¥é“<code>edi</code>æ˜¯å­—ç¬¦ä¸²ä¸‹è¡¨ï¼Œ<code>ecx</code>æ˜¯è¾“å…¥å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€ï¼Œå¹¶ä¸”åé¢è¿˜å°†å¼‚æˆ–åçš„å­—ç¬¦ä¸²å¤åˆ¶åˆ°å¦ä¸€ç‰‡å†…å­˜ä¸­ï¼Œå³<code>ebp+var_64</code>å¼€å§‹çš„å†…å­˜ã€‚</p><p>è¿™ä¸€éƒ¨åˆ†æ¸…æ¥šåï¼Œæˆ‘ä»¬æ¸…é™¤åŸæ¥çš„æ‰€æœ‰æ–­ç‚¹ï¼Œç„¶åç»™<code> call sub_D625C0</code>ä¸‹æ–­ç‚¹ï¼ˆå°±æ˜¯ä¼ªä»£ç ä¸­ç¬¬79è¡Œçš„å‡½æ•°ï¼‰ï¼Œæ‰§è¡Œåˆ°è¯¥å¤„åï¼ˆæ­¤æ—¶å·²å°†å¼‚æˆ–åçš„å­—ç¬¦ä¸²å¤åˆ¶åˆ°äº†<code>ebp+var_64</code>å¼€å§‹çš„å†…å­˜ï¼‰ï¼Œå†ç»™<code>ebp+var_64</code>å¼€å§‹çš„å†…å­˜ä¸‹æ–­ç‚¹ã€‚ä¹‹åå†<code>F9</code>è§¦å‘å†…å­˜æ–­ç‚¹ï¼Œ</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042200864.png"></p><p>è¿˜æ˜¯åŸæ¥é‚£ä¸ªåœ°æ–¹ï¼Œ<code>eax-4</code>å¼€å§‹çš„å†…å­˜å­˜å‚¨çš„å°±æ˜¯ä¹‹å‰å¼‚æˆ–å¾—åˆ°çš„å­—ç¬¦ä¸²ã€‚å› æ­¤å¯ä»¥ç¡®å®šçš„æ˜¯<code>esi+eax</code>å¼€å§‹çš„å†…å­˜ä¸­çš„å€¼æ˜¯å›ºå®šçš„ï¼Œè€Œ<code>eax -4</code>å¼€å§‹çš„å†…å­˜ä¸­çš„å€¼æ˜¯å¼‚æˆ–å¾—åˆ°çš„å­—ç¬¦ä¸²ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ï¼Œè¾“å…¥çš„å­—ç¬¦ä¸²å¾ªç¯å¼‚æˆ– â€œSWPU_2019_CTFâ€ ï¼Œå¾—åˆ°çš„ç»“æœå†è·Ÿ</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">unsigned char esi_eax[] =<br>&#123;<br>  <span class="hljs-number">0x86</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x3E</span>, <span class="hljs-number">0xCA</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0xAE</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0xE2</span>, <span class="hljs-number">0x77</span>, <br>  <span class="hljs-number">0x6B</span>, <span class="hljs-number">0xA6</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0xA1</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xB0</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x05</span>, <br>  <span class="hljs-number">0x7A</span>, <span class="hljs-number">0xF9</span>, <span class="hljs-number">0x7B</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x5A</span>, <span class="hljs-number">0x4B</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x7D</span>, <br>  <span class="hljs-number">0xD4</span>, <span class="hljs-number">0x28</span><br>&#125;<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å¼‚æˆ–ï¼Œå¾—åˆ°çš„ç»“æœä¸º</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">unsigned char <span class="hljs-built_in">eax</span>[] =<br>&#123;<br>  <span class="hljs-number">0xB3</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xF8</span>, <span class="hljs-number">0xBC</span>, <span class="hljs-number">0xBC</span>, <span class="hljs-number">0xAE</span>, <span class="hljs-number">0x5D</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x5A</span>, <br>  <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0xD3</span>, <span class="hljs-number">0x4F</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x16</span>, <br>  <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x9F</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x6D</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x6B</span>, <br>  <span class="hljs-number">0xC8</span>, <span class="hljs-number">0x67</span><br>&#125;<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>æ•´ä¸ªä¼ªä»£ç å¾ˆå¤æ‚ï¼Œä½†æ˜¯æœ€ç»ˆæˆ‘ä»¬åˆ†æå‡ºæ¥çš„åŠ å¯†è¿‡ç¨‹å´è¿™ä¹ˆç®€å•ã€‚è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> esi_eax[] =<br>&#123;<br>  <span class="hljs-number">0x86</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x3E</span>, <span class="hljs-number">0xCA</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0xD7</span>, <span class="hljs-number">0xAE</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0xE2</span>, <span class="hljs-number">0x77</span>,<br>  <span class="hljs-number">0x6B</span>, <span class="hljs-number">0xA6</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0xA1</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xB0</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x05</span>,<br>  <span class="hljs-number">0x7A</span>, <span class="hljs-number">0xF9</span>, <span class="hljs-number">0x7B</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x5A</span>, <span class="hljs-number">0x4B</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x7D</span>,<br>  <span class="hljs-number">0xD4</span>, <span class="hljs-number">0x28</span><br>&#125;;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> eax[] =<br>&#123;<br>  <span class="hljs-number">0xB3</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0xF8</span>, <span class="hljs-number">0xBC</span>, <span class="hljs-number">0xBC</span>, <span class="hljs-number">0xAE</span>, <span class="hljs-number">0x5D</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x5A</span>,<br>  <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0xD3</span>, <span class="hljs-number">0x4F</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x16</span>,<br>  <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x9F</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x1A</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x6D</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0xBA</span>, <span class="hljs-number">0x6B</span>,<br>  <span class="hljs-number">0xC8</span>, <span class="hljs-number">0x67</span><br>&#125;;<br><br><span class="hljs-type">char</span> v33[] = <span class="hljs-string">&quot;SWPU_2019_CTF&quot;</span>;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) &#123;<br><span class="hljs-type">char</span> c = (eax[i] ^ esi_eax[i]) ^ v33[i % <span class="hljs-number">13</span>];<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c&quot;</span>, c);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h2><p>ä½¿ç”¨ Ponce æ’ä»¶ï¼Œå‚è€ƒ<a href="https://bbs.kanxue.com/thread-271393.htm">IDAæ’ä»¶Ponceçš„ä½¿ç”¨-è½¯ä»¶é€†å‘-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a>ã€‚</p><p>ä½¿ç”¨è¯¥æ’ä»¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å¾…æ±‚è§£å­—ç¬¦ä¸²çš„åœ°å€å’Œé•¿åº¦ï¼Œä»¥åŠè·ç¦»æ­£ç¡®è·¯å¾„æœ€è¿‘çš„ä¸€ä¸ªæ¡ä»¶è·³è½¬ã€‚ä¸‹é¢è¯¦ç»†è¯´æ˜ä¸€ä¸‹æ€ä¹ˆä½¿ç”¨ã€‚</p><p>é¦–å…ˆæœç´¢è¾“å…¥å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°åï¼Œé€‰ä¸­32byteså¤§å°ï¼ˆä¸è¦åˆå¹¶æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰ï¼Œå³é”® -&gt; Symbolic -&gt; Symbolize memoryã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042201728.png"></p><p>ç„¶åæ‰¾åˆ°è·ç¦»æ­£ç¡®è·¯å¾„æœ€è¿‘çš„ä¸€ä¸ªæ¡ä»¶è·³è½¬ï¼Œç»è¿‡æˆ‘ä»¬å‰é¢çš„åˆ†æï¼Œå¯ä»¥ç¡®å®šçš„æ˜¯ä¼ªä»£ç ä¸­ç¬¬94è¡Œï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042201053.png"></p><p><strong>æŒ‰<code>F9</code>æ‰§è¡Œåˆ°è¯¥å¤„åï¼Œå³é”®è¯¥å¤„åˆ†æ”¯æ–­ç‚¹ -&gt; SMT Solver -&gt; Negate &amp; Injectï¼Œç„¶åå°±å¯ä»¥å¾—åˆ°éƒ¨åˆ†æ­£ç¡®å­—ç¬¦ã€‚</strong></p><p>é‡å¤ç²—ä½“å­—çš„æ“ä½œï¼ˆF9ï¼Œå³é”®â€¦ï¼‰ç›´è‡³å…¨éƒ¨è§£å‡ºã€‚æœ€ååœ¨å¾…æ±‚è§£å­—ç¬¦ä¸²æ‰€åœ¨çš„å†…å­˜ä¸­è¯»å–å³å¯ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2019çº¢å¸½æ¯-childRE</title>
    <link href="/2023/09/04/2019%E7%BA%A2%E5%B8%BD%E6%9D%AFchidRE/"/>
    <url>/2023/09/04/2019%E7%BA%A2%E5%B8%BD%E6%9D%AFchidRE/</url>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042156371.png"></p><p>éƒ¨åˆ†åˆ†æå¦‚å›¾æ‰€ç¤ºã€‚ç¬¬29è¡Œçš„<code>sub_xxxx</code>æ˜¯ä¸ªå¤æ‚çš„å‡½æ•°ï¼Œå°è¯•åˆ†æè¿‡ã€‚ç¬¬33~34è¡Œçš„è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯äºŒå‰æ ‘çš„ååºéå†</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202309042157471.png"></p><p>ä¸”éå†çš„ç»“æœå­˜å‚¨åˆ°<code>name</code>ä¸­ã€‚</p><p>ä¹‹åæ¯”è¾ƒå…³é”®çš„å‡½æ•°æ˜¯<code>UnDecorateSymbolName</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨å®˜æ–¹æ–‡æ¡£ä¸Šæœ‰ä»‹ç»ï¼Œä½†ä¸æ˜¯å¾ˆè¯¦ç»†ï¼Œäºæ˜¯é—®äº†é—®chatgptï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++">å¥½çš„ï¼Œè®©æˆ‘ä»¬ä»¥ C++ è¯­è¨€ä¸ºä¾‹æ¥è¯´æ˜ `unDecorateSymbolName` å‡½æ•°çš„ä½¿ç”¨ã€‚<br>åœ¨ C++ ä¸­ï¼Œå‡½æ•°åç§°ç»è¿‡è£…é¥°åä¼šåŒ…å«å‚æ•°ç±»å‹ã€è¿”å›ç±»å‹ç­‰ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œ`<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>` å‡½æ•°åœ¨è£…é¥°åå¯èƒ½ä¼šå˜æˆ `_Z3fooi`ã€‚è€Œ `unDecorateSymbolName` å‡½æ•°å¯ä»¥å°†è¿™æ ·çš„è£…é¥°åçš„ç¬¦å·åç§°è¿˜åŸæˆå¯è¯»çš„å½¢å¼ã€‚</span><br><span class="hljs-function">ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</span><br><span class="hljs-function">```cpp</span><br><span class="hljs-function"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></span><br><span class="hljs-function"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span></span><br><span class="hljs-function"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dbghelp.h&gt;</span></span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* decorated = <span class="hljs-string">&quot;_Z3fooi&quot;</span>;  <span class="hljs-comment">// è£…é¥°åçš„ç¬¦å·åç§°</span><br><br>    DWORD length = <span class="hljs-number">256</span>;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">256</span>];<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">UnDecorateSymbolName</span>(decorated, buffer, length, UNDNAME_COMPLETE)) &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Original symbol name: &quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Failed to undecorate symbol name.&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>```<br>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Windows å¹³å°ä¸‹çš„ `UnDecorateSymbolName` å‡½æ•°ï¼Œå¹¶ä¼ å…¥è£…é¥°åçš„ç¬¦å·åç§° `_Z3fooi`ã€‚é€šè¿‡è°ƒç”¨è¯¥å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿˜åŸåçš„ç¬¦å·åç§° `<span class="hljs-function"><span class="hljs-type">void</span> __cdecl <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>`ã€‚æœ€ç»ˆè¾“å‡ºç»“æœä¸ºï¼š</span><br><span class="hljs-function">```</span><br><span class="hljs-function">Original symbol name: void __cdecl foo(int)</span><br><span class="hljs-function">```</span><br><span class="hljs-function">è¿™ä¸ªä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `unDecorateSymbolName` å‡½æ•°å°†è£…é¥°åçš„ç¬¦å·åç§°è¿˜åŸæˆå¯è¯»å½¢å¼ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£å‡½æ•°çš„å®šä¹‰ã€‚è¯·æ³¨æ„ï¼Œå®é™…çš„å‡½æ•°è°ƒç”¨å¯èƒ½ä¼šå› ç¼–ç¨‹è¯­è¨€å’Œå¼€å‘ç¯å¢ƒè€Œæœ‰æ‰€ä¸åŒï¼Œéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œç›¸åº”çš„è°ƒæ•´ã€‚</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®è¿™ä¸ªä¾‹å­ï¼Œå¯ä»¥çŸ¥é“<code>unDecorateSymbolName</code> å‡½æ•°çš„åŠŸèƒ½æ˜¯å°†è£…é¥°åçš„ç¬¦å·åç§°è¿˜åŸæˆå¯è¯»å½¢å¼ï¼Œè¿™é‡Œçš„<code>outputString</code>å°±æ˜¯å¯è¯»å½¢å¼çš„å‡½æ•°åå®šä¹‰ï¼Œæˆ‘ä»¬è¦æ±‚çš„<code>name</code>å°±æ˜¯è¯¥å‡½æ•°å®šä¹‰ä¿®é¥°åçš„ç»“æœã€‚</p><p>é‚£é—®é¢˜æ¥äº†ï¼Œå‡½æ•°ä¿®é¥°çš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>å‡½æ•°ç¬¦å·ï¼ˆå‡½æ•°çš„åå­—ä¿®é¥°ï¼‰:åœ¨ç¼–è¯‘é˜¶æ®µç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼Œæ¥æŒ‡æ˜å‡½æ•°çš„å®šä¹‰æˆ–åŸå‹ã€‚</p><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/Scl_Diligent/article/details/83990429">C&#x2F;C++å‡½æ•°ç¬¦å·ç”Ÿæˆè§„åˆ™ï¼ˆå‡½æ•°åçš„ä¿®é¥°ï¼‰ï¼›C++ å‡½æ•°é‡è½½_Scl_Diligentçš„åšå®¢-CSDNåšå®¢</a></p><p>æ ¹æ®ä¸Šè¿°è§„åˆ™å¯æ¢å¤<code>name</code>ã€‚</p><p>å›åˆ°ä»£ç ä¸­ï¼Œæ¥ä¸‹æ¥æ¯”è¾ƒå…³é”®çš„æ˜¯50ã€52è¡Œï¼Œ<code>v13</code>åé¢åŠ çš„æ•°æ®å…¶å®å°±æ˜¯æŸäº›å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€ï¼Œæ‰€ä»¥æ ¹æ®è¿™ä¸¤è¡Œä»£ç å¯ä»¥æ¢å¤<code>outputString</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># / 23</span><br>str1 = <span class="hljs-string">&#x27;55565653255552225565565555243466334653663544426565555525555222&#x27;</span><br><span class="hljs-comment"># % 23</span><br>str2 = <span class="hljs-string">&#x27;(_@4620!08!6_0*0442!@186%%0@3=66!!974*3234=&amp;0^3&amp;1@=&amp;0908!6_0*&amp;&#x27;</span><br>str3 = <span class="hljs-string">&#x27;1234567890-=!@#$%^&amp;*()_+qwertyuiop[]QWERTYUIOP&#123;&#125;asdfghjkl;\x27ASDFGHJKL:&quot;ZXCVBNM&lt;&gt;?zxcvbnm,./&#x27;</span><br>outputstring = <span class="hljs-string">&#x27;&#x27;</span><br>slen = <span class="hljs-number">62</span><br><span class="hljs-keyword">for</span> v13 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(slen):<br>    <span class="hljs-comment">#outputString[v13] / 23     outputString[v13] % 23</span><br>    data = str3.index(str1[v13])*<span class="hljs-number">23</span> + str3.index(str2[v13])<br>    outputstring += <span class="hljs-built_in">chr</span>(data)<br><span class="hljs-built_in">print</span>(outputstring)<br></code></pre></td></tr></table></figure><p>æ±‚å‡º<code>outputString</code>ä¹‹åï¼Œæ ¹æ®å‡½æ•°åä¿®é¥°è§„åˆ™æ‰‹åŠ¨æ¢å¤å‡º<code>name</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">?<span class="hljs-symbol">My_Aut0_PWN@</span><span class="hljs-symbol">R0Pxx@</span><span class="hljs-meta">@AAEPADPAE</span><span class="hljs-meta">@Z</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯é€†äºŒå‰æ ‘ååºéå†äº†ã€‚å› ä¸ºä¸çŸ¥é“äºŒå‰æ ‘ç»“æ„è€Œä¸”åªçŸ¥é“ä¸€ç§éå†ç»“æœï¼Œæ˜¯æ— æ³•æ¢å¤çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å°è¯•IDAåŠ¨è°ƒï¼Œéšä¾¿è¾“å…¥ç¬¦åˆæ¡ä»¶çš„å­—ç¬¦ä¸²ï¼Œæ„é€ å‡ºä¸€ä¸ªå¯¹ç…§è¡¨ï¼Œç„¶åæ›¿æ¢å†…å®¹å¾—åˆ°æºå­—ç¬¦ä¸²ï¼ˆå‡è®¾ä¸ºSrcï¼‰ã€‚åœ¨IDAåŠ¨è°ƒè¿‡ç¨‹ä¸­ï¼Œæ˜¯å¯ä»¥å‘ç°ç¬¬29è¡Œçš„<code>sub_xxx</code>å‡½æ•°å¯¹æˆ‘ä»¬çš„è¾“å…¥æ˜¯æ²¡æœ‰å½±å“çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ±‚å‡ºçš„æºå­—ç¬¦ä¸²Srcå°±æ˜¯è¾“å…¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">name = <span class="hljs-string">&#x27;?My_Aut0_PWN@R0Pxx@@AAEPADPAE@Z&#x27;</span><br><br>table1 = <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyzABCDE&#x27;</span> <span class="hljs-comment">#éšæœºçš„è¾“å…¥</span><br>table2 = <span class="hljs-string">&#x27;pqhrsidtujvwkebxylzAmfBCnDEogca&#x27;</span> <span class="hljs-comment">#å¯¹åº”çš„ååºéå†ç»“æœ</span><br><br>plain = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(name)):<br>    pos = table2.index(table1[i])<br>    plain += name[pos]<br><span class="hljs-built_in">print</span>(md5(plain.encode()).hexdigest())<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AOSPæºç ç¼–è¯‘</title>
    <link href="/2023/08/28/AOSP%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/"/>
    <url>/2023/08/28/AOSP%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸‹è½½AOSPæºç "><a href="#ä¸‹è½½AOSPæºç " class="headerlink" title="ä¸‹è½½AOSPæºç "></a>ä¸‹è½½AOSPæºç </h1><p>æ ¹æ®ä¸­ç§‘å¤§çš„æ¥ï¼š<a href="https://mirrors.ustc.edu.cn/help/aosp.html">AOSP é•œåƒä½¿ç”¨å¸®åŠ© â€” USTC Mirror Help æ–‡æ¡£</a></p><p>è¿™é‡Œæˆ‘ç”¨çš„æ˜¯ç¬¬äºŒç§æ–¹æ³•ï¼Œè™½ç„¶ä¸æ¨èï¼Œä½†æ˜¯å¿…é¡»å¾—å°è¯•ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆæ˜¯ä¸‹è½½ repo å·¥å…·ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">mkdir ~/bin<br>PATH=~/bin:<span class="hljs-variable">$PATH</span><br>curl https:<span class="hljs-regexp">//</span>storage.googleapis.com<span class="hljs-regexp">/git-repo-downloads/</span>repo &gt; ~<span class="hljs-regexp">/bin/</span>repo<br>chmod a+x ~<span class="hljs-regexp">/bin/</span>repo<br></code></pre></td></tr></table></figure><p>å¦‚æœ repo å·²ç»ä¸‹è½½å¥½äº†ï¼Œä½†æ˜¯ä½¿ç”¨ä¸äº† repo æŒ‡ä»¤ï¼Œéœ€è¦é‡æ–°åŠ è½½ç¯å¢ƒï¼Œæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">PATH=~/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-regexp">//</span>chmod a+x ~<span class="hljs-regexp">/bin/</span>repo(åº”è¯¥ä¸éœ€è¦)<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨æ¡Œé¢å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆåç§°ä»»æ„ï¼‰ï¼Œå¹¶è¿›å…¥åˆ°è¯¥ç›®å½•ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> AOSP_COMPILE<br><span class="hljs-built_in">cd</span> AOSP_COMPILE<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥ç›®å½•ä¸‹åˆå§‹åŒ–ä»“åº“ï¼ˆå¯ä»¥ä½¿ç”¨ -b æ¥æŒ‡å®šAndroidç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œç›´æ¥æŒ‡å®šäº†Android10ç‰ˆæœ¬çš„ï¼‰ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>æŒ‡å®šAndroid10ç‰ˆæœ¬<br>repo init -u git:<span class="hljs-regexp">//mi</span>rrors.ustc.edu.cn<span class="hljs-regexp">/aosp/</span>platform/manifest -b android-<span class="hljs-number">4.0</span>.<span class="hljs-number">1</span>_r1<br></code></pre></td></tr></table></figure><p>æœ€ååŒæ­¥æºç æ ‘ï¼ˆä»¥ååªéœ€æ‰§è¡Œè¿™æ¡å‘½ä»¤æ¥åŒæ­¥ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">repo <span class="hljs-built_in">sync</span><br></code></pre></td></tr></table></figure><p>å¦‚æœåœ¨åŒæ­¥ä¸­å¤±å»è¿æ¥ï¼Œé‡æ–°æ‰§è¡Œè¯¥å‘½ä»¤å³å¯ï¼Œå®ƒä¼šåœ¨ä¹‹å‰ä¸‹è½½æ–­å¼€çš„ä½ç½®å¼€å§‹ç»§ç»­ä¸‹è½½ã€‚</p><h1 id="ç¼–è¯‘AOSP"><a href="#ç¼–è¯‘AOSP" class="headerlink" title="ç¼–è¯‘AOSP"></a>ç¼–è¯‘AOSP</h1><h2 id="ç¼–è¯‘å‰çš„ç¯å¢ƒé…ç½®"><a href="#ç¼–è¯‘å‰çš„ç¯å¢ƒé…ç½®" class="headerlink" title="ç¼–è¯‘å‰çš„ç¯å¢ƒé…ç½®"></a>ç¼–è¯‘å‰çš„ç¯å¢ƒé…ç½®</h2><p>åœ¨å¼€å§‹ç¼–è¯‘AOSPä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®å¥½ç¼–è¯‘ç¯å¢ƒã€‚</p><h3 id="ä¸‹è½½å·¥å…·"><a href="#ä¸‹è½½å·¥å…·" class="headerlink" title="ä¸‹è½½å·¥å…·"></a>ä¸‹è½½å·¥å…·</h3><ol><li><p><strong>ä¸‹è½½ libncurses5</strong></p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-comment">//32-bit æœºå™¨</span><br>sudo apt-<span class="hljs-keyword">get</span> install libncurses5:i386<br><span class="hljs-comment">//64-bit æœºå™¨</span><br>sudo apt-<span class="hljs-keyword">get</span> install libncurses5<br></code></pre></td></tr></table></figure><p>å¦åˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">prebuilts<span class="hljs-regexp">/clang/</span>host<span class="hljs-regexp">/linux-x86/</span>clang-<span class="hljs-number">3289846</span><span class="hljs-regexp">/bin/</span>clang.real: <br>error <span class="hljs-keyword">while</span> loading shared libraries: libncurses.so.<span class="hljs-number">5</span>: <br>cannot open shared object file: No <span class="hljs-number">15</span>:<span class="hljs-number">44</span>:<span class="hljs-number">33</span> ninja failed with: <span class="hljs-keyword">exit</span> status <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>ï¼ˆå‚è€ƒ<a href="https://juejin.cn/post/7204115174412894267">Android æºç  (AOSP) ä¸‹è½½ä¸ç¼–è¯‘ - æ˜é‡‘ (juejin.cn)</a>ï¼‰</p></li><li><p><strong>å®‰è£… openjdk-8</strong></p><p>ç³»ç»Ÿå†…ç½®çš„ openjdk-11 å¤ªæ–°äº†ï¼Œä¼šæŠ¥é”™ï¼Œè£…ä¸ªå®˜ç½‘è¦æ±‚çš„ openjdk-8 ã€‚</p><p><a href="https://mirrors.huaweicloud.com/java/jdk/">åä¸ºé•œåƒæº</a>ä¸­ä¸‹è½½jdkï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯ jdk-8u191-linux-x64.tar.gzã€‚éœ€è¦æ ¹æ®è‡ªå·±çš„è™šæ‹Ÿæœºæ¶æ„é€‰æ‹©ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹è™šæ‹Ÿæœºæ¶æ„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -m<br></code></pre></td></tr></table></figure><p>ç„¶åå°†å…¶è§£å‹ç¼©åˆ° &#x2F;usr&#x2F;lib&#x2F;jvm ç›®å½•ä¸‹ï¼ˆå¦‚æœæ²¡æœ‰è¯¥ç›®å½•å°±åˆ›å»ºä¸€ä¸‹ï¼‰ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>åˆ›å»ºç›®å½•ï¼Œå­˜åœ¨è¯¥ç›®å½•å¯å¿½ç•¥è¯¥å‘½ä»¤<br>sudo mkdir <span class="hljs-regexp">/usr/</span>lib/jvm<br><span class="hljs-regexp">//</span>è§£å‹<br>tar -zxvf jdk-<span class="hljs-number">8</span>u191-linux-x64.tar.gz -C <span class="hljs-regexp">/usr/</span>lib/jvm<br></code></pre></td></tr></table></figure><p>ä¹‹åè¦ç»™jdké…ç½®ç¯å¢ƒï¼Œå°†ä»¥ä¸‹å‘½ä»¤æ·»åŠ åˆ° ~&#x2F;.zshrcä¸­ï¼ˆæ™®é€šç”¨æˆ·ç›®å½•ä¸‹å’Œrootç”¨æˆ·ç›®å½•ä¸‹å°½é‡éƒ½æ·»åŠ ï¼‰ ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">export</span> JAVA_HOME=<span class="hljs-string">&quot;/usr/lib/jvm/jdk1.8.0_191&quot;</span>  <span class="hljs-comment">//ä½ è‡ªå·±ä¸‹è½½çš„jdkæ‰€åœ¨è·¯å¾„</span><br><span class="hljs-keyword">export</span> JRE_HOME=<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;JAVA_HOME&#125;</span>/jre&quot;</span>  <br><span class="hljs-keyword">export</span> CLASSPATH=<span class="hljs-string">&quot;.:<span class="hljs-subst">$&#123;JAVA_HOME&#125;</span>/lib:<span class="hljs-subst">$&#123;JRE_HOME&#125;</span>/lib&quot;</span> <br><span class="hljs-keyword">export</span> PATH=<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;JAVA_HOME&#125;</span>/bin:<span class="hljs-subst">$PATH</span>&quot;</span><br></code></pre></td></tr></table></figure><p>æœ€åä½¿ç¯å¢ƒç”Ÿæ•ˆï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> ~/.zshrc<br><span class="hljs-built_in">exec</span> <span class="hljs-variable">$SHELL</span><br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œå¦‚æœä½ å®‰è£…äº†å¤šä¸ªç‰ˆæœ¬çš„jdkï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ‡æ¢ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">sudo <span class="hljs-keyword">update</span><span class="hljs-operator">-</span>alternatives <span class="hljs-comment">--config java</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308282041983.jpg"></p><p>æœ€å‰é¢å¸¦æ˜Ÿå·çš„å°±æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨çš„javaç‰ˆæœ¬ï¼Œé€šè¿‡é”®å…¥ç¼–å·é€‰æ‹©ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬ã€‚</p><p>ï¼ˆå‚è€ƒ<a href="https://blog.csdn.net/zbj18314469395/article/details/86064849">Linuxä¹‹Ubuntu18.04å®‰è£…Java JDK8çš„ä¸‰ç§æ–¹å¼_ubuntuå®‰è£…jdk8_è½¯æµ‹å°ç”Ÿçš„åšå®¢-CSDNåšå®¢</a>ä¸­çš„ç¬¬ä¸‰ç§æ–¹æ³•ï¼‰</p></li><li><p><strong>ä¸‹è½½ m4</strong></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> m4<br></code></pre></td></tr></table></figure><p>å¦åˆ™åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œå³æ‰¾ä¸åˆ° m4 æŒ‡ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308282040409.jpg"></p></li></ol><h3 id="å¢å¤§äº¤æ¢ç©ºé—´"><a href="#å¢å¤§äº¤æ¢ç©ºé—´" class="headerlink" title="å¢å¤§äº¤æ¢ç©ºé—´"></a>å¢å¤§äº¤æ¢ç©ºé—´</h3><p>æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>åˆ›å»ºä¸€ä¸ªåä¸º swapfile çš„æ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶å¤§å°è®¾ç½®ä¸º <span class="hljs-number">10</span>GB<br>dd <span class="hljs-keyword">if</span>=<span class="hljs-regexp">/dev/</span>zero of=swapfile bs=<span class="hljs-number">1</span>M count=<span class="hljs-number">10240</span><br><span class="hljs-regexp">//</span>å°† swapfile æ ¼å¼åŒ–ä¸ºäº¤æ¢åˆ†åŒºï¼Œç”¨äºåœ¨ç‰©ç†å†…å­˜ä¸è¶³æ—¶ä½œä¸ºè™šæ‹Ÿå†…å­˜çš„æ‰©å±•<br>mkswap swapfile<br><span class="hljs-regexp">//</span>å¯åŠ¨äº¤æ¢ç©ºé—´<br>sudo swapon swapfile<br></code></pre></td></tr></table></figure><h3 id="å¢å¤§å†…å­˜"><a href="#å¢å¤§å†…å­˜" class="headerlink" title="å¢å¤§å†…å­˜"></a>å¢å¤§å†…å­˜</h3><p>æˆ‘ç»™è™šæ‹Ÿæœºå¼€äº†16Gå†…å­˜ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡htopå·¥å…·æŸ¥çœ‹å‘ç°å†…å­˜ä½¿ç”¨æƒ…å†µå¯ä»¥è¾¾åˆ°14Gå·¦å³ï¼ˆæ²¡æˆªå›¾ï¼‰ã€‚å½“ç„¶å¹¶ä¸æ˜¯è¦ä½ ç»™è¿™ä¹ˆå¤šï¼Œè€Œæ˜¯åœ¨åˆé€‚çš„èŒƒå›´å†…å°½é‡ç»™è™šæ‹Ÿæœºå¤šä¸€ç‚¹å†…å­˜ã€‚</p><h3 id="å¢å¤§JVMè™šæ‹Ÿæœºçš„å †å†…å­˜"><a href="#å¢å¤§JVMè™šæ‹Ÿæœºçš„å †å†…å­˜" class="headerlink" title="å¢å¤§JVMè™šæ‹Ÿæœºçš„å †å†…å­˜"></a>å¢å¤§JVMè™šæ‹Ÿæœºçš„å †å†…å­˜</h3><p>æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤å¢å¤§JVMçš„å †å†…å­˜ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>å¢å¤§å †å†…å­˜ï¼Œè®¾ç½®åˆå§‹å †å†…å­˜å¤§å°ä¸º<span class="hljs-number">512</span>MBï¼Œæœ€å¤§å †å¤§å°ä¸º <span class="hljs-number">4</span>GB<br>export JAVA_TOOL_OPTIONS=<span class="hljs-string">&quot;-Xms512m -Xmx4g&quot;</span><br><span class="hljs-regexp">//</span>æŸ¥çœ‹JVMçš„é…ç½®å‚æ•°<br>java -XX:+PrintFlagsFinal -version | grep -iE <span class="hljs-string">&#x27;HeapSize|PermSize|ThreadStackSize&#x27;</span><br></code></pre></td></tr></table></figure><p>å¦åˆ™å¯èƒ½ä¼šè·Ÿæˆ‘ä¸€æ ·ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å‡ºç°å¦‚ä¸‹æƒ…å†µï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308282040100.jpg"></p><p>ä¸è¿‡æ²¡å…³ç³»ï¼Œè¿™å¹¶ä¸ä¼šå¯¼è‡´ä½ éœ€è¦é‡å¤´å¼€å§‹ç¼–è¯‘ï¼Œè§£å†³ç©è¿™ä¸ªé—®é¢˜ä¹‹åï¼Œé‡æ–°æ‰§è¡Œ make -jx å³å¯ï¼ˆxä¸ºçº¿ç¨‹æ•°ï¼Œä¸è™šæ‹Ÿæœºçš„cpuæ ¸æ•°ä¸€è‡´å°±å¯ä»¥äº†ï¼Œå¤šäº†ä¹Ÿæ²¡å¤šä½™çš„æ ¸æ¥å¤„ç†ï¼‰ã€‚</p><h2 id="å¼€å§‹ç¼–è¯‘AOSP"><a href="#å¼€å§‹ç¼–è¯‘AOSP" class="headerlink" title="å¼€å§‹ç¼–è¯‘AOSP"></a>å¼€å§‹ç¼–è¯‘AOSP</h2><p>æ‰“å¼€ç»ˆç«¯æ§åˆ¶å°ï¼Œè¿›å…¥åˆ°æºç ç›®å½•ä¸­ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> build/envsetup.sh<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ç¼–è¯‘å‰æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç”¨äºåˆ é™¤æ„å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ‰€æœ‰ä¸­é—´æ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶ä»¥åŠç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ç­‰ï¼Œä»¥ä¾¿é‡æ–°å¼€å§‹ç¼–è¯‘ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">make clobber<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¹‹åï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç„¶åé€‰æ‹©ä½ æ‰€éœ€è¦ç¼–è¯‘çš„ç‰ˆæœ¬ï¼ˆç‰ˆæœ¬å¯è¯¦ç»†å‚è€ƒ<a href="https://source.android.google.cn/docs/setup/build/running?hl=zh-cn#selecting-device-build">åˆ·å†™è®¾å¤‡  | Android å¼€æºé¡¹ç›®  | Android Open Source Project (google.cn)</a>ï¼‰ï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">lunch</span><br></code></pre></td></tr></table></figure><p>æœ€åå¼€å§‹ç¼–è¯‘ï¼š</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-built_in">make</span> -j4<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œåœ¨100%çš„æ—¶å€™ï¼Œä»–ä¼šæ‰§è¡Œ &#x2F;device&#x2F;generic&#x2F;goldfish&#x2F;tools&#x2F;ç›®å½•ä¸‹çš„ mk_combined_img.py æ–‡ä»¶ï¼Œç„¶åä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308282040940.jpg"></p><p>æ˜¾ç„¶æ˜¯ç”±äºä½¿ç”¨python3ç¼–è¯‘python2å¯¼è‡´çš„ï¼Œæ‰€ä»¥ä¹Ÿå¾ˆå®¹æ˜“è§£å†³ã€‚é¦–å…ˆç¡®å®šä½ ä¸‹è½½äº†python2ï¼Œå…¶æ¬¡ä¿®æ”¹ mk_combined_img.py æ–‡ä»¶ä¸­çš„é¦–è¡Œï¼Œå°†<code>#!/usr/bin/python</code> æ”¹æˆ <code>#!/usr/bin/python2</code>ã€‚</p><p>ï¼ˆå‚è€ƒ<a href="https://cloud.tencent.com/developer/ask/sof/1023220">&#x2F;device&#x2F;generic&#x2F;goldfish&#x2F;tools&#x2F;mk_combined_img.pyâ€ï¼Œç¬¬48è¡Œæ‰“å°â€â€˜%sâ€˜æ— æ³•è½¬æ¢ä¸ºæ•´æ•°â€œ% lin[2]-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a>ï¼‰</p><p>å¦‚æœå¹¸è¿çš„è¯ï¼Œåº”è¯¥å°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ç¼–è¯‘æˆåŠŸäº†ï¼</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308282040907.jpg"></p><p>å¯åœ¨ &#x2F;out&#x2F;target&#x2F;product&#x2F;generic_x86_64 ç›®å½•ä¸‹æŸ¥çœ‹åˆ°ç¼–è¯‘å‡ºçš„ img æ–‡ä»¶ï¼ˆgeneric_x86_64 æ˜¯æˆ‘é€‰æ‹©çš„ç¼–è¯‘ç‰ˆæœ¬ï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308282039742.jpg"></p><hr><p>å‚è€ƒï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/68918808">æ­»ç£•Android_AOSPç¼–è¯‘è¿‡ç¨‹ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://www.anquanke.com/post/id/199898#h3-6">2020å¹´å®‰å“æºç ç¼–è¯‘æŒ‡å—åŠFARTè„±å£³æœºè°·æ­Œå…¨è®¾å¤‡é•œåƒå‘å¸ƒ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://juejin.cn/post/7204115174412894267">Android æºç  (AOSP) ä¸‹è½½ä¸ç¼–è¯‘ - æ˜é‡‘ (juejin.cn)</a></p><p><a href="https://mirrors.ustc.edu.cn/help/aosp.html">AOSP é•œåƒä½¿ç”¨å¸®åŠ© â€” USTC Mirror Help æ–‡æ¡£</a></p><p><a href="https://blog.csdn.net/zbj18314469395/article/details/86064849">Linuxä¹‹Ubuntu18.04å®‰è£…Java JDK8çš„ä¸‰ç§æ–¹å¼_ubuntuå®‰è£…jdk8_è½¯æµ‹å°ç”Ÿçš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AOSP</tag>
      
      <tag>ç¯å¢ƒé…ç½®</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fridaå¼€å‘ç¯å¢ƒæ­å»º</title>
    <link href="/2023/08/24/Frida%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <url>/2023/08/24/Frida%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="pyenvç¯å¢ƒé…ç½®"><a href="#pyenvç¯å¢ƒé…ç½®" class="headerlink" title="pyenvç¯å¢ƒé…ç½®"></a>pyenvç¯å¢ƒé…ç½®</h1><p>ç§‘å­¦ä¸Šç½‘ï¼š<a href="https://github.com/pyenv/pyenv">pyenv&#x2F;pyenv: Simple Python version management (github.com)</a></p><p>ç›´è¿ï¼š<a href="https://gitee.com/jordanxu/pyenv-installer">pyenv-installer: pyenv(giteeçš„åœ°å€)</a></p><p>é¦–å…ˆä¸‹è½½ä¾èµ–åŒ…ï¼ˆå‚è€ƒï¼š<a href="https://github.com/pyenv/pyenv/wiki/Common-build-problems">Common build problems Â· pyenv&#x2F;pyenv Wiki (github.com)</a>ï¼‰ï¼š</p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs q">sudo apt install libedit-<span class="hljs-built_in">dev</span><br>æˆ–è€…<br>apt-<span class="hljs-built_in">get</span> install -y make build-essential libssl-<span class="hljs-built_in">dev</span> zlib1g-<span class="hljs-built_in">dev</span> libbz2-<span class="hljs-built_in">dev</span> libreadline-<span class="hljs-built_in">dev</span> libsqlite3-<span class="hljs-built_in">dev</span> wget curl llvm libncurses5-<span class="hljs-built_in">dev</span> libncursesw5-<span class="hljs-built_in">dev</span> xz-utils tk-<span class="hljs-built_in">dev</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¹‹å‰ï¼Œå¯èƒ½éœ€è¦æ›´æ–°<code>apt-get</code>ã€‚</p><p>ä¹‹åä¸‹è½½<code>pyenv</code>ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">curl -L https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/yyuu/</span>pyenv-installer<span class="hljs-regexp">/master/</span>bin/pyenv-installer | bash <br></code></pre></td></tr></table></figure><p>å› ä¸º<code>raw.githubusercontent.com</code>åŸŸåè¢«æ±¡æŸ“çš„åŸå› ï¼Œéœ€è¦æˆ‘ä»¬ä¿®æ”¹<code>/etc</code>ä¸‹çš„<code>hosts</code>æ–‡ä»¶ï¼ŒæŒ‡å®šåŸŸåè·Ÿipçš„æ˜ å°„ï¼ˆipé€šè¿‡<a href="https://www.ipaddress.com/">ipaddress.com</a>æŸ¥è¯¢ï¼‰ï¼š</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">185.199.108.133</span> raw.githubusercontent.com//å¤šåŠ å‡ æ¡ä¹Ÿæ²¡å…³ç³»<br></code></pre></td></tr></table></figure><p>ä¸ºäº†åŠ å¿«è®¿é—®å¤–ç½‘çš„é€Ÿåº¦ï¼Œéœ€è¦ä¿®æ”¹<code>/etc</code>ä¸‹çš„<code>proxychains.conf</code>æ–‡ä»¶ï¼ˆæˆ‘è¿™é‡Œæ˜¯<code>proxychains4.conf</code>ï¼‰ï¼Œç¦æ‰ç¬¬ä¸€è¡Œï¼Œæ·»åŠ ç¬¬äºŒè¡Œï¼ˆipä¸ºå®¿ä¸»æœºipï¼Œç«¯å£æ˜¯å®¿ä¸»æœºå¼€å¯çš„ä»£ç†ç«¯å£ï¼‰</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#socks4 127.0.0.1 9050</span><br><span class="hljs-attribute">socks5</span>  ip port<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±å°†æµé‡ä»£ç†åˆ°å®¿ä¸»æœºä¸Šï¼Œä»è€Œå®ç°è™šæ‹Ÿæœºä¾é å®¿ä¸»æœºçš„ç¿»å¢™è½¯ä»¶è¾¾åˆ°ç¿»å¢™ç›®çš„ã€‚</p><p>å®‰è£…ç»“æŸåï¼Œæç¤ºæˆ‘ä»¬ç¼ºå°‘<code>pyenv</code>çš„åŠ è½½è·¯å¾„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308241940810.jpg"></p><blockquote><p> å³æˆ‘ä»¬éœ€è¦å°†ä»¥ä¸‹å‘½ä»¤æ·»åŠ åˆ°<code>/root</code>ä¸‹çš„<code>.bash_profile</code>æ–‡ä»¶ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¯¥æ–‡ä»¶ï¼Œåˆ™æ·»åŠ åˆ°<code>.profile</code>æ–‡ä»¶å’Œ<code>.bashrc</code>æ–‡ä»¶ä¸­ã€‚</p> <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">export</span> <span class="hljs-attribute">PYENV_ROOT</span>=<span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/.pyenv&quot;</span><br>command -v pyenv &gt;/dev/<span class="hljs-literal">null</span> || <span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-string">&quot;<span class="hljs-variable">$PYENV_ROOT</span>/bin:<span class="hljs-variable">$PATH</span>&quot;</span><br>eval <span class="hljs-string">&quot;<span class="hljs-variable">$(pyenv init -)</span>&quot;</span><br></code></pre></td></tr></table></figure><p> åŒæ—¶è¿˜éœ€è¦å°†ä¸‹é¢çš„å‘½ä»¤æ·»åŠ åˆ°<code>.bashrc</code>æ–‡ä»¶ä¸­ã€‚</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">eval</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(pyenv virtualenv-init -)</span>&quot;</span><br></code></pre></td></tr></table></figure><p> ä¹‹åé‡æ–°å¯åŠ¨shellçª—å£ï¼Œè¯´æ˜¯æ‰§è¡Œ</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure><p> å¦‚æœä½ è¿™æ ·åšäº†ï¼Œå°±ä¼šé‡åˆ°å¾ˆå¤šéº»çƒ¦ï¼Œæ¯”å¦‚æ‰§è¡Œ<code>source ~/.bashrc</code>æ—¶<code>æ‰¾ä¸åˆ°å‘½ä»¤ â€œshoptâ€</code>ï¼Œè¿™ä¸ªå¥½è¯´ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤è§£å†³ï¼š</p> <figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">exec</span> bash<span class="hljs-comment">//å°†å‘½ä»¤è¡Œä»zshåˆ‡æ¢ä¸ºbash</span><br><span class="hljs-keyword">source</span> ~/.bashrc<br><span class="hljs-keyword">exec</span> zsh<span class="hljs-comment">//é‡æ–°è¿è¡Œzshå‘½ä»¤è¡Œå·¥å…·</span><br></code></pre></td></tr></table></figure><p> è€Œä¸”æ–°å¼€çš„shellçª—å£å¹¶ä¸èƒ½è¯†åˆ«<code>pyenv</code>æŒ‡ä»¤ï¼Œè€Œä¸”é™¤pyenvæ‰€åœ¨ç”¨æˆ·ä»¥å¤–çš„å…¶ä»–ç”¨æˆ·ä¸èƒ½ä½¿ç”¨pyenvæŒ‡ä»¤</p><p> ç®€è€Œè¨€ä¹‹ï¼Œä¸è¦æŒ‰ç…§æç¤ºæ¥æ“ä½œï¼ï¼ï¼</p></blockquote><p>æ­£ç¡®çš„æ“ä½œæ˜¯ï¼Œå°†ä»¥ä¸‹æŒ‡ä»¤å†™å…¥rootç›®å½•å’Œ<code>home/kali</code>ç›®å½•ä¸‹ï¼ˆkaliæ˜¯æˆ‘çš„è™šæ‹Ÿæœºçš„ç”¨æˆ·åï¼‰çš„<code>.zshrc</code>æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> PYENV_ROOT=<span class="hljs-string">&quot;/home/kali/.pyenv&quot;</span>//pyenvçš„å®‰è£…è·¯å¾„<br><span class="hljs-built_in">command</span> -v pyenv &gt;/dev/null || <span class="hljs-built_in">export</span> PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$PYENV_ROOT</span>/bin:<span class="hljs-variable">$PATH</span>&quot;</span><br><span class="hljs-built_in">eval</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(pyenv init -)</span>&quot;</span><br><span class="hljs-built_in">eval</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(pyenv virtualenv-init -)</span>&quot;</span><br></code></pre></td></tr></table></figure><p>åˆ†åˆ«å¯¹å„è‡ªç”¨æˆ·ç›®å½•ä¸‹çš„<code>.zshrc</code>æ–‡ä»¶æ‰§è¡Œ<code>source /.zshrc</code>å‘½ä»¤ã€‚æœ€åæ‰§è¡Œ<code>exec $SHELL</code>ã€‚è¿™æ ·éšä¾¿å¯åŠ¨shellçª—å£éƒ½å¯ä»¥è¯†åˆ«<code>pyenv</code>æŒ‡ä»¤ã€‚</p><p>ï¼ˆè™½ç„¶å†™çš„è¿™ä¹ˆç®€æ´ï¼Œä½†æ˜¯è´¹äº†å¥½é•¿æ—¶é—´æ‰è§£å†³çš„ï¼Œæƒ¨ç—›çš„æ•™è®­ï¼‰</p><p>ç„¶åæ˜¯<code>pyenv</code>çš„åŸºæœ¬ç”¨æ³•ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pyenv</span> install --list//æŸ¥è¯¢ç›®å‰æ‰€æœ‰çš„pythonç‰ˆæœ¬<br><span class="hljs-attribute">pyenv</span> install <span class="hljs-number">2</span>.<span class="hljs-number">7</span>.//æŸ¥è¯¢æ‰€æœ‰<span class="hljs-number">2</span>.<span class="hljs-number">7</span>.xç‰ˆæœ¬<br><span class="hljs-attribute">pyenv</span> install <span class="hljs-number">2</span>.<span class="hljs-number">7</span>.<span class="hljs-number">10</span>//å®‰è£…<span class="hljs-number">2</span>.<span class="hljs-number">7</span>.<span class="hljs-number">10</span>ç‰ˆæœ¬çš„python<br><span class="hljs-attribute">pyenv</span> uninstall <span class="hljs-number">2</span>.<span class="hljs-number">7</span>.<span class="hljs-number">10</span>//å¸è½½<span class="hljs-number">2</span>.<span class="hljs-number">7</span>.<span class="hljs-number">10</span>ç‰ˆæœ¬çš„python<br><span class="hljs-attribute">pyenv</span> versions//æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­åŒ…å«çš„Pythonç‰ˆæœ¬<br><span class="hljs-attribute">pyenv</span> local <span class="hljs-number">2</span>.<span class="hljs-number">7</span>.<span class="hljs-number">10</span>//åˆ‡æ¢ä¸ºpyenvä¸­çš„pythonç‰ˆæœ¬<br><span class="hljs-attribute">pyenv</span> local system //åˆ‡æ¢ä¸ºç³»ç»Ÿçš„python<br></code></pre></td></tr></table></figure><p>ä¸‹è½½æ—¶éœ€è¦æ›´æ”¹<code>/etc/proxychain4.conf</code>é…ç½®ï¼Œæ³¨é‡Šæ‰<code>proxy_dns</code>ã€‚</p><h1 id="fridaç¯å¢ƒé…ç½®"><a href="#fridaç¯å¢ƒé…ç½®" class="headerlink" title="fridaç¯å¢ƒé…ç½®"></a>fridaç¯å¢ƒé…ç½®</h1><p>é¦–å…ˆæ˜¯ç»™æˆ‘ä»¬çš„è™šæ‹Ÿæœºé…ç½®fridaç¯å¢ƒã€‚é€‰å®šå¥½pyenvä¸­çš„pythonç‰ˆæœ¬åï¼Œæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤æ¥å®‰è£…<code>frida</code>å’Œ<code>frida-tools</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">pip install frida<br>pip install frida-tools<br></code></pre></td></tr></table></figure><p>å»ºè®®ä½¿ç”¨<code>proxychain</code>ä»£ç†ã€‚</p><p>å®‰è£…å®Œæˆåï¼Œåœ¨ç»ˆç«¯ä¸­è¾“å…¥frida-pså‘½ä»¤æŸ¥çœ‹ï¼Œå¦‚æœèƒ½æ˜¾ç¤ºå½“å‰ç³»ç»Ÿè¿›ç¨‹åˆ™è¯æ˜å®‰è£…æˆåŠŸ</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308241940538.jpg"></p><p>ç„¶åæ˜¯ç»™æˆ‘ä»¬çš„æ‰‹æœºé…ç½®fridaç¯å¢ƒã€‚åœ¨<a href="https://github.com/frida/frida/releases">Releases Â· frida&#x2F;frida (github.com)</a>ä¸­ä¸‹è½½<code>frida-server</code>ã€‚éœ€è¦æ³¨æ„ç‰ˆæœ¬ï¼æ¯”å¦‚æˆ‘çš„è™šæ‹Ÿæœºä¸‹è½½çš„<code>frida</code>ç‰ˆæœ¬æ˜¯<code>16.1.3</code>ï¼ŒAndroidæ‰‹æœºæ˜¯arm64æ¶æ„ï¼Œåˆ™åº”è¯¥ä¸‹è½½<code>frida-server-16.1.3-android-arm64.xz </code>æ–‡ä»¶ã€‚</p><p>æŸ¥çœ‹æ‰‹æœºcpuæ¶æ„çš„æŒ‡ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">./adb shell getprop ro<span class="hljs-selector-class">.product</span><span class="hljs-selector-class">.cpu</span>.abi<br></code></pre></td></tr></table></figure><p>ä¸‹è½½åè§£å‹ï¼Œå¯ä»¥å°†å¾—åˆ°çš„æ–‡ä»¶é‡å‘½åä¸ºfrida-serverï¼Œé€šè¿‡<code>adb push</code>ä¼ å…¥æ‰‹æœºé‡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./adb push frida-server /data/local/tmp/<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>frida-server</code>ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">./adb shell<br>su<br><span class="hljs-built_in">cd</span> /data/local/tmp/<br><span class="hljs-built_in">chmod</span> 777 frida-server<br>./frida-server<br></code></pre></td></tr></table></figure><p>æ­£å¸¸å¯åŠ¨åï¼Œå¦å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œä½¿ç”¨<code>frida-ps -U</code>å‘½ä»¤æ£€æŸ¥<code>frida</code>æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¦‚æœæ­£å¸¸è¿è¡Œåˆ™ä¼šåˆ—å‡ºAndroidè®¾å¤‡ä¸Šå½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308241939948.jpg"></p><p>ç„¶åæ˜¯<code>frida</code>çš„å…¶ä»–å‘½ä»¤</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>ä¿®æ”¹å¯åŠ¨ç«¯å£å¹¶å¯åŠ¨frida-server<br>./frida-server -l <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">9999</span><br><span class="hljs-regexp">//</span>ç”µè„‘ç«¯é€šè¿‡ç½‘ç»œè¿æ¥æ‰‹æœºç«¯çš„frida-server<br>frida-ps -H æ‰‹æœºip:ç«¯å£ ï¼ˆæ‰‹æœºipå¯åœ¨adb shellä¸­ä½¿ç”¨ifconfig | grep <span class="hljs-string">&quot;inet addr&quot;</span>ï¼‰<br><span class="hljs-regexp">//</span>ç”µè„‘ç«¯é€šè¿‡USBè¿æ¥æ‰‹æœºç«¯çš„frida-server<br>frida-ps -U<br><span class="hljs-regexp">//</span>-f å‚æ•°ç”¨äºæŒ‡å®šè¦è¿è¡Œçš„ç›®æ ‡åº”ç”¨ç¨‹åºã€‚è¿™é‡Œæ˜¯å¯åŠ¨è®¾ç½®ç¨‹åº<br>frida -H æ‰‹æœºip:ç«¯å£ -f com.android.settings<br></code></pre></td></tr></table></figure><h1 id="objectioné…ç½®"><a href="#objectioné…ç½®" class="headerlink" title="objectioné…ç½®"></a>objectioné…ç½®</h1><p>æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ä»£ç†ä¸‹è½½<code>objection</code>ï¼š</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">proxychains pip <span class="hljs-keyword">install</span> objection<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šå‡ºé”™ï¼š</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">ModuleNotFoundError:</span> No <span class="hljs-keyword">module</span> named <span class="hljs-comment">&#x27;_lzma&#x27;</span><br></code></pre></td></tr></table></figure><p>è¿™æ—¶å€™éœ€è¦å®‰è£…ç›¸åº”çš„ä¾èµ–ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment"># centosç³»ç»Ÿæ‰§è¡Œ</span><br>yum <span class="hljs-keyword">install </span>xz-devel -y<br>yum <span class="hljs-keyword">install </span>python-<span class="hljs-keyword">backports-lzma </span>-y<br><br><span class="hljs-comment"># Debian/ubuntuç³»ç»Ÿæ‰§è¡Œ</span><br>apt-get <span class="hljs-keyword">install </span>liblzma-dev -y<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œåéœ€è¦é‡æ–°ç¼–è¯‘å®‰è£…pythonç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯å¸è½½é‡è£…pythonã€‚</p><p>ï¼ˆå‚è€ƒ<a href="https://zhuanlan.zhihu.com/p/404162713">ModuleNotFoundError: No module named â€˜_lzmaâ€™ - çŸ¥ä¹ (zhihu.com)</a>ï¼‰</p><p>ä½¿ç”¨<code>objection</code>æ¥è¿æ¥<code>frida-server</code>ï¼ŒæˆåŠŸçš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308241939395.jpg"></p><h1 id="fridaè„šæœ¬ç¼–å†™çš„ç¯å¢ƒé…ç½®"><a href="#fridaè„šæœ¬ç¼–å†™çš„ç¯å¢ƒé…ç½®" class="headerlink" title="fridaè„šæœ¬ç¼–å†™çš„ç¯å¢ƒé…ç½®"></a>fridaè„šæœ¬ç¼–å†™çš„ç¯å¢ƒé…ç½®</h1><p>ä¸‹è½½vscodeå®‰è£…åŒ…ï¼Œå‚è€ƒï¼š<a href="https://blog.csdn.net/feinifi/article/details/127697851">vscodeå®˜æ–¹ä¸‹è½½å¤ªæ…¢è§£å†³åŠæ³•_vscodeusersetup-x64-1.79.2.exe_luffy5459çš„åšå®¢-CSDNåšå®¢</a></p><p>ä¸‹è½½å®Œåï¼Œè¿›å…¥åˆ°æ‰€åœ¨ç›®å½•ï¼Œæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤å®‰è£…vscodeï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">dpkg</span> -i code_1.<span class="hljs-number">81</span>.<span class="hljs-number">1</span>-<span class="hljs-number">1691620686</span>_amd64.deb<br></code></pre></td></tr></table></figure><p>ä¹‹åä»£ç†ä¸‹è½½<code>frida-agent-example</code>ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">proxychain git clone https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/oleavr/</span>frida-agent-example<br></code></pre></td></tr></table></figure><p>å¦‚æœæ–‡ä»¶å›¾æ ‡åŠ é”äº†ï¼Œå°±éœ€è¦ä¿®æ”¹æƒé™ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">chmod</span> -R <span class="hljs-number">777</span> frida-agent-example<br></code></pre></td></tr></table></figure><p>ä¸ºäº†è·å–ä»£ç æç¤ºï¼Œä¸‹è½½Node.jsï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -<br>sudo apt-get install -y nodejs<br></code></pre></td></tr></table></figure><p>ï¼ˆä¸è¿‡ä¸‹ä¸äº†ç‰ˆæœ¬10.xçš„ï¼Œç›´æ¥ç»™ä¸‹æœ€æ–°çš„äº†ï¼‰</p><p>ç„¶åæ˜¯åˆ°<code>frida-agent-example</code>ç›®å½•ä¸‹æ‰§è¡Œ<code>npm install</code>ï¼Œå¯æƒœæŠ¥é”™ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">Error: compilation failed<br>    at Module.build (file:<span class="hljs-regexp">//</span><span class="hljs-regexp">/home/</span>kali<span class="hljs-regexp">/%E6%A1%8C%E9%9D%A2/</span>frida-agent-example<span class="hljs-regexp">/node_modules/</span>frida-compile<span class="hljs-regexp">/dist/</span>compiler.js:<span class="hljs-number">35</span>:<span class="hljs-number">15</span>)                          <br>    at main (file:<span class="hljs-regexp">//</span><span class="hljs-regexp">/home/</span>kali<span class="hljs-regexp">/%E6%A1%8C%E9%9D%A2/</span>frida-agent-example<span class="hljs-regexp">/node_modules/</span>frida-compile<span class="hljs-regexp">/dist/</span>cli.js:<span class="hljs-number">37</span>:<span class="hljs-number">39</span>)<br>    at file:<span class="hljs-regexp">//</span><span class="hljs-regexp">/home/</span>kali<span class="hljs-regexp">/%E6%A1%8C%E9%9D%A2/</span>frida-agent-example<span class="hljs-regexp">/node_modules/</span>frida-compile<span class="hljs-regexp">/dist/</span>cli.js:<span class="hljs-number">56</span>:<span class="hljs-number">1</span><br>    at ModuleJob.run (node:internal<span class="hljs-regexp">/modules/</span>esm/module_job:<span class="hljs-number">194</span>:<span class="hljs-number">25</span>)<br>npm ERR! code <span class="hljs-number">1</span><br>npm ERR! path <span class="hljs-regexp">/home/</span>kali<span class="hljs-regexp">/æ¡Œé¢/</span>frida-agent-example<br>npm ERR! command failed<br>npm ERR! command sh -c npm run build<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨vscodeä¸­ä»ç„¶å¯ä»¥æœ‰ä»£ç æç¤ºï¼ï¼ï¼</p><p>ç¯å¢ƒé…ç½®å¥½äº†ã€‚æ¥ä¸‹æ¥å°±å†™ä¸ªè„šæœ¬è¯•ä¸€è¯•ã€‚</p><p>ä½¿ç”¨vscodeæ‰“å¼€<code>frida-agent-example</code>ç›®å½•ä¸‹çš„<code>agent</code>ç›®å½•ï¼Œåˆ›å»ºä¸€ä¸ªjsè„šæœ¬ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"># <span class="hljs-attr">filename</span>: ts1.<span class="hljs-property">js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>  <span class="hljs-title function_">x</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;nihao123&quot;</span>)<br>    &#125;)<br>&#125;<br><span class="hljs-title function_">setImmediate</span>(main)<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨vscodeä¸­å¼€å¯Terminalï¼Œæ‰§è¡ŒæŒ‡ä»¤</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">frida -H <span class="hljs-number">192.168</span>.<span class="hljs-number">0.101</span>:<span class="hljs-number">9999</span> -f com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span> -l ts1<span class="hljs-selector-class">.js</span> <span class="hljs-attr">--no-pause</span><br></code></pre></td></tr></table></figure><p>å¯æ˜¯æŠ¥é”™ï¼š</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">frida: <span class="hljs-keyword">error</span>: unrecognized arguments: --<span class="hljs-keyword">no</span>-<span class="hljs-keyword">pause</span><br></code></pre></td></tr></table></figure><p>å»æ‰<code>--no-pause</code>å°±å¯ä»¥æ‰§è¡Œäº†(åŸå› å‚è€ƒ<a href="https://github.com/frida/frida/issues/2277">frida: error: unrecognized arguments: â€“no-pause Â· Issue #2277 Â· frida&#x2F;frida (github.com)</a>)</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308241939143.jpg"></p><p>ï¼ˆè¿™å¯ä¸æ˜¯æˆ‘åŠ ä¸Šå»çš„ï¼‰</p><p>æ¥ä¸‹æ¥å°±åˆ©ç”¨pythonçš„firdaåº“å°è¯•æ‰¹é‡åŒ–å¤„ç†ã€‚ï¼ˆpythonçš„firdaæ²¡æœ‰ä»£ç æç¤ºï¼ï¼ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªpythonè„šæœ¬ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># filename: loader.py</span><br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> frida<br><br>device = frida.get_device_manager().add_remote_device(<span class="hljs-string">&quot;192.168.0.101:9999&quot;</span>)<br>pid = device.spawn([<span class="hljs-string">&#x27;com.android.settings&#x27;</span>])<br>device.resume(pid)<br>session = device.attach(pid)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;ts1.js&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    script = session.create_script(f.read())<br>script.load()<br>imput()<br></code></pre></td></tr></table></figure><p>åœ¨æ§åˆ¶å°ä¸­è¾“å…¥<code>python loader.py</code>ï¼ŒæˆåŠŸäº†ï¼</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308241939153.jpg"></p><p>å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåˆ™å¯èƒ½æ˜¯<code>pyenv</code>ç¯å¢ƒæ²¡æœ‰é…ç½®å¯¹ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¯å¢ƒé…ç½®</tag>
      
      <tag>Frida</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå¼€å‘å­¦ä¹ ç¬”è®°(å…«) â€”â€” æ¢ç©¶ContentProvider</title>
    <link href="/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%AB)%20%E2%80%94%E2%80%94%20%E6%8E%A2%E7%A9%B6ContentProvider/"/>
    <url>/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%AB)%20%E2%80%94%E2%80%94%20%E6%8E%A2%E7%A9%B6ContentProvider/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯ContentProvider"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯ContentProvider" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯ContentProvider"></a>ä¸€ã€ä»€ä¹ˆæ˜¯ContentProvider</h1><h2 id="1-1-æ¦‚å¿µ"><a href="#1-1-æ¦‚å¿µ" class="headerlink" title="1.1 æ¦‚å¿µ"></a>1.1 æ¦‚å¿µ</h2><p>å†…å®¹æä¾›å™¨(Content Provider)æ˜¯Androidå››å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦ç”¨äºåœ¨ä¸åŒçš„åº”ç”¨ç¨‹åºä¹‹é—´å®ç°æ•°æ®å…±äº«çš„åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸€å¥—å®Œæ•´çš„æœºåˆ¶ï¼Œå…è®¸ä¸€ä¸ªç¨‹åºè®¿é—®å¦ä¸€ä¸ªç¨‹åºä¸­çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯è¢«è®¿æ•°æ®çš„å®‰å…¨æ€§ã€‚ä½¿ç”¨æ—¶éœ€è¦åœ¨<code>AndroidManifest..xml</code>æ–‡ä»¶ä¸­è¿›è¡Œå£°æ˜ã€‚</p><p>ä¸åŒäºæ–‡ä»¶å­˜å‚¨å’ŒSharedPreferenceså­˜å‚¨ä¸­çš„ä¸¤ç§å…¨å±€å¯è¯»å†™æ“ä½œæ¨¡å¼ï¼Œå†…å®¹æä¾›å™¨å¯ä»¥é€‰æ‹©åªå¯¹å“ªä¸€éƒ¨åˆ†æ•°æ®è¿›è¡Œå…±äº«ï¼Œä»è€Œä¿è¯æˆ‘ä»¬ç¨‹åºä¸­çš„éšç§æ•°æ®ä¸ä¼šæœ‰æ³„æ¼çš„é£é™©ã€‚</p><p>ä¸è¿‡åœ¨æ­£å¼å¼€å§‹å­¦ä¹ å†…å®¹æä¾›å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŒæ¡å¦å¤–ä¸€ä¸ªéå¸¸é‡è¦çš„çŸ¥è¯†Androidè¿è¡Œæ—¶æƒé™ï¼Œå› ä¸ºå¾…ä¼šçš„å†…å®¹æä¾›å™¨ç¤ºä¾‹ä¸­ä¼šä½¿ç”¨åˆ°è¿è¡Œæ—¶æƒé™çš„åŠŸèƒ½ã€‚</p><h1 id="äºŒã€è¿è¡Œæ—¶æƒé™"><a href="#äºŒã€è¿è¡Œæ—¶æƒé™" class="headerlink" title="äºŒã€è¿è¡Œæ—¶æƒé™"></a>äºŒã€è¿è¡Œæ—¶æƒé™</h1><h3 id="2-1-Androidæƒé™æœºåˆ¶è¯¦è§£"><a href="#2-1-Androidæƒé™æœºåˆ¶è¯¦è§£" class="headerlink" title="2.1 Androidæƒé™æœºåˆ¶è¯¦è§£"></a>2.1 Androidæƒé™æœºåˆ¶è¯¦è§£</h3><p>åœ¨ä¹‹å‰çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ¥è§¦è¿‡ä¸€äº›æƒé™ã€‚ä¾‹å¦‚ï¼ŒBroadcastTesté¡¹ç›®çš„æ—¶å€™ç¬¬ä¸€æ¬¡æ¥è§¦äº†Androidæƒé™ç›¸å…³çš„å†…å®¹ï¼Œå½“æ—¶ä¸ºäº†è¦è®¿é—®ç³»ç»Ÿçš„ç½‘ç»œçŠ¶æ€ä»¥åŠç›‘å¬å¼€æœºå¹¿æ’­ï¼Œäºæ˜¯åœ¨<code>AndroidManifest..xml</code>æ–‡ä»¶ä¸­æ·»åŠ äº†è¿™æ ·ä¸¤å¥æƒé™å£°æ˜ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.example.broadcasttest&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.ACCESS NETWORK STATE&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.RECEIVE BOOT COMPLETED&quot;</span>/&gt;</span><br>    ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å› ä¸ºè®¿é—®ç³»ç»Ÿçš„ç½‘ç»œçŠ¶æ€ä»¥åŠç›‘å¬å¼€æœºå¹¿æ’­æ¶‰åŠäº†ç”¨æˆ·è®¾å¤‡çš„å®‰å…¨æ€§ï¼Œå› æ­¤å¿…é¡»åœ¨<code>AndroidManifest.xml</code>ä¸­åŠ å…¥æƒé™å£°æ˜ï¼Œå¦åˆ™æˆ‘ä»¬çš„ç¨‹åºå°±ä¼šå´©æºƒã€‚</p><p>é‚£ä¹ˆç°åœ¨é—®é¢˜æ¥äº†ï¼ŒåŠ å…¥äº†è¿™ä¸¤å¥æƒé™å£°æ˜åï¼Œå¯¹äºç”¨æˆ·æ¥è¯´åˆ°åº•æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿™æ ·å°±å¯ä»¥ä¿æŠ¤ç”¨æˆ·è®¾å¤‡çš„å®‰å…¨æ€§äº†å‘¢ï¼Ÿå…¶å®ç”¨æˆ·ä¸»è¦åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢å¾—åˆ°äº†ä¿æŠ¤ï¼Œä¸€æ–¹é¢ï¼Œç”¨æˆ·åœ¨å®‰è£…ç¨‹åºçš„æ—¶å€™ä¼šåœ¨å®‰è£…ç•Œé¢æ˜¾ç¤ºåº”ç”¨æ‰€éœ€è¦çš„æƒé™ï¼›å¦ä¸€æ–¹é¢ï¼Œç”¨æˆ·å¯ä»¥éšæ—¶åœ¨åº”ç”¨ç¨‹åºç®¡ç†ç•Œé¢æŸ¥çœ‹ä»»æ„ä¸€ä¸ªç¨‹åºçš„æƒé™ç”³è¯·æƒ…å†µï¼Œä»¥ä¿è¯åº”ç”¨ç¨‹åºä¸ä¼šå‡ºç°å„ç§æ»¥ç”¨æƒé™çš„æƒ…å†µã€‚</p><p>ç„¶è€Œå¤§å¤šæ•°åº”ç”¨å­˜åœ¨æ»¥ç”¨æƒé™çš„æƒ…å†µï¼Œä¸ç®¡åˆ°åº•ç”¨ä¸ç”¨å¾—åˆ°ï¼Œåæ­£å…ˆæŠŠæƒé™ç”³è¯·äº†å†è¯´ã€‚Androidå¼€å‘å›¢é˜Ÿå½“ç„¶ä¹Ÿæ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œäºæ˜¯åœ¨6.0ç³»ç»Ÿä¸­åŠ å…¥äº†è¿è¡Œæ—¶æƒé™åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·ä¸éœ€è¦åœ¨å®‰è£…è½¯ä»¶çš„æ—¶å€™ä¸€æ¬¡æ€§æˆæƒæ‰€æœ‰ç”³è¯·çš„æƒé™ï¼Œè€Œæ˜¯å¯ä»¥åœ¨è½¯ä»¶çš„ä½¿ç”¨è¿‡ç¨‹ä¸­å†å¯¹æŸä¸€é¡¹æƒé™ç”³è¯·è¿›è¡Œæˆæƒã€‚æ¯”å¦‚è¯´ä¸€æ¬¾ç›¸æœºåº”ç”¨åœ¨è¿è¡Œæ—¶ç”³è¯·äº†åœ°ç†ä½ç½®å®šä½æƒé™ï¼Œå°±ç®—æˆ‘æ‹’ç»äº†è¿™ä¸ªæƒé™ï¼Œä½†æ˜¯æˆ‘åº”è¯¥ä»ç„¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªåº”ç”¨çš„å…¶ä»–åŠŸèƒ½ï¼Œè€Œä¸æ˜¯åƒä¹‹å‰é‚£æ ·ç›´æ¥æ— æ³•å®‰è£…å®ƒã€‚</p><p>å½“ç„¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æƒé™éƒ½éœ€è¦åœ¨è¿è¡Œæ—¶ç”³è¯·ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œä¸åœåœ°æˆæƒä¹Ÿå¾ˆçƒ¦çã€‚Androidç°åœ¨å°†æ‰€æœ‰çš„æƒé™å½’æˆäº†ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æ™®é€šæƒé™ï¼Œä¸€ç±»æ˜¯å±é™©æƒé™ã€‚æ™®é€šæƒé™æŒ‡çš„æ˜¯é‚£äº›ä¸ä¼šç›´æ¥å¨èƒåˆ°ç”¨æˆ·çš„å®‰å…¨å’Œéšç§çš„æƒé™ï¼Œå¯¹äºè¿™éƒ¨åˆ†æƒé™ç”³è¯·ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è¿›è¡Œæˆæƒï¼Œè€Œä¸éœ€è¦ç”¨æˆ·å†å»æ‰‹åŠ¨æ“ä½œäº†ï¼Œæ¯”å¦‚åœ¨BroadcastTesté¡¹ç›®ä¸­ç”³è¯·çš„ä¸¤ä¸ªæƒé™å°±æ˜¯æ™®é€šæƒé™ã€‚å±é™©æƒé™åˆ™è¡¨ç¤ºé‚£äº›å¯èƒ½ä¼šè§¦åŠç”¨æˆ·éšç§ï¼Œæˆ–è€…å¯¹è®¾å¤‡å®‰å…¨æ€§é€ æˆå½±å“çš„æƒé™ï¼Œå¦‚è·å–è®¾å¤‡è”ç³»äººä¿¡æ¯ã€å®šä½è®¾å¤‡çš„åœ°ç†ä½ç½®ç­‰ï¼Œå¯¹äºè¿™éƒ¨åˆ†æƒé™ç”³è¯·ï¼Œå¿…é¡»è¦ç”±ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æˆæƒæ‰å¯ä»¥ï¼Œå¦åˆ™ç¨‹åºå°±æ— æ³•ä½¿ç”¨ç›¸åº”çš„åŠŸèƒ½ã€‚</p><p>ä½†æ˜¯Androidä¸­æœ‰ä¸€å…±æœ‰ä¸Šç™¾ç§æƒé™ï¼Œæˆ‘ä»¬æ€ä¹ˆä»ä¸­åŒºåˆ†å“ªäº›æ˜¯æ™®é€šæƒé™ï¼Œå“ªäº›æ˜¯å±é™©æƒé™å‘¢ï¼Ÿå…¶å®å¹¶æ²¡æœ‰é‚£ä¹ˆéš¾ï¼Œå› ä¸ºå±é™©æƒé™æ€»å…±å°±é‚£ä¹ˆå‡ ä¸ªï¼Œé™¤äº†å±é™©æƒé™ä¹‹å¤–ï¼Œå‰©ä½™çš„å°±éƒ½æ˜¯æ™®é€šæƒé™äº†ã€‚ä¸‹è¡¨åˆ—å‡ºäº†Androidä¸­æ‰€æœ‰çš„å±é™©æƒé™ï¼Œä¸€å…±æ˜¯9ç»„24ä¸ªæƒé™ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131927870.png"></p><p>æˆ‘ä»¬å¹¶ä¸éœ€è¦è®°ä½è¿™äº›æƒé™ï¼Œåªè¦æŠŠå®ƒå½“æˆä¸€ä¸ªå‚ç…§è¡¨æ¥æŸ¥é˜…å°±è¡Œäº†ã€‚æ¯å½“è¦ä½¿ç”¨ä¸€ä¸ªæƒé™æ—¶ï¼Œå¯ä»¥å…ˆåˆ°è¿™å¼ è¡¨ä¸­æ¥æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœæ˜¯å±äºè¿™å¼ è¡¨ä¸­çš„æƒé™ï¼Œé‚£ä¹ˆå°±éœ€è¦è¿›è¡Œè¿è¡Œæ—¶æƒé™å¤„ç†ï¼Œå¦‚æœä¸åœ¨è¿™å¼ è¡¨ä¸­ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸‹æƒé™å£°æ˜å°±å¯ä»¥äº†ã€‚å¦å¤–æ³¨æ„ä¸€ä¸‹ï¼Œè¡¨æ ¼ä¸­æ¯ä¸ªå±é™©æƒé™éƒ½å±äºä¸€ä¸ªæƒé™ç»„ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œè¿è¡Œæ—¶æƒé™å¤„ç†æ—¶ä½¿ç”¨çš„æ˜¯æƒé™åï¼Œä½†æ˜¯ç”¨æˆ·ä¸€æ—¦åŒæ„æˆæƒäº†ï¼Œé‚£ä¹ˆè¯¥æƒé™æ‰€å¯¹åº”çš„æƒé™ç»„ä¸­æ‰€æœ‰çš„å…¶ä»–æƒé™ä¹Ÿä¼šåŒæ—¶è¢«æˆæƒã€‚</p><p>Androidç³»ç»Ÿä¸­å®Œæ•´çš„æƒé™åˆ—è¡¨å¯ä»¥è®¿é—®<a href="http://developer..android.com/reference/android/.Manifest.permission.html">http:&#x2F;developer..android.com&#x2F;reference&#x2F;android&#x2F;.Manifest.permission.html</a>ã€‚</p><h3 id="2-2-åœ¨ç¨‹åºè¿è¡Œæ—¶ç”³è¯·æƒé™"><a href="#2-2-åœ¨ç¨‹åºè¿è¡Œæ—¶ç”³è¯·æƒé™" class="headerlink" title="2.2 åœ¨ç¨‹åºè¿è¡Œæ—¶ç”³è¯·æƒé™"></a>2.2 åœ¨ç¨‹åºè¿è¡Œæ—¶ç”³è¯·æƒé™</h3><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥å­¦ä¹ è¿è¡Œæ—¶æƒé™çš„ä½¿ç”¨æ–¹æ³•ã€‚å‡è®¾åº”ç”¨åœ¨è¿è¡Œæ—¶éœ€è¦ç”³è¯·CALL_PHONEè¿™ä¸ªæƒé™ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ç”¨ä¸€ä¸ªæŒ‰é’®æ¥è§¦å‘æƒé™ç”³è¯·ï¼Œæ‰€ä»¥ä¿®æ”¹<code>activity_main.xml</code>å¸ƒå±€æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ç”³è¯·æƒé™&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;ClicktoAccess&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„MainActivityä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>   ......<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoAccess</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_CALL);<br>            intent.setData(Uri.parse(<span class="hljs-string">&quot;tel:10086&quot;</span>));<br>            startActivity(intent);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>ClicktoAccess()</code>æ–¹æ³•ä¸ºæŒ‰é’®çš„ç‚¹å‡»æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªéšå¼Intentï¼ŒIntentçš„actionæŒ‡å®šä¸º<code>Intent.ACTION_CALL</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿå†…ç½®çš„æ‰“ç”µè¯çš„åŠ¨ä½œï¼Œdataéƒ¨åˆ†æŒ‡å®šäº†åè®®æ˜¯telï¼Œå·ç æ˜¯10086ã€‚å¦å¤–ä¸ºäº†é˜²æ­¢ç¨‹åºå´©æºƒï¼Œæˆ‘ä»¬å°†æ‰€æœ‰æ“ä½œéƒ½æ”¾åœ¨äº†å¼‚å¸¸æ•è·ä»£ç å—å½“ä¸­ã€‚</p><blockquote><p><code>Intent.ACTION_CALL</code>ä¸<code>Intent.ACTION_DIAL</code>ä¸åŒï¼Œ<code>Intent.ACTION_DIAL</code>è¡¨ç¤ºæ‰“å¼€æ‹¨å·ç•Œé¢ï¼Œè¿™ä¸ªæ˜¯ä¸éœ€è¦å£°æ˜æƒé™çš„ï¼Œè€Œ<code>Intent.ACTION_CALL</code>åˆ™å¯ä»¥ç›´æ¥æ‹¨æ‰“ç”µè¯ï¼Œå› æ­¤å¿…é¡»å£°æ˜æƒé™ã€‚</p></blockquote><p>æ¥ä¸‹æ¥å°±æ˜¯åœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­å£°æ˜è¯¥æƒé™ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.CALL_PHONE&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">application</span></span><br><span class="hljs-tag">       <span class="hljs-attr">...</span></span><br><span class="hljs-tag">    &lt;/<span class="hljs-attr">application</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å°†æ‹¨æ‰“ç”µè¯çš„åŠŸèƒ½æˆåŠŸå®ç°äº†ï¼Œå¹¶ä¸”åœ¨ä½äºAndroid6.0ç³»ç»Ÿçš„æ‰‹æœºä¸Šéƒ½æ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨6.0æˆ–è€…æ›´é«˜ç‰ˆæœ¬ç³»ç»Ÿçš„æ‰‹æœºä¸Šè¿è¡Œï¼Œç‚¹å‡»Make CallæŒ‰é’®å°±æ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œè¿™æ—¶è§‚å¯Ÿlogcatä¸­çš„æ‰“å°æ—¥å¿—ï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹è­¦å‘Šä¿¡æ¯ã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.SecurityException</span>: Permission Denial: starting Intent &#123; act=android<span class="hljs-selector-class">.intent</span><span class="hljs-selector-class">.action</span><span class="hljs-selector-class">.CALL</span>...<br></code></pre></td></tr></table></figure><p>è­¦å‘Šä¿¡æ¯ä¸­æé†’æˆ‘ä»¬<code>Permission Denial</code>ï¼Œå¾ˆæ˜æ˜¾ï¼Œæ˜¯ç”±äºæƒé™è¢«ç¦æ­¢æ‰€å¯¼è‡´çš„ï¼Œå› ä¸º6.0åŠä»¥ä¸Šç³»ç»Ÿåœ¨ä½¿ç”¨å±é™©æƒé™æ—¶éƒ½å¿…é¡»è¿›è¡Œè¿è¡Œæ—¶æƒé™å¤„ç†ã€‚</p><p>é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥å°è¯•ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œä¿®æ”¹MainActivityä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoAccess</span><span class="hljs-params">(View view)</span> &#123;<br><br>        <span class="hljs-keyword">if</span> (ContextCompat.checkSelfPermission(MainActivity.<span class="hljs-built_in">this</span>, android.Manifest.permission.CALL_PHONE)<br>            != PackageManager.PERMISSION_GRANTED)&#123;<br>            ActivityCompat.requestPermissions(MainActivity.<span class="hljs-built_in">this</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;android.Manifest.permission.CALL_PHONE&#125;,<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            call();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_CALL);<br>            intent.setData(Uri.parse(<span class="hljs-string">&quot;tel:10086&quot;</span>));<br>            startActivity(intent);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRequestPermissionsResult</span><span class="hljs-params">(<span class="hljs-type">int</span> requestCode, <span class="hljs-meta">@NonNull</span> String[] permissions, <span class="hljs-meta">@NonNull</span> <span class="hljs-type">int</span>[] grantResults)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);<br>        <span class="hljs-keyword">switch</span> (requestCode) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">if</span> (grantResults.length &gt; <span class="hljs-number">0</span> &amp;&amp; grantResults[<span class="hljs-number">0</span>] == PackageManager.PERMISSION_GRANTED)&#123;<br>                    call();<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;ä½ æ‹’ç»äº†æ­¤æƒé™ç”³è¯·&quot;</span>, Toast.LENGTH_SHORT).show();<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯´ç™½äº†ï¼Œè¿è¡Œæ—¶æƒé™çš„æ ¸å¿ƒå°±æ˜¯åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ç”±ç”¨æˆ·æˆæƒå»æ‰§è¡ŒæŸäº›å±é™©æ“ä½œï¼Œç¨‹åºæ˜¯ä¸å¯ä»¥æ“…è‡ªåšä¸»å»æ‰§è¡Œè¿™äº›å±é™©æ“ä½œçš„ã€‚</p><p>ä¸Šé¢çš„ä»£ç å°†è¿è¡Œæ—¶æƒé™çš„å®Œæ•´æµç¨‹éƒ½è¦†ç›–äº†ï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ol><li>é¦–å…ˆé€šè¿‡<code>ContextCompat.checkSelfPermission()</code>æ–¹æ³•åˆ¤æ–­ç”¨æˆ·æ˜¯ä¸æ˜¯å·²ç»ç»™è¿‡æˆæƒï¼Œè¯¥æ–¹æ³•å‚æ•°å¦‚ä¸‹ï¼š<ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Context</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯å…·ä½“çš„æƒé™åï¼Œæ¯”å¦‚æ‰“ç”µè¯çš„æƒé™åå°±æ˜¯<code>android.Manifest.permission.CALL_PHONE</code>ã€‚</li></ul></li><li>ç„¶åå°†<code>ContextCompat.checkSelfPermission()</code>æ–¹æ³•çš„è¿”å›å€¼å’Œ<code>PackageManager.PERMISSION_GRANTED</code>åšæ¯”è¾ƒï¼Œç›¸ç­‰å°±è¯´æ˜ç”¨æˆ·å·²ç»æˆæƒï¼Œä¸ç­‰å°±è¡¨ç¤ºç”¨æˆ·æ²¡æœ‰æˆæƒã€‚<ul><li>å¦‚æœå·²ç»æˆæƒçš„è¯å°±ç®€å•äº†ï¼Œç›´æ¥å»æ‰§è¡Œæ‹¨æ‰“ç”µè¯çš„é€»è¾‘æ“ä½œå°±å¯ä»¥äº†ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠæ‹¨æ‰“ç”µè¯çš„é€»è¾‘å°è£…åˆ°äº†<code>call()</code>æ–¹æ³•ä¸­ã€‚</li><li>å¦‚æœæ²¡æœ‰æˆæƒçš„è¯ï¼Œåˆ™éœ€è¦è°ƒç”¨<code>ActivityCompat.requestPermissions()</code>æ–¹æ³•æ¥å‘ç”¨æˆ·ç”³è¯·æˆæƒï¼Œè¯¥æ–¹æ³•æ–¹æ³•æ¥æ”¶3ä¸ªå‚æ•°ï¼š<ul><li>ç¬¬ä¸€ä¸ªå‚æ•°è¦æ±‚æ˜¯Activityçš„å®ä¾‹</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªStringæ•°ç»„ï¼Œæˆ‘ä»¬æŠŠè¦ç”³è¯·çš„æƒé™åæ”¾åœ¨æ•°ç»„ä¸­å³å¯</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è¯·æ±‚ç ï¼Œåªè¦æ˜¯å”¯ä¸€å€¼å°±å¯ä»¥äº†ã€‚</li></ul></li></ul></li><li>è°ƒç”¨å®Œäº†<code>requestPermissions()</code>æ–¹æ³•ä¹‹åï¼Œç³»ç»Ÿä¼šå¼¹å‡ºä¸€ä¸ªæƒé™ç”³è¯·çš„å¯¹è¯æ¡†ï¼Œç„¶åç”¨æˆ·å¯ä»¥é€‰æ‹©åŒæ„æˆ–æ‹’ç»æƒé™ç”³è¯·ï¼Œä¸è®ºæ˜¯å“ªç§ç»“æœï¼Œæœ€ç»ˆéƒ½ä¼šå›è°ƒåˆ°<code>onRequestPermissionsResult()</code>æ–¹æ³•ä¸­ï¼Œè€Œæˆæƒçš„ç»“æœåˆ™ä¼šå°è£…åœ¨<code>grantResults</code>å‚æ•°å½“ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬åªéœ€è¦åˆ¤æ–­ä¸€ä¸‹æœ€åçš„æˆæƒç»“æœï¼Œå¦‚æœç”¨æˆ·åŒæ„çš„è¯å°±è°ƒç”¨<code>call()</code>æ–¹æ³•æ¥æ‹¨æ‰“ç”µè¯ï¼Œå¦‚æœç”¨æˆ·æ‹’ç»çš„è¯æˆ‘ä»¬åªèƒ½æ”¾å¼ƒæ“ä½œï¼Œå¹¶ä¸”å¼¹å‡ºä¸€æ¡å¤±è´¥æç¤ºã€‚</li></ol><p>ç°åœ¨é‡æ–°è¿è¡Œä¸€ä¸‹ç¨‹åºï¼Œå¹¶ç‚¹å‡»æŒ‰é’®ï¼Œä¼šå‡ºç°æƒé™ç”³è¯·çš„å¼¹çª—ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©åŒæ„æˆ–æ‹’ç»ã€‚å¦‚æœé€‰æ‹©æ‹’ç»ï¼Œåˆ™ä¼šå¼¹å‡ºæç¤ºï¼Œä¸‹æ¬¡å†ç‚¹å‡»æŒ‰é’®ä»ä¼šå‡ºç°æƒé™ç”³è¯·å¼¹çª—ã€‚å¦‚æœé€‰æ‹©åŒæ„ï¼Œåˆ™ä¼šè·³è½¬åˆ°æ‹¨æ‰“ç”µè¯ç•Œé¢ï¼Œå¹¶ä¸”æ‹¨æ‰“äº†10086ï¼Œå¹¶ä¸”ç”±äºç”¨æˆ·å·²ç»å®Œæˆäº†æˆæƒæ“ä½œï¼Œä¹‹åå†ç‚¹å‡»æŒ‰é’®å°±ä¸ä¼šå†å¼¹å‡ºæƒé™ç”³è¯·å¯¹è¯æ¡†äº†ï¼Œè€Œæ˜¯ç›´æ¥æ‹¨æ‰“ç”µè¯ï¼ˆæƒ³è¦éœ€è¦æˆæƒå¯ä»¥åœ¨åº”ç”¨ç®¡ç†ä¸­è¿›è¡Œæƒé™å…³é—­ï¼‰ã€‚</p><h1 id="ä¸‰ã€è®¿é—®å…¶ä»–ç¨‹åºä¸­çš„æ•°æ®"><a href="#ä¸‰ã€è®¿é—®å…¶ä»–ç¨‹åºä¸­çš„æ•°æ®" class="headerlink" title="ä¸‰ã€è®¿é—®å…¶ä»–ç¨‹åºä¸­çš„æ•°æ®"></a>ä¸‰ã€è®¿é—®å…¶ä»–ç¨‹åºä¸­çš„æ•°æ®</h1><p>å†…å®¹æä¾›å™¨çš„ç”¨æ³•ä¸€èˆ¬æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ç°æœ‰çš„å†…å®¹æä¾›å™¨æ¥è¯»å–å’Œæ“ä½œç›¸åº”ç¨‹åºä¸­çš„æ•°æ®ï¼Œå¦ä¸€ç§æ˜¯åˆ›å»ºè‡ªå·±çš„å†…å®¹æä¾›å™¨ç»™æˆ‘ä»¬ç¨‹åºçš„æ•°æ®æä¾›å¤–éƒ¨è®¿é—®æ¥å£ã€‚</p><p>å¦‚æœä¸€ä¸ªåº”ç”¨ç¨‹åºé€šè¿‡å†…å®¹æä¾›å™¨å¯¹å…¶æ•°æ®æä¾›äº†å¤–éƒ¨è®¿é—®æ¥å£ï¼Œé‚£ä¹ˆä»»ä½•å…¶ä»–çš„åº”ç”¨ç¨‹åºå°±éƒ½å¯ä»¥å¯¹è¿™éƒ¨åˆ†æ•°æ®è¿›è¡Œè®¿é—®ã€‚Androidç³»ç»Ÿä¸­è‡ªå¸¦çš„ç”µè¯ç°¿ã€çŸ­ä¿¡ã€åª’ä½“åº“ç­‰ç¨‹åºéƒ½æä¾›äº†ç±»ä¼¼çš„è®¿é—®æ¥å£ï¼Œè¿™ä½¿å¾—ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå¯ä»¥å……åˆ†åœ°åˆ©ç”¨è¿™éƒ¨åˆ†æ•°æ®æ¥å®ç°æ›´å¥½çš„åŠŸèƒ½ã€‚</p><h2 id="3-1-contentResolverçš„åŸºæœ¬ç”¨æ³•"><a href="#3-1-contentResolverçš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="3.1 contentResolverçš„åŸºæœ¬ç”¨æ³•"></a>3.1 contentResolverçš„åŸºæœ¬ç”¨æ³•</h2><p>å¯¹äºæ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œå¦‚æœæƒ³è¦è®¿é—®å†…å®¹æä¾›å™¨ä¸­å…±äº«çš„æ•°æ®ï¼Œå°±ä¸€å®šè¦å€ŸåŠ©<code>ContentResolver</code>ç±»ï¼Œå¯ä»¥é€šè¿‡<code>Context</code>ä¸­çš„<code>getContentResolver()</code>æ–¹æ³•è·å–åˆ°è¯¥ç±»çš„å®ä¾‹ã€‚<code>ContentResolver</code>ä¸­æä¾›äº†ä¸€ç³»åˆ—çš„æ–¹æ³•ç”¨äºå¯¹æ•°æ®è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰æ“ä½œï¼Œå…¶ä¸­<code>insert()</code>æ–¹æ³•ç”¨äºæ·»åŠ æ•°æ®ï¼Œ<code>update()</code>æ–¹æ³•ç”¨äºæ›´æ–°æ•°æ®ï¼Œ<code>delete()</code>æ–¹æ³•ç”¨äºåˆ é™¤æ•°æ®ï¼Œ<code>query()</code>æ–¹æ³•ç”¨äºæŸ¥è¯¢æ•°æ®ã€‚</p><p>ä¸SQLiteDatabaseä¸åŒï¼ŒContentResolverä¸­çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•éƒ½æ˜¯ä¸æ¥æ”¶è¡¨åå‚æ•°çš„ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªUriå‚æ•°ä»£æ›¿ï¼Œè¿™ä¸ªå‚æ•°è¢«ç§°ä¸º<strong>å†…å®¹URI</strong>ã€‚å†…å®¹URIç»™å†…å®¹æä¾›å™¨ä¸­çš„æ•°æ®å»ºç«‹äº†å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå®ƒä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š**<code>authority</code><strong>å’Œ</strong><code>path</code>**ã€‚<code>authority</code>æ˜¯ç”¨äºå¯¹ä¸åŒçš„åº”ç”¨ç¨‹åºåšåŒºåˆ†çš„ï¼Œä¸€èˆ¬ä¸ºäº†é¿å…å†²çªï¼Œéƒ½ä¼šé‡‡ç”¨ç¨‹åºåŒ…åçš„æ–¹å¼æ¥è¿›è¡Œå‘½åï¼Œæ¯”å¦‚æŸä¸ªç¨‹åºçš„åŒ…åæ˜¯<code>com.example.app</code>ï¼Œé‚£ä¹ˆè¯¥ç¨‹åºå¯¹åº”çš„<code>authority</code>å°±å¯ä»¥å‘½åä¸º<code>com.example.app.provider</code>ã€‚<code>path</code>åˆ™æ˜¯ç”¨äºå¯¹åŒä¸€åº”ç”¨ç¨‹åºä¸­ä¸åŒçš„è¡¨åšåŒºåˆ†çš„ï¼Œé€šå¸¸éƒ½ä¼šæ·»åŠ åˆ°<code>authority</code>çš„åé¢ã€‚æ¯”å¦‚æŸä¸ªç¨‹åºçš„æ•°æ®åº“é‡Œå­˜åœ¨ä¸¤å¼ è¡¨ï¼štable1å’Œtable2ï¼Œè¿™æ—¶å°±å¯ä»¥å°†<code>path</code>åˆ†åˆ«å‘½åä¸º<code>/table1</code>å’Œ<code>/table2</code>ï¼Œç„¶åæŠŠ<code>authority</code>å’Œ<code>path</code>è¿›è¡Œç»„åˆï¼Œå†…å®¹URIå°±å˜æˆäº†<code>com.example.app.provider/table1</code>å’Œ<code>com.example.app.provider/table2</code>ã€‚ä¸è¿‡ï¼Œç›®å‰è¿˜å¾ˆéš¾è¾¨è®¤å‡ºè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²å°±æ˜¯ä¸¤ä¸ªå†…å®¹URIï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨å­—ç¬¦ä¸²çš„å¤´éƒ¨åŠ ä¸Šåè®®å£°æ˜ã€‚å› æ­¤ï¼Œå†…å®¹URI æœ€æ ‡å‡†çš„æ ¼å¼å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">content:</span>//<span class="hljs-keyword">com</span>.example.app.provider/tablel<br><span class="hljs-symbol">content:</span>//<span class="hljs-keyword">com</span>.example.app.provider/table2<br></code></pre></td></tr></table></figure><p>å†…å®¹URIå¯ä»¥éå¸¸æ¸…æ¥šåœ°è¡¨è¾¾å‡ºæˆ‘ä»¬æƒ³è¦è®¿é—®å“ªä¸ªç¨‹åºä¸­å“ªå¼ è¡¨é‡Œçš„æ•°æ®ã€‚ä¹Ÿæ­£æ˜¯å› æ­¤ï¼ŒContentResolverä¸­çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•æ‰éƒ½æ¥æ”¶Uriå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨è¡¨åçš„è¯ï¼Œç³»ç»Ÿå°†æ— æ³•å¾—çŸ¥æˆ‘ä»¬æœŸæœ›è®¿é—®çš„æ˜¯å“ªä¸ªåº”ç”¨ç¨‹åºé‡Œçš„è¡¨ã€‚</p><p>åœ¨å¾—åˆ°äº†å†…å®¹URIå­—ç¬¦ä¸²ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†å®ƒè§£ææˆ Uri å¯¹è±¡æ‰å¯ä»¥ä½œä¸ºå‚æ•°ä¼ äººã€‚è§£æçš„æ–¹æ³•ä¹Ÿç›¸å½“ç®€å•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">&quot;content://com.example.app.provider/table1&quot;</span>)<br></code></pre></td></tr></table></figure><p>åªéœ€è¦è°ƒç”¨<code>Uri.parse()</code>æ–¹æ³•ï¼Œå°±å¯ä»¥å°†å†…å®¹URIå­—ç¬¦ä¸²è§£ææˆUriå¯¹è±¡äº†ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯å¢åˆ æ”¹æŸ¥æ“ä½œäº†ï¼Œè¿™éƒ¨åˆ†ä¸SQLiteDatabaseçš„æ“ä½œå¤§åŒå°å¼‚ï¼Œåªä¸è¿‡æ˜¯å¤šäº†ä¸€ä¸ªuriã€‚</p><h3 id="3-1-1-æŸ¥è¯¢"><a href="#3-1-1-æŸ¥è¯¢" class="headerlink" title="3.1.1 æŸ¥è¯¢"></a>3.1.1 æŸ¥è¯¢</h3><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> getContentResolver().query(<br>    uri,<br>    projection,<br>    selection,<br>    selectionArgs,<br>    sortorder);<br></code></pre></td></tr></table></figure><p>è¿™äº›å‚æ•°å¯ä»¥ä¸SQLiteDatabaseä¸­<code>query()</code>æ–¹æ³•çš„å‚æ•°è¿›è¡Œç±»æ¯”ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´å®¹æ˜“ç†è§£ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131928561.jpg"></p><p>æŸ¥è¯¢å®Œæˆåè¿”å›çš„ä»ç„¶æ˜¯ä¸€ä¸ªCursorå¯¹è±¡ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥å°†æ•°æ®ä»Cursorå¯¹è±¡ä¸­é€ä¸ªè¯»å–å‡ºæ¥äº†ã€‚è¯»å–çš„æ€è·¯ä»ç„¶æ˜¯é€šè¿‡ç§»åŠ¨æ¸¸æ ‡çš„ä½ç½®æ¥éå†Cursorçš„æ‰€æœ‰è¡Œï¼Œç„¶åå†å–å‡ºæ¯ä¸€è¡Œä¸­ç›¸åº”åˆ—çš„æ•°æ®ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(cursor != <span class="hljs-literal">null</span>)&#123;<br>    <span class="hljs-keyword">while</span> (cursor.moveToNext())&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">column1</span> <span class="hljs-operator">=</span> cursor.getstring(cursor.getColumnIndex(<span class="hljs-string">&quot;column1&quot;</span>));<br>        <span class="hljs-type">int</span> <span class="hljs-variable">column2</span> <span class="hljs-operator">=</span> cursor.getInt(cursor.getColumnIndex(<span class="hljs-string">&quot;column2&quot;</span>));<br>    &#125;<br>     cursor.close();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-1-2-æ·»åŠ "><a href="#3-1-2-æ·»åŠ " class="headerlink" title="3.1.2 æ·»åŠ "></a>3.1.2 æ·»åŠ </h3><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ContentValues</span> <span class="hljs-variable">values</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();<br>values.put(<span class="hljs-string">&quot;columnl&quot;</span>,<span class="hljs-string">&quot;text&quot;</span>);<br>values.put(<span class="hljs-string">&quot;column2&quot;</span>,<span class="hljs-number">1</span>);<br>getContentResolver().insert(uri,values);<br></code></pre></td></tr></table></figure><p>ä¸SQLiteDatabaseçš„æ“ä½œç›¸ä¼¼ï¼Œä»ç„¶æ˜¯å°†å¾…æ·»åŠ çš„æ•°æ®ç»„è£…åˆ°ContentValuesä¸­ï¼Œç„¶åè°ƒç”¨ContentResolverçš„<code>insert()</code>æ–¹æ³•ï¼Œå°†Uriå’ŒContentValuesä½œä¸ºå‚æ•°ä¼ å…¥å³å¯ã€‚</p><h3 id="3-1-3-æ›´æ–°"><a href="#3-1-3-æ›´æ–°" class="headerlink" title="3.1.3 æ›´æ–°"></a>3.1.3 æ›´æ–°</h3><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ContentValues</span> <span class="hljs-variable">values</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();<br>values.put(<span class="hljs-string">&quot;column1&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)<br>getContentResolver().update(uri,values,<span class="hljs-string">&quot;column1 = ? and column2 = ?&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;text&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>&#125;);<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç é€šè¿‡selectionå’ŒselectionArgså‚æ•°æ¥æŒ‡å®šç¬¦åˆæ¡ä»¶çš„æ•°æ®è¿›è¡Œæ›´æ–°ã€‚</p><h3 id="3-1-4-åˆ é™¤"><a href="#3-1-4-åˆ é™¤" class="headerlink" title="3.1.4 åˆ é™¤"></a>3.1.4 åˆ é™¤</h3><p>è°ƒç”¨ContentResolverçš„delete()æ–¹æ³•å°†è¿™æ¡æ•°æ®åˆ é™¤æ‰ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">getContentResolver().delete(uri,<span class="hljs-string">&quot;column2 = ?&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;1&quot;</span>&#125;);<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬å°±æŠŠContentResolverä¸­çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•å…¨éƒ¨å­¦å®Œäº†ã€‚å› ä¸ºè¿™äº›çŸ¥è¯†åœ¨å­¦ä¹ SQLiteDatabaseçš„æ—¶å€™å°±å·²ç»å­¦ä¹ è¿‡äº†ï¼Œæ‰€éœ€ç‰¹åˆ«æ³¨æ„çš„å°±åªæœ‰uriè¿™ä¸ªå‚æ•°è€Œå·²ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ç›´æ¥è¿›è¡Œå®æ“æ¼”ç»ƒä¸€ä¸‹ã€‚</p><h2 id="3-2-å®æ“-â€”-è¯»å–é€šè®¯å½•çš„è”ç³»äºº"><a href="#3-2-å®æ“-â€”-è¯»å–é€šè®¯å½•çš„è”ç³»äºº" class="headerlink" title="3.2 å®æ“ â€” è¯»å–é€šè®¯å½•çš„è”ç³»äºº"></a>3.2 å®æ“ â€” è¯»å–é€šè®¯å½•çš„è”ç³»äºº</h2><p>ä¸ºäº†æ–¹ä¾¿å±•ç¤ºè”ç³»äººä¿¡æ¯ï¼Œä½¿ç”¨<code>ListView</code>æ§ä»¶ï¼ŒåŒæ—¶ä¸ºäº†çœç•¥æ— å…³ä»£ç ï¼Œä½¿ç”¨é¡¹ç›®ç»™å®šçš„itemï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨æ„å»ºAdapterç±»ã€‚å› æ­¤ï¼Œä¿®æ”¹<code>activity_main.xml</code>ä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">ListView</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/contacts_view&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">ListView</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯MainActivityä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    <span class="hljs-comment">//ListViewçš„é€‚é…å™¨</span><br>    <span class="hljs-keyword">private</span> ArrayAdapter&lt;String&gt; adapter;<br>    <span class="hljs-comment">//å­˜æ”¾è·å–åˆ°çš„è”ç³»äººä¿¡æ¯</span><br>    List&lt;String&gt; contactList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        initListView();<br>        PermissionCheck();<br>    &#125;<br>    <span class="hljs-comment">//è·å–ListViewå¹¶ç»‘å®šé€‚é…å™¨</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initListView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ListView</span> <span class="hljs-variable">contactView</span> <span class="hljs-operator">=</span> findViewById(R.id.contacts_view);<br>        <span class="hljs-comment">//ä½¿ç”¨è‡ªå¸¦çš„item</span><br>        adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayAdapter</span>&lt;String&gt;(<span class="hljs-built_in">this</span>, android.R.layout.simple_list_item_1,contactList);<br>        contactView.setAdapter(adapter);<br>    &#125;<br>    <span class="hljs-comment">//æ£€æŸ¥æƒé™æ˜¯å¦å·²è¢«æˆæƒ</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">PermissionCheck</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (ContextCompat.checkSelfPermission(MainActivity.<span class="hljs-built_in">this</span>, android.Manifest.permission.READ_CONTACTS)<br>                != PackageManager.PERMISSION_GRANTED)&#123;<br>            <span class="hljs-comment">//æœªæˆæƒåˆ™å¼¹çª—ç”³è¯·æˆæƒ</span><br>            ActivityCompat.requestPermissions(MainActivity.<span class="hljs-built_in">this</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;android.Manifest.permission.READ_CONTACTS&#125;,<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//å·²æˆæƒåˆ™è¯»å–è”ç³»äºº</span><br>            readContacts();<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//è¯»å–é€šè®¯å½•çš„è”ç³»äººä¿¡æ¯</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readContacts</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            cursor = getContentResolver().query(ContactsContract.CommonDataKinds.Phone.CONTENT_URI,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">if</span> (cursor != <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">while</span> (cursor.moveToNext())&#123;<br>                    <span class="hljs-comment">//è·å–è”ç³»äººå§“å</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(ContactsContract.CommonDataKinds.Phone.DISPLAY_NAME));<br>                    <span class="hljs-comment">//è·å–è”ç³»äººæ‰‹æœºå·</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">phonenumber</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(ContactsContract.CommonDataKinds.Phone.NUMBER));<br>                    contactList.add(name + <span class="hljs-string">&quot;\n&quot;</span> + phonenumber);<br>                &#125;<br>                <span class="hljs-comment">//é€šçŸ¥åˆ·æ–°ListView</span><br>                adapter.notifyDataSetChanged();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>          <span class="hljs-keyword">if</span> (cursor != <span class="hljs-literal">null</span>)&#123;<br>              cursor.close();<br>          &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//ç”¨æˆ·åšå‡ºé€‰æ‹©åçš„å›è°ƒå‡½æ•°</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRequestPermissionsResult</span><span class="hljs-params">(<span class="hljs-type">int</span> requestCode, <span class="hljs-meta">@NonNull</span> String[] permissions, <span class="hljs-meta">@NonNull</span> <span class="hljs-type">int</span>[] grantResults)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);<br>        <span class="hljs-keyword">switch</span> (requestCode) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">if</span> (grantResults.length &gt; <span class="hljs-number">0</span> &amp;&amp; grantResults[<span class="hljs-number">0</span>] == PackageManager.PERMISSION_GRANTED)&#123;<br>                    readContacts();<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;ä½ æ‹’ç»äº†æ­¤æƒé™ç”³è¯·&quot;</span>, Toast.LENGTH_SHORT).show();<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>onCreate()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè°ƒç”¨<code>initListView()</code>æ–¹æ³•è·å–ListViewå®ä¾‹å¹¶ç»‘å®šé€‚é…å™¨ï¼Œç„¶åè°ƒç”¨<code>PermissionCheck()</code>æ–¹æ³•æ¥è¿›è¡Œè¿è¡Œæ—¶æƒé™çš„å¤„ç†é€»è¾‘ï¼Œè¿™ä¸€éƒ¨åˆ†åˆšæ‰æˆ‘ä»¬å·²ç»åˆ†æè¿‡äº†ã€‚</p><p>ä¸‹é¢é‡ç‚¹çœ‹ä¸€ä¸‹<code>readContacts()</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä½¿ç”¨äº†ContentResolverçš„<code>query()</code>æ–¹æ³•æ¥æŸ¥è¯¢ç³»ç»Ÿçš„è”ç³»äººæ•°æ®ï¼Œä¸è¿‡ä¼ å…¥çš„uri å‚æ•°æ€ä¹ˆæœ‰äº›å¥‡æ€ªå•Šï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰è°ƒç”¨<code>Uri.parse()</code>æ–¹æ³•å»è§£æä¸€ä¸ªå†…å®¹URIå­—ç¬¦ä¸²å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º<code>ContactsContract.CommonData Kinds.Phone</code>ç±»å·²ç»å¸®æˆ‘ä»¬åšå¥½äº†å°è£…ï¼Œæä¾›äº†ä¸€ä¸ª<code>CONTENT_URI</code>å¸¸é‡ï¼Œè€Œè¿™ä¸ªå¸¸é‡å°±æ˜¯ä½¿ç”¨<code>Uri.parse()</code>æ–¹æ³•è§£æå‡ºæ¥çš„ç»“æœã€‚æ¥ç€æˆ‘ä»¬å¯¹Cursorå¯¹è±¡è¿›è¡Œéå†ï¼Œå°†è”ç³»äººå§“åå’Œæ‰‹æœºå·è¿™äº›æ•°æ®é€ä¸ªå–å‡ºï¼Œè”ç³»äººå§“åè¿™ä¸€åˆ—å¯¹åº”çš„å¸¸é‡æ˜¯<code>ContactsContract.CommonDataKinds.Phone.DISPLAY_NAME</code>ï¼Œè”ç³»äººæ‰‹æœºå·è¿™ä¸€åˆ—å¯¹åº”çš„å¸¸é‡æ˜¯<code>ContactsContract.CommonData Kinds.Phone.NUMBER</code>ã€‚ä¸¤ä¸ªæ•°æ®éƒ½å–å‡ºä¹‹åï¼Œå°†å®ƒä»¬è¿›è¡Œæ‹¼æ¥ï¼Œå¹¶ä¸”åœ¨ä¸­é—´åŠ ä¸Šæ¢è¡Œç¬¦ï¼Œç„¶åå°†æ‹¼æ¥åçš„æ•°æ®æ·»åŠ åˆ°ListViewçš„æ•°æ®æºé‡Œï¼Œå¹¶é€šçŸ¥åˆ·æ–°ä¸€ä¸‹ListViewã€‚æœ€åå°†Cursorå¯¹è±¡å…³é—­ã€‚</p><p>æœ€åè¿˜éœ€è¦å£°æ˜è¯»å–é€šè®¯å½•è”ç³»äººçš„æƒé™ã€‚åœ¨<code>AndroidManifest.xml</code>ä¸­æ·»åŠ ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.READ_CONTACTS&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h1 id="å››ã€åˆ›å»ºè‡ªå·±çš„ContentProvider"><a href="#å››ã€åˆ›å»ºè‡ªå·±çš„ContentProvider" class="headerlink" title="å››ã€åˆ›å»ºè‡ªå·±çš„ContentProvider"></a>å››ã€åˆ›å»ºè‡ªå·±çš„ContentProvider</h1><p>åœ¨ä¸Šä¸€èŠ‚å½“ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•åœ¨è‡ªå·±çš„ç¨‹åºä¸­è®¿é—®å…¶ä»–åº”ç”¨ç¨‹åºçš„æ•°æ®ã€‚æ€»ä½“æ¥è¯´æ€è·¯è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œåªéœ€è¦è·å–åˆ°è¯¥åº”ç”¨ç¨‹åºçš„å†…å®¹URIï¼Œç„¶åå€ŸåŠ©ContentResolverè¿›è¡ŒCRUDæ“ä½œå°±å¯ä»¥äº†ã€‚å¯æ˜¯ï¼Œé‚£äº›æä¾›å¤–éƒ¨è®¿é—®æ¥å£çš„åº”ç”¨ç¨‹åºéƒ½æ˜¯å¦‚ä½•å®ç°è¿™ç§åŠŸèƒ½çš„å‘¢ï¼Ÿå®ƒä»¬åˆæ˜¯æ€æ ·ä¿è¯æ•°æ®çš„å®‰å…¨æ€§ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±å…·ä½“å­¦ä¹ ä¸€ä¸‹ã€‚</p><h2 id="4-1-åˆ›å»ºContentProviderçš„æ­¥éª¤"><a href="#4-1-åˆ›å»ºContentProviderçš„æ­¥éª¤" class="headerlink" title="4.1 åˆ›å»ºContentProviderçš„æ­¥éª¤"></a>4.1 åˆ›å»ºContentProviderçš„æ­¥éª¤</h2><p>è¦æƒ³åˆ›å»ºè‡ªå·±çš„ContentProviderï¼Œå¯ä»¥é€šè¿‡æ–°å»ºä¸€ä¸ªç±»å»ç»§æ‰¿ContentProviderçš„æ–¹å¼æ¥åˆ›å»ºã€‚</p><p>ContentProviderç±»ä¸­æœ‰6ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨å­ç±»ç»§æ‰¿å®ƒçš„æ—¶å€™ï¼Œéœ€è¦å°†è¿™6ä¸ªæ–¹æ³•å…¨éƒ¨é‡å†™ã€‚æ–°å»ºMyContentProviderç»§æ‰¿è‡ªContentProviderï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContentProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContentProvider</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Cursor <span class="hljs-title function_">query</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> String[] strings, <span class="hljs-meta">@Nullable</span> String s, <span class="hljs-meta">@Nullable</span> String[] strings1, <span class="hljs-meta">@Nullable</span> String s1)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Uri <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> ContentValues contentValues)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> String s, <span class="hljs-meta">@Nullable</span> String[] strings)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> ContentValues contentValues, <span class="hljs-meta">@Nullable</span> String s, <span class="hljs-meta">@Nullable</span> String[] strings)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li><strong>onCreate()</strong><br>åˆå§‹åŒ–å†…å®¹æä¾›å™¨çš„æ—¶å€™è°ƒç”¨ã€‚é€šå¸¸ä¼šåœ¨è¿™é‡Œå®Œæˆå¯¹æ•°æ®åº“çš„åˆ›å»ºå’Œå‡çº§ç­‰æ“ä½œï¼Œè¿”å›trueè¡¨ç¤ºå†…å®¹æä¾›å™¨åˆå§‹åŒ–æˆåŠŸï¼Œè¿”å›falseåˆ™è¡¨ç¤ºå¤±è´¥ã€‚æ³¨æ„ï¼Œåªæœ‰å½“å­˜åœ¨ContentResolverå°è¯•è®¿é—®æˆ‘ä»¬ç¨‹åºä¸­çš„æ•°æ®æ—¶ï¼Œå†…å®¹æä¾›å™¨æ‰ä¼šè¢«åˆå§‹åŒ–ã€‚</li><li><strong>query()</strong><br>ä»å†…å®¹æä¾›å™¨ä¸­æŸ¥è¯¢æ•°æ®ã€‚ä½¿ç”¨uriå‚æ•°æ¥ç¡®å®šæŸ¥è¯¢å“ªå¼ è¡¨ï¼Œprojectionå‚æ•°ç”¨äºç¡®å®šæŸ¥è¯¢å“ªäº›åˆ—ï¼Œselectionå’ŒselectionArgså‚æ•°ç”¨äºçº¦æŸæŸ¥è¯¢å“ªäº›è¡Œï¼ŒsortOrderå‚æ•°ç”¨äºå¯¹ç»“æœè¿›è¡Œæ’åºï¼ŒæŸ¥è¯¢çš„ç»“æœå­˜æ”¾åœ¨Cursorå¯¹è±¡ä¸­è¿”å›ã€‚</li><li><strong>insert()</strong><br>å‘å†…å®¹æä¾›å™¨ä¸­æ·»åŠ ä¸€æ¡æ•°æ®ã€‚ä½¿ç”¨uriå‚æ•°æ¥ç¡®å®šè¦æ·»åŠ åˆ°çš„è¡¨ï¼Œå¾…æ·»åŠ çš„æ•°æ®ä¿å­˜åœ¨valueså‚æ•°ä¸­ã€‚æ·»åŠ å®Œæˆåï¼Œè¿”å›ä¸€ä¸ªç”¨äºè¡¨ç¤ºè¿™æ¡æ–°è®°å½•çš„URIã€‚</li><li><strong>update()</strong><br>æ›´æ–°å†…å®¹æä¾›å™¨ä¸­å·²æœ‰çš„æ•°æ®ã€‚ä½¿ç”¨uriå‚æ•°æ¥ç¡®å®šæ›´æ–°å“ªä¸€å¼ è¡¨ä¸­çš„æ•°æ®ï¼Œæ–°æ•°æ®ä¿å­˜åœ¨valueså‚æ•°ä¸­ï¼Œselectionå’ŒselectionArgså‚æ•°ç”¨äºçº¦æŸæ›´æ–°å“ªäº›è¡Œï¼Œå—å½±å“çš„è¡Œæ•°å°†ä½œä¸ºè¿”å›å€¼è¿”å›ã€‚</li><li><strong>delete()</strong><br>ä»å†…å®¹æä¾›å™¨ä¸­åˆ é™¤æ•°æ®ã€‚ä½¿ç”¨uriå‚æ•°æ¥ç¡®å®šåˆ é™¤å“ªä¸€å¼ è¡¨ä¸­çš„æ•°æ®ï¼Œselectionå’ŒselectionArgså‚æ•°ç”¨äºçº¦æŸåˆ é™¤å“ªäº›è¡Œï¼Œè¢«åˆ é™¤çš„è¡Œæ•°å°†ä½œä¸ºè¿”å›å€¼è¿”å›ã€‚</li><li><strong>getType()</strong><br>æ ¹æ®ä¼ å…¥çš„å†…å®¹URIæ¥è¿”å›ç›¸åº”çš„MIMEç±»å‹ã€‚</li></ol><p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æåŠåˆ°äº†æ ‡å‡†uriçš„æ ¼å¼ä¸ºï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">content:</span>//<span class="hljs-keyword">com</span>.example.app.provider/tablel<br></code></pre></td></tr></table></figure><p>è¿™å°±è¡¨ç¤ºè°ƒç”¨æ–¹æœŸæœ›è®¿é—®çš„æ˜¯<code>com.example.app</code>è¿™ä¸ªåº”ç”¨çš„table1è¡¨ä¸­çš„æ•°æ®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨è¿™ä¸ªå†…å®¹URIçš„åé¢åŠ ä¸Šä¸€ä¸ªidï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">content:<span class="hljs-regexp">//</span>com.example.app.provider<span class="hljs-regexp">/tablel/</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>è¿™å°±è¡¨ç¤ºè°ƒç”¨æ–¹æœŸæœ›è®¿é—®çš„æ˜¯<code>com.example.app</code>è¿™ä¸ªåº”ç”¨çš„table1è¡¨ä¸­idä¸º1çš„æ•°æ®ã€‚</p><p>å†…å®¹URIçš„æ ¼å¼ä¸»è¦å°±åªæœ‰ä»¥ä¸Šä¸¤ç§ï¼Œä»¥è·¯å¾„ç»“å°¾å°±è¡¨ç¤ºæœŸæœ›è®¿é—®è¯¥è¡¨ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œä»¥idç»“å°¾å°±è¡¨ç¤ºæœŸæœ›è®¿é—®è¯¥è¡¨ä¸­æ‹¥æœ‰ç›¸åº”idçš„æ•°æ®ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€šé…ç¬¦çš„æ–¹å¼æ¥åˆ†åˆ«åŒ¹é…è¿™ä¸¤ç§æ ¼å¼çš„å†…å®¹URIï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>*****ï¼šè¡¨ç¤ºåŒ¹é…ä»»æ„é•¿åº¦çš„ä»»æ„å­—ç¬¦ã€‚</li><li>**#**ï¼šè¡¨ç¤ºåŒ¹é…ä»»æ„é•¿åº¦çš„æ•°å­—ã€‚</li></ul><p>æ‰€ä»¥ï¼Œä¸€ä¸ªèƒ½å¤ŸåŒ¹é…ä»»æ„è¡¨çš„å†…å®¹URIæ ¼å¼å°±å¯ä»¥å†™æˆï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">content:</span>//<span class="hljs-keyword">com</span>.example.app.provider<span class="hljs-comment">/*</span><br></code></pre></td></tr></table></figure><p>è€Œä¸€ä¸ªèƒ½å¤ŸåŒ¹é…table1è¡¨ä¸­ä»»æ„ä¸€è¡Œæ•°æ®çš„å†…å®¹URIæ ¼å¼å°±å¯ä»¥å†™æˆï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">content:<span class="hljs-regexp">//</span>com.example.app.provider<span class="hljs-regexp">/tablel/</span><span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæˆ‘ä»¬å†å€ŸåŠ©<code>UriMatcher</code>è¿™ä¸ªç±»å°±å¯ä»¥è½»æ¾åœ°å®ç°åŒ¹é…å†…å®¹URIçš„åŠŸèƒ½ã€‚<code>UriMatcher</code>ä¸­æä¾›äº†ä¸€ä¸ª<code>addURI()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶3ä¸ªå‚æ•°ï¼Œå¯ä»¥åˆ†åˆ«æŠŠauthorityã€pathå’Œä¸€ä¸ªè‡ªå®šä¹‰ä»£ç ä¼ è¿›å»ã€‚è¿™æ ·ï¼Œå½“è°ƒç”¨<code>UriMatcher</code>çš„<code>match()</code>æ–¹æ³•æ—¶ï¼Œå°±å¯ä»¥å°†ä¸€ä¸ªUriå¯¹è±¡ä¼ å…¥ï¼Œè¿”å›å€¼æ˜¯æŸä¸ªèƒ½å¤ŸåŒ¹é…è¿™ä¸ªUå¯¹è±¡æ‰€å¯¹åº”çš„è‡ªå®šä¹‰ä»£ç ï¼Œåˆ©ç”¨è¿™ä¸ªä»£ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­å‡ºè°ƒç”¨æ–¹æœŸæœ›è®¿é—®çš„æ˜¯å“ªå¼ è¡¨ä¸­çš„æ•°æ®äº†ã€‚ä¿®æ”¹MyContentProviderä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContentProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContentProvider</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TABLE1_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TABLE1_ITEM</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TABLE2_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TABLE2_ITEM</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UriMatcher uriMatcher;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        uriMatcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UriMatcher</span>(UriMatcher.NO_MATCH);<br>        uriMatcher.addURI(<span class="hljs-string">&quot;com.example.app.provider&quot;</span>,<span class="hljs-string">&quot;table1&quot;</span>,TABLE1_DIR);<br>        uriMatcher.addURI(<span class="hljs-string">&quot;com.example.app.provider&quot;</span>,<span class="hljs-string">&quot;table1/#&quot;</span>,TABLE1_ITEM);<br>        uriMatcher.addURI(<span class="hljs-string">&quot;com.example.app.provider&quot;</span>,<span class="hljs-string">&quot;table2&quot;</span>,TABLE2_DIR);<br>        uriMatcher.addURI(<span class="hljs-string">&quot;com.example.app.provider&quot;</span>,<span class="hljs-string">&quot;table/#&quot;</span>,TABLE2_ITEM);<br>    &#125;<br>......<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Cursor <span class="hljs-title function_">query</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> String[] projection, <span class="hljs-meta">@Nullable</span> String selection, <span class="hljs-meta">@Nullable</span> String[] selectionArgs, <span class="hljs-meta">@Nullable</span> String sortOrder, <span class="hljs-meta">@Nullable</span> CancellationSignal cancellationSignal)</span> &#123;<br><br>        <span class="hljs-keyword">switch</span> (uriMatcher.match(uri))&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                <span class="hljs-comment">//æŸ¥è¯¢table1è¡¨ä¸­çš„æ‰€ç”¨æ•°æ®</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                <span class="hljs-comment">//æŸ¥è¯¢table1è¡¨ä¸­çš„å•æ¡æ•°æ®</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                <span class="hljs-comment">//æŸ¥è¯¢table2è¡¨ä¸­çš„æ‰€ç”¨æ•°æ®</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                <span class="hljs-comment">//æŸ¥è¯¢table1è¡¨ä¸­çš„å•æ¡æ•°æ®</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.query(uri, projection, selection, selectionArgs, sortOrder, cancellationSignal);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒMyContentProviderä¸­æ–°å¢äº†4ä¸ªæ•´å‹å¸¸é‡ï¼Œå…¶ä¸­TABLE1_DIRè¡¨ç¤ºè®¿é—®table1è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼ŒTABLE1_ITEMè¡¨ç¤ºè®¿é—®table1è¡¨ä¸­çš„å•æ¡æ•°æ®ï¼ŒTABLE2_DIRè¡¨ç¤ºè®¿é—®table2è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼ŒTABLE2_ITEMè¡¨ç¤ºè®¿é—®table2è¡¨ä¸­çš„å•æ¡æ•°æ®ã€‚</p><p>æ¥ç€åœ¨é™æ€ä»£ç å—é‡Œæˆ‘ä»¬åˆ›å»ºäº†UriMatcherçš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨<code>addURI()</code>æ–¹æ³•ï¼Œå°†æœŸæœ›åŒ¹é…çš„å†…å®¹URIæ ¼å¼ä¼ é€’è¿›å»ï¼Œæ³¨æ„è¿™é‡Œä¼ å…¥çš„è·¯å¾„å‚æ•°æ˜¯å¯ä»¥ä½¿ç”¨é€šé…ç¬¦çš„ã€‚ç„¶åå½“<code>query()</code>æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå°±ä¼šé€šè¿‡UriMatcherçš„<code>match()</code>æ–¹æ³•å¯¹ä¼ å…¥çš„Uriå¯¹è±¡è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœå‘ç°UriMatcherä¸­æŸä¸ªå†…å®¹URIæ ¼å¼æˆåŠŸåŒ¹é…äº†è¯¥Uriå¯¹è±¡ï¼Œåˆ™ä¼šè¿”å›ç›¸åº”çš„è‡ªå®šä¹‰ä»£ç ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­å‡ºè°ƒç”¨æ–¹æœŸæœ›è®¿é—®çš„åˆ°åº•æ˜¯ä»€ä¹ˆæ•°æ®äº†ã€‚</p><p>ä¸Šè¿°ä»£ç åªæ˜¯ä»¥query()æ–¹æ³•ä¸ºä¾‹åšäº†ä¸ªç¤ºèŒƒï¼Œå…¶å®insert()ã€update()ã€delete()è¿™å‡ ä¸ªæ–¹æ³•çš„å®ç°ä¹Ÿæ˜¯å·®ä¸å¤šçš„ï¼Œå®ƒä»¬éƒ½ä¼šæºå¸¦Uriè¿™ä¸ªå‚æ•°ï¼Œç„¶ååŒæ ·åˆ©ç”¨UriMatcherçš„match()æ–¹æ³•åˆ¤æ–­å‡ºè°ƒç”¨æ–¹æœŸæœ›è®¿é—®çš„æ˜¯å“ªå¼ è¡¨ï¼Œå†å¯¹è¯¥è¡¨ä¸­çš„æ•°æ®è¿›è¡Œç›¸åº”çš„æ“ä½œå°±å¯ä»¥äº†ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•æˆ‘ä»¬ä¼šæ¯”è¾ƒé™Œç”Ÿï¼Œå³getType()æ–¹æ³•ã€‚å®ƒæ˜¯æ‰€æœ‰çš„å†…å®¹æä¾›å™¨éƒ½å¿…é¡»æä¾›çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºè·å–Uriå¯¹è±¡æ‰€å¯¹åº”çš„MIMEç±»å‹ã€‚ä¸€ä¸ªå†…å®¹URIæ‰€å¯¹åº”çš„MIMEå­—ç¬¦ä¸²ä¸»è¦ç”±3éƒ¨åˆ†ç»„æˆï¼ŒAndroidå¯¹è¿™3ä¸ªéƒ¨åˆ†åšäº†å¦‚ä¸‹æ ¼å¼è§„å®šï¼š</p><ul><li>å¿…é¡»ä»¥<code>vnd</code>å¼€å¤´ã€‚</li><li>å¦‚æœå†…å®¹URIä»¥è·¯å¾„ç»“å°¾ï¼Œåˆ™åæ¥ <code>android.cursor.dir/</code>ï¼Œå¦‚æœå†…å®¹URIä»¥idç»“å°¾ï¼Œåˆ™åæ¥<code> android.cursor.item/</code> ã€‚</li><li>æœ€åæ¥ä¸Š<code>vnd.&lt;authority&gt;.&lt;path&gt;</code>ã€‚</li></ul><p>æ‰€ä»¥ï¼Œå¯¹äºcontent:&#x2F;&#x2F;com.example.app.provider&#x2F;table1è¿™ä¸ªå†…å®¹URIï¼Œå®ƒæ‰€å¯¹åº”çš„MIMEç±»å‹å°±å¯ä»¥å†™æˆï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">vnd<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.cursor</span>.dir/vnd<span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.provider</span>.table1<br></code></pre></td></tr></table></figure><p>å¯¹äºcontent:&#x2F;&#x2F;com.example.app.provider&#x2F;table1&#x2F;1è¿™ä¸ªå†…å®¹URIï¼Œå®ƒæ‰€å¯¹åº”çš„MMEç±»å‹å°±å¯ä»¥å†™æˆï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">vnd<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.cursor</span>.item/vnd<span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.provider</span>.tablel<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»§ç»­å®Œå–„MyContentProviderä¸­çš„å†…å®¹äº†ï¼Œè¿™æ¬¡æ¥å®ç°<code>getType()</code>æ–¹æ³•ä¸­çš„é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContentProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContentProvider</span> &#123;<br><br>    ......<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (uriMatcher.match(uri))&#123;<br>            <span class="hljs-keyword">case</span> TABLE1_DIR:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vnd.android.cursor.dir/vnd.com.example.app.provider.table1&quot;</span>;<br>            <span class="hljs-keyword">case</span> TABLE1_ITEM:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vnd.android.cursor.item/vnd.com.example.app.provider.table1&quot;</span>;<br>            <span class="hljs-keyword">case</span> TABLE2_DIR:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vnd.android.cursor.dir/vnd.com.example.app.provider.table2&quot;</span>;<br>            <span class="hljs-keyword">case</span> TABLE2_ITEM:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vnd.android.cursor.item/vnd.com.example.app.provider.table2&quot;</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>......<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œä¸€ä¸ªå®Œæ•´çš„å†…å®¹æä¾›å™¨å°±åˆ›å»ºå®Œæˆäº†ï¼Œç°åœ¨ä»»ä½•ä¸€ä¸ªåº”ç”¨ç¨‹åºéƒ½å¯ä»¥ä½¿ç”¨ContentResolveræ¥è®¿é—®æˆ‘ä»¬ç¨‹åºä¸­çš„æ•°æ®ã€‚è‡³äºå‰é¢æ‰€æåˆ°çš„ä¿è¯éšç§æ•°æ®å®‰å…¨çš„åŠŸèƒ½ï¼Œå› ä¸ºæ‰€æœ‰çš„CRUDæ“ä½œéƒ½ä¸€å®šè¦åŒ¹é…åˆ°ç›¸åº”çš„å†…å®¹URIæ ¼å¼æ‰èƒ½è¿›è¡Œçš„ï¼Œè€Œæˆ‘ä»¬å½“ç„¶ä¸å¯èƒ½å‘UriMatcherä¸­æ·»åŠ éšç§æ•°æ®çš„URIï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†æ•°æ®æ ¹æœ¬æ— æ³•è¢«å¤–éƒ¨ç¨‹åºè®¿é—®åˆ°ï¼Œå®‰å…¨é—®é¢˜ä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ¥å®æˆ˜ä¸€ä¸‹ï¼ŒçœŸæ­£ä½“éªŒä¸€ä¸‹è·¨ç¨‹åºæ•°æ®å…±äº«çš„åŠŸèƒ½ã€‚</p><h2 id="4-2-å®ç°è·¨ç¨‹åºæ•°æ®å…±äº«"><a href="#4-2-å®ç°è·¨ç¨‹åºæ•°æ®å…±äº«" class="headerlink" title="4.2 å®ç°è·¨ç¨‹åºæ•°æ®å…±äº«"></a>4.2 å®ç°è·¨ç¨‹åºæ•°æ®å…±äº«</h2><p>ä¸ºäº†çªå‡ºé‡ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ä¸Šä¸€ç« ä¸­SQLiteæ•°æ®åº“å­˜å‚¨çš„é¡¹ç›®çš„åŸºç¡€ä¸Šç»§ç»­å¼€å‘ï¼Œé€šè¿‡å†…å®¹æä¾›å™¨æ¥ç»™å®ƒåŠ å…¥å¤–éƒ¨è®¿é—®æ¥å£ã€‚ä¸ºæ­¤æˆ‘ä»¬éœ€è¦ç»™é¡¹ç›®åˆ›å»ºä¸€ä¸ªå†…å®¹æä¾›å™¨ï¼Œå³å‡»åŒ…åâ†’Newâ†’Otherâ†’Content Providerï¼Œåœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼Œæˆ‘ä»¬å°†å†…å®¹æä¾›å™¨å‘½åä¸º<code>DatabaseProvider</code>ï¼ŒauthorityæŒ‡å®šä¸º<code>com.example.databasetest.provider</code>ï¼Œ<code>Exported</code>å±æ€§è¡¨ç¤ºæ˜¯å¦å…è®¸å¤–éƒ¨ç¨‹åºè®¿é—®æˆ‘ä»¬çš„å†…å®¹æä¾›å™¨ï¼Œ<code>Enabled</code>å±æ€§è¡¨ç¤ºæ˜¯å¦å¯ç”¨è¿™ä¸ªå†…å®¹æä¾›å™¨ã€‚å°†ä¸¤ä¸ªå±æ€§éƒ½å‹¾ä¸­ï¼Œç‚¹å‡»Finishå®Œæˆåˆ›å»ºã€‚</p><p>æ¥ç€æˆ‘ä»¬ä¿®æ”¹DatabaseProviderä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContentProvider</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BOOK_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BOOK_ITEM</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CATEGORY_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CATEGORY_ITEM</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUTHORITY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.example.databasetest.provider&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UriMatcher uriMatcher;<br>    <span class="hljs-keyword">private</span> MyDatabaseHelper dbHelper;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        uriMatcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UriMatcher</span>(UriMatcher.NO_MATCH);<br>        uriMatcher.addURI(AUTHORITY,<span class="hljs-string">&quot;book&quot;</span>,BOOK_DIR);<br>        uriMatcher.addURI(AUTHORITY,<span class="hljs-string">&quot;book/#&quot;</span>,BOOK_ITEM);<br>        uriMatcher.addURI(AUTHORITY,<span class="hljs-string">&quot;category&quot;</span>,CATEGORY_DIR);<br>        uriMatcher.addURI(AUTHORITY,<span class="hljs-string">&quot;category/#&quot;</span>,CATEGORY_ITEM);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseProvider</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        dbHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDatabaseHelper</span>(getContext(),<span class="hljs-string">&quot;BookStore.db&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Cursor <span class="hljs-title function_">query</span><span class="hljs-params">(Uri uri, String[] projection, String selection,</span><br><span class="hljs-params">                        String[] selectionArgs, String sortOrder)</span> &#123;<br>        <span class="hljs-type">SQLiteDatabase</span> <span class="hljs-variable">db</span> <span class="hljs-operator">=</span> dbHelper.getReadableDatabase();<br>        <span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">switch</span> (uriMatcher.match(uri))&#123;<br>            <span class="hljs-keyword">case</span> BOOK_DIR:<br>                cursor = db.query(<span class="hljs-string">&quot;Book&quot;</span>,projection,selection,selectionArgs,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>,sortOrder);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> BOOK_ITEM:<br>                <span class="hljs-type">String</span> <span class="hljs-variable">bookId</span> <span class="hljs-operator">=</span> uri.getPathSegments().get(<span class="hljs-number">1</span>);<br>                cursor = db.query(<span class="hljs-string">&quot;Book&quot;</span>,projection,<span class="hljs-string">&quot;id = ?&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;bookId&#125;,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>,sortOrder);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_DIR:<br>                cursor = db.query(<span class="hljs-string">&quot;Category&quot;</span>,projection,selection,selectionArgs,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>,sortOrder);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_ITEM:<br>                <span class="hljs-type">String</span> <span class="hljs-variable">categoryId</span> <span class="hljs-operator">=</span> uri.getPathSegments().get(<span class="hljs-number">1</span>);<br>                cursor = db.query(<span class="hljs-string">&quot;Category&quot;</span>,projection,<span class="hljs-string">&quot;id = ?&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;categoryId&#125;,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>,sortOrder);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> cursor;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Uri <span class="hljs-title function_">insert</span><span class="hljs-params">(Uri uri, ContentValues values)</span> &#123;<br>        <span class="hljs-type">SQLiteDatabase</span> <span class="hljs-variable">db</span> <span class="hljs-operator">=</span> dbHelper.getWritableDatabase();<br>        <span class="hljs-type">Uri</span> <span class="hljs-variable">uriReturn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">switch</span> (uriMatcher.match(uri))&#123;<br>            <span class="hljs-keyword">case</span> BOOK_DIR:<br>            <span class="hljs-keyword">case</span> BOOK_ITEM:<br>                <span class="hljs-type">long</span> <span class="hljs-variable">newBookId</span> <span class="hljs-operator">=</span> db.insert(<span class="hljs-string">&quot;Book&quot;</span>,<span class="hljs-literal">null</span>,values);<br>                uriReturn = Uri.parse(<span class="hljs-string">&quot;content://&quot;</span> + AUTHORITY + <span class="hljs-string">&quot;/book/&quot;</span> + newBookId);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_DIR:<br>            <span class="hljs-keyword">case</span> CATEGORY_ITEM:<br>                <span class="hljs-type">long</span> <span class="hljs-variable">newCategoryId</span> <span class="hljs-operator">=</span> db.insert(<span class="hljs-string">&quot;Category&quot;</span>,<span class="hljs-literal">null</span>,values);<br>                uriReturn = Uri.parse(<span class="hljs-string">&quot;content://&quot;</span> + AUTHORITY + <span class="hljs-string">&quot;/Category/&quot;</span> + newCategoryId);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> uriReturn;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Uri uri, ContentValues values, String selection,</span><br><span class="hljs-params">                      String[] selectionArgs)</span> &#123;<br>        <span class="hljs-type">SQLiteDatabase</span> <span class="hljs-variable">db</span> <span class="hljs-operator">=</span> dbHelper.getWritableDatabase();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">updatedRows</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">switch</span> (uriMatcher.match(uri))&#123;<br>            <span class="hljs-keyword">case</span> BOOK_DIR:<br>                updatedRows = db.update(<span class="hljs-string">&quot;Book&quot;</span>,values,selection,selectionArgs);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> BOOK_ITEM:<br>                <span class="hljs-type">String</span> <span class="hljs-variable">bookId</span> <span class="hljs-operator">=</span> uri.getPathSegments().get(<span class="hljs-number">1</span>);<br>                updatedRows = db.update(<span class="hljs-string">&quot;Book&quot;</span>,values,selection,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;bookId&#125;);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_DIR:<br>                updatedRows = db.update(<span class="hljs-string">&quot;Category&quot;</span>,values,selection,selectionArgs);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_ITEM:<br>                <span class="hljs-type">String</span> <span class="hljs-variable">categoryId</span> <span class="hljs-operator">=</span> uri.getPathSegments().get(<span class="hljs-number">1</span>);<br>                updatedRows = db.update(<span class="hljs-string">&quot;Category&quot;</span>,values,selection,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;categoryId&#125;);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> updatedRows;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Uri uri, String selection, String[] selectionArgs)</span> &#123;<br>        <span class="hljs-type">SQLiteDatabase</span> <span class="hljs-variable">db</span> <span class="hljs-operator">=</span> dbHelper.getWritableDatabase();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">deletedRows</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">switch</span> (uriMatcher.match(uri))&#123;<br>            <span class="hljs-keyword">case</span> BOOK_DIR:<br>                deletedRows = db.delete(<span class="hljs-string">&quot;Book&quot;</span>,selection,selectionArgs);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> BOOK_ITEM:<br>                <span class="hljs-type">String</span> <span class="hljs-variable">bookId</span> <span class="hljs-operator">=</span> uri.getPathSegments().get(<span class="hljs-number">1</span>);<br>                deletedRows = db.delete(<span class="hljs-string">&quot;Book&quot;</span>,<span class="hljs-string">&quot;id = ?&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;bookId&#125;);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_DIR:<br>                deletedRows = db.delete(<span class="hljs-string">&quot;Category&quot;</span>,selection,selectionArgs);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_ITEM:<br>                <span class="hljs-type">String</span> <span class="hljs-variable">categoryId</span> <span class="hljs-operator">=</span> uri.getPathSegments().get(<span class="hljs-number">1</span>);<br>                deletedRows = db.delete(<span class="hljs-string">&quot;Category&quot;</span>,<span class="hljs-string">&quot;id = ?&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;categoryId&#125;);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> deletedRows;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(Uri uri)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (uriMatcher.match(uri))&#123;<br>            <span class="hljs-keyword">case</span> BOOK_DIR:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vnd.android.cursor.dir/vnd.com.example.databasetest.provider.book&quot;</span>;<br>            <span class="hljs-keyword">case</span> BOOK_ITEM:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vnd.android.cursor.item/vnd.com.example.databasetest.provider.book&quot;</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_DIR:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vnd.android.cursor.dir/vnd.com.example.databasetest.provider.category&quot;</span>;<br>            <span class="hljs-keyword">case</span> CATEGORY_ITEM:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vnd.android.cursor.item/vnd.com.example.databasetest.provider.category&quot;</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨ç±»çš„ä¸€å¼€å§‹ï¼ŒåŒæ ·æ˜¯å®šä¹‰äº†4ä¸ªå¸¸é‡ï¼Œåˆ†åˆ«ç”¨äºè¡¨ç¤ºè®¿é—®Bookè¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ã€è®¿é—®Bookè¡¨ä¸­çš„å•æ¡æ•°æ®ã€è®¿é—®Categoryè¡¨ä¸­çš„æ‰€æœ‰æ•°æ®å’Œè®¿é—®Categoryè¡¨ä¸­çš„å•æ¡æ•°æ®ã€‚ç„¶ååœ¨é™æ€ä»£ç å—é‡Œå¯¹UriMatcherè¿›è¡Œäº†åˆå§‹åŒ–æ“ä½œï¼Œå°†æœŸæœ›åŒ¹é…çš„å‡ ç§URIæ ¼å¼æ·»åŠ äº†è¿›å»ã€‚</p><p>å› ä¸ºæˆ‘ä»¬è¿™é‡Œæ˜¯å¯¹å¤–éƒ¨åº”ç”¨æä¾›è®¿é—®è¯¥åº”ç”¨æ•°æ®çš„æ¥å£ï¼Œè€Œæ•°æ®çš„æ¥æºæ˜¯æ•°æ®åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆåœ¨onCreate()æ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªMyDatabaseHelperå®ä¾‹ï¼Œè¿”å›trueè¡¨ç¤ºå†…å®¹æä¾›å™¨åˆå§‹åŒ–æˆåŠŸï¼Œè¿™æ—¶æ•°æ®åº“å°±å·²ç»å®Œæˆäº†åˆ›å»ºæˆ–å‡çº§æ“ä½œã€‚</p><p>æ¥ä¸‹æ¥æ˜¯CRUDæ“ä½œçš„æ–¹æ³•ï¼Œæ ¼å¼éƒ½å·®ä¸å¤šï¼Œéƒ½æ˜¯å…ˆæ ¹æ®æ“ä½œè·å–è¯»&#x2F;å†™çš„æ•°æ®åº“å®ä¾‹ï¼Œç„¶åæ ¹æ®Uriåˆ¤æ–­ç”¨æˆ·è®¿é—®å“ªå¼ è¡¨ä»¥åŠæ˜¯å…¨è¡¨æ•°æ®è¿˜æ˜¯å•æ¡æ•°æ®ã€‚æ³¨æ„å½“è®¿é—®å•æ¡æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨äº†Uriå¯¹è±¡çš„<code>getPathSegments()</code>æ–¹æ³•ï¼Œå®ƒä¼šå°†å†…å®¹URIæƒé™ä¹‹åçš„éƒ¨åˆ†ä»¥ â€œ&#x2F;â€ ç¬¦å·è¿›è¡Œåˆ†å‰²ï¼Œå¹¶æŠŠåˆ†å‰²åçš„ç»“æœæ”¾å…¥åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ä¸­ï¼Œé‚£è¿™ä¸ªåˆ—è¡¨çš„ç¬¬0ä¸ªä½ç½®å­˜æ”¾çš„å°±æ˜¯è·¯å¾„ï¼Œç¬¬1ä¸ªä½ç½®å­˜æ”¾çš„å°±æ˜¯idäº†ã€‚å¾—åˆ°äº†idä¹‹åï¼Œå†é€šè¿‡selectionå’ŒselectionArgså‚æ•°è¿›è¡Œçº¦æŸï¼Œå°±å®ç°äº†æŸ¥è¯¢å•æ¡æ•°æ®çš„åŠŸèƒ½ã€‚å››ç§æ–¹æ³•çš„å…·ä½“å·®å¼‚å¦‚ä¸‹ï¼š</p><ul><li><strong>query()æ–¹æ³•</strong>ï¼šå› ä¸ºæ˜¯è®¿é—®æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦å°†æŸ¥è¯¢åˆ°çš„æ•°æ®ä»¥Cursorå¯¹è±¡è¿”å›ã€‚</li><li><strong>insert()æ–¹æ³•</strong>ï¼šéœ€è¦è¿”å›ä¸€ä¸ªèƒ½å¤Ÿè¡¨ç¤ºè¿™æ¡æ–°å¢æ•°æ®çš„URIï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨<code>Uri.parse()</code>æ–¹æ³•æ¥å°†ä¸€ä¸ªå†…å®¹URIè§£ææˆUriå¯¹è±¡ï¼Œå½“ç„¶è¿™ä¸ªå†…å®¹URIæ˜¯ä»¥æ–°å¢æ•°æ®çš„idç»“å°¾çš„ã€‚</li><li><strong>update()æ–¹æ³•</strong>ï¼šéœ€è¦è¿”å›å—å½±å“çš„è¡Œæ•°ã€‚</li><li><strong>delete()æ–¹æ³•</strong>ï¼šéœ€è¦è¿”å›å—å½±å“çš„è¡Œæ•°ã€‚</li></ul><p>æœ€åæ˜¯getType()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­çš„ä»£ç å®Œå…¨æ˜¯æŒ‰ç…§ä¸Šä¸€èŠ‚ä¸­ä»‹ç»çš„æ ¼å¼è§„åˆ™ç¼–å†™çš„ï¼Œæ²¡æœ‰å¿…è¦å†è§£é‡Šäº†ã€‚</p><p>åˆ°æ­¤ï¼Œæˆ‘ä»¬å°±å°†å†…å®¹æä¾›å™¨ä¸­çš„ä»£ç å…¨éƒ¨ç¼–å†™å®Œäº†ã€‚</p><p>å¦å¤–è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå†…å®¹æä¾›å™¨ä¸€å®šè¦åœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­æ³¨å†Œæ‰å¯ä»¥ä½¿ç”¨ã€‚ä¸è¿‡ç”±äºæˆ‘ä»¬æ˜¯ä½¿ç”¨Android Studioçš„å¿«æ·æ–¹å¼åˆ›å»ºçš„å†…å®¹æä¾›å™¨ï¼Œå› æ­¤æ³¨å†Œè¿™ä¸€æ­¥å·²ç»è¢«è‡ªåŠ¨å®Œæˆäº†ã€‚å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">application</span></span><br><span class="hljs-tag">        <span class="hljs-attr">......</span></span><br><span class="hljs-tag">        &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">provider</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.DatabaseProvider&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">&quot;com.example.databasetest.provider&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:enabled</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span><br><br>        ......<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>&lt;application&gt;</code>æ ‡ç­¾å†…å‡ºç°äº†ä¸€ä¸ªæ–°çš„æ ‡ç­¾<code>&lt;provider&gt;</code>ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥å¯¹DatabaseProviderè¿™ä¸ªå†…å®¹æä¾›å™¨è¿›è¡Œæ³¨å†Œã€‚<code>android:name</code>å±æ€§æŒ‡å®šäº†DatabaseProviderçš„ç±»åï¼Œ<code>android:authorities</code>å±æ€§æŒ‡å®šäº†DatabaseProviderçš„authorityï¼Œè€Œ<code>enabled</code>å’Œ<code>exported</code>å±æ€§åˆ™æ˜¯æ ¹æ®æˆ‘ä»¬åˆšæ‰å‹¾é€‰çš„çŠ¶æ€è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œè¿™é‡Œè¡¨ç¤ºå…è®¸DatabaseProviderè¢«å…¶ä»–åº”ç”¨ç¨‹åºè¿›è¡Œè®¿é—®ã€‚</p><p>ç°åœ¨è¿™ä¸ªé¡¹ç›®å°±å·²ç»æ‹¥æœ‰äº†è·¨ç¨‹åºå…±äº«æ•°æ®çš„åŠŸèƒ½äº†ã€‚ä¸ºäº†éªŒè¯ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å¦å¤–åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ProviderTestæ¥è®¿é—®åˆšæ‰ç¼–å†™å¥½çš„é¡¹ç›®ä¸­çš„æ•°æ®ã€‚</p><p>æ–°é¡¹ç›®ProviderTestå¸ƒå±€æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Add To Book&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;AddToBook&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Query From Book&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;QueryFromBook&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Update Book&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;UpdateBook&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Delete From Book&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;DeleteFromBook&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç®€ç®€å•å•çš„4ä¸ªæŒ‰é’®ï¼Œåˆ†åˆ«ç”¨äºæ·»åŠ ã€æŸ¥è¯¢ã€ä¿®æ”¹å’Œåˆ é™¤æ•°æ®ã€‚ç„¶åä¿®æ”¹MainActivityä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String newId;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">AddToBook</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">&quot;content://com.example.databasetest.provider/book&quot;</span>);<br>        <span class="hljs-type">ContentValues</span> <span class="hljs-variable">values</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();<br>        values.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;A Clash of Kings&quot;</span>);<br>        values.put(<span class="hljs-string">&quot;author&quot;</span>,<span class="hljs-string">&quot;George Martin&quot;</span>);<br>        values.put(<span class="hljs-string">&quot;pages&quot;</span>,<span class="hljs-number">1024</span>);<br>        values.put(<span class="hljs-string">&quot;price&quot;</span>,<span class="hljs-number">22.45</span>);<br>        <span class="hljs-type">Uri</span> <span class="hljs-variable">newUri</span> <span class="hljs-operator">=</span> getContentResolver().insert(uri,values);<br>        newId = newUri.getPathSegments().get(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">UpdateBook</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">&quot;content://com.example.databasetest.provider/book&quot;</span> + newId);<br>        <span class="hljs-type">ContentValues</span> <span class="hljs-variable">values</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();<br>        values.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;A Storm of Swords&quot;</span>);<br>        getContentResolver().update(uri,values,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">QueryFromBook</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">&quot;content://com.example.databasetest.provider/book&quot;</span>);<br>        <span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> getContentResolver().query(uri, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> (cursor != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">while</span> (cursor.moveToNext())&#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(<span class="hljs-string">&quot;name&quot;</span>));<br>                <span class="hljs-type">String</span> <span class="hljs-variable">author</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(<span class="hljs-string">&quot;author&quot;</span>));<br>                <span class="hljs-type">int</span> <span class="hljs-variable">pages</span> <span class="hljs-operator">=</span> cursor.getInt(cursor.getColumnIndex(<span class="hljs-string">&quot;pages&quot;</span>));<br>                <span class="hljs-type">double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> cursor.getDouble(cursor.getColumnIndex(<span class="hljs-string">&quot;price&quot;</span>));<br>                Log.d(<span class="hljs-string">&quot;MainActivity&quot;</span>, <span class="hljs-string">&quot;name: &quot;</span> + name);<br>                Log.d(<span class="hljs-string">&quot;MainActivity&quot;</span>, <span class="hljs-string">&quot;author: &quot;</span> + author);<br>                Log.d(<span class="hljs-string">&quot;MainActivity&quot;</span>, <span class="hljs-string">&quot;pages: &quot;</span> + pages);<br>                Log.d(<span class="hljs-string">&quot;MainActivity&quot;</span>, <span class="hljs-string">&quot;price: &quot;</span> + price);<br>            &#125;<br>            cursor.close();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">DeleteFromBook</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">&quot;content://com.example.databasetest.provider/book&quot;</span> + newId);<br>        getContentResolver().delete(uri, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨è¿™4ä¸ªæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶é‡Œé¢å¤„ç†äº†å¢åˆ æ”¹æŸ¥çš„é€»è¾‘ï¼Œåˆ†åˆ«å¯¹æ¥ContentProviderä¸­çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•ã€‚</p><p>æ·»åŠ æ•°æ®çš„æ—¶å€™ï¼Œé¦–å…ˆè°ƒç”¨äº†<code>Uri.parse()</code>æ–¹æ³•å°†ä¸€ä¸ªå†…å®¹URIè§£ææˆUriå¯¹è±¡ï¼Œç„¶åæŠŠè¦æ·»åŠ çš„æ•°æ®éƒ½å­˜æ”¾åˆ°ContentValueså¯¹è±¡ä¸­ï¼Œæ¥ç€è°ƒç”¨ContentResolverçš„<code>insert()</code>æ–¹æ³•æ‰§è¡Œæ·»åŠ æ“ä½œå°±å¯ä»¥äº†ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªUriå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­åŒ…å«äº†æ–°å¢æ•°æ®çš„idï¼Œæˆ‘ä»¬é€šè¿‡getPathSegments()æ–¹æ³•å°†è¿™ä¸ªidå–å‡ºã€‚</p><p>æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼ŒåŒæ ·æ˜¯è°ƒç”¨äº†<code>Uri.parse()</code>æ–¹æ³•å°†ä¸€ä¸ªå†…å®¹URIè§£ææˆUriå¯¹è±¡ï¼Œç„¶åè°ƒç”¨ContentResolverçš„<code>query()</code>æ–¹æ³•å»æŸ¥è¯¢æ•°æ®ï¼ŒæŸ¥è¯¢çš„ç»“æœå­˜æ”¾åœ¨Cursorå¯¹è±¡ä¸­çš„ã€‚ä¹‹åå¯¹Cursorè¿›è¡Œéå†ï¼Œä»ä¸­å–å‡ºæŸ¥è¯¢ç»“æœï¼Œå¹¶ä¸€ä¸€æ‰“å°å‡ºæ¥ã€‚</p><p>æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å…ˆå°†å†…å®¹URIè§£ææˆUriå¯¹è±¡ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡å®šäº†idï¼Œé‚£ä¹ˆè¡¨ä¸­å…¶ä»–æ•°æ®å°±ä¸ä¼šå—å½±å“äº†ã€‚ç„¶åæŠŠæƒ³è¦æ›´æ–°çš„æ•°æ®å­˜æ”¾åˆ°ContentValueså¯¹è±¡ä¸­ï¼Œå†è°ƒç”¨ContentResolverçš„<code>update()</code>æ–¹æ³•æ‰§è¡Œæ›´æ–°æ“ä½œå°±å¯ä»¥äº†ã€‚</p><p>åˆ é™¤æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä½¿ç”¨åŒæ ·çš„æ–¹æ³•è§£æäº†ä¸€ä¸ªä»¥idç»“å°¾çš„å†…å®¹URIï¼Œç„¶åè°ƒç”¨ContentResolverçš„<code>delete()</code>æ–¹æ³•æ‰§è¡Œåˆ é™¤æ“ä½œå°±å¯ä»¥äº†ã€‚</p><p>åˆ°æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è¯•è¿è¡Œç¨‹åºäº†ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå¼€å‘å­¦ä¹ ç¬”è®°(ä¸ƒ) â€”â€” è¯¦è§£æ•°æ®å­˜å‚¨å…¨æ–¹æ¡ˆ</title>
    <link href="/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%B8%83)%20%E2%80%94%E2%80%94%20%E8%AF%A6%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%85%A8%E6%96%B9%E6%A1%88/"/>
    <url>/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%B8%83)%20%E2%80%94%E2%80%94%20%E8%AF%A6%E8%A7%A3%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%85%A8%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯æ•°æ®æŒä¹…åŒ–"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯æ•°æ®æŒä¹…åŒ–" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯æ•°æ®æŒä¹…åŒ–"></a>ä¸€ã€ä»€ä¹ˆæ˜¯æ•°æ®æŒä¹…åŒ–</h1><p>æ•°æ®æŒä¹…åŒ–å°±æ˜¯æŒ‡å°†é‚£äº›å†…å­˜ä¸­çš„ç¬æ—¶æ•°æ®ä¿å­˜åˆ°å­˜å‚¨è®¾å¤‡ä¸­ï¼Œä¿è¯å³ä½¿åœ¨æ‰‹æœºæˆ–ç”µè„‘å…³æœºçš„æƒ…å†µä¸‹ï¼Œè¿™äº›æ•°æ®ä»ç„¶ä¸ä¼šä¸¢å¤±ã€‚ä¿å­˜åœ¨å†…å­˜ä¸­çš„æ•°æ®æ˜¯å¤„äºç¬æ—¶çŠ¶æ€çš„ï¼Œè€Œä¿å­˜åœ¨å­˜å‚¨è®¾å¤‡ä¸­çš„æ•°æ®æ˜¯å¤„äºæŒä¹…çŠ¶æ€çš„ï¼ŒæŒä¹…åŒ–æŠ€æœ¯åˆ™æä¾›äº†ä¸€ç§æœºåˆ¶å¯ä»¥è®©æ•°æ®åœ¨ç¬æ—¶çŠ¶æ€å’ŒæŒä¹…çŠ¶æ€ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚<br>Androidç³»ç»Ÿä¸­ä¸»è¦æä¾›äº†3ç§æ–¹å¼ç”¨äºç®€å•åœ°å®ç°æ•°æ®æŒä¹…åŒ–åŠŸèƒ½ï¼Œå³æ–‡ä»¶å­˜å‚¨ã€SharedPreferenceå­˜å‚¨ä»¥åŠæ•°æ®åº“å­˜å‚¨ã€‚</p><h1 id="äºŒã€æ–‡ä»¶å­˜å‚¨"><a href="#äºŒã€æ–‡ä»¶å­˜å‚¨" class="headerlink" title="äºŒã€æ–‡ä»¶å­˜å‚¨"></a>äºŒã€æ–‡ä»¶å­˜å‚¨</h1><h2 id="2-1-æ¦‚å¿µ"><a href="#2-1-æ¦‚å¿µ" class="headerlink" title="2.1 æ¦‚å¿µ"></a>2.1 æ¦‚å¿µ</h2><p>æ–‡ä»¶å­˜å‚¨æ˜¯Androidä¸­æœ€åŸºæœ¬çš„ä¸€ç§æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œå®ƒä¸å¯¹å­˜å‚¨çš„å†…å®¹è¿›è¡Œä»»ä½•çš„æ ¼å¼åŒ–å¤„ç†ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯åŸå°ä¸åŠ¨åœ°ä¿å­˜åˆ°æ–‡ä»¶å½“ä¸­çš„ï¼Œå› è€Œå®ƒæ¯”è¾ƒé€‚åˆç”¨äºå­˜å‚¨ä¸€äº›ç®€å•çš„æ–‡æœ¬æ•°æ®æˆ–äºŒè¿›åˆ¶æ•°æ®ã€‚</p><h2 id="2-2-å°†æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶ä¸­"><a href="#2-2-å°†æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶ä¸­" class="headerlink" title="2.2 å°†æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶ä¸­"></a>2.2 å°†æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶ä¸­</h2><p>Contextç±»ä¸­æä¾›äº†ä¸€ä¸ª<code>openFileOutput()</code>æ–¹æ³•ï¼Œå¯ä»¥ç”¨äºå°†æ•°æ®å­˜å‚¨åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶åï¼Œè¿™é‡ŒæŒ‡å®šçš„æ–‡ä»¶åä¸å¯ä»¥åŒ…å«è·¯å¾„ï¼Œå› ä¸ºæ‰€æœ‰çš„æ–‡ä»¶éƒ½æ˜¯é»˜è®¤å­˜å‚¨åˆ°<code>/data/data/&lt;package name&gt;/fles/</code>ç›®å½•ä¸‹çš„ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ–‡ä»¶çš„æ“ä½œæ¨¡å¼ï¼Œä¸»è¦æœ‰ä¸¤ç§æ¨¡å¼å¯é€‰ï¼š</p><ul><li><code>MODE_PRIVATE</code>ï¼šé»˜è®¤æ“ä½œæ¨¡å¼ï¼Œè¡¨ç¤ºå½“æŒ‡å®šåŒæ ·æ–‡ä»¶åçš„æ—¶å€™ï¼Œæ‰€å†™å…¥çš„å†…å®¹å°†ä¼šè¦†ç›–åŸæ–‡ä»¶ä¸­çš„å†…å®¹ã€‚</li><li><code>MODE_APPEND</code>ï¼šè¡¨ç¤ºå¦‚æœè¯¥æ–‡ä»¶å·²å­˜åœ¨ï¼Œå°±å¾€æ–‡ä»¶é‡Œé¢è¿½åŠ å†…å®¹ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºæ–°æ–‡ä»¶ã€‚</li><li><code>MODE WORLD READABLE</code>å’Œ<code>MODE WORLD WRITEABLE</code>ï¼šè¿™ä¸¤ç§æ¨¡å¼è¡¨ç¤ºå…è®¸å…¶ä»–çš„åº”ç”¨ç¨‹åºå¯¹æˆ‘ä»¬ç¨‹åºä¸­çš„æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œï¼Œä¸è¿‡ç”±äºè¿™ä¸¤ç§æ¨¡å¼è¿‡äºå±é™©ï¼Œå¾ˆå®¹æ˜“å¼•èµ·åº”ç”¨çš„å®‰å…¨æ€§æ¼æ´ï¼Œå·²åœ¨Android4.2ç‰ˆæœ¬ä¸­è¢«åºŸå¼ƒã€‚</li></ul><p>å®ç°å°æ¡ˆä¾‹ï¼šæ´»åŠ¨é”€æ¯æ—¶ï¼Œå°†è¾“å…¥æ¡†ä¸­çš„æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ã€‚</p><p>é¦–å…ˆä¸»æ´»åŠ¨çš„å¸ƒå±€ï¼Œä¸€ä¸ªè¾“å…¥æ¡†å³å¯ã€‚åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥çš„æ•°æ®åªæ˜¯ç¬æ—¶æ•°æ®ï¼Œåœ¨æ´»åŠ¨è¢«é”€æ¯åå°±ä¼šè¢«å›æ”¶ã€‚æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨æ•°æ®è¢«å›æ”¶ä¹‹å‰ï¼Œå°†å®ƒå­˜å‚¨åˆ°æ–‡ä»¶å½“ä¸­ã€‚</p><p>ä¿®æ”¹ MainActivity ä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> EditText edittext;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">FileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;account&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        initView();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> edittext.getText().toString();<br>        saveData(s);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initView</span><span class="hljs-params">()</span> &#123;<br>        edittext = findViewById(R.id.id_edittext);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveData</span><span class="hljs-params">(String string)</span>&#123;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            out = openFileOutput(FileName, Context.MODE_PRIVATE);<br>            writer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(out));<br>            writer.write(string);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (writer != <span class="hljs-literal">null</span>)&#123;<br>                    writer.close();<br>                &#125;<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><code>saveData()</code>æ–¹æ³•ä¸»è¦æ˜¯æ–‡ä»¶æµå†™å…¥çš„åŸºæœ¬æ“ä½œï¼Œç„¶åé‡å†™äº†<code>onDestroy()</code>æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯åœ¨æ´»åŠ¨é”€æ¯ä¹‹å‰ä¸€å®šä¼šè°ƒç”¨<code>saveData()</code>æ–¹æ³•ã€‚</p><p>ç„¶åå…³é—­ç¨‹åºï¼Œè¿™æ—¶æˆ‘ä»¬è¾“å…¥çš„å†…å®¹å°±å·²ç»ä¿å­˜åˆ°æ–‡ä»¶ä¸­äº†ã€‚é‚£ä¹ˆå¦‚ä½•æ‰èƒ½è¯å®æ•°æ®ç¡®å®å·²ç»ä¿å­˜æˆåŠŸäº†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å€ŸåŠ©<code>Device File Explorer</code>å·¥å…·æ¥æŸ¥çœ‹ä¸€ä¸‹ã€‚ç‚¹å‡»Android Studioå¯¼èˆªæ ä¸­çš„Tools â†’Tool Windows â†’Device File Explorerï¼Œç„¶åæ‰¾åˆ°ç›¸åº”ç›®å½•å³å¯ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131922376.jpg"></p><h2 id="2-3-ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®"><a href="#2-3-ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®" class="headerlink" title="2.3 ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®"></a>2.3 ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®</h2><p>æ—¢ç„¶å­˜å‚¨äº†æ•°æ®ï¼Œé‚£è‚¯å®šåœ¨æŸä¸ªæ—¶é—´æ®µéœ€è¦æ‹¿å‡ºæ¥ä½¿ç”¨ã€‚å› æ­¤æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚</p><p>åŒæ ·çš„ï¼ŒContextç±»ä¸­ä¹Ÿæä¾›äº†ä¸€ä¸ª<code>openFileInput()</code>æ–¹æ³•ï¼Œç”¨äºä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚è¯¥æ–¹æ³•åªæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå³è¦è¯»å–çš„æ–‡ä»¶åï¼Œç„¶åç³»ç»Ÿä¼šè‡ªåŠ¨åˆ°<code>/data/data/&lt;package name&gt;/files/</code>ç›®å½•ä¸‹å»åŠ è½½è¿™ä¸ªæ–‡ä»¶ã€‚</p><p>å®ç°å°æ¡ˆä¾‹ï¼šåŸºäº 2.2 çš„æ¡ˆä¾‹ï¼Œæ´»åŠ¨åˆ›å»ºæ—¶ï¼Œä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°è¾“å…¥æ¡†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> EditText edittext;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">FileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;account&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        initView();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> loadData();<br>        <span class="hljs-keyword">if</span> (!TextUtils.isEmpty(content))&#123;<br>            edittext.setText(content);<br>        &#125;<br>    &#125;<br><br>......<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">loadData</span><span class="hljs-params">()</span>&#123;<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            in = openFileInput(FileName);<br>            reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(in));<br>            <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-keyword">while</span>((line = reader.readLine()) != <span class="hljs-literal">null</span>)&#123;<br>                content.append(line);<br>            &#125;<br><br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (reader != <span class="hljs-literal">null</span>)&#123;<br>                    reader.close();<br>                &#125;<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> content.toString();<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><code>loadData()</code>æ–¹æ³•ä¸»è¦æ˜¯æ–‡ä»¶æµè¯»å–çš„åŸºæœ¬æ“ä½œï¼Œç„¶åé‡å†™äº†<code>onCreate()</code>æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯åœ¨æ´»åŠ¨åˆ›å»ºæ—¶ä¸€å®šä¼šè°ƒç”¨<code>loadData()</code>æ–¹æ³•ã€‚åœ¨<code>onCreate()</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>TextUtils,isEmpty()</code>æ–¹æ³•æ¥å¯¹è¯»å–åˆ°çš„å­—ç¬¦ä¸²è¿›è¡Œéç©ºåˆ¤æ–­ã€‚<code>TextUtils,isEmpty()</code>æ–¹æ³•å¯ä»¥ä¸€æ¬¡æ€§è¿›è¡Œä¸¤ç§ç©ºå€¼çš„åˆ¤æ–­ã€‚å½“ä¼ å…¥çš„å­—ç¬¦ä¸²ç­‰äºnullæˆ–è€…ç­‰äºç©ºå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•éƒ½ä¼šè¿”å›trueï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬ä¸éœ€è¦å…ˆå•ç‹¬åˆ¤æ–­è¿™ä¸¤ç§ç©ºå€¼å†ä½¿ç”¨é€»è¾‘è¿ç®—ç¬¦è¿æ¥èµ·æ¥äº†ã€‚</p><h1 id="ä¸‰ã€SharedPreferenceså­˜å‚¨"><a href="#ä¸‰ã€SharedPreferenceså­˜å‚¨" class="headerlink" title="ä¸‰ã€SharedPreferenceså­˜å‚¨"></a>ä¸‰ã€SharedPreferenceså­˜å‚¨</h1><p>ä¸åŒäºæ–‡ä»¶çš„å­˜å‚¨æ–¹å¼ï¼ŒSharedPreferences æ˜¯ä½¿ç”¨é”®å€¼å¯¹çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¿å­˜ä¸€æ¡æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦ç»™è¿™æ¡æ•°æ®æä¾›ä¸€ä¸ªå¯¹åº”çš„é”®ï¼Œè¿™æ ·åœ¨è¯»å–æ•°æ®çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡è¿™ä¸ªé”®æŠŠç›¸åº”çš„å€¼å–å‡ºæ¥ã€‚è€Œä¸”SharedPreferencesè¿˜æ”¯æŒå¤šç§ä¸åŒçš„æ•°æ®ç±»å‹å­˜å‚¨ã€‚</p><h2 id="3-1-å°†æ•°æ®å­˜å‚¨åˆ°SharedPreferencesä¸­"><a href="#3-1-å°†æ•°æ®å­˜å‚¨åˆ°SharedPreferencesä¸­" class="headerlink" title="3.1 å°†æ•°æ®å­˜å‚¨åˆ°SharedPreferencesä¸­"></a>3.1 å°†æ•°æ®å­˜å‚¨åˆ°SharedPreferencesä¸­</h2><p>è¦æƒ³ä½¿ç”¨SharedPreferencesæ¥å­˜å‚¨æ•°æ®ï¼Œé¦–å…ˆéœ€è¦è·å–åˆ°SharedPreferenceså¯¹è±¡ã€‚Androidä¸­ä¸»è¦æä¾›äº†3ç§æ–¹æ³•ç”¨äºå¾—åˆ°SharedPreferenceså¯¹è±¡ã€‚</p><ol><li><p>Contextç±»ä¸­çš„<code>getSharedPreferences()</code>æ–¹æ³•</p><p>æ­¤æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°ç”¨äºæŒ‡å®šSharedPreferencesæ–‡ä»¶çš„åç§°ï¼Œå¦‚æœæŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨åˆ™ä¼šåˆ›å»ºä¸€ä¸ªï¼ŒSharedPreferencesæ–‡ä»¶éƒ½æ˜¯å­˜æ”¾åœ¨<code>/data/data/&lt;package name&gt;/shared prefs/</code>ç›®å½•ä¸‹çš„ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•°ç”¨äºæŒ‡å®šæ“ä½œæ¨¡å¼ï¼Œç›®å‰åªæœ‰<code>MODE PRIVATE</code>è¿™ä¸€ç§æ¨¡å¼å¯é€‰ï¼Œå®ƒæ˜¯é»˜è®¤çš„æ“ä½œæ¨¡å¼ï¼Œå’Œç›´æ¥ä¼ å…¥0æ•ˆæœæ˜¯ç›¸åŒçš„ï¼Œè¡¨ç¤ºåªæœ‰å½“å‰çš„åº”ç”¨ç¨‹åºæ‰å¯ä»¥å¯¹è¿™ä¸ªSharedPreferencesæ–‡ä»¶è¿›è¡Œè¯»å†™ã€‚å…¶ä»–å‡ ç§æ“ä½œæ¨¡å¼å‡å·²è¢«åºŸå¼ƒã€‚</li></ul></li><li><p>Activityç±»ä¸­çš„<code>getPreferences()</code>æ–¹æ³•</p><p>è¿™ä¸ªæ–¹æ³•å’ŒContextä¸­çš„<code>getSharedPreferences()</code>æ–¹æ³•å¾ˆç›¸ä¼¼ï¼Œä¸è¿‡å®ƒåªæ¥æ”¶ä¸€ä¸ªæ“ä½œæ¨¡å¼å‚æ•°ï¼Œå› ä¸ºä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ—¶ä¼šè‡ªåŠ¨å°†å½“å‰æ´»åŠ¨çš„ç±»åä½œä¸ºSharedPreferencesçš„æ–‡ä»¶åã€‚</p></li><li><p>PreferenceManagerç±»ä¸­çš„<code>getDefaultSharedPreferences()</code>æ–¹æ³•</p><p>è¿™æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªContextå‚æ•°ï¼Œå¹¶è‡ªåŠ¨ä½¿ç”¨å½“å‰åº”ç”¨ç¨‹åºçš„åŒ…åä½œä¸ºå‰ç¼€æ¥å‘½åSharedPreferencesæ–‡ä»¶ã€‚</p></li></ol><p>å¾—åˆ°äº†SharedPreferenceså¯¹è±¡ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹å‘SharedPreferencesæ–‡ä»¶ä¸­å­˜å‚¨æ•°æ®äº†ï¼Œä¸»è¦å¯ä»¥åˆ†ä¸º3æ­¥å®ç°ã€‚</p><ol><li>è°ƒç”¨SharedPreferenceså¯¹è±¡çš„<code>edit()</code>æ–¹æ³•æ¥è·å–ä¸€ä¸ªSharedPreferences.Editorå¯¹è±¡ã€‚</li><li>ä½¿ç”¨<code>putXXX()</code>æ–¹æ³•å‘SharedPreferences.Editorå¯¹è±¡ä¸­æ·»åŠ æ•°æ®ï¼Œæ¯”å¦‚æ·»åŠ å­—ç¬¦ä¸²ä½¿ç”¨<code>putString()</code>æ–¹æ³•ã€‚</li><li>è°ƒç”¨<code>apply()</code>æ–¹æ³•å°†æ·»åŠ çš„æ•°æ®æäº¤ï¼Œä»è€Œå®Œæˆæ•°æ®å­˜å‚¨æ“ä½œã€‚</li></ol><p>äº†è§£å®Œä¹‹åï¼Œå¼€å§‹å®æ“ã€‚</p><p><del>å’Œæ–‡ä»¶å­˜å‚¨çš„æ¡ˆä¾‹ä¸€æ ·ï¼Œåªä¸è¿‡ä½¿ç”¨çš„æ˜¯ä¸åŒçš„å­˜å‚¨æ–¹æ³•ã€‚</del>ï¼ˆè¯•äº†ä¸€ä¸‹ï¼Œå¹¶ä¸å¯ä»¥ï¼ï¼‰</p><p>ä¸»æ´»åŠ¨å¸ƒå±€æ”¹æˆä¸€ä¸ªæŒ‰é’®å°±è¡Œã€‚</p><p> MainActivity çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">FileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;account&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><span class="hljs-comment">//æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktosaveData</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">sharedPreferences</span> <span class="hljs-operator">=</span> getSharedPreferences(FileName, Context.MODE_PRIVATE);<br>        SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">edit</span> <span class="hljs-operator">=</span> sharedPreferences.edit();<br>        edit.putString(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;Jack&quot;</span>);<br>        edit.putInt(<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-number">28</span>);<br>        edit.putBoolean(<span class="hljs-string">&quot;married&quot;</span>,<span class="hljs-literal">true</span>);<br>        edit.apply();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åŒæ ·ä¾é <code>Device File Explorer</code>è¿›è¡ŒæŸ¥çœ‹ï¼Œæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131923336.jpg"></p><h2 id="3-2-ä»SharedPreferencesä¸­è¯»å–æ•°æ®"><a href="#3-2-ä»SharedPreferencesä¸­è¯»å–æ•°æ®" class="headerlink" title="3.2 ä»SharedPreferencesä¸­è¯»å–æ•°æ®"></a>3.2 ä»SharedPreferencesä¸­è¯»å–æ•°æ®</h2><p>åœ¨3.1ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ç³»åˆ—putæ–¹æ³•å°†æ•°æ®å­˜å‚¨åˆ°SharedPreferencesä¸­ï¼Œç±»ä¼¼çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—çš„getæ–¹æ³•è¯»å–å­˜å‚¨çš„æ•°æ®ã€‚è¿™äº›getæ–¹æ³•éƒ½æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”®ï¼Œä¼ å…¥å­˜å‚¨æ•°æ®æ—¶ä½¿ç”¨çš„é”®å°±å¯ä»¥å¾—åˆ°ç›¸åº”çš„å€¼äº†ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯é»˜è®¤å€¼ï¼Œå³è¡¨ç¤ºå½“ä¼ å…¥çš„é”®æ‰¾ä¸åˆ°å¯¹åº”çš„å€¼æ—¶ä¼šä»¥ä»€ä¹ˆæ ·çš„é»˜è®¤å€¼è¿›è¡Œè¿”å›ã€‚</p><p>ä¸å­˜å‚¨æ•°æ®ä¸åŒï¼Œè¯»å–æ•°æ®ä¸éœ€è¦è·å–SharedPreferences.Editorå¯¹è±¡ï¼Œåªéœ€è¦SharedPreferenceså¯¹è±¡å³å¯ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>è·å–SharedPreferenceså¯¹è±¡</li><li>é€šè¿‡getæ–¹æ³•è·å–å­˜å‚¨çš„æ•°æ®</li></ol><p>å¼€å§‹å®æ“ï¼Œå°†æˆ‘ä»¬åˆšåˆšå­˜å…¥çš„æ•°æ®è¯»å–å‡ºæ¥ã€‚</p><p>ä¸»æ´»åŠ¨å¸ƒå±€ä¸å˜ï¼Œåªä¸è¿‡æŒ‰é’®åŠŸèƒ½ä»å­˜å‚¨æ•°æ®å˜æˆäº†è¿˜åŸæ•°æ®ã€‚</p><p>ä¸»è¦ä¿®æ”¹çš„æ˜¯MainActivityçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">FileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;account&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoRestoreData</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">sharedPreferences</span> <span class="hljs-operator">=</span> getSharedPreferences(FileName, MODE_PRIVATE);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> sharedPreferences.getString(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> sharedPreferences.getInt(<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-number">0</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">married</span> <span class="hljs-operator">=</span> sharedPreferences.getBoolean(<span class="hljs-string">&quot;married&quot;</span>,<span class="hljs-literal">false</span>);<br>        Log.d(<span class="hljs-string">&quot;aaa&quot;</span>,<span class="hljs-string">&quot;name: &quot;</span> + name);<br>        Log.d(<span class="hljs-string">&quot;aaa&quot;</span>,<span class="hljs-string">&quot;age: &quot;</span> + age);<br>        Log.d(<span class="hljs-string">&quot;aaa&quot;</span>,<span class="hljs-string">&quot;married: &quot;</span> + married);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-3-å®ç°è®°ä½å¯†ç åŠŸèƒ½"><a href="#3-3-å®ç°è®°ä½å¯†ç åŠŸèƒ½" class="headerlink" title="3.3 å®ç°è®°ä½å¯†ç åŠŸèƒ½"></a>3.3 å®ç°è®°ä½å¯†ç åŠŸèƒ½</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªç™»é™†ç•Œé¢çš„å¸ƒå±€ï¼ˆactivity_login.xmlï¼‰ä»¥åŠæ´»åŠ¨ï¼ˆLoginActivity.javaï¼‰ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">EditText</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:hint</span>=<span class="hljs-string">&quot;è´¦å·&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/zhanghao&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">EditText</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:hint</span>=<span class="hljs-string">&quot;å¯†ç &quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/mima&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">CheckBox</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/remeber&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;è®°ä½å¯†ç &quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ç™»å…¥&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;ClicktoLogin&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ä½¿ç”¨åˆ°CheckBoxæ§ä»¶ï¼Œä»¥ä»£è¡¨ç”¨æˆ·æ˜¯å¦éœ€è¦è®°ä½å¯†ç ã€‚</p><p>ç„¶åæ˜¯LoginActivity.javaä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> EditText accountEdit;<br>    <span class="hljs-keyword">private</span> EditText passwordEdit;<br>    <span class="hljs-keyword">private</span> CheckBox remeberCheckBox;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">FileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;loginData&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">Arg1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;account&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">Arg2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">Arg3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;isRemeber&quot;</span>;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_login);<br>        initView();<br>        <br>        isRestoreData();<br>        <br>    &#125;<br><span class="hljs-comment">//è·å–æ§ä»¶å¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initView</span><span class="hljs-params">()</span> &#123;<br>        accountEdit = findViewById(R.id.zhanghao);<br>        passwordEdit = findViewById(R.id.mima);<br>        remeberCheckBox = findViewById(R.id.remeber);<br>    &#125;<br><span class="hljs-comment">//ç™»å…¥æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoLogin</span><span class="hljs-params">(View view)</span>&#123;<br>        <br>        isSaveData();<br>        <br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MainActivity.class);<br>        startActivity(intent);<br>        finish();<br>    &#125;<br><span class="hljs-comment">//å­˜å‚¨æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isSaveData</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">loginData</span> <span class="hljs-operator">=</span> getSharedPreferences(FileName, MODE_PRIVATE);<br>        SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">loginEdit</span> <span class="hljs-operator">=</span> loginData.edit();<br>        <span class="hljs-comment">//å¦‚æœç‚¹å‡»äº†è®°ä½å¯†ç çš„é€‰æ¡†</span><br>        <span class="hljs-keyword">if</span> (remeberCheckBox.isChecked())&#123;<br>            loginEdit.putString(Arg1, accountEdit.getText().toString());<br>            loginEdit.putString(Arg2, passwordEdit.getText().toString());<br>            loginEdit.putBoolean(Arg3, remeberCheckBox.isChecked());<br>        &#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">//æ²¡æœ‰è®°ä½å¯†ç ï¼Œå°±å°†å­˜å‚¨çš„æ•°æ®æ“¦é™¤</span><br>            loginEdit.clear();<br>        &#125;<br>        loginEdit.apply();<br>    &#125;<br><span class="hljs-comment">//æ¢å¤æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isRestoreData</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">sharedPreferences</span> <span class="hljs-operator">=</span> getSharedPreferences(FileName, MODE_PRIVATE);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isremeber</span> <span class="hljs-operator">=</span> sharedPreferences.getBoolean(Arg3, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">if</span> (isremeber)&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> sharedPreferences.getString(Arg1,<span class="hljs-string">&quot;&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> sharedPreferences.getString(Arg2, <span class="hljs-string">&quot;&quot;</span>);<br>            accountEdit.setText(account);<br>            passwordEdit.setText(password);<br>            remeberCheckBox.setChecked(isremeber);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨<code>ClicktoLogin()</code>æ–¹æ³•ä¸­è°ƒç”¨<code>isSaveData()</code>æ–¹æ³•ï¼Œåœ¨é‡Œé¢åˆ¤æ–­æ˜¯å¦è¦ä¿å­˜å¯†ç ï¼Œå¦‚æœCheckBoxè¢«é€‰ä¸­ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·æƒ³è¦è®°ä½å¯†ç ï¼Œé‚£ä¹ˆå°±æŠŠaccountå’Œpasswordä»¥åŠCheckBoxçš„é€‰æ‹©çŠ¶æ€çš„å€¼éƒ½å­˜å…¥åˆ°SharedPreferencesæ–‡ä»¶å½“ä¸­å¹¶æäº¤ã€‚å¦‚æœæ²¡æœ‰è¢«é€‰ä¸­ï¼Œå°±ç®€å•åœ°è°ƒç”¨ä¸€ä¸‹clear()æ–¹æ³•ï¼Œå°†SharedPreferencesæ–‡ä»¶ä¸­ä¹‹å‰å­˜å‚¨çš„æ•°æ®å…¨éƒ¨æ¸…é™¤æ‰ã€‚</p><p>å½“ç”¨æˆ·é€‰ä¸­äº†è®°ä½å¯†ç å¤é€‰æ¡†ï¼Œå¹¶æˆåŠŸç™»å½•ä¸€æ¬¡ä¹‹åï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœå†é‡æ–°å¯åŠ¨ç™»å½•ç•Œé¢ï¼Œå°±ä¼šä»SharedPreferencesæ–‡ä»¶ä¸­å°†ä¿å­˜çš„è´¦å·å’Œå¯†ç éƒ½è¯»å–å‡ºæ¥ï¼Œå¹¶å¡«å……åˆ°æ–‡æœ¬è¾“å…¥æ¡†ä¸­ï¼Œç„¶åæŠŠè®°ä½å¯†ç å¤é€‰æ¡†é€‰ä¸­ï¼Œè¿™æ ·å°±å®Œæˆè®°ä½å¯†ç çš„åŠŸèƒ½äº†ã€‚</p><p>å½“ç„¶ï¼Œè¿™åŠŸèƒ½è¿˜æ˜¯æœ‰ç¼ºé™·çš„ï¼Œå› ä¸ºä¸è®°ä½å¯†ç å¹¶ä¸æ„å‘³ç€è´¦å·ä¹Ÿè·Ÿç€æ¸…æ¥šæ‰ï¼Œæ€»ä¹‹è¿˜å¯ä»¥åœ¨è¿™ä¸ªåŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•ã€‚</p><p>MainActivityçš„ä»£ç å’Œå¸ƒå±€è¿™é‡Œå°±ä¸æ”¾å‡ºæ¥ï¼Œå°±æ˜¯ä¸€ä¸ªé€€å‡ºæŒ‰é’®ï¼Œç‚¹å‡»å›åˆ°ç™»å…¥ç•Œé¢ï¼Œå¯ä»¥è¯´æ˜¯å¾ˆç®€å•çš„åŠŸèƒ½ã€‚</p><h1 id="å››ã€SQLiteæ•°æ®åº“å­˜å‚¨"><a href="#å››ã€SQLiteæ•°æ®åº“å­˜å‚¨" class="headerlink" title="å››ã€SQLiteæ•°æ®åº“å­˜å‚¨"></a>å››ã€SQLiteæ•°æ®åº“å­˜å‚¨</h1><p>è®ºè°çš„æ•°æ®å­˜å‚¨çš„åŠŸèƒ½å¼ºå¤§ï¼Œé‚£æˆ‘åªèƒ½è¯´è¿˜å¾—æ˜¯æ•°æ®åº“æ›´å‰å®³ï¼Œå‰ä¸¤è€…ä¸ä¹‹æ¯”è¾ƒç®€ç›´æ˜¯ç›¸å½¢è§ç»Œï¼Androidç³»ç»Ÿå†…ç½®äº†SQLiteæ•°æ®åº“ï¼Œå®ƒæ˜¯ä¸€æ¬¾è½»é‡çº§çš„å…³ç³»å‹æ•°æ®åº“ï¼Œè¿ç®—é€Ÿåº¦éå¸¸å¿«ï¼Œå ç”¨èµ„æºå¾ˆå°‘ï¼Œé€šå¸¸åªéœ€è¦å‡ ç™¾KBçš„å†…å­˜å°±è¶³å¤Ÿäº†ï¼Œå› è€Œç‰¹åˆ«é€‚åˆåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šä½¿ç”¨ã€‚</p><h2 id="4-1-åˆ›å»ºæ•°æ®åº“"><a href="#4-1-åˆ›å»ºæ•°æ®åº“" class="headerlink" title="4.1 åˆ›å»ºæ•°æ®åº“"></a>4.1 åˆ›å»ºæ•°æ®åº“</h2><p>Androidæä¾›äº†SQLiteOpenHelperå¸®åŠ©ç±»ï¼Œå®ƒè®©æˆ‘ä»¬èƒ½å¤Ÿæ›´åŠ æ–¹ä¾¿åœ°ç®¡ç†æ•°æ®åº“ï¼Œå€ŸåŠ©è¿™ä¸ªç±»å°±å¯ä»¥éå¸¸ç®€å•åœ°å¯¹æ•°æ®åº“è¿›è¡Œåˆ›å»ºå’Œå‡çº§ã€‚</p><p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç±»æ¥ç»§æ‰¿SQLiteOpenHelperå¸®åŠ©ç±»ï¼Œå®ƒæœ‰ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>onCreate()</code>å’Œ<code>onUpgrade()</code>ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨è‡ªå·±çš„ç±»é‡Œé¢é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œç„¶ååˆ†åˆ«åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­å»å®ç°åˆ›å»ºã€å‡çº§æ•°æ®åº“çš„é€»è¾‘ã€‚</p><p>SQLiteOpenHelperä¸­è¿˜æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„å®ä¾‹æ–¹æ³•ï¼š<code>getReadableDatabase()</code>å’Œ<code>getWritableDatabase()</code>ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥åˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªç°æœ‰çš„æ•°æ®åº“ï¼ˆå¦‚æœæ•°æ®åº“å·²å­˜åœ¨åˆ™ç›´æ¥æ‰“å¼€ï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“)ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¯å¯¹æ•°æ®åº“è¿›è¡Œè¯»å†™æ“ä½œçš„å¯¹è±¡ã€‚ä¸åŒçš„æ˜¯ï¼Œå½“æ•°æ®åº“ä¸å¯å†™äººçš„æ—¶å€™ï¼ˆå¦‚ç£ç›˜ç©ºé—´å·²æ»¡ï¼‰ï¼Œ<code>getReadableDatabase()</code>æ–¹æ³•è¿”å›çš„å¯¹è±¡å°†ä»¥åªè¯»çš„æ–¹å¼å»æ‰“å¼€æ•°æ®åº“ï¼Œè€Œ<code>getWritableDatabase()</code>æ–¹æ³•åˆ™å°†å‡ºç°å¼‚å¸¸ã€‚</p><p>SQLiteOpenHelperä¸­æœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•å¯ä¾›é‡å†™ï¼Œä¸€èˆ¬ä½¿ç”¨å‚æ•°å°‘ä¸€ç‚¹çš„é‚£ä¸ªæ„é€ æ–¹æ³•å³å¯ã€‚è¿™ä¸ªæ„é€ æ–¹æ³•ä¸­æ¥æ”¶4ä¸ªå‚æ•°ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Contextï¼Œå¿…é¡»è¦æœ‰å®ƒæ‰èƒ½å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°æ®åº“åï¼Œåˆ›å»ºæ•°æ®åº“æ—¶ä½¿ç”¨çš„å°±æ˜¯è¿™é‡ŒæŒ‡å®šçš„åç§°ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°å…è®¸æˆ‘ä»¬åœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰çš„Cursorï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼ äººnulLã€‚</li><li>ç¬¬å››ä¸ªå‚æ•°è¡¨ç¤ºå½“å‰æ•°æ®åº“çš„ç‰ˆæœ¬å·ï¼Œå¯ç”¨äºå¯¹æ•°æ®åº“è¿›è¡Œå‡çº§æ“ä½œã€‚</li></ul><p><strong>æ„å»ºå‡ºSQLiteOpenHelperçš„å®ä¾‹ä¹‹åï¼Œå†è°ƒç”¨å®ƒçš„<code>getReadableDatabase()</code>æˆ–<code>getWritableDatabase()</code>æ–¹æ³•å°±èƒ½å¤Ÿåˆ›å»ºæ•°æ®åº“äº†</strong>ï¼Œæ•°æ®åº“æ–‡ä»¶ä¼šå­˜æ”¾åœ¨<code>/data/data/&lt;package name&gt;/databases/</code>ç›®å½•ä¸‹ã€‚<strong>æ­¤æ—¶ï¼Œé‡å†™çš„<code>onCreate()</code>æ–¹æ³•ä¹Ÿä¼šå¾—åˆ°æ‰§è¡Œ</strong>ï¼Œæ‰€ä»¥é€šå¸¸ä¼šåœ¨è¿™é‡Œå»å¤„ç†ä¸€äº›åˆ›å»ºè¡¨çš„é€»è¾‘ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ä¾‹å­æ¥å­¦ä¼šå¦‚ä½•ä½¿ç”¨SQLiteOpenHelperã€‚</p><p>å‡è®¾æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªåä¸ºBookStoreçš„æ•°æ®åº“ï¼Œå¹¶åœ¨é‡Œé¢åˆ›å»ºä¸€ä¸ªåä¸ºBookçš„è¡¨ï¼Œé‚£ä¹ˆå¦‚æœå­¦è¿‡SQLçš„è¯ï¼Œå»ºè¡¨è¯­å¥åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> Book(<br>id <span class="hljs-type">integer</span> <span class="hljs-keyword">primary</span> key autoincrement,<br>    author text,<br>    price <span class="hljs-type">real</span>,<br>    pages <span class="hljs-type">integer</span>,<br>    name text<br>)<br></code></pre></td></tr></table></figure><p>è¯¥è¡¨åŒ…å«æœ‰å…³ä¹¦çš„å±æ€§ï¼Œå¦‚ä½œè€…ã€ä»·æ ¼ã€é¡µæ•°ã€ä¹¦åï¼Œidä½œä¸ºä¸»é”®å­˜åœ¨ï¼ˆå”¯ä¸€æ€§ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åº”è¯¥åˆ©ç”¨SQLiteOpenHelperç±»æ¥åˆ›å»ºæ•°æ®åº“å¹¶å»ºè¡¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDatabaseHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SQLiteOpenHelper</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span>  <span class="hljs-variable">CreateBookTable</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;create table Book(\n&quot;</span> +<br>            <span class="hljs-string">&quot;   id integer primary key autoincrement,\n&quot;</span> +<br>            <span class="hljs-string">&quot;   author text,\n&quot;</span> +<br>            <span class="hljs-string">&quot;   price real,\n&quot;</span> +<br>            <span class="hljs-string">&quot;   pages integer,\n&quot;</span> +<br>            <span class="hljs-string">&quot;   name text\n&quot;</span> +<br>            <span class="hljs-string">&quot;)&quot;</span>;<br>    <span class="hljs-keyword">private</span> Context mContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyDatabaseHelper</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Context context, <span class="hljs-meta">@Nullable</span> String name, <span class="hljs-meta">@Nullable</span> SQLiteDatabase.CursorFactory factory, <span class="hljs-type">int</span> version)</span> &#123;<br>        <span class="hljs-built_in">super</span>(context, name, factory, version);<br>        mContext= context;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(SQLiteDatabase sqLiteDatabase)</span> &#123;<br>        <span class="hljs-comment">//æ‰§è¡Œå»ºè¡¨è¯­å¥</span><br>        sqLiteDatabase.execSQL(CreateBookTable);<br>        Toast.makeText(mContext, <span class="hljs-string">&quot;create table succeeded&quot;</span>, Toast.LENGTH_SHORT).show();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUpgrade</span><span class="hljs-params">(SQLiteDatabase sqLiteDatabase, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> i1)</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ä¸»æ´»åŠ¨çš„å¸ƒå±€å’Œä»£ç ã€‚å¸ƒå±€çš„è¯ï¼Œä¸€ä¸ªæŒ‰é’®å°±è¶³å¤Ÿäº†ï¼Œç„¶åæ˜¯ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoCreateDataBase</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">MyDatabaseHelper</span> <span class="hljs-variable">myDatabaseHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDatabaseHelper</span>(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;BookStore.db&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-number">1</span>);<br>        myDatabaseHelper.getWritableDatabase();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆç®€å•æ˜¯ä¸æ˜¯ï¼Ÿåªéœ€è¦åˆ›å»ºä¸€ä¸ªMyDatabaseHelperå¯¹è±¡ï¼Œé€šè¿‡æ„é€ å‡½æ•°çš„å‚æ•°å°†æ•°æ®åº“åæŒ‡å®šä¸ºBookStore.dbï¼Œç‰ˆæœ¬å·æŒ‡å®šä¸º1ï¼Œç„¶åè°ƒç”¨äº†<code>getWritableDatabase()</code>æ–¹æ³•æ¥åˆ›å»ºæ•°æ®åº“ã€‚</p><p>å¥½ï¼é‚£æˆ‘ä»¬æ€ä¹ˆéªŒè¯ç¡®å®åˆ›å»ºæˆåŠŸäº†å‘¢ï¼Ÿå°è¯•ä½¿ç”¨Device File Explorerè¿›è¡ŒæŸ¥çœ‹ï¼Œå‘ç°åªèƒ½çœ‹åˆ°databasesç›®å½•ä¸‹å‡ºç°äº†ä¸€ä¸ª<br>BookStore.dbæ–‡ä»¶ï¼ŒBookè¡¨æ˜¯æ— æ³•é€šè¿‡File Explorerçœ‹åˆ°çš„ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ¢å¦ä¸€ç§æ–¹å¼æŸ¥çœ‹ï¼Œä½¿ç”¨adb shellæ¥å¯¹æ•°æ®åº“å’Œè¡¨çš„åˆ›å»ºæƒ…å†µè¿›è¡Œæ£€æŸ¥ã€‚ç›¸å…³æŒ‡ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">//æ‰“å¼€æ•°æ®åº“<br>sqlite3 BookStore.db<br>//æŸ¥çœ‹æ‰€æœ‰è¡¨<br>.table<br>//æŸ¥çœ‹å»ºè¡¨è¯­å¥<br>.schema<br>//é€€å‡ºç¼–è¾‘<br>.exitæˆ–.quit<br></code></pre></td></tr></table></figure><h2 id="4-2-å‡çº§æ•°æ®åº“"><a href="#4-2-å‡çº§æ•°æ®åº“" class="headerlink" title="4.2 å‡çº§æ•°æ®åº“"></a>4.2 å‡çº§æ•°æ®åº“</h2><p>å¦‚æœæˆ‘ä»¬ä¹‹ååˆæƒ³åˆ›å»ºä¸€ä¸ªCategoryè¡¨ç”¨äºè®°å½•å›¾ä¹¦çš„åˆ†ç±»ï¼Œé‚£åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥è¯•è¯•å°†å†™å…¥onCreate()æ–¹æ³•ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDatabaseHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SQLiteOpenHelper</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span>  <span class="hljs-variable">CreateBookTable</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;create table Book(\n&quot;</span> +<br>            <span class="hljs-string">&quot;   id integer primary key autoincrement,\n&quot;</span> +<br>            <span class="hljs-string">&quot;   author text,\n&quot;</span> +<br>            <span class="hljs-string">&quot;   price real,\n&quot;</span> +<br>            <span class="hljs-string">&quot;   pages integer,\n&quot;</span> +<br>            <span class="hljs-string">&quot;   name text\n&quot;</span> +<br>            <span class="hljs-string">&quot;)&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CreateCategoryTable</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;create table Category(\n&quot;</span> +<br>            <span class="hljs-string">&quot;\tid integer primary key autoincrement,\n&quot;</span> +<br>            <span class="hljs-string">&quot;    category_name text,\n&quot;</span> +<br>            <span class="hljs-string">&quot;    category_code integer\n&quot;</span> +<br>            <span class="hljs-string">&quot;)&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> Context mContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyDatabaseHelper</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Context context, <span class="hljs-meta">@Nullable</span> String name, <span class="hljs-meta">@Nullable</span> SQLiteDatabase.CursorFactory factory, <span class="hljs-type">int</span> version)</span> &#123;<br>        <span class="hljs-built_in">super</span>(context, name, factory, version);<br>        mContext= context;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(SQLiteDatabase sqLiteDatabase)</span> &#123;<br>        <span class="hljs-comment">//æ‰§è¡Œå»ºè¡¨è¯­å¥</span><br>        sqLiteDatabase.execSQL(CreateBookTable);<br>        sqLiteDatabase.execSQL(CreateCategoryTable);<br>        Toast.makeText(mContext, <span class="hljs-string">&quot;create table succeeded&quot;</span>, Toast.LENGTH_SHORT).show();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUpgrade</span><span class="hljs-params">(SQLiteDatabase sqLiteDatabase, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> i1)</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å°è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°å¹¶æ²¡æœ‰æˆåŠŸåˆ›å»ºCategoryè¡¨ï¼ŒåŸå› æ˜¯BookStore.dbå·²ç»å­˜åœ¨ï¼Œä¹‹åä¸ç®¡æˆ‘ä»¬æ€ä¹ˆç‚¹å‡»åˆ›å»ºæŒ‰é’®ï¼ˆå³æ‰§è¡Œ<code>getWritableDatabase()</code>æ–¹æ³•ï¼‰ï¼ŒMyDatabaseHelperä¸­çš„<code>onCreate()</code>æ–¹æ³•éƒ½ä¸ä¼šå†æ¬¡æ‰§è¡Œï¼Œå› æ­¤ä¹Ÿå°±æ— æ³•æ–°å¢è¡¨ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é‡å†™<code>onUpgrade()</code>æ–¹æ³•æ¥å®ç°æ·»åŠ æ–°è¡¨ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDatabaseHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SQLiteOpenHelper</span> &#123;<br><br> ......<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUpgrade</span><span class="hljs-params">(SQLiteDatabase sqLiteDatabase, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> i1)</span> &#123;<br>        sqLiteDatabase.execSQL(<span class="hljs-string">&quot;drop table if exists Book&quot;</span>);<br>        sqLiteDatabase.execSQL(<span class="hljs-string">&quot;drop table if exists Category&quot;</span>);<br>        onCreate(sqLiteDatabase);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨<code>onUpgrade()</code>æ–¹æ³•ä¸­æ‰§è¡Œäº†ä¸¤æ¡dropè¯­å¥ï¼Œå¦‚æœå‘ç°æ•°æ®åº“ä¸­å·²ç»å­˜åœ¨Bookè¡¨æˆ–Categoryè¡¨äº†ï¼Œå°±å°†è¿™ä¸¤å¼ è¡¨åˆ é™¤æ‰ï¼Œç„¶åå†è°ƒç”¨onCreate()æ–¹æ³•é‡æ–°åˆ›å»ºã€‚è¿™é‡Œå…ˆå°†å·²ç»å­˜åœ¨çš„è¡¨åˆ é™¤æ‰ï¼Œå› ä¸ºå¦‚æœåœ¨åˆ›å»ºè¡¨æ—¶å‘ç°è¿™å¼ è¡¨å·²ç»å­˜åœ¨äº†ï¼Œå°±ä¼šç›´æ¥æŠ¥é”™ã€‚</p><p>æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯å¦‚ä½•è®©<code>onUpgrade()</code>æ–¹æ³•èƒ½å¤Ÿæ‰§è¡Œäº†ï¼Œè¿˜è®°å¾—SQLiteOpenHelperçš„æ„é€ æ–¹æ³•é‡Œæ¥æ”¶çš„ç¬¬å››ä¸ªå‚æ•°å—ï¼Ÿå®ƒè¡¨ç¤ºå½“å‰æ•°æ®åº“çš„ç‰ˆæœ¬å·ï¼Œä¹‹å‰æˆ‘ä»¬ä¼ å…¥çš„æ˜¯1ï¼Œç°åœ¨åªè¦ä¼ å…¥ä¸€ä¸ªæ¯”1å¤§çš„æ•°ï¼Œå°±å¯ä»¥è®©<code>onUpgrade()</code>æ–¹æ³•å¾—åˆ°æ‰§è¡Œäº†ã€‚ä¿®æ”¹MainActivityä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoCreateDataBase</span><span class="hljs-params">(View view)</span> &#123;<br>    <span class="hljs-comment">//ç‰ˆæœ¬æ”¹ä¸º2</span><br>        <span class="hljs-type">MyDatabaseHelper</span> <span class="hljs-variable">myDatabaseHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDatabaseHelper</span>(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;BookStore.db&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-number">2</span>);<br>        myDatabaseHelper.getWritableDatabase();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨é‡æ–°è¿è¡Œç¨‹åºï¼Œå¹¶ç‚¹å‡»åˆ›å»ºæŒ‰é’®ï¼Œè¿™æ—¶å°±ä¼šå†æ¬¡å¼¹å‡ºåˆ›å»ºæˆåŠŸçš„æç¤ºã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡adb shellæ¥éªŒè¯ã€‚</p><p>ï¼ˆä½†æ˜¯è¿™æœ‰ä¸ªé—®é¢˜ï¼Œè¿™æŠŠä¹‹å‰çš„æ•°æ®åº“ç»™åˆ äº†ï¼Œé‚£æ•°æ®å²‚ä¸æ˜¯ä¸¢å¤±äº†ï¼ï¼ï¼ï¼‰</p><h2 id="4-3-æ·»åŠ æ•°æ®"><a href="#4-3-æ·»åŠ æ•°æ®" class="headerlink" title="4.3 æ·»åŠ æ•°æ®"></a>4.3 æ·»åŠ æ•°æ®</h2><p>åœ¨æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬å¯¹æ•°æ®è¿›è¡Œçš„æ“ä½œæ— éå°±æ˜¯å¢åˆ æ”¹æŸ¥è¿™å››ç§ã€‚ç›¸æ¯”äºåœ¨å­¦ä¹ æ•°æ®åº“æ—¶ä¸æ–­ç¼–å†™insertã€deleteã€updateã€selectè¯­å¥ï¼ŒAndroidæä¾›äº†ä¸€ç³»åˆ—çš„è¾…åŠ©æ€§æ–¹æ³•ï¼Œä½¿å¾—åœ¨Androidä¸­å³ä½¿ä¸å»ç¼–å†™SQLè¯­å¥ï¼Œä¹Ÿèƒ½è½»æ¾å®Œæˆæ‰€æœ‰çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚</p><p>åœ¨å‰é¢æœ‰ä¸€ç‚¹æˆ‘ä»¬æ²¡æœ‰æ³¨æ„åˆ°ï¼Œå°±æ˜¯SQLiteOpenHelperçš„<code>getReadableDatabase()</code>å’Œ<code>getwritableDatabase()</code>æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ªSQLiteDatabaseå¯¹è±¡ï¼Œå€ŸåŠ©è¿™ä¸ªå¯¹è±¡å°±å¯ä»¥å¯¹æ•°æ®è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œäº†ã€‚</p><p>é‚£æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•æ·»åŠ æ•°æ®ã€‚SQLiteDatabaseä¸­æä¾›äº†ä¸€ä¸ª<code>insert()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ä¸“é—¨ç”¨äºæ·»åŠ æ•°æ®çš„ã€‚å®ƒæ¥æ”¶3ä¸ªå‚æ•°ï¼š</p><ol><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¡¨åã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•°ç”¨äºåœ¨æœªæŒ‡å®šæ·»åŠ æ•°æ®çš„æƒ…å†µä¸‹ç»™æŸäº›å¯ä¸ºç©ºçš„åˆ—è‡ªåŠ¨èµ‹å€¼NULL,ä¸€èˆ¬æˆ‘ä»¬ç”¨ä¸åˆ°è¿™ä¸ªåŠŸèƒ½ï¼Œç›´æ¥ä¼ å…¥nullå³å¯ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªContentValueså¯¹è±¡ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—çš„put()æ–¹æ³•é‡è½½ï¼Œç”¨äºå‘ContentValuesä¸­æ·»åŠ æ•°æ®ï¼Œåªéœ€è¦å°†è¡¨ä¸­çš„æ¯ä¸ªåˆ—åä»¥åŠç›¸åº”çš„å¾…æ·»åŠ æ•°æ®ä¼ å…¥å³å¯ã€‚</li></ol><p>é‚£ä¹ˆå°±å¼€å§‹å®æ“å§ã€‚åŒæ ·è¿˜æ˜¯ä¸€ä¸ªæŒ‰é’®å®ç°æ·»åŠ æ•°æ®ï¼Œé‚£ä¹ˆå®ƒçš„å¸ƒå±€å°±ä¸å¤šè¯´äº†ã€‚</p><p>MainActivityä¸­çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoInsertData</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">MyDatabaseHelper</span> <span class="hljs-variable">myDatabaseHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDatabaseHelper</span>(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;BookStore.db&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-type">SQLiteDatabase</span> <span class="hljs-variable">BookDatabase</span> <span class="hljs-operator">=</span> myDatabaseHelper.getWritableDatabase();<br>        <span class="hljs-type">ContentValues</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();<br>        <span class="hljs-comment">//ç»„è£…ç¬¬ä¸€æ¡è®°å½•</span><br>        book.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;The Da Vinci Code&quot;</span>);<br>        book.put(<span class="hljs-string">&quot;author&quot;</span>,<span class="hljs-string">&quot;Dan Brown&quot;</span>);<br>        book.put(<span class="hljs-string">&quot;pages&quot;</span>,<span class="hljs-number">454</span>);<br>        book.put(<span class="hljs-string">&quot;price&quot;</span>,<span class="hljs-number">16.53</span>);<br>        BookDatabase.insert(<span class="hljs-string">&quot;Book&quot;</span>,<span class="hljs-literal">null</span>,book);<br>        book.clear();<br>        <span class="hljs-comment">//ç»„è£…ç¬¬äºŒæ¡è®°å½•</span><br>        book.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;The Lost Symbol&quot;</span>);<br>        book.put(<span class="hljs-string">&quot;author&quot;</span>,<span class="hljs-string">&quot;Dan Brown&quot;</span>);<br>        book.put(<span class="hljs-string">&quot;pages&quot;</span>,<span class="hljs-number">510</span>);<br>        book.put(<span class="hljs-string">&quot;price&quot;</span>,<span class="hljs-number">17.16</span>);<br>        BookDatabase.insert(<span class="hljs-string">&quot;Book&quot;</span>,<span class="hljs-literal">null</span>,book);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†ä¸Šé¢çš„æ“ä½œè½¬æˆSQLè¯­å¥å°±æ˜¯ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> Book(name, author, pages, price) <span class="hljs-keyword">values</span>(&quot;The Da Vinci Code&quot;, &quot;Dan Brown&quot;, <span class="hljs-number">454</span>, <span class="hljs-number">16.53</span>);<br>......<br></code></pre></td></tr></table></figure><p>ç”±äºidè¢«æŒ‡å®šä¸ºè‡ªå¢é•¿ï¼Œæ‰€ä»¥ä¸éœ€è¦è®¾ç½®idçš„å€¼ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥æ‰“å¼€BookStoreæ•°æ®åº“ï¼Œæ‰§è¡Œ<code>select * from Book; </code>è¯­å¥ï¼ˆ<strong>ä¸è¦å¿˜è®°æœ€åæ·»åŠ åˆ†å·</strong>ï¼‰æ¥éªŒè¯æ˜¯å¦æ·»åŠ æˆåŠŸã€‚</p><h2 id="4-4-æ›´æ–°æ•°æ®"><a href="#4-4-æ›´æ–°æ•°æ®" class="headerlink" title="4.4 æ›´æ–°æ•°æ®"></a>4.4 æ›´æ–°æ•°æ®</h2><p>æ›´æ–°æ•°æ®ä½¿ç”¨<code>update()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶4ä¸ªå‚æ•°ï¼š</p><ol><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¡¨åã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªContentValueså¯¹è±¡ï¼ŒæŠŠè¦æ›´æ–°çš„æ•°æ®åœ¨è¿™é‡Œç»„è£…è¿›å»ã€‚</li><li>ç¬¬ä¸‰ã€ç¬¬å››ä¸ªå‚æ•°ç”¨äºçº¦æŸæ›´æ–°æŸä¸€è¡Œæˆ–æŸå‡ è¡Œä¸­çš„æ•°æ®ï¼Œä¸æŒ‡å®šçš„è¯é»˜è®¤æ›´æ–°æ‰€æœ‰è¡Œã€‚</li></ol><p>åªéœ€è¦ç¨å¾®ä¿®æ”¹MainActivityä¸­çš„ä»£ç å°±è¡Œäº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>......<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoUpDate</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">MyDatabaseHelper</span> <span class="hljs-variable">myDatabaseHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDatabaseHelper</span>(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;BookStore.db&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-type">SQLiteDatabase</span> <span class="hljs-variable">BookDatabase</span> <span class="hljs-operator">=</span> myDatabaseHelper.getWritableDatabase();<br><br>        <span class="hljs-type">ContentValues</span> <span class="hljs-variable">values</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();<br>        values.put(<span class="hljs-string">&quot;price&quot;</span>,<span class="hljs-number">9.99</span>);<br>        <br>        BookDatabase.update(<span class="hljs-string">&quot;Book&quot;</span>,values,<span class="hljs-string">&quot;name = ?&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;The Da Vinci Code&quot;</span>&#125;);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºSQLiteDatabaseçš„<code>update()</code>çš„ç¬¬ä¸‰ã€ç¬¬å››ä¸ªå‚æ•°çš„å…·ä½“ä½œç”¨ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°å¯¹åº”çš„æ˜¯SQLè¯­å¥çš„whereéƒ¨åˆ†ï¼Œè¡¨ç¤ºæ›´æ–°æœ‰nameç­‰äºï¼Ÿçš„è¡Œï¼Œè€Œï¼Ÿæ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå¯ä»¥é€šè¿‡ç¬¬å››ä¸ªå‚æ•°æä¾›çš„ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ä¸­çš„æ¯ä¸ªå ä½ç¬¦æŒ‡å®šç›¸åº”çš„å†…å®¹ï¼Œç›¸å½“äºSQLä»£ç ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> Book <span class="hljs-keyword">set</span> price <span class="hljs-operator">=</span> <span class="hljs-number">9.99</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> &quot;The Da Vinci Code&quot;;<br></code></pre></td></tr></table></figure><h2 id="4-5-åˆ é™¤æ•°æ®"><a href="#4-5-åˆ é™¤æ•°æ®" class="headerlink" title="4.5 åˆ é™¤æ•°æ®"></a>4.5 åˆ é™¤æ•°æ®</h2><p>æ›´æ–°æ•°æ®ä½¿ç”¨<code>delete()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶3ä¸ªå‚æ•°ï¼š</p><ol><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¡¨åã€‚</li><li>ç¬¬äºŒã€ä¸‰ä¸ªå‚æ•°ç”¨äºçº¦æŸåˆ é™¤æŸä¸€è¡Œæˆ–æŸå‡ è¡Œä¸­çš„æ•°æ®ï¼Œä¸æŒ‡å®šçš„è¯é»˜è®¤åˆ é™¤æ‰€æœ‰è¡Œã€‚</li></ol><p>åŒæ ·çš„ï¼Œåªéœ€è¦æŠŠMainActivityä¸­çš„æ“ä½œæ¢æˆåˆ é™¤æ“ä½œå°±è¡Œäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>......<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoCreateupDate</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">MyDatabaseHelper</span> <span class="hljs-variable">myDatabaseHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDatabaseHelper</span>(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;BookStore.db&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-number">2</span>);<br>        <span class="hljs-type">SQLiteDatabase</span> <span class="hljs-variable">BookDatabase</span> <span class="hljs-operator">=</span> myDatabaseHelper.getWritableDatabase();<br>        BookDatabase.delete(<span class="hljs-string">&quot;Book&quot;</span>,<span class="hljs-string">&quot;pages &gt; ?&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;500&quot;</span>&#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„SQLè¯­å¥ä¸ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> Book <span class="hljs-keyword">where</span> pages <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span>;<br></code></pre></td></tr></table></figure><h2 id="4-6-æŸ¥è¯¢è¯­å¥"><a href="#4-6-æŸ¥è¯¢è¯­å¥" class="headerlink" title="4.6 æŸ¥è¯¢è¯­å¥"></a>4.6 æŸ¥è¯¢è¯­å¥</h2><p>å­¦è¿‡æ•°æ®åº“çš„éƒ½çŸ¥é“ï¼ŒæŸ¥è¯¢è¯­å¥æ˜¯æœ€å¤æ‚çš„ä¸€ç§æ“ä½œï¼Œå› ä¸ºå®ƒå¾€å¾€ä¼šä¼´éšä¸€äº›å¤æ‚çš„é™åˆ¶æ¡ä»¶ï¼Œä»¥åŠå¤šä¸ªè¡¨ç»“åˆæŸ¥è¯¢ç­‰ç­‰ã€‚</p><p>æŸ¥è¯¢è¯­å¥ä½¿ç”¨<code>query()</code>æ–¹æ³•ï¼Œå› ä¸ºå®ƒçš„å¤æ‚æ€§ï¼Œæ‰€ä»¥å‚æ•°æœ‰å¾ˆå¤šã€‚æœ€çŸ­çš„ä¸€ä¸ªæ–¹æ³•ä¹Ÿéœ€è¦ä¼ å…¥7ä¸ªå‚æ•°ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131923945.jpg"></p><p>æ‹¿ä¸ªç®€å•çš„ä¾‹å­è¯•è¯•æ‰‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    ......<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoCreateupDate</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">MyDatabaseHelper</span> <span class="hljs-variable">myDatabaseHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDatabaseHelper</span>(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;BookStore.db&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-number">3</span>);<br>        <span class="hljs-type">SQLiteDatabase</span> <span class="hljs-variable">BookDatabase</span> <span class="hljs-operator">=</span> myDatabaseHelper.getWritableDatabase();<br>        <span class="hljs-type">Cursor</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> BookDatabase.query(<span class="hljs-string">&quot;Book&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;author = ?&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;Dan Brown&quot;</span>&#125;, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> (book.moveToFirst())&#123;<br>            <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> book.getString(book.getColumnIndex(<span class="hljs-string">&quot;name&quot;</span>));<br>                <span class="hljs-type">String</span> <span class="hljs-variable">author</span> <span class="hljs-operator">=</span> book.getString(book.getColumnIndex(<span class="hljs-string">&quot;author&quot;</span>));<br>                <span class="hljs-type">int</span> <span class="hljs-variable">pages</span> <span class="hljs-operator">=</span> book.getInt(book.getColumnIndex(<span class="hljs-string">&quot;pages&quot;</span>));<br>                <span class="hljs-type">double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> book.getDouble(book.getColumnIndex(<span class="hljs-string">&quot;price&quot;</span>));<br>                Log.d(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;name: &quot;</span> + name);<br>                Log.d(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;author: &quot;</span> + author);<br>                Log.d(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;pages: &quot;</span> + pages);<br>                Log.d(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;price: &quot;</span> + price);<br>            &#125;<span class="hljs-keyword">while</span> (book.moveToNext());<br>        &#125;<br>        book.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›¸å½“äºSQLè¯­å¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> Book <span class="hljs-keyword">where</span> author <span class="hljs-operator">=</span> &quot;Dan Brown&quot;;<br></code></pre></td></tr></table></figure><p><code>moveToFirst()</code>æ–¹æ³•å°†æ•°æ®çš„æŒ‡é’ˆç§»åŠ¨åˆ°ç¬¬ä¸€è¡Œçš„ä½ç½®ï¼Œç„¶åè¿›å…¥äº†ä¸€ä¸ªå¾ªç¯å½“ä¸­ï¼Œå»éå†æŸ¥è¯¢åˆ°çš„æ¯ä¸€è¡Œæ•°æ®ã€‚åœ¨è¿™ä¸ªå¾ªç¯ä¸­å¯ä»¥<br>é€šè¿‡Cursorçš„<code>getColumnIndex()</code>æ–¹æ³•è·å–åˆ°æŸä¸€åˆ—åœ¨è¡¨ä¸­å¯¹åº”çš„ä½ç½®ç´¢å¼•ï¼Œç„¶åå°†è¿™ä¸ªç´¢å¼•ä¼ å…¥åˆ°ç›¸åº”çš„å–å€¼æ–¹æ³•ä¸­ï¼Œå°±å¯ä»¥å¾—åˆ°ä»æ•°æ®åº“ä¸­è¯»å–åˆ°çš„æ•°æ®äº†ã€‚</p><h2 id="4-7-ä½¿ç”¨SQLæ“ä½œæ•°æ®åº“"><a href="#4-7-ä½¿ç”¨SQLæ“ä½œæ•°æ®åº“" class="headerlink" title="4.7 ä½¿ç”¨SQLæ“ä½œæ•°æ®åº“"></a>4.7 ä½¿ç”¨SQLæ“ä½œæ•°æ®åº“</h2><p>å¦‚æœæˆ‘ä»¬ä¸ä¹ æƒ¯ä½¿ç”¨Androidæä¾›çš„æ–¹æ³•æ¥å¯¹æ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡ŒSQLè¯­å¥æ¥å®ç°å¯¹æ•°æ®çš„æ“ä½œã€‚</p><p>ç°åœ¨å¯¹è¿™å››ç§æ“ä½œä¸¾ä¸€äº›ä¾‹å­æ¥ç†è§£å¦‚ä½•ä½¿ç”¨ï¼ˆå‡å®šæ•°æ®åº“å¯¹è±¡ä¸ºdbï¼‰ã€‚</p><ul><li><p>æ·»åŠ æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.execSQL(&quot;insert into Book (name,author,pages,price) values(?,?,?,?)&quot;, <span class="hljs-keyword">new</span> String[]&#123;&quot;The Da Vinci Code&quot;,&quot;Dan Brown&quot;,&quot;454&quot;,&quot;16.96&quot;&#125;)<br></code></pre></td></tr></table></figure></li><li><p>è·Ÿæ–°æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.execSQL(&quot;update Book set price = ? where name = ?&quot;, <span class="hljs-keyword">new</span> string[]&#123;&quot;10.99&quot;, &quot;The Da Vinci Code&quot;&#125;);<br></code></pre></td></tr></table></figure></li><li><p>åˆ é™¤æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.execSQL(&quot;delete from Book where pages &gt; ?&quot;, <span class="hljs-keyword">new</span> String[]&#123;&quot;500&quot;&#125;);<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥è¯¢æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.rawQuery(&quot;select * from Book&quot;,<span class="hljs-keyword">null</span>);<br>rawQuery(&quot;select * from Book where author = ?&quot;, <span class="hljs-keyword">new</span> String[]&#123;&quot;Dan Brown&quot;&#125;)<br></code></pre></td></tr></table></figure></li></ul><p>ç®€è€Œè¨€ä¹‹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é€šé…SQLè¯­å¥ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¡«å……é€šé…ç¬¦çš„å€¼ï¼ˆæŒ‰é¡ºåºå¡«å†™ï¼‰ã€‚</p><h1 id="äº”ã€ä½¿ç”¨LitePalæ“ä½œæ•°æ®åº“"><a href="#äº”ã€ä½¿ç”¨LitePalæ“ä½œæ•°æ®åº“" class="headerlink" title="äº”ã€ä½¿ç”¨LitePalæ“ä½œæ•°æ®åº“"></a>äº”ã€ä½¿ç”¨LitePalæ“ä½œæ•°æ®åº“</h1><p>LitePalæ˜¯ä¸€æ¬¾å¼€æºçš„Androidæ•°æ®åº“æ¡†æ¶ï¼Œå®ƒé‡‡ç”¨äº†å¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆORMï¼‰çš„æ¨¡å¼ï¼Œå¹¶å°†æˆ‘ä»¬å¹³æ—¶å¼€å‘æœ€å¸¸ç”¨åˆ°çš„ä¸€äº›æ•°æ®åº“åŠŸèƒ½è¿›è¡Œäº†å°è£…ï¼Œä½¿å¾—ä¸ç”¨ç¼–å†™ä¸€è¡ŒSQLè¯­å¥å°±å¯ä»¥å®Œæˆå„ç§å»ºè¡¨å’Œå¢åˆ æ”¹æŸ¥çš„æ“ä½œã€‚LitePalçš„é¡¹ç›®ä¸»é¡µä¸Šä¹Ÿæœ‰è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£ï¼Œåœ°å€æ˜¯ï¼š<a href="https://github.com/guolindev/LitePal">https://github.com/guolindev/LitePal</a>ã€‚</p><h2 id="5-1-é…ç½®LitePal"><a href="#5-1-é…ç½®LitePal" class="headerlink" title="5.1 é…ç½®LitePal"></a>5.1 é…ç½®LitePal</h2><p>é‚£ä¹ˆæ€æ ·æ‰èƒ½åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å¼€æºåº“å‘¢ï¼Ÿè¿‡å»çš„æ–¹å¼æ¯”è¾ƒå¤æ‚ï¼Œé€šå¸¸éœ€è¦ä¸‹è½½å¼€æºåº“çš„ Jar åŒ…æˆ–è€…æºç ï¼Œç„¶åå†é›†æˆåˆ°æˆ‘ä»¬çš„é¡¹ç›®å½“ä¸­ã€‚è€Œç°åœ¨å°±ç®€å•å¾—å¤šäº†ï¼Œå¤§å¤šæ•°çš„å¼€æºé¡¹ç›®éƒ½ä¼šå°†ç‰ˆæœ¬æäº¤åˆ° jcenter ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ <code>app/build.gradle </code>æ–‡ä»¶ä¸­å£°æ˜è¯¥å¼€æºåº“çš„å¼•ç”¨å°±å¯ä»¥äº†ã€‚</p><p>å› æ­¤ï¼Œè¦ä½¿ç”¨LitePalçš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯ç¼–è¾‘<code>app/build.gradle</code>æ–‡ä»¶ï¼Œåœ¨dependenciesé—­åŒ…ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs clean">dependencies &#123;<br>    <span class="hljs-keyword">implementation</span> <span class="hljs-string">&#x27;org.litepal.guolindev:core:3.2.3&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ·»åŠ çš„è¿™ä¸€è¡Œå£°æ˜ä¸­ï¼Œå‰é¢éƒ¨åˆ†æ˜¯å›ºå®šçš„ï¼Œæœ€åçš„3.2.3æ˜¯ç‰ˆæœ¬å·çš„æ„æ€ï¼Œæœ€æ–°çš„ç‰ˆæœ¬å·å¯ä»¥åˆ°LitePalçš„é¡¹ç›®ä¸»é¡µä¸Šå»æŸ¥çœ‹ã€‚</p><p>æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹buildäº†ã€‚ä½†æ˜¯ä¼šæŠ¥é”™ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">Execution failed <span class="hljs-keyword">for</span> task <span class="hljs-string">&#x27;:app:mergeDebugNativeLibs&#x27;</span>.<br>&gt; Could not resolve all files <span class="hljs-keyword">for</span> configuration <span class="hljs-string">&#x27;:app:debugRuntimeClasspath&#x27;</span>.<br>   &gt; Could not find org.litepal.guolindev:core:<span class="hljs-number">3.2</span>.<span class="hljs-number">3</span>.<br>     Searched <span class="hljs-keyword">in</span> the following locations:<br>       - https:<span class="hljs-regexp">//</span>dl.google.com<span class="hljs-regexp">/dl/</span>android<span class="hljs-regexp">/maven2/</span>org<span class="hljs-regexp">/litepal/gu</span>olindev<span class="hljs-regexp">/core/</span><span class="hljs-number">3.2</span>.<span class="hljs-number">3</span>/core-<span class="hljs-number">3.2</span>.<span class="hljs-number">3</span>.pom<br>       - https:<span class="hljs-regexp">//</span>repo.maven.apache.org<span class="hljs-regexp">/maven2/</span>org<span class="hljs-regexp">/litepal/gu</span>olindev<span class="hljs-regexp">/core/</span><span class="hljs-number">3.2</span>.<span class="hljs-number">3</span>/core-<span class="hljs-number">3.2</span>.<span class="hljs-number">3</span>.pom<br>     Required by:<br>         project :app<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæŠ¥é”™å‘Šè¯‰æˆ‘ä»¬åœ¨<a href="https://dl.google.com/dl/android/maven2%E5%92%8Chttps://repo.maven.apache.org/maven2%E7%BD%91%E7%AB%99%E4%B8%8A%E6%89%BE%E4%B8%8D%E5%88%B0LitePal%E3%80%82%E4%BD%86%E9%97%AE%E9%A2%98%E6%98%AF%E6%88%91%E4%BB%AC%E6%98%8E%E6%98%8E%E7%9F%A5%E9%81%93LitePal%E5%9C%A8Github%E4%B8%8A%EF%BC%8C%E4%BD%86%E5%AE%83%E5%8D%B4%E5%9C%A8%E8%BF%99%E4%B8%A4%E4%B8%AA%E7%BD%91%E7%AB%99%E4%B8%8A%E6%9F%A5%E6%89%BE%E3%80%82%E4%B8%BA%E4%BA%86%E4%BF%AE%E6%94%B9%E5%AE%83%E7%9A%84%E4%B8%8B%E8%BD%BD%E8%B7%AF%E5%BE%84%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%9C%A8%E5%A4%96%E5%B1%82%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%60settings.gradle%60%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84">https://dl.google.com/dl/android/maven2å’Œhttps://repo.maven.apache.org/maven2ç½‘ç«™ä¸Šæ‰¾ä¸åˆ°LitePalã€‚ä½†é—®é¢˜æ˜¯æˆ‘ä»¬æ˜æ˜çŸ¥é“LitePalåœ¨Githubä¸Šï¼Œä½†å®ƒå´åœ¨è¿™ä¸¤ä¸ªç½‘ç«™ä¸ŠæŸ¥æ‰¾ã€‚ä¸ºäº†ä¿®æ”¹å®ƒçš„ä¸‹è½½è·¯å¾„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¤–å±‚ç›®å½•ä¸‹çš„`settings.gradle`æ–‡ä»¶ä¸­çš„</a> <code>repositories</code> å—ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">jcenter</span><span class="hljs-params">()</span></span><br>maven &#123; url <span class="hljs-string">&#x27;https://jitpack.io&#x27;</span> &#125;<br></code></pre></td></tr></table></figure><p>å†æ¬¡buildå°±æŠŠLitePalæˆåŠŸå¼•å…¥åˆ°å½“å‰é¡¹ç›®ä¸­äº†ï¼Œæ¥ä¸‹æ¥éœ€è¦é…ç½®litepal.xmlæ–‡ä»¶ã€‚åœ¨<code>app/src/main</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªassetsç›®å½•ï¼Œç„¶ååœ¨assetsç›®å½•ä¸‹å†æ–°å»ºä¸€ä¸ª<code>litepal.xml</code>æ–‡ä»¶ï¼ˆé€‰æ‹©Fileï¼Œå‘½åçš„æ—¶å€™åŠ æ–‡ä»¶åç¼€ï¼‰ï¼Œæ¥ç€ç¼–è¾‘<code>litepal.xml</code>æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">litepal</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    Define the database name of your application.</span><br><span class="hljs-comment">    By default each database name should be end with .db.</span><br><span class="hljs-comment">    If you didn&#x27;t name your database end with .db,</span><br><span class="hljs-comment">    LitePal would plus the suffix automatically for you.</span><br><span class="hljs-comment">    For example:</span><br><span class="hljs-comment">    &lt;dbname value=&quot;demo&quot; /&gt;</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbname</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BookStore&quot;</span> /&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    Define the version of your database. Each time you want</span><br><span class="hljs-comment">    to upgrade your database, the version tag would helps.</span><br><span class="hljs-comment">    Modify the models you defined in the mapping tag, and just</span><br><span class="hljs-comment">    make the version value plus one, the upgrade of database</span><br><span class="hljs-comment">    will be processed automatically without concern.</span><br><span class="hljs-comment">For example:</span><br><span class="hljs-comment">    &lt;version value=&quot;1&quot; /&gt;</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;3&quot;</span> /&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    Define your models in the list with mapping tag, LitePal will</span><br><span class="hljs-comment">    create tables for each mapping class. The supported fields</span><br><span class="hljs-comment">    defined in models will be mapped into columns.</span><br><span class="hljs-comment">    For example:</span><br><span class="hljs-comment">    &lt;list&gt;</span><br><span class="hljs-comment">    &lt;mapping class=&quot;com.test.model.Reader&quot; /&gt;</span><br><span class="hljs-comment">    &lt;mapping class=&quot;com.test.model.Magazine&quot; /&gt;</span><br><span class="hljs-comment">    &lt;/list&gt;</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        Define where the .db file should be. &quot;internal&quot; means the .db file</span><br><span class="hljs-comment">        will be stored in the database folder of internal storage which no</span><br><span class="hljs-comment">        one can access. &quot;external&quot; means the .db file will be stored in the</span><br><span class="hljs-comment">        path to the directory on the primary external storage device where</span><br><span class="hljs-comment">        the application can place persistent files it owns which everyone</span><br><span class="hljs-comment">        can access. &quot;internal&quot; will act as default.</span><br><span class="hljs-comment">        For example:</span><br><span class="hljs-comment">        &lt;storage value=&quot;external&quot; /&gt;</span><br><span class="hljs-comment">    --&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">litepal</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>&lt;dbname&gt;</code>æ ‡ç­¾ç”¨äºæŒ‡å®šæ•°æ®åº“åï¼Œ<code>&lt;version&gt;</code>æ ‡ç­¾ç”¨äºæŒ‡å®šæ•°æ®åº“ç‰ˆæœ¬å·ï¼Œ<code>&lt;List&gt;</code>æ ‡ç­¾ç”¨äºæŒ‡å®šæ‰€æœ‰çš„æ˜ å°„æ¨¡å‹ï¼Œæˆ‘ä»¬ç¨åå°±ä¼šç”¨åˆ°ã€‚</p><p>æœ€ååœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">application</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;org.litepal.LitePalApplication&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">...</span></span><br><span class="hljs-tag">    &gt;</span><br>        ...<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†LitePalçš„ç¯å¢ƒæ­å»ºï¼</p><h2 id="5-2-åˆ›å»ºå’Œå‡çº§æ•°æ®åº“"><a href="#5-2-åˆ›å»ºå’Œå‡çº§æ•°æ®åº“" class="headerlink" title="5.2 åˆ›å»ºå’Œå‡çº§æ•°æ®åº“"></a>5.2 åˆ›å»ºå’Œå‡çº§æ•°æ®åº“</h2><p>åˆšæ‰åœ¨ä»‹ç»çš„æ—¶å€™å·²ç»è¯´è¿‡ï¼ŒLitePalé‡‡å–çš„æ˜¯å¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆORM)çš„æ¨¡å¼ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯å¯¹è±¡å…³ç³»æ˜ å°„å‘¢ï¼Ÿç®€å•ç‚¹è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€æ˜¯é¢å‘å¯¹è±¡è¯­è¨€ï¼Œè€Œä½¿ç”¨çš„æ•°æ®åº“åˆ™æ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Œé‚£ä¹ˆå°†é¢å‘å¯¹è±¡çš„è¯­è¨€å’Œé¢å‘å…³ç³»çš„æ•°æ®åº“ä¹‹é—´å»ºç«‹ä¸€ç§æ˜ å°„å…³ç³»ï¼Œè¿™å°±æ˜¯å¯¹è±¡å…³ç³»æ˜ å°„äº†ã€‚</p><p>ä¹‹å‰ä¸ºäº†åˆ›å»ºä¸€å¼ Bookè¡¨ï¼Œéœ€è¦å…ˆåˆ†æè¡¨ä¸­åº”è¯¥åŒ…å«å“ªäº›åˆ—ï¼Œç„¶åå†ç¼–å†™å‡ºä¸€æ¡å»ºè¡¨è¯­å¥ï¼Œæœ€ååœ¨è‡ªå®šä¹‰çš„SQLiteOpenHelperä¸­å»æ‰§è¡Œè¿™æ¡å»ºè¡¨è¯­å¥ã€‚ä½†æ˜¯ä½¿ç”¨LitePalå°±å¯ä»¥ç”¨é¢å‘å¯¹è±¡çš„æ€ç»´æ¥å®ç°åŒæ ·çš„åŠŸèƒ½äº†ï¼Œå®šä¹‰ä¸€ä¸ªBookç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LitePalSupport</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String author;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pages;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Book</span><span class="hljs-params">(<span class="hljs-type">int</span> id, String author, <span class="hljs-type">double</span> price, <span class="hljs-type">int</span> pages, String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>        <span class="hljs-built_in">this</span>.author = author;<br>        <span class="hljs-built_in">this</span>.price = price;<br>        <span class="hljs-built_in">this</span>.pages = pages;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Book</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAuthor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> author;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthor</span><span class="hljs-params">(String author)</span> &#123;<br>        <span class="hljs-built_in">this</span>.author = author;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> price;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(<span class="hljs-type">double</span> price)</span> &#123;<br>        <span class="hljs-built_in">this</span>.price = price;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPages</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> pages;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPages</span><span class="hljs-params">(<span class="hljs-type">int</span> pages)</span> &#123;<br>        <span class="hljs-built_in">this</span>.pages = pages;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„Java beanï¼Œåœ¨Bookç±»ä¸­æˆ‘ä»¬å®šä¹‰äº†idã€authorã€priceã€pagesã€nameè¿™å‡ ä¸ªå­—æ®µï¼Œå¹¶ç”Ÿæˆäº†ç›¸åº”çš„getterå’Œsetteræ–¹æ³•ã€‚å­¦è¿‡java webçš„åº”è¯¥çŸ¥é“ï¼ŒBookç±»å¯¹åº”çš„æ˜¯æ•°æ®åº“ä¸­çš„Bookè¡¨ï¼Œè€Œç±»ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µåˆ†åˆ«å¯¹åº”äº†è¡¨ä¸­çš„æ¯ä¸€ä¸ªåˆ—ï¼Œè¿™å°±æ˜¯å¯¹è±¡å…³ç³»æ˜ å°„æœ€ç›´è§‚çš„ä½“éªŒã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜éœ€è¦å°†Bookç±»æ·»åŠ åˆ°æ˜ å°„æ¨¡å‹åˆ—è¡¨å½“ä¸­ï¼Œä¿®æ”¹<code>litepal.xml</code>ä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">litepal</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbname</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BookStore&quot;</span> /&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span> /&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.example.testlitepal.Book&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">litepal</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨<code>&lt;mapping/&gt;</code>æ ‡ç­¾æ¥å£°æ˜æˆ‘ä»¬è¦é…ç½®çš„æ˜ å°„æ¨¡å‹ç±»ï¼Œ<strong>æ³¨æ„ä¸€å®šè¦ä½¿ç”¨å®Œæ•´çš„ç±»å</strong>ã€‚ä¸ç®¡æœ‰å¤šå°‘æ¨¡å‹ç±»éœ€è¦æ˜ å°„ï¼Œéƒ½ä½¿ç”¨åŒæ ·çš„æ–¹å¼é…ç½®åœ¨<code>&lt;list&gt;</code>æ ‡ç­¾ä¸‹å³å¯ã€‚<br>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å·²ç»æŠŠæ‰€æœ‰å·¥ä½œéƒ½å®Œæˆäº†ï¼Œç°åœ¨åªè¦è¿›è¡Œä»»æ„ä¸€æ¬¡æ•°æ®åº“çš„æ“ä½œï¼ŒBookStore.dbæ•°æ®åº“åº”è¯¥å°±ä¼šè‡ªåŠ¨åˆ›å»ºå‡ºæ¥ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹MainActivityä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoCreateDataBase</span><span class="hljs-params">(View view)</span> &#123;<br>        LitePal.getDatabase();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Connector.getDatabase()</code>æ–¹æ³•æ˜¯ä¸€æ¬¡æœ€ç®€å•çš„æ•°æ®åº“æ“ä½œï¼Œåªè¦ç‚¹å‡»ä¸€ä¸‹æŒ‰é’®ï¼Œæ•°æ®åº“å°±ä¼šè‡ªåŠ¨åˆ›å»ºå®Œæˆäº†ã€‚è¿è¡Œä¸€ä¸‹ç¨‹åºï¼Œç„¶åç‚¹å‡»Create databaseæŒ‰é’®ï¼Œé€šè¿‡adb shellæŸ¥çœ‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131924801.jpg"></p><p>ï¼ˆä¸€ç›´åœ¨æŸ¥çœ‹BookStoreæ–‡ä»¶ï¼Œä»¥ä¸ºæ²¡åˆ›å»ºå‡ºè¡¨ï¼Œæœ€åæ‰å‘ç°åº”è¯¥æŸ¥çœ‹BookStore.dbæ–‡ä»¶ï¼ï¼ï¼ï¼‰</p><h2 id="5-3-å‡çº§æ•°æ®åº“"><a href="#5-3-å‡çº§æ•°æ®åº“" class="headerlink" title="5.3 å‡çº§æ•°æ®åº“"></a>5.3 å‡çº§æ•°æ®åº“</h2><p>åœ¨ 4.2 çš„æœ€åï¼Œæˆ‘ç•™äº†ä¸ªç–‘é—®ï¼Œå°±æ˜¯åˆ é™¤ä¹‹å‰çš„æ•°æ®åº“å¯èƒ½ä¼šé€ æˆæ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚ç„¶è€Œåœ¨LitePalä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ æˆ–è€…ä¿®æ”¹ç›®æ ‡å†…å®¹ï¼Œç„¶åå°†ç‰ˆæœ¬å· +1 å°±è¡Œäº†ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬æƒ³è¦å‘Bookè¡¨ä¸­æ·»åŠ ä¸€ä¸ªpressï¼ˆå‡ºç‰ˆç¤¾ï¼‰åˆ—ï¼Œé‚£ä¹ˆç›´æ¥åœ¨Bookç±»ä¸­æ·»åŠ ä¸€ä¸ªpresså­—æ®µå³å¯å¹¶è®¾ç½®å¥½getå’Œsetæ–¹æ³•å³å¯ï¼ˆå¦‚æœæœ‰å¸¦å‚çš„æ„é€ å‡½æ•°ï¼Œè®°å¾—åœ¨å‚æ•°ä¸­æ·»åŠ æ–°å±æ€§ï¼‰ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LitePalSupport</span> &#123;<br><br>......<br>    <span class="hljs-keyword">private</span> String press;<br><br>......<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPress</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> press;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPress</span><span class="hljs-params">(String press)</span> &#123;<br>        <span class="hljs-built_in">this</span>.press = press;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬å†æ·»åŠ ä¸€å¼ Categoryè¡¨ï¼Œé‚£ä¹ˆåªéœ€è¦åˆ›å»ºä¸€ä¸ªCategoryç±»å³å¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LitePalSupport</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String categoryName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> categoryCode;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCategoryName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> categoryName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCategoryName</span><span class="hljs-params">(String categoryName)</span> &#123;<br>        <span class="hljs-built_in">this</span>.categoryName = categoryName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCategoryCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> categoryCode;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCategoryCode</span><span class="hljs-params">(<span class="hljs-type">int</span> categoryCode)</span> &#123;<br>        <span class="hljs-built_in">this</span>.categoryCode = categoryCode;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ”¹å®Œäº†æ‰€æœ‰æˆ‘ä»¬æƒ³æ”¹çš„ä¸œè¥¿ï¼Œåªéœ€è¦è®°å¾—å°†ç‰ˆæœ¬å· +1 å°±è¡Œäº†ã€‚å½“ç„¶ç”±äºè¿™é‡Œè¿˜æ·»åŠ äº†ä¸€ä¸ªæ–°çš„æ¨¡å‹ç±»ï¼Œå› æ­¤ä¹Ÿéœ€è¦å°†å®ƒæ·»åŠ åˆ°æ˜ å°„æ¨¡å‹åˆ—è¡¨ä¸­ã€‚ä¿®æ”¹litepal.xmlä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">litepal</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbname</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BookStore&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;2&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.example.testlitepal.Book&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.example.testlitepal.Category&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">litepal</span>&gt;</span><br></code></pre></td></tr></table></figure><p>é‡æ–°è¿è¡Œç¨‹åºï¼Œç‚¹å‡»æŒ‰é’®ï¼Œé€šè¿‡æŸ¥çœ‹å¯ä»¥ç¡®è®¤æˆåŠŸäº†ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131924266.jpg"></p><p>ï¼ˆè¿™é‡Œæ˜¯å®‰è£…äº†ä¸€ä¸ªæ’ä»¶ï¼Œæ„Ÿè§‰æ›´åŠ æ–¹ä¾¿ï¼Œå¯ä»¥æŸ¥çœ‹è¡¨çš„ç»“æ„å’Œæ•°æ®ã€‚åŒå‡»æ–‡ä»¶çš„æ—¶å€™ä¼šæœ‰å¼¹çª—ï¼Œç„¶åé‚£ä¸ªæ’ä»¶å°±åœ¨é‡Œé¢ï¼Œä¸“é—¨ç”¨æ¥æ‰“å¼€æ•°æ®åº“çš„ï¼‰</p><h2 id="5-4-æ·»åŠ æ•°æ®"><a href="#5-4-æ·»åŠ æ•°æ®" class="headerlink" title="5.4 æ·»åŠ æ•°æ®"></a>5.4 æ·»åŠ æ•°æ®</h2><p><strong>å¯¹äºå¢åˆ æ”¹æ“ä½œï¼Œæ¨¡å‹ç±»å¿…é¡»è¦ç»§æ‰¿LitePalSupportç±»æ‰è¡Œã€‚</strong>ä¹‹åæˆ‘ä»¬åªéœ€è¦åˆ›å»ºå‡ºæ¨¡å‹ç±»çš„å®ä¾‹ï¼Œå†å°†æ‰€æœ‰è¦å­˜å‚¨çš„æ•°æ®è®¾ç½®å¥½ï¼Œæœ€åè°ƒç”¨ä¸€ä¸‹<code>save()</code>æ–¹æ³•å°±å¯ä»¥äº†ã€‚</p><p>å¥½åœ¨æˆ‘ä»¬å†™çš„ä»£ç å·²ç»ç»§æ‰¿äº†ï¼Œæ‰€ä»¥ä»£ç ç›´æ¥å¤ç”¨å°±è¡Œã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹MainActivityä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>......<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoAddData</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-comment">//åˆ›å»ºå®ä½“ç±»</span><br>        <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>();<br>        <span class="hljs-comment">//è®¾ç½®å±æ€§å€¼</span><br>        book.setName(<span class="hljs-string">&quot;The Da Vinci Code&quot;</span>);<br>        book.setAuthor(<span class="hljs-string">&quot;Dan Brown&quot;</span>);<br>        book.setPages(<span class="hljs-number">454</span>);<br>        book.setPrice(<span class="hljs-number">16.92</span>);<br>        book.setPress(<span class="hljs-string">&quot;Unknow&quot;</span>);<br>        <span class="hljs-comment">//å‘Bookè¡¨ä¸­æ·»åŠ æ•°æ®</span><br>        book.save();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ„é€ å‡½æ•°è®¾ç½®å±æ€§å€¼ã€‚é‡æ–°è¿è¡Œç¨‹åºï¼Œå¯ä»¥å‘ç°æ•°æ®æ·»åŠ æˆåŠŸã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131925366.jpg"></p><h2 id="5-5-æ›´æ–°æ•°æ®"><a href="#5-5-æ›´æ–°æ•°æ®" class="headerlink" title="5.5 æ›´æ–°æ•°æ®"></a>5.5 æ›´æ–°æ•°æ®</h2><p>æ›´æ–°æ•°æ®è¦æ¯”æ·»åŠ æ•°æ®ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºå®ƒçš„APIæ¥å£æ¯”è¾ƒå¤šï¼Œè¿™é‡Œæˆ‘ä»¬åªä»‹ç»æœ€å¸¸ç”¨çš„å‡ ç§æ›´æ–°æ–¹å¼ã€‚</p><p>é¦–å…ˆï¼Œæœ€ç®€å•çš„ä¸€ç§æ›´æ–°æ–¹å¼å°±æ˜¯å¯¹æ•°æ®åº“ä¸­<strong>å·²å­˜å‚¨çš„å¯¹è±¡</strong>é‡æ–°è®¾å€¼ï¼Œç„¶åé‡æ–°è°ƒç”¨<code>save()</code>æ–¹æ³•å³å¯ã€‚ä¾‹å­å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoUpData</span><span class="hljs-params">(View view)</span> &#123;<br><span class="hljs-comment">//åœ¨Bookè¡¨ä¸­æ‰¾åˆ°idä¸º1çš„è®°å½•</span><br>        <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> LitePal.find(Book.class,<span class="hljs-number">1</span>)<br><span class="hljs-comment">//è®¾ç½®è¦ä¿®æ”¹çš„å€¼</span><br>        book.setPrice(<span class="hljs-number">10.99</span>);<br>    <span class="hljs-comment">//æäº¤</span><br>        book.save();<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>LitePal.find(model.class,id)</code>æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¡¨å¯¹åº”çš„ç±»ï¼Œç¬¬äºŒä¸ªä¸ºè¦æ›´æ–°çš„è®°å½•çš„idã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨<code>model.update(id)</code>æˆ–<code>model.updateAll(conditions)</code>æ–¹æ³•ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoUpData</span><span class="hljs-params">(View view)</span> &#123;<br><br>        <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>();<br><br>        book.setPrice(<span class="hljs-number">9.99</span>);<br>        book.setPress(<span class="hljs-string">&quot;Anchor&quot;</span>);<br><span class="hljs-comment">//æ›´æ–°id=1çš„è®°å½•</span><br>        book.update(<span class="hljs-number">1</span>);<br><span class="hljs-comment">//æ›´æ–°é¡µæ•°ä¸º510é¡µçš„è®°å½•</span><br>book.updateAll(<span class="hljs-string">&quot;pages = ?&quot;</span>,<span class="hljs-string">&quot;510&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>update()</code>æ–¹æ³•æŒ‡å®šidå³å¯ï¼Œ<code>updateAll()</code>æ–¹æ³•å¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªçº¦æŸæ¡ä»¶ï¼Œå¦‚æœä¸æŒ‡å®šæ¡ä»¶è¯­å¥çš„è¯ï¼Œå°±è¡¨ç¤ºæ›´æ–°æ‰€æœ‰æ•°æ®ã€‚</p><p>å½“ä½ æƒ³æŠŠä¸€ä¸ªå­—æ®µçš„å€¼æ›´æ–°æˆé»˜è®¤å€¼æ—¶ï¼Œæ˜¯ä¸å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼æ¥è®¾ç½®æ•°æ®çš„ã€‚åœ¨Javaä¸­ä»»ä½•ä¸€ç§æ•°æ®ç±»å‹çš„å­—æ®µéƒ½ä¼šæœ‰é»˜è®¤å€¼ï¼Œå½“æˆ‘ä»¬newå‡ºä¸€ä¸ªBookå¯¹è±¡æ—¶ï¼Œå…¶å®æ‰€æœ‰å­—æ®µéƒ½å·²ç»è¢«åˆè¯†åŒ–æˆé»˜è®¤å€¼äº†ï¼Œæ¯”å¦‚pagesé»˜è®¤ä¸º0ï¼Œå› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æŠŠæ•°æ®åº“è¡¨ä¸­çš„pagesåˆ—æ›´æ–°æˆ0ï¼Œç›´æ¥è°ƒç”¨<code>book.setPages(0)</code>æ˜¯ä¸å¯ä»¥çš„ï¼Œå› ä¸ºå³ä½¿ä¸è°ƒç”¨è¿™è¡Œä»£ç ï¼Œpageså­—æ®µæœ¬èº«ä¹Ÿæ˜¯0ï¼ŒLitePalæ­¤æ—¶æ˜¯ä¸ä¼šå¯¹è¿™ä¸ªåˆ—è¿›è¡Œæ›´æ–°çš„ã€‚</p><p>å¯¹äºå°†æ•°æ®æ›´æ–°æˆé»˜è®¤å€¼çš„æ“ä½œï¼ŒLitePalç»Ÿä¸€æä¾›äº†ä¸€ä¸ª<code>setToDefault()</code>æ–¹æ³•ï¼Œç„¶åä¼ å…¥ç›¸åº”çš„åˆ—åå°±å¯ä»¥äº†å®ç°äº†ã€‚<br>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>();<br>book.setToDefault(<span class="hljs-string">&quot;pages&quot;</span>);<br>book.updateAll();<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œå°†æ‰€æœ‰ä¹¦çš„é¡µæ•°éƒ½æ›´æ–°ä¸º0ï¼Œå› ä¸º<code>updateAll()</code>æ–¹æ³•ä¸­æ²¡æœ‰æŒ‡å®šçº¦æŸæ¡ä»¶ï¼Œå› æ­¤æ›´æ–°æ“ä½œå¯¹æ‰€æœ‰æ•°æ®éƒ½ç”Ÿæ•ˆäº†ã€‚</p><h2 id="5-6-åˆ é™¤æ•°æ®"><a href="#5-6-åˆ é™¤æ•°æ®" class="headerlink" title="5.6 åˆ é™¤æ•°æ®"></a>5.6 åˆ é™¤æ•°æ®</h2><p>åˆ é™¤æ•°æ®æœ‰ä¸¤ç§æ–¹æ³•ï¼š<code>LitePal.delete(model.class,id)</code>æ–¹æ³•å’Œ<code>LitePal.deleteAll(model.class,conditions)</code>æ–¹æ³•ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoCreateDataBase</span><span class="hljs-params">(View view)</span> &#123;<br><span class="hljs-comment">//åˆ é™¤Bookè¡¨ä¸­id=1çš„è®°å½•</span><br>    LitePal.delete(Book.class, <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//åˆ é™¤Bookè¡¨ä¸­name = &quot;Dan Brown&quot;çš„è®°å½•</span><br>    LitePal.deleteAll(Book.class, <span class="hljs-string">&quot;name = ?&quot;</span> , <span class="hljs-string">&quot;Dan Brown&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-7æŸ¥è¯¢æ•°æ®"><a href="#5-7æŸ¥è¯¢æ•°æ®" class="headerlink" title="5.7æŸ¥è¯¢æ•°æ®"></a>5.7æŸ¥è¯¢æ•°æ®</h2><p>å¯¹äºæŸ¥è¯¢æ•°æ®ï¼ŒLitePalæä¾›äº†<code>find()</code>ã€<code>findAll()</code>ã€<code>select()</code>ã€<code>where()</code>ã€<code>order()</code>ã€<code>limit()</code>ã€<code>offset()</code>æ–¹æ³•è¿›è¡Œç»„åˆæŸ¥è¯¢ï¼Œ</p><ul><li><p><code>select()</code>ï¼šç”¨äºæŒ‡å®šæŸ¥è¯¢å“ªå‡ åˆ—çš„æ•°æ®ï¼Œå¯¹åº”äº†SQLå½“ä¸­çš„selectå…³é”®å­—ã€‚æ¯”å¦‚åªæŸ¥nameå’Œauthorè¿™ä¸¤åˆ—çš„æ•°æ®ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Book&gt; books = LitePal.select(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;author&quot;</span>).find(Book.class); <br></code></pre></td></tr></table></figure></li><li><p><code>where()</code>æ–¹æ³•ï¼šç”¨äºæŒ‡å®šæŸ¥è¯¢çš„çº¦æŸæ¡ä»¶ï¼Œå¯¹åº”äº†SQLå½“ä¸­çš„whereå…³é”®å­—ã€‚æ¯”å¦‚åªæŸ¥é¡µæ•°å¤§äº400çš„æ•°æ®ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Book&gt; books = LitePal.where(<span class="hljs-string">&quot;pages &gt; ?&quot;</span>,<span class="hljs-string">&quot;400&quot;</span>).find(Book.class);<br></code></pre></td></tr></table></figure></li><li><p><code>order()</code>æ–¹æ³•ï¼šç”¨äºæŒ‡å®šç»“æœçš„æ’åºæ–¹å¼ï¼Œå¯¹åº”äº†SQLå½“ä¸­çš„order byå…³é”®å­—ã€‚æ¯”å¦‚å°†æŸ¥è¯¢ç»“æœæŒ‰ç…§ä¹¦ä»·ä»é«˜åˆ°ä½æ’åºï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Book&gt; books = LitePal.order(<span class="hljs-string">&quot;price desc&quot;</span>).find(Book.class);<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>desc</code>è¡¨ç¤ºé™åºæ’åˆ—ï¼Œ<code>asc</code>æˆ–è€…ä¸å†™è¡¨ç¤ºå‡åºæ’åˆ—ã€‚</p></li><li><p><code>limit()</code>æ–¹æ³•ï¼šç”¨äºæŒ‡å®šæŸ¥è¯¢ç»“æœçš„æ•°é‡ï¼Œæ¯”å¦‚åªæŸ¥è¡¨ä¸­çš„å‰3æ¡æ•°æ®ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Book&gt; books = LitePal.limit(<span class="hljs-number">3</span>).find(Book.class);<br></code></pre></td></tr></table></figure></li><li><p><code>offset()</code>æ–¹æ³•ï¼šç”¨äºæŒ‡å®šæŸ¥è¯¢ç»“æœçš„åç§»é‡ï¼Œæ¯”å¦‚æŸ¥è¯¢è¡¨ä¸­çš„ç¬¬2æ¡ã€ç¬¬3æ¡ã€ç¬¬4æ¡æ•°æ®ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Book&gt; books = LitePal.limit(<span class="hljs-number">3</span>).offset(<span class="hljs-number">1</span>).find(Book.class);<br></code></pre></td></tr></table></figure><p>ç”±äº<code>limit(3)</code>æŸ¥è¯¢åˆ°çš„æ˜¯å‰3æ¡æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬å†åŠ ä¸Š<code>offset(1)</code>è¿›è¡Œä¸€ä¸ªä½ç½®çš„åç§»ï¼Œå°±èƒ½å®ç°æŸ¥è¯¢ç¬¬2æ¡ã€ç¬¬3æ¡ã€ç¬¬4æ¡æ•°æ®çš„åŠŸèƒ½äº†ã€‚<code>limit()</code>å’Œ<code>offset()</code>æ–¹æ³•å…±åŒå¯¹åº”äº†SQLå½“ä¸­çš„limitå…³é”®å­—ã€‚</p></li></ul><p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹è¿™5ä¸ªæ–¹æ³•è¿›è¡Œä»»æ„çš„è¿ç¼€ç»„åˆï¼Œæ¥å®Œæˆä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„æŸ¥è¯¢æ“ä½œï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//æŸ¥æ‰¾å•æ¡è®°å½•</span><br><span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> LitePal.find(Book.class, <span class="hljs-number">1</span>);<br><span class="hljs-comment">//æŸ¥æ‰¾æ‰€æœ‰è®°å½•</span><br>List&lt;Book&gt; booklist = LitePal.findAll(Book.class);<br><span class="hljs-comment">//æŸ¥è¯¢Bookè¡¨ä¸­ç¬¬11~20æ¡æ»¡è¶³é¡µæ•°å¤§äº400è¿™ä¸ªæ¡ä»¶çš„nameã€authorå’Œpagesè¿™3åˆ—æ•°æ®ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœæŒ‰ç…§é¡µæ•°å‡åºæ’åˆ—ã€‚</span><br>List&lt;Book&gt; booklist = LitePal.select(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;author&quot;</span>,<span class="hljs-string">&quot;pages&quot;</span>)<br>    .where(<span class="hljs-string">&quot;pages &gt; ?&quot;</span>, <span class="hljs-string">&quot;400&quot;</span>)<br>                    .order(<span class="hljs-string">&quot;pages&quot;</span>)<br>                    .limit(<span class="hljs-number">10</span>)<br>           .offset(<span class="hljs-number">10</span>)<br>           .find(Book.class);<br></code></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼ŒLitePalä»ç„¶æ”¯æŒä½¿ç”¨åŸç”Ÿçš„SQLæ¥è¿›è¡ŒæŸ¥è¯¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Cursor</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> LitePal.findBySQL(<span class="hljs-string">&quot;select * from Book where pages &gt; ? and price &lt; ?&quot;</span>,<span class="hljs-string">&quot;400&quot;</span>,<span class="hljs-string">&quot;20&quot;</span>ï¼‰;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>LitePal.findBySQL()</code>æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ç”¨äºæŒ‡å®šSQLè¯­å¥ï¼Œåé¢çš„å‚æ•°ç”¨äºæŒ‡å®šå ä½ç¬¦çš„å€¼ã€‚æ³¨æ„<code>findBySQL()</code>æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªCursorå¯¹è±¡ï¼Œæ¥ä¸‹æ¥è¿˜éœ€è¦é€šè¿‡ä¹‹å‰æ‰€å­¦çš„è€æ–¹å¼å°†æ•°æ®ä¸€ä¸€å–å‡ºæ‰è¡Œã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå¼€å‘å­¦ä¹ ç¬”è®°(å…­) â€”â€” é‡æ¸©BroadcastReceiver</title>
    <link href="/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%AD)%20%E2%80%94%E2%80%94%20%E9%87%8D%E6%B8%A9BroadcastReceiver/"/>
    <url>/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%AD)%20%E2%80%94%E2%80%94%20%E9%87%8D%E6%B8%A9BroadcastReceiver/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯BroadcastReceiver"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯BroadcastReceiver" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯BroadcastReceiver"></a>ä¸€ã€ä»€ä¹ˆæ˜¯BroadcastReceiver</h1><p>å¹¿æ’­ï¼ˆBroadcastï¼‰æ˜¯ä¸€ç§å¹¿æ³›è¿ç”¨çš„åœ¨åº”ç”¨ç¨‹åºä¹‹é—´ä¼ è¾“ä¿¡æ¯çš„æœºåˆ¶ã€‚è€Œå¹¿æ’­æ¥æ”¶å™¨ï¼ˆBroadcastReceiverï¼‰æ˜¯Androidå››å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œç”¨äºå¯¹å‘é€å‡ºæ¥çš„å¹¿æ’­è¿›è¡Œè¿‡æ»¤æ¥å—å¹¶å“åº”çš„ä¸€ç±»ç»„ä»¶ã€‚å®ƒå…è®¸åº”ç”¨ç¨‹åºåœ¨æŸäº›äº‹ä»¶å‘ç”Ÿæ—¶ä½œå‡ºå“åº”ï¼Œæ— è®ºåº”ç”¨æ˜¯å¦åœ¨å‰å°è¿è¡Œã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯åŸºäºå‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€‚åº”ç”¨ç¨‹åºå¯ä»¥é€‰æ‹©æ³¨å†Œæ„Ÿå…´è¶£çš„å¹¿æ’­æ¶ˆæ¯ï¼Œå¹¶åœ¨æ¶ˆæ¯åˆ°è¾¾æ—¶è¿›è¡Œå“åº”ã€‚è¿™ç§æœºåˆ¶ä½¿å¾—ä¸åŒçš„åº”ç”¨ç¨‹åºä¹‹é—´èƒ½å¤Ÿå®ç°é€šä¿¡å’Œåä½œï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†ä¸€ç§ç³»ç»Ÿçº§åˆ«çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ã€‚å¹¿æ’­æ¥æ”¶å™¨åœ¨ Android å¼€å‘ä¸­éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥ç”¨äºå®ç°å¾ˆå¤šåŠŸèƒ½ï¼Œå¦‚æ¥æ”¶æ¥ç”µæˆ–çŸ­ä¿¡æé†’ã€å¤„ç†ç½‘ç»œçŠ¶æ€å˜åŒ–ã€ç›‘å¬ç³»ç»Ÿäº‹ä»¶ç­‰ã€‚</p><h2 id="1-1-æ ‡å‡†å¹¿æ’­å’Œæœ‰åºå¹¿æ’­"><a href="#1-1-æ ‡å‡†å¹¿æ’­å’Œæœ‰åºå¹¿æ’­" class="headerlink" title="1.1 æ ‡å‡†å¹¿æ’­å’Œæœ‰åºå¹¿æ’­"></a>1.1 æ ‡å‡†å¹¿æ’­å’Œæœ‰åºå¹¿æ’­</h2><ol><li><p><strong>æ ‡å‡†å¹¿æ’­</strong></p><p>å®Œå…¨å¼‚æ­¥æ‰§è¡Œçš„å¹¿æ’­ï¼Œæ‰€æœ‰çš„æ¥æ”¶è€…å‡ ä¹åŒæ—¶æ¥æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ã€‚è¿™ç§å¹¿æ’­ä¸ä¿è¯æ¥æ”¶è€…èƒ½å¤ŸåŒæ—¶å¤„ç†å¹¿æ’­ï¼Œä¹Ÿä¸èƒ½ä¿è¯æ¥æ”¶è€…æŒ‰ç…§ç‰¹å®šçš„é¡ºåºæ¥æ”¶åˆ°å¹¿æ’­ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131921764.jpg"></p></li><li><p><strong>æœ‰åºå¹¿æ’­</strong></p><p>åŒæ­¥æ‰§è¡Œçš„ä¸€ç§å¹¿æ’­ï¼Œå‘å‡ºå¹¿æ’­åï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå¹¿æ’­æ¥æ”¶è€…èƒ½æ”¶åˆ°ï¼Œå½“è¿™ä¸ªå¹¿æ’­æ¥æ”¶è€…çš„é€»è¾‘æ‰§è¡Œå®Œåï¼Œå¹¿æ’­æ‰ä¼šç»§ç»­ä¼ é€’ã€‚å½“ç„¶ï¼Œå‰é¢çš„æ¥å—è€…è¿˜å¯ä»¥æˆªæ–­å¹¿æ’­çš„ç»§ç»­ä¼ é€’ï¼Œé‚£ä¹ˆåç»­æ¥å—è€…å°±æ— æ³•æ”¶åˆ°å¹¿æ’­ä¿¡æ¯äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131921064.jpg"></p></li></ol><h2 id="é™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œ"><a href="#é™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œ" class="headerlink" title="é™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œ"></a>é™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œ</h2><p>ä¸åŒäºå…¶ä»–ä¸‰å¤§ç»„ä»¶ï¼Œå¹¿æ’­æ¥æ”¶å™¨æ—¢å¯ä»¥åœ¨<code>AndroidManifest.xml</code>ä¸­è¿›è¡Œé™æ€æ³¨å†Œï¼Œä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­è¿›è¡ŒåŠ¨æ€æ³¨å†Œã€‚</p><ol><li><p>é™æ€æ³¨å†Œ</p><p>åœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œã€‚</p><p>é™æ€æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸è®¾å¤‡å…±å­˜äº¡ï¼Œå¯ä»¥è®©åº”ç”¨åœ¨æœªè¿è¡Œæ—¶ä¹Ÿèƒ½æ¥æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ã€‚</p></li><li><p>åŠ¨æ€æ³¨å†Œ</p><p>åœ¨ä»£ç ä¸­ä½¿ç”¨<code>registerReceiver()</code>è¿›è¡Œæ³¨å†Œï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™è°ƒç”¨ <code>unregisterReceiver()</code> æ–¹æ³•è¿›è¡Œè§£æ³¨å†Œã€‚</p><p>åŠ¨æ€æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸æ³¨å†Œå®ƒçš„Activityå…±å­˜äº¡ï¼Œåªæœ‰å½“åº”ç”¨å¤„äºè¿è¡ŒçŠ¶æ€æ—¶ï¼Œæ¥æ”¶å™¨æ‰ä¼šæ¥æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ã€‚</p></li></ol><h1 id="äºŒã€BroadcastReceiverçš„åŸºæœ¬ä½¿ç”¨"><a href="#äºŒã€BroadcastReceiverçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="äºŒã€BroadcastReceiverçš„åŸºæœ¬ä½¿ç”¨"></a>äºŒã€BroadcastReceiverçš„åŸºæœ¬ä½¿ç”¨</h1><h2 id="2-1-é™æ€æ³¨å†Œæ¥æ”¶å¼€æœºå¹¿æ’­"><a href="#2-1-é™æ€æ³¨å†Œæ¥æ”¶å¼€æœºå¹¿æ’­" class="headerlink" title="2.1 é™æ€æ³¨å†Œæ¥æ”¶å¼€æœºå¹¿æ’­"></a>2.1 é™æ€æ³¨å†Œæ¥æ”¶å¼€æœºå¹¿æ’­</h2><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª<code>BootCompleteReceiver</code>ç±»ï¼Œé‡å†™<code>onReceive()</code>æ–¹æ³•ï¼Œè¿›è¡Œç®€å•çš„å¼¹çª—æç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BootCompleteReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_BOOT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;android.intent.action.BOOT_COMPLETED&quot;</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br>        <span class="hljs-keyword">if</span> (ACTION_BOOT.equals(intent.getAction()))<br>            Toast.makeText(context, <span class="hljs-string">&quot;å¼€æœºå®Œæ¯•~&quot;</span>, Toast.LENGTH_LONG).show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯é™æ€æ³¨å†Œï¼Œæ‰€ä»¥éœ€è¦åœ¨<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">receiver</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.BootCompleteReceiver&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span> = <span class="hljs-string">&quot;android.intent.cation.BOOT_COMPLETED&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">receiver</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å½“è®¾å¤‡å¯åŠ¨å®Œæˆåï¼Œå¹¿æ’­æ¥æ”¶å™¨å°±ä¼šæ”¶åˆ°åä¸º <code>android.intent.action.BOOT_COMPLETED</code> çš„å¹¿æ’­ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„é€»è¾‘æ“ä½œã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜è¦ç»™åº”ç”¨æ·»åŠ æƒé™ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸»æ´»åŠ¨ä¸­ä¸éœ€è¦æ·»åŠ ä»»ä½•ä»£ç ã€‚</p><h2 id="2-2-åŠ¨æ€æ³¨å†Œç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–"><a href="#2-2-åŠ¨æ€æ³¨å†Œç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–" class="headerlink" title="2.2 åŠ¨æ€æ³¨å†Œç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–"></a>2.2 åŠ¨æ€æ³¨å†Œç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–</h2><p>ä»¥ç›‘å¬ç½‘ç»œå˜åŒ–ä¸ºä¾‹ï¼Œè®²è§£å¦‚ä½•åŠ¨æ€æ³¨å†Œå¹¿æ’­æ¥æ”¶è€…ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code>BroadcastReceiver</code>ç±»ï¼Œé‡å†™çˆ¶ç±»çš„<code>onReceive()</code>æ–¹æ³•æ¥å®ç°ç½‘ç»œå˜åŒ–ååŠ¨ä½œï¼ˆæ¯”å¦‚å¼¹çª—æç¤ºå•¥çš„ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br>        Toast.makeText(context, <span class="hljs-string">&quot;ç½‘ç»œçŠ¶æ€å‘ç”Ÿæ”¹å˜&quot;</span>, Toast.LENGTH_SHORT).show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå†ä¸»æ´»åŠ¨ä¸­åŠ¨æ€æ³¨å†Œè¯¥å¹¿æ’­æ¥æ”¶è€…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> NetworkReceiver networkReceiver;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><span class="hljs-comment">//å®ä¾‹åŒ–å¹¿æ’­æ¥æ”¶è€…</span><br>        networkReceiver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkReceiver</span>();<br>        <span class="hljs-comment">//æ·»åŠ æ„å›¾ä¸ºç½‘ç»œçŠ¶æ€æ”¹å˜</span><br>        <span class="hljs-type">IntentFilter</span> <span class="hljs-variable">intentFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntentFilter</span>();<br>        intentFilter.addAction(<span class="hljs-string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span>);<br><span class="hljs-comment">//ä½¿ç”¨registerReceiver()åŠ¨æ€æ³¨å†Œå¹¿æ’­æ¥æ”¶è€…</span><br>        registerReceiver(networkReceiver, intentFilter);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        unregisterReceiver(networkReceiver);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç½‘ç»œçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç³»ç»Ÿä¼šå‘å‡ºä¸€æ¡å€¼ä¸º<code>android.net.conn.CONNECTIVITY_CHANGE</code>çš„å¹¿æ’­ï¼Œå› ä¸ºæˆ‘ä»¬çš„å¹¿æ’­æ¥æ”¶å™¨éœ€è¦ç›‘å¬è¿™ä¸ªå¹¿æ’­ï¼Œæ‰€ä»¥actionå°±è®¾ç½®æ­¤å€¼ã€‚</p><p>æœ€åï¼Œä¸è¦å¿˜è®°å°†å¹¿æ’­æ¥æ”¶å™¨å–æ¶ˆæ³¨å†Œã€‚åŠ¨æ€æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸æ´»åŠ¨å…±å­˜äº¡ï¼Œæ‰€ä»¥é‡å†™æ´»åŠ¨çš„<code>onDestroy()</code>æ–¹æ³•ï¼Œè°ƒç”¨<code>unregisterReceiver()</code>æ–¹æ³•æ¥å®ç°ã€‚</p><h2 id="2-3-å‘é€è‡ªå®šä¹‰å¹¿æ’­"><a href="#2-3-å‘é€è‡ªå®šä¹‰å¹¿æ’­" class="headerlink" title="2.3 å‘é€è‡ªå®šä¹‰å¹¿æ’­"></a>2.3 å‘é€è‡ªå®šä¹‰å¹¿æ’­</h2><p>ä¸Šé¢ä¸¤ä¸ªæ¡ˆä¾‹éƒ½æ˜¯è®²å¦‚ä½•æ¥æ”¶å¹¿æ’­ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•å‘é€å¹¿æ’­ã€‚åœ¨å‰é¢å·²ç»ä»‹ç»è¿‡ï¼Œå¹¿æ’­ä¸»è¦åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šæ ‡å‡†å¹¿æ’­å’Œæœ‰åºå¹¿æ’­ã€‚é‚£ä¹ˆè¿™ä¸¤ç§å¹¿æ’­å¦‚ä½•å‘é€å‘¢ï¼Ÿ</p><h3 id="2-3-1-å‘é€æ ‡å‡†å¹¿æ’­"><a href="#2-3-1-å‘é€æ ‡å‡†å¹¿æ’­" class="headerlink" title="2.3.1 å‘é€æ ‡å‡†å¹¿æ’­"></a>2.3.1 å‘é€æ ‡å‡†å¹¿æ’­</h3><p>åœ¨å‘é€å¹¿æ’­å‰ï¼Œæˆ‘ä»¬ä»ç„¶è¦å®šä¹‰ä¸€ä¸ªå¹¿æ’­æ¥æ”¶å™¨æ¥æ¥æ”¶æˆ‘ä»¬å‘é€çš„å¹¿æ’­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBroadcastReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br>        Log.d(<span class="hljs-string">&quot;MyBroadcastReceiver&quot;</span>, <span class="hljs-string">&quot;Received&quot;</span>);<br>        Toast.makeText(context, <span class="hljs-string">&quot;MyBroadcastReceiver received&quot;</span>, Toast.LENGTH_SHORT).show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>AndroidManifest.xml</code>ä¸­è¿›è¡Œæ³¨å†Œã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">receiver</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.MyBroadcastReceiver&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">android:enabled</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--è‡ªå®šä¹‰ä¸€ä¸ªåŠ¨ä½œ--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">receiver</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨ä¸»æ´»åŠ¨çš„xmlä¸­å®šä¹‰ä¸€ä¸ªæŒ‰é’®ï¼Œç”¨æ¥å‘é€å¹¿æ’­ã€‚æœ€åæ˜¯<code>MainActivity.java</code>ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> NetworkReceiver networkReceiver;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendBroadcast</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);<br>        <span class="hljs-comment">//SDKç‰ˆæœ¬ &gt; 26éœ€è¦æ·»åŠ </span><br>        <span class="hljs-comment">//intent.addFlags(0x01000000);</span><br>        sendBroadcast(intent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸæœ¬åˆ°è¿™é‡Œå°±å¯ä»¥å®ç°åŠŸèƒ½äº†ã€‚ä½†æ˜¯æˆ‘è¿™é‡Œå‡ºäº†ç‚¹å°æ’æ›²ã€‚ç‚¹å‡»æŒ‰é’®åï¼Œæ²¡æœ‰ååº”ï¼Œè€Œä¸”Logcatä¸­æç¤ºï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Background execution <span class="hljs-keyword">not</span> allowed: receiving Intent &#123; <span class="hljs-attribute">act</span>=com.example.broadcasttest.MY_BROADCAST <span class="hljs-attribute">flg</span>=0x2010 &#125; <span class="hljs-keyword">to</span> com.example.testbroadcastreceiver/.MyBroadcastReceiver<br></code></pre></td></tr></table></figure><p>åŸå› æ˜¯è‡ª Android 8.0ï¼ˆAPI çº§åˆ« 26ï¼‰èµ·ï¼ŒAndroid å¼•å…¥äº†åå°æ‰§è¡Œé™åˆ¶ï¼Œä»¥æé«˜è®¾å¤‡æ€§èƒ½å’Œå®‰å…¨æ€§ã€‚è¿™æ„å‘³ç€åœ¨åå°è¿è¡Œçš„åº”ç”¨ç¨‹åºå°†æ— æ³•æ¥æ”¶åˆ°å¤§å¤šæ•°éšå¼å¹¿æ’­ï¼Œé™¤éåº”ç”¨ç¨‹åºå¤„äºå‰å°æˆ–å…·æœ‰å‰å°æœåŠ¡ã€‚</p><p>è§£å†³æ–¹æ³•ï¼š</p><ol><li><p>ä»ç„¶ä½¿ç”¨é™æ€æ³¨å†Œå¹¿æ’­ï¼Œç»™Intentæ·»åŠ <code>FLAG_RECEIVER_INCLUDE_BACKGROUND</code>çš„Flagï¼Œä¸è¿‡è¿™ä¸ªæ ‡å¿—ä½åœ¨æºç ä¸­è¢«hideæ‰äº†ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªå±æ€§å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">intent.addFlags(<span class="hljs-number">0x01000000</span>);<br></code></pre></td></tr></table></figure></li><li><p>ä»ç„¶ä½¿ç”¨é™æ€æ³¨å†Œå¹¿æ’­ï¼Œä½†å°†åŸæ¥çš„éšå¼Intentå˜æˆæ˜¾å¼Intentï¼Œå³æŒ‡å®šåŒ…åã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,MyBroadcastReceiver.class);<br>sendBroadcast(intent);<br></code></pre></td></tr></table></figure></li><li><p>ä»ç„¶ä½¿ç”¨é™æ€æ³¨å†Œå¹¿æ’­ï¼Œä½†å°†å¹¿æ’­æ¥æ”¶å™¨æ”¹ä¸ºå‰å°æœåŠ¡ã€‚</p></li><li><p>é™ä½SDKç‰ˆæœ¬ã€‚</p></li><li><p>åœ¨<code>AndroidManifest.xml</code>ä¸­åˆ é™¤æ³¨å†Œï¼Œä½¿ç”¨åŠ¨æ€æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ï¼Œå‘é€å¹¿æ’­çš„ä»£ç ä¸å˜ã€‚</p></li></ol><h3 id="2-3-2-å‘é€æœ‰åºå¹¿æ’­"><a href="#2-3-2-å‘é€æœ‰åºå¹¿æ’­" class="headerlink" title="2.3.2 å‘é€æœ‰åºå¹¿æ’­"></a>2.3.2 å‘é€æœ‰åºå¹¿æ’­</h3><p>å¦å¤–åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼ŒåŒæ ·æ¥æ”¶<code>com.example.broadcasttest.MY_BROADCAST</code>çš„å¹¿æ’­æ¶ˆæ¯ï¼ŒåŒæ ·å¼¹çª—æ˜¾ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br>        Toast.makeText(context, <span class="hljs-string">&quot;å¦ä¸€ä¸ªåº”ç”¨çš„é™æ€å¹¿æ’­æ¥æ”¶å™¨æ”¶åˆ°è¯¥å¹¿æ’­&quot;</span>, Toast.LENGTH_SHORT).show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®°å¾—åœ¨<code>AndroidManifest.xml</code>ä¸­æ³¨å†Œï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">receiver</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.example.testanotherbroadcastreceiver.MyReceiver&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">receiver</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°†å…¶å®‰è£…åˆ°æµ‹è¯•æœºä¸Šã€‚</p><p>å‘é€æœ‰åºå¹¿æ’­çš„ä»£ç åœ¨ä¸Š 2.3.1 çš„åŸºç¡€ä¸Šï¼Œåªéœ€è¦å°†<code>sendBroadcast(intnet)</code>æ–¹æ³•æ”¹ä¸º<code>sendOrderedBroadcast(intent,receiverPermission )</code>æ–¹æ³•å³å¯ã€‚å…¶ä¸­å‚æ•°<code>receiverPermission </code>æ˜¯ä¸€ä¸ªä¸æƒé™æœ‰å…³çš„å­—ç¬¦ä¸²ï¼Œè¿™é‡Œä¼ å…¥ null å°±è¡Œäº†ã€‚</p><p>ç‚¹å‡»å‘é€æŒ‰é’®å¯ä»¥çœ‹åˆ°ä¾æ¬¡å‡ºç°ä¸¤ä¸ªå¼¹çª—ã€‚</p><h4 id="a-è®¾ç½®å¹¿æ’­æ¥æ”¶å™¨çš„ä¼˜å…ˆçº§"><a href="#a-è®¾ç½®å¹¿æ’­æ¥æ”¶å™¨çš„ä¼˜å…ˆçº§" class="headerlink" title="a. è®¾ç½®å¹¿æ’­æ¥æ”¶å™¨çš„ä¼˜å…ˆçº§"></a>a. è®¾ç½®å¹¿æ’­æ¥æ”¶å™¨çš„ä¼˜å…ˆçº§</h4><p>æ—¢ç„¶æœ‰åºå¹¿æ’­åœ¨æ¥æ”¶æ—¶æ˜¯æœ‰å…ˆåé¡ºåºçš„ï¼Œé‚£ä¹ˆå°±æˆ‘ä»¬å¯ä»¥è®¾ç½®å¹¿æ’­æ¥æ”¶å™¨çš„å…ˆåé¡ºåºã€‚åœ¨<code>AndroidManifest.xml</code>çš„<code>&lt;intent-filter&gt;</code>ä¸­ï¼Œä½¿ç”¨å±æ€§<code>android:priority</code>æ¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œä¼˜å…ˆçº§è¶Šé«˜çš„å¹¿æ’­æ¥æ”¶å™¨å°±è¶Šå…ˆæ¥æ”¶åˆ°å¹¿æ’­ã€‚</p><h4 id="b-æˆªæ–­å¹¿æ’­ä¼ é€’"><a href="#b-æˆªæ–­å¹¿æ’­ä¼ é€’" class="headerlink" title="b. æˆªæ–­å¹¿æ’­ä¼ é€’"></a>b. æˆªæ–­å¹¿æ’­ä¼ é€’</h4><p>æ—¢ç„¶å·²ç»è·å¾—äº†æ¥æ”¶å¹¿æ’­çš„ä¼˜å…ˆæƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¯¹è¿™æ¡å¹¿æ’­è¿›è¡Œæˆªæ–­äº†ã€‚æ“ä½œèµ·æ¥æ¯”è¾ƒå®¹æ˜“ï¼Œåªéœ€è¦åœ¨è‡ªå®šä¹‰çš„<code>BroadcastReceiver</code>ç±»çš„<code>onReceive()</code>æ–¹æ³•ä¸­æ·»åŠ <code>abortBroadcast()</code>æ–¹æ³•å³å¯ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBroadcastReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br>        Log.d(<span class="hljs-string">&quot;MyBroadcastReceiver&quot;</span>, <span class="hljs-string">&quot;Received&quot;</span>);<br>        Toast.makeText(context, <span class="hljs-string">&quot;MyBroadcastReceiver received&quot;</span>, Toast.LENGTH_SHORT).show();<br>        abortBroadcast();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-4-ä½¿ç”¨æœ¬åœ°å¹¿æ’­"><a href="#2-4-ä½¿ç”¨æœ¬åœ°å¹¿æ’­" class="headerlink" title="2.4 ä½¿ç”¨æœ¬åœ°å¹¿æ’­"></a>2.4 ä½¿ç”¨æœ¬åœ°å¹¿æ’­</h2><p>åœ¨å‰é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å‘é€å’Œæ¥æ”¶çš„å¹¿æ’­å…¨éƒ¨å±äºç³»ç»Ÿå…¨å±€å¹¿æ’­ï¼Œå³å‘å‡ºçš„å¹¿æ’­å¯ä»¥è¢«å…¶ä»–ä»»ä½•åº”ç”¨ç¨‹åºæ¥æ”¶åˆ°ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¥æ”¶æ¥è‡ªäºå…¶ä»–ä»»ä½•åº”ç”¨ç¨‹åºçš„å¹¿æ’­ã€‚</p><p>ä½†è¿™æ ·å°±å¾ˆå®¹æ˜“å¼•èµ·å®‰å…¨æ€§çš„é—®é¢˜ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å‘é€çš„ä¸€äº›æºå¸¦å…³é”®æ€§æ•°æ®çš„å¹¿æ’­æœ‰å¯èƒ½è¢«å…¶ä»–çš„åº”ç”¨ç¨‹åºæˆªè·ï¼Œæˆ–è€…å…¶ä»–çš„ç¨‹åºä¸åœåœ°å‘æˆ‘ä»¬çš„å¹¿æ’­æ¥æ”¶å™¨é‡Œå‘é€å„ç§åƒåœ¾å¹¿æ’­ã€‚å› æ­¤Androidå¼•å…¥äº†ä¸€å¥—æœ¬åœ°å¹¿æ’­æœºåˆ¶æ¥è§£å†³è¿™äº›å®‰å…¨æ€§é—®é¢˜ï¼Œä½¿ç”¨è¿™ä¸ªæœºåˆ¶å‘å‡ºçš„å¹¿æ’­åªèƒ½å¤Ÿåœ¨åº”ç”¨ç¨‹åºçš„å†…éƒ¨è¿›è¡Œä¼ é€’ï¼Œå¹¶ä¸”å¹¿æ’­æ¥æ”¶å™¨ä¹Ÿåªèƒ½æ¥æ”¶æ¥è‡ªæœ¬åº”ç”¨ç¨‹åºå‘å‡ºçš„å¹¿æ’­ã€‚</p><p>æœ¬åœ°å¹¿æ’­çš„ç”¨æ³•å¹¶ä¸å¤æ‚ï¼Œä¸»è¦å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ª<code>LocalBroadcastManager</code>æ¥å¯¹å¹¿æ’­è¿›è¡Œç®¡ç†ï¼Œå¹¶æä¾›äº†å‘é€å¹¿æ’­å’Œæ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨çš„æ–¹æ³•ã€‚</p><p>åœ¨ä½¿ç”¨å‰ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€äº›äº‹é¡¹ï¼š</p><ol><li>æœ¬åœ°å¹¿æ’­æ— æ³•é€šè¿‡é™æ€æ³¨å†Œæ¥æ¥æ”¶ã€‚å› ä¸ºå‘é€æœ¬åœ°å¹¿æ’­æ—¶ï¼Œç¨‹åºè‚¯å®šå·²ç»å¯åŠ¨äº†ï¼Œæ²¡æœ‰å¿…è¦ç”¨é™æ€æ³¨å†Œã€‚å†µä¸”é™æ€æ³¨å†Œçš„è¯ï¼Œä¼šæ¥æ”¶åˆ°æ¥è‡ªéè‡ªç”Ÿåº”ç”¨ç¨‹åºçš„å¹¿æ’­ã€‚</li><li>åœ¨å¹¿æ’­ä¸­å¯åŠ¨Activityçš„è¯ï¼Œéœ€è¦Intentä¸­æ·»åŠ <code>FLAG_ACTIVITY_NEW_TASK</code>çš„Flagï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼Œå› ä¸ºéœ€è¦ä¸€ä¸ªæ ˆæ¥å­˜æ”¾æ–°æ‰“å¼€çš„Activityã€‚</li><li>å¦‚æœé€šè¿‡å¹¿æ’­æ¥å¼¹å‡ºAlertDialogï¼Œéœ€è¦è®¾ç½®å¯¹è¯æ¡†çš„ç±»å‹ä¸º<code>TYPE_SYSTEM_ALERT</code>ã€‚</li></ol><p>ä¸‹é¢æˆ‘ä»¬å°±é€šè¿‡å…·ä½“çš„å®ä¾‹æ¥å°è¯•ä¸€ä¸‹å®ƒçš„ç”¨æ³•ã€‚é¦–å…ˆè‡ªå®šä¹‰çš„<code>BroadcastReceiver</code>ç±»ï¼Œä»£ç åŒä¸Šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBroadcastReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br>        Log.d(<span class="hljs-string">&quot;MyBroadcastReceiver&quot;</span>, <span class="hljs-string">&quot;Received&quot;</span>);<br>        Toast.makeText(context, <span class="hljs-string">&quot;MyBroadcastReceiver received&quot;</span>, Toast.LENGTH_SHORT).show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€å…³é”®çš„æ˜¯<code>MainActivity.java</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_MY_BROADCAST</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>;<br>    <span class="hljs-keyword">private</span> LocalBroadcastManager localBroadcastManager;<br>    <span class="hljs-keyword">private</span> MyBroadcastReceiver MyBroadcastReceiver;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        <span class="hljs-comment">//è·å–å®ä¾‹</span><br>        localBroadcastManager = LocalBroadcastManager.getInstance(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">//æ³¨å†Œæœ¬åœ°å¹¿æ’­æ¥æ”¶å™¨</span><br>        <span class="hljs-type">IntentFilter</span> <span class="hljs-variable">intentFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntentFilter</span>(ACTION_MY_BROADCAST);<br>        MyBroadcastReceiver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyBroadcastReceiver</span>();<br>        localBroadcastManager.registerReceiver(MyBroadcastReceiver, intentFilter);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendBroadcast</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(ACTION_MY_BROADCAST);<br>        <span class="hljs-comment">//intent.addFlags(0x01000000);</span><br>        <span class="hljs-comment">//å‘é€æœ¬åœ°å¹¿æ’­</span><br>        localBroadcastManager.sendBroadcast(intent);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        <span class="hljs-comment">//è®°å¾—è¦å–æ¶ˆæ³¨å†Œ</span><br>        localBroadcastManager.unregisterReceiver(MyBroadcastReceiver);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è·ŸåŠ¨æ€æ³¨å†Œçš„ä»£ç æ²¡æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œåªä¸è¿‡æ˜¯é€šè¿‡<code>localBroadcastManager</code>æ¥æ³¨å†Œå’Œé”€æ¯å¹¿æ’­æ¥æ”¶å™¨ã€‚</p><h1 id="ä¸‰ã€å¹¿æ’­çš„æœ€ä½³å®æˆ˜-â€”â€”-å®ç°å¼ºåˆ¶ä¸‹çº¿åŠŸèƒ½"><a href="#ä¸‰ã€å¹¿æ’­çš„æœ€ä½³å®æˆ˜-â€”â€”-å®ç°å¼ºåˆ¶ä¸‹çº¿åŠŸèƒ½" class="headerlink" title="ä¸‰ã€å¹¿æ’­çš„æœ€ä½³å®æˆ˜ â€”â€” å®ç°å¼ºåˆ¶ä¸‹çº¿åŠŸèƒ½"></a>ä¸‰ã€å¹¿æ’­çš„æœ€ä½³å®æˆ˜ â€”â€” å®ç°å¼ºåˆ¶ä¸‹çº¿åŠŸèƒ½</h1><p>å¼ºåˆ¶ä¸‹çº¿åŠŸèƒ½åº”è¯¥ç®—æ˜¯æ¯”è¾ƒå¸¸è§çš„äº†ï¼Œå¾ˆå¤šçš„åº”ç”¨ç¨‹åºéƒ½å…·å¤‡è¿™ä¸ªåŠŸèƒ½ï¼Œæ¯”å¦‚ä½ çš„QQå·åœ¨åˆ«å¤„ç™»å½•äº†ï¼Œå°±ä¼šå°†ä½ å¼ºåˆ¶æŒ¤ä¸‹çº¿ã€‚å…¶å®å®ç°å¼ºåˆ¶ä¸‹çº¿åŠŸèƒ½çš„æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨ç•Œé¢ä¸Šå¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·æ— æ³•è¿›è¡Œä»»ä½•å…¶ä»–æ“ä½œï¼Œå¿…é¡»è¦ç‚¹å‡»å¯¹è¯æ¡†ä¸­çš„ç¡®å®šæŒ‰é’®ï¼Œç„¶åå›åˆ°ç™»å½•ç•Œé¢å³å¯ã€‚å¯æ˜¯è¿™æ ·å°±å­˜åœ¨ç€ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºå½“æˆ‘ä»¬è¢«é€šçŸ¥éœ€è¦å¼ºåˆ¶ä¸‹çº¿æ—¶å¯èƒ½æ­£å¤„äºä»»ä½•ä¸€ä¸ªç•Œé¢ï¼Œéš¾é“éœ€è¦åœ¨æ¯ä¸ªç•Œé¢ä¸Šéƒ½ç¼–å†™ä¸€ä¸ªå¼¹å‡ºå¯¹è¯æ¡†çš„é€»è¾‘ï¼Ÿå…¶å®å¹¶ä¸è¿™ä¹ˆåšï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å€ŸåŠ©æœ¬ç« ä¸­æ‰€å­¦çš„å¹¿æ’­çŸ¥è¯†ï¼Œæ¥éå¸¸è½»æ¾åœ°å®ç°è¿™ä¸€åŠŸèƒ½ã€‚</p><p>å¼ºåˆ¶ä¸‹çº¿åŠŸèƒ½éœ€è¦å…ˆå…³é—­æ‰æ‰€æœ‰çš„æ´»åŠ¨ï¼Œç„¶åå›åˆ°ç™»å½•ç•Œé¢ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åœ¨Activityç« èŠ‚å­¦åˆ°çš„åˆ›å»ºä¸€ä¸ªæ´»åŠ¨ç®¡ç†ç±»ã€‚</p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªActivityCollectorç±»ç”¨äºç®¡ç†æ‰€æœ‰çš„æ´»åŠ¨ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityCollector</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Activity&gt; activityList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addActivity</span><span class="hljs-params">(Activity activity)</span>&#123;<br>        activityList.add(activity);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeActivity</span><span class="hljs-params">(Activity activity)</span>&#123;<br>        activityList.remove(activity);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishAll</span><span class="hljs-params">()</span>&#123;<br><br>        <span class="hljs-keyword">for</span> (Activity each:activityList) &#123;<br>            <span class="hljs-keyword">if</span> (!each.isFinishing())&#123;<br>                each.finish();<br>            &#125;<br>        &#125;<br>        activityList.clear();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºBaseActivityç±»ä½œä¸ºæ‰€æœ‰æ´»åŠ¨çš„çˆ¶ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        ActivityCollector.addActivity(<span class="hljs-built_in">this</span>);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        ActivityCollector.removeActivity(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€å¼€å§‹å®ç°æˆ‘ä»¬æ‰€éœ€è¦çš„åŠŸèƒ½ï¼Œé¦–å…ˆæ˜¯åˆ›å»ºä¸€ä¸ªç™»é™†ç•Œé¢çš„æ´»åŠ¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">loginActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseActivity</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_login);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoLogin</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MainActivity.class);<br>        startActivity(intent);<br>        finish();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æè‡´çš„ç®€é™‹ï¼Œå°±ä¸€ä¸ªç™»å…¥æŒ‰é’®å’Œå®ƒçš„ç‚¹å‡»äº‹ä»¶ï¼Œè´¦å·å¯†ç éƒ½ä¸æƒ³è¦äº†ï¼ˆå¯¹äºè¿™ä¸ªæ¡ˆä¾‹æ¥è®²å¹¶ä¸é‡è¦ï¼‰ã€‚</p><p>è®°å¾—æ³¨å†Œè¿™ä¸ªæ´»åŠ¨ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºä¸»æ´»åŠ¨è€Œä¸æ˜¯MainActivityã€‚</p><p>ç„¶åæ˜¯å¼ºåˆ¶ä¸‹çº¿ç•Œé¢çš„æ´»åŠ¨ï¼Œè¿™é‡Œå†™åœ¨<code>MainActivity.java</code>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClicktoFinishAllActivities</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-comment">//è‡ªå®šä¹‰actionï¼Œéšä¾¿å°±è¡Œ</span><br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-string">&quot;LOGIN_OTHER&quot;</span>);<br>        sendBroadcast(intent);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·è¿˜æ˜¯ä¸€ä¸ªæŒ‰é’®å’Œå®ƒçš„ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºå¼ºåˆ¶ä¸‹çº¿ã€‚éšä¾¿å®šä¹‰ä¸€ä¸ªå¹¿æ’­åŠ¨ä½œå³å¯ï¼Œåªè¦ä¸å¹¿æ’­æ¥æ”¶å™¨çš„åŠ¨ä½œä¸€è‡´å°±è¡Œã€‚</p><p>ç°åœ¨åŠŸèƒ½éƒ½å†™å¥½äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦åˆ›å»ºä¸€ä¸ªå¹¿æ’­æ¥æ”¶å™¨æ¥æ¥æ”¶è¿™æ¡å¼ºåˆ¶ä¸‹çº¿å¹¿æ’­ï¼Œå”¯ä¸€çš„é—®é¢˜å°±æ˜¯ï¼Œåº”è¯¥åœ¨å“ªé‡Œåˆ›å»ºå‘¢ï¼Ÿ</p><p>é¦–å…ˆä¸å¯èƒ½æ—¶é™æ€æ³¨å†Œï¼Œå› ä¸ºé™æ€æ³¨å†Œæ²¡æœ‰åŠæ³•åœ¨<code>onReceive()</code>æ–¹æ³•é‡Œå¼¹å‡ºå¯¹è¯æ¡†è¿™æ ·çš„UIæ§ä»¶çš„ã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬ä¸å¯èƒ½åœ¨æ¯ä¸ªå…·ä½“æ´»åŠ¨ä¸­éƒ½æ³¨å†Œä¸€ä¸ªåŠ¨æ€å¹¿æ’­æ¥æ”¶å™¨ï¼Œè¿™æ˜¾ç„¶ä¸åˆç†ã€‚ä½†æ˜¯æˆ‘ä»¬å†™çš„æ¯ä¸ªæ´»åŠ¨éƒ½å¿…é¡»ä¿è¯èƒ½å¤Ÿç›¸åº”å¹¿æ’­ï¼Œä¹Ÿå°±æ˜¯æœ‰å¹¿æ’­æ¥æ”¶å™¨ã€‚é‚£ä¹ˆæˆ‘ä»¬å°†æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨çš„ä»£ç å†™åˆ°ä»–ä»¬çš„çˆ¶ç±»BaseActivityä¸­ä¸å°±è¡Œäº†ï¼Ÿè¿™æ ·ä¸€æ¥ç¡®ç¡®å®å®æ¯ä¸ªæ´»åŠ¨éƒ½æœ‰å¹¿æ’­æ¥æ”¶å™¨äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">public</span> ForceOffLineReceiver forceOffLineReceiver;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        ActivityCollector.addActivity(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResume</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onResume();<br>        <span class="hljs-comment">//æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨</span><br>        forceOffLineReceiver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForceOffLineReceiver</span>();<br>        <span class="hljs-type">IntentFilter</span> <span class="hljs-variable">intentFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntentFilter</span>(<span class="hljs-string">&quot;LOGIN_OTHER&quot;</span>);<br>        registerReceiver(forceOffLineReceiver,intentFilter);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onPause();<br>        <span class="hljs-keyword">if</span> (forceOffLineReceiver != <span class="hljs-literal">null</span>)&#123;<br>unregisterReceiver(forceOffLineReceiver);<br>            forceOffLineReceiver = <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        ActivityCollector.removeActivity(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForceOffLineReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br>            Log.d(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;onReceive: &quot;</span>);<br>            <span class="hljs-comment">//å®ç°å¼¹çª—è­¦å‘Š</span><br>            AlertDialog.<span class="hljs-type">Builder</span> <span class="hljs-variable">dialogBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(context);<br>            dialogBuilder.setTitle(<span class="hljs-string">&quot;è­¦å‘Šï¼š&quot;</span>)<br>                    .setMessage(<span class="hljs-string">&quot;æ‚¨çš„è´¦å·åœ¨åˆ«å¤„ç™»å½•ï¼Œè¯·é‡æ–°ç™»é™†&quot;</span>)<br>                    .setCancelable(<span class="hljs-literal">false</span>)<br>                    .setPositiveButton(<span class="hljs-string">&quot;ç¡®è®¤&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DialogInterface</span>.OnClickListener() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(DialogInterface dialogInterface, <span class="hljs-type">int</span> i)</span> &#123;<br>                            Log.d(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;onClick: &quot;</span>);<br>                            <span class="hljs-comment">//å…³é—­æ‰€æœ‰æ´»åŠ¨</span><br>                            ActivityCollector.finishAll();<br>                            <span class="hljs-comment">//è¿”å›ç™»å½•ç•Œé¢</span><br>                            <span class="hljs-type">Intent</span> <span class="hljs-variable">backintent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(context, loginActivity.class);<br>                            backintent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);<br>                            context.startActivity(backintent);<br>                        &#125;<br>                    &#125;);<br>            dialogBuilder.show();<br>            <span class="hljs-comment">//AlertDialog alertDialog = dialogBuilder.create();</span><br>            <span class="hljs-comment">//alertDialog.show();</span><br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é¢å¤–é‡å†™äº†<code>onResume()</code>å’Œ<code>onPause()</code>è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œç„¶ååˆ†åˆ«åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œæ³¨å†Œå’Œå–æ¶ˆæ³¨å†Œäº†<code>ForceOfflineReceiver</code>.é‚£ä¹ˆä¸ºä»€ä¹ˆè¦è¿™æ ·å†™å‘¢ï¼Ÿ</p><p>å› ä¸ºæˆ‘ä»¬åªéœ€è¦ä¿è¯åº”ç”¨çš„Activityæ ˆä¸­æ ˆé¡¶æ´»åŠ¨èƒ½å¤Ÿæ¥æ”¶è¿™æ¡å¼ºåˆ¶ä¸‹çº¿å¹¿æ’­å°±è¶³å¤Ÿäº†ï¼Œéæ ˆé¡¶æ´»åŠ¨æ²¡æœ‰å¿…è¦å»æ¥æ”¶è¿™æ¡å¹¿æ’­ï¼Œæ‰€ä»¥å†™åœ¨<code>onResume()</code>å’Œ<code>onPause()</code>æ–¹æ³•é‡Œå°±å¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“ä¸€ä¸ªæ´»åŠ¨å¤±å»æ ˆé¡¶ä½ç½®æ—¶å°±ä¼šè‡ªåŠ¨å–æ¶ˆå¹¿æ’­æ¥æ”¶å™¨çš„æ³¨å†Œã€‚</p><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p><p><strong>ä¸èƒ½ä½¿ç”¨<code>localBroadcastManager</code>æ¥æ³¨å†Œå¹¿æ’­ï¼Œä¸ç„¶ç¨‹åºå¼‚å¸¸é€€å‡ºï¼ï¼ï¼</strong></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå¼€å‘å­¦ä¹ ç¬”è®°(äº”) â€”â€” æ¸©ä¹ Service</title>
    <link href="/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%BA%94)%20%E2%80%94%E2%80%94%20%E6%B8%A9%E4%B9%A0Service/"/>
    <url>/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%BA%94)%20%E2%80%94%E2%80%94%20%E6%B8%A9%E4%B9%A0Service/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯Service"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯Service" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯Service"></a>ä¸€ã€ä»€ä¹ˆæ˜¯Service</h1><p>æœåŠ¡ï¼ˆServiceï¼‰æ˜¯Androidå››å¤§ç»„ä»¶ä¹‹ä¸€ï¼ˆå› æ­¤éœ€è¦åœ¨<code>AndroidManifest.xml</code>ä¸­è¿›è¡Œæ³¨å†Œï¼Œå¦åˆ™ç³»ç»Ÿæ— æ³•è¯†åˆ«è¯¥Serviceï¼‰ï¼Œæ˜¯Androidä¸­å®ç°ç¨‹åºåå°è¿è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œéå¸¸é€‚åˆå»æ‰§è¡Œé‚£äº›ä¸éœ€è¦å’Œç”¨æˆ·äº¤äº’ï¼ˆå› è€Œä¹Ÿä¸éœ€è¦UIç•Œé¢ï¼‰è€Œä¸”è¿˜è¦æ±‚é•¿æœŸè¿è¡Œçš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ’­æ”¾éŸ³ä¹ã€ä¸‹è½½æ–‡ä»¶ã€ä¸Šä¼ æ•°æ®ç­‰ã€‚æœåŠ¡çš„è¿è¡Œä¸ä¾èµ–äºä»»ä½•ç”¨æˆ·ç•Œé¢ï¼Œå³ä½¿ç¨‹åºè¢«åˆ‡æ¢åˆ°åå°ï¼Œæˆ–è€…ç”¨æˆ·æ‰“å¼€äº†å¦å¤–ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ŒæœåŠ¡ä»ç„¶èƒ½å¤Ÿä¿æŒæ­£å¸¸è¿è¡Œã€‚</p><p>ä½†æ˜¯ï¼ŒæœåŠ¡å¹¶ä¸æ˜¯è¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹å½“ä¸­çš„ï¼Œè€Œæ˜¯ä¾èµ–äºåˆ›å»ºæœåŠ¡æ—¶æ‰€åœ¨çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚å½“æŸä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹è¢«æ€æ‰æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºè¯¥è¿›ç¨‹çš„æœåŠ¡ä¹Ÿä¼šåœæ­¢è¿è¡Œã€‚</p><p>å¦å¤–ï¼ŒæœåŠ¡å¹¶ä¸ä¼šè‡ªåŠ¨å¼€å¯çº¿ç¨‹ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½æ˜¯é»˜è®¤è¿è¡Œåœ¨ä¸»çº¿ç¨‹å½“ä¸­çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡çš„å†…éƒ¨æ‰‹åŠ¨åˆ›å»ºå­çº¿ç¨‹ï¼Œå¹¶åœ¨è¿™é‡Œæ‰§è¡Œå…·ä½“çš„ä»»åŠ¡ï¼Œå¦åˆ™å°±æœ‰å¯èƒ½å‡ºç°ä¸»çº¿ç¨‹è¢«é˜»å¡ä½çš„æƒ…å†µã€‚</p><h1 id="äºŒã€Androidå¤šçº¿ç¨‹ç¼–ç¨‹"><a href="#äºŒã€Androidå¤šçº¿ç¨‹ç¼–ç¨‹" class="headerlink" title="äºŒã€Androidå¤šçº¿ç¨‹ç¼–ç¨‹"></a>äºŒã€Androidå¤šçº¿ç¨‹ç¼–ç¨‹</h1><h2 id="2-1-çº¿ç¨‹çš„åŸºæœ¬ç”¨æ³•"><a href="#2-1-çº¿ç¨‹çš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="2.1 çº¿ç¨‹çš„åŸºæœ¬ç”¨æ³•"></a>2.1 çº¿ç¨‹çš„åŸºæœ¬ç”¨æ³•</h2><p>å®šä¹‰ä¸€ä¸ªçº¿ç¨‹åªéœ€è¦æ–°å»ºä¸€ä¸ªç±»ç»§æ‰¿è‡ªThreadï¼Œç„¶åé‡å†™çˆ¶ç±»çš„<code>run()</code>æ–¹æ³•ï¼Œå¹¶åœ¨é‡Œé¢ç¼–å†™æˆ‘ä»¬æƒ³è¦å¤„ç†çš„äº‹åŠ¡çš„é€»è¾‘å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//å¤„ç†äº‹åŠ¡çš„å…·ä½“é€»è¾‘</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¯¥å¦‚ä½•å¯åŠ¨è¿™ä¸ªçº¿ç¨‹å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦newå‡ºMyThreadçš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨å®ƒçš„<code>start()</code>æ–¹æ³•ï¼Œè¿™æ ·<code>run()</code>æ–¹æ³•ä¸­çš„ä»£ç å°±ä¼šåœ¨å­çº¿ç¨‹å½“ä¸­è¿è¡Œäº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">MyThread</span>().start();<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæ›´å¤šçš„æ—¶å€™æˆ‘ä»¬éƒ½ä¼šé€‰æ‹©ä½¿ç”¨å®ç°Runnableæ¥å£ï¼ˆThreadç±»ä¹Ÿå®ç°è¯¥æ¥å£ï¼‰çš„æ–¹å¼æ¥å®šä¹‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//å¤„ç†äº‹åŠ¡çš„å…·ä½“é€»è¾‘</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨äº†è¿™ç§å†™æ³•ï¼Œå¯åŠ¨çº¿ç¨‹çš„æ–¹æ³•ä¹Ÿéœ€è¦è¿›è¡Œç›¸åº”çš„æ”¹å˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyThread</span>()).start();<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒThreadçš„æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªRunnableå‚æ•°ï¼ˆåªæ˜¯å…¶ä¸­ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼‰ï¼Œè€Œæˆ‘ä»¬newå‡ºçš„MyThreadæ­£æ˜¯ä¸€ä¸ªå®ç°äº†Runnableæ¥å£çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†å®ƒä¼ å…¥åˆ°Threadçš„æ„é€ å‡½æ•°é‡Œã€‚æ¥ç€è°ƒç”¨Threadçš„<code>start()</code>æ–¹æ³•ï¼Œ<code>run()</code>æ–¹æ³•ä¸­çš„ä»£ç å°±ä¼šåœ¨å­çº¿ç¨‹å½“ä¸­è¿è¡Œäº†ã€‚</p><p>å½“ç„¶ï¼Œæ›´å¸¸è§çš„å†™æ³•æ—¶ä½¿ç”¨åŒ¿åç±»çš„æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//å¤„ç†äº‹åŠ¡çš„å…·ä½“é€»è¾‘</span><br>    &#125;<br>&#125;).start();<br></code></pre></td></tr></table></figure><h2 id="2-2-åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°UI"><a href="#2-2-åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°UI" class="headerlink" title="2.2 åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°UI"></a>2.2 åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°UI</h2><p>å’Œè®¸å¤šå…¶ä»–çš„GUIåº“ä¸€æ ·ï¼ŒAndroidçš„UIä¹Ÿæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæƒ³è¦æ›´æ–°åº”ç”¨ç¨‹åºé‡Œçš„UIå…ƒç´ ï¼Œåˆ™å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œï¼Œå¦åˆ™å°±ä¼šå‡ºç°å¼‚å¸¸ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä¾‹å­æ¥éªŒè¯ä¸€ä¸‹ã€‚æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç„¶åä¿®æ”¹<code>activity_main.xml</code>ä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;change text&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;ClickChangeUI&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Hello World!&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">&quot;40dp&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¸ƒå±€ä¸­å®šä¹‰äº†ä¸€ä¸ªTextViewæ§ä»¶ï¼Œç”¨äºæ˜¾ç¤ºå­—ç¬¦ä¸²ï¼Œç„¶åè¿˜æœ‰ä¸€ä¸ªæŒ‰é’®ï¼Œç”¨äºæ”¹å˜TextViewæ˜¾ç¤ºçš„å†…å®¹ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯MainActivityä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClickChangeUI</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-type">TextView</span> <span class="hljs-variable">textView</span> <span class="hljs-operator">=</span> findViewById(R.id.id_text);<br>                textView.setText(<span class="hljs-string">&quot;aaaaaaaaaaa&quot;</span>);<br>            &#125;<br>        &#125;).start();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶é‡Œé¢å¼€å¯äº†ä¸€ä¸ªå­çº¿ç¨‹ï¼Œç„¶ååœ¨å­çº¿ç¨‹ä¸­ä¿®æ”¹TextViewæ§ä»¶çš„å­—ç¬¦ä¸²ã€‚ç°åœ¨è¿è¡Œç¨‹åºå¹¶ç‚¹å‡»æŒ‰é’®ï¼Œæˆ‘ä»¬ä¼šå‘ç°ç¨‹åºå´©æºƒï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">FATAL <span class="hljs-keyword">EXCEPTION</span>: Thread<span class="hljs-number">-2</span><br>android.<span class="hljs-keyword">view</span>.ViewRootImpl$CalledFromWrongThreadException: <span class="hljs-keyword">Only</span> the original thread that created a <span class="hljs-keyword">view</span> hierarchy can touch its views.<br></code></pre></td></tr></table></figure><p>ç”±æ­¤è¯å®äº†Androidç¡®å®æ˜¯ä¸å…è®¸åœ¨å­çº¿ç¨‹ä¸­è¿›è¡ŒUIæ“ä½œçš„ã€‚ä½†æ˜¯æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å­çº¿ç¨‹é‡Œå»æ‰§è¡Œä¸€äº›è€—æ—¶ä»»åŠ¡ï¼Œç„¶åæ ¹æ®ä»»åŠ¡çš„æ‰§è¡Œç»“æœæ¥æ›´æ–°ç›¸åº”çš„UIæ§ä»¶ï¼Œé‚£è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>å¯¹äºè¿™ç§æƒ…å†µï¼ŒAndroidæä¾›äº†ä¸€å¥—å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œå®Œç¾åœ°è§£å†³äº†åœ¨å­çº¿ç¨‹ä¸­è¿›è¡ŒUIæ“ä½œçš„é—®é¢˜ã€‚æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸€ä¸‹å¼‚æ­¥æ¶ˆæ¯å¤„ç†çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><p>ä¿®æ”¹MainActivityä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">UPDATE_TEXT</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>()&#123;<br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span>&#123;<br>          <span class="hljs-keyword">switch</span> (msg.what)&#123;<br>              <span class="hljs-keyword">case</span> UPDATE_TEXT:<br>                  <span class="hljs-type">TextView</span> <span class="hljs-variable">textView</span> <span class="hljs-operator">=</span> findViewById(R.id.id_text);<br>                  textView.setText(<span class="hljs-string">&quot;aaaaaaaaaaa&quot;</span>);<br>                  <span class="hljs-keyword">break</span>;<br>              <span class="hljs-keyword">default</span>:<br>                  <span class="hljs-keyword">break</span>;<br>          &#125;<br>      &#125;<br>    &#125;;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClickChangeUI</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>();<br>                message.what = UPDATE_TEXT;<br>                handler.sendMessage(message);<br>            &#125;<br>        &#125;).start();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å…ˆæ˜¯å®šä¹‰äº†ä¸€ä¸ªæ•´å‹å¸¸é‡<code>UPDATE_TEXT</code>ï¼Œç”¨äºè¡¨ç¤ºæ›´æ–°TextViewè¿™ä¸ªåŠ¨ä½œã€‚ç„¶åæ–°å¢ä¸€ä¸ªHandlerå¯¹è±¡ï¼Œå¹¶é‡å†™çˆ¶ç±»çš„<code>handleMessage()</code>æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå¯¹å…·ä½“çš„Messageè¿›è¡Œå¤„ç†ã€‚å¦‚æœå‘ç°Messageçš„whatå­—æ®µçš„å€¼ç­‰äº<code>UPDATE_TEXT</code>ï¼Œå°±æ›´æ”¹TextViewçš„å†…å®¹ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­çš„ä»£ç ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨å­çº¿ç¨‹é‡Œç›´æ¥è¿›è¡ŒUIæ“ä½œï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ª<code>Message</code>ï¼ˆ<code>android.os.Message</code>ï¼‰å¯¹è±¡ï¼Œå¹¶å°†å®ƒçš„whatå­—æ®µçš„å€¼æŒ‡å®šä¸º<code>UPDATE_TEXT</code>ï¼Œç„¶åè°ƒç”¨Handlerçš„<code>sendMessage()</code>æ–¹æ³•å°†è¿™æ¡Messageå‘é€å‡ºå»ã€‚å¾ˆå¿«ï¼ŒHandlerå°±ä¼šæ”¶åˆ°è¿™æ¡Messageï¼Œå¹¶åœ¨<code>handleMessage()</code>æ–¹æ³•ä¸­å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚æ³¨æ„<strong>æ­¤æ—¶<code>handleMessage()</code>æ–¹æ³•ä¸­çš„ä»£ç å°±æ˜¯åœ¨ä¸»çº¿ç¨‹å½“ä¸­è¿è¡Œçš„äº†</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¾å¿ƒåœ°åœ¨è¿™é‡Œè¿›è¡ŒUIæ“ä½œã€‚</p><p>ç°åœ¨é‡æ–°è¿è¡Œç¨‹åºå¹¶ç‚¹å‡»æŒ‰é’®ï¼Œå‘ç°ç¨‹åºå¹¶æ²¡æœ‰å´©æºƒï¼Œè€Œä¸”TextViewä¸­çš„å†…å®¹æ›´æ”¹äº†ã€‚</p><p>ç°åœ¨å¯ä»¥è¯´æˆ‘ä»¬äº†è§£äº†Androidå¼‚æ­¥æ¶ˆæ¯å¤„ç†çš„åŸºæœ¬ç”¨æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸äº†è§£å®ƒçš„å·¥ä½œåŸç†ï¼Œå› æ­¤ä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹Androidå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶åˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><h2 id="2-3-è§£æå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶"><a href="#2-3-è§£æå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶" class="headerlink" title="2.3 è§£æå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶"></a>2.3 è§£æå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶</h2><p>Androidä¸­çš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†ä¸»è¦ç”±4ä¸ªéƒ¨åˆ†ç»„æˆï¼šMessageã€Handlerã€MessageQueueå’ŒLooperã€‚</p><ol><li>Message<br>Messageæ˜¯åœ¨<strong>çº¿ç¨‹ä¹‹é—´ä¼ é€’çš„æ¶ˆæ¯</strong>ï¼Œå®ƒå¯ä»¥åœ¨å†…éƒ¨æºå¸¦å°‘é‡çš„ä¿¡æ¯ï¼Œç”¨äºåœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´äº¤æ¢æ•°æ®ã€‚ä¸Šä¸€å°èŠ‚ä¸­æˆ‘ä»¬ä½¿ç”¨åˆ°äº†Messageçš„whatå­—æ®µï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥ä½¿ç”¨arg1å’Œarg2å­—æ®µæ¥æºå¸¦ä¸€äº›æ•´å‹æ•°æ®ï¼Œä½¿ç”¨objå­—æ®µæºå¸¦ä¸€ä¸ªObjectå¯¹è±¡ã€‚</li><li>Handler<br>Handleré¡¾åæ€ä¹‰ä¹Ÿå°±æ˜¯å¤„ç†è€…çš„æ„æ€ï¼Œå®ƒä¸»è¦æ˜¯ç”¨äºå‘é€å’Œå¤„ç†æ¶ˆæ¯çš„ã€‚å‘é€æ¶ˆæ¯ä¸€èˆ¬æ˜¯ä½¿ç”¨Handlerçš„<code>sendMessage()</code>æ–¹æ³•ï¼Œè€Œå‘å‡ºçš„æ¶ˆæ¯ç»è¿‡ä¸€ç³»åˆ—åœ°è¾—è½¬å¤„ç†åï¼Œæœ€ç»ˆä¼šä¼ é€’åˆ°Handlerçš„<code>handleMessage()</code>æ–¹æ³•ä¸­ã€‚</li><li>MessageQueue<br>MessageQueueæ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„æ„æ€ï¼Œå®ƒä¸»è¦ç”¨äºå­˜æ”¾æ‰€æœ‰é€šè¿‡Handlerå‘é€çš„æ¶ˆæ¯ã€‚è¿™éƒ¨åˆ†æ¶ˆæ¯ä¼šä¸€ç›´å­˜åœ¨äºæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«å¤„ç†ã€‚<strong>æ¯ä¸ªçº¿ç¨‹ä¸­åªä¼šæœ‰ä¸€ä¸ªMessageQueueå¯¹è±¡</strong>ã€‚</li><li>Looper<br>Looperæ˜¯æ¯ä¸ªçº¿ç¨‹ä¸­çš„MessageQueueçš„ç®¡å®¶ï¼Œè°ƒç”¨Looperçš„<code>Loop()</code>æ–¹æ³•åï¼Œå°±ä¼šè¿›å…¥åˆ°ä¸€ä¸ªæ— é™å¾ªç¯å½“ä¸­ï¼Œç„¶åæ¯å½“å‘ç°MessageQueueä¸­å­˜åœ¨ä¸€æ¡æ¶ˆæ¯ï¼Œå°±ä¼šå°†å®ƒå–å‡ºï¼Œå¹¶ä¼ é€’åˆ°Handlerçš„<code>handleMessage()</code>æ–¹æ³•ä¸­ã€‚<strong>æ¯ä¸ªçº¿ç¨‹ä¸­ä¹Ÿåªä¼šæœ‰ä¸€ä¸ªLooperå¯¹è±¡</strong>ã€‚</li></ol><p>äº†è§£äº†Messageã€Handlerã€MessageQueueä»¥åŠLooperçš„åŸºæœ¬æ¦‚å¿µåï¼Œæˆ‘ä»¬å†æ¥æŠŠå¼‚æ­¥æ¶ˆæ¯å¤„ç†çš„æ•´ä¸ªæµç¨‹æ¢³ç†ä¸€éã€‚é¦–å…ˆéœ€è¦åœ¨ä¸»çº¿ç¨‹å½“ä¸­åˆ›å»ºä¸€ä¸ªHandlerå¯¹è±¡ï¼Œå¹¶é‡å†™<code>handleMessage()</code>æ–¹æ³•ã€‚ç„¶åå½“å­çº¿ç¨‹ä¸­éœ€è¦è¿›è¡ŒUIæ“ä½œæ—¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªMessageå¯¹è±¡ï¼Œå¹¶é€š<br>è¿‡Handlerå°†è¿™æ¡æ¶ˆæ¯å‘é€å‡ºå»ã€‚ä¹‹åè¿™æ¡æ¶ˆæ¯ä¼šè¢«æ·»åŠ åˆ°MessageQueueçš„é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«å¤„ç†ï¼Œè€ŒLooperåˆ™ä¼šä¸€ç›´å°è¯•ä»MessageQueueä¸­å–å‡ºå¾…å¤„ç†æ¶ˆæ¯ï¼Œæœ€ååˆ†å‘å›Handlerçš„<code>handleMessage()</code>æ–¹æ³•ä¸­ã€‚ç”±äºHandleræ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„ï¼Œæ‰€ä»¥æ­¤æ—¶<code>handleMessage()</code>æ–¹æ³•ä¸­çš„ä»£ç ä¹Ÿä¼šåœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œäºæ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œå°±å¯ä»¥å®‰å¿ƒåœ°è¿›è¡ŒUIæ“ä½œäº†ã€‚æ•´ä¸ªå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶çš„æµç¨‹ç¤ºæ„å›¾å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131920173.jpg"></p><p>ä¸€æ¡Messageç»è¿‡è¿™æ ·ä¸€ä¸ªæµç¨‹çš„è¾—è½¬è°ƒç”¨åï¼Œä¹Ÿå°±ä»å­çº¿ç¨‹è¿›å…¥åˆ°äº†ä¸»çº¿ç¨‹ï¼Œä»ä¸èƒ½æ›´æ–°UIå˜æˆäº†å¯ä»¥æ›´æ–°UIï¼Œæ•´ä¸ªå¼‚æ­¥æ¶ˆæ¯å¤„ç†çš„æ ¸å¿ƒæ€æƒ³ä¹Ÿå°±æ˜¯å¦‚æ­¤ã€‚</p><h2 id="2-4-ä½¿ç”¨AsyncTask"><a href="#2-4-ä½¿ç”¨AsyncTask" class="headerlink" title="2.4 ä½¿ç”¨AsyncTask"></a>2.4 ä½¿ç”¨AsyncTask</h2><p>ä¸è¿‡ä¸ºäº†æ›´åŠ æ–¹ä¾¿æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­å¯¹UIè¿›è¡Œæ“ä½œï¼ŒAndroidè¿˜æä¾›äº†å¦å¤–ä¸€äº›å¥½ç”¨çš„å·¥å…·ï¼Œæ¯”å¦‚AsyncTaskã€‚å€ŸåŠ©AsyncTaskï¼Œå³ä½¿ä½ å¯¹å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶å®Œå…¨ä¸äº†è§£ï¼Œä¹Ÿå¯ä»¥ååˆ†ç®€å•åœ°ä»å­çº¿ç¨‹åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ã€‚å½“ç„¶ï¼ŒAsyncTaskèƒŒåçš„å®ç°åŸç†ä¹Ÿæ˜¯åŸºäºå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶çš„ï¼Œåªæ˜¯Androidå¸®æˆ‘ä»¬åšäº†å¾ˆå¥½çš„å°è£…è€Œå·²ã€‚</p><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹AsyncTaskçš„åŸºæœ¬ç”¨æ³•ï¼Œç”±äºAsyncTaskæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨å®ƒï¼Œå°±å¿…é¡»è¦åˆ›å»ºä¸€ä¸ªå­ç±»å»ç»§æ‰¿å®ƒã€‚åœ¨ç»§æ‰¿æ—¶æˆ‘ä»¬å¯ä»¥ä¸ºAsyncTaskç±»æŒ‡å®š3ä¸ªæ³›å‹å‚æ•°ï¼Œè¿™3ä¸ªå‚æ•°çš„ç”¨é€”å¦‚ä¸‹ï¼š</p><ul><li><p>Params</p><p>åœ¨æ‰§è¡ŒAsyncTaskæ—¶éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼Œå¯ç”¨äºåœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨ã€‚</p></li><li><p>Progress</p><p>åå°ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå¦‚æœéœ€è¦åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå½“å‰çš„è¿›åº¦ï¼Œåˆ™ä½¿ç”¨è¿™é‡ŒæŒ‡å®šçš„æ³›å‹ä½œä¸ºè¿›åº¦å•ä½ã€‚</p></li><li><p>Result</p><p>å½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå¦‚æœéœ€è¦å¯¹ç»“æœè¿›è¡Œè¿”å›ï¼Œåˆ™ä½¿ç”¨è¿™é‡ŒæŒ‡å®šçš„æ³›å‹ä½œä¸ºè¿”å›å€¼ç±»å‹ã€‚</p></li></ul><p>å› æ­¤ï¼Œä¸€ä¸ªæœ€ç®€å•çš„è‡ªå®šä¹‰AsyncTaskå°±å¯ä»¥å†™æˆå¦‚ä¸‹æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncTask</span>&lt;Void, Integer, Boolean&gt;&#123;<br>    ......<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æŠŠAsyncTaskçš„ç¬¬ä¸€ä¸ªæ³›å‹å‚æ•°æŒ‡å®šä¸ºVoidï¼Œè¡¨ç¤ºåœ¨æ‰§è¡ŒAsyncTaskçš„æ—¶å€™ä¸éœ€è¦ä¼ å…¥å‚æ•°ç»™åå°ä»»åŠ¡ã€‚ç¬¬äºŒä¸ªæ³›å‹å‚æ•°æŒ‡å®šä¸ºIntegerï¼Œè¡¨ç¤ºä½¿ç”¨æ•´å‹æ•°æ®æ¥ä½œä¸ºè¿›åº¦æ˜¾ç¤ºå•ä½ã€‚ç¬¬ä¸‰ä¸ªæ³›å‹å‚æ•°æŒ‡å®šä¸ºBooleanï¼Œåˆ™è¡¨ç¤ºä½¿ç”¨å¸ƒå°”å‹æ•°æ®æ¥åé¦ˆæ‰§è¡Œç»“æœã€‚</p><p>å½“ç„¶ï¼Œç›®å‰æˆ‘ä»¬è‡ªå®šä¹‰çš„DownloadTaskè¿˜æ˜¯ä¸€ä¸ªç©ºä»»åŠ¡ï¼Œå¹¶ä¸èƒ½è¿›è¡Œä»»ä½•å®é™…çš„æ“ä½œï¼Œæˆ‘ä»¬è¿˜éœ€è¦å»é‡å†™AsyncTaskä¸­çš„å‡ ä¸ªæ–¹æ³•æ‰èƒ½å®Œæˆå¯¹ä»»åŠ¡çš„å®šåˆ¶ã€‚ç»å¸¸éœ€è¦å»é‡å†™çš„æ–¹æ³•æœ‰ä»¥ä¸‹4ä¸ªï¼š</p><ol><li><strong>onPreExecute()</strong><br>è¿™ä¸ªæ–¹æ³•ä¼šåœ¨åå°ä»»åŠ¡å¼€å§‹æ‰§è¡Œä¹‹å‰è°ƒç”¨ï¼Œç”¨äºè¿›è¡Œä¸€äº›ç•Œé¢ä¸Šçš„åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚æ˜¾ç¤ºä¸€ä¸ªè¿›åº¦æ¡å¯¹è¯æ¡†ç­‰ã€‚</li><li><strong>doInBackground (Paramsâ€¦)</strong><br><strong>è¿™ä¸ªæ–¹æ³•ä¸­çš„æ‰€æœ‰ä»£ç éƒ½ä¼šåœ¨å­çº¿ç¨‹ä¸­è¿è¡Œ</strong>ï¼Œæˆ‘ä»¬åº”è¯¥<strong>åœ¨è¿™é‡Œå»å¤„ç†æ‰€æœ‰çš„è€—æ—¶ä»»åŠ¡</strong>ã€‚ä»»åŠ¡ä¸€æ—¦å®Œæˆå°±å¯ä»¥é€šè¿‡returnè¯­å¥æ¥å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ï¼Œå¦‚æœAsyncTaskçš„ç¬¬ä¸‰ä¸ªæ³›å‹å‚æ•°æŒ‡å®šçš„æ˜¯Void,å°±å¯ä»¥ä¸è¿”å›ä»»åŠ¡æ‰§è¡Œç»“æœã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ˜¯<strong>ä¸å¯ä»¥è¿›è¡ŒUIæ“ä½œçš„</strong>ï¼Œå¦‚æœéœ€è¦æ›´æ–°UIå…ƒç´ ï¼Œæ¯”å¦‚è¯´åé¦ˆå½“å‰ä»»åŠ¡çš„æ‰§è¡Œè¿›åº¦ï¼Œå¯ä»¥è°ƒç”¨<code>publishProgress(Progress...)</code>æ–¹æ³•æ¥å®Œæˆã€‚</li><li><strong>onProgressUpdate(Progressâ€¦)</strong><br>å½“åœ¨åå°ä»»åŠ¡ä¸­è°ƒç”¨äº†<code>publishProgress(Progress...)</code>æ–¹æ³•åï¼Œ<code>onProgressUpdate(Progress...)</code>æ–¹æ³•å°±ä¼šå¾ˆå¿«è¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•ä¸­æºå¸¦çš„å‚æ•°å°±æ˜¯åœ¨åå°ä»»åŠ¡ä¸­ä¼ é€’è¿‡æ¥çš„ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­<strong>å¯ä»¥å¯¹UIè¿›è¡Œæ“ä½œ</strong>ï¼Œåˆ©ç”¨å‚æ•°ä¸­çš„æ•°å€¼å°±å¯ä»¥å¯¹ç•Œé¢å…ƒç´ è¿›è¡Œç›¸åº”çš„æ›´æ–°ã€‚</li><li><strong>onPostExecute(Result)</strong><br>å½“åå°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å¹¶é€šè¿‡returnè¯­å¥è¿›è¡Œè¿”å›æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å°±å¾ˆå¿«ä¼šè¢«è°ƒç”¨ã€‚è¿”å›çš„æ•°æ®ä¼šä½œä¸ºå‚æ•°ä¼ é€’åˆ°æ­¤æ–¹æ³•ä¸­ï¼Œå¯ä»¥åˆ©ç”¨è¿”å›çš„æ•°æ®æ¥è¿›è¡Œä¸€äº›UIæ“ä½œï¼Œæ¯”å¦‚è¯´æé†’ä»»åŠ¡æ‰§è¡Œçš„ç»“æœï¼Œä»¥åŠå…³é—­æ‰è¿›åº¦æ¡å¯¹è¯æ¡†ç­‰ã€‚</li></ol><p>å› æ­¤ï¼Œä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„è‡ªå®šä¹‰AsyncTaskå°±å¯ä»¥å†™æˆå¦‚ä¸‹æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncTask</span>&lt;Void, Integer, Boolean&gt; &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPreExecute</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†</span><br>        progressDialog.show();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Boolean <span class="hljs-title function_">doInBackground</span><span class="hljs-params">(Void... params)</span> &#123;<br>        <span class="hljs-comment">//ä»»åŠ¡å¤„ç†</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">downloadPercent</span> <span class="hljs-operator">=</span> doDownload();<span class="hljs-comment">//è™šæ„æ–¹æ³•</span><br>                publishProgress(downloadPercent);<br>                <span class="hljs-keyword">if</span> (downloadPercent &gt;= <span class="hljs-number">100</span>)&#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onProgressUpdate</span><span class="hljs-params">(Integer... values)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onProgressUpdate(values);<br>        <span class="hljs-comment">//UIè·Ÿæ–°ï¼Œå³æ›´æ–°ä¸‹è½½è¿›åº¦</span><br>        progressDialog.setMessage(<span class="hljs-string">&quot;Downloaded &quot;</span> + values[<span class="hljs-number">0</span>] + <span class="hljs-string">&quot;%&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPostExecute</span><span class="hljs-params">(Boolean result)</span> &#123;<span class="hljs-comment">//ä»»åŠ¡æ‰§è¡Œå®Œåè¢«è°ƒç”¨</span><br>        <span class="hljs-built_in">super</span>.onPostExecute(result);<br>        <span class="hljs-comment">//å…³é—­è¿›åº¦å¯¹è¯æ¡†</span><br>        progressDialog.dismiss();<br>        <span class="hljs-comment">//æç¤ºä¸‹è½½ç»“æœ</span><br>        <span class="hljs-keyword">if</span> (result)&#123;<br>            Toast.makeText(context, <span class="hljs-string">&quot;Download succeeded&quot;</span>, Toast.LENGTH_SHORT).show();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Toast.makeText(context, <span class="hljs-string">&quot;Download failed&quot;</span>, Toast.LENGTH_SHORT).show();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªDownloadTaskä¸­ï¼Œæˆ‘ä»¬åœ¨<code>doInBackground()</code>æ–¹æ³•é‡Œå»æ‰§è¡Œå…·ä½“çš„ä¸‹è½½ä»»åŠ¡ã€‚è¿™ä¸ªæ–¹æ³•é‡Œçš„ä»£ç éƒ½æ˜¯åœ¨å­çº¿ç¨‹ä¸­è¿è¡Œçš„ï¼Œå› è€Œä¸ä¼šå½±å“åˆ°ä¸»çº¿ç¨‹çš„è¿è¡Œã€‚æ³¨æ„è¿™é‡Œè™šæ„äº†ä¸€ä¸ª<code>doDownload()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºè®¡ç®—å½“å‰çš„ä¸‹è½½è¿›åº¦å¹¶è¿”å›ï¼Œæˆ‘ä»¬å‡è®¾è¿™ä¸ªæ–¹æ³•å·²ç»å­˜åœ¨äº†ã€‚åœ¨å¾—åˆ°äº†å½“å‰çš„ä¸‹è½½è¿›åº¦åï¼Œä¸‹é¢å°±è¯¥è€ƒè™‘å¦‚ä½•æŠŠå®ƒæ˜¾ç¤ºåˆ°ç•Œé¢ä¸Šäº†ï¼Œç”±äº<code>doInBackground()</code>æ–¹æ³•æ˜¯åœ¨å­çº¿ç¨‹ä¸­è¿è¡Œçš„ï¼Œåœ¨è¿™é‡Œè‚¯å®šä¸èƒ½è¿›è¡ŒUIæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>publishProgress()</code>æ–¹æ³•å¹¶å°†å½“å‰çš„ä¸‹è½½è¿›åº¦ä¼ è¿›æ¥ï¼Œè¿™æ ·<code>onProgressUpdate()</code>æ–¹æ³•å°±ä¼šå¾ˆå¿«è¢«è°ƒç”¨ï¼Œåœ¨è¿™é‡Œå°±å¯ä»¥è¿›è¡ŒUIæ“ä½œäº†ã€‚å½“ä¸‹è½½å®Œæˆåï¼Œ<code>doInBackground()</code>æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å‹å˜é‡ï¼Œè¿™æ ·<code>onPostExecute()</code>æ–¹æ³•å°±ä¼šå¾ˆå¿«è¢«è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œçš„ã€‚ç„¶ååœ¨è¿™é‡Œæˆ‘ä»¬ä¼šæ ¹æ®ä¸‹è½½çš„ç»“æœæ¥å¼¹å‡ºç›¸åº”çš„Toastæç¤ºï¼Œä»è€Œå®Œæˆæ•´ä¸ªDownloadTaskä»»åŠ¡ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œä½¿ç”¨AsyncTaskçš„è¯€çªå°±æ˜¯ï¼Œåœ¨<code>doInBackground()</code>æ–¹æ³•ä¸­æ‰§è¡Œå…·ä½“çš„è€—æ—¶ä»»åŠ¡ï¼Œåœ¨<code>onProgressUpdate()</code>æ–¹æ³•ä¸­è¿›è¡ŒUIæ“ä½œï¼Œåœ¨<code>onPostExecute()</code>æ–¹æ³•ä¸­æ‰§è¡Œä¸€äº›ä»»åŠ¡çš„æ”¶å°¾å·¥ä½œã€‚</p><p>å¦‚æœæƒ³è¦å¯åŠ¨è¿™ä¸ªä»»åŠ¡ï¼Œåªéœ€ç¼–å†™ä»¥ä¸‹ä»£ç å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">DownloadTask</span>().execute();<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±æ˜¯AsyncTaskçš„åŸºæœ¬ç”¨æ³•ã€‚ä»ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å»è€ƒè™‘ä»€ä¹ˆå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œä¹Ÿä¸éœ€è¦ä¸“é—¨ä½¿ç”¨ä¸€ä¸ªHandleræ¥å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œåªéœ€è¦è°ƒç”¨ä¸€ä¸‹<code>publishProgress()</code>æ–¹æ³•ï¼Œå°±å¯ä»¥è½»æ¾åœ°ä»å­çº¿ç¨‹åˆ‡æ¢åˆ°UIçº¿ç¨‹äº†ã€‚</p><h1 id="ä¸‰ã€Serviceçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#ä¸‰ã€Serviceçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ä¸‰ã€Serviceçš„ç”Ÿå‘½å‘¨æœŸ"></a>ä¸‰ã€Serviceçš„ç”Ÿå‘½å‘¨æœŸ</h1><h2 id="3-1-ç”Ÿå‘½å‘¨æœŸæ–¹æ³•"><a href="#3-1-ç”Ÿå‘½å‘¨æœŸæ–¹æ³•" class="headerlink" title="3.1 ç”Ÿå‘½å‘¨æœŸæ–¹æ³•"></a>3.1 ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</h2><ul><li>**onCreate()**ï¼šå½“Serviceç¬¬ä¸€æ¬¡è¢«åˆ›å»ºåç«‹å³å›è°ƒè¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼</li><li>**onDestory()**ï¼šå½“Serviceè¢«å…³é—­æ—¶ä¼šå›è°ƒè¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åªä¼šå›è°ƒä¸€æ¬¡ï¼</li><li><strong>onStartCommand(intent,flag,startId)<strong>ï¼šå¯å¤šæ¬¡è°ƒç”¨StartServiceæ–¹æ³•ï¼Œ ä½†ä¸ä¼šå†åˆ›å»ºæ–°çš„Serviceå¯¹è±¡ï¼Œè€Œæ˜¯ç»§ç»­å¤ç”¨å‰é¢äº§ç”Ÿçš„Serviceå¯¹è±¡ï¼Œ</strong>ä½†ä¼šç»§ç»­å›è°ƒ onStartCommand()æ–¹æ³•</strong>ã€‚</li><li><strong>onbind(intent)<strong>ï¼šè¯¥æ–¹æ³•æ˜¯Serviceéƒ½å¿…é¡»å®ç°çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª IBinderå¯¹è±¡ï¼Œ</strong>appé€šè¿‡è¯¥å¯¹è±¡ä¸Serviceç»„ä»¶è¿›è¡Œé€šä¿¡</strong>ï¼</li><li><strong>onUnbind(intent)<strong>ï¼šå½“è¯¥Serviceä¸Šç»‘å®šçš„</strong>æ‰€æœ‰å®¢æˆ·ç«¯éƒ½æ–­å¼€</strong>æ—¶ä¼šå›è°ƒè¯¥æ–¹æ³•ï¼</li><li>**stopSelf()**ï¼šServiceè‡ªèº«è°ƒç”¨ï¼Œç”¨äºå…³é—­æœåŠ¡ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131920190.png"></p><h2 id="3-2-ä¸¤ç§å¯åŠ¨æ–¹å¼çš„åŒºåˆ«"><a href="#3-2-ä¸¤ç§å¯åŠ¨æ–¹å¼çš„åŒºåˆ«" class="headerlink" title="3.2 ä¸¤ç§å¯åŠ¨æ–¹å¼çš„åŒºåˆ«"></a>3.2 ä¸¤ç§å¯åŠ¨æ–¹å¼çš„åŒºåˆ«</h2><ol><li><strong>StartService</strong><ul><li>ç³»ç»Ÿå¯¹åŒä¸€ä¸ªServiceåªä¼šåˆ›å»ºä¸€ä¸ªServiceå®ä¾‹ã€‚å¦‚æœServiceå®ä¾‹ä¸å­˜åœ¨ï¼Œè°ƒç”¨<code>startService()</code>æ–¹æ³•åˆ™ä¼šå®ä¾‹åŒ–ä¸€ä¸ªServiceå¯¹è±¡ï¼Œå¦åˆ™å¤ç”¨ä¹‹å‰åˆ›å»ºçš„Serviceå®ä¾‹ã€‚</li><li>é€šè¿‡<code>StopService()</code>å…³é—­Serviceã€‚</li><li>å¦‚æœè°ƒç”¨è€…ç›´æ¥é€€å‡ºè€Œæ²¡æœ‰è°ƒç”¨<code>StopService()</code>æ–¹æ³•ï¼ŒServiceä¼šä¸€ç›´åœ¨åå°è¿è¡Œã€‚è¯¥Serviceçš„è°ƒç”¨è€…å†å¯åŠ¨èµ·æ¥åå¯ä»¥é€šè¿‡<code>StopService()</code>å…³é—­Serviceã€‚</li></ul></li><li><strong>BindService</strong><ul><li>ç³»ç»Ÿå¯¹åŒä¸€ä¸ªServiceåªä¼šåˆ›å»ºä¸€ä¸ªServiceå®ä¾‹ã€‚å¦‚æœServiceå®ä¾‹ä¸å­˜åœ¨ï¼Œè°ƒç”¨bindServiceåˆ™ä¼šå®ä¾‹åŒ–ä¸€ä¸ªServiceå¯¹è±¡ï¼Œå¦åˆ™å¤ç”¨ä¹‹å‰åˆ›å»ºçš„Serviceå®ä¾‹ã€‚</li><li>å½“Serviceåªä¸ä¸€ä¸ªå®¢æˆ·ç«¯ç»‘å®šæ—¶ï¼Œè°ƒç”¨<code>unbindService()</code>æˆ–è€…è°ƒç”¨è€…é€€å‡ºï¼ŒServiceä¼šè¢«é”€æ¯ã€‚å½“Serviceä¸å¤šä¸ªå®¢æˆ·ç«¯ç»‘å®šæ—¶ï¼Œåªæœ‰ä¸æ‰€æœ‰å®¢æˆ·ç«¯å–æ¶ˆç»‘å®šåï¼ŒServiceæ‰ä¼šè¢«é”€æ¯ã€‚</li></ul></li></ol><h2 id="3-3-ä½“éªŒServiceçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#3-3-ä½“éªŒServiceçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="3.3 ä½“éªŒServiceçš„ç”Ÿå‘½å‘¨æœŸ"></a>3.3 ä½“éªŒServiceçš„ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="3-3-1-éç»‘å®šå¯åŠ¨"><a href="#3-3-1-éç»‘å®šå¯åŠ¨" class="headerlink" title="3.3.1 éç»‘å®šå¯åŠ¨"></a>3.3.1 éç»‘å®šå¯åŠ¨</h3><p>åˆ›å»ºä¸€ä¸ªæœåŠ¡ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;aaa&quot;</span>;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onBind: &quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onUnbind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onUnbind: &quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onUnbind(intent);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onCreate: &quot;</span>);<br>        <span class="hljs-built_in">super</span>.onCreate();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onStartCommand: &quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onStartCommand(intent, flags, startId);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onDestroy: &quot;</span>);<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸è¦å¿˜è®°åœ¨<code>AndroidManifest.xml</code>ä¸­æ³¨å†Œè¯¥æœåŠ¡ï¼</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.MyService&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>å¦å¤–<code>activity_main.xml</code>ä¸­çš„é…ç½®å°±ä¸¤ä¸ªæŒ‰é’®ï¼Œç»‘å®šå¯åŠ¨æœåŠ¡å’Œé”€æ¯æœåŠ¡çš„åŠŸèƒ½ï¼Œ<code>MainActivity.java</code>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">StartService</span><span class="hljs-params">(View view)</span> &#123;<br>        startService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyService.class));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">StopService</span><span class="hljs-params">(View view)</span> &#123;<br>        stopService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyService.class));<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦ä½¿ç”¨åˆ°çš„æ–¹æ³•æ˜¯<code>startService()</code>å¯åŠ¨æœåŠ¡å’Œ<code>stopService()</code>å…³é—­æœåŠ¡ã€‚</p><p>é€šè¿‡ä¸Šé¢ä»£ç ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°éç»‘å®šæœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸä¸ºï¼šonCreate() -&gt; onStartCommand() -&gt; onDestroy()ã€‚</p><h3 id="3-3-2-ç»‘å®šå¯åŠ¨"><a href="#3-3-2-ç»‘å®šå¯åŠ¨" class="headerlink" title="3.3.2 ç»‘å®šå¯åŠ¨"></a>3.3.2 ç»‘å®šå¯åŠ¨</h3><p>åœ¨ 3.1.1çš„ä¾‹å­ä¸Šï¼Œé¢å¤–æ·»åŠ ä¸¤ä¸ªæŒ‰é’®ï¼Œç”¨äºç»‘å®šå’Œè§£ç»‘æœåŠ¡ï¼Œå¹¶é¢å¤–åˆ›å»ºä¸€ä¸ª<code>ServiceConnection</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">BindService</span><span class="hljs-params">(View view)</span> &#123;<br>    bindService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyService.class),conn, Context.BIND_AUTO_CREATE);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">UnbindService</span><span class="hljs-params">(View view)</span> &#123;<br>    unbindService(conn);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName componentName, IBinder iBinder)</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceDisconnected</span><span class="hljs-params">(ComponentName componentName)</span> &#123;<br><br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸»è¦ä½¿ç”¨åˆ°çš„æ–¹æ³•æ˜¯<code>bindService()</code>ç»‘å®šå¹¶å¯åŠ¨æœåŠ¡å’Œ<code>unbindService()</code>è§£ç»‘å¹¶å…³é—­æœåŠ¡ã€‚</p><p>é€šè¿‡ä¸Šé¢ä»£ç ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°éç»‘å®šæœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸä¸ºï¼šonCreate() -&gt; onBind() -&gt; onUnbind() -&gt; onDestroy()ã€‚</p><h1 id="å››ã€Serviceçš„åŸºæœ¬ç”¨æ³•"><a href="#å››ã€Serviceçš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="å››ã€Serviceçš„åŸºæœ¬ç”¨æ³•"></a>å››ã€Serviceçš„åŸºæœ¬ç”¨æ³•</h1><h2 id="4-1-åˆ›å»ºä¸€ä¸ªæœåŠ¡"><a href="#4-1-åˆ›å»ºä¸€ä¸ªæœåŠ¡" class="headerlink" title="4.1 åˆ›å»ºä¸€ä¸ªæœåŠ¡"></a>4.1 åˆ›å»ºä¸€ä¸ªæœåŠ¡</h2><p>åœ¨é¡¹ç›®ä¸­å³é”®åŒ…å â†’ New â†’ Service â†’ Serviceï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œéœ€è¦æˆ‘ä»¬ç»™æœåŠ¡å‘½åï¼ŒåŒæ—¶è¿˜æœ‰ä¸¤ä¸ªå±æ€§ï¼ŒExportedå±æ€§è¡¨ç¤ºæ˜¯å¦å…è®¸é™¤äº†å½“å‰ç¨‹åºä¹‹å¤–çš„å…¶ä»–ç¨‹åºè®¿é—®è¿™ä¸ªæœåŠ¡ï¼ŒEnabledå±æ€§è¡¨ç¤ºæ˜¯å¦å¯ç”¨è¿™ä¸ªæœåŠ¡ã€‚å°†ä¸¤ä¸ªå±æ€§éƒ½å‹¾ä¸­ï¼Œç‚¹å‡»Finishå®Œæˆåˆ›å»ºã€‚è¿™æ ·åˆ›å»ºçš„æœåŠ¡ï¼Œä¼šè‡ªåŠ¨åœ¨<code>AndroidManifest.xml</code>ä¸­è¿›è¡Œå£°æ˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">application</span></span><br><span class="hljs-tag">        <span class="hljs-attr">......</span></span><br><span class="hljs-tag">        &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">service</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.MyService&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:enabled</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span><br>......<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="4-2-Activityä¸Serviceé€šä¿¡"><a href="#4-2-Activityä¸Serviceé€šä¿¡" class="headerlink" title="4.2 Activityä¸Serviceé€šä¿¡"></a>4.2 Activityä¸Serviceé€šä¿¡</h2><p>Activityä¸Serviceä¹‹é—´çš„äº¤æµåª’ä»‹æ˜¯Serviceä¸­çš„<code>onBind()</code>æ–¹æ³•ï¼Œå®ƒå¸¦æœ‰Intentå‚æ•°ï¼Œå¹¶ä¸”è¿”å›å€¼ä¸º IBinderï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥é€šè¿‡IBinderæ¥ä¼ é€’æ•°æ®ã€‚</p><p>å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åœ¨è‡ªå®šä¹‰Serviceç±»ä¸­ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªBinderç±»ï¼Œå°†è¦æš´éœ²çš„æ–¹æ³•å†™åˆ°è¯¥ç±»ä¸­ï¼ŒåŒæ—¶å®ä¾‹åŒ–è¿™ä¸ªç±»ã€‚</li><li>ç„¶åé‡å†™onBind()æ–¹æ³•ï¼Œå°†è¿™ä¸ªBinderå¯¹è±¡è¿”å›ã€‚</li><li>åœ¨è°ƒç”¨è¯¥Serviceçš„Activityä¸­ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªServiceConnectionå¯¹è±¡ï¼Œé‡å†™<code>onServiceConnected()</code>æ–¹æ³•æ¥è·å–Binderå¯¹è±¡ï¼Œä¹‹åè°ƒç”¨ç›¸å…³æ–¹æ³•å³å¯ï¼</li></ol><p>ä»¥æ¨¡æ‹Ÿä¸‹è½½ä¸ºä¾‹ã€‚é¦–å…ˆä¸»æ´»åŠ¨çš„xmlæ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ç‚¹å‡»ä¸‹è½½&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;ClickDownload&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;è·å–ä¸‹è½½è¿›åº¦&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;getDownloadProgress&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªç”¨äºæ¨¡æ‹Ÿä¸‹è½½ï¼Œä¸€ä¸ªç”¨äºè·å–ä¸‹è½½è¿›åº¦ã€‚</p><p>åˆ›å»ºMyServiceç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    <span class="hljs-comment">//å®ä¾‹åŒ–è‡ªå®šä¹‰Binderç±»</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">MyBinder</span> <span class="hljs-variable">myBinder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyBinder</span>();<br>    <span class="hljs-comment">//åœ¨onBindæ–¹æ³•ä¸­è¿”å›binderç±»å¯¹è±¡</span><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        <span class="hljs-keyword">return</span> myBinder;<br>    &#125;<br>    <span class="hljs-comment">//å†…éƒ¨ç±»</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBinder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Binder</span>&#123;<br>        <span class="hljs-comment">//è¿›åº¦æ¡æœ€å¤§å€¼</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MaxProgress</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br>        <span class="hljs-comment">//å½“å‰çš„è¿›åº¦</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">currentProgress</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//è·å–å½“å‰è¿›åº¦</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCurrentProgress</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> currentProgress;<br>        &#125;<br>        <span class="hljs-comment">//æ¨¡æ‹Ÿä¸‹è½½,å®ç°è¿›åº¦æ¡çš„ç§»åŠ¨</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">StartDownload</span><span class="hljs-params">()</span>&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    <span class="hljs-keyword">while</span>(currentProgress &lt; MaxProgress)&#123;<br>                        currentProgress += <span class="hljs-number">1</span>;<br>                        <span class="hljs-keyword">try</span>&#123;<br>                            Thread.sleep(<span class="hljs-number">500</span>);<br>                        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                            e.printStackTrace();<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;).start();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å…¶å†…éƒ¨å®šä¹‰äº†MyBinderç±»ï¼Œå®ç°äº†è·å–ä¸‹è½½è¿›åº¦å’Œæ¨¡æ‹Ÿä¸‹è½½çš„åŠŸèƒ½ã€‚</p><p>ä¸»æ´»åŠ¨çš„javaä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><span class="hljs-comment">//Serviceå†…éƒ¨ç±»å¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> MyService.MyBinder myBinder;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><span class="hljs-comment">//ç»‘å®šå¯åŠ¨æœåŠ¡</span><br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyService.class);<br>        bindService(intent,conn, Context.BIND_AUTO_CREATE);<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName componentName, IBinder iBinder)</span> &#123;<br>            <span class="hljs-comment">//è·å–è¿”å›çš„binderå¯¹è±¡ </span><br>            myBinder = (MyService.MyBinder)iBinder;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceDisconnected</span><span class="hljs-params">(ComponentName componentName)</span> &#123;<br><br>        &#125;<br>    &#125;;<br><span class="hljs-comment">//è·å–ä¸‹è½½è¿›åº¦å¹¶å¼¹çª—æ˜¾ç¤º</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDownloadProgress</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">currentProgress</span> <span class="hljs-operator">=</span> myBinder.getCurrentProgress();<br>        Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;å½“å‰ä¸‹è½½è¿›åº¦ä¸º: &quot;</span> + Integer.toString(currentProgress), Toast.LENGTH_SHORT).show();<br>    &#125;<br><span class="hljs-comment">//æ¨¡æ‹Ÿä¸‹è½½</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClickDownload</span><span class="hljs-params">(View view)</span> &#123;<br>        myBinder.StartDownload();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-3-ç®€å•çš„å‰å°æœåŠ¡"><a href="#4-3-ç®€å•çš„å‰å°æœåŠ¡" class="headerlink" title="4.3 ç®€å•çš„å‰å°æœåŠ¡"></a>4.3 ç®€å•çš„å‰å°æœåŠ¡</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼ŒServiceéƒ½æ˜¯è¿è¡Œåœ¨åå°çš„ã€‚ä½†æ˜¯Serviceçš„ç³»ç»Ÿä¼˜å…ˆçº§æ¯”è¾ƒä½ï¼Œå¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œå°±æœ‰å¯èƒ½å›æ”¶æ­£åœ¨åå°è¿è¡Œçš„Serviceã€‚</p><p>é‚£å¦‚ä½•è§£å†³ä¸Šè¿°æƒ…å†µå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‰å°æœåŠ¡ï¼Œä»è€Œè®©Serviceè¢«æ€æ­»çš„å¯èƒ½æ€§é™ä½ï¼Œæ‰€è°“çš„å‰å°æœåŠ¡å°±æ˜¯çŠ¶æ€æ æ˜¾ç¤ºçš„Notificationã€‚</p><p>å®ç°æ–¹æ³•ï¼šåœ¨è‡ªå®šä¹‰çš„Serviceç±»ä¸­é‡å†™<code>onCreate()</code>ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚å®šåˆ¶Notificationï¼Œæœ€åè°ƒç”¨<code>startForeground(id,notification)</code>å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate();<br>        <span class="hljs-comment">//è·å–é€šçŸ¥ç®¡ç†æœåŠ¡</span><br>        <span class="hljs-type">NotificationManager</span> <span class="hljs-variable">notificationSystem</span> <span class="hljs-operator">=</span> (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);<br>        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O)&#123;<br>            <span class="hljs-comment">//åˆ›å»ºé€šçŸ¥æ¸ é“å¯¹è±¡</span><br>            <span class="hljs-type">NotificationChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotificationChannel</span>(<span class="hljs-string">&quot;nid001&quot;</span>, <span class="hljs-string">&quot;éšä¾¿&quot;</span>,NotificationManager.IMPORTANCE_LOW);<br>            <span class="hljs-comment">//é€šçŸ¥æ¸ é“å¯¹è±¡ä¸é€šçŸ¥ç®¡ç†æœåŠ¡å¯¹è±¡ç»‘å®š</span><br>            notificationSystem.createNotificationChannel(channel);<br>        &#125;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MainActivity.class);<br>        <span class="hljs-type">PendingIntent</span> <span class="hljs-variable">pendingIntent</span> <span class="hljs-operator">=</span> PendingIntent.getActivity(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>, intent, PendingIntent.FLAG_MUTABLE);<br><br>        Notification.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Notification</span>.Builder(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;nid001&quot;</span>);<br>        builder.setContentIntent(pendingIntent)<br>                .setAutoCancel(<span class="hljs-literal">false</span>)<br>                .setSmallIcon(R.mipmap.ic_launcher)<br>                .setContentTitle(<span class="hljs-string">&quot;åº”ç”¨å®&quot;</span>)<br>                .setContentText(<span class="hljs-string">&quot;æ­£åœ¨ä¸‹è½½XXX...&quot;</span>);<br>        <span class="hljs-type">Notification</span> <span class="hljs-variable">notification</span> <span class="hljs-operator">=</span> builder.build();<br>        startForeground(<span class="hljs-number">1</span>,notification);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦ç»™åº”ç”¨<code>android.permission.FOREGROUND_SERVICE</code>æƒé™ï¼Œåœ¨<code>AndroidManifest.xml</code>ä¸­çš„<code>&lt;manifest&gt;</code>æ ‡ç­¾ä¸­å£°æ˜ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.FOREGROUND_SERVICE&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h2 id="4-4-æ‰§è¡Œå®šæ—¶ä»»åŠ¡"><a href="#4-4-æ‰§è¡Œå®šæ—¶ä»»åŠ¡" class="headerlink" title="4.4 æ‰§è¡Œå®šæ—¶ä»»åŠ¡"></a>4.4 æ‰§è¡Œå®šæ—¶ä»»åŠ¡</h2><p>åœ¨å®é™…å¼€å‘ä¸­ï¼ŒServiceä¹Ÿå¸¸ç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚è½®è¯¢ï¼Œå°±æ˜¯æ¯é—´éš”ä¸€æ®µæ—¶é—´å°±è¯·æ±‚ä¸€æ¬¡æœåŠ¡å™¨ï¼Œç¡®è®¤å®¢æˆ·ç«¯çŠ¶æ€æˆ–è€…è¿›è¡Œä¿¡æ¯æ›´æ–°ç­‰ã€‚ä¸Šè¿°åŠŸèƒ½çš„å®ç°éœ€è¦ä¾é Androidæä¾›çš„å®šæ—¶æ–¹å¼ï¼šTimerç±»æˆ–Alarmæœºåˆ¶ã€‚</p><p>Timerç±»ä¸é€‚åˆäºéœ€è¦é•¿æœŸåœ¨åå°è¿è¡Œçš„å®šæ—¶ä»»åŠ¡ï¼ŒCPUä¸€æ—¦ä¼‘çœ ï¼ŒTimerä¸­çš„å®šæ—¶ä»»åŠ¡å°±æ— æ³•è¿è¡Œã€‚è€Œç”±äºAlarmæœºåˆ¶å…·æœ‰å”¤é†’CPUçš„åŠŸèƒ½ï¼Œæ‰€ä»¥ä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚</p><p>å®ç°æ–¹æ³•ï¼š</p><ol><li>å®šä¹‰ä¸€ä¸ªServiceç±»å¹¶è¿›è¡Œæ³¨å†Œã€‚é‡å†™Serviceçš„<code>onStartCommand()</code>æ–¹æ³•ã€‚å…·ä½“ä¸ºï¼š<ul><li>å¼€è¾Ÿçº¿ç¨‹å¤„ç†äº‹åŠ¡</li><li>é€šè¿‡<code>getSystemService(ALARM_SERVICE)</code>è·å¾—AlarmManagerå¯¹è±¡</li><li>é€šè¿‡PendingIntentè®¾ç½®å”¤é†’å¯¹è±¡å’Œå”¤é†’æ–¹å¼</li><li>é€šè¿‡<code>AlarmManager.set()</code>æ–¹æ³•è®¾ç½®å®šæ—¶ä»»åŠ¡</li></ul></li><li>å®šä¹‰ä¸€ä¸ªBroadcastç±»å¹¶è¿›è¡Œæ³¨å†Œï¼Œé€šè¿‡<code>context.startService()</code>æ¥å”¤é†’æœåŠ¡ã€‚</li><li>åœ¨ä¸»æ´»åŠ¨ä¸­é€šè¿‡<code>startService()</code>æ–¹æ³•æ¥å¯åŠ¨æœåŠ¡ã€‚</li></ol><p>ä»¥ä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚</p><p>é¦–å…ˆè‡ªå®šä¹‰BroadcastReceiverç±»ï¼Œå¹¶åœ¨<code>AndroidManifest.xml</code>æ³¨å†Œï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAlarmReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br><span class="hljs-comment">//å‘é€å¹¿æ’­æ¥å¯åŠ¨æœåŠ¡</span><br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(context, MyService.class);<br>        context.startService(intent1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡å¹¿æ’­æ¥å¯åŠ¨MyServiceï¼Œè¿™ä¸ªMyAlarmReceiverç±»åˆ™é€šè¿‡Alarmæœºåˆ¶æ¥å¯åŠ¨ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯è‡ªå®šä¹‰Serviceç±»ï¼ŒåŒæ ·åœ¨<code>AndroidManifest.xml</code>æ³¨å†Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> &#123;<br>        <span class="hljs-comment">//å¼€è¾Ÿçº¿ç¨‹æ¥è¿›è¡Œæƒ³è¦çš„æ“ä½œ</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                Log.d(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().toString());<br>            &#125;<br>        &#125;).start();<br>        <span class="hljs-comment">//è·å–AlarmManager</span><br>        <span class="hljs-type">AlarmManager</span> <span class="hljs-variable">alarmmanager</span> <span class="hljs-operator">=</span> (AlarmManager)getSystemService(ALARM_SERVICE);<br>        <span class="hljs-comment">//è®¾ç½®æ—¶é—´é—´éš”ï¼Œè¿™é‡Œæ˜¯æ¯2så”¤é†’ä¸€æ¬¡Service</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">anHour</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> * <span class="hljs-number">1000</span>;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">triggerAtTime</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime() + anHour;<br>        <span class="hljs-comment">//é€šè¿‡Intentè®¾ç½®å”¤é†’çš„BroadcastReceiver</span><br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">alarmIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyAlarmReceiver.class);<br>        <span class="hljs-comment">//è®¾ç½®å”¤é†’æ–¹å¼ä¸ºBroadcastå”¤é†’</span><br>        <span class="hljs-type">PendingIntent</span> <span class="hljs-variable">pendingIntent</span> <span class="hljs-operator">=</span> PendingIntent.getBroadcast(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>, alarmIntent, PendingIntent.FLAG_IMMUTABLE);<br>        <span class="hljs-comment">//æäº¤ç»™AlarmManagerå®Œæˆ</span><br>        alarmmanager.set(AlarmManager.ELAPSED_REALTIME_WAKEUP, triggerAtTime,pendingIntent);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onStartCommand(intent, flags, startId);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ä¸»æ´»åŠ¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyService.class);<br>        startService(intent);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼ï¼ï¼ä¸èƒ½ä½¿ç”¨bindService()æ–¹æ³•å¯åŠ¨æœåŠ¡ï¼ï¼ï¼å› ä¸ºbindService()æ–¹æ³•ä¸ä¼šæ‰§è¡Œç”Ÿå‘½å‘¨æœŸçš„onStartCommand()æ–¹æ³•ï¼ï¼ï¼</strong></p><h2 id="4-5-ä½¿ç”¨IntentService"><a href="#4-5-ä½¿ç”¨IntentService" class="headerlink" title="4.5 ä½¿ç”¨IntentService"></a>4.5 ä½¿ç”¨IntentService</h2><p>æœåŠ¡ä¸­çš„ä»£ç éƒ½æ˜¯é»˜è®¤è¿è¡Œåœ¨ä¸»çº¿ç¨‹å½“ä¸­çš„ï¼Œå¦‚æœç›´æ¥åœ¨æœåŠ¡é‡Œå»å¤„ç†ä¸€äº›è€—æ—¶çš„é€»è¾‘ï¼Œå°±å¾ˆå®¹æ˜“å‡ºç°<code>ANR(Application Not Responding)</code>çš„æƒ…å†µã€‚</p><p>æ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°Androidå¤šçº¿ç¨‹ç¼–ç¨‹çš„æŠ€æœ¯äº†ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨æœåŠ¡çš„æ¯ä¸ªå…·ä½“çš„æ–¹æ³•é‡Œå¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œç„¶ååœ¨è¿™é‡Œå»å¤„ç†é‚£äº›è€—æ—¶çš„é€»è¾‘ã€‚å› æ­¤ï¼Œä¸€ä¸ªæ¯”è¾ƒæ ‡å‡†çš„æœåŠ¡å°±å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    ......<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-comment">//å¤„ç†å…·ä½“çš„é€»è¾‘</span><br>            &#125;<br>        &#125;).start();<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onStartCommand(intent, flags, startId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œè¿™ç§æœåŠ¡ä¸€æ—¦å¯åŠ¨ä¹‹åï¼Œå°±ä¼šä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå¿…é¡»è°ƒç”¨<code>stopService()</code>æˆ–è€…<code>stopSelf()</code>æ–¹æ³•æ‰èƒ½è®©æœåŠ¡åœæ­¢ä¸‹æ¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦å®ç°è®©ä¸€ä¸ªæœåŠ¡åœ¨æ‰§è¡Œå®Œæ¯•åè‡ªåŠ¨åœæ­¢çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    ......<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-comment">//å¤„ç†å…·ä½“çš„é€»è¾‘</span><br>            stopSelf();<br>            &#125;<br>        &#125;).start();<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onStartCommand(intent, flags, startId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è™½è¯´è¿™ç§å†™æ³•å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯æ€»ä¼šæœ‰ä¸€äº›ç¨‹åºå‘˜å¿˜è®°å¼€å¯çº¿ç¨‹ï¼Œæˆ–è€…å¿˜è®°è°ƒç”¨<code>stopSelf()</code>æ–¹æ³•ã€‚ä¸ºäº†å¯ä»¥ç®€å•åœ°åˆ›å»ºä¸€ä¸ªå¼‚æ­¥çš„ã€ä¼šè‡ªåŠ¨åœæ­¢çš„æœåŠ¡ï¼ŒAndroidä¸“é—¨æä¾›äº†ä¸€ä¸ªIntentServiceç±»ï¼Œè¿™ä¸ªç±»å°±å¾ˆå¥½åœ°è§£å†³äº†å‰é¢æ‰€æåˆ°çš„ä¸¤ç§å°´å°¬ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹å®ƒçš„ç”¨æ³•ã€‚</p><p>æ‰‹åŠ¨å»ºä¸€ä¸ªMyIntentServiceç±»ç»§æ‰¿è‡ªIntentServiceï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyIntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IntentService</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyIntentService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(<span class="hljs-string">&quot;MyIntentService&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyIntentService</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onHandleIntent</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Intent intent)</span> &#123;<br>        <span class="hljs-comment">//æ‰“å°å½“å‰çº¿ç¨‹id</span><br>        Log.d(<span class="hljs-string">&quot;MyIntentService&quot;</span>, <span class="hljs-string">&quot;Thread id is &quot;</span> + Thread.currentThread().getId());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        Log.d(<span class="hljs-string">&quot;MyIntentService&quot;</span>, <span class="hljs-string">&quot;Destroyed&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¿™é‡Œé¦–å…ˆè¦æä¾›ä¸€ä¸ªæ— å‚çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”å¿…é¡»åœ¨å…¶å†…éƒ¨è°ƒç”¨çˆ¶ç±»çš„æœ‰å‚æ„é€ å‡½æ•°</strong>ã€‚ç„¶åè¦åœ¨å­ç±»ä¸­å»å®ç°<code>onHandleIntent()</code>è¿™ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å¯ä»¥å»å¤„ç†ä¸€äº›å…·ä½“çš„é€»è¾‘ï¼Œè€Œä¸”ä¸ç”¨æ‹…å¿ƒ<code>ANR</code>çš„é—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å·²ç»æ˜¯åœ¨å­çº¿ç¨‹ä¸­è¿è¡Œçš„äº†ã€‚è¿™é‡Œä¸ºäº†è¯å®ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨<code>onHandleIntent()</code>æ–¹æ³•ä¸­æ‰“å°äº†å½“å‰çº¿ç¨‹çš„idã€‚å¦å¤–æ ¹æ®IntentServiceçš„ç‰¹æ€§ï¼Œè¿™ä¸ªæœåŠ¡åœ¨è¿è¡Œç»“æŸååº”è¯¥æ˜¯ä¼šè‡ªåŠ¨åœæ­¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆé‡å†™äº†onDestroy()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œä¹Ÿæ‰“å°äº†ä¸€è¡Œæ—¥å¿—ï¼Œä»¥è¯å®æœåŠ¡æ˜¯ä¸æ˜¯åœæ­¢æ‰äº†ã€‚</p><p>è™½ç„¶MyIntentServiceç»§æ‰¿äºIntentServiceï¼Œä½†IntentServiceæ˜¯ç»§æ‰¿äºServiceçš„ï¼Œæ‰€ä»¥MyIntentServiceä»ç„¶æ˜¯ä¸ªæœåŠ¡ï¼Œå› æ­¤ä¸è¦å¿˜è®°åœ¨<code>AndroidManifest.xml</code>ä¸­è¿›è¡Œæ³¨å†Œã€‚</p><p>æ¥ä¸‹æ¥ä¿®æ”¹<code>activity_main.xml</code>ä¸­çš„ä»£ç ï¼ŒåŠ å…¥ä¸€ä¸ªç”¨äºå¯åŠ¨MyIntentServiceè¿™ä¸ªæœåŠ¡çš„æŒ‰é’®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">......</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Start IntentService&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;StartIntentService&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åä¿®æ”¹MainActivityä¸­çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">StartIntentService</span><span class="hljs-params">(View view)</span> &#123;<br>        Log.d(<span class="hljs-string">&quot;MainActivity&quot;</span>, <span class="hljs-string">&quot;Thread id is &quot;</span> + Thread.currentThread().getId());<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyIntentService.class);<br>        startService(intent);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶é‡Œé¢å»å¯åŠ¨MyIntentServiceè¿™ä¸ªæœåŠ¡ï¼Œå¹¶åœ¨è¿™é‡Œæ‰“å°äº†ä¸€ä¸‹ä¸»çº¿ç¨‹çš„idï¼Œç”¨äºå’ŒIntentServiceè¿›è¡Œæ¯”å¯¹ã€‚å…¶å®æˆ‘ä»¬å¯ä»¥å‘ç°IntentServiceçš„å¯åŠ¨å’Œæ™®é€šæœåŠ¡çš„å¯åŠ¨ä»£ç æ²¡æœ‰åŒºåˆ«ã€‚</p><p>ä¹‹åè¿è¡Œç¨‹åºå¹¶ç‚¹å‡»æŒ‰é’®ï¼Œè§‚å¯Ÿlogcatä¸­çš„æ‰“å°æ—¥å¿—ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä¸ä»…MyIntentServiceå’ŒMainActivityæ‰€åœ¨çš„çº¿ç¨‹idä¸ä¸€æ ·ï¼Œè€Œä¸”<code>onDestroy()</code>æ–¹æ³•ä¹Ÿå¾—åˆ°äº†æ‰§è¡Œï¼Œè¯´æ˜MyIntentServiceåœ¨è¿è¡Œå®Œæ¯•åç¡®å®è‡ªåŠ¨åœæ­¢äº†ã€‚</p><p>ç»è¿‡è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥çŸ¥é“IntentServiceå…¶å®å°±æ˜¯é›†æˆäº†å¼€å¯çº¿ç¨‹å’Œè‡ªåŠ¨åœæ­¢çš„æœåŠ¡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå¼€å‘å­¦ä¹ ç¬”è®°(å››) â€”â€” é‡æ‹¾Activity</title>
    <link href="/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%9B%9B)%20%E2%80%94%E2%80%94%20%E9%87%8D%E6%8B%BEActivity/"/>
    <url>/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%9B%9B)%20%E2%80%94%E2%80%94%20%E9%87%8D%E6%8B%BEActivity/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯Activity"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯Activity" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯Activity"></a>ä¸€ã€ä»€ä¹ˆæ˜¯Activity</h1><p>Activityæ˜¯Androidå››å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œç”¨äºæ˜¾ç¤ºç”¨æˆ·ç•Œé¢ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬è¿›è¡Œç›¸å…³æ“ä½œï¼Œæ¯”å¦‚æ‰“ç”µè¯ã€å‘çŸ­ä¿¡ç­‰ã€‚Activityéœ€è¦åœ¨<code>AndroidManifest.xml</code>é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œï¼Œå¦åˆ™ç³»ç»Ÿæ— æ³•è¯†åˆ«è¯¥Activityã€‚</p><p>Activityåœ¨ä»£ç ä¸­çš„ä½“ç°æ˜¯ï¼šç»§æ‰¿<code>AppCompatActivity</code>æ‰å«Activityã€‚</p><h1 id="äºŒã€Activityçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#äºŒã€Activityçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="äºŒã€Activityçš„ç”Ÿå‘½å‘¨æœŸ"></a>äºŒã€Activityçš„ç”Ÿå‘½å‘¨æœŸ</h1><h2 id="2-1-Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•"><a href="#2-1-Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•" class="headerlink" title="2.1 Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•"></a>2.1 Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</h2><ul><li><strong>onCreate()<strong>ï¼šåœ¨Activityåˆ›å»ºæ—¶è°ƒç”¨ï¼Œé€šå¸¸åšä¸€äº›åˆå§‹åŒ–è®¾ç½®ï¼Œ</strong>ä¸å¯è§</strong>ã€‚</li><li><strong>onStart()<strong>ï¼šåœ¨Activityç”±ä¸å¯è§å˜ä¸ºå¯è§æ—¶è°ƒç”¨ï¼Œ</strong>å¯è§</strong>ï¼Œæ­¤æ—¶ç”¨æˆ·å¯ä»¥çœ‹åˆ°ç•Œé¢ï¼Œä½†æ²¡æœ‰è·å–åˆ°ç„¦ç‚¹ï¼Œç”¨æˆ·ä¸èƒ½è¿›è¡Œæ“ä½œã€‚</li><li><strong>onResume()<strong>ï¼šæ­¤æ—¶Activityè·å–åˆ°ç„¦ç‚¹ï¼Œèƒ½å¤Ÿä¸ç”¨æˆ·äº¤äº’ï¼Œ</strong>å¯è§</strong>ã€‚æ­¤æ–¹æ³•æ˜¯åœ¨ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’æ—¶è°ƒç”¨ã€‚</li><li><strong>onPause()<strong>ï¼šåœ¨å½“å‰Activityè¢«å…¶å®ƒActivityè¦†ç›–æˆ–é”å±æ—¶è°ƒç”¨ï¼Œ</strong>å¯è§</strong>ï¼Œä½†å¤±å»ç„¦ç‚¹ã€‚æ­¤æ—¶ä¼šå¯¹çŠ¶æ€ä¿¡æ¯å’Œæ•°æ®è¿›è¡Œä¿å­˜ã€‚</li><li><strong>onStop()<strong>ï¼šåœ¨Activityä¸å¯è§æ—¶è°ƒç”¨ï¼Œ</strong>ä¸å¯è§</strong>ï¼ŒActivityè¿›å…¥åˆ°äº†åå°ï¼Œä¸”Activityå¯¹è±¡ä»åœ¨å†…å­˜ä¸­ã€‚</li><li>**onDestroy()**ï¼šåœ¨Activityé”€æ¯æ—¶è°ƒç”¨ã€‚</li><li>**onRestart()**ï¼šå½“å¤„äºStoppedçŠ¶æ€çš„æ´»åŠ¨éœ€è¦å†æ¬¡å±•ç°ç»™ç”¨æˆ·æ—¶è°ƒç”¨ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131918363.jpg"></p><p>åœ¨ä¸Šè¿°å›¾ç‰‡ä¸­ï¼Œå¯ä»¥å°†å†…å®¹å½’çº³ä¸ºä¸‰ä¸ªå‘¨æœŸï¼š</p><ol><li>å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼šonCreate() â†’ onStart() â†’ onResume() â†’ Activity running â†’ onPause() â†’ onStop() â†’ onDestory()</li><li>å¯è§ç”Ÿå‘½å‘¨æœŸï¼šonStart() â†’ onResume() â†’ Activity running â†’ onPause() â†’ onStop() â†’ onRestart()</li><li>å‰å°ç”Ÿå‘½å‘¨æœŸï¼šonResume() â†’ Activity running â†’ onPause()</li></ol><h2 id="2-2-ä½“éªŒActivityçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#2-2-ä½“éªŒActivityçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2.2 ä½“éªŒActivityçš„ç”Ÿå‘½å‘¨æœŸ"></a>2.2 ä½“éªŒActivityçš„ç”Ÿå‘½å‘¨æœŸ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;aaa&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        Log.d(TAG, <span class="hljs-string">&quot;onCreate: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onStart();<br>        Log.d(TAG, <span class="hljs-string">&quot;onStart: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResume</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onResume();<br>        Log.d(TAG, <span class="hljs-string">&quot;onResume: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onPause();<br>        Log.d(TAG, <span class="hljs-string">&quot;onPause: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onStop();<br>        Log.d(TAG, <span class="hljs-string">&quot;onStop: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        Log.d(TAG, <span class="hljs-string">&quot;onDestroy: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//å¯åŠ¨å¦ä¸€ä¸ªActivity</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAnotherActivity</span><span class="hljs-params">(View view)</span> &#123;<br>        startActivity(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,SecondaryActivity.class));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¹æ®<code>Logcat</code>ä¸­çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p><ol><li>å¯åŠ¨Activityï¼šonCreate() -&gt; onStart() -&gt; onResume()</li><li>åŸºäº1ï¼ŒæŒ‰ä¸‹homeé”®ï¼šonPause() -&gt; onStop()</li><li>åŸºäº2ï¼Œå†æ¬¡è®©Activityå æ®å±å¹•ï¼šonRestart() -&gt; onStart() -&gt; onResume()</li><li>è¢«å…¶ä»–Activityå®Œå…¨è¦†ç›–ï¼šonPause() -&gt; onStop()</li><li>ç›´æ¥é€€å‡ºåº”ç”¨ï¼šonPause() -&gt; onStop() -&gt; onDestroy()</li></ol><h1 id="ä¸‰ã€Activityçš„åŸºæœ¬ç”¨æ³•"><a href="#ä¸‰ã€Activityçš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="ä¸‰ã€Activityçš„åŸºæœ¬ç”¨æ³•"></a>ä¸‰ã€Activityçš„åŸºæœ¬ç”¨æ³•</h1><h2 id="3-1-æ‰‹åŠ¨åˆ›å»ºActivity"><a href="#3-1-æ‰‹åŠ¨åˆ›å»ºActivity" class="headerlink" title="3.1 æ‰‹åŠ¨åˆ›å»ºActivity"></a>3.1 æ‰‹åŠ¨åˆ›å»ºActivity</h2><p>åœ¨å·¥ç¨‹ä¸­ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥ç›´æ¥newå‡ºä¸€å¥—Activityï¼ˆå³å¯¹åº”çš„ç±»ã€xmlæ–‡ä»¶å¹¶åœ¨<code>AndroidManifest.xml</code>ä¸­æ³¨å†Œï¼‰ï¼Œä½†åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºä¸€ä¸‹æ¥ä½“ä¼šActivityçš„åˆ›å»ºè¿‡ç¨‹ã€‚</p><p>é¦–å…ˆéœ€è¦åˆ›å»ºActivityå¯¹åº”çš„å¸ƒå±€æ–‡ä»¶ï¼Œéšä¾¿å†™ä¸€å†™å°±è¡Œ.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--activity_secondary.xml--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;æˆ‘å°†åŸæ¥çš„ä¸»é¡µé¢å˜æˆå¦ä¸€ä¸ªé¡µé¢äº†&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åéœ€è¦ç¼–å†™ç»§æ‰¿<code>AppCompatActivity</code>çš„Activityç±»ï¼Œåªéœ€è¦é‡å†™<code>onCreate()</code>æ–¹æ³•å°±è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondaryActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_secondary);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æœ€ä¸ºå…³é”®ï¼Œå°±æ˜¯<strong>è¦åœ¨<code>AndroidManifest.xml</code>ä¸­å£°æ˜</strong>ï¼Œå°†ä¸‹é¢è¿™æ®µåŠ å…¥åˆ°<code>&lt;application&gt;</code>æ ‡ç­¾ä¸­ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--è‡ªå·±ç¼–å†™çš„Activity--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.SecondaryActivity&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>&lt;activity&gt;</code>æ ‡ç­¾ä¸­çš„<code>android:name</code>æŒ‡å®šè¦è¢«æ³¨å†Œçš„æ´»åŠ¨ï¼ˆå†…å®¹æ˜¯æˆ‘ä»¬ç¼–å†™çš„Acitivityç±»æ‰€åœ¨çš„å…¨é™å®šç±»åçš„ç¼©å†™ï¼‰ã€‚<code>android:exported</code>æŒ‡ç¤ºè¯¥Activityæ˜¯å¦å¯ä»¥è¢«å…¶å®ƒåº”ç”¨ç¨‹åºçš„ç»„ä»¶å¯åŠ¨ã€‚ <code>&lt;action&gt;</code>å’Œ<code>&lt;category&gt;</code>è¿™ä¸¤ä¸ªæ ‡ç­¾çš„å†…å®¹å…±åŒæŒ‡å®šäº†è¯¥æ´»åŠ¨ä¸ºåº”ç”¨è¿è¡Œåå¯åŠ¨çš„ç¬¬ä¸€ä¸ªæ´»åŠ¨ã€‚</p><h2 id="3-2-Activityè·³è½¬"><a href="#3-2-Activityè·³è½¬" class="headerlink" title="3.2 Activityè·³è½¬"></a>3.2 Activityè·³è½¬</h2><p>æ¡ˆä¾‹ï¼šåŸºäº2.1ï¼Œå®ç°é€šè¿‡æŒ‰é’®æ¥è·³è½¬åˆ°å¦ä¸€ä¸ªActivityã€‚</p><p>é¦–å…ˆåœ¨<code>activity_main.xml</code>ä¸­ç¼–å†™æŒ‰é’®æ¥å®ç°ç‚¹å‡»æŒ‰é’®è·³è½¬Activityï¼Œéšä¾¿å†™ä¸€å†™å°±è¡Œï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-comment">&lt;!--activity_main.xml--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;start another activity&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;startAnotherActivity&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨<code>MainActivity.java</code>ä¸­å®ç°è¯¥ç‚¹å‡»äº‹ä»¶å¤„ç†æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAnotherActivity</span><span class="hljs-params">(View view)</span> &#123;<br>    <span class="hljs-comment">//é€šè¿‡startActivityå¯åŠ¨å¦ä¸€ä¸ªActivity</span><br>    startActivity(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,SecondaryActivity.class));<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨çš„æ˜¯æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºçš„æ´»åŠ¨ï¼Œä½†éœ€è¦å°†è¯¥æ´»åŠ¨åœ¨<code>AndroidManifest.xml</code>ä¸­çš„é…ç½®æ”¹ä¸ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.SecondaryActivity&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-2-å¯åŠ¨å¤–éƒ¨åº”ç”¨"><a href="#3-2-å¯åŠ¨å¤–éƒ¨åº”ç”¨" class="headerlink" title="3.2 å¯åŠ¨å¤–éƒ¨åº”ç”¨"></a>3.2 å¯åŠ¨å¤–éƒ¨åº”ç”¨</h2><p>åœ¨åº”ç”¨ç¨‹åºAå¯åŠ¨åº”ç”¨ç¨‹åºBï¼Œå¯ä»¥ä½¿ç”¨æ˜¾ç¤ºIntentå’Œéšå¼Intentï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºå‰è€…æŒ‡å®šäº†ComponentNameï¼Œå¯ä»¥ç›´æ¥å¯åŠ¨ç›®æ ‡ç¨‹åºï¼Œè€Œåè€…æ²¡æœ‰ã€‚åè€…é€šè¿‡ Actionã€Category æˆ– Data ç­‰ä¿¡æ¯æ¥ç­›é€‰å‡ºåˆé€‚çš„åº”ç”¨ç¨‹åºï¼Œå†ç”±ä½¿ç”¨è€…æŒ‘é€‰ï¼ˆå¦‚æœå­˜åœ¨å¤šä¸ªçš„è¯ï¼‰ã€‚</p><p>è¯¦ç»†Intentä»‹ç»å¯è§[Android Intent](<a href="https://gal2xy.github.io/2023/07/04/Android">https://gal2xy.github.io/2023/07/04/Android</a> Intent&#x2F;)ã€‚</p><h3 id="3-2-1-æ˜¾ç¤ºIntentå¯åŠ¨"><a href="#3-2-1-æ˜¾ç¤ºIntentå¯åŠ¨" class="headerlink" title="3.2.1 æ˜¾ç¤ºIntentå¯åŠ¨"></a>3.2.1 æ˜¾ç¤ºIntentå¯åŠ¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAnotherActivity</span><span class="hljs-params">(View view)</span> &#123;<br>    <span class="hljs-comment">//æ˜¾å¼Intent</span><br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>    intent.setComponent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(<span class="hljs-string">&quot;com.example.myapplication&quot;</span>,<span class="hljs-string">&quot;com.example.myapplication.MainActivity&quot;</span>));<br>    startActivity(intent);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>ComponentName</code>æŒ‡å®šäº†è¦æ‰“å¼€çš„åº”ç”¨çš„ä¸»Activityã€‚</p><h3 id="3-2-2-éšå¼Intentå¯åŠ¨"><a href="#3-2-2-éšå¼Intentå¯åŠ¨" class="headerlink" title="3.2.2 éšå¼Intentå¯åŠ¨"></a>3.2.2 éšå¼Intentå¯åŠ¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAnotherActivity</span><span class="hljs-params">(View view)</span> &#123;<br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>    intent.setData(Uri.parse(<span class="hljs-string">&quot;https://baidu.com&quot;</span>));<br>    intent.setAction(Intent.ACTION_VIEW);<br>    intent.addCategory(Intent.CATEGORY_BROWSABLE);<br>    startActivity(intent);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨éšå¼Intentæ¥æ‰“å¼€ä¸€ä¸ªé“¾æ¥ï¼Œå…¶ä¸­<code>Intent.ACTION_VIEW</code>è¡¨ç¤ºæŸ¥çœ‹æŒ‡å®šæ•°æ®ï¼ˆå¦‚æ‰“å¼€ç½‘å€ã€æ˜¾ç¤ºåœ°å›¾ç­‰ï¼‰ã€‚<code>Intent.CATEGORY_BROWSABLE</code>è¡¨ç¤ºç”¨æµè§ˆå™¨æ¥æŸ¥çœ‹ã€‚</p><h2 id="3-3-Activityçš„çŠ¶æ€ä¿å­˜"><a href="#3-3-Activityçš„çŠ¶æ€ä¿å­˜" class="headerlink" title="3.3 Activityçš„çŠ¶æ€ä¿å­˜"></a>3.3 Activityçš„çŠ¶æ€ä¿å­˜</h2><p>å½“ç³»ç»Ÿèµ„æºä¸è¶³æ—¶ï¼Œå¤„äºonPauseçŠ¶æ€çš„Activityå¯èƒ½ä¼šè¢«ç³»ç»Ÿé”€æ¯ï¼Œæˆ–è€…å½“è®¾å¤‡å‘ç”Ÿæ¨ªç«–å±åˆ‡æ¢æ—¶ï¼Œç³»ç»Ÿä¹Ÿä¼šé”€æ¯å½“å‰Activityã€‚æ­¤æ—¶ç³»ç»Ÿè°ƒç”¨ <code>onSaveInstanceState()</code> æ–¹æ³•æ¥ä¿å­˜è¯¥Activity çš„çŠ¶æ€ï¼Œç­‰åˆ°è¯¥Activityé‡æ–°åˆ›å»ºæ—¶ï¼ˆå³è°ƒç”¨<code>onCreate()</code>æ–¹æ³•ï¼‰ä¼šè¿›è¡ŒçŠ¶æ€çš„æ¢å¤ã€‚å½“ç„¶çŠ¶æ€ä¿å­˜å’Œæ¢å¤çš„ä»£ç éœ€è¦æˆ‘ä»¬é‡å†™æ¥å®ç°ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSaveInstanceState</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Bundle outState)</span> &#123;<br>    <span class="hljs-built_in">super</span>.onSaveInstanceState(outState);<br>    outState.putString(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;data_temp&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>    setContentView(R.layout.activity_main);<br><br>    <span class="hljs-keyword">if</span> (savedInstanceState != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg1</span> <span class="hljs-operator">=</span> savedInstanceState.getString(<span class="hljs-string">&quot;key&quot;</span>);<br>        Log.d(TAG, <span class="hljs-string">&quot;onCreate&quot;</span> + msg1);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-4-æ‰‹åŠ¨é”€æ¯Activity"><a href="#3-4-æ‰‹åŠ¨é”€æ¯Activity" class="headerlink" title="3.4 æ‰‹åŠ¨é”€æ¯Activity"></a>3.4 æ‰‹åŠ¨é”€æ¯Activity</h2><p>ä½¿ç”¨<code>finish()</code>æ–¹æ³•ï¼Œè§¦å‘çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸ºonPause() -&gt; onStop() -&gt; onDestroy()ã€‚</p><p>æ¯”å¦‚åœ¨è·³è½¬åˆ°å¦ä¸€ä¸ªActivityå¹¶é”€æ¯å½“å‰Activityï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">startActivity(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,SecondaryActivity.class));<br>finish();<br></code></pre></td></tr></table></figure><h2 id="3-5-éšæ—¶å…³é—­æ‰€æœ‰Activity"><a href="#3-5-éšæ—¶å…³é—­æ‰€æœ‰Activity" class="headerlink" title="3.5 éšæ—¶å…³é—­æ‰€æœ‰Activity"></a>3.5 éšæ—¶å…³é—­æ‰€æœ‰Activity</h2><p>å…¶å®åˆ›å»ºä¸€ä¸ªActivityç®¡ç†ç±»æ¥ç®¡ç†è¿™äº›Activityçš„createå’Œdestoryã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityCollector</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Activity&gt; activityList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addActivity</span><span class="hljs-params">(Activity activity)</span>&#123;<br>        activityList.add(activity);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeActivity</span><span class="hljs-params">(Activity activity)</span>&#123;<br>        activityList.remove(activity);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishAll</span><span class="hljs-params">()</span>&#123;<br><br>        <span class="hljs-keyword">for</span> (Activity each:activityList) &#123;<br>            <span class="hljs-keyword">if</span> (!each.isFinishing())&#123;<br>                each.finish();<br>            &#125;<br>        &#125;<br><br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ç¼–å†™ä¸€ä¸ªBaseActivityç±»ä½œä¸ºæ‰€æœ‰Activityçš„çˆ¶ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        ActivityCollector.addActivity(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        ActivityCollector.removeActivity(<span class="hljs-built_in">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ä¸€æ¥ï¼Œåªéœ€è¦è®©Activityçš„åˆ›å»ºéƒ½ç»§æ‰¿BaseActivityå°±å¯ä»¥å®ç°è‡ªåŠ¨æ·»åŠ å’Œç§»é™¤äº†ã€‚å¦‚æœè¦å…³é—­æ‰€æœ‰æ´»åŠ¨ï¼Œä½¿ç”¨<code>removeAllActivity()</code>æ–¹æ³•å³å¯ã€‚</p><h2 id="3-6-å®Œå…¨é€€å‡ºApp"><a href="#3-6-å®Œå…¨é€€å‡ºApp" class="headerlink" title="3.6 å®Œå…¨é€€å‡ºApp"></a>3.6 å®Œå…¨é€€å‡ºApp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * é€€å‡ºåº”ç”¨ç¨‹åº </span><br><span class="hljs-comment"> */</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">AppExit</span><span class="hljs-params">(Context context)</span> &#123;  <br>    <span class="hljs-keyword">try</span> &#123;   <br>        <span class="hljs-type">ActivityManager</span> <span class="hljs-variable">activityMgr</span> <span class="hljs-operator">=</span> (ActivityManager) context  <br>                .getSystemService(Context.ACTIVITY_SERVICE);  <br>        activityMgr.killBackgroundProcesses(context.getPackageName());  <br>        System.exit(<span class="hljs-number">0</span>);  <br>    &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;&#125;  <br>&#125;  <br><br></code></pre></td></tr></table></figure><h2 id="3-7-åŒå‡»backé”®é€€å‡ºApp"><a href="#3-7-åŒå‡»backé”®é€€å‡ºApp" class="headerlink" title="3.7 åŒå‡»backé”®é€€å‡ºApp"></a>3.7 åŒå‡»backé”®é€€å‡ºApp</h2><p>åƒæœ‰çš„Appä¸­ï¼ŒæŒ‰ä¸‹ä¸€æ¬¡backé”®å¹¶ä¸ä¼šé€€å‡ºAppï¼Œè€Œæ˜¯ä¼šæé†’ä½ å†æŒ‰ä¸€æ¬¡é€€å‡ºï¼Œæ¥ä¸‹æ¥åŠæ—¶æŒ‰ä¸‹ç¬¬äºŒæ¬¡backé”®å°±ä¼šé€€å‡ºAppã€‚</p><p>å®ç°è¿™ç§æƒ…å†µåªéœ€è¦é‡å†™Activityçš„<code>onKeyDown()</code>æ–¹æ³•ï¼Œé€šè¿‡ä¸¤æ¬¡ç‚¹å‡»backé”®çš„æ—¶é—´å·®æ¥å†³å®šæ˜¯å¦é€€å‡ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onKeyDown</span><span class="hljs-params">(<span class="hljs-type">int</span> keyCode, KeyEvent event)</span> &#123;<br>        <span class="hljs-comment">//æ˜¯å¦æŒ‰ä¸‹è¿”å›é”®</span><br>        <span class="hljs-keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK)&#123;<br>            <span class="hljs-comment">//æ—¶å·®å¤§äº2så°±ä¸æ–­æç¤º</span><br>            <span class="hljs-keyword">if</span>(System.currentTimeMillis() - exitTime &gt; <span class="hljs-number">2000</span>)&#123;<br>                Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;å†æŒ‰ä¸€æ¬¡é€€å‡ºç¨‹åº&quot;</span>, Toast.LENGTH_SHORT).show();<br>                exitTime = System.currentTimeMillis();<br>                Log.d(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;onKeyDown: &quot;</span> + exitTime);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//æ—¶å·®å°äº2så°±é€€å‡º</span><br>                exit(<span class="hljs-number">0</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onKeyDown(keyCode, event);<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="3-8-çŸ¥æ™“å½“å‰æ˜¯åœ¨å“ªä¸€ä¸ªæ´»åŠ¨"><a href="#3-8-çŸ¥æ™“å½“å‰æ˜¯åœ¨å“ªä¸€ä¸ªæ´»åŠ¨" class="headerlink" title="3.8 çŸ¥æ™“å½“å‰æ˜¯åœ¨å“ªä¸€ä¸ªæ´»åŠ¨"></a>3.8 çŸ¥æ™“å½“å‰æ˜¯åœ¨å“ªä¸€ä¸ªæ´»åŠ¨</h2><p>åœ¨åˆ«äººçš„ä»£ç ä¸Šæ·»åŠ è‡ªå·±çš„åŠŸèƒ½æ—¶ï¼Œæ¯”å¦‚ä¿®æ”¹æŸä¸ªç•Œé¢ï¼Œé‚£ä¹ˆçŸ¥é“è¯¥ç•Œé¢æ‰€å±å“ªä¸ªActivityæ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p><p>å…¶å®å®ç°ä¸Šè¿°æƒ³æ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬è®©æ‰€æœ‰Activityéƒ½ç»§æ‰¿è‡ªå·±å†™çš„BaseActivityç±»ï¼Œåœ¨è¯¥ç±»çš„<code>onCreate()</code>æ–¹æ³•ä¸­å®ç°æ‰“å°å½“å‰Activityçš„åå­—ã€‚å½“ç„¶BaseActivityç±»å¿…ç„¶æ˜¯ç»§æ‰¿äºAppCompatActivityç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        Log.d(<span class="hljs-string">&quot;BaseActivity&quot;</span>, getClass().getSimpleName());<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-9-å¯åŠ¨æ´»åŠ¨çš„æœ€ä½³å†™æ³•"><a href="#3-9-å¯åŠ¨æ´»åŠ¨çš„æœ€ä½³å†™æ³•" class="headerlink" title="3.9 å¯åŠ¨æ´»åŠ¨çš„æœ€ä½³å†™æ³•"></a>3.9 å¯åŠ¨æ´»åŠ¨çš„æœ€ä½³å†™æ³•</h2><p>åœ¨ä»¥ä¸Šæ‰€æœ‰æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯åŠ¨Activityçš„æ–¹æ³•åŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨è°ƒç”¨è€…æ´»åŠ¨ä¸­å†™ä¸‹å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, xxxActivity.class);<br>Intent.putExtra(<span class="hljs-string">&quot;key1&quot;</span>, data1);<br>Intent.putExtra(<span class="hljs-string">&quot;key2&quot;</span>, data2);<br>startActivity(intent);<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šå†™æ³•å½“ç„¶æ²¡é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸çŸ¥é“å¯åŠ¨è¿™ä¸ªActivityè¦ä¼ é€’å“ªäº›æ•°æ®å‘¢ï¼ˆè´Ÿè´£åˆ«äººçš„é¡¹ç›®æ—¶ï¼‰ï¼Œé‚£ä¹ˆåªèƒ½é—®é—®ç›¸å…³äººå‘˜æˆ–è€…è‡ªå·±çœ‹æºç å’¯ã€‚é‚£å¦‚æœæˆ‘ä»¬å°†å¯åŠ¨Activityçš„ä»£ç <u>åŒ…è£…æˆæ–¹æ³•</u>ï¼Œå‚æ•°å°±æ˜¯å¯åŠ¨è¿™ä¸ªActivityæ‰€éœ€è¦çš„æ•°æ®ï¼Œé‚£ä¹‹åä¸å°±å¾ˆæ¸…æ¥šçš„çŸ¥é“è¿™ä¸ªActivityéœ€è¦å“ªäº›å‚æ•°ä»¥åŠç±»å‹åˆ†åˆ«æ˜¯ä»€ä¹ˆäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">StartxxxActivity</span><span class="hljs-params">(Context context, String data1, String data2)</span>&#123;<br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(context, xxxActivity.class);<br>    Intent.putExtra(<span class="hljs-string">&quot;key1&quot;</span>, data1);<br>    Intent.putExtra(<span class="hljs-string">&quot;key2&quot;</span>, data2);<br>    context.startActivity(intent);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å››ã€Activityä¹‹é—´çš„æ•°æ®ä¼ é€’"><a href="#å››ã€Activityä¹‹é—´çš„æ•°æ®ä¼ é€’" class="headerlink" title="å››ã€Activityä¹‹é—´çš„æ•°æ®ä¼ é€’"></a>å››ã€Activityä¹‹é—´çš„æ•°æ®ä¼ é€’</h1><h2 id="4-1-å‘ä¸‹ä¸€ä¸ªActivityä¼ é€’æ•°æ®"><a href="#4-1-å‘ä¸‹ä¸€ä¸ªActivityä¼ é€’æ•°æ®" class="headerlink" title="4.1 å‘ä¸‹ä¸€ä¸ªActivityä¼ é€’æ•°æ®"></a>4.1 å‘ä¸‹ä¸€ä¸ªActivityä¼ é€’æ•°æ®</h2><p>Intentä¸ä»…å¯ä»¥ç”¨æ¥å¯åŠ¨Activityï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ä¼ é€’æ•°æ®ï¼Œå› ä¸ºIntentæœ‰Extraå±æ€§ã€‚é€šè¿‡<code>putExtra()</code>æˆ–<code>putExtras()</code>æ–¹æ³•æ¥å­˜å‚¨è¦ä¼ é€’çš„æ•°æ®ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªæ´»åŠ¨ä¸­é€šè¿‡<code>getIntent()</code>è·å¾—ä¼ é€’è¿‡æ¥çš„Intentï¼Œç»§è€Œè¿›è¡Œç›¸å…³getæ“ä½œã€‚å…·ä½“ä½¿ç”¨å¯å‚è€ƒä¸‹å›¾ï¼ˆæ¥è‡ªèœé¸Ÿæ•™ç¨‹ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131918681.jpg"></p><p>æ¡ˆä¾‹ï¼šç™»å…¥ç•Œé¢ï¼Œç™»å…¥æˆåŠŸåæç¤ºâ€æ¬¢è¿æ‚¨ï¼ŒXXXâ€œã€‚</p><p>xmlçš„é…ç½®è¿‡äºç®€å•å°±ä¸å±•ç¤ºäº†ï¼Œç›´æ¥å±•ç¤ºjavaä»£ç ã€‚</p><p>ç™»å…¥ç•Œé¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> TextView AccountText;<br>    <span class="hljs-keyword">private</span> TextView PasswordText;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        <span class="hljs-comment">//è·å–ä¸¤ä¸ªè¾“å…¥æ¡†æ§ä»¶</span><br>        initView();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initView</span><span class="hljs-params">()</span> &#123;<br>        AccountText = findViewById(R.id.id_account);<br>        PasswordText = findViewById(R.id.id_password);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">login</span><span class="hljs-params">(View view)</span> &#123;<br><br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,SecondaryActivity.class);<br>        <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br>        bundle.putString(<span class="hljs-string">&quot;account&quot;</span>,AccountText.getText().toString());<br>        bundle.putString(<span class="hljs-string">&quot;password&quot;</span>,PasswordText.getText().toString());<br>        intent.putExtras(bundle);<br>        startActivity(intent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å“åº”ç•Œé¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondaryActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_secondary);<br>        initView();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TextView</span> <span class="hljs-variable">loginText</span> <span class="hljs-operator">=</span> findViewById(R.id.id_login_success);<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> getIntent();<br>        <span class="hljs-type">Bundle</span> <span class="hljs-variable">extras</span> <span class="hljs-operator">=</span> intent.getExtras();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> extras.getString(<span class="hljs-string">&quot;account&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> extras.getString(<span class="hljs-string">&quot;password&quot;</span>);<br>        <span class="hljs-keyword">if</span>(account.equals(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; password.equals(<span class="hljs-string">&quot;123456&quot;</span>))&#123;<br>            loginText.setText(<span class="hljs-string">&quot;æ¬¢è¿æ‚¨ï¼Œç”¨æˆ·&quot;</span> + account);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            loginText.setText(<span class="hljs-string">&quot;å¯†ç æˆ–è´¦å·é”™è¯¯&quot;</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-2-å‘ä¸Šä¸€ä¸ªActivityä¼ é€’æ•°æ®ï¼ˆæ•°æ®å›ä¼ ï¼‰"><a href="#4-2-å‘ä¸Šä¸€ä¸ªActivityä¼ é€’æ•°æ®ï¼ˆæ•°æ®å›ä¼ ï¼‰" class="headerlink" title="4.2 å‘ä¸Šä¸€ä¸ªActivityä¼ é€’æ•°æ®ï¼ˆæ•°æ®å›ä¼ ï¼‰"></a>4.2 å‘ä¸Šä¸€ä¸ªActivityä¼ é€’æ•°æ®ï¼ˆæ•°æ®å›ä¼ ï¼‰</h2><p>è¿™ä¸ªæƒ…å†µæ¯”è¾ƒç‰¹æ®Šã€‚å› ä¸ºå¦‚æœæˆ‘ä»¬è¦è¿”å›ä¸Šä¸€ä¸ªActivityï¼ŒæŒ‰backé”®å°±å¯ä»¥äº†ï¼Œä½†æ˜¯è¿™æ ·çš„è¯ï¼Œæ•°æ®æ˜¯ä¸ä¼šä¼ é€’è¿‡æ¥çš„ï¼Œå› ä¸ºbacké”®åªæ˜¯è®©Activityæ ˆæ ˆé¡¶æ´»åŠ¨å‘ç”Ÿå˜åŒ–ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œæ•°æ®çš„ä¼ é€’ï¼ˆå¦‚Intent, bundleç­‰é€šä¿¡ï¼‰ã€‚</p><p>å…¶å®Activityæä¾›äº†å¦ä¸€ç§å¯åŠ¨å…¶ä»–Activityçš„æ–¹æ³•ï¼š<code>startActivityForResult(Intent intent, int requestCode)</code>ã€‚å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆæ¥è‡ªèœé¸Ÿæ•™ç¨‹ï¼‰ï¼š</p><ol><li>åœ¨æ´»åŠ¨Aä½¿ç”¨<code>startActivityForResult()</code>æ–¹æ³•æ¥å¯åŠ¨å¦ä¸€ä¸ªæ´»åŠ¨Bã€‚</li><li>åœ¨æ´»åŠ¨Aä¸­é‡å†™<code>onActivityResult()</code>æ–¹æ³•æ¥å¯¹ä¼ å›çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚</li><li>åœ¨æ´»åŠ¨Bä¸­é€šè¿‡<code>setResult()</code>æ–¹æ³•è®¾ç½®å›ä¼ çš„æ•°æ®ï¼Œä¹‹å<strong>å¿…é¡»è°ƒç”¨<code>finish()</code>æ–¹æ³•æ¥ç»“æŸå½“å‰æ´»åŠ¨</strong>ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œæ•°æ®å›ä¼ ã€‚</li></ol><p>åœ¨è¿™äº›æ–¹æ³•ä¸­ï¼Œ<code>requestCode</code>æ˜¯è¯·æ±‚ç ï¼Œå¯ä»¥è‡ªå·±è®¾å®šï¼Œç”¨äºåŒºåˆ†<code>onActivityResult()</code>æ–¹æ³•æ˜¯è¢«è°è§¦å‘çš„ã€‚<code>resultCode</code>æ˜¯ç»“æœç ï¼Œä¹Ÿå¯ä»¥è‡ªå·±è®¾å®šï¼Œç”¨äºåŒºåˆ†ç»“æœï¼ˆæ¯”å¦‚æˆåŠŸå’Œå¤±è´¥ç­‰ï¼‰ã€‚</p><p>æ•°æ®å›ä¼ çš„æƒ…å†µå¤šå‡ºç°åœ¨å……å€¼åœºæ™¯ï¼Œæˆ‘ä»¬æ‹¿è¿™ä¸ªåšä¸ªç®€å•å®æ“ã€‚</p><p>é¦–å…ˆæ˜¯xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--ç°æœ‰é‡‘é¢æ˜¾ç¤ºç•Œé¢--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span> <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_money&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textAlignment</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#FF00FFFF&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_recharge&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å……å€¼&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;recharge&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><span class="hljs-comment">&lt;!--å……å€¼é‡‘é¢ç•Œé¢--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">EditText</span> <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_edt_rechargeMoney&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_recharge_success&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ç¡®è®¤&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;rechargesuccess&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_recharge_fail&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å–æ¶ˆ&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;rechargefail&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¯¹äºç°æœ‰é‡‘é¢æ˜¾ç¤ºç•Œé¢ï¼Œä¸€ä¸ªæ–‡æœ¬æ¡†æ˜¾ç¤ºé‡‘é¢ï¼Œä¸€ä¸ªå……å€¼æŒ‰é’®å°±å¤Ÿäº†ã€‚</p><p>å¯¹äºå……å€¼é‡‘é¢ç•Œé¢ï¼Œä¸€ä¸ªè¾“å…¥æ¡†è¾“å…¥å……å€¼é‡‘é¢æ•°ï¼Œä¸€ä¸ªç¡®è®¤æŒ‰é’®ï¼Œä¸€ä¸ªå–æ¶ˆæŒ‰é’®å°±å¤Ÿäº†ã€‚</p><p>ä»¥ä¸Šæ‰€æœ‰æŒ‰é’®å‡ç»‘å®šäº†ç‚¹å‡»äº‹ä»¶å¤„ç†æ–¹æ³•ã€‚</p><p>ç„¶åå°±æ˜¯ç°æœ‰é‡‘é¢æ˜¾ç¤ºç•Œé¢çš„Activityä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> TextView MoneyText;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        <span class="hljs-comment">//è·å–æ§ä»¶</span><br>        initView();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initView</span><span class="hljs-params">()</span> &#123;<br>        MoneyText = findViewById(R.id.id_money);<br>    &#125;<br><span class="hljs-comment">//å……å€¼æŒ‰é’®çš„ç‚¹å‡»æ–¹æ³•</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recharge</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, SecondaryActivity.class);<br>        <span class="hljs-comment">//ä½¿ç”¨startActivityForResultæ¥å¯åŠ¨å¦ä¸€ä¸ªæ´»åŠ¨</span><br>        startActivityForResult(intent,<span class="hljs-number">1</span>);<br>    &#125;<br><span class="hljs-comment">//é‡å†™onActivityResultæ–¹æ³•</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onActivityResult</span><span class="hljs-params">(<span class="hljs-type">int</span> requestCode, <span class="hljs-type">int</span> resultCode, <span class="hljs-meta">@Nullable</span> Intent data)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onActivityResult(requestCode, resultCode, data);<br>        <span class="hljs-comment">//æ ¹æ®è¯·æ±‚ç åˆ¤æ–­æ˜¯ä¸æ˜¯æŒ‰é’®è§¦å‘çš„å……å€¼äº‹ä»¶</span><br>        <span class="hljs-keyword">if</span> (requestCode == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">//æ ¹æ®ç»“æœç åˆ¤æ–­æ˜¯å¦å……å€¼æˆåŠŸ</span><br>            <span class="hljs-keyword">if</span> (resultCode == <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">rechargemoney</span> <span class="hljs-operator">=</span> data.getStringExtra(<span class="hljs-string">&quot;rechargemoney&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">nowmoney</span> <span class="hljs-operator">=</span> MoneyText.getText().toString();<br>                    <span class="hljs-type">Integer</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> Integer.parseInt(nowmoney) + Integer.parseInt(rechargemoney);<br>                    MoneyText.setText(total.toString());<br>                    Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;å……å€¼æˆåŠŸ&quot;</span>, Toast.LENGTH_SHORT).show();<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;å……å€¼å–æ¶ˆ&quot;</span>, Toast.LENGTH_SHORT).show();<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€æ˜¯å……å€¼é‡‘é¢ç•Œé¢çš„Activityä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondaryActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> EditText rechargeMoneyText;<br>    <span class="hljs-keyword">private</span> Button successButton;<br>    <span class="hljs-keyword">private</span> Button failButton;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_secondary);<br>        <span class="hljs-comment">//è·å–æ§ä»¶</span><br>        initView();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initView</span><span class="hljs-params">()</span> &#123;<br>        rechargeMoneyText = findViewById(R.id.id_edt_rechargeMoney);<br>        successButton = findViewById(R.id.id_recharge_success);<br>        failButton = findViewById(R.id.id_recharge_fail);<br>    &#125;<br><span class="hljs-comment">//ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»æ–¹æ³•</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rechargesuccess</span><span class="hljs-params">(View view)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">money</span> <span class="hljs-operator">=</span> rechargeMoneyText.getText().toString();<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MainActivity.class);<br>        intent.putExtra(<span class="hljs-string">&quot;rechargemoney&quot;</span>,money);<br>        setResult(<span class="hljs-number">1</span>,intent);<br>        finish();<br>    &#125;<br><span class="hljs-comment">//å–æ¶ˆæŒ‰é’®çš„ç‚¹å‡»æ–¹æ³•</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rechargefail</span><span class="hljs-params">(View view)</span>&#123;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MainActivity.class);<br>        setResult(<span class="hljs-number">0</span>,intent);<br>        finish();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡è®¾ç½®ä¸åŒçš„ç»“æœç æ¥åŒºåˆ†æ˜¯å¦å……å€¼æˆåŠŸã€‚</p><p>å¦‚æœä¹Ÿæƒ³è®©backé”®ä¹Ÿæœ‰è¿™æ ·çš„æ•ˆæœï¼Œåªéœ€è¦é‡å†™<code>onBackPressed()</code>æ–¹æ³•å³å¯ã€‚</p><h1 id="äº”ã€Activityå›é€€æ ˆå’ŒTask"><a href="#äº”ã€Activityå›é€€æ ˆå’ŒTask" class="headerlink" title="äº”ã€Activityå›é€€æ ˆå’ŒTask"></a>äº”ã€Activityå›é€€æ ˆå’ŒTask</h1><h2 id="5-1-Task"><a href="#5-1-Task" class="headerlink" title="5.1 Task"></a>5.1 Task</h2><p>Taskæ˜¯Activityçš„é›†åˆï¼Œæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œå®é™…ä½¿ç”¨çš„Activityå›é€€æ ˆæ¥å­˜å‚¨Activityã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œåº”ç”¨Aå°è¯•å¼€å¯æ‘„åƒå¤´ï¼Œé‚£ä¹ˆä»è¿™ä¸ªåº”ç”¨å¯åŠ¨åˆ°æ‘„åƒå¤´è¢«å¼€å¯çš„è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰è¢«å¯åŠ¨çš„Activityç»„æˆä¸€ä¸ªTaskï¼Œä»–ä»¬çš„ç®¡ç†ç”±è¯¥åº”ç”¨çš„Activityå›é€€æ ˆç®¡ç†ã€‚</p><p>ä¸€èˆ¬æ¥è¯´æ¯ä¸ªåº”ç”¨çš„å¯åŠ¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªTaskï¼ˆå…·ä½“æƒ…å†µè§†Activityå¯åŠ¨æ¨¡å¼å†³å®šï¼‰ã€‚å› æ­¤ç³»ç»Ÿä¸­å¯ä»¥æœ‰å¤šä¸ªTaskï¼Œä½†æ˜¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªTaskåœ¨å‰å°ï¼ˆèƒ½ä¸ä¹‹äº¤äº’çš„ï¼‰ï¼Œå…¶ä»–çš„éƒ½åœ¨åå°ã€‚</p><h2 id="5-2-Activityå›é€€æ ˆ"><a href="#5-2-Activityå›é€€æ ˆ" class="headerlink" title="5.2 Activityå›é€€æ ˆ"></a>5.2 Activityå›é€€æ ˆ</h2><p>Androidç³»ç»Ÿé‡‡ç”¨<strong>æ ˆç»“æ„</strong>æ¥ç®¡ç†åº”ç”¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ‰€å¯åŠ¨çš„Activityï¼Œå³Activityå›é€€æ ˆã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131919648.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€å¼€å§‹æ˜¯Activity1å¤„äºæ ˆé¡¶ï¼Œå½“Activity2è¢«å¯åŠ¨åï¼Œè¯¥Activityä¼šè¢«å‹å…¥æ ˆä¸­ï¼Œæˆä¸ºæ ˆé¡¶ã€‚åŒç†Activity3ç±»ä¼¼ã€‚å½“Activity3è¢«é”€æ¯åï¼ˆä¹Ÿå°±æ˜¯å‡ºæ ˆï¼‰ï¼Œé‚£ä¹ˆç´§éšå…¶åçš„Activity2å°±ä¼šæˆä¸ºæ–°çš„æ ˆé¡¶ã€‚</p><h1 id="å…­ã€Activityçš„å¯åŠ¨æ¨¡å¼"><a href="#å…­ã€Activityçš„å¯åŠ¨æ¨¡å¼" class="headerlink" title="å…­ã€Activityçš„å¯åŠ¨æ¨¡å¼"></a>å…­ã€Activityçš„å¯åŠ¨æ¨¡å¼</h1><ol><li><p><strong>Standard</strong>æ ‡å‡†æ¨¡å¼ </p><p>Activityçš„é»˜è®¤å¯åŠ¨æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼ŒåŒä¸€ä¸ªActivityå¯ä»¥è¢«å¤šæ¬¡å®ä¾‹åŒ–ï¼ˆå³ä½¿å­˜åœ¨ä¸”ä½äºæ ˆé¡¶ï¼‰ã€‚</p></li><li><p><strong>singleTop</strong>æ ˆé¡¶å•ä¾‹æ¨¡å¼ </p><p>å¦‚æœéœ€è¦å¯åŠ¨çš„Activityå­˜åœ¨ä¸”ä½äºæ ˆé¡¶ï¼Œåˆ™ä¸ä¼šé‡æ–°åˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨æ ˆé¡¶çš„Activityã€‚ä½†æ˜¯ï¼Œå¦‚æœéœ€è¦å¯åŠ¨çš„Activityå­˜åœ¨ä½†ä¸ä½äºæ ˆé¡¶ï¼Œé‚£ä¹ˆä»åˆ›å»ºæ–°çš„Activityã€‚</p></li><li><p><strong>singleTask</strong>æ ˆå†…å•ä¾‹æ¨¡å¼</p><p>åªå…è®¸åŒä¸€ä¸ªActivityåœ¨åŒä¸€ä¸ªTaskä¸­æ‹¥æœ‰ä¸€ä¸ªActivityå®ä¾‹ã€‚å¦‚æœç³»ç»Ÿä¸­å·²ç»æœ‰äº†ä¸€ä¸ªå®ä¾‹ä½†ä¸åœ¨æ ˆé¡¶ï¼Œåˆ™ä¼šç§»é™¤è¯¥Activityä¸Šçš„å…¶ä»–Activityï¼Œä»è€Œè®©å…¶ä½äºæ ˆé¡¶ã€‚ å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Activityå¹¶å°†å…¶å‹å…¥æ ˆé¡¶ã€‚</p></li><li><p><strong>singleInstance</strong>å…¨å±€å•ä¾‹æ¨¡å¼ </p><p>åªå…è®¸åŒä¸€ä¸ªActivityåœ¨ç³»ç»Ÿä¸­æ‹¥æœ‰ä¸€ä¸ªActivityå®ä¾‹ã€‚å¦‚æœå¯åŠ¨çš„Activityä¸å­˜åœ¨ï¼Œä¼šå…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„Taskï¼Œç„¶ååœ¨åˆ›å»ºActivityå®ä¾‹åŠ å…¥æ ˆé¡¶ã€‚å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™å°†å…¶ç§»è‡³æ ˆé¡¶ã€‚</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå¼€å‘å­¦ä¹ ç¬”è®°(ä¸‰) â€”â€” æ¢ç©¶Fragment</title>
    <link href="/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%B8%89)%20%E2%80%94%E2%80%94%20%E6%8E%A2%E7%A9%B6Fragment/"/>
    <url>/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%B8%89)%20%E2%80%94%E2%80%94%20%E6%8E%A2%E7%A9%B6Fragment/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯Fragment"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯Fragment" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯Fragment"></a>ä¸€ã€ä»€ä¹ˆæ˜¯Fragment</h1><h2 id="1-1-æ¦‚è¿°"><a href="#1-1-æ¦‚è¿°" class="headerlink" title="1.1 æ¦‚è¿°"></a>1.1 æ¦‚è¿°</h2><p>Fragmentæ˜¯Android3.0åå¼•å…¥çš„ä¸€ä¸ªæ–°çš„APIï¼Œå®ƒå‡ºç°çš„åˆè¡·æ˜¯ä¸ºäº†é€‚åº”å¤§å±å¹•çš„å¹³æ¿ç”µè„‘ã€‚å¼€å‘è€…å¯ä»¥åˆ©ç”¨Fragmentæ¡†æ¶æ„å»ºæ›´çµæ´»çš„ç•Œé¢ï¼Œå¹¶åœ¨ä¸åŒçš„è®¾å¤‡ä¸Šå®ç°ç»Ÿä¸€çš„ç”¨æˆ·ä½“éªŒã€‚</p><p>Fragmentå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå­Activityï¼Œå®ƒå…·æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†å¿…é¡»å¯„ç”Ÿåœ¨Activityä¸­æ‰èƒ½è¿è¡Œï¼Œå—Activityç”Ÿå‘½å‘¨æœŸå½±å“ã€‚</p><h2 id="1-2-ä¸ºä»€ä¹ˆä¼šæœ‰Fragment"><a href="#1-2-ä¸ºä»€ä¹ˆä¼šæœ‰Fragment" class="headerlink" title="1.2 ä¸ºä»€ä¹ˆä¼šæœ‰Fragment?"></a>1.2 ä¸ºä»€ä¹ˆä¼šæœ‰Fragment?</h2><p>æ‹¿æ–°é—»æ¿å—ä¸¾ä¾‹ã€‚ä¸‹å›¾æ˜¯ä½¿ç”¨å¹³æ¿å’Œæ‰‹æœºä½¿ç”¨Fragmenté’ˆå¯¹æ–°é—»æ¿å—çš„ä¸åŒå¤„ç†æƒ…å†µã€‚</p><p>ï¼ˆæ¥è‡ªèœé¸Ÿæ•™ç¨‹çš„å›¾ç‰‡ï¼‰</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131916189.jpg"></p><p>æ˜¾ç„¶å¯¹äºå¹³æ¿æ¥è¯´ï¼Œè¿™ä¹ˆå¤§çš„å±å¹•åªæ”¾æ–°é—»ç®€ä»‹å°±æœ‰ç‚¹å¤ªæµªè´¹äº†ï¼ŒUIè®¾è®¡ä¹Ÿä¸å¥½çœ‹ã€‚ä½†æ˜¯åˆ©ç”¨ä¸¤ä¸ªFragmentï¼Œä¸€ä¸ªå±•ç¤ºæ–°é—»ç®€ä»‹ï¼Œä¸€ä¸ªå±•ç¤ºæ–°é—»å…·ä½“å†…å®¹ï¼ŒåŒæ—¶å±•ç°åœ¨å±å¹•ä¸Šï¼Œé‚£è¿™æ ·å°±åˆç†åˆ©ç”¨äº†æ•´ä¸ªå±å¹•ï¼ŒUIè®¾è®¡ä¹Ÿå°±å¥½çœ‹å¤šäº†ã€‚</p><p>åŒæ ·çš„UIè®¾è®¡æ–¹æ¡ˆåº”ç”¨åˆ°æ‰‹æœºä¸Šå°±ä¸å¤ªè¡Œäº†ï¼Œå› ä¸ºæ‰‹æœºå±å¹•å¤ªå°äº†ã€‚æ‰€ä»¥æ›´åˆç†çš„è®¾è®¡æ˜¯å±•ç¤ºæ–°é—»ç®€ä»‹çš„Fragmentå…ˆå æ®æ•´ä¸ªå±å¹•ï¼Œå½“è§¦å‘ç‚¹å‡»äº‹ä»¶åï¼Œè¢«å±•ç¤ºæ–°é—»å…·ä½“å†…å®¹çš„Fragmentè¦†ç›–ã€‚</p><h1 id="äºŒã€Fragmentçš„åŸºæœ¬ä½¿ç”¨"><a href="#äºŒã€Fragmentçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="äºŒã€Fragmentçš„åŸºæœ¬ä½¿ç”¨"></a>äºŒã€Fragmentçš„åŸºæœ¬ä½¿ç”¨</h1><h2 id="2-1-é™æ€åŠ è½½Fragment"><a href="#2-1-é™æ€åŠ è½½Fragment" class="headerlink" title="2.1 é™æ€åŠ è½½Fragment"></a>2.1 é™æ€åŠ è½½Fragment</h2><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>é€šè¿‡ <code>getSupportFragmentManager() </code>æ–¹æ³•è·å–<code>FragmentManager</code>å¯¹è±¡ã€‚</li><li>é€šè¿‡ <code>FragmentManager.beginTransaction()</code>æ–¹æ³•è·å–<code>FragmentTransaction</code>å¯¹è±¡ã€‚</li><li>è°ƒç”¨<code>add()</code>æ–¹æ³•æˆ–è¿™<code>replace()</code>æ–¹æ³•åŠ è½½ <code>Fragment</code>ã€‚</li><li>æœ€åè°ƒç”¨<code>commit()</code>æ–¹æ³•æäº¤äº‹åŠ¡ã€‚</li></ol><p>åˆ›å»ºçš„fragmentone.xmlã€fragmenttwo.xmlå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- fragmentone.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/fragmentone_tv&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ä»Šå¤©æ˜ŸæœŸå››ï¼Œæ‡‚ï¼Ÿ&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;32sp&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><span class="hljs-comment">&lt;!-- fragmenttwo.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/fragmenttwo_btn&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;200dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;120dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ç‚¹å‡»æ”¹å˜æ–‡å­—&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;32sp&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨activity_main.xmlä¸­ä½¿ç”¨</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/ll&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;horizontal&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">fragment</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.example.myapplication.FragmentOne&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/fragmentone&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">fragment</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.example.myapplication.FragmentTwo&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/fragmenttwo&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯<code>&lt;fragment&gt;</code>æ ‡ç­¾ä¸­å¿…é¡»è®¾ç½®<code>id</code>å’Œ<code>name</code>ï¼ˆå¯¹åº”çš„è‡ªå·±åˆ›å»ºçš„ç»§æ‰¿äº<code>Fragment</code>çš„å­ç±»ï¼‰</p><p>å…¶ä¸­<code>FragmentOne</code>ç±»å’Œ<code>FragmentTwo</code>ç±»çš„å®ç°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//FragmentOne.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FragmentOne</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fragment</span> &#123;<br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LayoutInflater inflater, <span class="hljs-meta">@Nullable</span> ViewGroup container, <span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-comment">//åŠ è½½fragmentï¼Œå°½é‡å†™å…¨å±€ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å·²ç»åˆ›å»º</span><br>        <span class="hljs-type">View</span> <span class="hljs-variable">FragmentOne</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.fragmentone, container, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">return</span> FragmentOne;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//FragmentTwo.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FragmentTwo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fragment</span> &#123;<br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LayoutInflater inflater, <span class="hljs-meta">@Nullable</span> ViewGroup container, <span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-comment">//åŠ è½½fragment</span><br>        <span class="hljs-type">View</span> <span class="hljs-variable">FragmentTwo</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.fragmenttwo, container, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">return</span> FragmentTwo;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆä¸è®¾ç½®ä¸¤ä¸ªFragmentçš„å…³è”ã€‚</p><p>MainActivity.javaä¸­ä¸éœ€è¦ä»»ä½•ä»£ç è®¾ç½®ã€‚</p><h2 id="2-2-åŠ¨æ€åŠ è½½Fragment"><a href="#2-2-åŠ¨æ€åŠ è½½Fragment" class="headerlink" title="2.2 åŠ¨æ€åŠ è½½Fragment"></a>2.2 åŠ¨æ€åŠ è½½Fragment</h2><p>ä¸¤ä¸ªfragmentçš„xmlæ–‡ä»¶å’Œfragmentå­ç±»åŒä¸Šã€‚åªä¸è¿‡ activity_main.xml ä¸­éœ€è¦ä¿®æ”¹ï¼Œä¸æ˜¯ä½¿ç”¨<code>&lt;fragment&gt;</code>æ ‡ç­¾ï¼Œè€Œæ˜¯<code>&lt;FrameLayout&gt;</code>æ ‡ç­¾ï¼Œéœ€è¦å®šä¹‰<code>id</code>ï¼Œæ²¡æœ‰<code>name</code>å±æ€§ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/ll&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/changefragmentbtn&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;change&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/framelayout&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@drawable/wallhaven&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡ç‚¹å‡»æŒ‰é’®æ¥æ›´æ¢fragmentã€‚</p><p>MainActivity.javaéœ€è¦åšä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">View</span>.OnClickListener&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-type">Button</span> <span class="hljs-variable">btn</span> <span class="hljs-operator">=</span> findViewById(R.id.changefragmentbtn);<br>        btn.setOnClickListener(<span class="hljs-built_in">this</span>);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br><br>        <span class="hljs-keyword">if</span> (flag)&#123;<br>            replaceFragment(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FragmentTwo</span>());<br>            flag = <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            replaceFragment(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FragmentOne</span>());<br>            flag = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//åŠ¨æ€åˆ‡æ¢fragment</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceFragment</span><span class="hljs-params">(Fragment fragment)</span> &#123;<br>        <span class="hljs-comment">//è·å–fragmentManager</span><br>        <span class="hljs-type">FragmentManager</span> <span class="hljs-variable">supportFragmentManager</span> <span class="hljs-operator">=</span> getSupportFragmentManager();<br>        <span class="hljs-comment">//è·å–transaction</span><br>        <span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">fragmentTransaction</span> <span class="hljs-operator">=</span> supportFragmentManager.beginTransaction();<br>        <span class="hljs-comment">//æ›¿æ¢fragmentï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¢«æ›¿æ¢çš„fragmentæ‰€åœ¨çš„FrameLayoutå®¹å™¨idï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ‰€è¦å±•ç¤ºçš„fragment</span><br>        fragmentTransaction.replace(R.id.framelayout, fragment);<br>        <span class="hljs-comment">//æäº¤ä¿®æ”¹è¯·æ±‚</span><br>        fragmentTransaction.commit();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥ä¸é€‰æ‹©å®ç°View.OnClickListeneræ¥å£æ¥å®ç°ç‚¹å‡»äº‹ä»¶å¤„ç†æ–¹æ³•ï¼Œé€‰æ‹©å†™æˆåŒ¿åå‡½æ•°ä¹Ÿæ˜¯å¯ä»¥ã€‚</p><h2 id="2-3-Fragmentå›é€€æ ˆ"><a href="#2-3-Fragmentå›é€€æ ˆ" class="headerlink" title="2.3 Fragmentå›é€€æ ˆ"></a>2.3 Fragmentå›é€€æ ˆ</h2><p>åœ¨2.2çš„ä¾‹å­ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ç‚¹å‡»backé”®ï¼Œåˆ™ä¼šç›´æ¥é€€å‡ºåº”ç”¨ã€‚å¦‚æœæˆ‘ä»¬è¦å®ç°ä¸€å±‚ä¸€å±‚çš„é€€å‡º fragment çš„è¯ï¼Œéœ€è¦ä½¿ç”¨åˆ°<code>addToBackStack()</code>æ–¹æ³•ã€‚æ‹¿2.2çš„ä¾‹å­æ¥è®²ï¼Œåªéœ€ç¨å¾®ä¿®æ”¹<code>replaceFragment()</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceFragment</span><span class="hljs-params">(Fragment fragment)</span> &#123;<br>    <span class="hljs-comment">//è·å–fragmentManager</span><br>    <span class="hljs-type">FragmentManager</span> <span class="hljs-variable">supportFragmentManager</span> <span class="hljs-operator">=</span> getSupportFragmentManager();<br>    <span class="hljs-comment">//è·å–transaction</span><br>    <span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">fragmentTransaction</span> <span class="hljs-operator">=</span> supportFragmentManager.beginTransaction();<br>    <span class="hljs-comment">//æ›¿æ¢fragmentï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¢«æ›¿æ¢çš„fragmentæ‰€åœ¨çš„FrameLayoutå®¹å™¨idï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ‰€è¦å±•ç¤ºçš„fragment</span><br>    fragmentTransaction.replace(R.id.framelayout, fragment);<br>    <span class="hljs-comment">//å°†è¢«æ›¿æ¢çš„fragmentæ·»åŠ åˆ°æ ˆä¸­</span><br>    fragmentTransaction.addToBackStack(<span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">//æäº¤ä¿®æ”¹è¯·æ±‚</span><br>    fragmentTransaction.commit();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·å½“æˆ‘ä»¬ç‚¹å‡»backé”®åï¼Œæœ€ä¸Šé¢çš„ fragment äº‹åŠ¡ä¼šä»å †æ ˆä¸­å¼¹å‡ºã€‚å¦‚æœå †æ ˆä¸Šæ²¡æœ‰ fragment äº‹åŠ¡ï¼Œåˆ™è¿”å›äº‹ä»¶ä¼šå‘ä¸Šä¼ é€’åˆ° Activityã€‚</p><h2 id="2-4-Fragmentä¸Activityçš„äº¤äº’"><a href="#2-4-Fragmentä¸Activityçš„äº¤äº’" class="headerlink" title="2.4 Fragmentä¸Activityçš„äº¤äº’"></a>2.4 Fragmentä¸Activityçš„äº¤äº’</h2><h3 id="2-4-1-ç»„ä»¶è·å–"><a href="#2-4-1-ç»„ä»¶è·å–" class="headerlink" title="2.4.1 ç»„ä»¶è·å–"></a>2.4.1 ç»„ä»¶è·å–</h3><ul><li>Fragmenté€šè¿‡getActivity().findViewById(R.id.list)è·å¾—Activityä¸­çš„ç»„ä»¶ã€‚</li><li>Activityé€šè¿‡getSupportFragmentManager().findFragmentByidè·å¾—Fragmentä¸­çš„ç»„ä»¶ï¼ˆidå’Œtagéƒ½è¡Œï¼‰ã€‚</li></ul><h3 id="2-4-2-æ•°æ®ä¼ é€’"><a href="#2-4-2-æ•°æ®ä¼ é€’" class="headerlink" title="2.4.2 æ•°æ®ä¼ é€’"></a>2.4.2 æ•°æ®ä¼ é€’</h3><h4 id="2-4-2-1-Fragmentä¼ é€’æ•°æ®ç»™Activity"><a href="#2-4-2-1-Fragmentä¼ é€’æ•°æ®ç»™Activity" class="headerlink" title="2.4.2.1 Fragmentä¼ é€’æ•°æ®ç»™Activity"></a>2.4.2.1 Fragmentä¼ é€’æ•°æ®ç»™Activity</h4><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åœ¨Fragmentå®šä¹‰ä¸€ä¸ªæ¥å£,æ¥å£ä¸­å®šä¹‰æŠ½è±¡æ–¹æ³•,ä½ è¦ä¼ ä»€ä¹ˆç±»å‹çš„æ•°æ®å‚æ•°å°±è®¾ç½®ä¸ºä»€ä¹ˆç±»å‹</li><li>æ¥ç€è¿˜æœ‰å†™ä¸€ä¸ªè°ƒç”¨æ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•,æŠŠè¦ä¼ é€’çš„æ•°æ®ä¼ è¿‡å»</li><li>å†æ¥ç€å°±æ˜¯Activityäº†,è°ƒç”¨Fragmentæä¾›çš„é‚£ä¸ªæ–¹æ³•,ç„¶åé‡å†™æŠ½è±¡æ–¹æ³•çš„æ—¶å€™è¿›è¡Œæ•°æ® çš„è¯»å–å°±å¯ä»¥äº†</li></ol><p>ï¼ˆæœ‰ç‚¹åƒUIå¼€å‘ç¬”è®°ä¸­çš„RecyclerViewçš„itemç›‘å¬è®¾ç½®ã€‚ï¼‰</p><p>æ¡ˆä¾‹è¿˜æ˜¯ä½¿ç”¨2.2çš„ä»£ç ï¼Œåªè¿›è¡Œä¸€ç‚¹ç‚¹ä¿®æ”¹ã€‚</p><p>é¦–å…ˆåœ¨fragmentå¯¹åº”çš„ç±»ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> FragmentToActivity fta;<br><span class="hljs-comment">//å®šä¹‰æ¥å£</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FragmentToActivity</span>&#123;<br>    <span class="hljs-comment">//ä¾‹å¦‚å‘é€å­—ç¬¦ä¸²</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sentDataToActivity</span><span class="hljs-params">(String string)</span>;<br>&#125;<br><span class="hljs-comment">//è®©Activityèƒ½å¤Ÿå®ç°è¯¥æ¥å£çš„åŒæ—¶å¹¶è°ƒç”¨æ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDataFromFragment</span><span class="hljs-params">(FragmentToActivity fta)</span> &#123;<br>    <span class="hljs-built_in">this</span>.fta = fta;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello! I&#x27;m from Fragment&quot;</span>;<br>    fta.sentDataToActivity(msg);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨MainActivity.javaä¸­çš„onClickæ–¹æ³•ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">fragmentOne.getDataFromFragment(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FragmentOne</span>.FragmentToActivity() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sentDataToActivity</span><span class="hljs-params">(String string)</span> &#123;<br>        Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, string, Toast.LENGTH_SHORT).show();<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h4 id="2-4-2-1-Activityä¼ é€’æ•°æ®ç»™Fragment"><a href="#2-4-2-1-Activityä¼ é€’æ•°æ®ç»™Fragment" class="headerlink" title="2.4.2.1  Activityä¼ é€’æ•°æ®ç»™Fragment"></a>2.4.2.1  Activityä¼ é€’æ•°æ®ç»™Fragment</h4><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åœ¨Activityä¸­åˆ›å»ºBundleæ•°æ®åŒ…ï¼Œå°†æ•°æ®æ”¾å…¥Bundleä¸­ã€‚</li><li>è°ƒç”¨Fragmentå®ä¾‹çš„setArguments(bundle) ä»è€Œå°†Bundleæ•°æ®åŒ…ä¼ ç»™Fragmentã€‚</li><li>ç„¶åFragmentä¸­è°ƒç”¨getArgumentsè·å¾— Bundleå¯¹è±¡,ï¼Œç„¶åè¿›è¡Œè§£æå°±å¯ä»¥äº†ã€‚</li></ol><p>ä»ç„¶ä»¥ 2.2 çš„ä»£ç ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥å°è¯•ä¿®æ”¹fragmentçš„å†…å®¹ã€‚</p><p>åœ¨MainActivity.javaä¸­ï¼Œéœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>    setContentView(R.layout.activity_main);<br><br>    <span class="hljs-type">Button</span> <span class="hljs-variable">btn</span> <span class="hljs-operator">=</span> findViewById(R.id.changefragmentbtn);<br>    btn.setOnClickListener(<span class="hljs-built_in">this</span>);<br><span class="hljs-comment">//æ”¹ä¸ºå…¬å…±å¯¹è±¡</span><br>    fragmentOne = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FragmentOne</span>();<br>    fragmentTwo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FragmentTwo</span>();<br><span class="hljs-comment">//åˆ›å»ºç”¨äºé€šä¿¡çš„bundle</span><br>    bundleone = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br>    bundletwo = <span class="hljs-keyword">new</span>  <span class="hljs-title class_">Bundle</span>();<br><span class="hljs-comment">//è®¾ç½®æ¶ˆæ¯çš„é”®å€¼å¯¹</span><br>    bundleone.putString(<span class="hljs-string">&quot;message&quot;</span>,<span class="hljs-string">&quot;æˆ‘æ˜¯ç§¦å§‹çš‡ï¼Œæ‰“é’±ï¼&quot;</span>);<br>    bundletwo.putString(<span class="hljs-string">&quot;message&quot;</span>,<span class="hljs-string">&quot;å°æˆ‘åšå¤§å°†å†›å˜&quot;</span>);<br><span class="hljs-comment">//å°†bundleä¼ ç»™fragment</span><br>    fragmentOne.setArguments(bundleone);<br>    fragmentTwo.setArguments(bundletwo);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ”¹å˜çš„æ˜¯onCreateæ–¹æ³•ï¼ŒonClickæ–¹æ³•å°±ä¸éœ€è¦åœ¨åˆ›å»ºæ–°çš„fragmentå¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨åˆ›å»ºçš„å…¬å…±å¯¹è±¡ã€‚</p><blockquote><p><strong>è¡¥å……ï¼</strong></p><p>ä¸å»ºè®®å°†new FragmentOne()å‡ºçš„å¯¹è±¡ä½œä¸ºå…¬å…±å¯¹è±¡ä½œä¸ºfragmentTransaction.add()çš„å‚æ•°ï¼Œè¿™æ ·ä¼šå¯¼è‡´åº”ç”¨åˆ‡æ¢å‡ºé—®é¢˜ã€‚ä½†replace()ä¸ä¼šã€‚</p></blockquote><p>ç„¶ååªéœ€è¦åœ¨fragmentå­ç±»ä¸­çš„onCreateViewæ–¹æ³•ä¸­é¢å¤–æ·»åŠ ä»¥ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">textview = FragmentOne.findViewById(R.id.fragmentone_tv);<br><span class="hljs-comment">//è·å–ä¼ è¿‡æ¥çš„bunlde</span><br><span class="hljs-type">Bundle</span> <span class="hljs-variable">bunlde</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getArguments();<br><span class="hljs-comment">//é€šè¿‡keyè·å¾—ä¼ è¿‡æ¥çš„å­—ç¬¦ä¸²</span><br>message = bunlde.getString(<span class="hljs-string">&quot;message&quot;</span>);<br>textview.setText(message);<br></code></pre></td></tr></table></figure><h4 id="2-4-2-1-Fragmentä¼ é€’æ•°æ®ç»™Fragment"><a href="#2-4-2-1-Fragmentä¼ é€’æ•°æ®ç»™Fragment" class="headerlink" title="2.4.2.1  Fragmentä¼ é€’æ•°æ®ç»™Fragment"></a>2.4.2.1  Fragmentä¼ é€’æ•°æ®ç»™Fragment</h4><p>å¦‚æœ æ˜¯ä¸€ä¸ªFragment è·³è½¬åˆ°å¦ä¸€ä¸ªFragmentï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨Bundleé€šä¿¡ï¼Œå› ä¸ºæ¶‰åŠåˆ°Fragmentçš„æ·»åŠ ï¼Œæ‰€ä»¥è¿˜éœ€è¦FragmentManagerã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªèœé¸Ÿæ•™ç¨‹ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">FragmentManager</span> <span class="hljs-variable">fManager</span> <span class="hljs-operator">=</span> getSupportFragmentManager( );<br><span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">fTransaction</span> <span class="hljs-operator">=</span> fManager.beginTransaction();<br><span class="hljs-type">Fragmentthree</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fragmentthree</span>();<br><span class="hljs-type">Fragmenttwo</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fragmenttwo</span>();<br><span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br>bundle.putString(<span class="hljs-string">&quot;key&quot;</span>,id);<br>t2.setArguments(bundle); <br>fTransaction.add(R.id.fragmentRoot, t2, <span class="hljs-string">&quot;~~~&quot;</span>);  <br>fTransaction.addToBackStack(t1);  <br>fTransaction.commit(); <br></code></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ä¸¤ä¸ªFragmentéœ€è¦å³æ—¶ä¼ æ•°æ®ï¼Œè€Œéè·³è½¬çš„è¯ï¼Œå°±éœ€è¦ä»¥Activityä¸ºåª’ä»‹ï¼Œå³å…ˆåœ¨Activityè·å¾—fragment1ä¼ è¿‡æ¥çš„æ•°æ®ï¼Œå†ä¼ åˆ°fragment2ä¸­ã€‚</p><p>è¿™ä¸ªå®ç°çš„è¯æ„Ÿè§‰æ˜¯å°† 2.4.2.1 å’Œ 2.4.2.2 ä¸­çš„æ–¹æ³•æ‹¼æ¥ä¸€ä¸‹ã€‚</p><h1 id="ä¸‰ã€Fragmentç”Ÿå‘½å‘¨æœŸ"><a href="#ä¸‰ã€Fragmentç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ä¸‰ã€Fragmentç”Ÿå‘½å‘¨æœŸ"></a>ä¸‰ã€Fragmentç”Ÿå‘½å‘¨æœŸ</h1><h2 id="3-1-Fragmentç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•"><a href="#3-1-Fragmentç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•" class="headerlink" title="3.1 Fragmentç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•"></a>3.1 Fragmentç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•</h2><p>éƒ¨åˆ†æ–¹æ³•è§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li>onAttach()ï¼šå› ä¸ºFragmentå¿…é¡»ä¾æ‰˜Activityæ‰èƒ½è¿è¡Œï¼Œæ‰€ä»¥è¯¥æ–¹æ³•çš„åŠŸèƒ½æ˜¯å°†Fragmentä¸Activityç»‘å®šã€‚</li><li>onCreate()ï¼šåˆ›å»ºFragmentã€‚</li><li>onCreateView()ï¼šå› ä¸ºFragmentæ˜¯æœ‰UIç•Œé¢çš„ï¼Œæ‰€ä»¥è¯¥æ–¹æ³•çš„åŠŸèƒ½æ˜¯ç»˜åˆ¶Fragmentçš„UIç•Œé¢ã€‚</li><li>onActivityCreate()ï¼šFragmentæ‰€åœ¨çš„Activityå¯åŠ¨å®Œæˆåæ‰ä¼šè¢«è°ƒç”¨ã€‚</li><li>onDestroyView()ï¼šé”€æ¯Fragmentçš„UIè§†å›¾</li><li>onDestroy() ï¼šé”€æ¯Fragmentã€‚</li><li>onDetach()ï¼šFragmentä¸Activityè§£ç»‘ã€‚</li></ul><p>ï¼ˆæ¥è‡ªèœé¸Ÿæ•™ç¨‹çš„å›¾ç‰‡ï¼‰</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131917005.jpg"></p><p>ç”±æ­¤å¯è§ï¼ŒFragmentçš„è¿è¡Œå¿…é¡»åœ¨onAttach()å’ŒonDetach()ä¹‹é—´ï¼Œå› ä¸ºFragmentä¸èƒ½ç‹¬ç«‹è¿è¡Œï¼Œå¿…é¡»ä¾èµ–Activityã€‚</p><h2 id="3-2-ä½“éªŒFragmentçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#3-2-ä½“éªŒFragmentçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="3.2 ä½“éªŒFragmentçš„ç”Ÿå‘½å‘¨æœŸ"></a>3.2 ä½“éªŒFragmentçš„ç”Ÿå‘½å‘¨æœŸ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FragmentOne</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fragment</span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lll&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAttach</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onAttach(context);<br>        Log.d(TAG, <span class="hljs-string">&quot;onAttach: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        Log.d(TAG, <span class="hljs-string">&quot;onCreate: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LayoutInflater inflater, <span class="hljs-meta">@Nullable</span> ViewGroup container, <span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-comment">//åŠ è½½fragment</span><br>        <span class="hljs-type">View</span> <span class="hljs-variable">FragmentOne</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.fragmentone, container, <span class="hljs-literal">false</span>);<br>        Log.d(TAG, <span class="hljs-string">&quot;onCreateView: &quot;</span>);<br>        <span class="hljs-keyword">return</span> FragmentOne;<br>        <br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onActivityCreated</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onActivityCreated(savedInstanceState);<br>        Log.d(TAG, <span class="hljs-string">&quot;onActivityCreated: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onStart();<br>        Log.d(TAG, <span class="hljs-string">&quot;onStart: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResume</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onResume();<br>        Log.d(TAG, <span class="hljs-string">&quot;onResume: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onPause();<br>        Log.d(TAG, <span class="hljs-string">&quot;onPause: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onStop();<br>        Log.d(TAG, <span class="hljs-string">&quot;onStop: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroyView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroyView();<br>        Log.d(TAG, <span class="hljs-string">&quot;onDestroyView: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        Log.d(TAG, <span class="hljs-string">&quot;onDestroy: &quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDetach</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDetach();<br>        Log.d(TAG, <span class="hljs-string">&quot;onDetach: &quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯ŸLogcatä¸­çš„ä¿¡æ¯ï¼Œå¯ä»¥çŸ¥é“ï¼š</p><ol><li>ä»æ— åˆ°æœ‰æ˜¾ç¤ºFragmentï¼šonAttach() -&gt; onCreate() -&gt; onCreateView() -&gt; onActivityCreated() -&gt; onStart() -&gt; onResume()</li><li>åŸºäº1ï¼Œä¹‹åæŒ‰ä¸‹homeé”®ï¼šonPause() -&gt; onStop()</li><li>åŸºäº2ï¼Œé‡æ–°è¿›å…¥ï¼šonStart() -&gt; onResume()</li><li>åŸºäº3ï¼ŒæŒ‰å›é€€é”®ï¼šonPause() -&gt; onStop() -&gt; onDestroyView() -&gt; onDestroy() -&gt; onDetach()</li><li>è¢«å¦ä¸€ä¸ªUIå®Œå…¨æ›¿æ¢ï¼šonPause() -&gt; onStop() -&gt; onDestroyView()</li><li>åŸºäº5ï¼Œç›´æ¥é€€å‡ºåº”ç”¨ï¼šonDestroy() -&gt; onDetach()</li><li>åŸºäº5ï¼Œå†æ¬¡æ›¿æ¢å›æ¥ï¼šonCreateView() -&gt; onActivityCreated() -&gt; onStart() -&gt; onResume()</li></ol><h1 id="å››ã€Fragment-ViewPagerå®ç°ç®€å•ç‚¹çš„å¾®ä¿¡ç¨‹åºé¡µé¢"><a href="#å››ã€Fragment-ViewPagerå®ç°ç®€å•ç‚¹çš„å¾®ä¿¡ç¨‹åºé¡µé¢" class="headerlink" title="å››ã€Fragment + ViewPagerå®ç°ç®€å•ç‚¹çš„å¾®ä¿¡ç¨‹åºé¡µé¢"></a>å››ã€Fragment + ViewPagerå®ç°ç®€å•ç‚¹çš„å¾®ä¿¡ç¨‹åºé¡µé¢</h1><p>å®ç°é¡µé¢æ»‘åŠ¨èƒ½å¤Ÿä¸åº•éƒ¨å¯¼èˆªæ è¿›è¡ŒåŒæ­¥ã€‚</p><p>å½“ç„¶ï¼Œ<strong>BottomNavigationView</strong>å·²ç»å®ç°äº†è¿™ä¸€åŠŸèƒ½ï¼Œä»¥åä½¿ç”¨è¿™ä¸ªç»„ä»¶å³å¯ï¼Œå°±ä¸éœ€è¦é‚£ä¹ˆéº»çƒ¦äº†ã€‚</p><p>è¯ä¸å¤šè¯´ï¼Œå¼€å§‹å®æ“ï¼</p><p>é¦–å…ˆç¼–å†™activity_main.xmlçš„å†…å®¹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.viewpager2.widget.ViewPager2</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_viewpager&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;0dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">&quot;1&quot;</span>/&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;horizontal&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">        &gt;</span><br>        <span class="hljs-comment">&lt;!-- ç¬¬ä¸€ä¸ªæŒ‰é’®--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_chatlayout&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">            &gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_chatimage&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:src</span>=<span class="hljs-string">&quot;@drawable/baseline_message_24&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">app:tint</span>=<span class="hljs-string">&quot;@color/buttoncolorchange&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å¾®ä¿¡&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24sp&quot;</span></span><br><span class="hljs-tag">                /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- ç¬¬äºŒä¸ªæŒ‰é’®--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_contactlayout&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">            &gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_contactimage&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:src</span>=<span class="hljs-string">&quot;@drawable/baseline_contacts_24&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">app:tint</span>=<span class="hljs-string">&quot;@color/buttoncolorchange&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;è”ç³»äºº&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24sp&quot;</span></span><br><span class="hljs-tag">                /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- ç¬¬ä¸‰ä¸ªæŒ‰é’®--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_findlayout&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">            &gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_findimage&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:src</span>=<span class="hljs-string">&quot;@drawable/baseline_compass_calibration_24&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">app:tint</span>=<span class="hljs-string">&quot;@color/buttoncolorchange&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å‘ç°&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24sp&quot;</span></span><br><span class="hljs-tag">                /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- ç¬¬å››ä¸ªæŒ‰é’®--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_melayout&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">            &gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_meimage&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:src</span>=<span class="hljs-string">&quot;@drawable/baseline_account_box_24&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">app:tint</span>=<span class="hljs-string">&quot;@color/buttoncolorchange&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;æˆ‘&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24sp&quot;</span></span><br><span class="hljs-tag">                /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br>        <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ•´ä½“å¸ƒå±€ä¸ºï¼šåº•éƒ¨ä¸ºå¯¼èˆªæ ï¼Œå…¶ä½™ç©ºé—´ç»™viewpager2ã€‚å¯¼èˆªæ åˆ†å››ä¸ªæŒ‰é’®ï¼ˆè·Ÿå¾®ä¿¡ä¸€æ ·ï¼‰ï¼Œå…¶ä¸­ImageViewçš„tintå±æ€§å¯ä»¥å®ç°å›¾ç‰‡é¢œè‰²çš„å˜åŒ–ï¼Œè¿™æ ·å°±ä¸éœ€è¦ç”¨åˆ°ä¸¤å¼ å›¾æ¥åˆ‡æ¢äº†ï¼Œbuttoncolorchange.xml çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">selector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:color</span>=<span class="hljs-string">&quot;#5cd849&quot;</span> <span class="hljs-attr">android:state_selected</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:color</span>=<span class="hljs-string">&quot;#ffffff&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">selector</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åº•éƒ¨å¯¼èˆªæ çš„å››ä¸ªæŒ‰é’®åˆ†åˆ«æœ‰å¯¹åº”çš„å››ä¸ªé¡µé¢ï¼ˆfragmentï¼‰ï¼Œå®ƒä»¬é€šè¿‡FragmentAdapterä»¥åŠFragmentæ¥å®ç°ï¼Œå¯¹åº”çš„xmlæ–‡ä»¶æˆ‘å†™çš„æ¯”è¾ƒç®€é™‹ï¼Œå°±ä¸€ä¸ªTextViewã€‚ï¼ˆè¿™ä¸ªæ–‡ä»¶é€šè¿‡åˆ›å»ºFragmentç±»ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œä¸éœ€è¦è‡ªå·±å†åˆ›å»ºï¼‰</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.WechatFragment&quot;</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/id_textView&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;32sp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">&quot;#FFFF00&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <br><span class="hljs-tag">&lt;/<span class="hljs-name">FrameLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ—¢ç„¶ä½¿ç”¨äº†Viewpager2å’ŒFragmentï¼Œé‚£ä¹ˆå°±è¦ç¼–å†™å¯¹åº”çš„FragmentAdapterå’ŒFragmentç±»ã€‚å…¶ä¸­Viewpageçš„Adapterç¼–å†™å¦‚ä¸‹ï¼ˆ<strong>éœ€è¦æ³¨æ„ç»§æ‰¿çš„æ˜¯FragmentStateAdapter</strong>ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatViewAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FragmentStateAdapter</span> &#123;<br><span class="hljs-comment">//ç”¨äºå­˜å‚¨å››ä¸ªé¡µé¢(fragment)</span><br>    <span class="hljs-keyword">private</span> List&lt;Fragment&gt; fragmentList;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WechatViewAdapter</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> FragmentManager fragmentManager, <span class="hljs-meta">@NonNull</span> Lifecycle lifecycle, List&lt;Fragment&gt; fragmentList)</span> &#123;<br>        <span class="hljs-built_in">super</span>(fragmentManager, lifecycle);<br>        <span class="hljs-built_in">this</span>.fragmentList = fragmentList;<br>    &#125;<br><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Fragment <span class="hljs-title function_">createFragment</span><span class="hljs-params">(<span class="hljs-type">int</span> position)</span> &#123;<br>        <span class="hljs-keyword">return</span> fragmentList.get(position);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getItemCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> fragmentList == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : fragmentList.size();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Fragmentå¯¹åº”çš„Fragmentç±»ç¼–å†™å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatFragment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fragment</span> &#123;<br><br>    <span class="hljs-comment">//bundleçš„key</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARG_PARAM1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;key1&quot;</span>;<br>    <span class="hljs-comment">//fragmentå¯¹åº”çš„è§†å›¾</span><br>    <span class="hljs-keyword">private</span> View rootView;<br>    <span class="hljs-comment">//é€šè¿‡keyè·å–çš„æ¶ˆæ¯</span><br>    <span class="hljs-keyword">private</span> String mParam1;<br><br>    <span class="hljs-comment">//åˆ›å»ºfragmentçš„å®ä¾‹å¯¹è±¡</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WechatFragment <span class="hljs-title function_">newInstance</span><span class="hljs-params">(String param1)</span> &#123;<br>        <span class="hljs-type">WechatFragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WechatFragment</span>();<br>        <span class="hljs-type">Bundle</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br>        args.putString(ARG_PARAM1, param1);<br>        fragment.setArguments(args);<br>        <span class="hljs-keyword">return</span> fragment;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <span class="hljs-keyword">if</span> (getArguments() != <span class="hljs-literal">null</span>) &#123;<br>            mParam1 = getArguments().getString(ARG_PARAM1);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(LayoutInflater inflater, ViewGroup container,</span><br><span class="hljs-params">                             Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-keyword">if</span> (rootView == <span class="hljs-literal">null</span>)&#123;<br>            rootView = inflater.inflate(R.layout.fragment_wechat, container, <span class="hljs-literal">false</span>);<br>        &#125;<br>        <span class="hljs-comment">//å¯¹ç»„ä»¶åšä¸€äº›åˆå§‹åŒ–</span><br>        initView();<br>        <span class="hljs-keyword">return</span> rootView;<br>    &#125;<br><span class="hljs-comment">//è®¾ç½®é¡µé¢è¦å±•ç¤ºçš„å†…å®¹</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initView</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-type">TextView</span> <span class="hljs-variable">textView</span> <span class="hljs-operator">=</span> rootView.findViewById(R.id.id_textView);<br>        textView.setText(mParam1);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¯¹äºè¿™ä¸ªå®æˆ˜æ¥è®²ï¼Œå…¶å®å¯ä»¥ä¸ç”¨å†™é‚£ä¹ˆå¤æ‚ã€‚</p><p>å› ä¸ºå››ä¸ªé¡µé¢æˆ‘ä½¿ç”¨çš„éƒ½æ˜¯ç›¸åŒçš„fragmentçš„xmlæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œåˆ›å»ºä¸€ä¸ªfragmentç±»å³å¯ã€‚</p><p>æœ€ä¸»è¦çš„æ˜¯MainActivity.javaï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">View</span>.OnClickListener&#123;<br><span class="hljs-comment">//å­˜æ”¾å››ä¸ªé¡µé¢å¯¹åº”çš„å®ä¾‹åŒ–å¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> List&lt;Fragment&gt; fragmentList;<br>    <span class="hljs-comment">//å­˜æ”¾viewpagerç»„ä»¶å¯¹åº”çš„å®ä¾‹åŒ–å¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> ViewPager2 viewpager;<br><span class="hljs-comment">//å­˜æ”¾åº•éƒ¨å¯¼èˆªæ çš„å››ä¸ª&quot;æŒ‰é’®&quot;å¯¹åº”çš„å®ä¾‹åŒ–å¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> ArrayList&lt;LinearLayout&gt; linearLayoutArrayList;<br><span class="hljs-comment">//å­˜æ”¾åº•éƒ¨å¯¼èˆªæ çš„å››ä¸ª&quot;æŒ‰é’®&quot;çš„å›¾ç‰‡çš„å®ä¾‹åŒ–å¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> ArrayList&lt;ImageView&gt; imageViewArrayList;<br>    <span class="hljs-comment">//å­˜æ”¾å½“å‰é¡µé¢å¯¹åº”çš„&quot;æŒ‰é’®&quot;çš„å›¾ç‰‡ï¼ˆå½“é¡µé¢è¿›è¡Œåˆ‡æ¢æ—¶ï¼Œæ—§çš„å½“å‰é¡µé¢å¯¹åº”çš„æŒ‰é’®å›¾ç‰‡çš„é€‰ä¸­çŠ¶æ€éœ€è¦æ”¹å˜ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡æ¥è¿›è¡Œæ“ä½œï¼‰ã€‚</span><br>    <span class="hljs-keyword">private</span> ImageView currentImageView;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><span class="hljs-comment">//è¿›è¡Œviewpagerçš„åˆå§‹åŒ–ï¼Œå³å››ä¸ªfragmentçš„åˆå§‹åŒ–</span><br>        initPager();<br>        <span class="hljs-comment">//è¿›è¡Œåº•éƒ¨å¯¼èˆªæ çš„åˆå§‹åŒ–</span><br>        initBottomNavigation();<br><br>    &#125;<br>    <br>    <span class="hljs-comment">//åˆå§‹åŒ–viewpager</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initPager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//å¸¸è§„æ“ä½œ......</span><br>        <span class="hljs-comment">//æ‰¾åˆ°viewpageræ§ä»¶ï¼Œä»¥ä¾¿åç»­è®¾ç½®adapter</span><br>        viewpager = findViewById(R.id.id_viewpager);<br><span class="hljs-comment">//å®ä¾‹åŒ–å››ä¸ªé¡µé¢çš„fragment</span><br>        fragmentList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        fragmentList.add(WechatFragment.newInstance(<span class="hljs-string">&quot;èŠå¤©&quot;</span>));<br>        fragmentList.add(WechatFragment.newInstance(<span class="hljs-string">&quot;é€šè®¯å½•&quot;</span>));<br>        fragmentList.add(WechatFragment.newInstance(<span class="hljs-string">&quot;å‘ç°&quot;</span>));<br>        fragmentList.add(WechatFragment.newInstance(<span class="hljs-string">&quot;æˆ‘çš„&quot;</span>));<br><br>        <span class="hljs-type">WechatViewAdapter</span> <span class="hljs-variable">wechatViewAdapter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WechatViewAdapter</span>(getSupportFragmentManager(), getLifecycle(), fragmentList);<br>        viewpager.setAdapter(wechatViewAdapter);<br><br>        <span class="hljs-comment">//è®¾ç½®viewpagerçš„æ»‘åŠ¨ç›‘å¬ï¼Œä»¥ä¾¿åœ¨æ»‘åŠ¨é¡µé¢çš„æ—¶å€™ï¼Œåº•éƒ¨å¯¼èˆªæ çš„æŒ‰é’®é¢œè‰²ä¹Ÿèƒ½è·Ÿç€æ”¹å˜</span><br>        viewpager.registerOnPageChangeCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewPager2</span>.OnPageChangeCallback() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">//é¡µé¢è¢«é€‰ä¸­ï¼Œé€šè¿‡å®ç°è¯¥æ–¹æ³•æ¥ä¸å¯¼èˆªæ å…³è”</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPageSelected</span><span class="hljs-params">(<span class="hljs-type">int</span> position)</span> &#123;<br>                <span class="hljs-built_in">super</span>.onPageSelected(position);<br>                <span class="hljs-comment">//å‘Šè¯‰åº•éƒ¨å¯¼èˆªæ ä½¿ç”¨å“ªä¸ªpage,ç„¶åå¯¹åº”itemå˜è‰²</span><br>                chageBottomNavigationItem(position);<br>            &#125;<br><br>        &#125;);<br><br>    &#125;<br><span class="hljs-comment">//åˆå§‹åŒ–åº•éƒ¨å¯¼èˆªæ ï¼Œå³è·å–å››ä¸ª&quot;æŒ‰é’®&quot;ï¼Œç„¶åè®¾ç½®ç›‘å¬ï¼Œæœ€åé»˜è®¤</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initBottomNavigation</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//è·å–å››ä¸ª&quot;æŒ‰é’®&quot;</span><br>        linearLayoutArrayList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        linearLayoutArrayList.add(findViewById(R.id.id_chatlayout));<br>        linearLayoutArrayList.add(findViewById(R.id.id_contactlayout));<br>        linearLayoutArrayList.add(findViewById(R.id.id_findlayout));<br>        linearLayoutArrayList.add(findViewById(R.id.id_melayout));<br><span class="hljs-comment">//å¾ªç¯è®¾ç½®ç›‘å¬</span><br>        <span class="hljs-keyword">for</span> (LinearLayout each : linearLayoutArrayList) &#123;<br>            each.setOnClickListener(<span class="hljs-built_in">this</span>);<br>        &#125;<br><span class="hljs-comment">//è·å–å››ä¸ª&quot;æŒ‰é’®&quot;çš„å›¾ç‰‡</span><br>        imageViewArrayList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        imageViewArrayList.add(findViewById(R.id.id_chatimage));<br>        imageViewArrayList.add(findViewById(R.id.id_contactimage));<br>        imageViewArrayList.add(findViewById(R.id.id_findimage));<br>        imageViewArrayList.add(findViewById(R.id.id_meimage));<br><br>        <span class="hljs-comment">//ViewPageré¦–å…ˆå±•ç¤ºçš„æ˜¯ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œæ‰€ä»¥å¯¹åº”çš„&quot;æŒ‰é’®&quot;å›¾ç‰‡ä¸ºé€‰ä¸­çŠ¶æ€</span><br>        currentImageView = imageViewArrayList.get(<span class="hljs-number">0</span>);<br>        currentImageView.setSelected(<span class="hljs-literal">true</span>);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-comment">//ç‚¹å‡»åº•éƒ¨å¯¼èˆªæ è§¦å‘é¡µé¢åˆ‡æ¢</span><br>        chageBottomNavigationItem(view.getId());<br>    &#125;<br>    <br><span class="hljs-comment">//å®ç°æ»‘åŠ¨å’Œ&quot;æŒ‰é’®&quot;ç‚¹å‡»å¸¦æ¥çš„é¡µé¢åˆ‡æ¢å’Œ&quot;æŒ‰é’®&quot;å›¾ç‰‡æ”¹å˜</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">chageBottomNavigationItem</span><span class="hljs-params">(<span class="hljs-type">int</span> positon)</span> &#123;<br>        <span class="hljs-comment">//å› ä¸ºä¸èƒ½ä½¿ç”¨switch-caseï¼Œæ‰€ä»¥ifä¸å¤ªå¥½å†™</span><br>        currentImageView.setSelected(<span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">if</span> (positon == R.id.id_chatlayout) &#123;<span class="hljs-comment">//ç‚¹å‡»å¯¼èˆªæ çš„itemæ¥åˆ‡æ¢é¡µé¢</span><br>            <span class="hljs-comment">//çœŸæ­£è¿›è¡Œé¡µé¢åˆ‡æ¢</span><br>            viewpager.setCurrentItem(<span class="hljs-number">0</span>);<br>            <span class="hljs-comment">//å¯¹åº”çš„æ–°é¡µé¢çš„&quot;æŒ‰é’®&quot;å›¾ç‰‡è®¾ç½®ä¸ºå½“å‰é¡µé¢çš„&quot;æŒ‰é’®&quot;å›¾ç‰‡</span><br>            currentImageView = imageViewArrayList.get(<span class="hljs-number">0</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (positon == <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//é€šè¿‡æ»‘åŠ¨æ¥åˆ‡æ¢é¡µé¢</span><br>            currentImageView = imageViewArrayList.get(<span class="hljs-number">0</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (positon == R.id.id_contactlayout) &#123;<br>            viewpager.setCurrentItem(<span class="hljs-number">1</span>);<br>            currentImageView = imageViewArrayList.get(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (positon == <span class="hljs-number">1</span>) &#123;<br>            currentImageView = imageViewArrayList.get(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (positon == R.id.id_findlayout) &#123;<br>            viewpager.setCurrentItem(<span class="hljs-number">2</span>);<br>            currentImageView = imageViewArrayList.get(<span class="hljs-number">2</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (positon == <span class="hljs-number">2</span>) &#123;<br>            currentImageView = imageViewArrayList.get(<span class="hljs-number">2</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (positon == R.id.id_melayout) &#123;<br>            viewpager.setCurrentItem(<span class="hljs-number">3</span>);<br>            currentImageView = imageViewArrayList.get(<span class="hljs-number">3</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (positon == <span class="hljs-number">3</span>) &#123;<br>            currentImageView = imageViewArrayList.get(<span class="hljs-number">3</span>);<br>        &#125;<br>        <span class="hljs-comment">//æ–°çš„é¡µé¢å¯¹åº”çš„itemçš„é€‰ä¸­çŠ¶æ€å…ˆè®¾ç½®ä¸ºtrue</span><br>        currentImageView.setSelected(<span class="hljs-literal">true</span>);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå¼€å‘å­¦ä¹ ç¬”è®°(äºŒ) â€”â€” äº†è§£UIæ§ä»¶</title>
    <link href="/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%BA%8C)%20%E2%80%94%E2%80%94%20%E4%BA%86%E8%A7%A3UI%E6%8E%A7%E4%BB%B6/"/>
    <url>/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%BA%8C)%20%E2%80%94%E2%80%94%20%E4%BA%86%E8%A7%A3UI%E6%8E%A7%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>Androidçš„UIå¼€å‘ä¸€èˆ¬é‡‡ç”¨XMLä»£ç ç¼–å†™å’Œå¯è§†åŒ–ç¼–è¾‘å™¨ï¼ˆæ›´æ–¹ä¾¿ï¼‰ã€‚è¿™ä¸€éƒ¨åˆ†å°±å¥½æ¯”æ˜¯html+css+jsä¸‰å‰‘å®¢ã€‚</p><h1 id="äºŒã€æ§ä»¶"><a href="#äºŒã€æ§ä»¶" class="headerlink" title="äºŒã€æ§ä»¶"></a>äºŒã€æ§ä»¶</h1><h2 id="2-1-TextView"><a href="#2-1-TextView" class="headerlink" title="2.1 TextView"></a>2.1 TextView</h2><p>æ–‡æœ¬æ¡†</p><h3 id="åŸºæœ¬å±æ€§"><a href="#åŸºæœ¬å±æ€§" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>layout_width</td><td>è®¾ç½®æ§ä»¶çš„å®½åº¦ï¼Œå¸¸ç”¨çš„æœ‰â€wrap_contentâ€(æ ¹æ®æ§ä»¶å†…å®¹é€‚é…)ã€â€match_parentâ€(ä¸çˆ¶å®¹å™¨åŒå®½)ï¼Œä»¥åŠç¡®åˆ‡æ•°å­—ï¼Œå¦‚200<strong>dp</strong></td></tr><tr><td>layout_height</td><td>è®¾ç½®æ§ä»¶çš„é«˜åº¦ï¼ŒåŒä¸Šã€‚</td></tr><tr><td>id</td><td>æ ¼å¼ä¸ºâ€@+id&#x2F;xxxâ€ç”¨äºåœ¨ä»£ç ä¸­è·å–è¯¥å¯¹è±¡ï¼Œæ¯”å¦‚javaä»£ç é€šè¿‡findViewById()æ–¹æ³•è·å–</td></tr><tr><td>text</td><td>è®¾ç½®æ–‡å­—å†…å®¹</td></tr><tr><td>textColor</td><td>è®¾ç½®æ–‡å­—é¢œè‰²ï¼Œæ ¼å¼å¯ä»¥ä¸ºâ€#xxxxxxxxâ€ï¼Œå‰ä¸¤ä½ä»£è¡¨é¢œè‰²çš„é€æ˜åº¦ï¼ˆ00é€æ˜ï¼ŒFFä¸é€æ˜ï¼‰ï¼Œåé¢ä»£è¡¨RGB</td></tr><tr><td>textStyle</td><td>è®¾ç½®æ–‡å­—é£æ ¼ï¼Œå¦‚normal(æ— æ•ˆæœ)ï¼Œbold(åŠ ç²—)ï¼Œitalic(æ–œä½“)</td></tr><tr><td>textSize</td><td>è®¾ç½®æ–‡å­—å¤§å°ï¼Œå•ä½<strong>sp</strong></td></tr><tr><td>background</td><td>è®¾ç½®æ§ä»¶èƒŒæ™¯é¢œè‰²ï¼Œâ€#xxxxxxxxâ€çš„æ ¼å¼åŒtextColorä¸€æ ·ï¼Œä¹Ÿå¯ä»¥æ˜¯å›¾ç‰‡èƒŒæ™¯</td></tr><tr><td>gravity</td><td>è®¾ç½®æ§ä»¶ä¸­å†…å®¹çš„å¯¹é½æ–¹å‘ï¼Œå¦‚centerã€leftã€rightã€bottomã€topç­‰</td></tr><tr><td>autoLink</td><td>å½“æ–‡å­—å†…å®¹å‡ºç°URLï¼ŒE-Mailï¼Œç”µè¯å·ç ç­‰ï¼Œé€šè¿‡è®¾ç½®autoLinkå±æ€§ï¼Œå¯ä»¥ä½¿å…¶æˆä¸ºé“¾æ¥ï¼Œå¸¸ç”¨ç±»åˆ«æœ‰ webã€emailã€phoneã€mapç­‰</td></tr></tbody></table><p>å…¶ä¸­ textã€textColorã€background å±æ€§çš„å†…å®¹åœ¨å¼€å‘ä¸­å¹¶ä¸ç›´æ¥åœ¨æ§ä»¶ä¸­å†™æ˜ï¼Œè€Œæ˜¯å†™åœ¨res\values\ç›®å½•ä¸‹çš„ colors.xmlã€strings.xmlä¸­ï¼Œç„¶åè¢«æ§ä»¶è°ƒç”¨ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">//åœ¨strings.xmlä¸­å£°æ˜:<br><span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;aaa&quot;</span>&gt;</span>æˆ‘è¢«è°ƒç”¨äº†<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>//åœ¨æ§ä»¶ä¸­å¼•ç”¨:<br><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">          <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;@String/aaa&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h3 id="è·‘é©¬ç¯æ¡ˆä¾‹"><a href="#è·‘é©¬ç¯æ¡ˆä¾‹" class="headerlink" title="è·‘é©¬ç¯æ¡ˆä¾‹"></a>è·‘é©¬ç¯æ¡ˆä¾‹</h3><p>æ¶‰åŠåˆ°çš„å±æ€§</p><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>singleLine</td><td>å†…å®¹æ˜¯å¦å•è¡Œæ˜¾ç¤º</td></tr><tr><td>focusable</td><td>æ§ä»¶æ˜¯å¦å¯ä»¥è·å–ç„¦ç‚¹</td></tr><tr><td>focusableInTouchMode</td><td>ç”¨äºæ§ä»¶åœ¨è§¦æ‘¸æ¨¡å¼ä¸‹æ˜¯å¦å¯ä»¥è·å–ç„¦ç‚¹</td></tr><tr><td>ellipsize</td><td>çœç•¥æ–‡æœ¬çš„æ¨¡å¼</td></tr><tr><td>marqueeRepeatLimit</td><td>å­—æ¯åŠ¨ç”»é‡å¤çš„æ¬¡æ•°</td></tr><tr><td>clickable</td><td>æ§ä»¶æ˜¯å¦å¯ä»¥è¢«ç‚¹å‡»</td></tr></tbody></table><p>ä¸Šè¿°å±æ€§è®¾ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml">android:singleLine=&quot;true&quot;<br>android:ellipsize=&quot;marquee&quot;<br>android:marqueeRepeatLimit=&quot;marquee_forever&quot;<br>android:focusable=&quot;true&quot;<br></code></pre></td></tr></table></figure><p>å®ç°è·‘é©¬ç¯æœ‰ä»¥ä¸‹æ–¹å¼ï¼š</p><ol><li><p>é¢å¤–è®¾ç½®å±æ€§å€¼</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">android:</span>focusableInTouchMode=<span class="hljs-string">&quot;true&quot;</span><br><span class="hljs-symbol">android:</span>clickable=<span class="hljs-string">&quot;true&quot;</span><br></code></pre></td></tr></table></figure><p>ç‚¹å‡»TextViewåï¼Œè·å¾—ç„¦ç‚¹ï¼Œå¼€å§‹è·‘é©¬ç¯æ•ˆæœã€‚</p></li><li><p>æ·»åŠ é¢å¤–å±å‹å€¼</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">android:</span>focusableInTouchMode=<span class="hljs-string">&quot;true&quot;</span><br></code></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨åŒä¸€ä¸ª<code>LinearLayout</code>ä¸‹æ·»åŠ </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-section">&lt;requestFocus/&gt;</span><br></code></pre></td></tr></table></figure><p>å®ƒç”¨äºè¯·æ±‚å°†ç„¦ç‚¹è®¾ç½®åˆ°æŒ‡å®šçš„å…ƒç´ ä¸Šã€‚</p></li><li><p>åˆ›å»ºç±»ç»§æ‰¿TextViewç±»ï¼Œé‡å†™<code>isFocused</code>æ–¹æ³•ï¼Œä½¿å…¶æ°¸è¿œè¿”å›<code>true</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTextView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TextView</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyTextView</span><span class="hljs-params">(Context context)</span> &#123;<br>        <span class="hljs-built_in">super</span>(context);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyTextView</span><span class="hljs-params">(Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> &#123;<br>        <span class="hljs-built_in">super</span>(context, attrs);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyTextView</span><span class="hljs-params">(Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> &#123;<br>        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFocused</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="2-2-Button"><a href="#2-2-Button" class="headerlink" title="2.2 Button"></a>2.2 Button</h2><p>æŒ‰é’®ã€‚Buttonç»§æ‰¿äºTextViewï¼Œæ‰€ä»¥TextViewä¸Šå¾ˆå¤šå±æ€§ä¹Ÿå¯ä»¥åº”ç”¨åˆ°Button ä¸Šã€‚</p><h3 id="åŸºæœ¬å±æ€§-1"><a href="#åŸºæœ¬å±æ€§-1" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>drawable</td><td>å¼•ç”¨çš„Drawableä½å›¾</td></tr><tr><td>state_focused</td><td>æ˜¯å¦è·å¾—ç„¦ç‚¹</td></tr><tr><td>state_window_focused</td><td>æ˜¯å¦è·å¾—çª—å£ç„¦ç‚¹</td></tr><tr><td>state_enabled</td><td>æ§ä»¶æ˜¯å¦å¯ç”¨</td></tr><tr><td>state_checkable</td><td>æ§ä»¶å¯å¦è¢«å‹¾é€‰</td></tr><tr><td>state_checked</td><td>æ§ä»¶æ˜¯å¦è¢«å‹¾é€‰</td></tr><tr><td>state_selected</td><td>æ§ä»¶æ˜¯å¦è¢«é€‰æ‹©,é’ˆå¯¹æœ‰æ»šè½®çš„æƒ…å†µ</td></tr><tr><td>state_pressed</td><td>æ§ä»¶æ˜¯å¦è¢«æŒ‰ä¸‹</td></tr><tr><td>state_active</td><td>æ§ä»¶æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€</td></tr><tr><td>state_single</td><td>æ§ä»¶åŒ…å«å¤šä¸ªå­æ§ä»¶æ—¶,ç¡®å®šæ˜¯å¦åªæ˜¾ç¤ºä¸€ä¸ªå­æ§ä»¶</td></tr><tr><td>state_firstã€state_middleã€state_last</td><td>æ§ä»¶åŒ…å«å¤šä¸ªå­æ§ä»¶æ—¶,ç¡®å®šå“ªä¸ªå­æ§ä»¶æ˜¯å¦å¤„äºæ˜¾ç¤ºçŠ¶æ€</td></tr></tbody></table><p>ä»¥ä¸Šè¿™äº›å±æ€§å¹¶ä¸æ˜¯åœ¨<code>&lt;button&gt;</code>æˆ–<code>&lt;android.widget.Button&gt;</code>ä¸‹å£°æ˜çš„ï¼Œè€Œæ˜¯åœ¨<code>\res\drawable\</code>å’Œ<code>\res\color\</code>ç›®å½•ä¸‹åˆ›å»ºxmlæ–‡ä»¶è¿›è¡Œå£°æ˜ï¼ˆcolorè¿™ä¸ªç›®å½•è‡ªå·±åˆ›å»ºï¼Œåå­—åªèƒ½æ˜¯colorï¼Œå› ä¸º<code>&lt;selector&gt;</code>åªèƒ½åœ¨<code>animator\</code>ï¼Œ<code>drawable\</code>ï¼Œ<code>color\</code>ä¸‹çš„xmlæ–‡ä»¶ä¸­ä½¿ç”¨ï¼‰ã€‚</p><h3 id="æŒ‰é’®ç‚¹å‡»è½¬åŒ–æ¡ˆä¾‹"><a href="#æŒ‰é’®ç‚¹å‡»è½¬åŒ–æ¡ˆä¾‹" class="headerlink" title="æŒ‰é’®ç‚¹å‡»è½¬åŒ–æ¡ˆä¾‹"></a>æŒ‰é’®ç‚¹å‡»è½¬åŒ–æ¡ˆä¾‹</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;200dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;æˆ‘æ˜¯æŒ‰é’®&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">&quot;#FF00FF00&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;32dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@drawable/bt_image&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:backgroundTint</span>=<span class="hljs-string">&quot;@color/btn_color&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br></code></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨<code>&lt;Button/&gt;</code>æ ‡ç­¾ï¼Œåˆ™<code>background</code>å’Œ<code>backgroundTint</code>å±æ€§è®¾ç½®é¢œè‰²æ— æ•ˆï¼æ¨èä½¿ç”¨**<code>&lt;android.widget.Button/&gt;</code>**æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚å…¶ä¸­<code>background</code>å±æ€§è®¾ç½®çš„<code>@drawable/bt_image</code>å’Œ<code>backgroundTint</code>å±æ€§è®¾ç½®çš„<code>@color/btn_color</code>å‡æ˜¯è‡ªå·±åˆ›å»ºçš„ã€‚</p><p>drawable&#x2F;bt_image.xmlå¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">selector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">&quot;@drawable/baseline_airplanemode_active_24&quot;</span> <span class="hljs-attr">android:state_pressed</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">&quot;@drawable/baseline_airplanemode_inactive_24&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">selector</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€<code>&lt;item/&gt;</code>è®¾ç½®äº†<code>state_pressed=&quot;true&quot;</code>ï¼Œè¡¨ç¤ºButtonè¢«ç‚¹å‡»çš„çŠ¶æ€å¯¹åº”çš„å›¾æ¡ˆï¼Œé‚£ä¹ˆæ˜¾ç„¶ç¬¬äºŒä¸ª<code>&lt;item/&gt;</code>åˆ™è¡¨ç¤ºçš„æ˜¯æ²¡æœ‰è¢«ç‚¹å‡»çŠ¶æ€ä¸‹çš„å›¾æ¡ˆã€‚è‡³äºè¿™äº›drawableçš„å±æ€§å€¼ï¼Œåˆ™æ˜¯ä¸€äº›çŸ¢é‡å›¾ã€‚</p><p>color&#x2F;btn_color.xmlå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">selector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:color</span>=<span class="hljs-string">&quot;@color/black&quot;</span> <span class="hljs-attr">android:state_pressed</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:color</span>=<span class="hljs-string">&quot;#FFFF0000&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">selector</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è·Ÿ<code>drawable/bt_image.xml</code>çš„è§£é‡Šç±»ä¼¼ï¼Œä¸è¿‡é¢œè‰²è®¾ç½®çš„æ˜¯å›¾æ ‡çš„ã€‚</p><h3 id="Buttonçš„äº‹ä»¶å¤„ç†"><a href="#Buttonçš„äº‹ä»¶å¤„ç†" class="headerlink" title="Buttonçš„äº‹ä»¶å¤„ç†"></a>Buttonçš„äº‹ä»¶å¤„ç†</h3><p>ç‚¹å‡»äº‹ä»¶ã€é•¿æŒ‰äº‹ä»¶ã€è§¦æ‘¸äº‹ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Button</span> <span class="hljs-variable">btn1</span> <span class="hljs-operator">=</span> findViewById(R.id.btn1);<br><br><span class="hljs-comment">//ç‚¹å‡»äº‹ä»¶</span><br>btn1.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onClick: &quot;</span>);;<br>    &#125;<br>&#125;);<br><span class="hljs-comment">//é•¿æŒ‰äº‹ä»¶</span><br>btn1.setOnLongClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnLongClickListener() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onLongClick</span><span class="hljs-params">(View view)</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onLongClick: &quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;);<br><span class="hljs-comment">//è§¦æ‘¸äº‹ä»¶</span><br>btn1.setOnTouchListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnTouchListener() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouch</span><span class="hljs-params">(View view, MotionEvent motionEvent)</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onTouch: &quot;</span> + motionEvent.getAction());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>é•¿æŒ‰æŒ‰é’®å¹¶æ¾å¼€ï¼ˆä¸ç§»åŠ¨ï¼‰ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">onTouch:</span> <span class="hljs-number">0</span>  <br><span class="hljs-symbol">onLongClick:</span> <br><span class="hljs-symbol">onTouch:</span> <span class="hljs-number">1</span><br><span class="hljs-symbol">onClick:</span> <br></code></pre></td></tr></table></figure><p>Touchäº‹ä»¶è§¦å‘äº†ä¸¤æ¬¡ã€‚åˆ†åˆ«æ˜¯æŒ‰ä¸‹åŠ¨ä½œ<code>ACTION_DOWN (0)</code>ã€æ¾å¼€åŠ¨ä½œ<code>ACTION_UP (1)</code>ã€‚å¦‚æœæŒ‰ä½ä¸æ¾å¼€å¹¶ä¸”ç§»åŠ¨ï¼Œåˆ™ä¼šè§¦å‘ç§»åŠ¨åŠ¨ä½œ<code>ACTION_MOVE (2)</code>ã€‚</p><p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸‰ä¸ªäº‹ä»¶è§¦å‘çš„é¡ºåºä¾æ¬¡Touchã€LongClickã€Clickã€‚</p><p>åœ¨è¿™äº›å›è°ƒå‡½æ•°ä¸­ï¼Œè¿”å›å€¼ä¸ºfalseè¡¨ç¤ºä¸æ‹¦æˆªç‚¹å‡»äº‹ä»¶æ¶ˆæ¯ï¼ˆclickåŠ¨ä½œåœ¨æœ€åè§¦å‘ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼‰ã€‚å€˜è‹¥å°†è¿”å›å€¼ä¿®æ”¹ä¸ºtrueï¼Œè¡¨ç¤ºæ‹¦æˆªç‚¹å‡»äº‹ä»¶æ¶ˆæ¯ï¼Œé‚£ä¹ˆå…¶ä»–ç›‘å¬å™¨å°±ä¸ä¼šæ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œå› æ­¤ä¹Ÿå°±ä¸ä¼šæ‰§è¡Œç›¸åº”å›è°ƒå‡½æ•°ã€‚ï¼ˆä»è¿™ä¸‰ä¸ªäº‹ä»¶çš„è§¦å‘é¡ºåºæ˜¯å¯ä»¥çŒœæµ‹å‡ºä¿®æ”¹è¿”å›å€¼åçš„è§¦å‘æƒ…å†µï¼‰</p><p>onclickäº‹ä»¶çš„å¤„ç†å‡½æ•°å¯ä»¥åœ¨buttonçš„onClickå±æ€§å¤„ç»‘å®šã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;dealClick&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dealClick</span><span class="hljs-params">(View view)</span> &#123;<br>    Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;å¯ä»¥çš„&quot;</span>, Toast.LENGTH_SHORT).show();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h4><p>è®¡æ•°å™¨ï¼Œå¦‚æœé•¿æŒ‰åˆ™æç¤ºä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ç‚¹å‡»äº‹ä»¶</span><br>btn1.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onClick: &quot;</span>);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">cnt</span> <span class="hljs-operator">=</span>  Integer.parseInt(btn1.getText().toString());<br>        cnt++;<br>        btn1.setText(cnt.toString());<br>    &#125;<br>&#125;);<br><span class="hljs-comment">//é•¿æŒ‰äº‹ä»¶</span><br>btn1.setOnLongClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnLongClickListener() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onLongClick</span><span class="hljs-params">(View view)</span> &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;onLongClick: &quot;</span>);<br>        Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;è¯·ä¸è¦é•¿æŒ‰æŒ‰é’®&quot;</span>, Toast.LENGTH_SHORT).show();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="2-3-EditText"><a href="#2-3-EditText" class="headerlink" title="2.3 EditText"></a>2.3 EditText</h2><p>è¾“å…¥æ¡†ã€‚EditTextç»§æ‰¿ä¸TextViewã€‚</p><h3 id="åŸºæœ¬å±æ€§-2"><a href="#åŸºæœ¬å±æ€§-2" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>hint</td><td>æç¤ºä¿¡æ¯</td></tr><tr><td>textColorHint</td><td>æç¤ºæ–‡å­—çš„é¢œè‰²</td></tr><tr><td>inputType</td><td>è¾“å…¥ç±»å‹ï¼Œå¦‚æ—¥æœŸã€ç”µè¯ã€é‚®ä»¶ç­‰</td></tr><tr><td>drawableLeft, drawableRightç­‰</td><td>åœ¨è¾“å…¥æ¡†çš„æŒ‡å®šä½ç½®æ·»åŠ å›¾ç‰‡</td></tr><tr><td>drawablePadding</td><td>è®¾ç½®å›¾ç‰‡å’Œè¾“å…¥å†…å®¹çš„é—´è·</td></tr><tr><td>paddingLeft, paddingRightç­‰</td><td>è®¾ç½®å†…å®¹ä¸è¾¹æ¡†çš„é—´è·</td></tr><tr><td>selectAllOnFocus</td><td>è·å¾—ç„¦ç‚¹åå…¨é€‰ç»„ä»¶å†…æ‰€æœ‰æ–‡æœ¬å†…å®¹</td></tr><tr><td>minLines, maxLines</td><td>è®¾ç½®æœ€å°ã€æœ€å¤§çš„è¡Œæ•°ï¼Œå½“è¾“å…¥å†…å®¹è¶…è¿‡æœ€å¤§è¡Œæ•°ï¼Œæ–‡å­—ä¼šè‡ªåŠ¨å‘ä¸Šæ»šåŠ¨</td></tr></tbody></table><h3 id="ç™»å½•æ¡ˆä¾‹"><a href="#ç™»å½•æ¡ˆä¾‹" class="headerlink" title="ç™»å½•æ¡ˆä¾‹"></a>ç™»å½•æ¡ˆä¾‹</h3><p>xmlçš„å£°æ˜å¦‚ä¸‹ï¼Œå£°æ˜äº†è´¦å·æ¡†ã€å¯†ç æ¡†ã€ç™»å½•æŒ‰é’®ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">EditText</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/zhanghao&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;200dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:inputType</span>=<span class="hljs-string">&quot;text&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:hint</span>=<span class="hljs-string">&quot;è¯·è¾“å…¥ç”¨æˆ·å&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textColorHint</span>=<span class="hljs-string">&quot;#89827f&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:drawableLeft</span>=<span class="hljs-string">&quot;@drawable/baseline_account_box_24&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:drawablePadding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">EditText</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/mima&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;200dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:inputType</span>=<span class="hljs-string">&quot;textPassword&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:hint</span>=<span class="hljs-string">&quot;è¯·è¾“å…¥å¯†ç &quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textColorHint</span>=<span class="hljs-string">&quot;#89827f&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:drawableLeft</span>=<span class="hljs-string">&quot;@drawable/baseline_password_24&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:drawablePadding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;20dp&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btn&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ç™»å½•&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æŒ‰é’®è®¾ç½®clickç›‘å¬ï¼Œç„¶åè·å–è´¦å·å¯†ç ï¼Œå¯¹æ¯”ä»è€Œè¿›è¡Œä¸åŒæ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>    setContentView(R.layout.activity_main);<br>    <span class="hljs-type">Button</span> <span class="hljs-variable">btn</span> <span class="hljs-operator">=</span> findViewById(R.id.btn);<br>    <span class="hljs-type">EditText</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> findViewById(R.id.zhanghao);<br>    <span class="hljs-type">EditText</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> findViewById(R.id.mima);<br><br>    btn.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">ac</span> <span class="hljs-operator">=</span> account.getText().toString();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">pwd</span> <span class="hljs-operator">=</span> password.getText().toString();<br>            <span class="hljs-keyword">if</span> (ac.equals(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; pwd.equals(<span class="hljs-string">&quot;123456&quot;</span>))&#123;<br>                Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;ç®¡ç†å‘˜ï¼Œæ¬¢è¿ä½ &quot;</span>, Toast.LENGTH_SHORT).show();<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯&quot;</span>, Toast.LENGTH_SHORT).show();<br>                account.setText(<span class="hljs-string">&quot;&quot;</span>);<br>                password.setText(<span class="hljs-string">&quot;&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-4-ImageView"><a href="#2-4-ImageView" class="headerlink" title="2.4 ImageView"></a>2.4 ImageView</h2><p>å›¾ç‰‡è§†å›¾ã€‚</p><h3 id="åŸºæœ¬å±æ€§-3"><a href="#åŸºæœ¬å±æ€§-3" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>src</td><td>è®¾ç½®å›¾ç‰‡èµ„æº</td></tr><tr><td>scaleType</td><td>è®¾ç½®å›¾ç‰‡ç¼©æ”¾ç±»å‹ï¼Œå¦‚fitStart, fitCenter, fitEndï¼ˆç­‰æ¯”ç¼©æ”¾ï¼Œä½ç½®æ”¾ç½®ä¸åŒï¼‰ç­‰</td></tr><tr><td>maxHeight</td><td>æœ€å¤§é«˜åº¦</td></tr><tr><td>maxWidth</td><td>æœ€å¤§å®½åº¦</td></tr><tr><td>adjustViewBounds</td><td>è°ƒæ•´Viewçš„ç•Œé™</td></tr></tbody></table><p>maxHeightã€maxWidthéœ€è¦å’ŒadjustViewBoundsä¸€èµ·ä½¿ç”¨ï¼Œç­‰æ¯”ç¼©æ”¾ç›´åˆ°ä¸€è¾¹è¾¾åˆ°æœ€å¤§å€¼ã€‚</p><h2 id="2-5-RadioButton"><a href="#2-5-RadioButton" class="headerlink" title="2.5 RadioButton"></a>2.5 RadioButton</h2><p>å•é€‰æ¡†ã€‚éœ€è¦åˆ›å»º<code>&lt;RadioGroup&gt;</code>æ ‡ç­¾å°†å¤šä¸ª<code>&lt;RadioButton&gt;</code>èšé›†ä¸ºä¸€ç»„ï¼Œç¡®ä¿ä¸€æ¬¡åªé€‰æ‹©ä¸€ä¸ªå•é€‰æŒ‰é’®ã€‚</p><p><strong>è¦ä¸ºæ¯ä¸ªRadioButtonæ·»åŠ ä¸€ä¸ªidï¼Œä¸ç„¶å•é€‰åŠŸèƒ½ä¼šç”Ÿæ•ˆï¼</strong></p><h3 id="åŸºæœ¬å±æ€§-4"><a href="#åŸºæœ¬å±æ€§-4" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>checked</td><td>é»˜è®¤æ˜¯å¦å‹¾é€‰</td></tr><tr><td>drawableXXX(Left, Right)</td><td>æ–‡å­—ä¸é€‰æ‹©æ¡†çš„ç›¸å¯¹ä½ç½®ã€‚éœ€è¦ä¸button&#x3D;â€@nullâ€ä¸€èµ·ä½¿ç”¨ã€‚</td></tr><tr><td>paddingXxx</td><td>æ–‡å­—ä¸é€‰æ‹©æ¡†çš„è·ç¦»</td></tr><tr><td>button</td><td>è®¾ç½®ä¸º@nullè¡¨ç¤ºä¸ä½¿ç”¨é»˜è®¤çš„é€‰æ‹©æ¡†</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-1"><a href="#æ¡ˆä¾‹-1" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>æ€§åˆ«é€‰æ‹©ï¼Œé€šè¿‡æäº¤æŒ‰é’®æ˜¾ç¤ºä½ é€‰æ‹©çš„æ€§åˆ«æˆ–è€…åœ¨æ”¹å˜æ—¶æç¤ºé€‰æ‹©çš„æ€§åˆ«ã€‚</p><p>xmlé…ç½®å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;è¯·é€‰æ‹©ä½ çš„æ€§åˆ«:&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24dp&quot;</span>/&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">RadioGroup</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/radiogroup&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">       &gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">RadioButton</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/rbtnman&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;man&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24dp&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:checked</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">RadioButton</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/rbtnwoman&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;woman&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24dp&quot;</span>/&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">RadioGroup</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btnpost&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;æäº¤&quot;</span></span><br><span class="hljs-tag">       /&gt;</span><br></code></pre></td></tr></table></figure><p>MainActivityå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span>&#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-comment">//æ–¹æ³•ä¸€ï¼šä¸ºRadioGroupè®¾ç½®ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨setOnCheckChangeListener</span><br>        <span class="hljs-comment">//æ”¹åŠ¨çš„æ—¶å€™ä¼šå¼¹å‡ºæç¤º</span><br><span class="hljs-comment">//        RadioGroup rg = findViewById(R.id.radiogroup);</span><br><span class="hljs-comment">//        rg.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() &#123;</span><br><span class="hljs-comment">//            @Override</span><br><span class="hljs-comment">//            public void onCheckedChanged(RadioGroup radioGroup, int i) &#123;</span><br><span class="hljs-comment">//                RadioButton rbtn = findViewById(i);</span><br><span class="hljs-comment">//                Toast.makeText(MainActivity.this, &quot;ä½ é€‰è€…äº†&quot; + rbtn.getText().toString(), Toast.LENGTH_SHORT).show();</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//        &#125;);</span><br>        <span class="hljs-comment">//æ–¹æ³•äºŒï¼šé€šè¿‡å•å‡»å…¶ä»–æŒ‰é’®è·å–é€‰ä¸­å•é€‰æŒ‰é’®çš„å€¼</span><br>        <span class="hljs-type">RadioGroup</span> <span class="hljs-variable">rg</span> <span class="hljs-operator">=</span> findViewById(R.id.radiogroup);<br>        <span class="hljs-type">Button</span> <span class="hljs-variable">btnpost</span> <span class="hljs-operator">=</span> findViewById(R.id.btnpost);<br>        btnpost.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i&lt;rg.getChildCount(); i++)&#123;<br>                    <span class="hljs-type">RadioButton</span> <span class="hljs-variable">childbtn</span> <span class="hljs-operator">=</span> (RadioButton) rg.getChildAt(i);<br>                    <span class="hljs-keyword">if</span> (childbtn.isChecked())&#123;<br>                        Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;ä½ é€‰è€…äº†&quot;</span> + childbtn.getText().toString(), Toast.LENGTH_SHORT).show();<br>                    &#125;<br><br>                &#125;<br>            &#125;<br>        &#125;);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æ–¹æ³•ä¸€æ˜¯é€šè¿‡ç»™RadioGroupè®¾ç½®CheckedChangeç›‘å¬ï¼Œç›´æ¥è·å–è¢«é€‰æ‹©çš„RadioButtonçš„idï¼Œé€šè¿‡idæ‰¾åˆ°è¯¥æ§ä»¶ã€‚</p><p>æ–¹æ³•äºŒæ˜¯é€šè¿‡ç»™æŒ‰é’®è®¾ç½®Clickç›‘å¬ï¼Œéå†RadioGroupä¸‹çš„RadioButtonï¼ŒæŸ¥çœ‹RadioButtonæ˜¯å¦è¢«é€‰æ‹©ã€‚</p><h2 id="2-6-CheckBox"><a href="#2-6-CheckBox" class="headerlink" title="2.6 CheckBox"></a>2.6 CheckBox</h2><p>å¤é€‰æ¡†ã€‚å¯¹äºæ¯ä¸€ä¸ªå¤é€‰æ¡†ï¼Œä½¿ç”¨<code>&lt;CheckBox&gt;</code>å•ç‹¬åˆ›å»ºå³å¯ã€‚</p><h3 id="åŸºæœ¬å±æ€§-5"><a href="#åŸºæœ¬å±æ€§-5" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><p>å±æ€§åŒRadioButtonã€‚</p><h3 id="æ¡ˆä¾‹-2"><a href="#æ¡ˆä¾‹-2" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>åŒRadioButtonã€‚</p><p>ä¸€ç§æ–¹æ³•æ˜¯ç»™æ‰€æœ‰CheckBoxè®¾ç½®CheckedChangedç›‘å¬ï¼Œä½¿ç”¨isChecked()æ–¹æ³•åˆ¤æ–­æ˜¯å¦è¢«é€‰ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCheckedChanged</span><span class="hljs-params">(CompoundButton compoundButton, <span class="hljs-type">boolean</span> b)</span> &#123;<br>    <span class="hljs-keyword">if</span>(compoundButton.isChecked()) <br>        Toast.makeText(<span class="hljs-built_in">this</span>,compoundButton.getText().toString(),Toast.LENGTH_SHORT).show();<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦ä¸€ç§æ–¹æ³•æ˜¯ç»™æäº¤æŒ‰é’®è®¾ç½®clickç›‘å¬ï¼Œç„¶åéå†æ‰€æœ‰CheckBoxï¼Œä½¿ç”¨<code>isChecked()</code>æ–¹æ³•åˆ¤æ–­æ˜¯å¦è¢«é€‰ä¸­ã€‚ç”±äºCheckBoxæ˜¯ç‹¬ç«‹å­˜åœ¨çš„ï¼Œå¹¶ä¸åƒRadioButtonä¸€æ ·æœ‰çˆ¶æ ‡ç­¾RadioGroupï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨forå¾ªç¯åˆ¤æ–­ã€‚</p><h2 id="2-7-ProgressBar"><a href="#2-7-ProgressBar" class="headerlink" title="2.7 ProgressBar"></a>2.7 ProgressBar</h2><p>è¿›åº¦æ¡ã€‚</p><h3 id="åŸºæœ¬å±æ€§-6"><a href="#åŸºæœ¬å±æ€§-6" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>max</td><td>è¿›åº¦æ¡æœ€å¤§å€¼</td></tr><tr><td>progress</td><td>è¿›åº¦æ¡å·²ç»å®Œæˆè¿›åº¦å€¼</td></tr><tr><td>indeterminate</td><td>å¦‚æœè®¾ç½®æˆtrueï¼Œåˆ™è¿›åº¦æ¡ä¸ç²¾ç¡®æ˜¾ç¤ºè¿›åº¦</td></tr><tr><td>progressDrawable</td><td>è®¾ç½®è½¨é“å¯¹åº”çš„Drawableå¯¹è±¡</td></tr><tr><td>secondaryProgress</td><td>äºŒçº§è¿›åº¦æ¡ï¼Œç±»ä¼¼äºè§†é¢‘æ’­æ”¾çš„ä¸€æ¡æ˜¯å½“å‰æ’­æ”¾è¿›åº¦ï¼Œä¸€æ¡æ˜¯ç¼“å†²è¿›åº¦ï¼Œå‰è€…é€šè¿‡progresså±æ€§è¿›è¡Œè®¾ç½®</td></tr><tr><td>style</td><td>è¿›åº¦æ¡æ ·å¼</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-3"><a href="#æ¡ˆä¾‹-3" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--ç³»ç»Ÿæä¾›çš„åœ†å½¢è¿›åº¦æ¡--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">ProgressBar</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">    /&gt;</span><br><span class="hljs-comment">&lt;!--ç³»ç»Ÿæä¾›çš„æ°´å¹³è¿›åº¦æ¡--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">ProgressBar</span></span><br><span class="hljs-tag">    <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;?android:attr/progressBarStyleHorizontal&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;300dp&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">ProgressBar</span></span><br><span class="hljs-tag">    <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;?android:attr/progressBarStyleHorizontal&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;300dp&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:indeterminate</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">    /&gt;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­æ¡å½¢è¿›åº¦æ¡è®¾ç½®indeterminateä¸ºtrueåï¼Œå’Œåœ†å½¢è¿›åº¦æ¡ç±»ä¼¼ï¼Œåœ¨ä¸æ–­åœ°æµåŠ¨ã€‚</p><p>ç”±äºç³»ç»Ÿæä¾›çš„æ¯”è¾ƒç®€é™‹ï¼Œåœ¨å¼€å‘ä¸­ä¸€èˆ¬éƒ½ç”¨åŠ¨ç”»ï¼ˆAnimationï¼‰æ¥ä»£æ›¿æˆ–è€…è‡ªå®šä¹‰è¿›åº¦æ¡ï¼ˆç»§æ‰¿ProgressBaræˆ–è€…viewï¼‰ã€‚</p><h2 id="2-8-Notification"><a href="#2-8-Notification" class="headerlink" title="2.8 Notification"></a>2.8 Notification</h2><p>çŠ¶æ€æ é€šçŸ¥ã€‚</p><p>è¦æƒ³å®ç°é€šçŸ¥ï¼Œéœ€è¦è·å¾—ä¸¤ä¸ªå¯¹è±¡ï¼š</p><ul><li><p>NotificationMannager</p><p>NotificationManagerç±»æ˜¯ä¸€ä¸ªé€šçŸ¥ç®¡ç†å™¨ç±»ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ç”±ç³»ç»Ÿç»´æŠ¤çš„æœåŠ¡ï¼Œæ˜¯ä»¥å•ä¾‹æ¨¡å¼çš„æ–¹å¼è·å¾—ï¼Œæ‰€ä»¥ä¸€èˆ¬å¹¶ä¸ç›´æ¥å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡ã€‚åœ¨Activityä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>Activity.getSystemService(String)</code>æ–¹æ³•è·å–NotificationManagerå¯¹è±¡ï¼Œè¿™é‡Œä¼ é€’<code>Context.NOTIFICATION_SERVICE</code>å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">NotificationManager</span> <span class="hljs-variable">notification_manager</span> <span class="hljs-operator">=</span> (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);<br></code></pre></td></tr></table></figure></li><li><p>Notification</p><p>ä½¿ç”¨NotificationCompatç±»çš„Builderæ„é€ å™¨æ¥åˆ›å»ºNotificationå¯¹è±¡ï¼Œå¯ä»¥ä¿è¯ç¨‹åºåœ¨æ‰€æœ‰çš„ç‰ˆæœ¬ä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚Android8.0æ–°å¢äº†<strong>é€šçŸ¥æ¸ é“</strong>è¿™ä¸ªæ¦‚å¿µï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™é€šçŸ¥æ— æ³•åœ¨Android8.0çš„æœº<br>å™¨ä¸Šæ˜¾ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åˆ›å»ºbuilderå¯¹è±¡</span><br>NotificationCompat.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotificationCompat</span>.Builder(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;nid001&quot;</span>);<br><span class="hljs-comment">//builderçš„æˆå‘˜è®¾ç½®ï¼Œå¦‚setContentTitle(&quot;xxx&quot;)ç­‰</span><br>......<br><span class="hljs-comment">//åˆ›å»ºnotificationå¯¹è±¡</span><br><span class="hljs-type">Notification</span> <span class="hljs-variable">notification</span> <span class="hljs-operator">=</span> builder.build();<br></code></pre></td></tr></table></figure><p>ç”±äº<strong>é€šçŸ¥æ¸ é“</strong>çš„å¼•è¿›ï¼Œæˆ‘ä»¬è¦åˆ›å»ºé€šçŸ¥æ¸ é“å¹¶ä¸é€šçŸ¥ç®¡ç†æœåŠ¡ç»‘å®š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//Android 8.0å¼•å…¥äº†é€šçŸ¥æ¸ é“ï¼Œæ‰€ä»¥æ ¹æ®ç‰ˆæœ¬é€‰æ‹©æ˜¯å¦åˆ›å»ºé€šçŸ¥æ¸ é“</span><br><span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O)&#123;<br>    <span class="hljs-comment">/* @param id: è¡¨ç¤ºé€šçŸ¥æ¸ é“idï¼Œå³ä¸‹æ–¹åˆ›å»ºnotificationæ—¶çš„channelidï¼Œä¸¤è€…è¦ä¸€è‡³</span><br><span class="hljs-comment">    *  @param name: ä»»æ„</span><br><span class="hljs-comment">    *  @param importance: é€šçŸ¥é‡è¦æ€§</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">//åˆ›å»ºé€šçŸ¥æ¸ é“å¯¹è±¡</span><br>    <span class="hljs-type">NotificationChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotificationChannel</span>(<span class="hljs-string">&quot;nid001&quot;</span>,<span class="hljs-string">&quot;æµ‹è¯•é€šçŸ¥&quot;</span>, NotificationManager.IMPORTANCE_HIGH);<br>    <span class="hljs-comment">//é€šçŸ¥æ¸ é“å¯¹è±¡ä¸é€šçŸ¥ç®¡ç†æœåŠ¡å¯¹è±¡ç»‘å®š</span><br>    notification_manager.createNotificationChannel(channel);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯Builderåˆ›å»ºæ—¶çš„å‚æ•°idå’ŒChannelåˆ›å»ºæ—¶çš„å‚æ•°idè¦ä¸€è‡´</strong>ã€‚</p><p>NotificationChannelçš„Importanceå‚æ•°å¦‚ä¸‹ï¼š</p><table><thead><tr><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>IMPORTANCE_NONE</td><td>å…³é—­é€šçŸ¥</td></tr><tr><td>IMPORTANCE_MIN</td><td>å¼€å¯é€šçŸ¥ï¼Œä¸ä¼šå¼¹å‡ºï¼Œä½†æ²¡æœ‰æç¤ºéŸ³ï¼ŒçŠ¶æ€æ ä¸­æ— æ˜¾ç¤º</td></tr><tr><td>IMPGRTANCE_LOW</td><td>å¼€å¯é€šçŸ¥ï¼Œä¸ä¼šå¼¹å‡ºï¼Œä¸å‘å‡ºæç¤ºéŸ³ï¼ŒçŠ¶æ€æ ä¸­æ˜¾ç¤º</td></tr><tr><td>IMPORTANCE_DEFAULT</td><td>å¼€å¯é€šçŸ¥ï¼Œä¸ä¼šå¼¹å‡ºï¼Œå‘å‡ºæç¤ºéŸ³ï¼ŒçŠ¶æ€æ ä¸­æ˜¾ç¤º</td></tr><tr><td>IMPORTANCE_HIGH</td><td>å¼€å¯é€šçŸ¥ï¼Œä¼šå¼¹å‡ºï¼Œå‘å‡ºæç¤ºéŸ³ï¼ŒçŠ¶æ€æ ä¸­æ˜¾ç¤º</td></tr></tbody></table></li></ul><h3 id="NotificationCompat-Builderçš„åŸºæœ¬æ–¹æ³•"><a href="#NotificationCompat-Builderçš„åŸºæœ¬æ–¹æ³•" class="headerlink" title="NotificationCompat.Builderçš„åŸºæœ¬æ–¹æ³•"></a>NotificationCompat.Builderçš„åŸºæœ¬æ–¹æ³•</h3><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>setContentTitle(String string)</td><td>è®¾ç½®æ ‡é¢˜</td></tr><tr><td>setContentText(String string)</td><td>è®¾ç½®æ–‡æœ¬å†…å®¹</td></tr><tr><td>setSmallIcon(int icon)</td><td>è®¾ç½®å°å›¾æ ‡ï¼Œåªæ˜¯ç”¨alphaå›¾å±‚ï¼Œå³å›¾æ ‡ä¸èƒ½å¸¦é¢œè‰²</td></tr><tr><td>setLargeIcon(int argb)</td><td>è®¾ç½®å°å›¾æ ‡é¢œè‰²</td></tr><tr><td>setContentIntent(PendingIntent intent)</td><td>è®¾ç½®ç‚¹å‡»é€šçŸ¥åçš„è·³è½¬æ„å›¾</td></tr><tr><td>setAutoCancel(boolean bool)</td><td>è®¾ç½®ç‚¹å‡»é€šçŸ¥åè‡ªåŠ¨æ¸…é™¤é€šçŸ¥</td></tr><tr><td>setWhen(long when)</td><td>è®¾ç½®é€šçŸ¥çš„åˆ›å»ºäº‹ä»¶</td></tr></tbody></table><p>å…¶ä¸­å‰ä¸‰ä¸ªæ–¹æ³•æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ç¨‹åºæ— æ³•æ­£å¸¸å·¥ä½œã€‚</p><h3 id="æ¡ˆä¾‹-4"><a href="#æ¡ˆä¾‹-4" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>é€šè¿‡æŒ‰é’®åˆ›å»ºå’Œæ¸…æ¥šé€šçŸ¥ï¼Œå¹¶ä¸”ç‚¹å‡»é€šçŸ¥ä¼šè·³è½¬åˆ°å¦ä¸€ä¸ªé¡µé¢(activity)ã€‚</p><p>xmlå£°æ˜å¦‚ä¸‹ã€‚é€šè¿‡onClickå±æ€§ç»‘å®šç‚¹å‡»äº‹ä»¶å¤„ç†æ–¹æ³•ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;165dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;sentNotification&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å‘é€é€šçŸ¥&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;165dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;cacelNotification&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å–æ¶ˆé€šçŸ¥&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>MainActivityæ–¹æ³•å¦‚ä¸‹ã€‚è·å–é€šçŸ¥ç®¡ç†æœåŠ¡(NotificationManager)ï¼Œåˆ›å»ºé€šä¿¡æ¸ é“(channel)å¹¶ä¸é€šçŸ¥ç®¡ç†æœåŠ¡ç»‘å®šã€‚åˆ›å»ºPendingIntentè®¾ç½®è·³è½¬æ„å›¾ã€‚åˆ›å»ºNotificationå¯¹è±¡ï¼Œæœ€åå®ç°ç‚¹å‡»äº‹ä»¶å¤„ç†æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">private</span> NotificationManager notification_manager;<br>    <span class="hljs-keyword">private</span> Notification notification;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        <span class="hljs-comment">//è·å–é€šçŸ¥ç®¡ç†æœåŠ¡</span><br>        notification_manager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);<br>        <span class="hljs-comment">//Android 8.0å¼•å…¥äº†é€šçŸ¥æ¸ é“ï¼Œæ‰€ä»¥æ ¹æ®ç‰ˆæœ¬é€‰æ‹©æ˜¯å¦åˆ›å»ºé€šçŸ¥æ¸ é“</span><br>        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O)&#123;<br>            <span class="hljs-comment">/* @param id: è¡¨ç¤ºé€šçŸ¥æ¸ é“idï¼Œå³ä¸‹æ–¹åˆ›å»ºnotificationæ—¶çš„channelidï¼Œä¸¤è€…è¦ä¸€è‡³</span><br><span class="hljs-comment">            *  @param name: ä»»æ„</span><br><span class="hljs-comment">            *  @param importance: é€šçŸ¥é‡è¦æ€§</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-comment">//åˆ›å»ºé€šçŸ¥æ¸ é“å¯¹è±¡</span><br>            <span class="hljs-type">NotificationChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotificationChannel</span>(<span class="hljs-string">&quot;nid001&quot;</span>,<span class="hljs-string">&quot;æµ‹è¯•é€šçŸ¥&quot;</span>,<br>                    NotificationManager.IMPORTANCE_HIGH);<br>            <span class="hljs-comment">//é€šçŸ¥æ¸ é“å¯¹è±¡ä¸é€šçŸ¥ç®¡ç†æœåŠ¡å¯¹è±¡ç»‘å®š</span><br>            notification_manager.createNotificationChannel(channel);<br>        &#125;<br><br>        <span class="hljs-comment">//åˆ›å»ºIntent</span><br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, NotificationActivity.class);<br><br>        <span class="hljs-comment">//åˆ›å»ºPendingIntent</span><br>        <span class="hljs-type">PendingIntent</span> <span class="hljs-variable">pendingIntent</span> <span class="hljs-operator">=</span>  PendingIntent.getActivity(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>, intent, PendingIntent.FLAG_IMMUTABLE);<br><br>        <span class="hljs-comment">//åˆ›å»ºnotificationå¯¹è±¡å¹¶è®¾ç½®åŸºæœ¬å±æ€§</span><br>        notification = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotificationCompat</span>.Builder(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;nid001&quot;</span>)<br>                .setContentTitle(<span class="hljs-string">&quot;å¶å&quot;</span>)<br>                .setContentText(<span class="hljs-string">&quot;å–‚å–‚å–‚&quot;</span>)<br>                .setSmallIcon(R.drawable.baseline_account_box_24)<br>                .setLargeIcon(BitmapFactory.decodeResource(getResources(),R.drawable.wallhaven))<br>                .setColor(Color.parseColor(<span class="hljs-string">&quot;#FFFF0000&quot;</span>))<br>                .setContentIntent(pendingIntent)<br>                .setAutoCancel(<span class="hljs-literal">true</span>)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sentNotification</span><span class="hljs-params">(View view)</span>&#123;<br>        <span class="hljs-comment">/* @param id: ä»»æ„</span><br><span class="hljs-comment">         *  @param notification: åˆ›å»ºå¥½çš„é€šçŸ¥</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//å°†åˆ›å»ºå¥½çš„é€šçŸ¥å‘é€å‡ºå»</span><br>        notification_manager.notify(<span class="hljs-number">111</span>,notification);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacelNotification</span><span class="hljs-params">(View view)</span>&#123;<br>        <span class="hljs-comment">//æ¸…é™¤é€šçŸ¥ï¼Œidä¸notifyæ–¹æ³•çš„idä¸€è‡´</span><br>        notification_manager.cancel(<span class="hljs-number">111</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­NotificationActivityæ–¹æ³•å¦‚ä¸‹ã€‚åªæ˜¯ç®€å•çš„åœ¨Logcatå¤„è¾“å‡ºä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//éœ€è¦å°†è¯¥Acitivityæ³¨å†Œåˆ°AndroidManifest.xmlä¸­ï¼Œå¦åˆ™å¦åˆ™ç³»ç»Ÿå°†ä¸è¯†åˆ«ä¹Ÿä¸æ‰§è¡Œè¯¥Activity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        Log.d(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;ç‚¹å‡»æ¶ˆæ¯è¿›å…¥åˆ°äº†NotificatoinActivity&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-9-Toolbar"><a href="#2-9-Toolbar" class="headerlink" title="2.9 Toolbar"></a>2.9 Toolbar</h2><p>å·¥å…·æ ã€‚</p><h3 id="åŸºæœ¬å±æ€§-7"><a href="#åŸºæœ¬å±æ€§-7" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>layout_widthã€layout_height</td><td>å®½é«˜ï¼Œlayout_heightä¸€èˆ¬è®¾ç½®ä¸ºâ€œ?attr&#x2F;actionBarSizeâ€</td></tr><tr><td>background</td><td>èƒŒæ™¯è‰²æˆ–èƒŒæ™¯å›¾</td></tr><tr><td>navigationIcon</td><td>å¯¼èˆªå›¾æ ‡ï¼Œæ¯”å¦‚è¿”å›å›¾æ ‡</td></tr><tr><td>title</td><td>æ ‡é¢˜</td></tr><tr><td>subtitle</td><td>å­æ ‡é¢˜</td></tr><tr><td>logo</td><td>å›¾æ ‡</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-5"><a href="#æ¡ˆä¾‹-5" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.appcompat.widget.Toolbar</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;?attr/actionBarSize&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#00FFFF&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:title</span>=<span class="hljs-string">&quot;å¤§æ ‡é¢˜&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:subtitle</span>=<span class="hljs-string">&quot;å°æ ‡é¢˜&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:titleMarginStart</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:navigationIcon</span>=<span class="hljs-string">&quot;@drawable/baseline_arrow_back_24&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:logo</span>=<span class="hljs-string">&quot;@mipmap/ic_launcher&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬æ ‡é¢˜éƒ½æ˜¯å±…ä¸­æ˜¾ç¤º</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.appcompat.widget.Toolbar</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;?attr/actionBarSize&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#00FFFF&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:navigationIcon</span>=<span class="hljs-string">&quot;@drawable/baseline_arrow_back_24&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:logo</span>=<span class="hljs-string">&quot;@mipmap/ic_launcher&quot;</span></span><br><span class="hljs-tag">        &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;æ ‡é¢˜&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">            /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">androidx.appcompat.widget.Toolbar</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨TextViewä¸­è®¾ç½®äº†æ ‡é¢˜å°±ä¸è¦åœ¨<code>&lt;androidx.appcompat.widget.Toolbar&gt;</code>é‡Œé¢å†è®¾ç½®æ ‡é¢˜äº†ã€‚ç”±äºæ˜¯androidxé‡Œé¢çš„Toolbarï¼Œä¸androidé‡Œé¢çš„Toolbarä¸åŒï¼Œéœ€è¦æ³¨æ„åœ¨javaä»£ç ä¸­ä½¿ç”¨è¯¥å¯¹è±¡æ—¶ä¸è¦å¯¼é”™åŒ…ï¼ˆimport androidx.appcompat.widget.Toolbarï¼‰ã€‚</p><h2 id="2-10-AlertDialog"><a href="#2-10-AlertDialog" class="headerlink" title="2.10 AlertDialog"></a>2.10 AlertDialog</h2><p>å¯¹è¯æ¡†ã€‚</p><h3 id="AlertDialog-Builderçš„åŸºæœ¬æ–¹æ³•"><a href="#AlertDialog-Builderçš„åŸºæœ¬æ–¹æ³•" class="headerlink" title="AlertDialog.Builderçš„åŸºæœ¬æ–¹æ³•"></a>AlertDialog.Builderçš„åŸºæœ¬æ–¹æ³•</h3><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>setIcon(int iconId)</td><td>è®¾ç½®å›¾æ ‡</td></tr><tr><td>setTitle(Charsequence title)</td><td>æ·»åŠ æ ‡é¢˜</td></tr><tr><td>setMessage(CharSequence message)</td><td>æ·»åŠ æ¶ˆæ¯</td></tr><tr><td>setView(View view)</td><td>è®¾ç½®è‡ªå®šä¹‰å¸ƒå±€</td></tr><tr><td>setPositiveButton</td><td>ç¡®å®šæŒ‰é’®</td></tr><tr><td>setNegativeButton</td><td>å–æ¶ˆæŒ‰é’®</td></tr><tr><td>setNeutralButton</td><td>ä¸­é—´æŒ‰é’®</td></tr><tr><td>create()</td><td>åˆ›å»ºå¯¹è¯æ¡†</td></tr><tr><td>show()</td><td>æ˜¾ç¤ºå¯¹è¯æ¡†</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-6"><a href="#æ¡ˆä¾‹-6" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>å®ç°ä»¥ä¸ŠåŠŸèƒ½ã€‚</p><p>è§¦å‘æŒ‰é’®çš„xmlè®¾ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btn1&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ç‚¹å‡»æ˜¾ç¤ºçª—å£&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;ClickWindow&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br></code></pre></td></tr></table></figure><p>ç»‘å®šäº†ClickWindowæ–¹æ³•ã€‚</p><p>MainActivityæ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">private</span> AlertDialog dialog;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br><span class="hljs-comment">//        View dialogview = getLayoutInflater().inflate(R.layout.dialog_view, null);</span><br><br>        <span class="hljs-comment">//åˆ›å»ºAlertDialog.Builderå¯¹è±¡</span><br>        AlertDialog.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">//è®¾ç½®åŸºæœ¬å±æ€§</span><br>        dialog = builder.setIcon(R.drawable.baseline_account_box_24)<br>                .setTitle(<span class="hljs-string">&quot;æˆ‘æ˜¯å¯¹è¯æ¡†&quot;</span>)<br>                .setMessage(<span class="hljs-string">&quot;é˜¿å·´é˜¿å·´......&quot;</span>)<br>                .setPositiveButton(<span class="hljs-string">&quot;ç¡®è®¤&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DialogInterface</span>.OnClickListener() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(DialogInterface dialogInterface, <span class="hljs-type">int</span> i)</span> &#123;<br>                        Log.d(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;ç‚¹å‡»ç¡®è®¤&quot;</span>);<br>                    &#125;<br>                &#125;)<br>                .setNegativeButton(<span class="hljs-string">&quot;å–æ¶ˆ&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DialogInterface</span>.OnClickListener() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(DialogInterface dialogInterface, <span class="hljs-type">int</span> i)</span> &#123;<br>                        Log.d(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;ç‚¹å‡»å–æ¶ˆ&quot;</span>);<br>                    &#125;<br>                &#125;)<br>                .setNeutralButton(<span class="hljs-string">&quot;ä¸­ç«‹&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DialogInterface</span>.OnClickListener() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(DialogInterface dialogInterface, <span class="hljs-type">int</span> i)</span> &#123;<br>                        Log.d(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;ç‚¹å‡»ä¸­ç«‹&quot;</span>);<br>                    &#125;<br>                &#125;)<br>                .setView(R.layout.dialog_view)<br>                .create();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClickWindow</span><span class="hljs-params">(View view)</span> &#123;<br>        dialog.show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œé¦–å…ˆè¦åˆ›å»ºçš„æ˜¯AlertDialog.Builderå¯¹è±¡ï¼Œç„¶åé€šè¿‡ä¸€ç³»åˆ—æ–¹æ³•è®¾ç½®å±æ€§ã€‚å…¶ä¸­setViewæ–¹æ³•çš„å‚æ•°æ˜¯è‡ªå·±åˆ›å»ºçš„ä¸€ä¸ªå¸ƒå±€çš„xmlæ–‡ä»¶ã€‚æœ€åå®ç°ClickWindowæ–¹æ³•æ¥å¤„ç†ç‚¹å‡»äº‹ä»¶ã€‚</p><h2 id="2-11-PopupWindow"><a href="#2-11-PopupWindow" class="headerlink" title="2.11 PopupWindow"></a>2.11 PopupWindow</h2><p>æ‚¬æµ®æ¡†ã€‚</p><p>PopupWindowå¼¹å‡ºåï¼Œæ‰€æœ‰çš„è§¦å±å’Œç‰©ç†æŒ‰é”®éƒ½ç”±PopupWindows å¤„ç†ã€‚å…¶ä»–ä»»ä½•äº‹ä»¶çš„å“åº”éƒ½å¿…é¡»å‘ç”Ÿåœ¨PopupWindowæ¶ˆå¤±ä¹‹åï¼Œï¼ˆhome ç­‰ç³»ç»Ÿå±‚é¢çš„äº‹ä»¶é™¤å¤–ï¼‰ã€‚ </p><h3 id="åŸºæœ¬æ–¹æ³•"><a href="#åŸºæœ¬æ–¹æ³•" class="headerlink" title="åŸºæœ¬æ–¹æ³•"></a>åŸºæœ¬æ–¹æ³•</h3><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>PopupWindow(View contentView, int width, int height, boolean focusable)</td><td>å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œè¿™é‡Œæ‹¿ä¸€ä¸ªæ¥è¯´æ˜ã€‚å‚æ•°contentViewæŒ‡PopupWindowçš„å¸ƒå±€ï¼Œå‚æ•°widthå’Œheightä¸€èˆ¬è®¾ç½®ViewGroup.LayoutParams.WRAP_CONTENTï¼Œå‚æ•°focusableæŒ‡æ˜¯å¦æ˜¾ç¤ºç„¦ç‚¹ï¼Œå³ç‚¹å‡»è¯¥å¸ƒå±€ä¹‹å¤–çš„åœ°æ–¹å¯ä»¥é€€å‡ºã€‚</td></tr><tr><td>setContentView(View contentView)</td><td>è®¾ç½®PopupWindowæ˜¾ç¤ºçš„View</td></tr><tr><td>getContentView()</td><td>è·å¾—PopupWindowæ˜¾ç¤ºçš„View</td></tr><tr><td>showAsDropDown(View anchor)</td><td>ç›¸å¯¹æŸä¸ªæ§ä»¶çš„ä½ç½®ï¼ˆæ­£å·¦ä¸‹æ–¹ï¼‰ï¼Œæ— åç§»</td></tr><tr><td>showAsDropDown(View anchor, int xoff, int yoff)</td><td>ç›¸å¯¹æŸä¸ªæ§ä»¶çš„ä½ç½®ï¼Œæœ‰åç§»</td></tr><tr><td>setFocusable(boolean focusable)</td><td>è®¾ç½®ç„¦ç‚¹</td></tr><tr><td>setBackgroundDrawable(Drawable background)</td><td>è®¾ç½®èƒŒæ™¯</td></tr><tr><td>setAnimationStyle(int animationStyle)</td><td>è®¾ç½®åŠ¨ç”»æ•ˆæœ</td></tr><tr><td>dismiss()</td><td>å…³é—­å¼¹çª—</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-7"><a href="#æ¡ˆä¾‹-7" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>xmlé…ç½®å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--ä¸»æ´»åŠ¨çš„layoutçš„xml--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btn1&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;ç‚¹å‡»æ˜¾ç¤ºPopupWindow&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;ClickButton&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><span class="hljs-comment">&lt;!--popupwindowçš„layoutçš„xml--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/haha&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å“ˆå“ˆå“ˆå“ˆå“ˆ&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/xixi&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å˜»å˜»å˜»å˜»&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>MainActivityå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">private</span> PopupWindow popupWindow;<br>    <span class="hljs-keyword">private</span> View popupwindow_view;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-comment">//è·å–viewèµ„æºçš„å¯¹è±¡</span><br>        popupwindow_view = getLayoutInflater().inflate(R.layout.popupwindow_view, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//åˆ›å»ºpopupwindowå¯¹è±¡</span><br>        popupWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PopupWindow</span>(popupwindow_view,<br>                ViewGroup.LayoutParams.WRAP_CONTENT,<br>                ViewGroup.LayoutParams.WRAP_CONTENT,<br>                <span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®èƒŒæ™¯</span><br>        popupWindow.setBackgroundDrawable(getResources().getDrawable(R.drawable.wallhaven));<br><br>        <span class="hljs-comment">//è®¾ç½®popupwindowä¸­æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†æ–¹æ³•</span><br>        <span class="hljs-type">Button</span> <span class="hljs-variable">haha</span> <span class="hljs-operator">=</span> popupwindow_view.findViewById(R.id.haha);<br>        <span class="hljs-type">Button</span> <span class="hljs-variable">xixi</span> <span class="hljs-operator">=</span> popupwindow_view.findViewById(R.id.xixi);<br>        haha.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>                Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;ä½ ç‚¹å‡»äº†å“ˆå“ˆå“ˆ&quot;</span>, Toast.LENGTH_SHORT).show();<br>                popupWindow.dismiss();<br>            &#125;<br>        &#125;);<br>        xixi.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>                Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;ä½ ç‚¹å‡»äº†å˜»å˜»å˜»&quot;</span>, Toast.LENGTH_SHORT).show();<br>                popupWindow.dismiss();<br>            &#125;<br>        &#125;);<br><br>    &#125;<br>    <span class="hljs-comment">//æ˜¾ç¤ºpopupwindow</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClickButton</span><span class="hljs-params">(View view)</span> &#123;<br>        popupWindow.showAsDropDown(view);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-12-ListView"><a href="#2-12-ListView" class="headerlink" title="2.12 ListView"></a>2.12 ListView</h2><p>åˆ—è¡¨ã€‚åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹(item)éƒ½æœ‰è‡ªå·±çš„å¸ƒå±€ã€‚itemçš„å¸ƒå±€å•ç‹¬åˆ›å»ºä¸€ä¸ªlayoutçš„xmlæ–‡ä»¶ï¼Œå¹¶å¯¹è¯¥å¸ƒå±€åˆ›å»ºä¸€ä¸ªç±»ï¼ŒåŒæ—¶ä¹Ÿè¦åˆ›å»ºå¯¹åº”çš„Adapterç±»ï¼Œç”¨æ¥ç»™itemå¡«å……æ•°æ®ç­‰ã€‚</p><blockquote><p>ä»€ä¹ˆæ˜¯Adapter?</p><p>ç­”ï¼š</p><p>Adapterï¼ˆé€‚é…å™¨ï¼‰æ˜¯ä¸€ä¸ªç”¨äºå°†æ•°æ®ä¸è§†å›¾è¿›è¡Œç»‘å®šçš„æ¡¥æ¢ã€‚ç®€å•ç‚¹è¯´ï¼Œå°±æ˜¯å°†å„ç§æ•°æ®ä»¥åˆé€‚çš„å½¢å¼æ˜¾ç¤ºåˆ°viewä¸Šï¼Œæä¾›ç»™ç”¨æˆ·çœ‹ã€‚ï¼ˆä¸ªäººçš„ç†è§£æ˜¯Adapterå°†æ•°æ®ä»å¸ƒå±€ä¸­åˆ†ç¦»å¼€æ¥ï¼‰</p><p>å¸¸ç”¨çš„å‡ ä¸ªAdapterç±»</p><ul><li>BaseAdapterï¼šæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæä¾›äº†ä¸€ä¸ªåŸºæœ¬çš„Adapterå®ç°ï¼Œå¯ä»¥ç”¨äºè‡ªå®šä¹‰Adapterçš„å¼€å‘ã€‚</li><li>ArrayAdapterï¼šæ˜¯BaseAdapterçš„å­ç±»ï¼Œç”¨äºå°†æ•°ç»„æˆ–Listæ•°æ®ç»‘å®šåˆ°ListViewä¸­ã€‚</li><li>SimpleAdapterï¼šæ˜¯BaseAdapterçš„å­ç±»ï¼Œç”¨äºå°†é”®å€¼å¯¹æ•°æ®ç»‘å®šåˆ°ListViewä¸­çš„å¤šä¸ªTextViewç»„åˆçš„å¸ƒå±€ä¸­ã€‚</li><li>CursorAdapterï¼šæ˜¯BaseAdapterçš„å­ç±»ï¼Œç”¨äºå°†æ•°æ®åº“Cursorä¸­çš„æ•°æ®ç»‘å®šåˆ°ListViewä¸­ã€‚</li><li>RecyclerView.Adapterï¼šç”¨äºRecyclerViewç»„ä»¶çš„é€‚é…å™¨ï¼Œæ”¯æŒæ›´å¼ºå¤§çš„åˆ—è¡¨é¡¹å®šåˆ¶å’ŒåŠ¨ç”»æ•ˆæœã€‚</li></ul></blockquote><h3 id="åŸºæœ¬å±æ€§-8"><a href="#åŸºæœ¬å±æ€§-8" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>divider</td><td>è®¾ç½®è¡¨é¡¹ä¹‹é—´çš„åˆ†éš”æ¡,å¯ä»¥ç”¨é¢œè‰²åˆ†å‰²,ä¹Ÿå¯ä»¥ç”¨drawableèµ„æºåˆ†å‰²</td></tr><tr><td>dividerHeight</td><td>è®¾ç½®è¡¨é¡¹ä¹‹é—´åˆ†å‰²çº¿çš„é«˜åº¦</td></tr><tr><td>dividerPadding</td><td>è®¾ç½®è¡¨é¡¹ä¹‹é—´åˆ†å‰²çº¿çš„å·¦å³å†…è¾¹è·</td></tr><tr><td>listSelector</td><td>è®¾ç½®è¡¨é¡¹è¢«é€‰ä¸­æ—¶çš„èƒŒæ™¯æ ·å¼</td></tr><tr><td>scrollbars</td><td>è®¾ç½®æ»šåŠ¨æ¡çš„æ˜¾ç¤ºæ–¹å¼ï¼Œå¦‚â€verticalâ€ï¼ˆå‚ç›´æ»šåŠ¨æ¡ï¼‰ã€â€horizontalâ€ï¼ˆæ°´å¹³æ»šåŠ¨æ¡ï¼‰å’Œâ€noneâ€ï¼ˆä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ï¼‰</td></tr><tr><td>headerDividersEnabled, footerDividersEnabled</td><td>æ˜¯å¦æ˜¾ç¤ºåˆ—è¡¨å¤´éƒ¨å’Œå°¾éƒ¨çš„åˆ†å‰²çº¿ï¼Œé»˜è®¤ä¸ºtrue</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-8"><a href="#æ¡ˆä¾‹-8" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>å®ç°ç±»ä¼¼QQçš„æ¶ˆæ¯åˆ—è¡¨ã€‚ï¼ˆç›®çš„åœ¨äºå­¦ä¼šä½¿ç”¨Adapteï¼‰</p><p>é¦–å…ˆactivity_main.xmlä¸­åˆ›å»ºä¸€ä¸ªListViewå°±è¡Œäº†ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ListView</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/lv&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ListView</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¦å¤–åˆ›å»ºä¸€ä¸ªxmlæ–‡ä»¶ç”¨äºåˆ—è¡¨ä¸­itemçš„å¸ƒå±€ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/imageView&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;135dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;128dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">&quot;@+id/textView3&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toStartOf</span>=<span class="hljs-string">&quot;@+id/textView3&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">tools:srcCompat</span>=<span class="hljs-string">&quot;@tools:sample/avatars&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/textView2&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;275dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;40dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;TextView&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">&quot;parent&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/textView3&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;275dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;94dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;TextView&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">&quot;parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">&quot;@+id/textView2&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ConstraintLayoutå¸ƒå±€å¾ˆæ–¹ä¾¿ï¼Œåªè¦æ‹–æ‹½ç»„ä»¶ï¼Œè¿çº¿å°±å¯ä»¥åˆ¶ä½œå¥½ã€‚</p><p>å› ä¸ºä¿¡æ¯ä¸å­˜æ”¾åœ¨xmlæ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªç±»æ¥æè¿°itemã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åˆ—è¡¨ä¸­itemæ‰€éœ€è¦å±•ç¤ºçš„ä¸œè¥¿</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br><span class="hljs-comment">//ç½‘å</span><br>    <span class="hljs-keyword">private</span> String name;<br><span class="hljs-comment">//æ¶ˆæ¯</span><br>    <span class="hljs-keyword">private</span> String text;<br>    <span class="hljs-comment">//å¤´åƒ</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pIcon;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, String text, <span class="hljs-type">int</span> pIcon)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.text = text;<br>        <span class="hljs-built_in">this</span>.pIcon = pIcon;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getText</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> text;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setText</span><span class="hljs-params">(String text)</span> &#123;<br>        <span class="hljs-built_in">this</span>.text = text;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getpIcon</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> pIcon;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setpIcon</span><span class="hljs-params">(<span class="hljs-type">int</span> pIcon)</span> &#123;<br>        <span class="hljs-built_in">this</span>.pIcon = pIcon;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å†å†™ä¸ªç±»ç»§æ‰¿BaseAdapterç”¨æ¥å°†æ•°æ®æ˜¾ç¤ºåœ¨é¡µé¢ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseAdapter</span> &#123;<br><br>    <span class="hljs-keyword">private</span> ArrayList&lt;Person&gt; data;<br>    <span class="hljs-keyword">private</span> Context context;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PersonAdapter</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PersonAdapter</span><span class="hljs-params">(ArrayList&lt;Person&gt; data, Context context)</span> &#123;<br>        <span class="hljs-built_in">this</span>.data = data;<br>        <span class="hljs-built_in">this</span>.context = context;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> data.size();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getItem</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>        <span class="hljs-keyword">return</span> data.get(i);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getItemId</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>        <span class="hljs-keyword">return</span> i;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-comment">//getViewç»™åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹è¿›è¡Œè®¾ç½®å¹¶è¿”å›åˆ°é¡µé¢ä¸Š</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">getView</span><span class="hljs-params">(<span class="hljs-type">int</span> i, View view, ViewGroup viewGroup)</span> &#123;<br>        ViewHolder viewHolder;<br>        <br>        <span class="hljs-keyword">if</span> (view == <span class="hljs-literal">null</span>)&#123;<br>            view = LayoutInflater.from(context).inflate(R.layout.item_view, viewGroup, <span class="hljs-literal">false</span>);<br><br>            viewHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewHolder</span>();<br>            viewHolder.Icon = view.findViewById(R.id.imageView);<br>            viewHolder.Name = view.findViewById(R.id.textView2);<br>            viewHolder.Message = view.findViewById(R.id.textView3);<br><br>            view.setTag(viewHolder);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            viewHolder = (ViewHolder) view.getTag();<br>        &#125;<br><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> data.get(i);<br><br>        viewHolder.Icon.setBackgroundResource(person.getpIcon());<br>        viewHolder.Name.setText(person.getName());<br>        viewHolder.Message.setText(person.getText());<br><br>        <span class="hljs-keyword">return</span> view;<br>    &#125;<br><br>    <span class="hljs-comment">//ä¼˜åŒ–</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>&#123;<br>        ImageView Icon;<br>        TextView Name;<br>        TextView Message;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºgetViewæ–¹æ³•ï¼Œæœ‰å¤šå°‘ä¸ªitemå°±ä¼šè°ƒç”¨å¤šå°‘æ¬¡getViewæ–¹æ³•ï¼Œé‡Œé¢çš„inflateæ–¹æ³•å’ŒfindViewByIdæ–¹æ³•ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œè¿™æ˜¯éå¸¸è€—æ—¶çš„ã€‚</p><p>ä½†æ˜¯getViewæ–¹æ³•ä¸­çš„å‚æ•°viewæ˜¯ç³»ç»Ÿæä¾›çš„è§†å›¾<strong>ç¼“å­˜</strong>å¯¹è±¡ã€‚æ‰€ä»¥é€šè¿‡ifè¯­å¥çš„åˆ¤æ–­viewæ˜¯å¦å·²ç»åˆ›å»ºï¼Œå°±ä¸ä¼šæ‰§è¡Œå¤šæ¬¡inflateæ–¹æ³•ã€‚åŒæ—¶åˆ›å»ºViewHolderç±»å­˜æ”¾itemçš„ç»„ä»¶ï¼Œé€šè¿‡view.setTag(viewHolder)æ”¾å…¥viewä¸­ï¼Œç›¸å½“äºä¹Ÿç¼“å­˜itemä¸­çš„æ§ä»¶å¼•ç”¨ï¼Œä»¥ä¾¿åç»­å¤ç”¨ï¼ˆæ¯”å¦‚å±å¹•ä¸Šä¸‹æ»‘åŠ¨ï¼ŒåŒä¸€ä¸ªitemå¤šæ¬¡å‡ºç°ã€éšè—çš„æƒ…å†µï¼‰ã€‚</p><p>æœ€åMainActivity.javaå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span>&#123;<br><br>    <span class="hljs-keyword">private</span> ArrayList&lt;Person&gt; PersonArrayList;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-comment">//éšä¾¿é€ ç‚¹æ•°æ®</span><br>        PersonArrayList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Person&gt;();<br>        PersonArrayList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;é€ä¹‹&quot;</span>, <span class="hljs-string">&quot;åœ¨å—ï¼Ÿ&quot;</span>, R.drawable.wallhaven));<br>        PersonArrayList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;æ— é˜¿&quot;</span>, <span class="hljs-string">&quot;Vivo50&quot;</span>, R.drawable.wallhaven));<br>        PersonArrayList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;å‰æ‹‰&quot;</span>, <span class="hljs-string">&quot;6&quot;</span>, R.drawable.wallhaven));<br>        PersonArrayList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;é˜¿ä¸‰&quot;</span>, <span class="hljs-string">&quot;?&quot;</span>, R.drawable.wallhaven));<br>        PersonArrayList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;éª—å­&quot;</span>, <span class="hljs-string">&quot;æˆ‘æ˜¯ç§¦å§‹çš‡&quot;</span>, R.drawable.baseline_account_box_24));<br><br>        <span class="hljs-comment">//æ‰¾åˆ°ListView</span><br>        <span class="hljs-type">ListView</span> <span class="hljs-variable">listviewByid</span> <span class="hljs-operator">=</span> findViewById(R.id.lv);<br>        <span class="hljs-comment">//éœ€è¦é…åˆAdapteræ‰èƒ½å°†æ•°æ®æ”¾å…¥</span><br>        listviewByid.setAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PersonAdapter</span>(PersonArrayList, <span class="hljs-built_in">this</span>));<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-13-RecyclerView"><a href="#2-13-RecyclerView" class="headerlink" title="2.13 RecyclerView"></a>2.13 RecyclerView</h2><p>RecyclerViewæ¯”ListViewæ›´åŠ çµæ´»ï¼ŒRecyclerViewåœ¨ç»§æ‰¿RecyclerView.Adapteræ—¶ä¼šå¼ºåˆ¶è®©æˆ‘ä»¬å®ç°ViewHolderï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†å¤šä¸ªå¸ƒå±€å¯ä¾›é€‰æ‹©ã€‚</p><p>ç›´æ¥ä¸Šæ¡ˆä¾‹ã€‚</p><h3 id="æ¡ˆä¾‹-9"><a href="#æ¡ˆä¾‹-9" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>åŒListViewçš„æ¡ˆä¾‹ã€‚ä¸»è¦æ˜¯ç»§æ‰¿RecyclerView.Adapterå¤„æœ‰åŒºåˆ«ã€‚</p><p>PersonAdapter.javaå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//RecyclerView.Adapter&lt;VH&gt;,åœ¨ç»§æ‰¿RecyclerView.Adapterçš„æ—¶å€™å°±è®©æˆ‘ä»¬å¼ºåˆ¶æ€§åˆ›å»ºViewHolderæ¥ä¼˜åŒ–</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.Adapter&lt;PersonAdapter.ViewHolder&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> ArrayList&lt;Person&gt; data;<br>    <span class="hljs-keyword">private</span> Context context;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PersonAdapter</span><span class="hljs-params">(ArrayList&lt;Person&gt; data, Context context)</span> &#123;<br>        <span class="hljs-built_in">this</span>.data = data;<br>        <span class="hljs-built_in">this</span>.context = context;<br>    &#125;<br><br>    <span class="hljs-comment">//ç”¨äºåˆ›å»ºViewHolderå¯¹è±¡</span><br>    <span class="hljs-keyword">public</span> ViewHolder <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewGroup parent, <span class="hljs-type">int</span> viewType)</span> &#123;<br>        <span class="hljs-comment">//å°±æ˜¯BaseAdapterç±»ä¸­getView()æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°--ç¼“å†²å¯¹è±¡view</span><br>        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> View.inflate(context, R.layout.item_view, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//åˆ›å»ºviewholderå¹¶è¿”å›</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewHolder</span>(view);<br>    &#125;<br><br>    <span class="hljs-comment">//ç”¨äºç»™itemçš„æ§ä»¶è®¾ç½®æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBindViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewHolder holder, <span class="hljs-type">int</span> position)</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> data.get(position);<br><br>        holder.Icon.setBackgroundResource(person.getpIcon());<br>        holder.Name.setText(person.getName());<br>        holder.Message.setText(person.getText());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getItemCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> data == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span>:data.size();<br>    &#125;<br><br>    <span class="hljs-comment">//ViewHolderéœ€è¦ç»§æ‰¿RecyclerView.ViewHolderç±»</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.ViewHolder &#123;<br>        <span class="hljs-comment">//itemçš„æ§ä»¶</span><br>        <span class="hljs-keyword">private</span> ImageView Icon;<br>        <span class="hljs-keyword">private</span> TextView Name;<br>        <span class="hljs-keyword">private</span> TextView Message;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View itemView)</span> &#123;<br>            <span class="hljs-built_in">super</span>(itemView);<br>            <span class="hljs-comment">//è·å–æ§ä»¶,è°ƒç”¨çš„æ—¶å€™é€šè¿‡ViewHolder.xxx</span><br>            Icon = itemView.findViewById(R.id.imageView);<br>            Name = itemView.findViewById(R.id.textView2);<br>            Message = itemView.findViewById(R.id.textView3);<br><br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¼¼é‚£ä¹ˆå¤šæ–¹æ³•ï¼Œä½†åšçš„äº‹æƒ…å¹¶æ²¡æœ‰å˜ï¼šé€šè¿‡inflateæ–¹æ³•è·å–viewï¼Œåˆ›å»ºViewHolderå¯¹è±¡ï¼Œé€šè¿‡findViewByIdæ–¹æ³•è·å–itemä¸­çš„ç»„ä»¶ï¼Œé€šè¿‡setxxxæ–¹æ³•è®¾ç½®æ•°æ®ã€‚åªä¸è¿‡æ˜¯å°†è¿™äº›å·¥ä½œç»†åŒ–ä¸ºå¤šä¸ªæ–¹æ³•äº†ã€‚</p><p>MainActivity.javaå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span>&#123;<br><br>    <span class="hljs-keyword">private</span> ArrayList&lt;Person&gt; PersonArrayList;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-comment">//éšä¾¿é€ ç‚¹æ•°æ®</span><br>......<br><br>        <span class="hljs-comment">//æ‰¾åˆ°ListView</span><br>        <span class="hljs-type">RecyclerView</span> <span class="hljs-variable">recyclerView</span> <span class="hljs-operator">=</span> findViewById(R.id.rv);<br>        <span class="hljs-comment">//åˆ›å»ºAdapter</span><br>        <span class="hljs-type">PersonAdapter</span> <span class="hljs-variable">personAdapter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersonAdapter</span>(PersonArrayList, <span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">//éœ€è¦é…åˆAdapteræ‰èƒ½å°†æ•°æ®æ”¾å…¥</span><br>        recyclerView.setAdapter(personAdapter);<br>        <span class="hljs-comment">//é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦ç»™recyclerViewå¸ƒå±€ã€‚ListViewé»˜è®¤å‚ç›´å¸ƒå±€ï¼Œè€ŒrecyclerViewå°†å¸ƒå±€æŠ½ç¦»å‡ºæ¥ï¼Œä½¿å¾—å¸ƒå±€æ›´åŠ çµæ´»</span><br>        recyclerView.setLayoutManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayoutManager</span>(<span class="hljs-built_in">this</span>));<span class="hljs-comment">//ç¤ºä¾‹ä½¿ç”¨çº¿æ€§å¸ƒå±€ç®¡ç†å™¨</span><br>        <span class="hljs-comment">//recyclerView.setLayoutManager(new GridLayoutManager(this,3));//ç¤ºä¾‹ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ç®¡ç†å™¨</span><br>        <span class="hljs-comment">//recyclerView.setLayoutManager(new StaggeredGridLayoutManager(3,LinearLayout.HORIZONTAL));//ç¤ºä¾‹ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ç®¡ç†å™¨</span><br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸ŠåŸºæœ¬å°±å®ç°äº†RecyclerViewã€‚</p><p>ç„¶åå†ç»™itemæ¥ä¸ªç‚¹å‡»äº‹ä»¶çš„ç›‘å¬å’Œå¤„ç†ã€‚</p><p>è¿™éƒ¨åˆ†ä¸»è¦åœ¨PersonAdapter.javaä¸­é¢å¤–æ·»åŠ ä¸€ä¸‹æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å¤–éƒ¨è®¾ç½®çš„ç›‘å¬å¯¹è±¡</span><br><span class="hljs-keyword">private</span> OnRecyclerItemOnClickListener monRecyclerItemOnClickListener;<br><br><span class="hljs-comment">//itemçš„ç‚¹å‡»äº‹ä»¶å¤„ç†æ–¹æ³•çš„æ¥å£</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OnRecyclerItemOnClickListener</span>&#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRecyclerItemClick</span><span class="hljs-params">(<span class="hljs-type">int</span> postion)</span>;<br>&#125;<br><br><span class="hljs-comment">//å¤–éƒ¨è°ƒç”¨è¯¥æ–¹æ³•æ¥è®¾ç½®itemç›‘å¬</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRecyclerItemOnClickListener</span><span class="hljs-params">(OnRecyclerItemOnClickListener listener)</span>&#123;<br>    monRecyclerItemOnClickListener = listener;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶è¿˜éœ€è¦åœ¨ç»§æ‰¿äº†RecyclerView.ViewHolderç±»çš„ViewHolderç±»çš„ViewHolderæ–¹æ³•ä¸­ç»™itemè®¾ç½®ç›‘å¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è®¾ç½®ç›‘å¬</span><br>itemView.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-keyword">if</span> (monRecyclerItemOnClickListener != <span class="hljs-literal">null</span>)&#123;<br>            monRecyclerItemOnClickListener.onRecyclerItemClick(getAdapterPosition());<br>        &#125;<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>æœ€ååœ¨MainActivity.javaä¸­ç»™Adapteråˆ›å»ºç›‘å¬å¹¶å®ç°æ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">personAdapter.setRecyclerItemOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PersonAdapter</span>.OnRecyclerItemOnClickListener() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRecyclerItemClick</span><span class="hljs-params">(<span class="hljs-type">int</span> postion)</span> &#123;<br>        Log.d(<span class="hljs-string">&quot;leo&quot;</span>, <span class="hljs-string">&quot;ç‚¹å‡»äº†ç¬¬&quot;</span>+postion+<span class="hljs-string">&quot;ä¸ªitem&quot;</span>);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>å’‹ä¸€çœ‹ï¼Œæ€ä¹ˆè®¾ç½®äº†ä¸¤æ¬¡ç›‘å¬ï¼Ÿå…¶å®åœ¨MainActivity.javaçš„è°ƒç”¨çš„setRecyclerItemOnClickListeneræ–¹æ³•å®é™…ä¸Šæ˜¯ä¸ºäº†ç»™å¤–éƒ¨æä¾›ä¸€ä¸ªæ¥å£ï¼Œè®©å¤–éƒ¨æœ‰æœºä¼šè®¾ç½®è‡ªå·±çš„ç›‘å¬å™¨monRecyclerItemOnClickListeneræ¥å¤„ç†itemçš„ç‚¹å‡»äº‹ä»¶ã€‚ï¼ˆå¹¶ä¸æ˜¯ç»§æ‰¿View.OnClickListeneré‡å†™onClickæ–¹æ³•ï¼‰</p><p>è€Œç»™itemè®¾ç½®çš„ç›‘å¬ï¼Œæ‰ä¼šåœ¨æˆ‘ä»¬ç‚¹å‡»é¡µé¢ä¸­çš„åˆ—è¡¨é¡¹æ—¶è§¦å‘ã€‚</p><p>ï¼ˆå¯ä»¥å°è¯•ç†è§£ä¸ºitemåœ¨é¡µé¢ä¸­æœ‰å¯¹åº”æ§ä»¶ï¼Œæ˜¯å¯ä»¥ç‚¹å‡»åˆ°çš„ï¼Œè€ŒAdapteråœ¨é¡µé¢ä¸­å¹¶ä¸æ²¡æœ‰ã€‚å½“ç„¶è¿™æ ·ç†è§£å¹¶ä¸æ˜¯å¾ˆæ­£ç¡®ï¼‰</p><p>ï¼ˆä¸å¦¨å¯ä»¥ç›´æ¥å°†OnRecyclerItemOnClickListeneræ¥å£å†™æˆæ–¹æ³•è¯•è¯•ï¼Œä½†ä¸€èˆ¬ä¸å°†å¤„ç†å‡½æ•°å†™æ­»ï¼‰</p><h2 id="2-14-ViewPager"><a href="#2-14-ViewPager" class="headerlink" title="2.14 ViewPager"></a>2.14 ViewPager</h2><p>ViewPageræ˜¯ä¸€ä¸ªé¡µé¢åˆ‡æ¢ç»„ä»¶ï¼Œå¸¸ç”¨äºåˆ›å»ºè½®æ’­å›¾ã€å›¾ç‰‡æµè§ˆã€å¯¼èˆªé¡µé¢ç­‰éœ€è¦å·¦å³æ»‘åŠ¨åˆ‡æ¢å†…å®¹çš„åœºæ™¯ã€‚ä½¿ç”¨<code>&lt;androidx.viewpager.widget.ViewPager&gt;</code>æˆ–è€…<code>&lt;androidx.viewpager2.widget.ViewPager2&gt;</code>æ ‡ç­¾ã€‚éœ€è¦PagerAdapteråˆ›å»ºAdapterå¯¹è±¡ä¸ViewPagerå¯¹è±¡ç»‘å®šã€‚</p><p>åœ¨å¼€å‘ä¸­ç»å¸¸ä¸Fragmentæ­é…ä½¿ç”¨ï¼Œå®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªä¸“é—¨ç”¨äºFragmentçš„Adapterï¼š<strong>FragmentPageAdapter</strong>å’Œ<strong>FragmentStatePagerAdapter</strong>ï¼š</p><ul><li><strong>FragmentPageAdapter</strong>ï¼šå’ŒPagerAdapterä¸€æ ·ï¼Œåªä¼šç¼“å­˜å½“å‰çš„Fragmentä»¥åŠå·¦è¾¹ä¸€ä¸ªï¼Œå³è¾¹ ä¸€ä¸ªï¼Œå³æ€»å…±ä¼šç¼“å­˜3ä¸ªFragmentã€‚</li><li><strong>FragmentStatePagerAdapter</strong>ï¼šå½“Fragmentå¯¹ç”¨æˆ·ä¸å¯è§æ—¶ï¼Œæ•´ä¸ªFragmentä¼šè¢«é”€æ¯ï¼Œ åªä¼šä¿å­˜Fragmentçš„çŠ¶æ€ã€‚è€Œåœ¨é¡µé¢éœ€è¦é‡æ–°æ˜¾ç¤ºçš„æ—¶å€™ï¼Œä¼šç”Ÿæˆæ–°çš„é¡µé¢ã€‚</li></ul><p>ï¼ˆä¸viewpager2æ­é…ä½¿ç”¨ï¼ï¼‰</p><h3 id="åŸºæœ¬æ–¹æ³•-1"><a href="#åŸºæœ¬æ–¹æ³•-1" class="headerlink" title="åŸºæœ¬æ–¹æ³•"></a>åŸºæœ¬æ–¹æ³•</h3><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>instantiateItem()</td><td>â‘ å°†ç»™å®šä½ç½®çš„viewæ·»åŠ åˆ°ViewGroup(å®¹å™¨)ä¸­,åˆ›å»ºå¹¶æ˜¾ç¤ºå‡ºæ¥ <br/>â‘¡è¿”å›ä¸€ä¸ªä»£è¡¨æ–°å¢é¡µé¢çš„Object(key),é€šå¸¸éƒ½æ˜¯ç›´æ¥è¿”å›viewæœ¬èº«å°±å¯ä»¥äº†,å½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„key,ä½†æ˜¯keyå’Œæ¯ä¸ªviewè¦ä¸€ä¸€å¯¹åº”çš„å…³ç³»</td></tr><tr><td>isViewFromObject()</td><td>åˆ¤æ–­instantiateItemå‡½æ•°æ‰€è¿”å›æ¥çš„Keyä¸ä¸€ä¸ªé¡µé¢è§†å›¾æ˜¯å¦æ˜¯ä»£è¡¨çš„åŒä¸€ä¸ªè§†å›¾(å³å®ƒä¿©æ˜¯å¦æ˜¯å¯¹åº”çš„ï¼Œå¯¹åº”çš„è¡¨ç¤ºåŒä¸€ä¸ªView),é€šå¸¸æˆ‘ä»¬ç›´æ¥å†™ return view &#x3D;&#x3D; object</td></tr><tr><td>destroyItem()</td><td>ä»ViewGroupå®¹å™¨ä¸­ç§»é™¤å¯¹åº”ä½ç½®çš„è§†å›¾å¯¹è±¡ï¼Œå³æ‘§æ¯å¯¹åº”é¡µé¢è§†å›¾</td></tr><tr><td>getPageTitle()</td><td>è·å–æŒ‡å®šä½ç½®é¡µé¢çš„æ ‡é¢˜</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-10"><a href="#æ¡ˆä¾‹-10" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>é¡µé¢åˆ‡æ¢ã€‚</p><p>å…ˆéšä¾¿åœ¨layoutæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸‰ä¸ªå¸ƒå±€ã€‚</p><p>ç„¶ååˆ›å»ºä¸€ä¸ªç»§æ‰¿PagerAdapterçš„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PagerAdapter</span> &#123;<br><br>    <span class="hljs-comment">//å­˜æ”¾è¦å±•ç¤ºçš„viewpage</span><br>    <span class="hljs-keyword">private</span> List&lt;View&gt; viewList;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewAdapter</span><span class="hljs-params">(List&lt;View&gt; viewList)</span> &#123;<br>        <span class="hljs-built_in">this</span>.viewList = viewList;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> viewList == <span class="hljs-literal">null</span>? <span class="hljs-number">0</span> : viewList.size();<br>    &#125;<br><br>    <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰é¡µé¢è§†å›¾</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isViewFromObject</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view, <span class="hljs-meta">@NonNull</span> Object object)</span> &#123;<br>        <span class="hljs-keyword">return</span> view == object;<br>    &#125;<br><br>    <span class="hljs-comment">//åˆ›å»ºé¡µé¢è§†å›¾</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">instantiateItem</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewGroup container, <span class="hljs-type">int</span> position)</span> &#123;<br>        container.addView(viewList.get(position), <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> viewList.get(position);<br>    &#125;<br><span class="hljs-comment">//æ‘§æ¯é¡µé¢è§†å›¾</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyItem</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewGroup container, <span class="hljs-type">int</span> position, <span class="hljs-meta">@NonNull</span> Object object)</span> &#123;<br>        container.removeView(viewList.get(position));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>MainActivity.javaå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-comment">//åˆ›å»ºè§£æå™¨</span><br>        <span class="hljs-type">LayoutInflater</span> <span class="hljs-variable">inflater</span> <span class="hljs-operator">=</span> getLayoutInflater().from(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">//è§£æviewpageé¡µé¢</span><br>        <span class="hljs-type">View</span> <span class="hljs-variable">vp1</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.viewpage1,<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">View</span> <span class="hljs-variable">vp2</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.viewpage2,<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">View</span> <span class="hljs-variable">vp3</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.viewpage3,<span class="hljs-literal">null</span>);<br><br>        List&lt;View&gt; viewList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        viewList.add(vp1);<br>        viewList.add(vp2);<br>        viewList.add(vp3);<br>        <span class="hljs-comment">//é€šè¿‡idæ‰¾ViewPager</span><br>        <span class="hljs-type">ViewPager</span> <span class="hljs-variable">viewPager</span> <span class="hljs-operator">=</span> findViewById(R.id.vp);<br>        <span class="hljs-comment">//åˆ›å»ºViewAdapter</span><br>        <span class="hljs-type">ViewAdapter</span> <span class="hljs-variable">viewAdapter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewAdapter</span>(viewList);<br>        <span class="hljs-comment">//ç»‘å®šViewAdapter</span><br>        viewPager.setAdapter(viewAdapter);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¸‰ã€å¸ƒå±€"><a href="#ä¸‰ã€å¸ƒå±€" class="headerlink" title="ä¸‰ã€å¸ƒå±€"></a>ä¸‰ã€å¸ƒå±€</h1><p>ä¹Ÿå°±æ˜¯æ”¾ç½®æ§ä»¶ã€å¸ƒå±€çš„å®¹å™¨ï¼Œå¯ä»¥å¤šå±‚åµŒå¥—ã€‚</p><p>å¸ƒå±€ä¸­çš„æ‰€æœ‰å…ƒç´ å‡ä½¿ç”¨ <code>View</code> å’Œ <code>ViewGroup</code> å¯¹è±¡çš„å±‚æ¬¡ç»“æ„è¿›è¡Œæ„å»ºã€‚<code>View</code> é€šå¸¸ç”¨äºç»˜åˆ¶ç”¨æˆ·<strong>å¯çœ‹åˆ°å¹¶ä¸ä¹‹äº¤äº’</strong>çš„å†…å®¹ã€‚<code>ViewGroup</code> åˆ™æ˜¯<strong>ä¸å¯è§</strong>çš„å®¹å™¨ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131930446.jpg"></p><p><code>View</code> å¯¹è±¡é€šå¸¸ç§°ä¸ºâ€œå¾®ä»¶â€ï¼Œå¯ä»¥æ˜¯å¤šä¸ªå­ç±»ä¹‹ä¸€ï¼Œä¾‹å¦‚ <code>Button</code> æˆ– <code>TextView</code>ã€‚<code>ViewGroup</code> å¯¹è±¡é€šå¸¸ç§°ä¸ºâ€œå¸ƒå±€â€ï¼Œå¯ä»¥æ˜¯æä¾›ä¸åŒå¸ƒå±€ç»“æ„çš„ä¼—å¤šç±»å‹ä¹‹ä¸€ï¼Œä¾‹å¦‚ <code>LinearLayout</code> æˆ– <code>ConstraintLayout</code>ã€‚</p><h2 id="3-1-LinearLayout"><a href="#3-1-LinearLayout" class="headerlink" title="3.1 LinearLayout"></a>3.1 LinearLayout</h2><p>çº¿æ€§å¸ƒå±€</p><h3 id="åŸºæœ¬å±æ€§-9"><a href="#åŸºæœ¬å±æ€§-9" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>orientation</td><td>å¸ƒå±€ä¸­ç»„ä»¶çš„æ’åˆ—æ–¹å¼ï¼Œå¦‚horizontal(æ°´å¹³æ‘†æ”¾)ã€vertical(å‚ç›´æ‹œè®¿ï¼Œå³ä¸€ä¸ªæ§ä»¶å ä¸€æ•´è¡Œ)</td></tr><tr><td>gravity</td><td>æ§åˆ¶ç»„ä»¶æˆ–å¸ƒå±€æ‰€åŒ…å«çš„å­å…ƒç´ çš„å¯¹é½æ–¹å¼ï¼Œå¯ä»¥å¤šä¸ªç»„åˆï¼Œä»¥ | åˆ†éš”ï¼Œå¦‚ bottom|leftè¡¨ç¤ºä½ç½®åœ¨å·¦ä¸‹æ–¹</td></tr><tr><td>layout_gravity</td><td>æ§åˆ¶å½“å‰ç»„ä»¶åœ¨çˆ¶å®¹å™¨çš„å¯¹é½æ–¹å¼</td></tr><tr><td>background</td><td>ä¸ºå½“å‰ç»„ä»¶è®¾ç½®èƒŒæ™¯ï¼ˆå›¾ç‰‡ã€é¢œè‰²ï¼‰</td></tr><tr><td>divider</td><td>åˆ†å‰²çº¿ã€‚ä¸showDividersæ­é…ä½¿ç”¨</td></tr><tr><td>showDividers</td><td>è®¾ç½®åˆ†å‰²çº¿æ‰€åœ¨çš„ä½ç½®ï¼Œå¦‚none(æ— )ã€beginning(å¼€å§‹)ã€end(ç»“æŸ)ã€middle(æ¯ä¸¤ä¸ªç»„ä»¶é—´)</td></tr><tr><td>dividerPadding</td><td>è®¾ç½®åˆ†éš”çº¿ä¸å·¦å³ä¸¤è¾¹çš„é—´è·</td></tr><tr><td>layout_weight</td><td>ç­‰æ¯”ä¾‹åˆ’åˆ†å‰©ä½™åŒºåŸŸ</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-11"><a href="#æ¡ˆä¾‹-11" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@drawable/wallhaven&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:divider</span>=<span class="hljs-string">&quot;@drawable/baseline_password_24&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:showDividers</span>=<span class="hljs-string">&quot;middle&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:dividerPadding</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;300dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;LinearLayoutåµŒå¥—LinearLayout&quot;</span></span><br><span class="hljs-tag">            /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;è¯·é€‰æ‹©ä½ å–œæ¬¢åƒçš„æ°´æœ:&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;left&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24dp&quot;</span>/&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">RadioButton</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/apple&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;è‹¹æœ&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;right&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">RadioButton</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/banana&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;é¦™è•‰&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24dp&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">RadioButton</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/pear&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;æ¢¨&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24dp&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">RadioButton</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/Cantaloupe&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å“ˆå¯†ç“œ&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24dp&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btnpost&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;50dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;æäº¤&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">&quot;postByclick&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-2-RelativeLayout"><a href="#3-2-RelativeLayout" class="headerlink" title="3.2 RelativeLayout"></a>3.2 RelativeLayout</h2><p>ç›¸å¯¹å¸ƒå±€ã€‚</p><h3 id="åŸºæœ¬å±æ€§-10"><a href="#åŸºæœ¬å±æ€§-10" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th align="left">å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td align="left">gravity</td><td>æ§åˆ¶ç»„ä»¶æˆ–å¸ƒå±€æ‰€åŒ…å«çš„å­å…ƒç´ çš„å¯¹é½æ–¹å¼</td></tr><tr><td align="left">ignoreGravity</td><td>è®¾ç½®ä¸ºtrueå°†ä¸å—gravityå±æ€§çš„å½±å“</td></tr><tr><td align="left">layout_alignParentXXXX(Left, Rightç­‰)</td><td>æ ¹æ®çˆ¶å®¹å™¨å®šä½ã€‚å·¦(å³)å¯¹é½</td></tr><tr><td align="left">layout_centerXXXX(Horizontal, Vertical, InParent)</td><td>æ ¹æ®çˆ¶å®¹å™¨å®šä½ã€‚æ°´å¹³å±…ä¸­ï¼Œå‚ç›´å±…ä¸­ï¼Œä¸­é—´ä½ç½®</td></tr><tr><td align="left">layout_XXX(toLeftOf, toRightOf, above, below, alignTop, alignBottom, alignLeft, alignRight)</td><td>æ ¹æ®å…„å¼Ÿç»„ä»¶å®šä½ã€‚æ ¹æ®idæ¥è®¾ç½®ã€‚å…¶ä¸­toLeftOf, toRightOf, above, belowæ˜¯å‚è€ƒç»„ä»¶çš„å·¦ã€å³ã€ä¸Šã€ä¸‹è¾¹ï¼Œè€ŒalignTop, alignBottom, alignLeft, alignRightåˆ™æ˜¯<strong>å¯¹é½</strong>å‚è€ƒç»„ä»¶çš„ä¸Šã€ä¸‹ã€å·¦ã€å³è¾¹ç•Œã€‚</td></tr><tr><td align="left">layout_XXX(margin, marginLeft, marginRight, marginTop, marginBottom)</td><td>è®¾ç½®ç»„ä»¶ä¸çˆ¶å®¹å™¨çš„è¾¹è·ï¼ˆåç§»ï¼‰</td></tr><tr><td align="left">padding, paddingXXX(Left, Right, Top, Bottom)</td><td>è®¾ç½®ç»„ä»¶å†…éƒ¨å…ƒç´ é—´çš„è¾¹è·</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-12"><a href="#æ¡ˆä¾‹-12" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>å®ç°æ¢…èŠ±å¸ƒå±€ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">RelativeLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btn_center&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_centerInParent</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btn_left&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_centerVertical</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_toLeftOf</span>=<span class="hljs-string">&quot;@id/btn_center&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btn_right&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_centerVertical</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_toRightOf</span>=<span class="hljs-string">&quot;@id/btn_center&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btn_top&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_centerHorizontal</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_above</span>=<span class="hljs-string">&quot;@id/btn_center&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/btn_bottom&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_below</span>=<span class="hljs-string">&quot;@id/btn_center&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_centerInParent</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">RelativeLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-3-FrameLayout"><a href="#3-3-FrameLayout" class="headerlink" title="3.3 FrameLayout"></a>3.3 FrameLayout</h2><p>å¸§å¸ƒå±€ã€‚ä»çˆ¶å®¹å™¨å·¦ä¸Šè§’å¼€å§‹ç»˜åˆ¶ï¼ŒæŒ‰ç»„ä»¶æˆ–å¸ƒå±€çš„å®šä¹‰é¡ºåºä¾æ¬¡ç»˜åˆ¶ï¼Œé€ æˆè¦†ç›–æ•ˆæœã€‚</p><h3 id="åŸºæœ¬å±æ€§-11"><a href="#åŸºæœ¬å±æ€§-11" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>foreground</td><td>è®¾ç½®å‰æ™¯å›¾åƒ</td></tr><tr><td>foregroundGravity</td><td>è®¾ç½®å‰æ™¯å›¾åƒæ˜¾ç¤ºçš„ä½ç½®</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-13"><a href="#æ¡ˆä¾‹-13" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;400dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;400dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#FFFF0000&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;300dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;300dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#FF00FF00&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;200dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;200dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#FF0000FF&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;100dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#FFFFFF00&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:foreground</span>=<span class="hljs-string">&quot;@drawable/baseline_airplanemode_active_24&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:foregroundGravity</span>=<span class="hljs-string">&quot;center&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">FrameLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-4-TableLayout"><a href="#3-4-TableLayout" class="headerlink" title="3.4 TableLayout"></a>3.4 TableLayout</h2><p>è¡¨æ ¼å¸ƒå±€ã€‚</p><p>&lt;<code>TableLayout&gt;</code>è¡¨æ ¼æ ‡ç­¾ï¼Œå†…åµŒ<code>&lt;TableRow&gt;</code>è¡¨è¡Œæ ‡ç­¾</p><h3 id="åŸºæœ¬å±æ€§-12"><a href="#åŸºæœ¬å±æ€§-12" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>collapseColumns</td><td>è®¾ç½®éœ€è¦è¢«éšè—çš„åˆ—çš„åºå·ï¼Œåºå·ä»0å¼€å§‹ã€‚å¯ä»¥è®¾ç½®å¤šä¸ª,ç”¨é€—å·éš”å¼€ï¼Œæ¯”å¦‚â€0,2â€ï¼Œå¦‚æœæ˜¯æ‰€æœ‰åˆ—éƒ½ç”Ÿæ•ˆï¼Œåˆ™ç”¨â€*â€œå·å³å¯</td></tr><tr><td>stretchColumns</td><td>è®¾ç½®å…è®¸è¢«æ‹‰ä¼¸çš„åˆ—çš„åˆ—åºå·ï¼Œåºå·ä»0å¼€å§‹ã€‚è®¾ç½®åŒä¸Šã€‚åªè¦å­˜åœ¨ä¸€è¡Œæ˜¯æ»¡çš„ï¼Œè®¾ç½®å°±å¯¹æ‰€æœ‰è¡Œæ— æ•ˆã€‚<strong>æ— æ³•æ§åˆ¶è¢«æ‹‰ä¼¸çš„æ§ä»¶çš„é•¿åº¦</strong></td></tr><tr><td>shrinkColumns</td><td>è®¾ç½®å…è®¸è¢«æ”¶ç¼©çš„åˆ—çš„åˆ—åºå·ï¼Œåºå·ä»0å¼€å§‹ã€‚è®¾ç½®åŒä¸Šã€‚åªè¦å­˜åœ¨ä¸€è¡Œæœ‰ç©ºéš™ï¼Œè®¾ç½®å°±å¯¹æ‰€æœ‰è¡Œæ— æ•ˆã€‚<strong>æ— æ³•æ§åˆ¶è¢«æ”¶ç¼©çš„æ§ä»¶çš„é•¿åº¦</strong></td></tr><tr><td>layout_column</td><td>è®¾ç½®<strong>å­æ§ä»¶</strong>æ˜¾ç¤ºåœ¨ç¬¬å‡ åˆ—</td></tr><tr><td>layout_span</td><td>è®¾ç½®<strong>å­æ§ä»¶</strong>æ¨ªå‘è·¨å‡ åˆ—</td></tr></tbody></table><h2 id="3-5-GridLayout"><a href="#3-5-GridLayout" class="headerlink" title="3.5 GridLayout"></a>3.5 GridLayout</h2><p>ç½‘æ ¼å¸ƒå±€ã€‚</p><p>ä¸TableLayoutæœ‰ç‚¹ç±»ä¼¼ï¼Œä½†æ¯”å®ƒæ›´å¥½ç”¨ï¼ŒåŠŸèƒ½ï¼ˆå±æ€§ï¼‰æ›´å¤šã€‚</p><h3 id="åŸºæœ¬å±æ€§-13"><a href="#åŸºæœ¬å±æ€§-13" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>orientation</td><td>è®¾ç½®æ°´å¹³æ˜¾ç¤ºè¿˜æ˜¯å‚ç›´æ˜¾ç¤º</td></tr><tr><td>columnCount</td><td>è®¾ç½®è¡Œçš„æ˜¾ç¤ºä¸ªæ•°ã€‚</td></tr><tr><td>rowCount</td><td>è®¾ç½®åˆ—çš„æ˜¾ç¤ºä¸ªæ•°ã€‚</td></tr><tr><td>layout_row, layout_column</td><td>è®¾ç½®<strong>å­æ§ä»¶</strong>æ˜¾ç¤ºåœ¨ç¬¬å‡ è¡Œç¬¬å‡ åˆ—ã€‚ä»0å¼€å§‹ï¼Œå¯ä»¥è¦†ç›–ã€‚<u>åé¢æ²¡æœ‰å®šä¹‰è¡Œåˆ—çš„æ§ä»¶ä¼šè·Ÿéšå½“å‰æ§ä»¶ç§»åŠ¨</u>ã€‚</td></tr><tr><td>layout_rowSpan, layout_columnSpan</td><td>è®¾ç½®<strong>å­æ§ä»¶</strong>æ¨ªè·¨å‡ è¡Œå‡ åˆ—ã€‚<strong>éœ€è¦è®¾ç½®android:layout_gravity &#x3D; â€œfillâ€æ‰èƒ½ç”Ÿæ•ˆ</strong></td></tr><tr><td>layout_gravity</td><td>è®¾ç½®<strong>å­æ§ä»¶</strong>åœ¨ç½‘æ ¼ä¸­çš„æ˜¾ç¤ºä½ç½®ï¼Œå¦‚left, rightç­‰</td></tr><tr><td>layout_columnWeight, layout_rowWeight</td><td>è®¾ç½®<strong>å­æ§ä»¶</strong>çš„æ¨ªå‘ï¼ˆæˆ–çºµå‘ï¼‰å‰©ä½™ç©ºé—´çš„åˆ†é…æƒé‡ã€‚ä¸LinearLayoutå¸ƒå±€çš„å±æ€§layout_weightç›¸åŒ</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-14"><a href="#æ¡ˆä¾‹-14" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>å®ç°è®¡ç®—å™¨å¸ƒå±€ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">GridLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;horizontal&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:columnCount</span>=<span class="hljs-string">&quot;4&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:rowCount</span>=<span class="hljs-string">&quot;7&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;9+1&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;24sp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#fecccb&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_margin</span>=<span class="hljs-string">&quot;5dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;fill&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_columnSpan</span>=<span class="hljs-string">&quot;4&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å›é€€&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_columnSpan</span>=<span class="hljs-string">&quot;2&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;fill&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;å½’é›¶&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_columnSpan</span>=<span class="hljs-string">&quot;2&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;fill&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;7&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;8&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;9&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;+&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;4&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;5&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;6&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;-&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;1&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;2&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;3&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;*&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;.&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;=&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">android.widget.Button</span> <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;/&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">GridLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-6-ConstraintLayout"><a href="#3-6-ConstraintLayout" class="headerlink" title="3.6 ConstraintLayout"></a>3.6 ConstraintLayout</h2><p>çº¦æŸå¸ƒå±€ã€‚</p><p><code>&lt;androidx.constraintlayout.widget.ConstraintLayout&gt;</code>æ ‡ç­¾ã€‚</p><p>å¯ä»¥åœ¨Designæ¨¡å¼ä¸‹ï¼Œæ‹–åŠ¨æ§ä»¶è¿›è¡Œå¸ƒå±€ï¼Œæ›´åŠ æ–¹ä¾¿ï¼Œ<strong>è¿›è¡Œå¯è§†åŒ–å¸ƒå±€</strong>ï¼ŒInfer ConstraintsåŠŸèƒ½å¯ä»¥ç›´æ¥å¸®ä½ è®¾ç½®å¥½çº¦æŸï¼ˆæ¯”å¦‚è·ç¦»æ§ä»¶æˆ–çˆ¶å®¹å™¨çš„å„ç§è®¾ç½®ï¼‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨Attributeså¤„è¿›è¡Œæ›´è¯¦ç»†çš„è®¾ç½®ã€‚</p><h1 id="å››ã€åŠ¨ç”»"><a href="#å››ã€åŠ¨ç”»" class="headerlink" title="å››ã€åŠ¨ç”»"></a>å››ã€åŠ¨ç”»</h1><h2 id="4-1-é€å¸§åŠ¨ç”»"><a href="#4-1-é€å¸§åŠ¨ç”»" class="headerlink" title="4.1 é€å¸§åŠ¨ç”»"></a>4.1 é€å¸§åŠ¨ç”»</h2><p>æŠŠå¤šå¼ å›¾ç‰‡å¿«é€Ÿæ’­æ”¾å½¢æˆçš„åŠ¨ç”»ã€‚</p><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><p><code>&lt;animation-list&gt;</code>ä½œä¸ºå¤§æ ‡ç­¾ï¼Œå†…éƒ¨è®¾ç½®å¤šä¸ª<code>&lt;item&gt;</code>å°æ ‡ç­¾ï¼ˆå¯¹åº”å¤šå¼ å›¾ç‰‡ï¼‰ï¼Œ<code>&lt;item&gt;</code>æ ‡ç­¾è®¾ç½®å›¾ç‰‡èµ„æº(drawable)å’Œå›¾ç‰‡æ˜¾ç¤ºçš„æ—¶é—´(duration)ã€‚</p><h3 id="åŸºæœ¬å±æ€§-14"><a href="#åŸºæœ¬å±æ€§-14" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>drawable</td><td>å›¾ç‰‡èµ„æº</td></tr><tr><td>duration</td><td>å›¾ç‰‡æ˜¾ç¤ºçš„æ—¶é—´ï¼Œå•ä½ä¸ºmsã€‚æ¯å¼ å›¾ç‰‡æ˜¾ç¤ºçš„æ—¶é—´å¯ä»¥å•ç‹¬è®¾ç½®</td></tr></tbody></table><h3 id="åŸºæœ¬æ–¹æ³•-2"><a href="#åŸºæœ¬æ–¹æ³•-2" class="headerlink" title="åŸºæœ¬æ–¹æ³•"></a>åŸºæœ¬æ–¹æ³•</h3><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>start()</td><td>æ’­æ”¾åŠ¨ç”»</td></tr><tr><td>stop()</td><td>åœæ­¢åŠ¨ç”»</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-15"><a href="#æ¡ˆä¾‹-15" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>åŠ¨ç”»xmlå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">animation-list</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">&quot;@drawable/baseline_airplanemode_active_24&quot;</span> <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;120&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">&quot;@drawable/baseline_airplanemode_inactive_24&quot;</span> <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;120&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">&quot;@drawable/wallhaven&quot;</span> <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;120&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">animation-list</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨activity_main.xmlä¸­å¼•ç”¨ã€‚</p><p>ä½†æ˜¯å¹¶ä¸ä¼šæ’­æ”¾ï¼Œéœ€è¦é€šè¿‡è°ƒç”¨start()æ–¹æ³•æ¥æ’­æ”¾åŠ¨ç”»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-type">LinearLayout</span> <span class="hljs-variable">linearlayout</span> <span class="hljs-operator">=</span> findViewById(R.id.ll);<br>        <span class="hljs-type">AnimationDrawable</span> <span class="hljs-variable">animation</span> <span class="hljs-operator">=</span> (AnimationDrawable)linearlayout.getBackground();<br>        animation.start();<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-2-è¡¥é—´åŠ¨ç”»"><a href="#4-2-è¡¥é—´åŠ¨ç”»" class="headerlink" title="4.2 è¡¥é—´åŠ¨ç”»"></a>4.2 è¡¥é—´åŠ¨ç”»</h2><p>åœ¨æŒ‡å®šçš„æ—¶é—´æ®µå†…ï¼Œé€šè¿‡ä¸æ–­åœ°æ”¹å˜è§†å›¾çš„å±æ€§å€¼ï¼ˆå¦‚ä½ç½®ã€å°ºå¯¸ã€æ—‹è½¬è§’åº¦ã€é€æ˜åº¦ç­‰ï¼‰ï¼Œæ¥å®ç°è§†å›¾çš„å¹³æ»‘åŠ¨ç”»æ•ˆæœã€‚</p><p>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹çš„è¡¥é—´åŠ¨ç”»ï¼š</p><ol><li>ä½ç§»åŠ¨ç”»ï¼ˆTranslate Animationï¼‰ï¼šé€šè¿‡æ”¹å˜è§†å›¾çš„ä½ç½®å®ç°ç§»åŠ¨æ•ˆæœã€‚</li><li>ç¼©æ”¾åŠ¨ç”»ï¼ˆScale Animationï¼‰ï¼šé€šè¿‡æ”¹å˜è§†å›¾çš„å°ºå¯¸å®ç°ç¼©æ”¾æ•ˆæœã€‚</li><li>æ—‹è½¬åŠ¨ç”»ï¼ˆRotate Animationï¼‰ï¼šé€šè¿‡æ”¹å˜è§†å›¾çš„æ—‹è½¬è§’åº¦å®ç°æ—‹è½¬æ•ˆæœã€‚</li><li>é€æ˜åº¦åŠ¨ç”»ï¼ˆAlpha Animationï¼‰ï¼šé€šè¿‡æ”¹å˜è§†å›¾çš„é€æ˜åº¦å®ç°æ·¡å…¥æ·¡å‡ºæ•ˆæœã€‚</li></ol><h3 id="åŸºæœ¬å±æ€§-15"><a href="#åŸºæœ¬å±æ€§-15" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><h4 id="ä½ç§»åŠ¨ç”»"><a href="#ä½ç§»åŠ¨ç”»" class="headerlink" title="ä½ç§»åŠ¨ç”»"></a>ä½ç§»åŠ¨ç”»</h4><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>fromXDelta, fromYDelta</td><td>èµ·å§‹Xã€Yè½´ä½ç½®çš„åç§»é‡</td></tr><tr><td>toXDelta, toYDelta</td><td>ç»“æŸXã€Yè½´ä½ç½®çš„åç§»é‡</td></tr><tr><td>duration</td><td>åŠ¨ç”»æ—¶é•¿</td></tr></tbody></table><h4 id="ç¼©æ”¾åŠ¨ç”»"><a href="#ç¼©æ”¾åŠ¨ç”»" class="headerlink" title="ç¼©æ”¾åŠ¨ç”»"></a>ç¼©æ”¾åŠ¨ç”»</h4><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>fromXScale, fromYScale</td><td>èµ·å§‹Xã€Yè½´ä¸Šçš„ç¼©æ”¾æ¯”ä¾‹</td></tr><tr><td>toXScale, toYScale</td><td>ç»“æŸXã€Yè½´ä¸Šçš„ç¼©æ”¾æ¯”ä¾‹</td></tr><tr><td>pivotX, pivotY</td><td>ç¼©æ”¾ä¸­å¿ƒç‚¹çš„Xã€Yè½´åæ ‡ï¼ˆè¢«ç¼©æ”¾çš„æ§ä»¶çš„å·¦ä¸Šè§’ä¸º0%ï¼Œä¸­å¿ƒä¸º50%ï¼‰</td></tr><tr><td>duration</td><td>åŠ¨ç”»æ—¶é•¿</td></tr></tbody></table><h4 id="æ—‹è½¬åŠ¨ç”»"><a href="#æ—‹è½¬åŠ¨ç”»" class="headerlink" title="æ—‹è½¬åŠ¨ç”»"></a>æ—‹è½¬åŠ¨ç”»</h4><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>fromDegrees</td><td>èµ·å§‹è§’åº¦ï¼ˆ0~360ï¼‰</td></tr><tr><td>toDegrees</td><td>ç»“æŸè§’åº¦</td></tr><tr><td>pivotX, pivotY</td><td>æ—‹è½¬ä¸­å¿ƒç‚¹çš„Xã€Yè½´åæ ‡</td></tr><tr><td>duration</td><td>åŠ¨ç”»æ—¶é•¿</td></tr></tbody></table><h4 id="é€æ˜åº¦åŠ¨ç”»"><a href="#é€æ˜åº¦åŠ¨ç”»" class="headerlink" title="é€æ˜åº¦åŠ¨ç”»"></a>é€æ˜åº¦åŠ¨ç”»</h4><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>fromAlpha</td><td>èµ·å§‹é€æ˜åº¦ï¼ˆ0.0è¡¨ç¤ºå®Œå…¨é€æ˜ï¼Œ1.0è¡¨ç¤ºå®Œå…¨ä¸é€æ˜ï¼‰</td></tr><tr><td>toAlpha</td><td>ç»“æŸé€æ˜åº¦</td></tr><tr><td>duration</td><td>åŠ¨ç”»æ—¶é•¿</td></tr></tbody></table><h3 id="åŸºæœ¬æ–¹æ³•-3"><a href="#åŸºæœ¬æ–¹æ³•-3" class="headerlink" title="åŸºæœ¬æ–¹æ³•"></a>åŸºæœ¬æ–¹æ³•</h3><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>start()</td><td>å¼€å§‹æ‰§è¡ŒåŠ¨ç”»</td></tr><tr><td>setRepeatMode(int repeatMode)</td><td>è®¾ç½®åŠ¨ç”»çš„é‡å¤æ¨¡å¼</td></tr><tr><td>setRepeatCount(int repeatCount)</td><td>è®¾ç½®åŠ¨ç”»çš„é‡å¤æ¬¡æ•°</td></tr><tr><td>setFillEnabled(boolean fillEnabled)</td><td>è®¾ç½®æ˜¯å¦ä¿æŒåŠ¨ç”»ç»“æŸæ—¶çš„çŠ¶æ€</td></tr><tr><td>setDuration(int duration)</td><td>è®¾ç½®åŠ¨ç”»çš„æŒç»­æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’</td></tr><tr><td>setInterpolator(Interpolator interpolator)</td><td>è®¾ç½®åŠ¨ç”»çš„æ’å€¼å™¨</td></tr></tbody></table><h3 id="æ¡ˆä¾‹-16"><a href="#æ¡ˆä¾‹-16" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>åŠ¨ç”»xmlæ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">set</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">alpha</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:fromAlpha</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:toAlpha</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;2000&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rotate</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:fromDegrees</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:toDegrees</span>=<span class="hljs-string">&quot;360&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:pivotX</span>=<span class="hljs-string">&quot;50%&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:pivotY</span>=<span class="hljs-string">&quot;50%&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;2000&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scale</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:fromXScale</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:fromYScale</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:toXScale</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:toYScale</span>=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:pivotY</span>=<span class="hljs-string">&quot;50%&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:pivotX</span>=<span class="hljs-string">&quot;50%&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;2000&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">translate</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:fromXDelta</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:fromYDelta</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:toXDelta</span>=<span class="hljs-string">&quot;400&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:toYDelta</span>=<span class="hljs-string">&quot;400&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:duration</span>=<span class="hljs-string">&quot;2000&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åŠ è½½å¹¶å¯åŠ¨è¯¥åŠ¨ç”»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//é€šè¿‡idæ‰¾åˆ°ä½¿ç”¨åŠ¨ç”»çš„æ§ä»¶</span><br><span class="hljs-type">ImageView</span> <span class="hljs-variable">imageview</span> <span class="hljs-operator">=</span> findViewById(R.id.imageV);<br><span class="hljs-comment">//åŠ è½½åŠ¨ç”»çš„xmlæ–‡ä»¶</span><br><span class="hljs-type">Animation</span> <span class="hljs-variable">animation</span> <span class="hljs-operator">=</span> AnimationUtils.loadAnimation(<span class="hljs-built_in">this</span>, R.anim.bujian);<br><span class="hljs-comment">//é€šè¿‡ä½¿ç”¨è¯¥åŠ¨ç”»çš„æ§ä»¶æ¥å¯åŠ¨åŠ¨ç”»</span><br>imageview.startAnimation(animation);<br></code></pre></td></tr></table></figure><h2 id="4-3-å±æ€§åŠ¨ç”»"><a href="#4-3-å±æ€§åŠ¨ç”»" class="headerlink" title="4.3 å±æ€§åŠ¨ç”»"></a>4.3 å±æ€§åŠ¨ç”»</h2><p>å±æ€§åŠ¨ç”»ï¼ˆProperty Animationï¼‰æ˜¯ä¸€ç§å¯ä»¥æ”¹å˜<strong>ä»»æ„å¯¹è±¡</strong>çš„å±æ€§å€¼ï¼Œå¹¶å®ç°å¹³æ»‘åŠ¨ç”»æ•ˆæœçš„æœºåˆ¶ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡æ’å€¼å™¨å’Œä¼°å€¼å™¨æ¥è®¡ç®—ä¸­é—´å±æ€§å€¼çš„ã€‚æ’å€¼å™¨æ§åˆ¶åŠ¨ç”»çš„æ—¶é—´è¿›åº¦ï¼Œä¼°å€¼å™¨åˆ™æ ¹æ®æ—¶é—´è¿›åº¦è®¡ç®—å‡ºä¸­é—´çš„å±æ€§å€¼ã€‚</p><h3 id="åŸºæœ¬æ–¹æ³•-4"><a href="#åŸºæœ¬æ–¹æ³•-4" class="headerlink" title="åŸºæœ¬æ–¹æ³•"></a>åŸºæœ¬æ–¹æ³•</h3><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ObjectAnimator.ofXXX(target, propertyName, values, â€¦)</td><td>åˆ›å»ºä¸€ä¸ªé’ˆå¯¹æŒ‡å®šç›®æ ‡å¯¹è±¡ã€å±æ€§åå’Œèµ·å§‹å€¼&#x2F;ç»“æŸå€¼çš„å±æ€§åŠ¨ç”»</td></tr></tbody></table><p>å…¶ä»–æ–¹æ³•åŒè¡¥é—´åŠ¨ç”»çš„æ–¹æ³•ä¸€æ ·ã€‚</p><h3 id="æ¡ˆä¾‹-17"><a href="#æ¡ˆä¾‹-17" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>ä¸¤ç§æ–¹æ³•è®¾ç½®é€æ˜åº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>    setContentView(R.layout.activity_main);<br><br>    <span class="hljs-type">TextView</span> <span class="hljs-variable">textView</span> <span class="hljs-operator">=</span> findViewById(R.id.tv);<br><span class="hljs-comment">//æ–¹æ³•ä¸€</span><br>    <span class="hljs-type">ValueAnimator</span> <span class="hljs-variable">valueAnimator</span> <span class="hljs-operator">=</span> ValueAnimator.ofFloat(<span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>);<br>    valueAnimator.setDuration(<span class="hljs-number">4000</span>);<br>    <span class="hljs-comment">//æ·»åŠ åŠ¨ç”»æ•°å€¼æ›´æ–°ç›‘å¬å™¨</span><br>    valueAnimator.addUpdateListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueAnimator</span>.AnimatorUpdateListener() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationUpdate</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ValueAnimator valueAnimator)</span> &#123;<br>            <span class="hljs-type">float</span> <span class="hljs-variable">animatedValue</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>) valueAnimator.getAnimatedValue();<br>            Log.d(<span class="hljs-string">&quot;leo&quot;</span>, <span class="hljs-string">&quot;onAnimationUpdate: &quot;</span> + animatedValue);<br>            <span class="hljs-comment">//æ ¹æ®åŠ¨ç”»æ•°å€¼ä¿®æ”¹æ§ä»¶çš„é€æ˜åº¦</span><br>            textView.setAlpha(animatedValue);<br>        &#125;<br>    &#125;);<br>    valueAnimator.start();<br><span class="hljs-comment">//æ–¹æ³•äºŒ</span><br>    <span class="hljs-comment">//        ObjectAnimator alpha = ObjectAnimator.ofFloat(textView, &quot;alpha&quot;, 0f, 1f);</span><br>    <span class="hljs-comment">//        alpha.setDuration(4000);</span><br>    <span class="hljs-comment">//        alpha.start();</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå¼€å‘å­¦ä¹ ç¬”è®°(ä¸€) â€”â€” åˆ†æAndroidé¡¹ç›®ç»“æ„</title>
    <link href="/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%B8%80)%20%E2%80%94%E2%80%94%20%E5%88%86%E6%9E%90Android%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84/"/>
    <url>/2023/08/12/Android%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E4%B8%80)%20%E2%80%94%E2%80%94%20%E5%88%86%E6%9E%90Android%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€é¡¹ç›®ç»“æ„"><a href="#ä¸€ã€é¡¹ç›®ç»“æ„" class="headerlink" title="ä¸€ã€é¡¹ç›®ç»“æ„"></a>ä¸€ã€é¡¹ç›®ç»“æ„</h1><p>æˆ‘ä»¬åˆ›å»ºçš„é¡¹ç›®ï¼Œå®ƒçš„é¡¹ç›®ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131906853.jpg"></p><p>ä»»ä½•ä¸€ä¸ªæ–°å»ºçš„é¡¹ç›®éƒ½ä¼šé»˜è®¤ä½¿ç”¨Androidæ¨¡å¼çš„é¡¹ç›®ç»“æ„ï¼Œä½†è¿™å¹¶ä¸æ˜¯é¡¹ç›®çœŸå®çš„ç›®å½•ç»“æ„ï¼Œè€Œæ˜¯è¢«Android Studioè½¬æ¢è¿‡çš„ã€‚è¿™ç§é¡¹ç›®ç»“æ„ç®€æ´æ˜äº†ï¼Œé€‚åˆè¿›è¡Œå¿«é€Ÿå¼€å‘ï¼Œä½†æ˜¯å¯¹äºæ–°æ‰‹æ¥è¯´å¯èƒ½å¹¶ä¸æ˜“äºç†è§£ã€‚</p><p>ç‚¹å‡»ä¸Šå›¾ä¸­é¡¶éƒ¨çš„AndroidåŒºåŸŸå¯ä»¥åˆ‡æ¢é¡¹ç›®ç»“æ„æ¨¡å¼ï¼Œæˆ‘ä»¬å°†å…¶åˆ‡æ¢æˆProjectæ¨¡å¼ï¼Œè¿™ä¸ªå°±æ˜¯é¡¹ç›®çš„çœŸå®ç›®å½•ç»“æ„ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131906007.jpg"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¾æ¬¡åˆ†æç›®å½•ç»“æ„ä¸­çš„æ–‡ä»¶ã€‚</p><ol><li><p><code>.gradle</code> å’Œ <code>.idea</code><br>è¿™ä¸¤ä¸ªç›®å½•ä¸‹æ”¾ç½®çš„éƒ½æ˜¯Android Studioè‡ªåŠ¨ç”Ÿæˆçš„ä¸€äº›æ–‡ä»¶ï¼Œæˆ‘ä»¬æ— é¡»å…³å¿ƒï¼Œä¹Ÿä¸è¦å»æ‰‹åŠ¨ç¼–è¾‘ã€‚</p></li><li><p><code>app</code><br>é¡¹ç›®ä¸­çš„ä»£ç ã€èµ„æºç­‰å†…å®¹å‡ ä¹éƒ½æ˜¯æ”¾ç½®åœ¨è¿™ä¸ªç›®å½•ä¸‹çš„ï¼Œæˆ‘ä»¬åé¢çš„å¼€å‘å·¥ä½œä¹ŸåŸºæœ¬éƒ½æ˜¯åœ¨è¿™ä¸ªç›®å½•ä¸‹è¿›è¡Œçš„ã€‚è¿™ä¸ªç›®å½•åœ¨ä¸‹æ–‡ä¼šå•ç‹¬å±•å¼€è¿›è¡Œè®²è§£ã€‚</p></li><li><p><code>build</code><br>è¿™ä¸ªç›®å½•æˆ‘ä»¬ä¹Ÿä¸éœ€è¦è¿‡å¤šå…³å¿ƒï¼Œå®ƒä¸»è¦åŒ…å«äº†ä¸€äº›åœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚</p></li><li><p><code>gradle</code><br>è¿™ä¸ªç›®å½•ä¸‹åŒ…å«äº†gradle wrapperçš„é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨gradle wrapperçš„æ–¹å¼ä¸éœ€è¦æå‰å°†gradleä¸‹è½½å¥½ï¼Œè€Œæ˜¯ä¼šè‡ªåŠ¨æ ¹æ®æœ¬åœ°çš„ç¼“å­˜æƒ…å†µå†³å®šæ˜¯å¦éœ€è¦è”ç½‘ä¸‹è½½gradleã€‚Android Studioé»˜è®¤æ²¡æœ‰å¯ç”¨gradle wrapperçš„æ–¹å¼ï¼Œå¦‚æœéœ€è¦æ‰“å¼€ï¼Œå¯ä»¥ç‚¹å‡»Android Studioå¯¼èˆªæ â†’Fileâ†’Settings-â†’Build,Execution,.Deploymentâ†’Gradleï¼Œè¿›è¡Œé…ç½®æ›´æ”¹ã€‚</p></li><li><p><code>.gitignore</code></p><p>è¿™ä¸ªæ–‡ä»¶æ˜¯ç”¨æ¥å°†æŒ‡å®šçš„ç›®å½•æˆ–æ–‡ä»¶æ’é™¤åœ¨ç‰ˆæœ¬æ§åˆ¶ä¹‹å¤–çš„</p></li><li><p><code>build.gradle</code><br>è¿™æ˜¯é¡¹ç›®å…¨å±€çš„gradleæ„å»ºè„šæœ¬ï¼Œé€šå¸¸è¿™ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹æ˜¯ä¸éœ€è¦ä¿®æ”¹çš„ã€‚è¿™ä¸ªç›®å½•åœ¨ä¸‹æ–‡ä¼šå•ç‹¬å±•å¼€è¿›è¡Œè®²è§£ã€‚</p></li><li><p><code>gradle.properties</code><br>è¿™ä¸ªæ–‡ä»¶æ˜¯å…¨å±€çš„gradleé…ç½®æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œé…ç½®çš„å±æ€§å°†ä¼šå½±å“åˆ°é¡¹ç›®ä¸­æ‰€æœ‰çš„gradleç¼–è¯‘è„šæœ¬ã€‚</p></li><li><p><code>gradlew</code>å’Œ<code>gradlew.bat</code><br>è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯ç”¨æ¥åœ¨å‘½ä»¤è¡Œç•Œé¢ä¸­æ‰§è¡Œgradleå‘½ä»¤çš„ï¼Œå…¶ä¸­gradlewæ˜¯åœ¨Linuxæˆ–Macç³»ç»Ÿä¸­ä½¿ç”¨çš„ï¼Œgradlew.batæ˜¯åœ¨Windowsç³»ç»Ÿä¸­ä½¿ç”¨çš„ã€‚</p></li><li><p><code>HelloWorld.iml</code><br>imlæ–‡ä»¶æ˜¯æ‰€æœ‰IntelliJ IDEAé¡¹ç›®éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆçš„ä¸€ä¸ªæ–‡ä»¶ï¼ˆAndroid Studioæ˜¯åŸºäºIntelliJ IDEAå¼€å‘çš„)ï¼Œç”¨äºæ ‡è¯†è¿™æ˜¯ä¸€ä¸ªIntelliJ IDEAé¡¹ç›®ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ä¸­çš„ä»»ä½•å†…å®¹ã€‚</p></li><li><p><code>local.properties</code><br>  è¿™ä¸ªæ–‡ä»¶ç”¨äºæŒ‡å®šæœ¬æœºä¸­çš„Android SDKè·¯å¾„ï¼Œé€šå¸¸å†…å®¹éƒ½æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¿®æ”¹ã€‚é™¤éä½ æœ¬æœºä¸­çš„Android SDKä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆå°±å°†è¿™ä¸ªæ–‡ä»¶ä¸­çš„è·¯å¾„æ”¹æˆæ–°çš„ä½ç½®å³å¯ã€‚</p></li><li><p><code>settings.gradle</code></p></li></ol><p>   è¿™ä¸ªæ–‡ä»¶ç”¨äºæŒ‡å®šé¡¹ç›®ä¸­æ‰€æœ‰å¼•å…¥çš„æ¨¡å—ã€‚ç”±äºHelloWorldé¡¹ç›®ä¸­å°±åªæœ‰ä¸€ä¸ªappæ¨¡å—ï¼Œå› æ­¤è¯¥æ–‡ä»¶ä¸­ä¹Ÿå°±åªå¼•å…¥äº†appè¿™ä¸€ä¸ªæ¨¡å—ã€‚é€šå¸¸æƒ…å†µä¸‹æ¨¡å—çš„å¼•äººéƒ½æ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„åœºæ™¯å¯èƒ½æ¯”è¾ƒå°‘ã€‚</p><p>åˆæ­¥åˆ†ææ•´ä¸ªé¡¹ç›®çš„å¤–å±‚ç›®å½•ç»“æ„ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œé™¤äº†appç›®å½•ä¹‹å¤–ï¼Œå¤§å¤šæ•°çš„æ–‡ä»¶å’Œç›®å½•éƒ½æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚</p><h1 id="äºŒã€appç›®å½•"><a href="#äºŒã€appç›®å½•" class="headerlink" title="äºŒã€appç›®å½•"></a>äºŒã€appç›®å½•</h1><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131909224.jpg"></p><ol><li><code>build</code><br>  è¿™ä¸ªç›®å½•ä¸»è¦åŒ…å«äº†ä¸€äº›åœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œä¸è¿‡å®ƒé‡Œé¢çš„å†…å®¹ä¼šæ›´å¤šæ›´æ‚ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿‡å¤šå…³å¿ƒã€‚</li><li><code>libs</code><br>  å¦‚æœä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨åˆ°äº†ç¬¬ä¸‰æ–¹jaråŒ…ï¼Œå°±éœ€è¦æŠŠè¿™äº›jaråŒ…éƒ½æ”¾åœ¨libsç›®å½•ä¸‹ï¼Œæ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹çš„jaråŒ…éƒ½ä¼šè¢«è‡ªåŠ¨æ·»åŠ åˆ°æ„å»ºè·¯å¾„é‡Œå»ã€‚</li><li><code>androidTest</code><br>  æ­¤å¤„æ˜¯ç”¨æ¥ç¼–å†™Android Testæµ‹è¯•ç”¨ä¾‹çš„ï¼Œå¯ä»¥å¯¹é¡¹ç›®è¿›è¡Œä¸€äº›è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚</li><li><code>java</code><br>  javaç›®å½•æ˜¯æ”¾ç½®æˆ‘ä»¬æ‰€æœ‰Javaä»£ç çš„åœ°æ–¹ã€‚</li><li><code>res</code><br>  è¿™ä¸ªç›®å½•ä¸‹çš„å†…å®¹å°±æœ‰ç‚¹å¤šäº†ã€‚ç®€å•ç‚¹è¯´ï¼Œå°±æ˜¯ä½ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨åˆ°çš„æ‰€æœ‰å›¾ç‰‡ã€å¸ƒå±€ã€å­—ç¬¦ä¸²ç­‰èµ„æºéƒ½è¦å­˜æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚å½“ç„¶è¿™ä¸ªç›®å½•ä¸‹è¿˜æœ‰å¾ˆå¤šå­ç›®å½•ï¼Œå›¾ç‰‡æ”¾åœ¨drawableç›®å½•ä¸‹ï¼Œå¸ƒå±€æ”¾åœ¨layoutç›®å½•ä¸‹ï¼Œå­—ç¬¦ä¸²æ”¾åœ¨valuesç›®å½•ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒä¼šæŠŠæ•´ä¸ªresç›®å½•å¼„å¾—ä¹±ç³Ÿç³Ÿçš„ã€‚</li><li><code>AndroidManifest.xml</code><br>  è¿™æ˜¯ä½ æ•´ä¸ªAndroidé¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œä½ åœ¨ç¨‹åºä¸­å®šä¹‰çš„æ‰€æœ‰å››å¤§ç»„ä»¶éƒ½éœ€è¦åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œæ³¨å†Œï¼Œå¦å¤–è¿˜å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ç»™åº”ç”¨ç¨‹åºæ·»åŠ æƒé™å£°æ˜ã€‚</li><li><code>test</code><br>  æ­¤å¤„æ˜¯ç”¨æ¥ç¼–å†™UnitTestæµ‹è¯•ç”¨ä¾‹çš„ï¼Œæ˜¯å¯¹é¡¹ç›®è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•çš„å¦ä¸€ç§æ–¹å¼ã€‚</li><li><code>.gitignore</code><br>  è¿™ä¸ªæ–‡ä»¶ç”¨äºå°†appæ¨¡å—å†…çš„æŒ‡å®šçš„ç›®å½•æˆ–æ–‡ä»¶æ’é™¤åœ¨ç‰ˆæœ¬æ§åˆ¶ä¹‹å¤–ï¼Œä½œç”¨å’Œå¤–å±‚çš„.gitignoreæ–‡ä»¶ç±»ä¼¼ã€‚</li><li><code>build.gradle</code><br>  è¿™æ˜¯appæ¨¡å—çš„gradleæ„å»ºè„šæœ¬ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­ä¼šæŒ‡å®šå¾ˆå¤šé¡¹ç›®æ„å»ºç›¸å…³çš„é…ç½®ï¼Œæˆ‘ä»¬ç¨åå°†ä¼šè¯¦ç»†åˆ†ægradleæ„å»ºè„šæœ¬ä¸­çš„å…·ä½“å†…å®¹ã€‚</li><li><code>proguard-rules.pro</code><br>  è¿™ä¸ªæ–‡ä»¶ç”¨äºæŒ‡å®šé¡¹ç›®ä»£ç çš„æ··æ·†è§„åˆ™ï¼Œå½“ä»£ç å¼€å‘å®Œæˆåæ‰“æˆå®‰è£…åŒ…æ–‡ä»¶ï¼Œå¦‚æœä¸å¸Œæœ›ä»£ç è¢«åˆ«äººç ´è§£ï¼Œé€šå¸¸ä¼šå°†ä»£ç è¿›è¡Œæ··æ·†ï¼Œä»è€Œè®©ç ´è§£è€…éš¾ä»¥é˜…è¯»ã€‚</li></ol><h2 id="2-1-è¯¦è§£èµ„æºç›®å½•"><a href="#2-1-è¯¦è§£èµ„æºç›®å½•" class="headerlink" title="2.1 è¯¦è§£èµ„æºç›®å½•"></a>2.1 è¯¦è§£èµ„æºç›®å½•</h2><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202308131914566.jpg"></p><p>æ‰€æœ‰ä»¥drawableå¼€å¤´çš„æ–‡ä»¶å¤¹éƒ½æ˜¯ç”¨æ¥æ”¾å›¾ç‰‡çš„ï¼Œæ‰€æœ‰ä»¥mipmapå¼€å¤´çš„æ–‡ä»¶å¤¹éƒ½æ˜¯ç”¨æ¥æ”¾åº”ç”¨å›¾æ ‡çš„ï¼Œæ‰€æœ‰ä»¥valueså¼€å¤´çš„æ–‡ä»¶å¤¹éƒ½æ˜¯ç”¨æ¥æ”¾å­—ç¬¦ä¸²ã€æ ·å¼ã€é¢œè‰²ç­‰é…ç½®çš„ï¼Œlayoutæ–‡ä»¶å¤¹æ˜¯ç”¨æ¥æ”¾å¸ƒå±€æ–‡ä»¶çš„ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å¼€å¯ä»¥åˆ›å»ºcoloræ–‡ä»¶å¤¹å’Œanimæ–‡ä»¶å¤¹ï¼Œå‰è€…ç”¨äºå­˜æ”¾é¢œè‰²é€‰æ‹©å™¨ï¼ˆæ§ä»¶ä¸åŒçŠ¶æ€æ—¶æ˜¾ç¤ºä¸åŒé¢œè‰²ï¼‰ï¼Œåè€…ç”¨äºå­˜æ”¾åŠ¨ç”»èµ„æºã€‚</p><p>ä¹‹æ‰€ä»¥æœ‰è¿™ä¹ˆå¤šmipmapå¼€å¤´çš„æ–‡ä»¶å¤¹ï¼Œå…¶å®ä¸»è¦æ˜¯ä¸ºäº†è®©ç¨‹åºèƒ½å¤Ÿæ›´å¥½åœ°å…¼å®¹å„ç§è®¾å¤‡ï¼ˆè®¾å¤‡å±å¹•åŸå› ï¼Œå› æ­¤åˆ†è¾¨ç‡ä¸åŒï¼‰ã€‚drawableæ–‡ä»¶å¤¹ä¹Ÿæ˜¯ç›¸åŒçš„é“ç†ï¼Œè™½ç„¶Android Studioæ²¡æœ‰å¸®æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆï¼Œä½†æ˜¯æˆ‘ä»¬åº”è¯¥è‡ªå·±åˆ›å»ºdrawable-hdpiã€drawable-xhdpiã€drawableâ€“xxhdpiç­‰æ–‡ä»¶å¤¹ã€‚</p><h2 id="2-2-è¯¦è§£build-gradleæ–‡ä»¶"><a href="#2-2-è¯¦è§£build-gradleæ–‡ä»¶" class="headerlink" title="2.2 è¯¦è§£build.gradleæ–‡ä»¶"></a>2.2 è¯¦è§£build.gradleæ–‡ä»¶</h2><h3 id="2-2-1-æœ€å¤–å±‚ç›®å½•ä¸‹çš„build-gradleæ–‡ä»¶"><a href="#2-2-1-æœ€å¤–å±‚ç›®å½•ä¸‹çš„build-gradleæ–‡ä»¶" class="headerlink" title="2.2.1 æœ€å¤–å±‚ç›®å½•ä¸‹çš„build.gradleæ–‡ä»¶"></a>2.2.1 æœ€å¤–å±‚ç›®å½•ä¸‹çš„build.gradleæ–‡ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">plugins &#123;<br>    id <span class="hljs-string">&#x27;com.android.application&#x27;</span> version <span class="hljs-string">&#x27;8.0.2&#x27;</span> apply <span class="hljs-literal">false</span><br>    id <span class="hljs-string">&#x27;com.android.library&#x27;</span> version <span class="hljs-string">&#x27;8.0.2&#x27;</span> apply <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>plugins</code>å£°æ˜äº†ä¸¤ä¸ªæ’ä»¶ï¼š<code>com.android.application</code>ï¼ˆç”¨äºæ„å»º Android åº”ç”¨ç¨‹åºæ¨¡å—ï¼‰å’Œ<code>com.android.library</code>ï¼ˆç”¨äºæ„å»º Android åº“æ¨¡å—ï¼‰ï¼Œå®ƒä»¬çš„ç‰ˆæœ¬å·éƒ½æ˜¯<code>8.0.2</code>ï¼Œå¹¶ä¸”<code>apply false</code>è¡¨ç¤ºè¿™äº›æ’ä»¶ä¸ä¼šè‡ªåŠ¨åº”ç”¨åˆ°é¡¹ç›®ä¸­ã€‚</p><p>ï¼ˆåº”ç”¨ç¨‹åºæ¨¡å—å’Œåº“æ¨¡å—çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼Œå‰è€…æ˜¯å¯ä»¥ç›´æ¥è¿è¡Œçš„ï¼Œè€Œåè€…åªèƒ½ä½œä¸ºä»£ç åº“ä¾é™„äºåˆ«çš„åº”ç”¨ç¨‹åºæ¨¡å—æ¥è¿è¡Œã€‚ï¼‰</p><p>å¦‚æœéœ€è¦ä½¿ç”¨è¿™äº›æ’ä»¶ï¼Œå¯ä»¥åœ¨é¡¹ç›®çš„å…¶ä»–æ„å»ºè„šæœ¬ä¸­æ˜¾å¼åœ°åº”ç”¨å®ƒä»¬ã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸éœ€è¦ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œé™¤éæˆ‘ä»¬æƒ³æ·»åŠ ä¸€äº›å…¨å±€çš„é¡¹ç›®æ„å»ºé…ç½®ã€‚</p><h3 id="2-2-2-appç›®å½•ä¸‹çš„build-gradleæ–‡ä»¶"><a href="#2-2-2-appç›®å½•ä¸‹çš„build-gradleæ–‡ä»¶" class="headerlink" title="2.2.2 appç›®å½•ä¸‹çš„build.gradleæ–‡ä»¶"></a>2.2.2 appç›®å½•ä¸‹çš„build.gradleæ–‡ä»¶</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs awk">plugins &#123;<br><span class="hljs-regexp">//</span>æ„æ€åŒæœ€å¤–å±‚çš„build.gradleä¸€æ ·<br>    id <span class="hljs-string">&#x27;com.android.application&#x27;</span><br>&#125;<br><br>android &#123;<br><span class="hljs-regexp">//</span>æŒ‡å®šåº”ç”¨ç¨‹åºçš„å‘½åç©ºé—´ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºçš„åŒ…å<br>    namespace <span class="hljs-string">&#x27;com.example.forcelogout&#x27;</span><br>    <span class="hljs-regexp">//</span>SDKç¼–è¯‘ç‰ˆæœ¬ä¸º<span class="hljs-number">33</span>,æ ¹æ®è¿™ä¸ªå¯ä»¥æŸ¥æ‰¾Androidç³»ç»Ÿç‰ˆæœ¬<br>    compileSdk <span class="hljs-number">33</span><br><br>    defaultConfig &#123;<br>    <span class="hljs-regexp">//</span>æŒ‡å®šé¡¹ç›®çš„åŒ…åï¼Œåœ¨åˆ›å»ºé¡¹ç›®çš„æ—¶å€™å…¶å®å·²ç»æŒ‡å®šè¿‡åŒ…åï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä¿®æ”¹ï¼‰<br>        applicationId <span class="hljs-string">&quot;com.example.forcelogout&quot;</span><br>        <span class="hljs-regexp">//</span>é¡¹ç›®æœ€ä½å…¼å®¹çš„SDKç‰ˆæœ¬ï¼ˆæˆ–æœ€ä½å…¼å®¹çš„Androidç³»ç»Ÿç‰ˆæœ¬ï¼‰<br>        minSdk <span class="hljs-number">29</span><br>        <span class="hljs-regexp">//</span>è¡¨ç¤ºåœ¨è¯¥ç›®æ ‡ç‰ˆæœ¬ä¸Šå·²ç»åšè¿‡äº†å……åˆ†çš„æµ‹è¯•<br>        targetSdk <span class="hljs-number">33</span><br>        <span class="hljs-regexp">//</span>æŒ‡å®šé¡¹ç›®çš„ç‰ˆæœ¬å·<br>        versionCode <span class="hljs-number">1</span><br>        <span class="hljs-regexp">//</span>æŒ‡å®šé¡¹ç›®çš„ç‰ˆæœ¬å<br>        versionName <span class="hljs-string">&quot;1.0&quot;</span><br><span class="hljs-regexp">//</span>æŒ‡å®šAndroidå•å…ƒæµ‹è¯•è¿è¡Œå™¨çš„å±æ€§ï¼Œè¿™é‡Œæ˜¯åŸºäºJUnitçš„Androidæµ‹è¯•è¿è¡Œå™¨<br>        testInstrumentationRunner <span class="hljs-string">&quot;androidx.test.runner.AndroidJUnitRunner&quot;</span><br>    &#125;<br><br>    buildTypes &#123;<br>        release &#123;<br>        <span class="hljs-regexp">//</span>æŒ‡å®šæ˜¯å¦å¯¹é¡¹ç›®çš„ä»£ç è¿›è¡Œæ··æ·†<br>            minifyEnabled false<br>            /*æŒ‡å®šæ··æ·†æ—¶ä½¿ç”¨çš„è§„åˆ™æ–‡ä»¶<br>            *ç¬¬ä¸€ä¸ªproguard-android.txtæ˜¯åœ¨Android SDKç›®å½•ä¸‹çš„<br>            *é‡Œé¢æ˜¯æ‰€æœ‰é¡¹ç›®é€šç”¨çš„æ··æ·†è§„åˆ™<br>            *ç¬¬äºŒä¸ªproguard-rules.proæ˜¯åœ¨å½“å‰é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹çš„<br>            *é‡Œé¢å¯ä»¥ç¼–å†™å½“å‰é¡¹ç›®ç‰¹æœ‰çš„æ··æ·†è§„åˆ™ã€‚<br>            */<br>            proguardFiles getDefaultProguardFile(<span class="hljs-string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="hljs-string">&#x27;proguard-rules.pro&#x27;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-regexp">//</span>ç”¨äºæŒ‡å®šç¼–è¯‘é€‰é¡¹<br>    compileOptions &#123;<br>    <span class="hljs-regexp">//</span>æŒ‡å®šäº†æºä»£ç çš„å…¼å®¹æ€§è¦æ±‚ï¼Œè¡¨ç¤ºç¼–è¯‘å™¨å°†æŒ‰ç…§ Java <span class="hljs-number">1.8</span> çš„è§„èŒƒæ¥å¤„ç†æºä»£ç æ–‡ä»¶<br>        sourceCompatibility JavaVersion.VERSION_1_8<br>        <span class="hljs-regexp">//</span>æŒ‡å®šäº†ç”Ÿæˆçš„å­—èŠ‚ç çš„å…¼å®¹æ€§è¦æ±‚ï¼Œè¡¨ç¤ºç¼–è¯‘å™¨å°†ç”Ÿæˆä¸ Java <span class="hljs-number">1.8</span> å…¼å®¹çš„å­—èŠ‚ç æ–‡ä»¶<br>        targetCompatibility JavaVersion.VERSION_1_8<br>    &#125;<br>    buildFeatures &#123;<br>    <span class="hljs-regexp">//</span>trueè¡¨ç¤ºå…è®¸æ‚¨ä»¥ç±»å‹å®‰å…¨çš„æ–¹å¼è®¿é—®å¸ƒå±€æ–‡ä»¶ä¸­çš„è§†å›¾<br>        viewBinding true<br>    &#125;<br>&#125;<br><span class="hljs-regexp">//</span>ä¾èµ–é…ç½®ï¼Œå½“ç¼ºå°‘ä¾èµ–çš„æ—¶å€™å¯ä»¥æ‰‹åŠ¨æ·»åŠ <br>dependencies &#123;<br>    implementation <span class="hljs-string">&#x27;androidx.appcompat:appcompat:1.4.1&#x27;</span><br>    implementation <span class="hljs-string">&#x27;com.google.android.material:material:1.5.0&#x27;</span><br>    implementation <span class="hljs-string">&#x27;androidx.constraintlayout:constraintlayout:2.1.3&#x27;</span><br>    implementation <span class="hljs-string">&#x27;androidx.annotation:annotation:1.3.0&#x27;</span><br>    implementation <span class="hljs-string">&#x27;androidx.lifecycle:lifecycle-livedata-ktx:2.4.1&#x27;</span><br>    implementation <span class="hljs-string">&#x27;androidx.lifecycle:lifecycle-viewmodel-ktx:2.4.1&#x27;</span><br>    testImplementation <span class="hljs-string">&#x27;junit:junit:4.13.2&#x27;</span><br>    androidTestImplementation <span class="hljs-string">&#x27;androidx.test.ext:junit:1.1.3&#x27;</span><br>    androidTestImplementation <span class="hljs-string">&#x27;androidx.test.espresso:espresso-core:3.4.0&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>androidé—­åŒ…ç”¨æ¥é…ç½®é¡¹ç›®æ„å»ºçš„å„ç§å±æ€§ã€‚</p><p>åœ¨androidé—­åŒ…ä¸­åµŒå¥—çš„defaultConfigé—­åŒ…ç”¨æ¥å¯¹é¡¹ç›®çš„æ›´å¤šç»†èŠ‚è¿›è¡Œé…ç½®ã€‚</p><p>buildTypesé—­åŒ…ä¸­ç”¨äºæŒ‡å®šç”Ÿæˆå®‰è£…æ–‡ä»¶çš„ç›¸å…³é…ç½®ï¼Œé€šå¸¸åªä¼šæœ‰ä¸¤ä¸ªå­é—­åŒ…ï¼Œä¸€ä¸ªæ˜¯debug,ä¸€ä¸ªæ˜¯releaseã€‚debugé—­åŒ…ç”¨äºæŒ‡å®šç”Ÿæˆæµ‹è¯•ç‰ˆå®‰è£…æ–‡ä»¶çš„é…ç½®ï¼Œreleaseé—­åŒ…ç”¨äºæŒ‡å®šç”Ÿæˆæ­£å¼ç‰ˆå®‰è£…æ–‡ä»¶çš„é…ç½®ã€‚å¦å¤–ï¼Œdebugé—­åŒ…æ˜¯å¯ä»¥å¿½ç•¥ä¸å†™çš„ï¼Œå› æ­¤æˆ‘ä»¬çœ‹åˆ°ä¸Šé¢çš„ä»£ç ä¸­å°±åªæœ‰ä¸€ä¸ªreleaseé—­åŒ…ã€‚</p><p>dependenciesé—­åŒ…ã€‚è¿™ä¸ªé—­åŒ…çš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œå®ƒå¯ä»¥æŒ‡å®šå½“å‰é¡¹ç›®æ‰€æœ‰çš„ä¾èµ–å…³ç³»ã€‚é€šå¸¸Android Studioé¡¹ç›®ä¸€å…±æœ‰3ç§ä¾èµ–æ–¹å¼ï¼š<strong>æœ¬åœ°ä¾èµ–ã€åº“ä¾èµ–å’Œè¿œç¨‹ä¾èµ–</strong>ã€‚æœ¬åœ°ä¾èµ–å¯ä»¥å¯¹æœ¬åœ°çš„ Jar åŒ…æˆ–ç›®å½•æ·»åŠ ä¾èµ–å…³ç³»ï¼Œåº“ä¾èµ–å¯ä»¥å¯¹é¡¹ç›®ä¸­çš„åº“æ¨¡å—æ·»åŠ ä¾èµ–å…³ç³»ï¼Œè¿œç¨‹ä¾èµ–åˆ™å¯ä»¥å¯¹ jcenter åº“ä¸Šçš„å¼€æºé¡¹ç›®æ·»åŠ ä¾èµ–å…³ç³»ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå¼€å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é™æ€é“¾æ¥åº“å’ŒåŠ¨æ€é“¾æ¥åº“</title>
    <link href="/2023/07/26/%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93%E5%92%8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/"/>
    <url>/2023/07/26/%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93%E5%92%8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>åœ¨è·Ÿç€æ»´æ°´å­¦ä¹ PEç»“æ„çš„æ—¶å€™ï¼Œæ¥è§¦åˆ°äº†é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥çš„çŸ¥è¯†ã€‚ä½†æ˜¯é‚£æ—¶å¹¶æ²¡æœ‰åšç¬”è®°ï¼Œæœ‰ä¹Ÿåªæ˜¯æ‚ä¹±çš„ï¼ˆæ˜¯å•Šï¼ä¸ºä»€ä¹ˆä¸å†™åšå®¢å•Šï¼Ÿï¼Ÿï¼Ÿï¼‰ã€‚å¦‚ä»Šå­¦ä¹ Androidé€†å‘æ—¶ï¼Œä¹Ÿéœ€è¦äº†è§£è¿™æ–¹é¢çš„çŸ¥è¯†ï¼Œè¶ç€è¿™ä¸ªæœºä¼šå†™ä¸€ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹ã€‚</p><hr><h2 id="1-1-ç¼–è¯‘è¿‡ç¨‹"><a href="#1-1-ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="1.1 ç¼–è¯‘è¿‡ç¨‹"></a>1.1 ç¼–è¯‘è¿‡ç¨‹</h2><p>å…ˆæ¥äº†è§£ä¸€ä¸‹ç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹ï¼ˆå€Ÿç”¨èœé¸Ÿæ•™ç¨‹çš„å›¾ç‰‡ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261549265.png"></p><p>ä»æˆ‘ä»¬ç¼–å†™å¥½çš„æºæ–‡ä»¶å¼€å§‹ï¼Œå…ˆç»è¿‡é¢„ç¼–è¯‘ã€ç¼–è¯‘ã€æ±‡ç¼–ï¼Œå¾—åˆ°äº†<code>.o</code>æ–‡ä»¶ï¼ˆæˆ–<code>.obj</code>æ–‡ä»¶ï¼‰ï¼Œè¿™ç±»æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ä¹‹ååœ¨é“¾æ¥è¿‡ç¨‹ï¼Œä¼šå°†æˆ‘ä»¬æºæ–‡ä»¶å¯¹åº”çš„<code>.obj</code>æ–‡ä»¶ä¸æºæ–‡ä»¶æ‰€éœ€è¦çš„é™æ€é“¾æ¥åº“ï¼ˆ<code>.lib</code>ã€<code>.o</code>ï¼‰æˆ–åŠ¨æ€é“¾æ¥åº“ï¼ˆ<code>.dll</code>ã€<code>.so</code>ï¼‰åˆå¹¶ï¼Œå½¢æˆäº†æˆ‘ä»¬å¸¸è§çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚<code>.exe</code>ã€<code>.elf</code>æ–‡ä»¶ï¼‰ã€‚é™æ€é“¾æ¥åº“å’ŒåŠ¨æ€é“¾æ¥åº“çš„åŒºåˆ«å°±åœ¨äºé“¾æ¥è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•åˆå¹¶çš„ã€‚</p><h1 id="äºŒã€é™æ€é“¾æ¥åº“"><a href="#äºŒã€é™æ€é“¾æ¥åº“" class="headerlink" title="äºŒã€é™æ€é“¾æ¥åº“"></a>äºŒã€é™æ€é“¾æ¥åº“</h1><h2 id="2-1-æ¦‚å¿µ"><a href="#2-1-æ¦‚å¿µ" class="headerlink" title="2.1 æ¦‚å¿µ"></a>2.1 æ¦‚å¿µ</h2><p>é™æ€é“¾æ¥åº“åœ¨Windowså¹³å°ä¸‹æ˜¯<code>.lib</code>æ–‡ä»¶ï¼Œåœ¨Linuxå¹³å°ä¸‹æ˜¯<code>.a</code>æ–‡ä»¶ã€‚</p><p>é™æ€é“¾æ¥åº“æ˜¯ä¸€ç§èµ„æºçš„é›†åˆï¼ŒåŒ…æ‹¬å‡½æ•°ã€å˜é‡ã€ç±»ç­‰ï¼Œç¨‹åºé€šè¿‡ä¸å…¶é“¾æ¥ï¼Œè°ƒç”¨åº“ä¸­çš„èµ„æºã€‚åœ¨é“¾æ¥çš„æ—¶å€™ï¼Œé™æ€é“¾æ¥åº“ä¼šå°†è‡ªèº«å®Œæ•´å¤åˆ¶åˆ°ç¨‹åºä¸­ï¼Œè¿™æ ·å°±ä½¿å¾—ç¨‹åºå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€ä¾èµ–å¤–éƒ¨åº“æ–‡ä»¶ã€‚ä½†è¿™æ ·åšä¹Ÿå¯¼è‡´äº†ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶éå¸¸å¤§ã€é™æ€é“¾æ¥åº“æ›´æ–°åˆ™ä¾èµ–äºè¯¥åº“çš„æ‰€æœ‰ç¨‹åºéƒ½éœ€è¦é‡æ–°ç¼–è¯‘ã€å¤šä¸ªç¨‹åºä½¿ç”¨åŒä¸€ä¸ªé™æ€åº“ä¼šåœ¨å†…å­˜ä¸­é‡å¤åŠ è½½ç­‰ã€‚</p><h2 id="2-2-Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨é™æ€é“¾æ¥åº“"><a href="#2-2-Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨é™æ€é“¾æ¥åº“" class="headerlink" title="2.2 Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨é™æ€é“¾æ¥åº“"></a>2.2 Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨é™æ€é“¾æ¥åº“</h2><p><code>lib</code>é¡¹ç›®çš„ç¼–å†™æ¯”è¾ƒç®€å•ï¼Œå‚ç…§<a href="https://learn.microsoft.com/zh-cn/cpp/build/walkthrough-creating-and-using-a-static-library-cpp?view=msvc-170">å®˜æ–¹æ–‡æ¡£</a>æ¥å°±æ˜¯äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261549818.png"></p><p>ç„¶åæ˜¯ä½¿ç”¨<code>lib</code>æ—¶çš„ä¸€äº›é…ç½®ã€‚è¿™éƒ¨åˆ†åœ¨<a href="https://learn.microsoft.com/zh-cn/cpp/build/walkthrough-creating-and-using-a-static-library-cpp?view=msvc-170#UseLibInApp">å®˜æ–¹æ–‡æ¡£</a>çš„<strong>åœ¨åº”ç”¨ä¸­ä½¿ç”¨é™æ€åº“çš„åŠŸèƒ½</strong>å¤„ã€‚å®˜æ–¹ç”¨çš„æ˜¯æ¯”è¾ƒç®€å•çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ·»åŠ å¼•ç”¨ï¼Œä¸€ä¸ªæ·»åŠ å¼•ç”¨åº“çš„è·¯å¾„å°±å¯ä»¥äº†ã€‚</p><p>æˆ‘è¿™é‡Œæ”¹å˜äº†ä¸€ä¸‹æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨â€œæ·»åŠ å¼•ç”¨â€ï¼Œè¿™ä¸ªæƒ³æ³•æ˜¯åŸºäºåé¢çš„ä½¿ç”¨åŠ¨æ€åº“çš„é…ç½®ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><p>é¦–å…ˆå°† <code>lib</code> çš„<code>.h</code>å¤´æ–‡ä»¶çš„æ‰€åœ¨è·¯å¾„æ·»åŠ åˆ°ä½¿ç”¨è¯¥<code>lib</code>é¡¹ç›®çš„å±æ€§é¡µ -&gt; C&#x2F;C++ -&gt; å¸¸è§„ -&gt; é™„åŠ åŒ…å«ç›®å½•ã€‚è¿™ä¸€æ­¥æ˜¯ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨å¤´æ–‡ä»¶ï¼ˆåº“å‡½æ•°ï¼‰ã€‚</p></li><li><p>ç„¶åæ˜¯å°†<code>lib</code>æ–‡ä»¶çš„æ–‡ä»¶åæ·»åŠ åˆ°ä½¿ç”¨è¯¥<code>lib</code>é¡¹ç›®çš„å±æ€§é¡µ -&gt; é“¾æ¥å™¨ -&gt; è¾“å…¥ -&gt; é™„åŠ ä¾èµ–é¡¹ã€‚</p><p>æ¥ä¸‹æ¥éœ€è¦åœ¨ä½¿ç”¨è¯¥<code>lib</code>é¡¹ç›®çš„å±æ€§é¡µ -&gt; é“¾æ¥å™¨ -&gt; å¸¸è§„ -&gt; é™„åŠ åº“ç›®å½•å¤„ï¼Œæ·»åŠ <code>lib</code>æ–‡ä»¶çš„æ‰€åœ¨è·¯å¾„ã€‚</p></li></ol><p>ï¼ˆå› ä¸ºæ˜¯å†™å®Œ<code>dll</code>é…ç½®åå°è¯•çš„ï¼Œå›¾ç‰‡çš„è¯å°±å‚è€ƒåé¢çš„<strong>3.2 Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“</strong>å§ï¼‰</p><p>ä»¥ä¸Šå®Œæˆåï¼Œå°±å¯ä»¥æˆåŠŸçš„ä½¿ç”¨<code>lib</code>æ–‡ä»¶äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261549930.png"></p><h2 id="2-3-Linuxå¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨é™æ€é“¾æ¥åº“"><a href="#2-3-Linuxå¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨é™æ€é“¾æ¥åº“" class="headerlink" title="2.3 Linuxå¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨é™æ€é“¾æ¥åº“"></a>2.3 Linuxå¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨é™æ€é“¾æ¥åº“</h2><p>ä»£ç åŒä¸Šï¼Œç¼–å†™å¥½åæ‰§è¡ŒæŒ‡ä»¤ç”Ÿæˆ<code>.o</code>æ–‡ä»¶ã€‚</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">g</span><span class="hljs-literal">++</span> <span class="hljs-literal">-</span><span class="hljs-comment">c StaticMath</span><span class="hljs-string">.</span><span class="hljs-comment">cpp(cppæ–‡ä»¶å)</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„å¸¦å‚æ•°<code>-c</code>ï¼Œå¦åˆ™ç›´æ¥ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚ç„¶åï¼Œé€šè¿‡<code>ar</code>å·¥å…·å°†ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆ<code>.a</code>é™æ€åº“æ–‡ä»¶</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">ar -crv libstaticmath.a<span class="hljs-comment">(.aæ–‡ä»¶åä»»æ„)</span> StaticMath.o<span class="hljs-comment">(ç”Ÿæˆçš„.oæ–‡ä»¶å)</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥å°±ä¼šç”Ÿæˆæˆ‘ä»¬æ‰€éœ€è¦çš„é™æ€åº“ã€‚æ¥ä¸‹æ¥æ˜¯ç¼–å†™ä½¿ç”¨æ¡ˆä¾‹ï¼ˆä»£ç åŒä¸Šï¼‰ï¼Œç¼–å†™å¥½äº†ä¹‹åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">g++ TestStaticLibrary.cpp -I .<span class="hljs-regexp">/StaticLibrary -L ./</span>StaticLibrary -lstaticmath -o TestStaticLibrary.out<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>-I</code> ç”¨äºæŒ‡å®šå¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œ<code>-L</code> ç”¨äºæŒ‡å®šåº“æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œ<code>-l</code> ç”¨äºæŒ‡å®šé™æ€åº“æˆ–å…±äº«åº“æ–‡ä»¶ï¼ˆä¸éœ€è¦<code>lib</code>å‰ç¼€å’Œ<code>.a</code>åç¼€ï¼Œç¼–è¯‘å™¨æŸ¥æ‰¾åŠ¨æ€è¿æ¥åº“æ—¶æœ‰éšå«çš„å‘½åè§„åˆ™ï¼Œå³åœ¨ç»™å‡ºçš„åå­—å‰é¢åŠ ä¸Šlibï¼Œåé¢åŠ ä¸Š.aæˆ–.soæ¥ç¡®å®šåº“çš„åç§°ï¼‰ï¼Œ<code>-o</code>ç”¨äºæŒ‡å®šç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šç”Ÿæˆä¸€ä¸ªåä¸º <code>a.out</code> çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>å› ä¸ºæˆ‘åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œ<code>TestStaticLibrary.cpp</code>å’Œé™æ€åº“é¡¹ç›®å¹¶æ²¡æœ‰æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œå¦‚æœä¸åŠ <code>-I</code>å‚æ•°ï¼Œå¯èƒ½ä¼šæŠ¥é”™</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stata">TestStaticLibrary.cpp:1:10: fatal <span class="hljs-keyword">error</span>: StaticMath.<span class="hljs-keyword">h</span>: <span class="hljs-keyword">No</span> such <span class="hljs-keyword">file</span> or directory<br>    1 | #<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;StaticMath.h&quot;</span><br>      |          ^~~~~~~~~~~~~~<br>compilation terminated.<br></code></pre></td></tr></table></figure><p>æœ€åæ‰§è¡Œç”Ÿæˆçš„<code>.out</code>æ–‡ä»¶ï¼Œç»“æœå¦‚ä¸‹</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261550027.jpg"></p><h1 id="ä¸‰ã€åŠ¨æ€é“¾æ¥åº“"><a href="#ä¸‰ã€åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="ä¸‰ã€åŠ¨æ€é“¾æ¥åº“"></a>ä¸‰ã€åŠ¨æ€é“¾æ¥åº“</h1><h2 id="3-1-æ¦‚å¿µ"><a href="#3-1-æ¦‚å¿µ" class="headerlink" title="3.1 æ¦‚å¿µ"></a>3.1 æ¦‚å¿µ</h2><p>åŠ¨æ€é“¾æ¥åº“åœ¨Windowså¹³å°ä¸‹æ˜¯<code>.dll</code>æ–‡ä»¶ï¼Œåœ¨Linuxå¹³å°ä¸‹æ˜¯<code>.so</code>æ–‡ä»¶ã€‚</p><p>ä¸é™æ€é“¾æ¥åº“ç›¸åŒçš„æ˜¯ï¼ŒåŠ¨æ€é“¾æ¥åº“ä¹Ÿæ˜¯ä¸€ç§èµ„æºçš„é›†åˆï¼ŒåŒ…æ‹¬å‡½æ•°ã€å˜é‡å’Œç±»ç­‰èµ„æºã€‚</p><p>ä½†æ˜¯åŠ¨æ€é“¾æ¥åº“åœ¨é“¾æ¥çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šæŠŠè‡ªèº«å¤åˆ¶åˆ°å¯æ‰§è¡Œç¨‹åºä¸­ï¼Œè€Œæ˜¯æŠŠå¯¹åŠ¨æ€é“¾æ¥åº“çš„å¼•ç”¨ä¿¡æ¯æ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä»¥æŒ‡ç¤ºç¨‹åºåœ¨è¿è¡Œæ—¶éœ€è¦åŠ è½½çš„åŠ¨æ€é“¾æ¥åº“ã€‚åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæ ¹æ®è¿™äº›å¼•ç”¨ä¿¡æ¯æ¥åŠ¨æ€åŠ è½½å¹¶é“¾æ¥åŠ¨æ€é“¾æ¥åº“ï¼Œä½¿å¾—ç¨‹åºå¯ä»¥è°ƒç”¨å…¶ä¸­çš„å‡½æ•°å’Œä½¿ç”¨å…¶ä¸­çš„æ•°æ®ã€‚</p><p>è¿™æ ·åšçš„ä¼˜ç‚¹ï¼Œæ¯”å¦‚åŠ¨æ€é“¾æ¥åº“çš„ä»£ç åœ¨å†…å­˜ä¸­æ˜¯å…±äº«çš„ï¼Œå¯ä»¥è¢«å¤šä¸ªç¨‹åºåŒæ—¶ä½¿ç”¨ã€‚ä½†ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå¦‚æœç¼ºå°‘æ‰€éœ€çš„<code>.dll</code>æ–‡ä»¶ï¼Œåˆ™å¯æ‰§è¡Œæ–‡ä»¶æ— æ³•è¿è¡Œã€‚</p><h2 id="3-2-Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“"><a href="#3-2-Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="3.2 Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“"></a>3.2 Windowså¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“</h2><p><code>dll</code>é¡¹ç›®ç¼–è¯‘åï¼Œä¼šç”Ÿæˆ<code>.lib</code>ã€<code>.dll</code>æ–‡ä»¶ã€‚<code>.lib</code>æ–‡ä»¶æ˜¯ä¸€ä¸ªè¾…åŠ©æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†ä¸åŠ¨æ€é“¾æ¥åº“ç›¸å…³çš„ä¸€äº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‡½æ•°åã€ç¬¦å·åä»¥åŠå‡½æ•°åœ¨<code>dll</code>ä¸­çš„åç§»ç­‰ï¼Œä¸»è¦ä½œç”¨æ˜¯åœ¨ç¼–è¯‘æœŸé—´æä¾›å¼•ç”¨ä¿¡æ¯ï¼Œä»¥ä¾¿ç¼–è¯‘å™¨èƒ½å¤Ÿæ­£ç¡®åœ°è§£æå’Œé“¾æ¥åŠ¨æ€é“¾æ¥åº“ã€‚</p><p>åˆ›å»º<code>dll</code>æ–‡ä»¶æ¯”è¾ƒç®€å•ï¼Œä½†éœ€è¦æ³¨æ„åœ¨å‡½æ•°åå‰é¢åŠ ä¸Š<code>extern &quot;C&quot; __declspec(dllimport)</code>ã€‚</p><ul><li><p><code>extern &quot;C&quot;</code>ç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨å°†ä»£ç æŒ‰ç…§ C è¯­è¨€çš„è§„åˆ™è¿›è¡Œé“¾æ¥ã€‚å› ä¸º C++ åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šå¯¹å‡½æ•°åè¿›è¡Œé‡è½½å’Œåç§°ä¿®é¥°ï¼Œå¯¼è‡´å‡½æ•°ååœ¨ç¼–è¯‘åå˜æˆäº†ä¸åŒçš„å½¢å¼ã€‚è€ŒåŠ¨æ€é“¾æ¥åº“å¯¹å¤–æš´éœ²çš„å‡½æ•°åé€šå¸¸æ˜¯ä½¿ç”¨ C è¯­è¨€çš„å‘½åè§„åˆ™ï¼Œä¸ºäº†ç¡®ä¿æ­£ç¡®é“¾æ¥ï¼Œéœ€è¦ä½¿ç”¨<code>extern &quot;C&quot;</code>æ¥å‘Šè¯‰ç¼–è¯‘å™¨ä½¿ç”¨ C è¯­è¨€çš„é“¾æ¥è§„åˆ™ã€‚</p></li><li><p><code>__declspec(dllimport)</code>ç”¨äºæ˜¾å¼åœ°æŒ‡ç¤ºç¼–è¯‘å™¨è¯¥å‡½æ•°æ˜¯ä»<code>dll </code>æ–‡ä»¶ä¸­å¯¼å…¥çš„ã€‚ä½¿ç”¨<code>__declspec(dllimport)</code>ä¿®é¥°çš„å‡½æ•°è¡¨ç¤ºè¯¥å‡½æ•°åœ¨ç¼–è¯‘æ—¶æ˜¯ä»å¤–éƒ¨çš„<code>dll </code>æ–‡ä»¶ä¸­å¼•å…¥çš„ï¼Œè€Œä¸æ˜¯å½“å‰ç¼–è¯‘çš„æºæ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚è¿™æ ·ï¼Œåœ¨é“¾æ¥é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®è¯¥å…³é”®å­—ç”Ÿæˆæ­£ç¡®çš„å¯¼å…¥è¡¨ï¼Œå¹¶åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å¯¹åº”çš„ DLL æ–‡ä»¶ã€‚</p></li></ul><p>è¿™ä¸€éƒ¨åˆ†çš„ç¼–å†™è·Ÿç€å®˜æ–¹æ–‡æ¡£èµ°å°±è¡Œäº†ã€‚</p><p>è¿™é‡Œä¸»è¦è¯´ä¸€ä¸‹ä½¿ç”¨<code>.dll</code>æ–‡ä»¶æ—¶æ‰€éœ€è¦çš„è®¾ç½®ã€‚</p><ol><li><p>é¦–å…ˆå°† <code>dll</code> çš„<code>.h</code>å¤´æ–‡ä»¶çš„æ‰€åœ¨è·¯å¾„æ·»åŠ åˆ°ä½¿ç”¨è¯¥<code>dll</code>é¡¹ç›®çš„å±æ€§é¡µ -&gt; C&#x2F;C++ -&gt; å¸¸è§„ -&gt; é™„åŠ åŒ…å«ç›®å½•ï¼Œè¿™ä¸€æ­¥çš„è®¾ç½®è·Ÿé™æ€é“¾æ¥åº“ä¸€æ ·ã€‚æ˜¯ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨å¤´æ–‡ä»¶ï¼ˆåº“å‡½æ•°ï¼‰ã€‚ï¼ˆè¿™ä¸€æ­¥åœ¨<a href="https://learn.microsoft.com/zh-cn/cpp/build/walkthrough-creating-and-using-a-dynamic-link-library-cpp?view=msvc-170#to-add-the-dll-header-to-your-include-path">å®˜æ–¹æ–‡æ¡£</a>çš„<strong>å°† DLL æ ‡å¤´æ·»åŠ åˆ°åŒ…å«è·¯å¾„</strong>å¤„ï¼‰</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261550538.jpg"></p></li><li><p>ç„¶åæ˜¯å°†<code>lib</code>æ–‡ä»¶çš„æ–‡ä»¶åï¼ˆä»¥é¡¹ç›®åå‘½åçš„ï¼Œæˆ‘è¿˜å‚»ä¹ä¹çš„å¡«<code>.c</code>çš„æ–‡ä»¶åï¼‰æ·»åŠ åˆ°ä½¿ç”¨è¯¥<code>dll</code>é¡¹ç›®çš„å±æ€§é¡µ -&gt; é“¾æ¥å™¨ -&gt; è¾“å…¥ -&gt; é™„åŠ ä¾èµ–é¡¹ï¼Œ</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261550945.jpg"></p><p>ç°åœ¨åªæ˜¯å‘Šè¯‰é“¾æ¥å™¨åœ¨ç¼–è¯‘æ—¶éœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ª<code>lib</code>æ–‡ä»¶ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å‘Šè¯‰é“¾æ¥å™¨å»å“ªé‡Œæ‰¾è¿™ä¸ª<code>lib</code>æ–‡ä»¶ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦åœ¨ä½¿ç”¨è¯¥<code>dll</code>é¡¹ç›®çš„å±æ€§é¡µ -&gt; é“¾æ¥å™¨ -&gt; å¸¸è§„ -&gt; é™„åŠ åº“ç›®å½•å¤„ï¼Œæ·»åŠ <code>lib</code>æ–‡ä»¶çš„æ‰€åœ¨è·¯å¾„ï¼ˆå¥‡æ€ªï¼Œè¿™ä¸ª<code>lib</code>æ–‡ä»¶æ€ä¹ˆåœ¨ä½¿ç”¨<code>dll</code>é¡¹ç›®çš„è·¯å¾„ä¸‹ï¼Ÿï¼Ÿï¼Ÿï¼‰</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261552596.jpg"></p><p>ï¼ˆä»¥ä¸Šåœ¨<a href="https://learn.microsoft.com/zh-cn/cpp/build/walkthrough-creating-and-using-a-dynamic-link-library-cpp?view=msvc-170#to-add-the-dll-import-library-to-your-project">å®˜æ–¹æ–‡æ¡£</a>çš„<strong>å°† DLL å¯¼å…¥åº“æ·»åŠ åˆ°é¡¹ç›®ä¸­</strong>å¤„ï¼‰</p></li><li><p>æœ€åæ˜¯å°†<code>dll</code>æ–‡ä»¶å¤åˆ¶åˆ°ä½¿ç”¨è¯¥<code>dll</code>çš„é¡¹ç›®ä¸­ï¼Œåœ¨è¯¥é¡¹ç›®çš„å±æ€§é¡µ -&gt; ç”Ÿæˆäº‹ä»¶ -&gt; ç”Ÿæˆåäº‹ä»¶ -&gt; å‘½ä»¤è¡Œä¸­æ·»åŠ æŒ‡ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">xcopy /y /d dllæ‰€åœ¨è·¯å¾„ <span class="hljs-string">&quot;<span class="hljs-subst">$(OutDir)</span>&quot;</span><br></code></pre></td></tr></table></figure><p>ï¼ˆè¿™ä¸€æ­¥åœ¨<a href="https://learn.microsoft.com/zh-cn/cpp/build/walkthrough-creating-and-using-a-dynamic-link-library-cpp?view=msvc-170#to-add-the-dll-import-library-to-your-project">å®˜æ–¹æ–‡æ¡£</a>çš„<strong>åœ¨ç”Ÿæˆåäº‹ä»¶ä¸­å¤åˆ¶ DLL</strong>å¤„ï¼‰</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261551736.jpg"></p></li></ol><p>ä»¥ä¸Šå®Œæˆåï¼Œå°±å¯ä»¥æ„‰å¿«åœ°ä½¿ç”¨è‡ªå·±å†™çš„<code>dll</code>äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261551693.png"></p><h2 id="3-3-Linuxå¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“"><a href="#3-3-Linuxå¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="3.3 Linuxå¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“"></a>3.3 Linuxå¹³å°ä¸‹åˆ›å»ºä¸ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“</h2><p>ç¼–å†™å¥½<code>so</code>é¡¹ç›®åï¼Œæ‰§è¡Œå‘½ä»¤ç”Ÿæˆ<code>.o</code>æ–‡ä»¶ã€‚</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">g</span><span class="hljs-literal">++</span> <span class="hljs-literal">-</span><span class="hljs-comment">fPIC</span> <span class="hljs-literal">-</span><span class="hljs-comment">c DynamicMath</span><span class="hljs-string">.</span><span class="hljs-comment">cpp(cppæ–‡ä»¶å)</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>-fPIC</code>ç”¨äºåˆ›å»ºä¸åœ°å€æ— å…³çš„ç¼–è¯‘ç¨‹åºï¼Œæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨å¤šä¸ªåº”ç”¨ç¨‹åºé—´å…±äº«ã€‚</p><p>ä¹‹åï¼Œæ‰§è¡Œå‘½ä»¤ç”ŸæˆåŠ¨æ€åº“</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">g++ -shared -o libdynmath<span class="hljs-selector-class">.so</span>(.aæ–‡ä»¶åä»»æ„) DynamicMath<span class="hljs-selector-class">.o</span>(ç”Ÿæˆçš„.oæ–‡ä»¶å)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>-shared</code>ç”¨äºç”ŸæˆåŠ¨æ€é“¾æ¥åº“ã€‚</p><p>ç¼–å†™ä½¿ç”¨æ¡ˆä¾‹ï¼Œæ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼Œå¼•ç”¨åŠ¨æ€åº“ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè·Ÿé™æ€åº“æ–¹å¼ä¸€æ ·ï¼‰ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">g++ TestDynamicLibrary.cpp -I .<span class="hljs-regexp">/DynamicLibrary -L ./</span>DynamicLibrary -ldynmath -o TestDynamicLibrary<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥éœ€è¦å°†ç”Ÿæˆçš„<code>so</code>æ–‡ä»¶å¤åˆ¶åˆ°<code>/usr/lib</code>ç›®å½•ä¸‹ï¼ˆåœ¨<code>root</code>æ¨¡å¼ä¸‹ï¼‰ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo cp .<span class="hljs-regexp">/DynamicLibrary/</span>libdynmath.so <span class="hljs-regexp">/usr/</span>lib<br></code></pre></td></tr></table></figure><p>å¦è€…æŠ¥é”™å¦‚ä¸‹</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">./TestDynamicLibrary: <span class="hljs-keyword">error</span> <span class="hljs-keyword">while</span> loading shared libraries: libdynmath.<span class="hljs-keyword">so</span>: <br>cannotopen shared object <span class="hljs-keyword">file</span>: <span class="hljs-keyword">No</span> such <span class="hljs-keyword">file</span> or directory<br></code></pre></td></tr></table></figure><p>æ‰¾ä¸åˆ°<code>libdynmath.so</code>ï¼Œé‚£ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ</p><p>åŸå› æ˜¯åœ¨<code>Linux</code>ç³»ç»Ÿä¸‹ï¼Œç¨‹åºé€šè¿‡ä»¥ä¸‹æ–¹å¼å®šä½<code>so</code>æ–‡ä»¶ï¼š</p><ol><li>é»˜è®¤æœç´¢è·¯å¾„ï¼šç³»ç»Ÿä¼šåœ¨ä¸€ç»„é»˜è®¤çš„ç›®å½•ä¸­æœç´¢åŠ¨æ€å…±äº«åº“ï¼ŒåŒ…æ‹¬ <code>/lib</code>, <code>/usr/lib</code>, <code>/lib64</code>, <code>/usr/lib64</code> ç­‰ç­‰ã€‚</li><li>ç¯å¢ƒå˜é‡<code>LD_LIBRARY_PATH</code>ï¼šç¨‹åºå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ <code>LD_LIBRARY_PATH</code> æ¥æŒ‡å®šé¢å¤–çš„åŠ¨æ€å…±äº«åº“æœç´¢è·¯å¾„ã€‚ç³»ç»Ÿä¼šåœ¨è¯¥ç¯å¢ƒå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­æœç´¢åŠ¨æ€å…±äº«åº“ã€‚</li><li><code>rpath/rpath-link</code>ï¼šç¨‹åºå¯ä»¥åœ¨ç¼–è¯‘æ—¶é€šè¿‡ <code>-Wl,-rpath</code> æˆ– <code>-Wl,-rpath-link</code> é€‰é¡¹æŒ‡å®šè¿è¡Œæ—¶æœç´¢åŠ¨æ€å…±äº«åº“çš„è·¯å¾„ã€‚è¿™äº›è·¯å¾„ä¼šè¢«ä¿å­˜åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„ <code>ELF</code> å¤´éƒ¨ä¸­ï¼Œå¹¶åœ¨ç¨‹åºè¿è¡Œæ—¶ç”Ÿæ•ˆã€‚</li><li>ç¼“å­˜æ–‡ä»¶ï¼š<code>Linux</code>ç³»ç»Ÿè¿˜ç»´æŠ¤äº†ä¸€ä¸ªåŠ¨æ€å…±äº«åº“çš„ç¼“å­˜æ–‡ä»¶ï¼Œé€šå¸¸æ˜¯ <code>/etc/ld.so.cache</code>ã€‚è¯¥æ–‡ä»¶è®°å½•äº†ç³»ç»Ÿä¸­å¯ç”¨çš„åŠ¨æ€å…±äº«åº“çš„ä½ç½®ï¼ŒåŠ å¿«äº†åº“çš„æœç´¢é€Ÿåº¦ã€‚</li></ol><p>æ‰€ä»¥æœ€ç®€å•çš„æ–¹å¼æ˜¯å°†<code>so</code>æ–‡ä»¶å¤åˆ¶ <code>/lib</code>, <code>/usr/lib</code>ç­‰ç›®å½•ä¸‹ã€‚æœ€ç»ˆæ‰§è¡Œæ•ˆæœå¦‚ä¸‹</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307261551601.jpg"></p><h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p>åº“æ˜¯ä¸€ç§èµ„æºçš„é›†åˆï¼ŒåŒ…æ‹¬å‡½æ•°ã€å˜é‡ã€ç±»ç­‰ï¼Œç¨‹åºå¯ä»¥é€šè¿‡ä¸å…¶é“¾æ¥æ¥è°ƒç”¨åº“ä¸­çš„èµ„æºã€‚ç”±äºé“¾æ¥çš„æ–¹å¼çš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºé™æ€é“¾æ¥åº“å’ŒåŠ¨æ€é“¾æ¥åº“ï¼Œé™æ€é“¾æ¥åº“åœ¨ç¼–è¯‘é˜¶æ®µå°†è‡ªèº«å¤åˆ¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä¸€æ¥å¯æ‰§è¡Œæ–‡ä»¶å°±å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼›è€ŒåŠ¨æ€é“¾æ¥åº“åˆ™æ˜¯å°†å¼•ç”¨ä¿¡æ¯å¤åˆ¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶é€šè¿‡è¿™äº›å¼•ç”¨ä¿¡æ¯æ¥åŠ¨æ€åŠ è½½åŠ¨æ€é“¾æ¥åº“ï¼Œè¿™æ ·ä¸€æ¥å¯æ‰§è¡Œæ–‡ä»¶å°±ä¸èƒ½ç‹¬ç«‹è¿è¡Œã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://learn.microsoft.com/zh-cn/cpp/build/walkthrough-creating-and-using-a-static-library-cpp?view=msvc-170">æ¼”ç»ƒï¼šåˆ›å»ºå¹¶ä½¿ç”¨é™æ€åº“ (C++) | Microsoft Learn</a></p><p><a href="https://learn.microsoft.com/zh-cn/cpp/build/walkthrough-creating-and-using-a-dynamic-link-library-cpp?view=msvc-170">æ¼”ç»ƒï¼šåˆ›å»ºå’Œä½¿ç”¨è‡ªå·±çš„åŠ¨æ€é“¾æ¥åº“ (C++) | Microsoft Learn</a></p><p><a href="https://blog.csdn.net/dive668/article/details/120372718">ã€Visual Studioã€‘åˆ›å»ºå¹¶ä½¿ç”¨é™æ€åº“(.lib) æ¾åº“æœ¬åº“çš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/dive668/article/details/120388534?ops_request_misc=&request_id=ce1e4f5606d441d3b092bc80b29b56ed&biz_id=&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~koosearch~default-1-120388534-null-null.268%5Ev1%5Econtrol&utm_term=%E5%8A%A8%E6%80%81&spm=1018.2226.3001.4450">ã€Visual Studioã€‘åˆ›å»ºå¹¶ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“(C++)_æ¾åº“æœ¬åº“çš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://www.runoob.com/w3cnote/cpp-static-library-and-dynamic-library.html">C++é™æ€åº“ä¸åŠ¨æ€åº“ | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>é™æ€åº“</tag>
      
      <tag>åŠ¨æ€åº“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidåº”ç”¨ç¨‹åºå¯åŠ¨æµç¨‹(äºŒ)</title>
    <link href="/2023/07/24/Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B(%E4%BA%8C)/"/>
    <url>/2023/07/24/Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B(%E4%BA%8C)/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>åœ¨<a href="https://gal2xy.github.io/2023/07/17/Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B(%E4%B8%80)">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨çš„æµç¨‹ã€‚é‚£ä¹ˆï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹å·²å¯åŠ¨çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºåˆæ˜¯å¦‚ä½•å¯åŠ¨çš„å‘¢ï¼Ÿåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»ç‚¹å‡»åº”ç”¨å¿«æ·å›¾æ ‡å¼€å§‹ï¼Œåˆ†æåº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Œå³æ ¹<code>Activity</code>æ˜¯å¦‚ä½•å¯åŠ¨çš„ã€‚</p><h1 id="äºŒã€æ ¹Activityå¯åŠ¨æµç¨‹"><a href="#äºŒã€æ ¹Activityå¯åŠ¨æµç¨‹" class="headerlink" title="äºŒã€æ ¹Activityå¯åŠ¨æµç¨‹"></a>äºŒã€æ ¹Activityå¯åŠ¨æµç¨‹</h1><h2 id="2-1-Launcher-è¯·æ±‚-AMS-è¿‡ç¨‹"><a href="#2-1-Launcher-è¯·æ±‚-AMS-è¿‡ç¨‹" class="headerlink" title="2.1 Launcher è¯·æ±‚ AMS è¿‡ç¨‹"></a>2.1 Launcher è¯·æ±‚ AMS è¿‡ç¨‹</h2><p>è¿˜è®°å¾—<a href="https://gal2xy.github.io/2023/07/04/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">Androidç³»ç»Ÿå¯åŠ¨æµç¨‹</a>ä¸­ï¼Œæœ€åä¸€ä¸ªé˜¶æ®µæ˜¯ä»€ä¹ˆå˜›ï¼Ÿæ²¡é”™ï¼Œæ˜¯<code>Launcher</code>åº”ç”¨ç¨‹åºçš„å¯åŠ¨ï¼Œä¹Ÿå°±æ˜¯æ‰‹æœºçš„æ¡Œé¢ã€‚å®ƒæ˜¯<code>Zygote</code>è¿›ç¨‹å­µåŒ–çš„ç¬¬ä¸€ä¸ª<code>APP</code>ã€‚åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šè¯·æ±‚<code>PackageManagerService</code>è¿”å›ç³»ç»Ÿä¸­å·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯å°è£…æˆä¸€ä¸ªå¿«æ·å›¾æ ‡åˆ—è¡¨æ˜¾ç¤ºåœ¨ç³»ç»Ÿå±å¹•ä¸Šï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»å›¾æ ‡æ¥å¯åŠ¨ç›¸åº”çš„åº”ç”¨ç¨‹åºã€‚</p><p>å½“æˆ‘ä»¬ç‚¹å‡»åº”ç”¨å›¾æ ‡æ—¶ï¼Œ<code>Launcher</code>çš„<code>onClick</code>æ–¹æ³•è¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> &#123;<br>    ......<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">tag</span> <span class="hljs-operator">=</span> v.getTag();<br>    <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> ShortcutInfo) &#123;<span class="hljs-comment">//åº”ç”¨ç¨‹åºå¿«æ·å›¾æ ‡</span><br>        <span class="hljs-comment">//å¤„ç†åº”ç”¨ç¨‹åºå¿«æ·æ–¹å¼çš„ç‚¹å‡»äº‹ä»¶</span><br>        onClickAppShortcut(v);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> FolderInfo) &#123;<span class="hljs-comment">//æ–‡ä»¶å¤¹</span><br>        <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> FolderIcon) &#123;<span class="hljs-comment">//ç‚¹å‡»çš„è§†å›¾æ—¶æ–‡ä»¶å¤¹å›¾æ ‡</span><br>            onClickFolderIcon(v);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((FeatureFlags.LAUNCHER3_ALL_APPS_PULL_UP &amp;&amp; v <span class="hljs-keyword">instanceof</span> PageIndicator) ||<br>               (v == mAllAppsButton &amp;&amp; mAllAppsButton != <span class="hljs-literal">null</span>)) &#123;<br>        onClickAllAppsButton(v);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> AppInfo) &#123;<span class="hljs-comment">//åº”ç”¨ä¿¡æ¯</span><br>        startAppShortcutOrInfoActivity(v);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> LauncherAppWidgetInfo) &#123;<span class="hljs-comment">//Launcherå°éƒ¨ä»¶ï¼Œå¦‚å¤©æ°”ã€æ—¥æœŸç­‰å°éƒ¨ä»¶</span><br>        <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> PendingAppWidgetHostView) &#123;<br>            onClickPendingWidget((PendingAppWidgetHostView) v);<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClickAppShortcut</span><span class="hljs-params">(<span class="hljs-keyword">final</span> View v)</span> &#123;<br>    <span class="hljs-comment">//å¯¹vçš„æ£€æµ‹</span><br>......<br>    <span class="hljs-comment">// Start activities</span><br>    startAppShortcutOrInfoActivity(v);<br>&#125;<br><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAppShortcutOrInfoActivity</span><span class="hljs-params">(View v)</span> &#123;<br>    <span class="hljs-type">ItemInfo</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> (ItemInfo) v.getTag();<br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> item.getIntent();<br>    <span class="hljs-keyword">if</span> (intent == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Input must have a valid intent&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//startActivitySafely()å¯åŠ¨åº”ç”¨ç¨‹åº</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> startActivitySafely(v, intent, item);<br>    <span class="hljs-comment">//è®°å½•åº”ç”¨ç¨‹åºå¯åŠ¨çš„ç”¨æˆ·äº‹ä»¶ï¼ˆæ—¥å¿—ï¼‰</span><br>    getUserEventDispatcher().logAppLaunch(v, intent); <span class="hljs-comment">// TODO for discovered apps b/35802115</span><br><br>    <span class="hljs-keyword">if</span> (success &amp;&amp; v <span class="hljs-keyword">instanceof</span> BubbleTextView) &#123;<br>        mWaitingForResume = (BubbleTextView) v;<br>        mWaitingForResume.setStayPressed(<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startActivitySafely</span><span class="hljs-params">(View v, Intent intent, ItemInfo item)</span> &#123;<br>    ......<br>    <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡æ ˆæ¥å¯åŠ¨Activity</span><br>    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);<br>    <span class="hljs-keyword">if</span> (v != <span class="hljs-literal">null</span>) &#123;<br>        intent.setSourceBounds(getViewBounds(v));<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (Utilities.ATLEAST_MARSHMALLOW<br>            &amp;&amp; (item <span class="hljs-keyword">instanceof</span> ShortcutInfo)<br>            &amp;&amp; (item.itemType == Favorites.ITEM_TYPE_SHORTCUT<br>                || item.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT)<br>            &amp;&amp; !((ShortcutInfo) item).isPromise()) &#123;<br>            <span class="hljs-comment">// Shortcuts need some special checks due to legacy reasons.</span><br>            startShortcutIntentSafely(intent, optsBundle, item);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.equals(Process.myUserHandle())) &#123;<br>            <span class="hljs-comment">// Could be launching some bookkeeping activity</span><br>            startActivity(intent, optsBundle);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            LauncherAppsCompat.getInstance(<span class="hljs-built_in">this</span>).startActivityForProfile(<br>                intent.getComponent(), user, intent.getSourceBounds(), optsBundle);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (ActivityNotFoundException|SecurityException e) &#123;<br>        ......<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœç‚¹å‡»çš„æ—¶åº”ç”¨å¿«æ·å›¾æ ‡ï¼Œä¼šè°ƒç”¨<code>onClickAppShortcut</code>æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨<code>startAppShortcutOrInfoActivity</code>æ–¹æ³•ï¼Œè·å–è§†å›¾å¯¹è±¡çš„<code>Intent</code>ï¼Œç„¶åè°ƒç”¨<code>startActivitySafely</code>æ–¹æ³•ï¼Œè®¾ç½®<code>Intent</code>çš„<code>Flag</code>ä¸º<code>FLAG_ACTIVITY_NEW_TASK</code>ï¼ŒæŒ‡ç¤º<code>Android</code>ç³»ç»Ÿé€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡æ ˆæ¥å¯åŠ¨<code>Activity</code>ï¼Œä¹‹åä¼šè°ƒç”¨<code>startActivity</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/Activity.java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Launch a new activity.  You will not receive any information about when</span><br><span class="hljs-comment">* the activity exits.  This implementation overrides the base version,</span><br><span class="hljs-comment">* providing information about the activity performing the launch.  </span><br><span class="hljs-comment">* Because of this additional information,</span><br><span class="hljs-comment">* the &#123;<span class="hljs-doctag">@link</span> Intent#FLAG_ACTIVITY_NEW_TASK&#125; launch flag is not</span><br><span class="hljs-comment">* required; if not specified, the new activity will be added to the</span><br><span class="hljs-comment">* task of the caller.</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> intent The intent to start.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> options Additional options for how the Activity should be started.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(Intent intent, <span class="hljs-meta">@Nullable</span> Bundle options)</span> &#123;<br>    <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) &#123;<br>        startActivityForResult(intent, -<span class="hljs-number">1</span>, options);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        startActivityForResult(intent, -<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Same as calling &#123;<span class="hljs-doctag">@link</span> #startActivityForResult(Intent, int, Bundle)&#125;</span><br><span class="hljs-comment">* with no options.</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> requestCode If &gt;= 0, this code will be returned in</span><br><span class="hljs-comment">*                    onActivityResult() when the activity exits.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivityForResult</span><span class="hljs-params">(<span class="hljs-meta">@RequiresPermission</span> Intent intent, <span class="hljs-type">int</span> requestCode)</span> &#123;<br>    startActivityForResult(intent, requestCode, <span class="hljs-literal">null</span>);<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Launch an activity for which you would like a result when it finished.</span><br><span class="hljs-comment">* When this activity exits, your</span><br><span class="hljs-comment">* onActivityResult() method will be called with the given requestCode.</span><br><span class="hljs-comment">* Using a negative requestCode is the same as calling</span><br><span class="hljs-comment">* &#123;<span class="hljs-doctag">@link</span> #startActivity&#125; (the activity is not launched as a sub-activity).</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivityForResult</span><span class="hljs-params">(<span class="hljs-meta">@RequiresPermission</span> Intent intent, <span class="hljs-type">int</span> requestCode,</span><br><span class="hljs-params">                                   <span class="hljs-meta">@Nullable</span> Bundle options)</span> &#123;<br>    <span class="hljs-keyword">if</span> (mParent == <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//å½“å‰Activityæ˜¯å¦æœ‰çˆ¶Activity</span><br>        options = transferSpringboardActivityOptions(options);<br>        Instrumentation.<span class="hljs-type">ActivityResult</span> <span class="hljs-variable">ar</span> <span class="hljs-operator">=</span> mInstrumentation.execStartActivity(<span class="hljs-built_in">this</span>, mMainThread.getApplicationThread(), mToken, <span class="hljs-built_in">this</span>, intent, requestCode, options);<br>        <span class="hljs-keyword">if</span> (ar != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//é€šè¿‡ä¸»çº¿ç¨‹çš„sendActivityResultæ–¹æ³•å°†ç»“æœæ•°æ®å‘é€ç»™å‘èµ·è¯·æ±‚çš„Activity</span><br>            mMainThread.sendActivityResult(mToken, mEmbeddedID, requestCode, ar.getResultCode(), ar.getResultData());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (requestCode &gt;= <span class="hljs-number">0</span>) &#123;<br>            mStartedActivity = <span class="hljs-literal">true</span>;<br>        &#125;<br>        cancelInputsAndStartExitTransition(options);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) &#123;<br>            mParent.startActivityFromChild(<span class="hljs-built_in">this</span>, intent, requestCode, options);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            mParent.startActivityFromChild(<span class="hljs-built_in">this</span>, intent, requestCode);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>startActivity</code>æ–¹æ³•ä¸­ï¼Œæ— è®ºå“ªä¸ªåˆ†æ”¯ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨ä¸‰ä¸ªå‚æ•°çš„<code>startActivityForResult</code>æ–¹æ³•ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>requestCode = -1</code>è¡¨ç¤º<code>Launcher</code>ä¸éœ€è¦çŸ¥é“<code>Activity</code>å¯åŠ¨çš„ç»“æœï¼Œç¬¬ä¸‰ä¸ªå‚æ•°åˆ™ä»£è¡¨<code>Activity</code>å¯åŠ¨çš„æ–¹å¼ã€‚</p><p>åœ¨ä¸‰ä¸ªå‚æ•°çš„<code>startActivityForResult</code>æ–¹æ³•ä¸­ï¼Œ<code>mParent</code>æ˜¯<code>Activity</code>ç±»å‹çš„ï¼Œè¡¨ç¤ºå½“å‰<code>Activity</code>çš„çˆ¶ç±»ã€‚å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬è¦å¯åŠ¨çš„åº”ç”¨ç¨‹åºçš„ç¬¬ä¸€ä¸ª<code>Activity</code>ï¼ˆä¹Ÿå°±æ˜¯æ ¹<code>Activity</code>ï¼‰è¿˜æ²¡æœ‰åˆ›å»ºå‡ºæ¥ï¼Œæ‰€ä»¥è°ƒç”¨<code>mInstrumentation</code>çš„<code>execStartActivity</code>æ–¹æ³•ï¼Œ<code>mInstrumentation</code>ä¸»è¦ç”¨æ¥ç›‘æ§åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿçš„äº¤äº’ã€‚<code>execStartActivity</code>æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="hljs-keyword">public</span> ActivityResult <span class="hljs-title function_">execStartActivity</span><span class="hljs-params">(</span><br><span class="hljs-params">    Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="hljs-params">    Intent intent, <span class="hljs-type">int</span> requestCode, Bundle options)</span> &#123;<br>    <span class="hljs-type">IApplicationThread</span> <span class="hljs-variable">whoThread</span> <span class="hljs-operator">=</span> (IApplicationThread) contextThread;<br>    <span class="hljs-type">Uri</span> <span class="hljs-variable">referrer</span> <span class="hljs-operator">=</span> target != <span class="hljs-literal">null</span> ? target.onProvideReferrer() : <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (referrer != <span class="hljs-literal">null</span>) &#123;<br>        intent.putExtra(Intent.EXTRA_REFERRER, referrer);<br>    &#125;<br>    <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ´»åŠ¨ç›‘è§†å™¨mActivityMonitors</span><br>    <span class="hljs-keyword">if</span> (mActivityMonitors != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">synchronized</span> (mSync) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> mActivityMonitors.size();<br>            <span class="hljs-comment">//éå†ç›‘è§†å™¨æŸ¥æ‰¾åŒ¹é…çš„Activity</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N; i++) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityMonitor</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> mActivityMonitors.get(i);<br>                <span class="hljs-type">ActivityResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> (am.ignoreMatchingSpecificIntents()) &#123;<br>                    result = am.onStartActivity(intent);<br>                &#125;<br>                <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>                    am.mHits++;<br>                    <span class="hljs-keyword">return</span> result;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (am.match(who, <span class="hljs-literal">null</span>, intent)) &#123;<br>                    am.mHits++;<br>                    <span class="hljs-comment">//å½“è¯¥monitoré˜»å¡activityå¯åŠ¨,åˆ™ç›´æ¥è¿”å›</span><br>                    <span class="hljs-keyword">if</span> (am.isBlocking()) &#123;<br>                        <span class="hljs-keyword">return</span> requestCode &gt;= <span class="hljs-number">0</span> ? am.getResult() : <span class="hljs-literal">null</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        intent.migrateExtraStreamToClipData();<br>        intent.prepareToLeaveProcess(who);<br>        <span class="hljs-comment">//è·å–AMSçš„ä»£ç†å¯¹è±¡å¹¶è°ƒç”¨startActivityæ–¹æ³•</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ActivityManager.getService()<br>            .startActivity(whoThread, who.getBasePackageName(), intent,<br>                           intent.resolveTypeIfNeeded(who.getContentResolver()),<br>                           token, target != <span class="hljs-literal">null</span> ? target.mEmbeddedID : <span class="hljs-literal">null</span>,<br>                           requestCode, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, options);<br>        <span class="hljs-comment">//æ£€æŸ¥Activityçš„å¯åŠ¨ç»“æœ</span><br>        checkStartActivityResult(result, intent);<br>    &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Failure from system&quot;</span>, e);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆé€šè¿‡æ´»åŠ¨ç›‘è§†å™¨æ£€æŸ¥æ­£åœ¨å¯åŠ¨çš„<code>Activity</code>æ˜¯å¦å—ç›‘è§†æˆ–æ‹¦æˆªï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨<code>ActivityManager</code>çš„<code>getService</code>æ–¹æ³•è·å¾—<code>AMS</code>çš„ä»£ç†å¯¹è±¡ï¼Œæ¥ç€è°ƒç”¨<code>startActivity</code>æ–¹æ³•ã€‚</p><p>é¦–å…ˆçœ‹<code>getService</code>æ–¹æ³•åšäº†ä»€ä¹ˆï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityManager.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IActivityManager <span class="hljs-title function_">getService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> IActivityManagerSingleton.get();<br>&#125;<br><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>&lt;IActivityManager&gt;() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> IActivityManager <span class="hljs-title function_">create</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">IBinder</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> ServiceManager.getService(Context.ACTIVITY_SERVICE);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">IActivityManager</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> IActivityManager.Stub.asInterface(b);<br>        <span class="hljs-keyword">return</span> am;<br>    &#125;<br>&#125;;<br><br><br><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/util/Singleton.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">private</span> T mInstance;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">create</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-literal">null</span>) &#123;<br>                mInstance = create();<br>            &#125;<br>            <span class="hljs-keyword">return</span> mInstance;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>getService</code>æ–¹æ³•è°ƒç”¨äº†<code>IActivityManagerSingleton</code>çš„<code>get</code>æ–¹æ³•ï¼Œè€Œ<code>IActivityManagerSingleton</code>æ˜¯ä¸€ä¸ª<code>Singleton</code>ç±»ï¼Œè¿™ä¸ªç±»ä¸­<code>get</code>æ–¹æ³•è°ƒç”¨äº†<code>create</code>æ–¹æ³•ã€‚å®ƒåœ¨åˆ›å»ºçš„æ—¶å€™é‡å†™äº†<code>create</code>æ–¹æ³•ï¼Œé€šè¿‡<code>getService</code>æ–¹æ³•è·å–åä¸º â€œactivityâ€ çš„<code>Service</code>å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯<code>IBinder</code>ç±»å‹çš„<code>AMS</code>å¼•ç”¨ï¼Œæ¥ç€å°†å®ƒè½¬æ¢æˆ<code>IActivityManager</code>ç±»å‹çš„å¯¹è±¡ï¼ˆé‡‡ç”¨çš„æ˜¯<code>AIDL</code>ï¼Œ<code>IActivityManager.java</code>ç±»æ˜¯ç”±<code>AIDL</code>å·¥å…·ç¼–è¯‘<code>IActivityManager.aidl</code>æ—¶ç”Ÿæˆçš„ï¼‰ã€‚<code>AIDL</code>çš„ä½œç”¨æ˜¯å®ç°è·¨è¿›ç¨‹é€šä¿¡(<code>IPC</code>)ï¼Œåœ¨è¿™é‡Œæ˜¯å»ºç«‹æœåŠ¡ç«¯<code>AMS</code>å’Œå®¢æˆ·ç«¯<code>Launcher</code>ä¹‹é—´çš„é€šä¿¡ã€‚</p><p>å›åˆ°<code>Instrumentation.java</code>ï¼Œæ¥ä¸‹æ¥æ˜¯è°ƒç”¨<code>startActivity</code>æ–¹æ³•ã€‚</p><h2 id="2-2-AMS-åˆ°-ApplicationThread-çš„è°ƒç”¨è¿‡ç¨‹"><a href="#2-2-AMS-åˆ°-ApplicationThread-çš„è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="2.2 AMS åˆ° ApplicationThread çš„è°ƒç”¨è¿‡ç¨‹"></a>2.2 AMS åˆ° ApplicationThread çš„è°ƒç”¨è¿‡ç¨‹</h2><p><code>Launcher</code>è¯·æ±‚<code>AMS</code>åï¼Œä»£ç é€»è¾‘è¿›å…¥åˆ°<code>AMS</code>ä¸­ï¼Œ <code>AMS</code>çš„ <code>startActivity</code>æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(IApplicationThread caller, String callingPackage,</span><br><span class="hljs-params">                               Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="hljs-type">int</span> requestCode,</span><br><span class="hljs-params">                               <span class="hljs-type">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> &#123;<br>    <span class="hljs-keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,<br>                               resultWho, requestCode, startFlags, profilerInfo, bOptions,<br>                               UserHandle.getCallingUserId());<br>&#125;<br><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityAsUser</span><span class="hljs-params">(IApplicationThread caller, String callingPackage,</span><br><span class="hljs-params">                                     Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="hljs-type">int</span> requestCode,</span><br><span class="hljs-params">                                     <span class="hljs-type">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="hljs-type">int</span> userId)</span> &#123;<br>    <span class="hljs-comment">//åˆ¤æ–­è°ƒç”¨è€…è¿›ç¨‹æ˜¯å¦è¢«éš”ç¦»</span><br>    enforceNotIsolatedCaller(<span class="hljs-string">&quot;startActivity&quot;</span>);<br>    <span class="hljs-comment">//æ£€æŸ¥è°ƒç”¨è€…æƒé™</span><br>    userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),<br>                                                userId, <span class="hljs-literal">false</span>, ALLOW_FULL_ONLY, <span class="hljs-string">&quot;startActivity&quot;</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Switch to user app stacks here.</span><br>    <span class="hljs-keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="hljs-number">1</span>, callingPackage, intent,<br>                                                 resolvedType, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, resultTo, resultWho, requestCode, startFlags,<br>                                                 profilerInfo, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, bOptions, <span class="hljs-literal">false</span>, userId, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>,<br>                                                 <span class="hljs-string">&quot;startActivityAsUser&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ <code>startActivity</code>æ–¹æ³•ç›¸æ¯”ï¼Œ <code>startActivityAsUser</code>æ–¹æ³•çš„å‚æ•°å¤šäº†ä¸€ä¸ª<code>UserHandle.getCallingUserId()</code>ï¼Œæ­¤æ–¹æ³•ç”¨äºè·å–è°ƒç”¨è€…çš„<code>UserId</code>ã€‚æ¥ç€åœ¨<code>startActivityAsUser</code>æ–¹æ³•ä¸­ï¼Œæ£€æŸ¥è°ƒç”¨è€…è¿›ç¨‹æ˜¯å¦è¢«éš”ç¦»ï¼Œä»¥åŠè°ƒç”¨è€…æƒé™ï¼Œæœ€åè°ƒç”¨<code>startActivityMayWait</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</span><br><span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityMayWait</span><span class="hljs-params">(IApplicationThread caller, <span class="hljs-type">int</span> callingUid,</span><br><span class="hljs-params">                               String callingPackage, Intent intent, String resolvedType,</span><br><span class="hljs-params">                               IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">                               IBinder resultTo, String resultWho, <span class="hljs-type">int</span> requestCode, <span class="hljs-type">int</span> startFlags,</span><br><span class="hljs-params">                               ProfilerInfo profilerInfo, WaitResult outResult,</span><br><span class="hljs-params">                               Configuration globalConfig, Bundle bOptions, <span class="hljs-type">boolean</span> ignoreTargetSecurity, <span class="hljs-type">int</span> userId,</span><br><span class="hljs-params">                               IActivityContainer iContainer, TaskRecord inTask, String reason)</span> &#123;<br>    ......<br>    <span class="hljs-comment">//åˆ›å»ºæ–°çš„Intentå¯¹è±¡ï¼Œå³ä¾¿intentè¢«ä¿®æ”¹ä¹Ÿä¸å—å½±å“</span><br>    intent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(intent);<br><br>    <span class="hljs-comment">//æ”¶é›†Intentæ‰€æŒ‡å‘çš„Activityä¿¡æ¯, å½“å­˜åœ¨å¤šä¸ªå¯ä¾›é€‰æ‹©çš„Activity,åˆ™ç›´æ¥å‘ç”¨æˆ·å¼¹å‡ºresolveActivity</span><br>    <span class="hljs-type">ActivityInfo</span> <span class="hljs-variable">aInfo</span> <span class="hljs-operator">=</span> resolveActivity(intent, resolvedType, startFlags, profilerInfo, userId);<br>......<br>    <span class="hljs-keyword">synchronized</span> (mService) &#123;<br>        ......<br>        <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> startActivityLocked(caller, intent, ephemeralIntent, resolvedType,<br>                                      aInfo, rInfo, voiceSession, voiceInteractor,<br>                                      resultTo, resultWho, requestCode, callingPid,<br>                                      callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,<br>                                      options, ignoreTargetSecurity, componentSpecified, outRecord, container,<br>                                      inTask, reason);<br><br>......<br><br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">startActivityLocked</span><span class="hljs-params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span><br><span class="hljs-params">                        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span><br><span class="hljs-params">                        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">                        IBinder resultTo, String resultWho, <span class="hljs-type">int</span> requestCode, <span class="hljs-type">int</span> callingPid, <span class="hljs-type">int</span> callingUid,</span><br><span class="hljs-params">                        String callingPackage, <span class="hljs-type">int</span> realCallingPid, <span class="hljs-type">int</span> realCallingUid, <span class="hljs-type">int</span> startFlags,</span><br><span class="hljs-params">                        ActivityOptions options, <span class="hljs-type">boolean</span> ignoreTargetSecurity, <span class="hljs-type">boolean</span> componentSpecified,</span><br><span class="hljs-params">                        ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span><br><span class="hljs-params">                        TaskRecord inTask, String reason)</span> &#123;<br><span class="hljs-comment">//åˆ¤æ–­å¯åŠ¨ç†ç”±æ˜¯å¦ä¸ºç©º</span><br>    <span class="hljs-keyword">if</span> (TextUtils.isEmpty(reason)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Need to specify a reason.&quot;</span>);<br>    &#125;<br>    mLastStartReason = reason;<br>    mLastStartActivityTimeMs = System.currentTimeMillis();<br>    mLastStartActivityRecord[<span class="hljs-number">0</span>] = <span class="hljs-literal">null</span>;<br><br>    mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType,<br>                                             aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,<br>                                             callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,<br>                                             options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,<br>                                             container, inTask);<br><br>    <span class="hljs-keyword">if</span> (outActivity != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// mLastStartActivityRecord[0] is set in the call to startActivity above.</span><br>        outActivity[<span class="hljs-number">0</span>] = mLastStartActivityRecord[<span class="hljs-number">0</span>];<br>    &#125;<br>    <span class="hljs-keyword">return</span> mLastStartActivityResult;<br>&#125;<br><br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span><br><span class="hljs-params">                          String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span><br><span class="hljs-params">                          IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">                          IBinder resultTo, String resultWho, <span class="hljs-type">int</span> requestCode, <span class="hljs-type">int</span> callingPid, <span class="hljs-type">int</span> callingUid,</span><br><span class="hljs-params">                          String callingPackage, <span class="hljs-type">int</span> realCallingPid, <span class="hljs-type">int</span> realCallingUid, <span class="hljs-type">int</span> startFlags,</span><br><span class="hljs-params">                          ActivityOptions options, <span class="hljs-type">boolean</span> ignoreTargetSecurity, <span class="hljs-type">boolean</span> componentSpecified,</span><br><span class="hljs-params">                          ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span><br><span class="hljs-params">                          TaskRecord inTask)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> ActivityManager.START_SUCCESS;<br>    <span class="hljs-comment">// Pull the optional Ephemeral Installer-only bundle out of the options early.</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Bundle</span> <span class="hljs-variable">verificationBundle</span><br>        <span class="hljs-operator">=</span> options != <span class="hljs-literal">null</span> ? options.popAppVerificationBundle() : <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">callerApp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (caller != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//è·å¾—Launcherè¿›ç¨‹</span><br>        callerApp = mService.getRecordForAppLocked(caller);<br>        <span class="hljs-keyword">if</span> (callerApp != <span class="hljs-literal">null</span>) &#123;<br>            callingPid = callerApp.pid;<br>            callingUid = callerApp.info.uid;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Slog.w(TAG, <span class="hljs-string">&quot;Unable to find app for caller &quot;</span> + caller<br>                   + <span class="hljs-string">&quot; (pid=&quot;</span> + callingPid + <span class="hljs-string">&quot;) when starting: &quot;</span><br>                   + intent.toString());<br>            err = ActivityManager.START_PERMISSION_DENIED;<br>        &#125;<br>    &#125;<br><br>    ......<br><span class="hljs-comment">//åˆ›å»ºå³å°†è¦å¯åŠ¨çš„Activityçš„æè¿°ç±»ActivityRecord</span><br>    <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityRecord</span>(mService, callerApp, callingPid, callingUid,<br>                                          callingPackage, intent, resolvedType, aInfo, mService.getGlobalConfiguration(),<br>                                          resultRecord, resultWho, requestCode, componentSpecified, voiceSession != <span class="hljs-literal">null</span>,<br>                                          mSupervisor, container, options, sourceRecord);<br>    <span class="hljs-keyword">if</span> (outActivity != <span class="hljs-literal">null</span>) &#123;<br>        outActivity[<span class="hljs-number">0</span>] = r;<br>    &#125;<br>......<br><br>    doPendingActivityLaunchesLocked(<span class="hljs-literal">false</span>);<br><br>    <span class="hljs-keyword">return</span> startActivity(r, sourceRecord, voiceSession, voiceInteractor, startFlags, <span class="hljs-literal">true</span>,<br>                         options, inTask, outActivity);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>startActivityMayWait</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨<code>startActivityLocked</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…ˆåˆ¤æ–­äº†ä¸€ä¸‹å¯åŠ¨ç†ç”±ï¼Œç„¶åè°ƒç”¨<code>startActivity</code>æ–¹æ³•ï¼ˆæ€ä¹ˆè¿™ä¹ˆå¤šåŒåæ–¹æ³•å•Šï¼ï¼‰ã€‚è¯¥æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†<code>mService.getRecordForAppLocked(caller)</code>è·å¾—ä»£è¡¨<code>Launcher</code>è¿›ç¨‹çš„<code>callerApp</code>å¯¹è±¡ï¼Œå®ƒæ˜¯<code>ProcessRecord</code>ç±»å‹çš„ï¼Œ<code>ProcessRecord</code>ç”¨äºæè¿°ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚å‚æ•°<code>caller</code>æ˜¯ä¸€è·¯ä¼ è¿‡æ¥çš„ï¼ŒæŒ‡å‘çš„æ˜¯<code>Launcher</code>æ‰€åœ¨çš„åº”ç”¨ç¨‹åºè¿›ç¨‹çš„<code>AppliactionThread</code>å¯¹è±¡ã€‚</p><p>åŒæ ·åœ°ï¼Œ<code>ActivityRecord</code>ç”¨äºæè¿°ä¸€ä¸ª<code>Activity</code>ï¼Œè®°å½•å…¶æ‰€ç”¨ä¿¡æ¯ã€‚<code>ActivityRecord</code>æ–¹æ³•åˆ›å»ºäº†ç”¨äºæè¿°å°†è¦å¯åŠ¨çš„<code>Activity</code>ä¿¡æ¯çš„å¯¹è±¡<code>r</code>ï¼Œå¹¶å°†<code>r</code>èµ‹å€¼ç»™<code>outActivity[0]</code>ï¼Œä¸¤è€…ä½œä¸º<code>startActivity</code>æ–¹æ³•çš„å‚æ•°ä¼ é€’ä¸‹å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="hljs-params">                          IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">                          <span class="hljs-type">int</span> startFlags, <span class="hljs-type">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span><br><span class="hljs-params">                          ActivityRecord[] outActivity)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> START_CANCELED;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//å»¶è¿Ÿçª—å£å¸ƒå±€çš„æ“ä½œ</span><br>        mService.mWindowManager.deferSurfaceLayout();<br>        result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,<br>                                        startFlags, doResume, options, inTask, outActivity);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (!ActivityManager.isStartResultSuccessful(result)<br>            &amp;&amp; mStartActivity.getTask() != <span class="hljs-literal">null</span>) &#123;<br>            mStartActivity.getTask().removeActivity(mStartActivity);<br>        &#125;<br>        <span class="hljs-comment">//ç»§ç»­æ‰§è¡Œçª—å£å¸ƒå±€æ“ä½œ</span><br>        mService.mWindowManager.continueSurfaceLayout();<br>    &#125;<br><br>    postStartActivityProcessing(r, result, mSupervisor.getLastStack().mStackId,  mSourceRecord,<br>                                mTargetStack);<br><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityUnchecked</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="hljs-params">                                   IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">                                   <span class="hljs-type">int</span> startFlags, <span class="hljs-type">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span><br><span class="hljs-params">                                   ActivityRecord[] outActivity)</span> &#123;<br><br>    ......<br>    <br>    <span class="hljs-keyword">if</span> (mStartActivity.resultTo == <span class="hljs-literal">null</span> &amp;&amp; mInTask == <span class="hljs-literal">null</span> &amp;&amp; !mAddingToTask &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="hljs-number">0</span>) &#123;<br>        newTask = <span class="hljs-literal">true</span>;<br>        <span class="hljs-comment">//åˆ›å»ºæ–°çš„TaskRecord</span><br>        result = setTaskFromReuseOrCreateNewTask(taskToAffiliate, preferredLaunchStackId, topStack);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mSourceRecord != <span class="hljs-literal">null</span>) &#123;<br>        result = setTaskFromSourceRecord();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mInTask != <span class="hljs-literal">null</span>) &#123;<br>        result = setTaskFromInTask();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        setTaskToCurrentTopOrCreateNewTask();<br>    &#125;<br>    <br>    ......<br><br>    <span class="hljs-keyword">if</span> (mDoResume) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">topTaskActivity</span> <span class="hljs-operator">=</span><br>            mStartActivity.getTask().topRunningActivityLocked();<br>        <span class="hljs-keyword">if</span> (!mTargetStack.isFocusable()<br>            || (topTaskActivity != <span class="hljs-literal">null</span> &amp;&amp; topTaskActivity.mTaskOverlay<br>                &amp;&amp; mStartActivity != topTaskActivity)) &#123;<br>            <br>            mTargetStack.ensureActivitiesVisibleLocked(<span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, !PRESERVE_WINDOWS);<br>            mWindowManager.executeAppTransition();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (mTargetStack.isFocusable() &amp;&amp; !mSupervisor.isFocusedStack(mTargetStack)) &#123;<br>                mTargetStack.moveToFront(<span class="hljs-string">&quot;startActivityUnchecked&quot;</span>);<br>            &#125;<br>            mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity, mOptions);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        mTargetStack.addRecentActivityLocked(mStartActivity);<br>    &#125;<br>    mSupervisor.updateUserStackLocked(mStartActivity.userId, mTargetStack);<br><br>    mSupervisor.handleNonResizableTaskIfNeeded(mStartActivity.getTask(), preferredLaunchStackId, preferredLaunchDisplayId, mTargetStack.mStackId);<br><br>    <span class="hljs-keyword">return</span> START_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>startActivity</code>æ–¹æ³•è°ƒç”¨äº†<code>startActivityUnchecked</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦æ˜¯å¤„ç†ä¸<code>Activity</code>æ ˆç®¡ç†ç›¸å…³çš„é€»è¾‘ã€‚åœ¨ 2.1 ä¸­çš„ <code>startActivitySafely</code>æ–¹æ³•ï¼Œé‡Œé¢è®¾ç½®<code>Intent</code>çš„<code>Flag</code>ä¸º<code>FLAG_ACTIVITY_NEW_TASK</code>ã€‚æ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨<code>setTaskFromReuseOrCreateNewTask</code>æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„<code>TaskRecord</code>ç”¨äºæè¿°<code>Activity</code>æ ˆã€‚ä¹‹åä¼šè°ƒç”¨<code>resumeFocusedStackTopActivityLocked</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeFocusedStackTopActivityLocked</span><span class="hljs-params">(</span><br><span class="hljs-params">    ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> &#123;<br>    <span class="hljs-comment">//åˆ¤æ–­ç›®æ ‡Activityæ ˆæ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”ç›®æ ‡Activityæ ˆæ˜¯å¦ä¸ºç„¦ç‚¹Activityæ ˆï¼ˆç”¨æˆ·å½“å‰æ­£åœ¨ä¸ä¹‹äº¤äº’çš„ä»»åŠ¡çš„Activityæ ˆï¼‰</span><br>    <span class="hljs-keyword">if</span> (targetStack != <span class="hljs-literal">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;<br>        <span class="hljs-comment">//æ¢å¤ç„¦ç‚¹Activityæ ˆçš„é¡¶éƒ¨æ´»åŠ¨</span><br>        <span class="hljs-keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);<br>    &#125;<br>    <span class="hljs-comment">//è·å–å½“å‰ç„¦ç‚¹Activityæ ˆçš„é¡¶éƒ¨æ­£åœ¨è¿è¡Œçš„Activity</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> mFocusedStack.topRunningActivityLocked();<br>    <span class="hljs-comment">//è·å¾—åˆ°çš„ActivityRecordä¸ºç©ºæˆ–è€…ä¸å¤„äºRESUMEDçŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span> || r.state != RESUMED) &#123;<br>        <span class="hljs-comment">//æ¢å¤ç„¦ç‚¹Activityæ ˆçš„é¡¶éƒ¨æ´»åŠ¨</span><br>        mFocusedStack.resumeTopActivityUncheckedLocked(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r.state == RESUMED) &#123;<br>        mFocusedStack.executeAppTransition(targetOptions);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>èµ°åˆ°è¿™ä¸€æ­¥ï¼Œæ–°<code>Activity</code>æ ˆå·²ç»åˆ›å»ºå¥½äº†ï¼Œä½†æ˜¯<code>Activity</code>è¿˜æ²¡åˆ›å»ºå¥½ï¼Œæ‰€ä»¥è°ƒç”¨åä¸€ä¸ª<code>resumeTopActivityUncheckedLocked</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeTopActivityUncheckedLocked</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options)</span> &#123;<br>    <span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é€’å½’æ‰§è¡ŒresumeTopActivityInnerLockedæ–¹æ³•ï¼Œé¿å…è¿›ä¸€æ­¥é€’å½’è°ƒç”¨</span><br>    <span class="hljs-keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;<br>        <span class="hljs-comment">// Don&#x27;t even start recursing.</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//é˜²æ­¢é€’å½’è°ƒç”¨ï¼Œå°†mStackSupervisor.inResumeTopActivityæ ‡å¿—è®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºæ­£åœ¨æ¢å¤æ ˆé¡¶æ´»åŠ¨</span><br>        mStackSupervisor.inResumeTopActivity = <span class="hljs-literal">true</span>;<br>        result = resumeTopActivityInnerLocked(prev, options);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-comment">//å°†mStackSupervisor.inResumeTopActivityæ ‡å¿—é‡æ–°è®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºæ¢å¤é¡¶éƒ¨æ´»åŠ¨çš„è¿‡ç¨‹ç»“æŸ</span><br>        mStackSupervisor.inResumeTopActivity = <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    mStackSupervisor.checkReadyForSleepLocked();<br><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeTopActivityInnerLocked</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options)</span> &#123;<br>    ......    <br>    mStackSupervisor.startSpecificActivityLocked(next, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br><br><span class="hljs-keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>resumeTopActivityUncheckedLocked</code>æ–¹æ³•ä¸­ï¼Œæ ¹æ®<code>mStackSupervisor.inResumeTopActivity</code>æ ‡å¿—æ¥é˜²æ­¢é€’å½’è°ƒç”¨<code>resumeTopActivityInnerLocked</code>æ–¹æ³•ï¼Œä¹‹åè°ƒç”¨<code>resumeTopActivityInnerLocked</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä»£ç å·¨å¤šï¼Œä¸»è¦å…³æ³¨<code>startSpecificActivityLocked</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">startSpecificActivityLocked</span><span class="hljs-params">(ActivityRecord r,</span><br><span class="hljs-params">                                 <span class="hljs-type">boolean</span> andResume, <span class="hljs-type">boolean</span> checkConfig)</span> &#123;<br>    <span class="hljs-comment">//è·å–å³å°†å¯åŠ¨çš„Activityçš„æ‰€åœ¨çš„åº”ç”¨ç¨‹åºè¿›ç¨‹</span><br>    <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> mService.getProcessRecordLocked(r.processName, r.info.applicationInfo.uid, <span class="hljs-literal">true</span>);<br>    r.getStack().setLaunchTime(r);<br><span class="hljs-comment">//å¦‚æœè¦å¯åŠ¨çš„Activityæ‰€åœ¨çš„åº”ç”¨ç¨‹åºè¿›ç¨‹å·²ç»è¿è¡Œ</span><br>    <span class="hljs-keyword">if</span> (app != <span class="hljs-literal">null</span> &amp;&amp; app.thread != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="hljs-number">0</span> || !<span class="hljs-string">&quot;android&quot;</span>.equals(r.info.packageName)) &#123;<br>                app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode, mService.mProcessStats);<br>            &#125;<br>            realStartActivityLocked(r, app, andResume, checkConfig);<br>            <span class="hljs-keyword">return</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            Slog.w(TAG, <span class="hljs-string">&quot;Exception when starting activity &quot;</span> + r.intent.getComponent().flattenToShortString(), e);<br>        &#125;<br>    &#125;<br><span class="hljs-comment">//åº”ç”¨ç¨‹åºæ²¡æœ‰è¿è¡Œæˆ–è€…æ²¡æœ‰æœ‰æ•ˆçš„è¿›ç¨‹çº¿ç¨‹,è°ƒç”¨startProcessLockedæ–¹æ³•å¯åŠ¨ç›®æ ‡æ´»åŠ¨æ‰€å±çš„è¿›ç¨‹</span><br>    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="hljs-literal">true</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;activity&quot;</span>, r.intent.getComponent(), <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>startSpecificActivityLocked</code>æ–¹æ³•ä¸­ï¼Œå…ˆé€šè¿‡<code>getProcessRecordLocked</code>æ–¹æ³•è·å¾—å³å°†å¯åŠ¨çš„Activityçš„æ‰€åœ¨çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œæ¥ç€åˆ¤æ–­å¾—åˆ°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹æ˜¯å¦å·²ç»è¿è¡Œäº†ï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œï¼Œåˆ™è°ƒç”¨<code>startProcessLocked</code>æ–¹æ³•ï¼Œæ²¿ç€æ­¤æ–¹æ³•ç»§ç»­ä¸‹å»ï¼Œå°±æ˜¯<a href="https://gal2xy.github.io/2023/07/17/Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B(%E4%B8%80)">åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨æµç¨‹</a>äº†ã€‚å¦‚æœè¿è¡Œäº†ï¼Œå°±è°ƒç”¨<code>realStartActivityLocked</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</span><br><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">realStartActivityLocked</span><span class="hljs-params">(ActivityRecord r, ProcessRecord app,</span><br><span class="hljs-params">                                      <span class="hljs-type">boolean</span> andResume, <span class="hljs-type">boolean</span> checkConfig)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    ......<br><br>        app.thread.scheduleLaunchActivity(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(r.intent), r.appToken,<br>                                          System.identityHashCode(r), r.info,<br>                                          mergedConfiguration.getGlobalConfiguration(),<br>                                          mergedConfiguration.getOverrideConfiguration(), r.compat,<br>                                          r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,<br>                                          r.persistentState, results, newIntents, !andResume,<br>                                          mService.isNextTransitionForward(), profilerInfo);<br><br>        ......<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>app</code>æŒ‡ä¼ å…¥çš„è¦å¯åŠ¨çš„<code>Activity</code>æ‰€åœ¨çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œ <code>app.thread</code>æŒ‡<code>IApplicationThread</code>ï¼Œå®ƒçš„å®ç°æ˜¯<code>ActivityThread</code>çš„å†…éƒ¨ç±»<code>AppliactionThread</code>ï¼Œè¿™ä¸ªç±»åˆæ˜¯ç»§æ‰¿<code>IApplicationThread.Stub</code>çš„ã€‚</p><p><code>realStartActivityLocked</code>æ–¹æ³•ä¸»è¦æ˜¯è°ƒç”¨<code>scheduleLaunchActivity</code>æ–¹æ³•ï¼Œå°†å¯åŠ¨<code>Activity</code>çš„è¯·æ±‚å‘é€ç»™åº”ç”¨ç¨‹åºæ‰€åœ¨çš„è¿›ç¨‹ã€‚å½“å‰ä»£ç é€»è¾‘è¿è¡Œåœ¨<code>AMS</code>æ‰€åœ¨çš„è¿›ç¨‹ï¼ˆ<code>SystemServer</code>è¿›ç¨‹ï¼‰ä¸­ï¼Œé€šè¿‡<code>ApplicationThread</code>æ¥ä¸åº”ç”¨ç¨‹åºè¿›ç¨‹è¿›è¡Œ<code>Binder</code>é€šä¿¡ï¼Œå³<code>ApplicationThread</code>æ˜¯<code>AMS</code>æ‰€åœ¨çš„è¿›ç¨‹å’Œåº”ç”¨ç¨‹åºè¿›ç¨‹çš„é€šä¿¡æ¡¥æ¢ã€‚</p><h2 id="2-3-ActivityThreadå¯åŠ¨Activityçš„è¿‡ç¨‹"><a href="#2-3-ActivityThreadå¯åŠ¨Activityçš„è¿‡ç¨‹" class="headerlink" title="2.3 ActivityThreadå¯åŠ¨Activityçš„è¿‡ç¨‹"></a>2.3 ActivityThreadå¯åŠ¨Activityçš„è¿‡ç¨‹</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« é‡Œè®²è¿‡ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹åˆ›å»ºåä¼šè¿è¡Œä»£è¡¨ä¸»çº¿ç¨‹çš„å®ä¾‹<code>ActivityThread</code>ï¼Œå®ƒç®¡ç†è€…å½“å‰åº”ç”¨ç¨‹åºè¿›ç¨‹çš„ä¸»çº¿ç¨‹ã€‚  <code>scheduleLaunchActivity</code>æ–¹æ³•å°±æ˜¯åœ¨<code>AppliactionThread</code>ç±»ä¸­çš„ï¼Œè¯¥ç±»åˆæ˜¯<code>ActivityThread</code>çš„å†…éƒ¨ç±»ã€‚æ‰€ä»¥ä»£ç é€»è¾‘ç»ˆäºè¿›å…¥åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ã€‚<code>scheduleLaunchActivity</code>è¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleLaunchActivity</span><span class="hljs-params">(Intent intent, IBinder token, <span class="hljs-type">int</span> ident,</span><br><span class="hljs-params">                                         ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span><br><span class="hljs-params">                                         CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">                                         <span class="hljs-type">int</span> procState, Bundle state, PersistableBundle persistentState,</span><br><span class="hljs-params">                                         List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span><br><span class="hljs-params">                                         <span class="hljs-type">boolean</span> notResumed, <span class="hljs-type">boolean</span> isForward, ProfilerInfo profilerInfo)</span> &#123;<br><span class="hljs-comment">//æ›´æ–°è¿›ç¨‹çš„çŠ¶æ€</span><br>    updateProcessState(procState, <span class="hljs-literal">false</span>);<br><span class="hljs-comment">//å°†è¦å¯åŠ¨çš„Activityçš„å‚æ•°å°è£…æˆActivityClientRecord</span><br>    <span class="hljs-type">ActivityClientRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityClientRecord</span>();<br>    r.token = token;<br>    ......<br>    <span class="hljs-comment">//æ›´æ–°è¦è¦å¯åŠ¨Activityçš„é…ç½®</span><br>    updatePendingConfiguration(curConfig);<br><span class="hljs-comment">//å‘Hç±»å‘é€ç±»å‹ä¸ºLAUNCH_ACTIVITYçš„æ¶ˆæ¯</span><br>    sendMessage(H.LAUNCH_ACTIVITY, r);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>scheduleLaunchActivity</code>æ–¹æ³•å°†ä¼ å…¥çš„å‚æ•°å°è£…æˆ<code>ActivityClientRecord</code>å¯¹è±¡ï¼Œ<code>sendMessage</code>æ–¹æ³•å‘<code>H</code>ç±»å‘é€ç±»å‹ä¸º<code>LAUNCH_ACTIVITY</code>çš„æ¶ˆæ¯ï¼Œå¹¶å°†<code>ActivityClientRecord</code>ä¼ é€’è¿‡å»ã€‚<code>sendMessage</code>æ–¹æ³•æœ‰å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œè°ƒç”¨åˆ°çš„å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(<span class="hljs-type">int</span> what, Object obj)</span> &#123;<br>    sendMessage(what, obj, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<br>&#125;<br><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(<span class="hljs-type">int</span> what, Object obj, <span class="hljs-type">int</span> arg1, <span class="hljs-type">int</span> arg2, <span class="hljs-type">boolean</span> async)</span> &#123;<br>    <span class="hljs-keyword">if</span> (DEBUG_MESSAGES) <br>        Slog.v(TAG, <span class="hljs-string">&quot;SCHEDULE &quot;</span> + what + <span class="hljs-string">&quot; &quot;</span> + mH.codeToString(what) + <span class="hljs-string">&quot;: &quot;</span> + arg1 + <span class="hljs-string">&quot; / &quot;</span> + obj);<br><span class="hljs-comment">//è·å–æ¶ˆæ¯å®ä¾‹</span><br>    <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain();<br>    msg.what = what;<br>    msg.obj = obj;<br>    msg.arg1 = arg1;<br>    msg.arg2 = arg2;<br>    <span class="hljs-comment">//æ˜¯å¦æ˜¯å¼‚æ­¥æ¶ˆæ¯</span><br>    <span class="hljs-keyword">if</span> (async) &#123;<br>        msg.setAsynchronous(<span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-comment">//è°ƒç”¨æ¶ˆæ¯å¤„ç†ç¨‹åºï¼ˆmHï¼‰çš„sendMessageæ–¹æ³•å°†æ¶ˆæ¯å‘é€å‡ºå»</span><br>    mH.sendMessage(msg);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>mH</code>æ˜¯<code>H</code>ç±»ï¼Œå®ƒæ˜¯<code>ActivityThread</code>çš„å†…éƒ¨ç±»å¹¶ç»§æ‰¿è‡ª<code>Handler</code>ï¼Œæ˜¯åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ä¸»çº¿ç¨‹çš„æ¶ˆæ¯ç®¡ç†ç±»ã€‚å› ä¸º<code>ApplicationThread</code>æ˜¯ä¸€ä¸ª<code>Binder</code>ï¼Œå®ƒçš„è°ƒç”¨é€»è¾‘è¿è¡Œåœ¨<code>Binder</code>çº¿ç¨‹æ± ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨<code>H</code>ç±»å°†ä»£ç çš„é€»è¾‘åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ä¸­ã€‚</p><p><code>sendMessage</code>æ–¹æ³•å°†æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆæ¯å¤„ç†ç¨‹åºä¼šè‡ªåŠ¨ä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯å¹¶è°ƒç”¨å¯¹åº”çš„<code>handleMessage</code>æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè¯¥æ–¹æ³•åœ¨<code>H</code>ç±»ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> &#123;<br>    <span class="hljs-keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="hljs-string">&quot;&gt;&gt;&gt; handling: &quot;</span> + codeToString(msg.what));<br>    <span class="hljs-keyword">switch</span> (msg.what) &#123;<br>        <span class="hljs-keyword">case</span> LAUNCH_ACTIVITY: &#123;<br>            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;activityStart&quot;</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityClientRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (ActivityClientRecord) msg.obj;<br><br>            r.packageInfo = getPackageInfoNoCheck(r.activityInfo.applicationInfo, r.compatInfo);<br>            handleLaunchActivity(r, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;LAUNCH_ACTIVITY&quot;</span>);<br>            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>        &#125; <span class="hljs-keyword">break</span>;<br>        ......<br>    &#125;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> msg.obj;<br>    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> SomeArgs) &#123;<br>        ((SomeArgs) obj).recycle();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="hljs-string">&quot;&lt;&lt;&lt; done: &quot;</span> + codeToString(msg.what));<br>&#125;<br></code></pre></td></tr></table></figure><p><code>handleMessage</code>å¯¹ <code>LAUNCH_ACTIVITY</code>æ¶ˆæ¯çš„å¤„ç†ä¸ºï¼šå°†å‚æ•°<code>obj</code>ï¼ˆä¹Ÿå°±æ˜¯åœ¨<code>scheduleLaunchActivity</code>æ–¹æ³•ä¸­åˆ›å»ºçš„<code>ActivityClientRecord</code>ï¼‰è½¬æˆ<code>ActivityClientRecord</code>å¯¹è±¡ï¼Œé€šè¿‡<code>getPackageInfoNoCheck</code>çš„æ–¹æ³•è·å¾—<code>LoadedApk</code>ç±»å‹çš„å¯¹è±¡å¹¶èµ‹å€¼ç»™<code>r.packageInfo</code>ã€‚</p><p>ä¸ºä»€ä¹ˆè¦è·å–<code>LoadedApk</code>å‘¢ï¼Ÿå› ä¸ºåº”ç”¨ç¨‹åºè¿›ç¨‹è¦å¯åŠ¨<code>Activity</code>æ—¶ï¼Œéœ€è¦å°†è¯¥<code>Activity</code>æ‰€å±çš„<code>APK</code>åŠ è½½è¿›æ¥ï¼Œè€Œ<code>LoadedApk</code>å°±æ˜¯ç”¨æ¥æè¿°å·²åŠ è½½çš„<code>APK</code>æ–‡ä»¶çš„ã€‚</p><p>æ¥ä¸‹æ¥è°ƒç”¨<code>handleLaunchActivity</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent, String reason)</span> &#123;<br><span class="hljs-comment">//å–æ¶ˆä¹‹å‰è®¡åˆ’çš„GC(åƒåœ¾å›æ”¶æœºåˆ¶)æ“ä½œï¼Œå› ä¸ºåº”ç”¨ç¨‹åºæ­£åœ¨é‡æ–°å˜ä¸ºæ´»åŠ¨çŠ¶æ€</span><br>    unscheduleGcIdler();<br>    mSomeActivitiesChanged = <span class="hljs-literal">true</span>;<br><span class="hljs-comment">//å¦‚æœActivityClientRecordå¯¹è±¡ä¸­åŒ…å«äº†profilerInfoï¼ˆæ€§èƒ½åˆ†æå™¨ç›¸å…³ä¿¡æ¯ï¼‰ï¼Œåˆ™å°†å…¶è®¾ç½®åˆ°mProfilerä¸­ï¼Œå¹¶å¯åŠ¨æ€§èƒ½åˆ†æå™¨</span><br>    <span class="hljs-keyword">if</span> (r.profilerInfo != <span class="hljs-literal">null</span>) &#123;<br>        mProfiler.setProfiler(r.profilerInfo);<br>        mProfiler.startProfiling();<br>    &#125;<br><br>    <span class="hljs-comment">//å¤„ç†é…ç½®å˜æ›´,ç¡®ä¿å½“å‰è¿è¡Œæ—¶ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„é…ç½®ä¿¡æ¯</span><br>    handleConfigurationChanged(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>    <span class="hljs-keyword">if</span> (localLOGV) <br>        Slog.v(TAG, <span class="hljs-string">&quot;Handling launch of &quot;</span> + r);<br><br>    <span class="hljs-comment">//åˆå§‹åŒ–çª—å£ç®¡ç†å™¨</span><br>    WindowManagerGlobal.initialize();<br><span class="hljs-comment">//æ‰§è¡ŒActivityå¯åŠ¨æµç¨‹</span><br>    <span class="hljs-type">Activity</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> performLaunchActivity(r, customIntent);<br><span class="hljs-comment">//åˆ¤æ–­Activityæ˜¯å¦å¯åŠ¨æˆåŠŸ</span><br>    <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span>) &#123;<br>        r.createdConfig = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(mConfiguration);<br>        reportSizeConfigurations(r);<br>        <span class="hljs-type">Bundle</span> <span class="hljs-variable">oldState</span> <span class="hljs-operator">=</span> r.state;<br>        <span class="hljs-comment">//å°†Activityçš„çŠ¶æ€è®¾ç½®ä¸ºResume</span><br>        handleResumeActivity(r.token, <span class="hljs-literal">false</span>, r.isForward, !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);<br>        <br>        <span class="hljs-keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;<br>            performPauseActivityIfNeeded(r, reason);<br>            <span class="hljs-keyword">if</span> (r.isPreHoneycomb()) &#123;<br>                r.state = oldState;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//åœæ­¢Activityå¯åŠ¨</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            ActivityManager.getService().finishActivity(r.token, Activity.RESULT_CANCELED, <span class="hljs-literal">null</span>, Activity.DONT_FINISH_TASK_WITH_ACTIVITY);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException ex) &#123;<br>            <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å–æ¶ˆ<code>GC</code>æ“ä½œï¼Œæ ¹æ®<code>profilerInfo</code>å†³å®šæ˜¯å¦å¯åŠ¨æ€§èƒ½åˆ†æå™¨ï¼Œç„¶åæ›´æ–°é…ç½®ï¼Œåˆå§‹åŒ–çª—å£ç®¡ç†å™¨ï¼Œè°ƒç”¨<code>performLaunchActivity</code>æ–¹æ³•å¯åŠ¨<code>Activity</code>ï¼Œå¦‚æœå¯åŠ¨æˆåŠŸï¼Œåˆ™è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼ŒåŒ…æ‹¬ä¿å­˜é…ç½®ä¿¡æ¯ã€æŠ¥å‘Š<code>Activity</code>å°ºå¯¸é…ç½®ã€å°†<code>Activity</code>çš„çŠ¶æ€è®¾ç½®ä¸º<code>Resume</code>ç­‰ã€‚å¦‚æœ<code>Activity</code>å¯åŠ¨å¤±è´¥ï¼Œåˆ™é€šçŸ¥<code>ActivityManager</code>åœæ­¢å½“å‰<code>Activity</code>ã€‚</p><p>æ¥ä¸‹æ¥çœ‹<code>performLaunchActivity</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">private</span> Activity <span class="hljs-title function_">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent)</span> &#123;<br><span class="hljs-comment">//è·å–Activityçš„ä¿¡æ¯</span><br>    <span class="hljs-type">ActivityInfo</span> <span class="hljs-variable">aInfo</span> <span class="hljs-operator">=</span> r.activityInfo;<br>    <span class="hljs-keyword">if</span> (r.packageInfo == <span class="hljs-literal">null</span>) &#123;<br>        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo, Context.CONTEXT_INCLUDE_CODE);<br>    &#125;<br><span class="hljs-comment">//è·å–componentNameï¼Œå³Activityçš„å…¨é™å®šç±»å(åŒ…åå’Œç±»å)</span><br>    <span class="hljs-type">ComponentName</span> <span class="hljs-variable">component</span> <span class="hljs-operator">=</span> r.intent.getComponent();<br>    ......<br><span class="hljs-comment">//å¯åŠ¨Activityçš„ä¸Šä¸‹æ–‡ç¯å¢ƒ(Context)</span><br>    <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> createBaseContextForActivity(r);<br>    <span class="hljs-type">Activity</span> <span class="hljs-variable">activity</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//åˆ›å»ºç±»åŠ è½½å™¨</span><br>        java.lang.<span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> appContext.getClassLoader();<br>        <span class="hljs-comment">//é€šè¿‡ç±»åŠ è½½å™¨åˆ›å»ºActivityå®ä¾‹</span><br>        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);<br><br>        StrictMode.incrementExpectedActivityCount(activity.getClass());<br>        r.intent.setExtrasClassLoader(cl);<br>        r.intent.prepareToEnterProcess();<br>        <span class="hljs-keyword">if</span> (r.state != <span class="hljs-literal">null</span>) &#123;<br>            r.state.setClassLoader(cl);<br>        &#125;<br>    &#125;<br>......<br>    <br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//åˆ›å»ºåº”ç”¨ç¨‹åºå¯¹è±¡ï¼ˆApplicationï¼‰çš„å®ä¾‹</span><br>        <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> r.packageInfo.makeApplication(<span class="hljs-literal">false</span>, mInstrumentation);<br>        ......<br><br>        <span class="hljs-keyword">if</span> (activity != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//åˆå§‹åŒ–Activity</span><br>            ......<br>            <span class="hljs-comment">//å¯¹ Activity è¿›è¡Œåˆå§‹åŒ–å’Œè¿æ¥å…³é”®ç»„ä»¶</span><br>            activity.attach(appContext, <span class="hljs-built_in">this</span>, getInstrumentation(), r.token,<br>                            r.ident, app, r.intent, r.activityInfo, title, r.parent,<br>                            r.embeddedID, r.lastNonConfigurationInstances, config,<br>                            r.referrer, r.voiceInteractor, window, r.configCallback);<br><br>            ......<br>            <span class="hljs-comment">//å¯åŠ¨Activity</span><br>            <span class="hljs-keyword">if</span> (r.isPersistable()) &#123;<br>                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                mInstrumentation.callActivityOnCreate(activity, r.state);<br>            &#125;<br>            ......<br>        &#125;<br>        r.paused = <span class="hljs-literal">true</span>;<br><br>        mActivities.put(r.token, r);<br><br>    &#125; <br>    ......<br><br>    <span class="hljs-keyword">return</span> activity;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆåšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚è·å–<code>Activity</code>çš„ä¿¡æ¯ã€è·å–<code>APK</code>æ–‡ä»¶æè¿°ä¿¡æ¯ã€è·å–ç»„ä»¶åç§°(<code>ComponentName</code>)ã€è·å–ä¸Šä¸‹æ–‡ç¯å¢ƒ(<code>Context</code>)ã€‚ç„¶åè°ƒç”¨<code>mInstrumentation</code>çš„<code>newActivity</code>æ–¹æ³•ï¼Œé€šè¿‡ç±»åŠ è½½å™¨åˆ›å»º<code>Activity</code>å®ä¾‹ã€‚</p><p>æ¥ç€æ˜¯è°ƒç”¨<code>makeApplication</code>æ–¹æ³•åˆ›å»ºåº”ç”¨ç¨‹åºå¯¹è±¡ï¼ˆ<code>Application</code>ï¼‰çš„å®ä¾‹ã€‚åœ¨ <code>Android </code>ä¸­ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ªå…¨å±€çš„ <code>Application</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­å­˜åœ¨ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºå­˜å‚¨å’Œå…±äº«åº”ç”¨ç¨‹åºçš„å…¨å±€çŠ¶æ€å’Œæ•°æ®ã€‚</p><p>ä¹‹åæ˜¯å¯¹åˆšåˆ›å»ºçš„<code>Activity</code>å®ä¾‹è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œæœ€åè°ƒç”¨<code>callActivityOnCreate</code>æ–¹æ³•å¯åŠ¨<code>Activity</code>ã€‚è¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callActivityOnCreate</span><span class="hljs-params">(Activity activity, Bundle icicle, PersistableBundle persistentState)</span> &#123;<br>    <span class="hljs-comment">//æ‰§è¡Œé¢„å¤„ç†æ“ä½œï¼Œä¾‹å¦‚è®¾å®šä¸»é¢˜æ ·å¼ã€åˆå§‹åŒ–èµ„æºç­‰</span><br>    prePerformCreate(activity);<br><span class="hljs-comment">//æ‰§è¡ŒActivityçš„åˆ›å»ºæ“ä½œ</span><br>    activity.performCreate(icicle, persistentState);<br>    <span class="hljs-comment">//æ‰§è¡Œåå¤„ç†æ“ä½œï¼Œä¾‹å¦‚æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ã€åˆå§‹åŒ–æ•°æ®ç­‰</span><br>    postPerformCreate(activity);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®æ˜¯è°ƒç”¨äº†<code>Activity</code>çš„<code>performCreate</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/Activity.java</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performCreate</span><span class="hljs-params">(Bundle icicle, PersistableBundle persistentState)</span> &#123;<br>    <span class="hljs-comment">//åœ¨Android 6.0åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œåº”ç”¨éœ€è¦åŠ¨æ€è¯·æ±‚æŸäº›æƒé™ï¼Œè¯¥æ–¹æ³•ç”¨äºæ¢å¤ä¹‹å‰çš„æƒé™è¯·æ±‚çŠ¶æ€</span><br>    restoreHasCurrentPermissionRequest(icicle);<br>    <span class="hljs-comment">//è°ƒç”¨Activityçš„å®é™…çš„onCreateæ–¹æ³•ï¼Œæ‰§è¡Œå¼€å‘è€…åœ¨Activityä¸­é‡å†™çš„onCreateæ–¹æ³•</span><br>    onCreate(icicle, persistentState);<br>    <span class="hljs-comment">//è¯»å–Activityçš„è½¬åœºçŠ¶æ€ï¼Œå³è¿‡æ¸¡åŠ¨ç”»çš„çŠ¶æ€ã€‚è¿™ä¸ªæ–¹æ³•å°†ä¹‹å‰ä¿å­˜çš„è½¬åœºçŠ¶æ€æ¢å¤åˆ°å½“å‰Activityä¸­</span><br>    mActivityTransitionState.readState(icicle);<br>    <span class="hljs-comment">//æ‰§è¡Œä¸€äº›é€šç”¨çš„åˆå§‹åŒ–æ“ä½œ</span><br>    performCreateCommon();<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>performCreate</code>æ–¹æ³•ä¸­ä¼šè°ƒç”¨<code>Activity</code>çš„å®é™…çš„<code>onCreate</code>æ–¹æ³•ï¼Œå…¶å…·ä½“çš„å®ç°æ˜¯ç”±å¼€å‘è€…æ¥é‡å†™ã€‚åˆ°æ­¤ï¼Œæ ¹<code>Activity</code>å°±å¯åŠ¨äº†ï¼Œå³åº”ç”¨ç¨‹åºå¯åŠ¨äº†ã€‚</p><h1 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h1><p>æ•´ä¸ªæµç¨‹ä¸‹æ¥éå¸¸é•¿ï¼Œæ„Ÿè§‰æœ‰ç‚¹æ‚ä¹±ï¼Œè¿™é‡Œç®€å•æ¢³ç†ä¸€ä¸‹æ•´ä¸ªåº”ç”¨ç¨‹åºå¯åŠ¨çš„æµç¨‹ï¼ˆå‡è®¾åº”ç”¨ç¨‹åºè¿›ç¨‹æ²¡æœ‰è¿è¡Œï¼‰ï¼š</p><ol><li>ç‚¹å‡»æ¡Œé¢çš„åº”ç”¨å›¾æ ‡ï¼Œ<code>Launcher</code>è¿›ç¨‹ä½¿ç”¨<code>Binder</code>ä¸<code>SystemServer</code>è¿›ç¨‹çš„<code>AMS</code>è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡(<code>IPC</code>)ï¼Œå‘èµ·<code>startActivity</code>è¯·æ±‚ã€‚</li><li><code>SystemServer</code>è¿›ç¨‹çš„<code>AMS</code>æ¥æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡<code>zygoteSendArgsAndGetResult</code>ä¸<code>zygote</code>è¿›ç¨‹è¿›è¡Œ<code>Socket</code>é€šä¿¡ï¼Œå‘é€åˆ›å»ºè¿›ç¨‹çš„è¯·æ±‚ã€‚</li><li><code>Zygote</code>è¿›ç¨‹æ¥æ”¶è¯·æ±‚åï¼Œé€šè¿‡<code>forkAndSpecialize</code>æ–¹æ³•åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œç„¶åè¿›è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–å·¥ä½œã€‚</li><li>å¯åŠ¨äº†åº”ç”¨ç¨‹åºè¿›ç¨‹åï¼Œ<code>AMS</code>é€šè¿‡<code>ApplicationThread</code>æ¥ä¸åº”ç”¨ç¨‹åºè¿›ç¨‹è¿›è¡Œ<code>Binder</code>é€šä¿¡ï¼Œå‘é€<code>scheduleLaunchActivity</code>è¯·æ±‚ã€‚</li><li>åº”ç”¨ç¨‹åºè¿›ç¨‹çš„<code>Binder</code>çº¿ç¨‹ï¼ˆ<code>ApplicationThread</code>ï¼‰æ¥æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡<code>sendMessage</code>æ–¹æ³•ä¸ä¸»çº¿ç¨‹<code>ActivityThread</code>è¿›è¡Œ<code>Handler</code>é€šä¿¡ï¼Œå‘é€ <code>LAUNCH_ACTIVITY</code>çš„æ¶ˆæ¯ã€‚</li><li>ä¸»çº¿ç¨‹<code>ActivityThread</code>æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œé€šè¿‡åå°„æœºåˆ¶åˆ›å»ºç›®æ ‡<code>Activity</code>ï¼Œå¹¶å›è°ƒ<code>Activity.onCreate()</code>ç­‰æ–¹æ³•ã€‚åˆ°æ­¤ï¼Œåº”ç”¨ç¨‹åºä¾¿æ­£å¼å¯åŠ¨ï¼Œå¼€å§‹è¿›å…¥<code>Activity</code>ç”Ÿå‘½å‘¨æœŸã€‚</li></ol><hr><p>å‚è€ƒï¼š</p><p><a href="http://liuwangshu.cn/framework/component/1-activity-start-1.html">Androidæ·±å…¥å››å¤§ç»„ä»¶ï¼ˆä¸€ï¼‰åº”ç”¨ç¨‹åºå¯åŠ¨è¿‡ç¨‹ï¼ˆå‰ç¯‡ï¼‰ | BATcoder - åˆ˜æœ›èˆ’ (liuwangshu.cn)</a></p><p><a href="http://liuwangshu.cn/framework/component/1-activity-start-2.html">Androidæ·±å…¥å››å¤§ç»„ä»¶ï¼ˆä¸€ï¼‰åº”ç”¨ç¨‹åºå¯åŠ¨è¿‡ç¨‹ï¼ˆåç¯‡ï¼‰ | BATcoder - åˆ˜æœ›èˆ’ (liuwangshu.cn)</a></p><p><a href="http://gityuan.com/2016/03/12/start-activity/">startActivityå¯åŠ¨è¿‡ç¨‹åˆ†æ - Gityuanåšå®¢ | è¢è¾‰è¾‰çš„æŠ€æœ¯åšå®¢</a></p><p><a href="https://zhuanlan.zhihu.com/p/67451239">æ­»ç£•Android_App å¯åŠ¨è¿‡ç¨‹ï¼ˆå« Activity å¯åŠ¨è¿‡ç¨‹ï¼‰ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>Androidæºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BurpSuiteæŠ“æ‰‹æœºç«¯å°ç¨‹åºåŒ…</title>
    <link href="/2023/07/21/BurpSuite%E6%8A%93%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8C%85/"/>
    <url>/2023/07/21/BurpSuite%E6%8A%93%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8C%85/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>æœ¬ç¯‡æ–‡ç« åˆ©ç”¨BurpSuite + pixel4ï¼Œå¯¹ç¾Šäº†ç¾Šå°ç¨‹åºè¿›è¡ŒæŠ“åŒ…å’Œæ”¹åŒ…ï¼Œå°è¯•é€šå…³ç¾Šäº†ç¾Šã€‚å‚è€ƒäº†ç½‘ä¸Šçš„ç›¸å…³æ–‡ç« ï¼Œä½†å¤§éƒ¨åˆ†éƒ½æ˜¯å¤±æ•ˆçš„ï¼Œå·²ç»è¢«æ¸¸æˆæ–¹ä¿®å¤äº†ã€‚</p><hr><p>å—¯ï¼Œè¿™åº”è¯¥å°±æ˜¯ä¸€ç¯‡æ°´æ–‡ï¼Œæœ›æµ·æ¶µã€‚</p><h1 id="äºŒã€å‡†å¤‡å·¥ä½œ"><a href="#äºŒã€å‡†å¤‡å·¥ä½œ" class="headerlink" title="äºŒã€å‡†å¤‡å·¥ä½œ"></a>äºŒã€å‡†å¤‡å·¥ä½œ</h1><h2 id="2-1-BurpSuiteè¯ä¹¦é…ç½®"><a href="#2-1-BurpSuiteè¯ä¹¦é…ç½®" class="headerlink" title="2.1 BurpSuiteè¯ä¹¦é…ç½®"></a>2.1 BurpSuiteè¯ä¹¦é…ç½®</h2><p>æˆ‘è¿™é‡Œç›´æ¥è®²è¿°æ€ä¹ˆåœ¨æ‰‹æœºä¸Šé…ç½®BurpSuiteè¯ä¹¦ã€‚</p><p>åœ¨[ä¸Šä¸€ç¯‡åšå®¢](<a href="https://gal2xy.github.io/2023/07/15/Pixel4%E5%88%B7Lineage">https://gal2xy.github.io/2023/07/15/Pixel4åˆ·Lineage</a> OS&#x2F;#å››ã€æ·»åŠ BurpSuiteè¯ä¹¦)ä¸­ï¼Œè®²è¿°äº†ä¸€ç§å°†è¯ä¹¦æ”¾ç½®ç³»ç»Ÿè¯ä¹¦ç›®å½•ä¸‹ã€‚ç”±äºè¯ä¹¦é…ç½®ä¸æ­£ç¡®çš„åŸå› ï¼ˆä½†åé¢æƒ³äº†æƒ³ï¼Œä¼°è®¡æ˜¯å› ä¸ºæ‰‹æœºæ—¶é—´çš„é—®é¢˜å¯¼è‡´<code>https</code>è¿æ¥å¤±è´¥ï¼‰ï¼Œè„‘å­ä¸€æŠ½ç»ï¼Œå°†æ‰‹æœºåˆ·æœºå›Android10äº†ã€‚ç„¶åå‘ç°ä¹‹å‰çš„æ–¹æ³•ä¸èƒ½ä½¿ç”¨äº†ï¼Œå› ä¸º<code>adb root</code>åœ¨è¿™éƒ¨æ‰‹æœºç³»ç»Ÿä¸Šè¢«é™åˆ¶äº†ã€‚äºæ˜¯è·Ÿç€æŠ¥é”™ä¿¡æ¯ï¼Œä¸€è·¯æŸ¥æ‰¾ï¼Œæ‰¾äº†å¤šä¸ªå·¥å…·ï¼ˆå°è¯•äº†<code>adb_root</code>ã€<code>adbd-Insecure</code>ã€<code>magisk-overlayfs</code>ã€<code>RootExplorer</code>ã€<code>movecert</code>ï¼‰ï¼Œç»ˆäºæœ‰ä¸€ä¸ªæœ‰æ•ˆçš„æœ‰ç”¨äº†æ’ä»¶<a href="https://github.com/NVISOsecurity/MagiskTrustUserCerts">AlwaysTurstUserCerts</a>ã€‚ä¹‹ååœ¨æ‰‹æœºçš„è®¾ç½®-&gt;å®‰å…¨-&gt;åŠ å¯†ä¸å‡­è¯-&gt;ä»å­˜å‚¨è®¾å¤‡å®‰è£…ï¼Œå³æ™®é€šçš„ç”¨æˆ·è¯ä¹¦å®‰è£…æµç¨‹ã€‚ç„¶åæ ¹æ®è¯ä¹¦çš„å“ˆå¸Œå€¼åœ¨ç³»ç»Ÿè¯ä¹¦ç›®å½•ä¸‹æŸ¥æ‰¾ï¼ŒæƒŠå¥‡çš„å‘ç°å­˜åœ¨äº†ï¼è€Œä¸”<code>RootExplorer</code>å·¥å…·ä¸­ä¹Ÿå…è®¸æŒ‚è½½ç³»ç»Ÿè¯ä¹¦ç›®å½•ä¸ºå¯è¯»å¯å†™äº†ï¼</p><h2 id="2-2-Edxposedå’ŒJustTrustMeå®‰è£…"><a href="#2-2-Edxposedå’ŒJustTrustMeå®‰è£…" class="headerlink" title="2.2 Edxposedå’ŒJustTrustMeå®‰è£…"></a>2.2 Edxposedå’ŒJustTrustMeå®‰è£…</h2><p>è¯ä¹¦é…ç½®å®Œåï¼Œè¿˜éœ€è¦åœ¨<code>magisk</code>ä¸Šå®‰è£…<code>JustTrustMe</code>æ’ä»¶æ¥ç»•è¿‡<code>SSL pinning</code>ï¼Œåœ¨<code>Edxposed</code>(å…¶ä»–<code>xposed</code>éƒ½è¡Œ)ä¸Šå¯åŠ¨ï¼Œä½œç”¨åŸŸé€‰æ‹©å¾®ä¿¡æˆ–è€…QQã€‚</p><h2 id="2-3-æ‰‹æœºä»£ç†åˆ°ç”µè„‘ä¸Š"><a href="#2-3-æ‰‹æœºä»£ç†åˆ°ç”µè„‘ä¸Š" class="headerlink" title="2.3 æ‰‹æœºä»£ç†åˆ°ç”µè„‘ä¸Š"></a>2.3 æ‰‹æœºä»£ç†åˆ°ç”µè„‘ä¸Š</h2><p>è¿™ä¸€æ­¥éœ€è¦æ‰‹æœºå’Œç”µè„‘å¤„åœ¨åŒä¸€ç½‘ç»œä¸­ï¼ŒæŸ¥çœ‹ç”µè„‘<code>ip</code>ï¼Œç„¶åå¯¹æ‰‹æœºè¿æ¥çš„<code>wife</code>è¿›è¡Œä»£ç†è®¾ç½®ï¼Œä»£ç†<code>ip</code>ä¸ºç”µè„‘<code>ip</code>ï¼Œç«¯å£åªè¦æ˜¯æ²¡è¢«å ç”¨çš„å°±è¡Œã€‚</p><p>ä»¥ä¸Šå‡†å¤‡å·¥ä½œä¸æƒ³ç€é‡è®²è¿°ï¼Œå®‰è£…é…ç½®çš„äº‹æƒ…éƒ½åœ¨ç½‘ç»œä¸Šæœ‰å‚è€ƒæ–‡ç« ã€‚</p><h1 id="ä¸‰ã€å¾®ä¿¡å°ç¨‹åºç¾Šäº†ç¾ŠæŠ“åŒ…æ”¹åŒ…"><a href="#ä¸‰ã€å¾®ä¿¡å°ç¨‹åºç¾Šäº†ç¾ŠæŠ“åŒ…æ”¹åŒ…" class="headerlink" title="ä¸‰ã€å¾®ä¿¡å°ç¨‹åºç¾Šäº†ç¾ŠæŠ“åŒ…æ”¹åŒ…"></a>ä¸‰ã€å¾®ä¿¡å°ç¨‹åºç¾Šäº†ç¾ŠæŠ“åŒ…æ”¹åŒ…</h1><p>åŒæ ·çš„å°ç¨‹åºåœ¨QQä¸ŠæŠ“åŒ…æ¯”è¾ƒé¡ºåˆ©ï¼Œä½†åœ¨å¾®ä¿¡ä¸Šæ—¶ç½‘ç»œå°±å·¨å¡äº†ã€‚ç›®å‰ä¸çŸ¥é“ä»€ä¹ˆåŸå› ã€‚æ‰€ä»¥è¿™é‡Œä»¥QQä¸Šçš„ç¾Šäº†ç¾Šä½œä¸ºä¾‹å­è®²è§£æŠ“åŒ…æ”¹åŒ…ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å…ˆè¿›å…¥åˆ°ç¾Šäº†ç¾Šçš„å¼€å§‹æ¸¸æˆç•Œé¢ï¼Œå…ˆä¸è¿›è¡Œæ‹¦æˆªï¼Œç‚¹å‡»æŒ‘æˆ˜è¿›å…¥æ¶ˆæ¶ˆä¹ç•Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è®¸å¤šæµé‡åŒ…ï¼Œå…¶ä¸­URLä¸º<code>/sheep/v1/game/map_info_ex</code>è¿™ä¸ªæµé‡åŒ…ï¼Œé€šè¿‡åå­—å°±å¯ä»¥çŸ¥é“æ˜¯è·å–åœ°å›¾çš„ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307210958624.jpg"></p><p>åœ¨ç›¸åº”çš„å“åº”æµé‡åŒ…ä¸­ï¼Œ<code>map_md5</code>å°±æ˜¯ç¬¬ä¸€ã€äºŒå…³çš„åœ°å›¾çš„<code>md5</code>å€¼äº†ã€‚è‡³äº<code>map_seed</code>å°±æ˜¯ç”¨äºç”Ÿæˆåœ°å›¾çš„åˆå§‹ç§å­ï¼Œä½†æˆ‘ä»¬å¹¶ä¸çŸ¥é“ç”Ÿæˆç®—æ³•ã€‚</p><hr><p>æ—¢ç„¶<code>map_md5</code>æ˜¯ç¬¬ä¸€ã€äºŒå…³çš„åœ°å›¾çš„<code>md5</code>å€¼ï¼Œé‚£å°†ç¬¬äºŒä¸ª<code>md5</code>å€¼è¦†ç›–ä¸ºç¬¬ä¸€ä¸ª<code>md5</code>å€¼ä¸å°±è¡Œäº†ï¼Ÿï¼</p><p>å°è¯•äº†ä¸€ä¸‹ï¼Œå¼€å¯æ‹¦æˆªï¼Œç­‰åˆ°å‡ºç°è¿™ä¸ªè¯·æ±‚åŒ…ï¼Œå³é”®æ‹¦æˆª-&gt;å“åº”æ­¤è¯·æ±‚ï¼Œç»§ç»­æ”¾è¡Œï¼Œç­‰åˆ°è¿™ä¸ªå“åº”åˆ°æ¥åï¼Œç¯¡æ”¹<code>map_md5</code>ï¼Œå†æ”¾è¡Œï¼Œç¡®å®å¯ä»¥ï¼Œä½†ç¼ºç‚¹æ˜¯é€šå…³äº†ä¸ä¼šåœ¨åç‰‡ä¸­æ˜¾ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307210958769.jpg"></p><p>ï¼ˆ<code>pixel4</code>æ²¡æœ‰æˆªå±åŠŸèƒ½ï¼ï¼Ÿï¼‰</p><hr><p>å½“ç„¶ï¼Œ<code>map_seed</code>ä¹Ÿä¸æ˜¯æ”¹äº†æ²¡ç”¨çš„ï¼Œå› ä¸ºæ¯•ç«Ÿæ˜¯ç”¨åˆå§‹ç§å­è¿›è¡ŒåŠ å¯†å¾—åˆ°çš„åœ°å›¾ï¼Œè€Œè¿™äº›åŠ å¯†ï¼Œå¤§æ¦‚ç‡æ˜¯ä¼šç”¨åˆ°ä½è¿ç®—çš„ï¼Œæ¯”å¦‚ä»€ä¹ˆå·¦ç§»ã€å³ç§»ã€‚å‡è®¾æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å°†ç§å­å˜å¾—ç®€å•ç‚¹ä¸å°±è¡Œäº†ï¼</p><p>å°è¯•å°†<code>map_seed</code>å…¨æ”¹ä¸º0ï¼Œç¬¬äºŒå…³çš„åœ°å›¾å¦‚ä¸‹æ‰€ç¤º</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307210958569.jpg"></p><p>ç„¶åè¿˜æ˜¯æœ‰ç‚¹éš¾ï¼Œå› ä¸ºè™½ç„¶çœ‹ç€æ•´é½ï¼Œä½†æ˜¯ä¸ªæ•°ä¸æ˜¯3çš„å€æ•°ã€‚</p><h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p>åœ¨å¯»æ‰¾å…³é”®è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä¸è¿›è¡Œæ‹¦æˆªï¼Œå…ˆåˆ†æä¸€éæ•´ä¸ªè¯·æ±‚å“åº”çš„æµé‡åŒ…ï¼Œå…¶ä¸­ä¸€äº›å¸¦å‚æ•°çš„è¯·æ±‚å¯èƒ½æ¯”è¾ƒå…³é”®ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥å°è¯•å¼€å¯æ‹¦æˆªï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªçš„æ”¾è¡Œï¼Œå¦‚æœæ‰‹æœºç«¯å› æŸä¸ªè¯·æ±‚æµé‡åŒ…çš„æ”¾è¡Œè€Œè§¦å‘äº†åŠ¨ä½œï¼Œé‚£ä¹ˆå¯ä»¥è‚¯å®šè¿™ä¸ªè¯·æ±‚æ˜¯å…³é”®çš„ã€‚æ‰¾åˆ°å…³é”®è¯·æ±‚ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™ä¸ªè¯·æ±‚çš„å‚æ•°æˆ–è€…æ‹¦æˆªå¯¹åº”çš„å“åº”ï¼Œè¿›ä¸€æ­¥æ·±å…¥å­¦ä¹ ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>æŠ“åŒ…</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidåº”ç”¨ç¨‹åºå¯åŠ¨æµç¨‹(ä¸€)</title>
    <link href="/2023/07/17/Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B(%E4%B8%80)/"/>
    <url>/2023/07/17/Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B(%E4%B8%80)/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>è¦æƒ³å¯åŠ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œé¦–å…ˆè¦ä¿è¯è¿™ä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„åº”ç”¨ç¨‹åºè¿›ç¨‹å·²ç»å¯åŠ¨ã€‚<code>Activity Manager Service(AMS)</code>åœ¨å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶ä¼šæ£€æŸ¥è¿™ä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„åº”ç”¨è¿›ç¨‹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±ä¼šè¯·æ±‚<code>Zygote</code>è¿›ç¨‹å¯åŠ¨æ‰€éœ€è¦çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚å½“åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨å®Œåï¼Œå°±ä¼šæ¥ç€å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œä¹Ÿå°±æ˜¯å¯åŠ¨æ ¹<code>Activity</code>ï¼Œè¿™éƒ¨åˆ†å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­åˆ†æã€‚æœ¬ç¯‡æ–‡ç« å°±å…ˆæ¥åˆ†æä¸€ä¸‹åº”ç”¨ç¨‹åºè¿›ç¨‹çš„å¯åŠ¨æµç¨‹ã€‚</p><h1 id="äºŒã€åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨æµç¨‹"><a href="#äºŒã€åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨æµç¨‹" class="headerlink" title="äºŒã€åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨æµç¨‹"></a>äºŒã€åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨æµç¨‹</h1><h2 id="2-1-AMSå‘é€å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚"><a href="#2-1-AMSå‘é€å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚" class="headerlink" title="2.1 AMSå‘é€å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚"></a>2.1 AMSå‘é€å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚</h2><p>å‡å®šæ­¤æ—¶å¯åŠ¨çš„åº”ç”¨ç¨‹åºæ‰€éœ€çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸å­˜åœ¨ï¼Œåˆ™<code>AMS</code>ä¼šé€šè¿‡<code>startProcessLocked</code>æ–¹æ³•å‘<code>Zygote</code>è¿›ç¨‹å‘é€è¯·æ±‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(ProcessRecord app, String hostingType, String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> &#123;<br>    ......<br>    <span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//è®¾ç½®å„ä¸ªå‚æ•°çš„å€¼ï¼Œå¦‚uidã€gidsã€debugFlagsã€entryPointç­‰</span><br>        ......<br>        <br>        ProcessStartResult startResult;<br>        <span class="hljs-keyword">if</span> (hostingType.equals(<span class="hljs-string">&quot;webview_service&quot;</span>)) &#123;<br>            startResult = startWebView(entryPoint,<br>                                       app.processName, uid, uid, gids, debugFlags, mountExternal,<br>                                       app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,<br>                                       app.info.dataDir, <span class="hljs-literal">null</span>, entryPointArgs);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹</span><br>            startResult = Process.start(entryPoint,<br>                                        app.processName, uid, uid, gids, debugFlags, mountExternal,<br>                                        app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,<br>                                        app.info.dataDir, invokeWith, entryPointArgs);<br>        &#125;<br>        ......<br>    &#125; <span class="hljs-keyword">catch</span> (RuntimeException e) &#123;<br>    ......    <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å…ˆå¯¹æ‰€éœ€è¦çš„å‚æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ä¸­<code>entryPoint</code>æˆ‘ä»¬å¾—çŸ¥æ˜¯<code>android.app.ActivityThread</code>ï¼Œåæ–‡ä¼šå†æ¬¡æåˆ°å®ƒã€‚ç„¶ååˆ¤æ–­<code>hostingType</code>ï¼ˆæ˜¯ä¸ªå•¥å˜ï¼Ÿï¼‰æ˜¯å¦æ˜¯<code>webview_service</code>ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨<code>startWebView</code>æ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨<code>Process.start</code>æ–¹æ³•å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚è¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/os/Process.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ProcessStartResult <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String processClass,</span><br><span class="hljs-params">                                             <span class="hljs-keyword">final</span> String niceName,</span><br><span class="hljs-params">                                             <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-type">int</span>[] gids,</span><br><span class="hljs-params">                                             <span class="hljs-type">int</span> debugFlags, <span class="hljs-type">int</span> mountExternal,</span><br><span class="hljs-params">                                             <span class="hljs-type">int</span> targetSdkVersion,</span><br><span class="hljs-params">                                             String seInfo,</span><br><span class="hljs-params">                                             String abi,</span><br><span class="hljs-params">                                             String instructionSet,</span><br><span class="hljs-params">                                             String appDataDir,</span><br><span class="hljs-params">                                             String invokeWith,</span><br><span class="hljs-params">                                             String[] zygoteArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> zygoteProcess.start(processClass, niceName, uid, gid, gids,<br>                               debugFlags, mountExternal, targetSdkVersion, seInfo,<br>                               abi, instructionSet, appDataDir, invokeWith, zygoteArgs);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å¹¶æ²¡æœ‰å®ç°åŠŸèƒ½ï¼Œè€Œæ˜¯è°ƒç”¨äº†<code>zygoteProcess.start</code>æ–¹æ³•æ¥å®ç°ï¼Œ<code>zygoteProcess</code>ç”¨æ¥ä¿æŒä¸<code>Zygote</code>è¿›ç¨‹çš„é€šä¿¡çŠ¶æ€ã€‚è¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/os/ZygoteProcess.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Process.ProcessStartResult <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String processClass,</span><br><span class="hljs-params">                                              <span class="hljs-keyword">final</span> String niceName,</span><br><span class="hljs-params">                                              <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-type">int</span>[] gids,</span><br><span class="hljs-params">                                              <span class="hljs-type">int</span> debugFlags, <span class="hljs-type">int</span> mountExternal,</span><br><span class="hljs-params">                                              <span class="hljs-type">int</span> targetSdkVersion,</span><br><span class="hljs-params">                                              String seInfo,</span><br><span class="hljs-params">                                              String abi,</span><br><span class="hljs-params">                                              String instructionSet,</span><br><span class="hljs-params">                                              String appDataDir,</span><br><span class="hljs-params">                                              String invokeWith,</span><br><span class="hljs-params">                                              String[] zygoteArgs)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,<br>                              debugFlags, mountExternal, targetSdkVersion, seInfo,<br>                              abi, instructionSet, appDataDir, invokeWith, zygoteArgs);<br>    &#125; <span class="hljs-keyword">catch</span> (ZygoteStartFailedEx ex) &#123;<br>        Log.e(LOG_TAG,<br>              <span class="hljs-string">&quot;Starting VM process through Zygote failed&quot;</span>);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>            <span class="hljs-string">&quot;Starting VM process through Zygote failed&quot;</span>, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¥½ï¼Œè¿˜æ˜¯ä¸ªä»£ç†å‡½æ•°ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†<code>startViaZygote</code>æ¥å®ç°åŠŸèƒ½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/os/ZygoteProcess.java</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">*Starts a new process via the zygote mechanism.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">startViaZygote</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String processClass,</span><br><span class="hljs-params">                                                  <span class="hljs-keyword">final</span> String niceName,</span><br><span class="hljs-params">                                                  <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> uid, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> gid,</span><br><span class="hljs-params">                                                  <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] gids,</span><br><span class="hljs-params">                                                  <span class="hljs-type">int</span> debugFlags, <span class="hljs-type">int</span> mountExternal,</span><br><span class="hljs-params">                                                  <span class="hljs-type">int</span> targetSdkVersion,</span><br><span class="hljs-params">                                                  String seInfo,</span><br><span class="hljs-params">                                                  String abi,</span><br><span class="hljs-params">                                                  String instructionSet,</span><br><span class="hljs-params">                                                  String appDataDir,</span><br><span class="hljs-params">                                                  String invokeWith,</span><br><span class="hljs-params">                                                  String[] extraArgs)</span><br>    <span class="hljs-keyword">throws</span> ZygoteStartFailedEx &#123;<br>    <span class="hljs-comment">//åˆ›å»ºargsForZygoteå­—ç¬¦ä¸²æ•°ç»„ï¼Œå°†åº”ç”¨è¿›ç¨‹çš„å¯åŠ¨å‚æ•°ä¿å­˜åœ¨å…¶ä¸­</span><br>    ......<br><br>    <span class="hljs-keyword">synchronized</span>(mLock) &#123;<br>        <span class="hljs-keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å°†åº”ç”¨è¿›ç¨‹çš„å¯åŠ¨å‚æ•°è½¬æˆå­—ç¬¦ä¸²æ•°ç»„ï¼Œç„¶åè°ƒç”¨<code>zygoteSendArgsAndGetResult</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸ª<code>openZygoteSocketIfNeeded</code>æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹<code>openZygoteSocketIfNeeded</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/os/ZygoteProcess.java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Tries to open socket to Zygote process if not already open. If</span><br><span class="hljs-comment">* already open, does nothing.  May block and retry.  Requires that mLock be held.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@GuardedBy(&quot;mLock&quot;)</span><br><span class="hljs-keyword">private</span> ZygoteState <span class="hljs-title function_">openZygoteSocketIfNeeded</span><span class="hljs-params">(String abi)</span> <span class="hljs-keyword">throws</span> ZygoteStartFailedEx &#123;<br>    <span class="hljs-comment">//æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰mLocké”ï¼Œæ²¡æœ‰åˆ™æŠ›å¼‚å¸¸</span><br>    Preconditions.checkState(Thread.holdsLock(mLock), <span class="hljs-string">&quot;ZygoteProcess lock not held&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (primaryZygoteState == <span class="hljs-literal">null</span> || primaryZygoteState.isClosed()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//é€šè¿‡Socketä¸ä¸»Zygoteè¿›ç¨‹å»ºç«‹è¿æ¥</span><br>            primaryZygoteState = ZygoteState.connect(mSocket);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;Error connecting to primary zygote&quot;</span>, ioe);<br>        &#125;<br>    &#125;<br><span class="hljs-comment">//æ£€æŸ¥ä¸»Zygoteè¿›ç¨‹çš„çŠ¶æ€æ˜¯å¦ä¸ç»™å®šçš„abi(åº”ç”¨äºŒè¿›åˆ¶æ¥å£)åŒ¹é…ï¼ŒåŒ¹é…åˆ™è¿”å›ä¸»Zygoteè¿›ç¨‹çš„çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (primaryZygoteState.matches(abi)) &#123;<br>        <span class="hljs-keyword">return</span> primaryZygoteState;<br>    &#125;<br><br>    <span class="hljs-comment">// ä¸»Zygoteè¿›ç¨‹çš„çŠ¶æ€ä¸abiä¸åŒ¹é…ï¼Œå°è¯•ä¸è¾…Zygoteè¿›ç¨‹å»ºç«‹è¿æ¥</span><br>    <span class="hljs-keyword">if</span> (secondaryZygoteState == <span class="hljs-literal">null</span> || secondaryZygoteState.isClosed()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//é€šè¿‡Socketä¸è¾…Zygoteè¿›ç¨‹å»ºç«‹è¿æ¥</span><br>            secondaryZygoteState = ZygoteState.connect(mSecondarySocket);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;Error connecting to secondary zygote&quot;</span>, ioe);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (secondaryZygoteState.matches(abi)) &#123;<br>        <span class="hljs-keyword">return</span> secondaryZygoteState;<br>    &#125;<br><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;Unsupported zygote ABI: &quot;</span> + abi);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å…ˆæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦ä¸Š<code>mLock</code>é”ï¼Œç„¶åå°è¯•ä¸ä¸»<code>Zygote</code>è¿æ¥ï¼Œå¦‚æœä¸»<code>Zygote</code>çŠ¶æ€ä¸å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹æ‰€éœ€çš„<code>ABI</code>ä¸åŒ¹é…ï¼Œåˆ™å°è¯•è¿æ¥è¾…<code>Zygote</code>ï¼Œå¦‚æœä»ä¸åŒ¹é…ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p><blockquote><p> <code>Zygote</code>çš„å¯åŠ¨è„šæœ¬æœ‰4ä¸­ï¼Œå…¶ä¸­<code>init.zygote32_64.rc</code>å’Œ<code>init.zygote64_32.rc</code>åˆ†ä¸»è¾…<code>Zygote</code>ï¼ˆè°åœ¨å‰è°ä¸»ï¼‰ï¼Œä¸»è¾…<code>Zygote</code>çš„åŒºåˆ«åœ¨äºæ‰€æ”¯æŒç¨‹åºçš„ä½æ•°(32ä½ã€64ä½)ã€‚</p></blockquote><p>æ¥ä¸‹æ¥çœ‹<code>zygoteSendArgsAndGetResult</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/os/ZygoteProcess.java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Sends an argument list to the zygote process, which starts a new child</span><br><span class="hljs-comment">* and returns the child&#x27;s pid. Please note: the present implementation</span><br><span class="hljs-comment">* replaces newlines in the argument list with spaces.</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> ZygoteStartFailedEx if process start failed for any reason</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@GuardedBy(&quot;mLock&quot;)</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Process.ProcessStartResult <span class="hljs-title function_">zygoteSendArgsAndGetResult</span><span class="hljs-params">(</span><br><span class="hljs-params">    ZygoteState zygoteState, ArrayList&lt;String&gt; args)</span><br>    <span class="hljs-keyword">throws</span> ZygoteStartFailedEx &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æ£€æŸ¥argsæ•°ç»„ä¸­çš„å‚æ•°</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">sz</span> <span class="hljs-operator">=</span> args.size();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; sz; i++) &#123;<br>            <span class="hljs-keyword">if</span> (args.get(i).indexOf(<span class="hljs-string">&#x27;\n&#x27;</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;embedded newlines not allowed&quot;</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">        * See com.android.internal.os.SystemZygoteInit.readArgumentList()</span><br><span class="hljs-comment">        * Presently the wire format to the zygote process is:</span><br><span class="hljs-comment">        * a) a count of arguments (argc, in essence)</span><br><span class="hljs-comment">        * b) a number of newline-separated argument strings equal to count</span><br><span class="hljs-comment">        *</span><br><span class="hljs-comment">        * After the zygote process reads these it will write the pid of</span><br><span class="hljs-comment">        * the child or -1 on failure, followed by boolean to</span><br><span class="hljs-comment">        * indicate whether a wrapper process was used.</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> zygoteState.writer;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> zygoteState.inputStream;<br><span class="hljs-comment">//å°†å‚æ•°å†™å…¥zygoteStateä¸­</span><br>        writer.write(Integer.toString(args.size()));<br>        writer.newLine();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; sz; i++) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> args.get(i);<br>            writer.write(arg);<br>            writer.newLine();<br>        &#125;<br><br>        writer.flush();<br><br>        <br>        Process.<span class="hljs-type">ProcessStartResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Process</span>.ProcessStartResult();<br><span class="hljs-comment">//ç­‰å¾…socketæœåŠ¡ç«¯ï¼ˆå³zygoteï¼‰è¿”å›æ–°åˆ›å»ºçš„è¿›ç¨‹pidã€usingWrapper;</span><br>        <br>        result.pid = inputStream.readInt();<br>        result.usingWrapper = inputStream.readBoolean();<br><br>        <span class="hljs-keyword">if</span> (result.pid &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;fork() failed&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        zygoteState.close();<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å°†å‚æ•°åˆ—è¡¨å†™å…¥<code>zygoteState</code>ä¸­ï¼Œç„¶åä¸<code>Zygote</code>è¿›ç¨‹è¿›è¡Œ<code>Socket</code>é€šä¿¡ï¼Œç­‰å¾…<code>socket</code>æœåŠ¡ç«¯å‘é€å›æ¥æ–°åˆ›å»ºçš„è¿›ç¨‹pidã€‚å¦‚æœ<code>pid&gt;=0</code>åˆ™è¿›ç¨‹åˆ›å»ºæˆåŠŸï¼Œè¿”å›<code>ProcessStartResult</code>å¯¹è±¡ï¼ˆåŒ…å«<code>pid</code>ã€<code>usingWrapper</code>ï¼‰ï¼Œå¦åˆ™å…³é—­<code>Zygote</code>çš„<code>Socket</code>å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯<code>Zygote</code>è¿›ç¨‹æ¥æ”¶è¯·æ±‚å¹¶åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹äº†ã€‚</p><h2 id="2-2-Zygoteè¿›ç¨‹æ¥æ”¶è¯·æ±‚å¹¶åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹"><a href="#2-2-Zygoteè¿›ç¨‹æ¥æ”¶è¯·æ±‚å¹¶åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹" class="headerlink" title="2.2 Zygoteè¿›ç¨‹æ¥æ”¶è¯·æ±‚å¹¶åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹"></a>2.2 Zygoteè¿›ç¨‹æ¥æ”¶è¯·æ±‚å¹¶åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹</h2><p>åœ¨åˆ†æ[Androidç³»ç»Ÿå¯åŠ¨æµç¨‹](<a href="https://gal2xy.github.io/2023/07/04/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ - gla2xyâ€™s blog (gal2xy.github.io)</a>)ä¸­ï¼Œ<code>ZygoteInit.java</code>çš„<code>main</code>å‡½æ•°ä¸­ï¼Œ<code>Zygote</code>åˆ›å»º<code>Socket</code>æœåŠ¡ç«¯åï¼Œä¼šé€šè¿‡<code>runSelectLoop</code>æ–¹æ³•ç­‰å¾…<code>AMS</code>çš„è¯·æ±‚æ¥åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚é‚£æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹<code>runSelectLoop</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">runSelectLoop</span><span class="hljs-params">(String abiList)</span> <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>    <span class="hljs-comment">//åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦çš„æ•°ç»„å’ŒzygoteConnectionå¯¹è±¡çš„æ•°ç»„</span><br>    ArrayList&lt;FileDescriptor&gt; fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;FileDescriptor&gt;();<br>    ArrayList&lt;ZygoteConnection&gt; peers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ZygoteConnection&gt;();<br><span class="hljs-comment">//mServerSocketæ˜¯zygoteè¿›ç¨‹çš„Socketï¼Œä¿å­˜åˆ°fds[0]</span><br>    fds.add(mServerSocket.getFileDescriptor());<br>    peers.add(<span class="hljs-literal">null</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª StructPollfd æ•°ç»„ pollFdsï¼Œç”¨äºå­˜å‚¨å¾…è½®è¯¢çš„æ–‡ä»¶æè¿°ç¬¦</span><br>        StructPollfd[] pollFds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructPollfd</span>[fds.size()];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pollFds.length; ++i) &#123;<br>            pollFds[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructPollfd</span>();<br>            pollFds[i].fd = fds.get(i);<br>            pollFds[i].events = (<span class="hljs-type">short</span>) POLLIN;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//ä½¿ç”¨ Os.poll() æ–¹æ³•å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè½®è¯¢ï¼Œç­‰å¾…æœ‰æ•°æ®å¯è¯»çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¯¥æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿ</span><br>            Os.poll(pollFds, -<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;poll failed&quot;</span>, ex);<br>        &#125;<br>        <span class="hljs-comment">//éå† pollFds æ•°ç»„ï¼Œåˆ¤æ–­æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿ</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> pollFds.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) &#123;<br>            <span class="hljs-comment">//åˆ¤æ–­æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿ</span><br>            <span class="hljs-keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">//å¦‚æœæ–‡ä»¶æè¿°ç¬¦ç´¢å¼•ä¸º 0ï¼Œè¡¨ç¤ºæœ‰æ–°çš„è¿æ¥è¯·æ±‚åˆ°è¾¾</span><br>            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">//è°ƒç”¨ acceptCommandPeer() æ–¹æ³•æ¥å—è¿æ¥ï¼Œå¹¶å°†æ–°çš„è¿æ¥å¯¹è±¡æ·»åŠ åˆ° peers å’Œå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ° fdsã€‚</span><br>                <span class="hljs-type">ZygoteConnection</span> <span class="hljs-variable">newPeer</span> <span class="hljs-operator">=</span> acceptCommandPeer(abiList);<br>                peers.add(newPeer);<br>                fds.add(newPeer.getFileDesciptor());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//å¦‚æœæ–‡ä»¶æè¿°ç¬¦ç´¢å¼•ä¸ä¸º 0ï¼Œåˆ™è¡¨ç¤ºå·²æœ‰è¿æ¥çš„æ•°æ®å¯è¯»ï¼Œè°ƒç”¨å¯¹åº”è¿æ¥å¯¹è±¡çš„ runOnce() æ–¹æ³•</span><br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">done</span> <span class="hljs-operator">=</span> peers.get(i).runOnce(<span class="hljs-built_in">this</span>);<br>                <span class="hljs-comment">//å¤„ç†å®Œåç§»é™¤è¯¥æ–‡ä»¶æè¿°ç¬¦å’Œè¿æ¥å¯¹è±¡</span><br>                <span class="hljs-keyword">if</span> (done) &#123;<br>                    peers.remove(i);<br>                    fds.remove(i);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><br><span class="hljs-keyword">private</span> ZygoteConnection <span class="hljs-title function_">acceptCommandPeer</span><span class="hljs-params">(String abiList)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> createNewConnection(mServerSocket.accept(), abiList);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>            <span class="hljs-string">&quot;IOException during accept()&quot;</span>, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•´ä¸ª<code>runSelectLoop</code>æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡æ­»å¾ªç¯æ¥è½®è¯¢å¯è¯»äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰¾åˆ°åæ¥å—è¿æ¥å¹¶åˆ›å»ºè¿æ¥å¯¹è±¡å¹¶è°ƒç”¨<code>runOnce</code>æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚è¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Reads one start command from the command socket. If successful,</span><br><span class="hljs-comment">* a child is forked and a &#123;<span class="hljs-doctag">@link</span> Zygote.MethodAndArgsCaller&#125;</span><br><span class="hljs-comment">* exception is thrown in that child while in the parent process,</span><br><span class="hljs-comment">* the method returns normally. On failure, the child is not</span><br><span class="hljs-comment">* spawned and messages are printed to the log and stderr. Returns</span><br><span class="hljs-comment">* a boolean status value indicating whether an end-of-file on the command</span><br><span class="hljs-comment">* socket has been encountered.</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span> false if command socket should continue to be read from, or</span><br><span class="hljs-comment">* true if an end-of-file has been encountered.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> Zygote.MethodAndArgsCaller trampoline to invoke main()</span><br><span class="hljs-comment">* method in child process</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">runOnce</span><span class="hljs-params">(ZygoteServer zygoteServer)</span> <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br><br>    String args[];<br>    <span class="hljs-type">Arguments</span> <span class="hljs-variable">parsedArgs</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    FileDescriptor[] descriptors;<br><br>    <span class="hljs-comment">//è·å–å¯åŠ¨å‚æ•°å’Œæ–‡ä»¶æè¿°ç¬¦</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        args = readArgumentList();<br>        descriptors = mSocket.getAncillaryFileDescriptors();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        Log.w(TAG, <span class="hljs-string">&quot;IOException on command socket &quot;</span> + ex.getMessage());<br>        closeSocket();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    ......<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//å°†binderå®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œè§£ææˆArgumentså¯¹è±¡æ ¼å¼</span><br>        parsedArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arguments</span>(args);<br><br>        <span class="hljs-comment">//æ ¹æ®å‚æ•°åšç›¸åº”å¤„ç†</span><br>        ......<br><span class="hljs-comment">//åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹</span><br>        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,<br>                                       parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,<br>                                       parsedArgs.niceName, fdsToClose, fdsToIgnore, parsedArgs.instructionSet,<br>                                       parsedArgs.appDataDir);<br>    &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>    ......<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <br>        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//å½“å‰ä»£ç è¿è¡Œåœ¨å­è¿›ç¨‹ä¸­</span><br>            zygoteServer.closeServerSocket();<br>            IoUtils.closeQuietly(serverPipeFd);<span class="hljs-comment">//å…³é—­æ–‡ä»¶æè¿°ç¬¦</span><br>            serverPipeFd = <span class="hljs-literal">null</span>;<br>            handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//å½“å‰ä»£ç è¿è¡Œåœ¨çˆ¶è¿›ç¨‹ä¸­</span><br>            IoUtils.closeQuietly(childPipeFd);<br>            childPipeFd = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        IoUtils.closeQuietly(childPipeFd);<br>        IoUtils.closeQuietly(serverPipeFd);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å…ˆè·å–å¯åŠ¨å‚æ•°å’Œæ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¹å…¶åšå¤„ç†åï¼Œè°ƒç”¨<code>Zygote.forkAndSpecialize</code>æ–¹æ³•åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œç„¶åé€šè¿‡<code>pid</code>åˆ¤æ–­å½“å‰ä»£ç è¿è¡Œåœ¨å“ªä¸ªè¿›ç¨‹ä¸­ï¼Œæ­£å¸¸æµç¨‹æ˜¯åˆ›å»ºæˆåŠŸï¼Œ<code>pid=0</code>è¿›å…¥<code>handleChildProc</code>æ–¹æ³•ã€‚</p><h2 id="2-3-åº”ç”¨ç¨‹åºè¿›ç¨‹çš„åˆå§‹åŒ–"><a href="#2-3-åº”ç”¨ç¨‹åºè¿›ç¨‹çš„åˆå§‹åŒ–" class="headerlink" title="2.3 åº”ç”¨ç¨‹åºè¿›ç¨‹çš„åˆå§‹åŒ–"></a>2.3 åº”ç”¨ç¨‹åºè¿›ç¨‹çš„åˆå§‹åŒ–</h2><p><code>handleChildProc</code>æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Handles post-fork setup of child proc, closing sockets as appropriate,</span><br><span class="hljs-comment">* reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller</span><br><span class="hljs-comment">* if successful or returning if failed.</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> Zygote.MethodAndArgsCaller on success to</span><br><span class="hljs-comment">* trampoline to code that invokes static main.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleChildProc</span><span class="hljs-params">(Arguments parsedArgs,</span><br><span class="hljs-params">                             FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)</span><br>    <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>    <br><span class="hljs-comment">// å…³é—­ä»zygoteç»§æ‰¿è¿‡æ¥çš„Socketé€šä¿¡</span><br>    closeSocket();<br>    <span class="hljs-comment">//é‡å®šå‘std_xxxåˆ°descriptorsæ•°ç»„ä¸­å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åå…³é—­descriptorsæ•°ç»„ä¸­çš„æ–‡ä»¶æè¿°ç¬¦</span><br>    <span class="hljs-keyword">if</span> (descriptors != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Os.dup2(descriptors[<span class="hljs-number">0</span>], STDIN_FILENO);<br>            Os.dup2(descriptors[<span class="hljs-number">1</span>], STDOUT_FILENO);<br>            Os.dup2(descriptors[<span class="hljs-number">2</span>], STDERR_FILENO);<br><br>            <span class="hljs-keyword">for</span> (FileDescriptor fd: descriptors) &#123;<br>                IoUtils.closeQuietly(fd);<br>            &#125;<br>            newStderr = System.err;<br>        &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>            Log.e(TAG, <span class="hljs-string">&quot;Error reopening stdio&quot;</span>, ex);<br>        &#125;<br>    &#125;<br><span class="hljs-comment">//è®¾ç½®è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°argv0ä¸ºparsedArgs.niceName</span><br>    <span class="hljs-keyword">if</span> (parsedArgs.niceName != <span class="hljs-literal">null</span>) &#123;<br>        Process.setArgV0(parsedArgs.niceName);<br>    &#125;<br><br>    <span class="hljs-comment">//å…³é—­Traceäº‹ä»¶ï¼Œè¡¨ç¤ºä¸å†è·Ÿè¸ªå½“å‰çš„æ´»åŠ¨ç®¡ç†å™¨äº‹ä»¶</span><br>    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>    <span class="hljs-comment">//invokeWithå¯èƒ½æ˜¯ä¸€ä¸ªç”¨äºæŒ‡å®šå­è¿›ç¨‹å¯åŠ¨æ–¹å¼çš„å‚æ•°</span><br>    <span class="hljs-keyword">if</span> (parsedArgs.invokeWith != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//é€šè¿‡ WrapperInit.execApplication() æ–¹æ³•ä»¥å¦ä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œåº”ç”¨ç¨‹åºè¿›ç¨‹</span><br>        WrapperInit.execApplication(parsedArgs.invokeWith,<br>                                    parsedArgs.niceName, parsedArgs.targetSdkVersion,<br>                                    VMRuntime.getCurrentInstructionSet(),<br>                                    pipeFd, parsedArgs.remainingArgs);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion,<br>                              parsedArgs.remainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸»è¦ç”¨äºé…ç½®å­è¿›ç¨‹çš„åˆå§‹ç¯å¢ƒï¼ŒåŒ…æ‹¬å…³é—­çˆ¶è¿›ç¨‹çš„é€šä¿¡ç®¡é“ã€é‡å®šå‘æ ‡å‡†è¾“å…¥è¾“å‡ºå’Œé”™è¯¯è¾“å‡ºã€è®¾ç½®å­è¿›ç¨‹åç§°ç­‰ã€‚åœ¨å®Œæˆè¿™äº›æ“ä½œåï¼Œæ ¹æ®ä¸åŒçš„æƒ…å†µæ¥å¯åŠ¨å­è¿›ç¨‹ã€‚</p><p>å…¶ä¸­<code>execApplication</code>æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/WrapperInit.java</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Executes a runtime application with a wrapper command.</span><br><span class="hljs-comment">* This method never returns.</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> invokeWith The wrapper command.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> niceName The nice name for the application, or null if none.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> targetSdkVersion The target SDK version for the app.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> pipeFd The pipe to which the application&#x27;s pid should be written, or null if none.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> args Arguments for &#123;<span class="hljs-doctag">@link</span> RuntimeInit#main&#125;.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execApplication</span><span class="hljs-params">(String invokeWith, String niceName,</span><br><span class="hljs-params">                                   <span class="hljs-type">int</span> targetSdkVersion, String instructionSet, FileDescriptor pipeFd,</span><br><span class="hljs-params">                                   String[] args)</span> &#123;<br>    <span class="hljs-comment">//åˆ›å»ºæŒ‡ä»¤å­—ç¬¦ä¸²å¹¶æ„é€ æŒ‡ä»¤</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(invokeWith);<br><br>    <span class="hljs-keyword">final</span> String appProcess;<br>    <span class="hljs-comment">//æ ¹æ®ç›®æ ‡è®¾å¤‡æŒ‡ä»¤é›†é€‰æ‹©ç›¸åº”çš„app_processå¯æ‰§è¡Œæ–‡ä»¶</span><br>    <span class="hljs-keyword">if</span> (VMRuntime.is64BitInstructionSet(instructionSet)) &#123;<br>        appProcess = <span class="hljs-string">&quot;/system/bin/app_process64&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        appProcess = <span class="hljs-string">&quot;/system/bin/app_process32&quot;</span>;<br>    &#125;<br>    command.append(<span class="hljs-string">&#x27; &#x27;</span>);<br>    command.append(appProcess);<br><span class="hljs-comment">//æŒ‡å®š--applicationå‚æ•°æ¥è¡¨ç¤ºè¦æ‰§è¡Œçš„æ˜¯åº”ç”¨ç¨‹åº</span><br>    command.append(<span class="hljs-string">&quot; /system/bin --application&quot;</span>);<br>    <span class="hljs-comment">//æ·»åŠ  --nice-name= å‚æ•°</span><br>    <span class="hljs-keyword">if</span> (niceName != <span class="hljs-literal">null</span>) &#123;<br>        command.append(<span class="hljs-string">&quot; &#x27;--nice-name=&quot;</span>).append(niceName).append(<span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//ä½¿ç”¨ com.android.internal.os.WrapperInit ä½œä¸ºåº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ç±»</span><br>    command.append(<span class="hljs-string">&quot; com.android.internal.os.WrapperInit &quot;</span>);<br>    <span class="hljs-comment">//å°† pipeFd è½¬æ¢ä¸ºæ•´æ•°å¹¶æ·»åŠ åˆ°å‘½ä»¤å­—ç¬¦ä¸²ä¸­ã€‚è¯¥æ•´æ•°ç”¨äºåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨åå‘çˆ¶è¿›ç¨‹å†™å…¥åº”ç”¨ç¨‹åºçš„PID</span><br>    command.append(pipeFd != <span class="hljs-literal">null</span> ? pipeFd.getInt$() : <span class="hljs-number">0</span>);<br>    command.append(<span class="hljs-string">&#x27; &#x27;</span>);<br>    command.append(targetSdkVersion);<br>    Zygote.appendQuotedShellArgs(command, args);<br>    preserveCapabilities();<br>    <span class="hljs-comment">//è°ƒç”¨ Zygote.execShell() æ–¹æ³•æ‰§è¡Œæ„å»ºå¥½çš„å‘½ä»¤</span><br>    Zygote.execShell(command.toString());<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•é€šè¿‡æ„é€ å‘½ä»¤æ¥æ‰§è¡Œåº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œå…¶ä¸­<code>/system/bin/app_process32</code>è¿™ä¸²å­—ç¬¦æœ‰ç‚¹çœ¼ç†Ÿå•Šï¼æ˜¯åœ¨è§£æ<code>init.rc</code>æ–‡ä»¶ä¸­å‡ºç°è¿‡ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™ä¸ªå‘½ä»¤</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">service zygote <span class="hljs-regexp">/system/</span>bin<span class="hljs-regexp">/app_process64 -Xzygote /</span>system/bin --zygote --start-system-server<br></code></pre></td></tr></table></figure><p>å¥½äº†ï¼Œè¿™éƒ¨åˆ†ç‚¹åˆ°ä¸ºæ­¢ã€‚</p><p>æŸ¥é˜…äº†ç½‘ä¸Šçš„åšå®¢ï¼Œéƒ½è®¤ä¸ºåœ¨<code>handleChildProc</code>æ–¹æ³•ä¹‹åï¼Œè¿›å…¥åˆ†æ”¯<code>zygoteInit</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">zygoteInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, String[] argv,</span><br><span class="hljs-params">                                    ClassLoader classLoader)</span> <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>    <span class="hljs-keyword">if</span> (RuntimeInit.DEBUG) &#123;<br>        Slog.d(RuntimeInit.TAG, <span class="hljs-string">&quot;RuntimeInit: Starting application from zygote&quot;</span>);<br>    &#125;<br><span class="hljs-comment">// åŸç”Ÿæ·»åŠ åä¸ºâ€œZygoteInit â€çš„systrace tagä»¥æ ‡è¯†è¿›ç¨‹åˆå§‹åŒ–æµç¨‹</span><br>    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;ZygoteInit&quot;</span>);<br>    RuntimeInit.redirectLogStreams();<span class="hljs-comment">//é‡å®šå‘logè¾“å‡º</span><br><br>    RuntimeInit.commonInit();<span class="hljs-comment">// é€šç”¨çš„ä¸€äº›åˆå§‹åŒ–</span><br>    ZygoteInit.nativeZygoteInit();<span class="hljs-comment">//nativeZygoteInitå‡½æ•°ä¸­JNIè°ƒç”¨å¯åŠ¨è¿›ç¨‹çš„binderçº¿ç¨‹æ± </span><br>    RuntimeInit.applicationInit(targetSdkVersion, argv, classLoader);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„ä¸»è¦å·¥ä½œæ˜¯æ ‡è¯†è¿›ç¨‹åˆå§‹åŒ–æµç¨‹ï¼Œé‡å®šå‘logè¾“å‡ºï¼Œé€šç”¨åˆå§‹åŒ–å¤„ç†ï¼Œå¯åŠ¨<code>Binder</code>çº¿ç¨‹æ± ï¼Œç„¶åè°ƒç”¨<code>applicationInit</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applicationInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span><br>    <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>    <span class="hljs-comment">//trueä»£è¡¨åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ä¸è°ƒç”¨AppRuntime.onExit()ï¼Œå¦åˆ™ä¼šåœ¨é€€å‡ºå‰è°ƒç”¨</span><br>    nativeSetExitWithoutCleanup(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">//è®¾ç½®è™šæ‹Ÿæœºçš„å†…å­˜åˆ©ç”¨ç‡å‚æ•°å€¼ä¸º0.75å’ŒSDKç‰ˆæœ¬</span><br>    VMRuntime.getRuntime().setTargetHeapUtilization(<span class="hljs-number">0.75f</span>);<br>    VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);<br><br>    <span class="hljs-keyword">final</span> Arguments args;<br>    <span class="hljs-keyword">try</span> &#123;<br>        args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arguments</span>(argv);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException ex) &#123;<br>        Slog.e(TAG, ex.getMessage());<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// ç»“æŸZygoteInitçš„systrace tag</span><br>    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br><br>    invokeStaticMain(args.startClass, args.startArgs, classLoader);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®çš„æ˜¯<code>invokeStaticMain</code>æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°<code>args.startClass</code>ï¼Œå°±æ˜¯æ–‡ç« å¼€å¤´æåˆ°çš„<code>entryPoint</code>å‚æ•°ï¼Œå…¶å€¼ä¸º<code>android.app.ActivityThread</code>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æŸ¥çœ‹<code>invokeStaticMain</code>æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeStaticMain</span><span class="hljs-params">(String className, String[] argv, ClassLoader classLoader)</span><br>    <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>    Class&lt;?&gt; cl;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//è·å–android.app.ActivityThreadçš„ç±»</span><br>        cl = Class.forName(className, <span class="hljs-literal">true</span>, classLoader);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>            <span class="hljs-string">&quot;Missing class when invoking static main &quot;</span> + className,<br>            ex);<br>    &#125;<br><br>    Method m;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//è·å¾—android.app.ActivityThreadä¸­çš„mainæ–¹æ³•</span><br>        m = cl.getMethod(<span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String[].class &#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>            <span class="hljs-string">&quot;Missing static main on &quot;</span> + className, ex);<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>            <span class="hljs-string">&quot;Problem getting static main on &quot;</span> + className, ex);<br>    &#125;<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> m.getModifiers();<br>    <span class="hljs-keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>            <span class="hljs-string">&quot;Main method is not public and static on &quot;</span> + className);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * This throw gets caught in ZygoteInit.main(), which responds</span><br><span class="hljs-comment">    * by invoking the exception&#x27;s run() method. This arrangement</span><br><span class="hljs-comment">    * clears up all the stack frames that were required in setting</span><br><span class="hljs-comment">    * up the process.</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">//é€šè¿‡æŠ›å‡ºå¼‚å¸¸å¯åŠ¨mainæ–¹æ³•</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Zygote</span>.MethodAndArgsCaller(m, argv);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†çš„ä»£ç åŒ<a href="https://gal2xy.github.io/2023/07/04/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/#2-5-System-Server%E9%98%B6%E6%AE%B5">ç³»ç»Ÿå¯åŠ¨æµç¨‹ä¸­SystemServiceé˜¶æ®µ</a>çš„åä¸€éƒ¨åˆ†ä¸€è‡´ï¼ˆå…¶å®ä»<code>zygoteInit</code>æ–¹æ³•å¼€å§‹å°±ä¸€æ ·äº†ï¼‰ï¼Œè¿™é‡Œå°±ä¸å†åˆ†æ<code>MethodAndArgsCaller</code>æ–¹æ³•ï¼Œè¯¦ç»†è¯·è§é“¾æ¥ã€‚æ¥ä¸‹æ¥åˆ†æ<code>ActivityThread</code>çš„<code>main</code>æ–¹æ³•ã€‚</p><h2 id="2-4-åº”ç”¨ç¨‹åºè¿›ç¨‹çš„è¿è¡Œ"><a href="#2-4-åº”ç”¨ç¨‹åºè¿›ç¨‹çš„è¿è¡Œ" class="headerlink" title="2.4 åº”ç”¨ç¨‹åºè¿›ç¨‹çš„è¿è¡Œ"></a>2.4 åº”ç”¨ç¨‹åºè¿›ç¨‹çš„è¿è¡Œ</h2><p><code>ActivityThread</code>çš„<code>main</code>æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//è·¯å¾„ï¼š/frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">//å¼€å§‹è·Ÿè¸ªï¼Œæ ‡è®°ä¸º&quot;ActivityThreadMain&quot;</span><br>    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;ActivityThreadMain&quot;</span>);<br>    <br>    <span class="hljs-comment">//å¯åŠ¨é‡‡æ ·åˆ†æå™¨é›†æˆï¼Œç”¨äºæ€§èƒ½åˆ†æ</span><br>    SamplingProfilerIntegration.start();<br><br>    <span class="hljs-comment">//å…³é—­CloseGuardï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯å¯ç”¨çš„ï¼Œä½†åœ¨æ­¤å¤„å°†å…¶ç¦ç”¨ã€‚CloseGuardç”¨äºæ£€æµ‹èµ„æºæ²¡æœ‰æ­£ç¡®å…³é—­çš„æƒ…å†µ</span><br>    CloseGuard.setEnabled(<span class="hljs-literal">false</span>);<br>    <br><span class="hljs-comment">//åˆå§‹åŒ–å½“å‰ç”¨æˆ·çš„ç¯å¢ƒå˜é‡</span><br>    Environment.initForCurrentUser();<br><br>    <span class="hljs-comment">//è®¾ç½®äº‹ä»¶æ—¥å¿—çš„æŠ¥å‘Šå™¨ï¼Œç”¨äºåœ¨libcoreä¸­è®°å½•äº‹ä»¶æ—¥å¿—</span><br>    EventLogger.setReporter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EventLoggingReporter</span>());<br><br>    <span class="hljs-comment">//å¯»æ‰¾CAè¯ä¹¦çš„å­˜å‚¨ä½ç½®å¹¶è®¾ç½®ä¸ºé»˜è®¤çš„CAè¯ä¹¦å­˜å‚¨ä½ç½®</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">configDir</span> <span class="hljs-operator">=</span> Environment.getUserConfigDirectory(UserHandle.myUserId());<br>    TrustedCertificateStore.setDefaultUserDirectory(configDir);<br>    <br><span class="hljs-comment">//è®¾ç½®å½“å‰è¿›ç¨‹çš„argv[0]å€¼ä¸º&quot;&lt;pre-initialized&gt;&quot;</span><br>    Process.setArgV0(<span class="hljs-string">&quot;&lt;pre-initialized&gt;&quot;</span>);<br>    <br><span class="hljs-comment">//åˆ›å»ºå¹¶å¯åŠ¨ä¸»çº¿ç¨‹çš„loopæ¶ˆæ¯å¾ªç¯</span><br>    Looper.prepareMainLooper();<br>    <br><span class="hljs-comment">//åˆ›å»ºçº¿ç¨‹å¹¶å°†å½“å‰çº¿ç¨‹é™„åŠ åˆ°ActivityThreadï¼Œå‚æ•°falseè¡¨ç¤ºä¸ä½¿ç”¨æ–°çº¿ç¨‹</span><br>    <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();<br>    thread.attach(<span class="hljs-literal">false</span>);<br>    <br><span class="hljs-comment">//å¦‚æœsMainThreadHandlerä¸ºç©ºï¼Œåˆ™å°†å…¶è®¾ç½®ä¸ºActivityThreadçš„Handlerã€‚</span><br>    <span class="hljs-keyword">if</span> (sMainThreadHandler == <span class="hljs-literal">null</span>) &#123;<br>        sMainThreadHandler = thread.getHandler();<br>    &#125;<br>    <br><span class="hljs-comment">//æ°¸å‡ï¼Œå¯å¿½ç•¥</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) &#123;<br>        Looper.myLooper().setMessageLogging(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogPrinter</span>(Log.DEBUG, <span class="hljs-string">&quot;ActivityThread&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">//ç»“æŸè·Ÿè¸ª</span><br>    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>    <br>    <span class="hljs-comment">//å¼€å§‹ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯</span><br>    Looper.loop();<br><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•åˆå§‹åŒ–ä¸€äº›ç¯å¢ƒå˜é‡å’Œè®¾ç½®ï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ª<code>ActivityThread</code>å¯¹è±¡ï¼Œç„¶åè¿›å…¥ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯ã€‚å…¶ä¸­<code>Handler</code>æ˜¯ä¸€ä¸ªæ¶ˆæ¯æœºåˆ¶ï¼Œç”¨äºåŒè¿›ç¨‹çš„çº¿ç¨‹é—´é€šä¿¡ã€‚</p><p>è‡³æ­¤ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹å°±åˆ›å»ºå®Œæˆäº†å¹¶ä¸”è¿è¡Œäº†ä¸»çº¿ç¨‹çš„ç®¡ç†ç±»<code>ActivityThread</code>ã€‚</p><h1 id="ä¸‰ã€å°ç»“"><a href="#ä¸‰ã€å°ç»“" class="headerlink" title="ä¸‰ã€å°ç»“"></a>ä¸‰ã€å°ç»“</h1><p>åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸»è¦å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š</p><ol><li><code>AMS</code>å‘é€å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹è¯·æ±‚ï¼š<code>AMS</code>é¦–å…ˆä¼šè°ƒç”¨<code>startProcessLocked</code>æ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡<code>openZygoteSocketIfNeeded</code>æ–¹æ³•ä¸<code>Zygote</code> çš„Socketå»ºç«‹è¿æ¥ï¼Œå¹¶é€šè¿‡<code>zygoteSendArgsAndGetResult</code>ä¸è¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œå‘é€è¯·æ±‚ã€‚</li><li><code>Zygote</code>è¿›ç¨‹æ¥æ”¶è¯·æ±‚å¹¶åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹ï¼š<code>Zygote</code>é€šè¿‡<code>runSelectLoop</code>æ–¹æ³•æ¥æ”¶åˆ°<code>AMS</code>çš„è¯·æ±‚ï¼Œç„¶åè°ƒç”¨<code>runOnce</code>æ–¹æ³•ï¼Œé€šè¿‡<code>forkAndSpecialize</code>æ–¹æ³•åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</li><li>åº”ç”¨ç¨‹åºè¿›ç¨‹åˆå§‹åŒ–å’Œè¿è¡Œï¼šåº”ç”¨ç¨‹åºè¿›ç¨‹åˆ›å»ºå®Œæˆåï¼Œé¦–å…ˆä¼šé€šè¿‡<code>handleParentProc</code>å¼€å§‹è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œå¯åŠ¨<code>Binder</code>çº¿ç¨‹æ± ï¼Œæœ€åé€šè¿‡æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼è°ƒç”¨<code>MethodAndArgsCaller</code>æ¥å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œå³è¿›å…¥åˆ°<code>ActivityThread</code>çš„<code>main</code>æ–¹æ³•ï¼Œåˆ›å»ºå¹¶å¯åŠ¨ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li></ol><p>æ•´ä¸ªä¸»çº¿æµç¨‹å¯ç”¨ä¸‹é¢è¿™å¼ å›¾æ¦‚æ‹¬ï¼ˆæ¥è‡ªåˆ˜æœ›èˆ’åšå®¢çš„å›¾ç‰‡ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307171046842.png"></p><hr><p>å‚è€ƒï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/411198603">Android åº”ç”¨å¯åŠ¨å…¨æµç¨‹åˆ†æï¼ˆæºç æ·±åº¦å‰–æå’Œ Systrace å±•ç¤ºï¼‰- ä¸Šç¯‡ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="http://gityuan.com/2016/03/26/app-process-create/">ç†è§£Androidè¿›ç¨‹åˆ›å»ºæµç¨‹ - Gityuanåšå®¢ | è¢è¾‰è¾‰çš„æŠ€æœ¯åšå®¢</a></p><p><a href="http://liuwangshu.cn/framework/applicationprocess/1.html">Androidåº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ï¼ˆå‰ç¯‡ï¼‰ | BATcoder - åˆ˜æœ›èˆ’ (liuwangshu.cn)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>Androidæºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pixel4åˆ·Lineage OSå’Œroot</title>
    <link href="/2023/07/15/Pixel4%E5%88%B7Lineage%20OS/"/>
    <url>/2023/07/15/Pixel4%E5%88%B7Lineage%20OS/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>åˆ·æœºå‰å»ºè®®å…ˆçœ‹çœ‹è¿™ä¸ªè§†é¢‘ï¼ˆ<a href="https://www.bilibili.com/video/BV1BY4y1H7Mc/?buvid=XX71D2975B6460DDA13ACF6C397DF2E78AA3B&is_story_h5=false&mid=rVd4HoESkEBG2mkNA+9sTQ==&p=1&plat_id=116&share_from=ugc&share_medium=android&share_plat=android&share_session_id=b77b1884-2159-47d3-8b5d-7094160a3811&share_source=QQ&share_tag=s_i&timestamp=1689348675&unique_k=AJdJ9pW&up_id=25876945&vd_source=93c3d93ed7e80c0e051905699e1c294f">ç©æœºå¿…çœ‹ï¼å¸¦ä½ å…¥å‘å®‰å“åˆ·æœºï¼Œå°ç™½ä¹Ÿèƒ½çœ‹æ‡‚çš„ROOTåŸºç¡€æŒ‡å—æ¥å•¦ï¼_å“”å“©å“”å“©_bilibili</a>ï¼‰ï¼Œäº†è§£åˆ·æœºçš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚<code>pixle</code>åˆ·<code>LineageOS</code>ç³»ç»Ÿçš„è¯å¯ä»¥å‚è€ƒï¼š<a href="https://www.bilibili.com/video/BV1fR4y1v7qf/?buvid=XX71D2975B6460DDA13ACF6C397DF2E78AA3B&is_story_h5=false&mid=rVd4HoESkEBG2mkNA+9sTQ==&p=1&plat_id=116&share_from=ugc&share_medium=android&share_plat=android&share_session_id=ec2eeed6-587f-4461-a521-457392a009ec&share_source=QQ&share_tag=s_i&timestamp=1689396221&unique_k=3rdkpc7&up_id=3493094532057146&vd_source=93c3d93ed7e80c0e051905699e1c294f">ä¸¤æ¡å‘½ä»¤æ•™ä½ åˆ·å…¥LineageOSï¼Œå°ç™½ä¹Ÿèƒ½ä¸Šæ‰‹ï¼_å“”å“©å“”å“©_bilibili</a>ã€‚</p><h1 id="äºŒã€Pixel4åˆ·LineageOSç³»ç»ŸåŠMindTheGapps"><a href="#äºŒã€Pixel4åˆ·LineageOSç³»ç»ŸåŠMindTheGapps" class="headerlink" title="äºŒã€Pixel4åˆ·LineageOSç³»ç»ŸåŠMindTheGapps"></a>äºŒã€Pixel4åˆ·LineageOSç³»ç»ŸåŠMindTheGapps</h1><h2 id="2-1-å‡†å¤‡å·¥ä½œ"><a href="#2-1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="2.1 å‡†å¤‡å·¥ä½œ"></a>2.1 å‡†å¤‡å·¥ä½œ</h2><ol><li><p>åœ¨å®˜ç½‘ä¸­æ‰¾å¯¹åº”è®¾å¤‡çš„æ€»é¡µé¢ï¼š<a href="https://wiki.lineageos.org/devices/">Devices | LineageOS Wiki</a>ï¼Œåˆ¤æ–­è®¾å¤‡æ˜¯å¦ä¸é¡µé¢ä¸­æ‰‹æœºå±•ç¤ºä¿¡æ¯ç›¸ç¬¦ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152231613.png"></p></li><li><p>ä¸‹è½½<code>LineageOS</code>çš„<code>zip</code>å’Œ<code>boot.img</code>ï¼š<a href="https://download.lineageos.org/devices/flame/builds">LineageOS Downloads</a>ä¸‹è½½æœ€æ–°çš„é…å¥—çš„<code>boot.img</code>å’Œ<code>lineage-xxxxxxx-nightly-flame-signed.zip</code>ï¼ˆå› ä¸ºåªæœ‰æœ€æ–°çš„ğŸ¤£ï¼‰</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152231549.png"></p></li><li><p>ä¸‹è½½Google appsï¼ˆMindTheGappsï¼‰ï¼š<a href="https://wiki.lineageos.org/gapps">Google apps | LineageOS Wiki</a>ï¼Œé€‰æ‹©ç§»åŠ¨ç‰ˆã€‚æ ¹æ®ä½ ä¸‹çš„LineageOSçš„åŒ…ä¸‹å¯¹åº”çš„ï¼ˆä¾‹å¦‚Lineage 20å®‰å“ç‰ˆæœ¬æ˜¯13ï¼Œæ‰€ä»¥é€‰æ‹©MindTheGapps-13xxxxï¼‰,è‡³äºæ˜¯<code>arm</code>è¿˜æ˜¯<code>arm64</code>åˆ™æ ¹æ®ä½ çš„æ‰‹æœºçš„<code>CPU</code>æ¶æ„æ¥é€‰æ‹©ã€‚</p><p>åœ¨<code>cmd</code>ä¸­ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤æŸ¥çœ‹è®¾å¤‡çš„CPUæ¶æ„ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">adb shell getprop ro<span class="hljs-selector-class">.product</span><span class="hljs-selector-class">.cpu</span>.abi<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152232080.png"></p><p>é€‰æ‹©é•œåƒç½‘ç«™ä¸‹è½½æ¯”è¾ƒå¿«ï¼ˆå¦ä¸€ä¸ªç½‘ç«™å°è¯•ç‚¹å‡»ä¸‹è½½æ˜¯æ— ååº”çš„ï¼‰</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152232488.png"></p></li><li><p>ç¡®ä¿ç”µè„‘ç«¯ä¸‹è½½äº†<code>platform-tools</code>ï¼Œå³åœ¨å‘½ä»¤çª—å£ä¸­èƒ½å¤Ÿä½¿ç”¨<code>adb</code>å’Œ<code>fastboot</code>æŒ‡ä»¤ã€‚</p></li><li><p>æ‰‹æœºç«¯å¼€å¯USBè°ƒè¯•æ¨¡å¼</p></li></ol><p><strong>åœ¨å¼€å§‹æ“ä½œå‰ï¼Œè¯·å…ˆé˜…è¯»ä¸€éå®˜ç½‘ç»™çš„åˆ·æœºæ•™ç¨‹ï¼ˆ<a href="https://wiki.lineageos.org/devices/flame/install">Install LineageOS on flame | LineageOS Wiki</a>ï¼‰ï¼ï¼ï¼</strong></p><p><strong>åœ¨å¼€å§‹æ“ä½œå‰ï¼Œè¯·å…ˆé˜…è¯»ä¸€éå®˜ç½‘ç»™çš„åˆ·æœºæ•™ç¨‹ï¼ˆ<a href="https://wiki.lineageos.org/devices/flame/install">Install LineageOS on flame | LineageOS Wiki</a>ï¼‰ï¼ï¼ï¼</strong></p><p><strong>åœ¨å¼€å§‹æ“ä½œå‰ï¼Œè¯·å…ˆé˜…è¯»ä¸€éå®˜ç½‘ç»™çš„åˆ·æœºæ•™ç¨‹ï¼ˆ<a href="https://wiki.lineageos.org/devices/flame/install">Install LineageOS on flame | LineageOS Wiki</a>ï¼‰ï¼ï¼ï¼</strong></p><h2 id="2-2-åˆ·å…¥LineageOS"><a href="#2-2-åˆ·å…¥LineageOS" class="headerlink" title="2.2 åˆ·å…¥LineageOS"></a>2.2 åˆ·å…¥LineageOS</h2><p>é¦–å…ˆåœ¨æ‰‹æœºç«¯è§£<code>OEM</code>é”ï¼ˆåœ¨å¼€å‘è€…é€‰é¡¹é‡Œï¼‰ï¼Œç„¶åç”µè„‘ç«¯æ‰§è¡Œä¸‹åˆ—å‘½ä»¤å³å¯è§£<code>BootLoader</code>é”ï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">adb reboot bootloader</span><br><span class="hljs-attribute">fastboot devices</span><br><span class="hljs-attribute">fastboot flashing unlock</span><br></code></pre></td></tr></table></figure><p>è§£å®Œ<code>BootLoader</code>é”ä¹‹ååº”è¯¥è¿˜æ˜¯åœ¨<code>fastboot</code>æ¨¡å¼ä¸‹ï¼ˆæ²¡è®°é”™çš„è¯ï¼Œå¦‚æœä¸æ˜¯å°±æ‰§è¡Œ<code>fastboot reboot bootloader</code>ï¼‰ï¼Œæ‰§è¡Œä¸‹åˆ—å‘½ä»¤åˆ·å…¥<code>boot.img</code>ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">fastboot flash boot <span class="hljs-attr">--slot</span> <span class="hljs-attribute">all</span> boot<span class="hljs-selector-class">.img</span>æ‰€åœ¨è·¯å¾„<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä½¿ç”¨<code>--slot all</code>æ˜¯å› ä¸ºä¸‹é¢è¿™ä¸ªåŸå› ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸æ·»åŠ ï¼Œå€˜è‹¥æŠ¥<code>no valid slot to boot</code>ï¼Œè¯·æ·»åŠ è¯¥å‚æ•°å¹¶é‡æ–°æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼ˆå‚è€ƒï¼š<a href="https://forum.xda-developers.com/t/no-valid-slot-to-boot-any-way-to-back-up-data.4193883/">No valid slot to boot - any way to back up data? | XDA Forums (xda-developers.com)</a>ï¼‰ã€‚</p><blockquote><p>ä»Android7å¼€å§‹ï¼Œå¼•å…¥äº†æ–°çš„OTAå‡çº§æ–¹å¼A&#x2F;B System Updatesï¼Œè¿™ç§å‡çº§æ–¹å¼å°†bootã€systemç­‰åˆ†åŒºä¸ºä¸¤å¥—ï¼Œå«åšslot Aå’Œslot Bã€‚åœ¨fastbootæ¨¡å¼ä¸‹å¯ä»¥çœ‹åˆ°å½“å‰ä½¿ç”¨çš„æ˜¯å“ªä¸ªåˆ†åŒºã€‚</p></blockquote><p>ç„¶åæ‰§è¡Œä¸‹åˆ—æŒ‡ä»¤æ¸…é™¤ç”¨æˆ·æ•°æ®ï¼š</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">fastboot <span class="hljs-built_in">erase</span> userdata<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‹åˆ—æŒ‡ä»¤è¿›å…¥<code>fastbootd</code>æ¨¡å¼:</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">fastboot reboot fastboot</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152232204.jpg"></p><p>é€‰æ‹©<code>Enter recovery</code>è¿›å…¥åˆ°<code>recovery</code>æ¨¡å¼ï¼Œç„¶åé€‰æ‹©<code>Apply update</code>ï¼Œç»§ç»­é€‰æ‹©<code>Apply from ADB</code>ï¼Œåœ¨æ‰‹æœºåº•éƒ¨çœ‹åˆ°<code>ADB Sideload</code>åï¼Œå°±å¯ä»¥è¾“å…¥ä¸‹åˆ—å‘½ä»¤åˆ·å…¥<code>lineage</code>ç³»ç»Ÿï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">adb</span> sideload lineagexxx.zipæ‰€åœ¨è·¯å¾„<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¼šå¡åœ¨47%ï¼Œä¸è¦æ€¥ï¼Œæ‰§è¡Œå®Œåæ‰‹æœºåº•éƒ¨ä¼šæœ‰å‘½ä»¤æ˜¾ç¤º<code>Install completed</code>ã€‚</p><p>åˆ·å…¥<code>lineag</code>ç³»ç»Ÿåï¼ŒåŒæ ·çš„æ–¹å¼è¿›å…¥åˆ°<code>Apply from ADB</code>ï¼Œæ‰§è¡Œä¸‹åˆ—å‘½ä»¤åˆ·å…¥<code>MindTheGapps</code>ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">adb</span> sideload MindTheGappsxxx.zipæ‰€åœ¨è·¯å¾„<br></code></pre></td></tr></table></figure><p>å…³é”®çš„æ¥äº†ï¼å®ƒä¼šæŠ¥é”™ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152233262.jpg"></p><p>ä¸è¦ç®¡å®ƒï¼Œç‚¹å‡»<code>Yes</code>ç»§ç»­å®‰è£…ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152233793.jpg"></p><p>å®‰è£…æˆåŠŸå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152233803.jpg"></p><p>æœ€åé€‰æ‹©<code>reboot system now</code>å°±å¤§åŠŸå‘Šæˆäº†ã€‚</p><p><code>MindTheGapps</code>å®‰è£…å’Œæ²¡æœ‰å®‰è£…çš„åŒºåˆ«å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152233855.jpg"></p><h1 id="ä¸‰ã€Pixel4åˆ·root"><a href="#ä¸‰ã€Pixel4åˆ·root" class="headerlink" title="ä¸‰ã€Pixel4åˆ·root"></a>ä¸‰ã€Pixel4åˆ·root</h1><h2 id="3-1-å‡†å¤‡å·¥ä½œ"><a href="#3-1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="3.1 å‡†å¤‡å·¥ä½œ"></a>3.1 å‡†å¤‡å·¥ä½œ</h2><ol><li>ä¸‹è½½<code>Magisk</code>ï¼ˆ<a href="https://github.com/topjohnwu/Magisk/releases%EF%BC%89">https://github.com/topjohnwu/Magisk/releasesï¼‰</a></li><li>åˆ·<code>LineageOS</code>æ—¶çš„<code>boot.img</code></li></ol><h2 id="3-2-åˆ·å…¥root"><a href="#3-2-åˆ·å…¥root" class="headerlink" title="3.2 åˆ·å…¥root"></a>3.2 åˆ·å…¥root</h2><p>å…ˆé€šè¿‡æŒ‡ä»¤åœ¨æ‰‹æœºç«¯å®‰è£…<code>Magisk</code></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">adb <span class="hljs-keyword">install</span> Magiskè·¯å¾„(ç”µè„‘ç«¯)<br></code></pre></td></tr></table></figure><p>ç„¶åå°†<code>boot.img</code>å¯¼å…¥æ‰‹æœºç«¯ï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">adb <span class="hljs-keyword">push</span> boot.imgè·¯å¾„(ç”µè„‘ç«¯) <span class="hljs-regexp">/storage/</span>emulated<span class="hljs-regexp">/0/</span>Download(æ‰‹æœºç«¯ï¼Œè¿™é‡Œé€‰æ‹©çš„æ˜¯Magiskçš„ä¸‹è½½è·¯å¾„ï¼Œå¯ä»¥éšæ„)<br></code></pre></td></tr></table></figure><p>æ‰‹æœºç«¯æ‰“å¼€<code>Magisk</code>ï¼Œç‚¹å‡»å®‰è£…ï¼Œé€‰æ‹©<code>ä¿®è¡¥booté•œåƒä¸­çš„vbmeta</code>ï¼Œå†é€‰æ‹©<code>é€‰æ‹©å¹¶ä¿®è¡¥ä¸€ä¸ªæ–‡ä»¶</code>ï¼Œé€‰æ‹©åˆšæ‰ä¼ å…¥çš„<code>boot.img</code>ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307152233622.png"></p><p>ä¿®è¡¥åä¼šåœ¨<code>boot.img</code>çš„åŒæ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆä¸€ä¸ª<code>magisk_patched_xxx.img</code>æ–‡ä»¶ï¼ŒæŠŠ<code>magisk_patched.img</code>ä¼ åˆ°ç”µè„‘ç«¯ï¼Œä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">adb pull <span class="hljs-regexp">/storage/</span>emulated<span class="hljs-regexp">/0/</span>Download/xxx(æ‰‹æœºç«¯) \xxx(ç”µè„‘ç«¯)<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ä½¿æ‰‹æœºè¿›å…¥<code>bootloader</code>ï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">adb reboot bootloader</span><br></code></pre></td></tr></table></figure><p>å°†ä¿®è¡¥çš„<code>boot.img</code>å†™å›<code>boot</code>åˆ†åŒºå¹¶é‡å¯æ‰‹æœºï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">fastboot flash boot (<span class="hljs-attr">--slot</span> <span class="hljs-attribute">all</span>) magisk_patchedxxx<span class="hljs-selector-class">.img</span>æ‰€åœ¨è·¯å¾„<br>fastboot reboot<br></code></pre></td></tr></table></figure><p>æ‰“å¼€<code>Magisk</code>å¯ä»¥å‘ç°è¶…çº§ç”¨æˆ·å’Œæ¨¡å—å¯ä»¥ä½¿ç”¨äº†ï¼Œå³<code>root</code>æˆåŠŸã€‚</p><h1 id="å››ã€æ·»åŠ BurpSuiteè¯ä¹¦"><a href="#å››ã€æ·»åŠ BurpSuiteè¯ä¹¦" class="headerlink" title="å››ã€æ·»åŠ BurpSuiteè¯ä¹¦"></a>å››ã€æ·»åŠ BurpSuiteè¯ä¹¦</h1><p>ç›´æ¥å®‰è£…è¯ä¹¦åªèƒ½å®‰è£…è¿›ç”¨æˆ·é‡Œï¼Œè€Œæœ‰äº› app åªä¿¡ä»»ç³»ç»Ÿçš„æ ¹è¯ä¹¦ï¼Œæ‰€ä»¥éœ€è¦å°† Burp çš„ CA è¯ä¹¦æ·»åŠ åˆ°ç³»ç»Ÿæ ¹è¯ä¹¦é‡Œã€‚</p><p>é¦–å…ˆå¯¼å‡º Burp çš„è¯ä¹¦ï¼Œç„¶åæ‰§è¡Œä¸‹é¢æŒ‡ä»¤ï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">openssl <span class="hljs-keyword">x</span><span class="hljs-number">509</span> -inform DER -subject_hash_old -in è¯ä¹¦è·¯å¾„<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œçš„æ•°å­—å°±æ˜¯å“ˆå¸Œå€¼ã€‚ç„¶åæ‰§è¡Œ</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">openssl</span> x509 -inform DER -in burp.cer -text &gt; æ‰€å¾—åˆ°çš„å“ˆå¸Œå€¼.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>ç”¨è®°äº‹æœ¬ç¼–è¾‘è¯ä¹¦ï¼Œå°†<code>-----BEGIN CERTIFICATE-----</code>åˆ°<code>-----END CERTIFICATE-----</code>çš„éƒ¨åˆ†ï¼ˆä¹Ÿå°±æ˜¯è¯ä¹¦éƒ¨åˆ†ï¼‰æ”¾åˆ°æ–‡ä»¶æœ€å‰é¢ã€‚</p><p>æ‰§è¡Œ</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">adb remount<span class="hljs-regexp">//</span>é‡æ–°æŒ‚è½½è®¾å¤‡çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå°†æ–‡ä»¶ç³»ç»Ÿä»åªè¯»æ¨¡å¼åˆ‡æ¢ä¸ºå¯è¯»å†™æ¨¡å¼<br><span class="hljs-regexp">//</span>å¦‚æœadb remountå¤±è´¥ï¼Œè¯·å…ˆadb rootå†å°è¯•<br>adb push cert<span class="hljs-regexp">/xxxx.0 /</span>sdcard<span class="hljs-regexp">/Download/</span><span class="hljs-regexp">//</span>å°†å¾—åˆ°çš„.<span class="hljs-number">0</span>æ–‡ä»¶æ¨å…¥æ‰‹æœºä¸­<br></code></pre></td></tr></table></figure><p>adb rootæ— æ•ˆçš„è¯ï¼Œå¯èƒ½æ˜¯ä½ æ‰€åˆ·çš„ç³»ç»Ÿå¸¦æœ‰Google APIï¼Œæ‰€ä»¥ä¸å®Œå…¨å¼€æ”¾rootæƒé™ï¼Œè¯¦ç»†å¯å‚è€ƒ<a href="https://developer.android.google.cn/studio/run/managing-avds?hl=zh-cn">åˆ›å»ºå’Œç®¡ç†è™šæ‹Ÿè®¾å¤‡  | Android Studio  | Android Developers (google.cn)</a>ï¼Œå…³é”®è¯´æ˜å¦‚ä¸‹ï¼š</p><blockquote><p>ä¸ºç¡®ä¿åº”ç”¨å®‰å…¨å¹¶ä¸”ä¸å®ä½“è®¾å¤‡çš„ä½“éªŒä¸€è‡´ï¼ŒåŒ…å« Google Play å•†åº—çš„ç³»ç»Ÿæ˜ åƒå·²ä½¿ç”¨å‘å¸ƒå¯†é’¥ç­¾åï¼Œè¿™æ„å‘³ç€ï¼Œæ‚¨æ— æ³•è·å¾—è¿™äº›æ˜ åƒçš„æå‡æƒé™ (root)ã€‚</p><p>å¦‚æœæ‚¨éœ€è¦ä½¿ç”¨æå‡æƒé™ (root) æ¥å¸®åŠ©æ‚¨æ’æŸ¥åº”ç”¨é—®é¢˜ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒ…å« Google åº”ç”¨æˆ–æœåŠ¡çš„ Android å¼€æºé¡¹ç›® (AOSP) ç³»ç»Ÿæ˜ åƒã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>adb root</code> å’Œ <code>adb unroot</code> å‘½ä»¤åœ¨æ™®é€šæƒé™å’Œæå‡æƒé™ä¹‹é—´åˆ‡æ¢ï¼š</p></blockquote><p>å¦‚æœæƒ³è¦å®Œå…¨è·å–rootæƒé™ï¼Œå¯ä»¥å¯»æ‰¾å…¶ä»–å·¥å…·ï¼ˆæš‚æ—¶æ²¡æ‰¾åˆ°èƒ½ç”¨çš„ï¼‰ï¼Œå¦‚æœåªæ˜¯ä¸ºäº†è®©è¯ä¹¦è£…åœ¨ç³»ç»Ÿæ ¹è¯ä¹¦ç›®å½•ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://github.com/NVISOsecurity/MagiskTrustUserCerts">AlwaysTurstUserCerts</a>æ’ä»¶ã€‚</p><p>æ¥ç€æ‰§è¡Œä¸‹åˆ—å‘½ä»¤</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">adb shell  <span class="hljs-regexp">//</span>è¿›å…¥shellæ¨¡å¼<br>cp <span class="hljs-regexp">/sdcard/</span>Download<span class="hljs-regexp">/xxxx.0 /</span>system<span class="hljs-regexp">/etc/</span>security<span class="hljs-regexp">/cacerts/</span> <span class="hljs-regexp">//</span>å°†è¯ä¹¦å¤åˆ¶åˆ°ç³»ç»Ÿæ ¹è¯ä¹¦ç›®å½•ä¸‹<br>chmod <span class="hljs-number">644</span> <span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/security/</span>cacerts<span class="hljs-regexp">/xxxx.0/</span><span class="hljs-regexp">/è®¾ç½®æ–‡ä»¶æƒé™</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨burpçš„è¯ä¹¦å°±åœ¨ç³»ç»Ÿæ ¹è¯ä¹¦ä¸‹äº†ã€‚æˆ‘è¯•äº†ä¸‹ï¼Œé‡å¯åè¿™ä¸ªæ–‡ä»¶å¹¶æ²¡æœ‰æ¶ˆå¤±ï¼Œå¦‚æœæ¶ˆå¤±äº†å°± adb remount, adb shell, cp ä¸ chmod å››æ­¥å°±è¡Œäº†ã€‚</p><p><strong>æ³¨æ„ï¼ï¼ï¼åœ¨æŠ“åŒ…å‰ï¼Œå…ˆæŠŠæ‰‹æœºæ—¶é—´è°ƒåˆ°å½“å‰æ—¶é—´ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°æŠ“åŒ…å¼‚å¸¸ï¼ï¼ï¼ï¼ˆç¨€é‡Œç³Šæ¶‚çš„æˆ‘å†æ¬¡åˆ·æœºäº†ï¼‰</strong></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>åˆ·æœº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidç³»ç»Ÿå¯åŠ¨æµç¨‹</title>
    <link href="/2023/07/04/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    <url>/2023/07/04/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€å¼•è¨€"><a href="#ä¸€ã€å¼•è¨€" class="headerlink" title="ä¸€ã€å¼•è¨€"></a>ä¸€ã€å¼•è¨€</h1><p>åœ¨åˆ†æAndroidç³»ç»Ÿæ¶æ„çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯é™æ€åˆ†æäº†Androidç³»ç»Ÿæ¶æ„ï¼Œè™½ç„¶å¯ä»¥äº†è§£Androidæ¶æ„åœ°å±‚æ¬¡å’ŒåŠŸèƒ½ï¼Œä½†ä¸è¶³ä»¥äº†è§£Androidæ•´ä¸ªç³»ç»Ÿè¿è¡Œæ—¶å„å±‚æ¬¡ä¹‹é—´çš„ä¿¡æ¯ä¼ é€’å’Œäº¤äº’ï¼Œå³ä¸èƒ½çœŸæ­£çœ‹ç©¿Androidçš„è¿è¡Œæœºç†ï¼Œæ•…è¿˜éœ€è¿›ä¸€æ­¥å­¦ä¹ ã€‚</p><p>æ‰€ä»¥æ–°å¼€ä¸€ç¯‡æ–‡ç« ç»“åˆAndroid 8.0æºç æ¥è®²è¿°Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ã€‚</p><h1 id="äºŒã€Androidç³»ç»Ÿå¯åŠ¨æµç¨‹"><a href="#äºŒã€Androidç³»ç»Ÿå¯åŠ¨æµç¨‹" class="headerlink" title="äºŒã€Androidç³»ç»Ÿå¯åŠ¨æµç¨‹"></a>äºŒã€Androidç³»ç»Ÿå¯åŠ¨æµç¨‹</h1><p>è¿™æ˜¯ä¸€å¼ Androidç³»ç»Ÿå¯åŠ¨çš„æµç¨‹å›¾ï¼ˆæ¥è‡ªgityuanï¼‰ã€‚</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307041429364.jpg"></p><p>æ ¹æ®ä¸Šå›¾ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p><ol><li><strong>Boot Loaderé˜¶æ®µ</strong>ï¼šè®¾å¤‡åŠ ç”µåï¼Œé¦–å…ˆè¿è¡Œçš„æ˜¯Boot Loaderç¨‹åºã€‚Boot Loaderä¸»è¦è´Ÿè´£ç¡¬ä»¶åˆå§‹åŒ–å’Œè®¾å¤‡çš„å¼•å¯¼æ“ä½œã€‚</li><li><strong>Kernelé˜¶æ®µ</strong>ï¼šå½“Boot Loaderå®Œæˆåˆå§‹åŒ–æ“ä½œåï¼Œå®ƒä¼šå°†æ§åˆ¶æƒäº¤ç»™å†…æ ¸ã€‚å†…æ ¸æ˜¯Androidç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†ç³»ç»Ÿèµ„æºã€è°ƒåº¦è¿›ç¨‹ç­‰ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå†…æ ¸ä¼šåŠ è½½æ–‡ä»¶ç³»ç»Ÿå’Œé©±åŠ¨ç¨‹åºï¼Œä¸ºæœ€ç»ˆç³»ç»Ÿçš„å¯åŠ¨åšå¥½å‡†å¤‡ã€‚</li><li><strong>Initè¿›ç¨‹é˜¶æ®µ</strong>ï¼šåœ¨Kernelé˜¶æ®µå®Œæˆåï¼ŒInitè¿›ç¨‹å°±ä¼šè¢«å¯åŠ¨ã€‚Initè¿›ç¨‹æ˜¯ç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ç³»ç»Ÿä¸­å…¶ä»–æ‰€æœ‰çš„è¿›ç¨‹ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒInitè¿›ç¨‹ä¼šä¾æ¬¡æ‰§è¡Œinit.rcè„šæœ¬ä¸­å®šä¹‰çš„å„é¡¹ä»»åŠ¡ï¼ŒåŒ…æ‹¬æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€å¯åŠ¨æœåŠ¡ç­‰ã€‚</li><li><strong>Zygoteè¿›ç¨‹é˜¶æ®µ</strong>ï¼šåœ¨Initè¿›ç¨‹å¯åŠ¨å®Œæˆåï¼ŒAndroidç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªåä¸ºZygoteçš„è¿›ç¨‹ï¼Œä»–æ˜¯æ‰€æœ‰Javaåº”ç”¨ç¨‹åºçš„å­µåŒ–å™¨ã€‚Zygoteè¿›ç¨‹ä¼šé¢„åŠ è½½å¤§é‡çš„Javaç±»å’Œèµ„æºï¼Œä»¥æé«˜åº”ç”¨ç¨‹åºçš„å¯åŠ¨é€Ÿåº¦ã€‚å½“ç”¨æˆ·å¯åŠ¨æ–°çš„åº”ç”¨ç¨‹åºæ—¶ï¼ŒZygoteè¿›ç¨‹ä¼šå¤åˆ¶è‡ªèº«å¹¶ç”Ÿæˆæ–°çš„è™šæ‹Ÿæœºå®ä¾‹ï¼Œç„¶ååŠ è½½å¯¹åº”åº”ç”¨ç¨‹åºçš„ä»£ç å¹¶æ‰§è¡Œã€‚</li><li><strong>System Serveré˜¶æ®µ</strong>ï¼šåœ¨Zygoteè¿›ç¨‹å¯åŠ¨å®Œæˆåï¼ŒSystem Serverè¿›ç¨‹å°±ä¼šè¢«å¯åŠ¨ã€‚System Serveræ˜¯æ•´ä¸ªAndroidç³»ç»Ÿä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨å¹¶ç®¡ç†å¤šç§ç³»ç»ŸæœåŠ¡ï¼Œä¾‹å¦‚Activity Managerã€Window Managerã€PackageManagerç­‰ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œç”¨æˆ·æ‰å¯ä»¥çœ‹åˆ°å¼€å§‹ç•Œé¢ï¼Œå¼€å§‹ä½¿ç”¨æ‰‹æœºã€‚</li><li><strong>Launcherå¯åŠ¨é˜¶æ®µ</strong>ï¼šåœ¨System Serverå¯åŠ¨å®Œæˆåï¼Œç³»ç»Ÿä¼šå¼€å§‹å¯åŠ¨Androidåº”ç”¨ç¨‹åºã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå¯åŠ¨å™¨ä¼šå±•ç¤ºæ‰€æœ‰å·²å®‰è£…çš„åº”ç”¨ç¨‹åºï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©å¯åŠ¨æ‰€éœ€åº”ç”¨ç¨‹åºã€‚</li></ol><h2 id="2-1-Boot-Loaderé˜¶æ®µ"><a href="#2-1-Boot-Loaderé˜¶æ®µ" class="headerlink" title="2.1 Boot Loaderé˜¶æ®µ"></a>2.1 Boot Loaderé˜¶æ®µ</h2><p>å½“æ‰‹æœºå¤„äºå…³æœºçŠ¶æ€æ—¶ï¼Œé•¿æŒ‰Poweré”®å¼€æœºï¼Œå¼•å¯¼èŠ¯ç‰‡å¼€å§‹ä»å›ºåŒ–åœ¨ROM é‡Œçš„é¢„è®¾ä»£ç å¼€å§‹æ‰§è¡Œï¼Œå°†å¼•å¯¼ç¨‹åºï¼ˆBoot Loaderï¼‰åŠ è½½åˆ° RAMä¸­å¹¶æ‰§è¡Œï¼Œä¸»è¦ä»»åŠ¡æ˜¯å°†æ“ä½œç³»ç»ŸåŠ è½½åˆ°å†…å­˜ä¸­å¹¶å»ºç«‹å¥½æ“ä½œç³»ç»Ÿè¿è¡Œçš„ç¯å¢ƒï¼Œç„¶åå°†æ§åˆ¶æƒè½¬ç§»åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚</p><h2 id="2-2-Kernelé˜¶æ®µ"><a href="#2-2-Kernelé˜¶æ®µ" class="headerlink" title="2.2 Kernelé˜¶æ®µ"></a>2.2 Kernelé˜¶æ®µ</h2><p>Kernelé˜¶æ®µä¼šå¯åŠ¨Kernelçš„swapperè¿›ç¨‹(pid&#x3D;0)ï¼Œè¯¥è¿›ç¨‹åˆç§°ä¸ºidleè¿›ç¨‹ï¼Œæ˜¯Kernelå¼€åˆ›çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œç”¨äºåˆå§‹åŒ–è¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ï¼ŒåŠ è½½é©±åŠ¨ç­‰ç›¸å…³å·¥ä½œï¼Œä»¥åŠå¯åŠ¨kthreaddè¿›ç¨‹ï¼ˆpid&#x3D;2ï¼‰ï¼Œè¯¥è¿›ç¨‹æ˜¯Linuxç³»ç»Ÿçš„å†…æ ¸è¿›ç¨‹ï¼Œæ˜¯æ‰€æœ‰å†…æ ¸è¿›ç¨‹çš„é¼»ç¥–ï¼Œä¼šåˆ›å»ºå†…æ ¸å·¥ä½œçº¿ç¨‹kworkderï¼Œè½¯ä¸­æ–­çº¿ç¨‹ksoftirqdï¼Œthermalç­‰å†…æ ¸å®ˆæŠ¤è¿›ç¨‹ã€‚Kernelå®Œæˆè¿™äº›å·¥ä½œåï¼Œä¼šåœ¨ç³»ç»Ÿæ–‡ä»¶ä¸­å¯»æ‰¾init.rcæ–‡ä»¶ï¼Œå¹¶å¯åŠ¨initè¿›ç¨‹ã€‚</p><h2 id="2-3-Initè¿›ç¨‹é˜¶æ®µ"><a href="#2-3-Initè¿›ç¨‹é˜¶æ®µ" class="headerlink" title="2.3 Initè¿›ç¨‹é˜¶æ®µ"></a>2.3 Initè¿›ç¨‹é˜¶æ®µ</h2><p><code>init</code>è¿›ç¨‹ï¼ˆpid&#x3D;1ï¼‰æ˜¯<code>Android</code>ç³»ç»Ÿä¸­ç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œæ˜¯æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹çš„é¼»ç¥–ã€‚initæºç åœ¨<code>system/core/init/init.cpp</code>è·¯å¾„ä¸‹ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    ......<br><span class="hljs-comment">// æ·»åŠ ç¯å¢ƒå˜é‡</span><br>    <span class="hljs-built_in">add_environment</span>(<span class="hljs-string">&quot;PATH&quot;</span>, _PATH_DEFPATH);<br>......<br><br>    <span class="hljs-keyword">if</span> (is_first_stage) &#123;<br>        ......<br>        <span class="hljs-comment">// åˆ›å»ºå’ŒæŒ‚è½½å¯åŠ¨æ‰€éœ€è¦çš„æ–‡ä»¶ç›®å½•</span><br>        <span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/dev&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="hljs-string">&quot;mode=0755&quot;</span>);<br>        ......<br>        <span class="hljs-comment">// åˆå§‹åŒ–Kernelçš„æ—¥å¿—</span><br>        <span class="hljs-built_in">InitKernelLogging</span>(argv);<br>        ......<br>    &#125;<br>    ......<br><span class="hljs-comment">// å¯¹å±æ€§æœåŠ¡è¿›è¡Œåˆå§‹åŒ–</span><br>    <span class="hljs-built_in">property_init</span>();<br><br>    ......<br>    <span class="hljs-comment">// è®¾ç½®å­è¿›ç¨‹ä¿¡å·å¤„ç†ï¼Œå¦‚æœå­è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œinitè¿›ç¨‹ä¼šè°ƒç”¨è¯¥å‡½æ•°ä¸­è®¾å®šçš„ä¿¡å·å¤„ç†å‡½æ•°æ¥è¿›è¡Œå¤„ç†</span><br>    <span class="hljs-built_in">signal_handler_init</span>();<br>......<br>    <span class="hljs-comment">//å¯åŠ¨å±æ€§æœåŠ¡</span><br>    <span class="hljs-built_in">start_property_service</span>();<br>    ......<br><br>    <span class="hljs-keyword">if</span> (bootscript.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-comment">//è§£æ init.rcé…ç½®æ–‡ä»¶</span><br>        parser.<span class="hljs-built_in">ParseConfig</span>(<span class="hljs-string">&quot;/init.rc&quot;</span>);<br>        ......<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ......<br>    &#125;<br><br>    ......<br>    <br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">//é‡å¯æ­»å»çš„è¿›ç¨‹</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œåœ¨è§£æ<code>init.rc</code>ï¼ˆ<code>system/core/rootdir/init.rc</code>ï¼‰è¿‡ç¨‹ä¸­ä¼šå­µåŒ–<code>zygote</code>è¿›ç¨‹ã€‚</p><p>ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡º<code>init</code>è¿›ç¨‹é˜¶æ®µä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p><ol><li>åˆ›å»ºå’ŒæŒ‚è½½å¯åŠ¨æ‰€éœ€è¦çš„æ–‡ä»¶ç›®å½•</li><li>åˆå§‹åŒ–å’Œå¯åŠ¨å±æ€§æœåŠ¡</li><li>è§£æ<code>init.rc</code>é…ç½®æ–‡ä»¶å¹¶å­µåŒ–<code>zygote</code>è¿›ç¨‹</li></ol><h2 id="2-4-Zygoteè¿›ç¨‹é˜¶æ®µ"><a href="#2-4-Zygoteè¿›ç¨‹é˜¶æ®µ" class="headerlink" title="2.4 Zygoteè¿›ç¨‹é˜¶æ®µ"></a>2.4 Zygoteè¿›ç¨‹é˜¶æ®µ</h2><p>åœ¨<code>Android</code>ç³»ç»Ÿä¸­ï¼Œ<code>DVM</code>å’Œ<code>ART</code>ã€åº”ç”¨ç¨‹åºè¿›ç¨‹ä»¥åŠè¿è¡Œç³»ç»Ÿçš„å…³é”®æœåŠ¡çš„<code>SystemServer</code>è¿›ç¨‹éƒ½æ˜¯ç”±<code>Zygote</code>è¿›ç¨‹åˆ›å»ºçš„ï¼Œæˆ‘ä»¬ä¹Ÿå°†å®ƒç§°ä¸ºå­µåŒ–å™¨ã€‚å®ƒé€šè¿‡forkï¼ˆå¤åˆ¶è¿›ç¨‹ï¼‰æ¥åˆ›å»º<strong>åº”ç”¨è¿›ç¨‹å’Œ<code>SystemServer</code>è¿›ç¨‹</strong>ï¼Œç”±äº<code>Zygote</code>è¿›ç¨‹åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»º<code>DVM</code>æˆ–è€…<code>ART</code>ï¼Œå› æ­¤é€šè¿‡forkè€Œåˆ›å»ºçš„åº”ç”¨ç¨‹åºè¿›ç¨‹å’Œ<code>SystemServer</code>è¿›ç¨‹å¯ä»¥åœ¨å†…éƒ¨è·å–ä¸€ä¸ª<code>DVM</code>æˆ–è€…<code>ART</code>çš„å®ä¾‹å‰¯æœ¬ã€‚</p><p>é€šè¿‡è§£æ<code>init.rc</code>é…ç½®æ–‡ä»¶å¯ä»¥çŸ¥é“<code>init</code>å¯åŠ¨<code>Zygote</code>æ—¶ä¸»è¦æ˜¯è°ƒç”¨<code>app_main.cpp</code>çš„<code>main</code>æ–¹æ³•ï¼ˆä¹‹åå†åˆ†æï¼‰ï¼Œæ‰€åœ¨è·¯å¾„ä¸º<code>frameworks/base/cmds/app_process/app_main.cpp</code>ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* <span class="hljs-type">const</span> argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    ......<br>    <span class="hljs-keyword">while</span> (i &lt; argc) &#123;<br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* arg = argv[i++];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--zygote&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//å¦‚æœå½“å‰è¿è¡Œåœ¨zygoteè¿›ç¨‹ä¸­ï¼Œåˆ™å°†zygoteè®¾ç½®ä¸ºtrue</span><br>            zygote = <span class="hljs-literal">true</span>;<br>            niceName = ZYGOTE_NICE_NAME;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--start-system-server&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//å¦‚æœå½“å‰è¿è¡Œåœ¨SystemServerè¿›ç¨‹ä¸­ï¼Œåˆ™å°†startSystemServerè®¾ç½®ä¸ºtrue</span><br>            startSystemServer = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--application&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            application = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(arg, <span class="hljs-string">&quot;--nice-name=&quot;</span>, <span class="hljs-number">12</span>) == <span class="hljs-number">0</span>) &#123;<br>            niceName.<span class="hljs-built_in">setTo</span>(arg + <span class="hljs-number">12</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(arg, <span class="hljs-string">&quot;--&quot;</span>, <span class="hljs-number">2</span>) != <span class="hljs-number">0</span>) &#123;<br>            className.<span class="hljs-built_in">setTo</span>(arg);<br>            <span class="hljs-keyword">break</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            --i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    ......<br>    <br>    <span class="hljs-keyword">if</span> (zygote) &#123;<br>        <span class="hljs-comment">//å¯åŠ¨Zygoteè¿›ç¨‹</span><br>        runtime.<span class="hljs-built_in">start</span>(<span class="hljs-string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className) &#123;<br>        runtime.<span class="hljs-built_in">start</span>(<span class="hljs-string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);<br>        <span class="hljs-built_in">app_usage</span>();<br>        <span class="hljs-built_in">LOG_ALWAYS_FATAL</span>(<span class="hljs-string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>zygote</code>è¿›ç¨‹éƒ½æ˜¯é€šè¿‡forkè‡ªèº«æ¥åˆ›å»ºå­è¿›ç¨‹çš„ï¼Œè¿™æ ·<code>Zygote</code>è¿›ç¨‹ä»¥åŠå®ƒçš„å­è¿›ç¨‹éƒ½å¯ä»¥è¿›å…¥<code>app_main.cpp</code>çš„<code>main</code>å‡½æ•°ï¼Œå› æ­¤ä¸ºäº†åŒºåˆ†<code>main</code>å‡½æ•°è¿è¡Œåœ¨å“ªä¸ªè¿›ç¨‹ä¸­ï¼Œå¯¹<code>argc</code>è¿›è¡Œäº†åˆ¤æ–­ã€‚</p><p>æ¥ä¸‹æ¥æŸ¥çœ‹<code>runtime.start()</code>è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å±äº<code>AppRuntime</code>ç±»ï¼Œè€Œè¿™ä¸ªç±»åˆç»§æ‰¿<code>AndroidRuntime</code>ï¼Œè·¯å¾„ä¸º<code>/frameworks/base/core/jni/AndroidRuntime.cpp</code>ï¼Œä½äºç¬¬994è¡Œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AndroidRuntime::start</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* className, <span class="hljs-type">const</span> Vector&lt;String8&gt;&amp; options, <span class="hljs-type">bool</span> zygote)</span></span><br><span class="hljs-function"></span>&#123;<br>    ......<br><br>    <span class="hljs-comment">/* å¯åŠ¨javaè™šæ‹Ÿæœº */</span><br>    JniInvocation jni_invocation;<br>    jni_invocation.<span class="hljs-built_in">Init</span>(<span class="hljs-literal">NULL</span>);<br>    JNIEnv* env;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">startVm</span>(&amp;mJavaVM, &amp;env, zygote) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-built_in">onVmCreated</span>(env);<br><br>    <span class="hljs-comment">//ä¸ºjavaè™šæ‹Ÿæœºæ³¨å†ŒJNIæ–¹æ³•</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">startReg</span>(env) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;Unable to register all android natives\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    ......<br>    <span class="hljs-comment">//classNameä¸ºcom.android.internal.os.ZygoteInit</span><br>    classNameStr = env-&gt;<span class="hljs-built_in">NewStringUTF</span>(className);<br>    ......<br>    <span class="hljs-comment">//å°†å…¨é™å®šç±»åclassNameè½¬æˆè·¯å¾„</span><br>    <span class="hljs-type">char</span>* slashClassName = <span class="hljs-built_in">toSlashClassName</span>(className);<br>    <span class="hljs-comment">//é€šè¿‡slashClassNameæ‰¾åˆ°ZygoteInit</span><br>    jclass startClass = env-&gt;<span class="hljs-built_in">FindClass</span>(slashClassName);<br>    <span class="hljs-keyword">if</span> (startClass == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//æ‰¾åˆ°ZygoteInitçš„mainæ–¹æ³•</span><br>        jmethodID startMeth = env-&gt;<span class="hljs-built_in">GetStaticMethodID</span>(startClass, <span class="hljs-string">&quot;main&quot;</span>,<br>            <span class="hljs-string">&quot;([Ljava/lang/String;)V&quot;</span>);<br>        <span class="hljs-keyword">if</span> (startMeth == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);<br>            <span class="hljs-comment">/* keep going */</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//é€šè¿‡JNIè°ƒç”¨ZygoteInitçš„mainæ–¹æ³•</span><br>            env-&gt;<span class="hljs-built_in">CallStaticVoidMethod</span>(startClass, startMeth, strArray);<br>......    <br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡<code>startVm</code>æ–¹æ³•åˆ›å»ºjavaè™šæ‹Ÿæœºï¼Œç„¶åé€šè¿‡<code>startReg</code>æ–¹æ³•ä¸ºJavaè™šæ‹Ÿæœºæ³¨å†Œ<code>JNI</code>æ–¹æ³•ï¼Œå°†<code>className</code>è½¬æˆè·¯å¾„åï¼Œå³æ‰¾åˆ°<code>ZygoteInit</code>ç±»æ‰€åœ¨ä½ç½®ï¼Œç„¶åé€šè¿‡<code>GetStaticMethodID</code>è·å–<code>main</code>æ–¹æ³•ï¼Œæœ€åé€šè¿‡<code>CallStaticVoidMethod</code>æ–¹æ³•å¯åŠ¨<code>ZygoteInit</code>ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯é€šè¿‡<code>JNI</code>è°ƒç”¨<code>ZygoteInit</code>çš„<code>main</code>æ–¹æ³•ï¼ŒæŸ¥çœ‹<code>ZygoteInit</code>ä¹Ÿå¯ä»¥å‘ç°æ˜¯javaè¯­è¨€ç¼–å†™çš„ã€‚å½“å‰<code>Zygote</code>çš„è¿è¡Œé€»è¾‘åœ¨<code>Native</code>å±‚ä¸­ï¼Œé€šè¿‡<code>JNI</code>è°ƒç”¨javaä»£ç åï¼Œ<code>Zygote</code>å°±è¿›å…¥åˆ°äº†javaæ¡†æ¶å±‚ï¼</p><p>ç»§ç»­æŸ¥çœ‹<code>ZygoteInit</code>ï¼Œæ‰€åœ¨ä½ç½®ä¸º<code>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String argv[])</span> &#123;<br>    ......<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        ......<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªserverç«¯çš„socket,socketNameçš„å€¼ä¸ºzygote</span><br>        zygoteServer.registerServerSocket(socketName);<br><br>        <span class="hljs-keyword">if</span> (!enableLazyPreload) &#123;<br>            ......<br>            <span class="hljs-comment">//é¢„åŠ è½½ç±»å’Œèµ„æº</span><br>            preload(bootTimingsTraceLog);<br>            ......<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Zygote.resetNicePriority();<br>        &#125;<br><br>        ......<br>            <br>        <span class="hljs-keyword">if</span> (startSystemServer) &#123;<br>            <span class="hljs-comment">//å¯åŠ¨systemServerè¿›ç¨‹</span><br>            startSystemServer(abiList, socketName, zygoteServer);<br>        &#125;<br><br>        Log.i(TAG, <span class="hljs-string">&quot;Accepting command socket connections&quot;</span>);<br>        <span class="hljs-comment">//ç­‰å¾…AMSè¯·æ±‚</span><br>        zygoteServer.runSelectLoop(abiList);<br>        zygoteServer.closeServerSocket();<br>    &#125; <span class="hljs-keyword">catch</span> (Zygote.MethodAndArgsCaller caller) &#123;<br>        caller.run();<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        Log.e(TAG, <span class="hljs-string">&quot;System zygote died with exception&quot;</span>, ex);<br>        zygoteServer.closeServerSocket();<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡<code>registerServerSocket</code>æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªåä¸º<code>zygote</code>çš„<code>Server</code>ç«¯çš„<code>socket</code>ï¼Œç”¨äºç­‰å¾…<code>ActivityManagerService</code>è¯·æ±‚<code>Zygote</code>æ¥åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚ç„¶åé¢„åŠ è½½ç±»å’Œèµ„æºã€‚å¯åŠ¨<code>systemServer</code>è¿›ç¨‹ä¹‹åï¼Œé€šè¿‡<code>runSelectLoop</code>æ–¹æ³•ç­‰å¾…<code>AMS</code>è¯·æ±‚åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</p><p>æ€»ç»“ä¸€ä¸‹æ•´ä¸ª<code>Zygote</code>è¿›ç¨‹é˜¶æ®µä¸»è¦çš„ä»»åŠ¡ï¼š</p><ol><li>åˆ›å»º<code>AndroidRuntime</code>å¹¶è°ƒç”¨å…¶<code>start</code>æ–¹æ³•ï¼Œå¯åŠ¨<code>Zygote</code>è¿›ç¨‹ã€‚</li><li>åˆ›å»ºjavaè™šæ‹Ÿæœºå¹¶æ³¨å†Œ<code>JNI</code>æ–¹æ³•ã€‚</li><li>é€šè¿‡<code>JNI</code>è°ƒç”¨<code>ZygoteInit</code>çš„<code>main</code>æ–¹æ³•ï¼Œä½¿<code>Zygote</code>ä»<code>Native</code>å±‚è¿›å…¥åˆ°<code>java</code>æ¡†æ¶å±‚ã€‚</li><li>é€šè¿‡<code>registerServerSocket</code>æ–¹æ³•åˆ›å»ºæœåŠ¡å™¨ç«¯<code>Socket</code>ï¼Œå¹¶é€šè¿‡<code>runSelectLoop</code>æ–¹æ³•ç­‰å¾…<code>AMS</code>è¯·æ±‚æ¥åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚</li><li>å¯åŠ¨<code>SystemServer</code>è¿›ç¨‹ã€‚</li></ol><h2 id="2-5-System-Serveré˜¶æ®µ"><a href="#2-5-System-Serveré˜¶æ®µ" class="headerlink" title="2.5 System Serveré˜¶æ®µ"></a>2.5 System Serveré˜¶æ®µ</h2><p><code>SystemServer</code>å¯åŠ¨ä»£ç ä»åœ¨<code>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code>ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startSystemServer</span><span class="hljs-params">(String abiList, String socketName, ZygoteServer zygoteServer)</span><br>    <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller, RuntimeException &#123;<br>    ......<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        ......<br><br>        <span class="hljs-comment">/* ä»Zygoteè¿›ç¨‹ä¸­forkå‡ºSystemServerè¿›ç¨‹ */</span><br>        pid = Zygote.forkSystemServer(<br>            ......);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);<br>    &#125;<br>        <br>    <span class="hljs-comment">/* For child process */</span><br>    <span class="hljs-comment">//å­è¿›ç¨‹æ˜¯å¦è¿è¡Œåœ¨SystemServerè¿›ç¨‹ä¸­</span><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (hasSecondZygote(abiList)) &#123;<br>            waitForSecondaryZygote(socketName);<br>        &#125;<br><span class="hljs-comment">//å…³é—­Zygoteè¿›ç¨‹åˆ›å»ºçš„Socket</span><br>        zygoteServer.closeServerSocket();<br>        <span class="hljs-comment">//å¯åŠ¨SystemServerè¿›ç¨‹</span><br>        handleSystemServerProcess(parsedArgs);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äº<code>SystemServer</code>è¿›ç¨‹forkäº†<code>Zygote</code>è¿›ç¨‹ï¼Œæ‰€ä»¥è¯¥è¿›ç¨‹ä¹Ÿä¼šå¾—åˆ°<code>Zygote</code>è¿›ç¨‹åˆ›å»ºçš„<code>Socket</code>ï¼Œè¿™ä¸ª<code>Socket</code>å¯¹äº<code>SystemServer</code>è¿›ç¨‹æ²¡æœ‰ç”¨å¤„ï¼Œæ‰€ä»¥éœ€è¦å…³é—­ã€‚æœ€åé€šè¿‡<code>handleSystemServerProcess</code>æ–¹æ³•å¯åŠ¨<code>SystemServer</code>è¿›ç¨‹ã€‚</p><p>æ¥ä¸‹æ¥æŸ¥çœ‹<code>handleSystemServerProcess</code>æ–¹æ³•ï¼Œå…¶ä»£ç ä½äºåŒæ ·çš„è·¯å¾„ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSystemServerProcess</span><span class="hljs-params">(ZygoteConnection.Arguments parsedArgs)</span><br>    <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br><br>    ......<br><br>    <span class="hljs-keyword">if</span> (parsedArgs.invokeWith != <span class="hljs-literal">null</span>) &#123;<br>        ......<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (systemServerClasspath != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//åˆ›å»ºPathClassLoader</span><br>            cl = createPathClassLoader(systemServerClasspath, parsedArgs.targetSdkVersion);<br><br>            Thread.currentThread().setContextClassLoader(cl);<br>        &#125;<br><br>        <span class="hljs-comment">//è°ƒç”¨zygoteInitæ–¹æ³•</span><br>        ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¸ª<code>zygoteInit</code>æ–¹æ³•ï¼Œå…¶ä»£ç è¿˜æ˜¯ä½äºåŒæ ·çš„è·¯å¾„ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">zygoteInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span><br>    <span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>    <span class="hljs-keyword">if</span> (RuntimeInit.DEBUG) &#123;<br>        Slog.d(RuntimeInit.TAG, <span class="hljs-string">&quot;RuntimeInit: Starting application from zygote&quot;</span>);<br>    &#125;<br><br>    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;ZygoteInit&quot;</span>);<br>    RuntimeInit.redirectLogStreams();<br><br>    RuntimeInit.commonInit();<br>    <span class="hljs-comment">//å¯åŠ¨Binderçº¿ç¨‹æ± </span><br>    ZygoteInit.nativeZygoteInit();<br>    <span class="hljs-comment">//è¿›å…¥SystemServerçš„mainæ–¹æ³•</span><br>    RuntimeInit.applicationInit(targetSdkVersion, argv, classLoader);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>nativeZygoteInit</code>æ–¹æ³•é¡¾åæ€ä¹‰æ˜¯<code>native</code>å±‚çš„æ–¹æ³•ï¼Œç”¨æ¥å¯åŠ¨<code>Binder</code>çº¿ç¨‹æ± ï¼ˆéœ€è¦å…ˆäº†è§£JNIï¼Œè¿™é‡Œå…ˆä¸è§£é‡Šï¼‰ï¼Œè¿™æ ·<code>SystemServer</code>è¿›ç¨‹å°±å¯ä»¥ä½¿ç”¨<code>Binder</code>ä¸å…¶ä»–è¿›ç¨‹è¿›è¡Œé€šä¿¡äº†ã€‚<code>applicationInit</code>æ–¹æ³•åˆ™æ˜¯ç”¨äºè¿›å…¥åˆ°<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•ï¼Œå¯¹åº”æ–¹æ³•æ‰€åœ¨è·¯å¾„ä¸º<code>/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applicationInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span><br><span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>    ......<br>    <span class="hljs-comment">// Remaining arguments are passed to the start class&#x27;s static main</span><br>    invokeStaticMain(args.startClass, args.startArgs, classLoader);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>invokeStaticMain</code>æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼ˆä½äºç›¸åŒè·¯å¾„ä¸‹ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeStaticMain</span><span class="hljs-params">(String className, String[] argv, ClassLoader classLoader)</span><br><span class="hljs-keyword">throws</span> Zygote.MethodAndArgsCaller &#123;<br>    Class&lt;?&gt; cl;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//é€šè¿‡åå°„å¾—åˆ°SystemServerç±»</span><br>        cl = Class.forName(className, <span class="hljs-literal">true</span>, classLoader);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>        ......<br>    &#125;<br><br>    Method m;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//æ‰¾åˆ°SystemServerçš„mainæ–¹æ³•</span><br>        m = cl.getMethod(<span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String[].class &#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;<br>        ......<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException ex) &#123;<br>        ......<br>    &#125;<br><br>    ......<br>    <span class="hljs-comment">//æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ä¸­è°ƒç”¨äº†SystemServerçš„mainæ–¹æ³•</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Zygote</span>.MethodAndArgsCaller(m, argv);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è·å–<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•ï¼Œå¹¶ä¼ å…¥<code>MethodAndArgsCaller</code>å¼‚å¸¸ä¸­ï¼Œæ•è·è¯¥å¼‚å¸¸çš„ä»£ç åœ¨<code>ZygoteInit.java</code>çš„<code>main</code>æ–¹æ³•ä¸­ï¼ˆç¬¬766è¡Œï¼‰ï¼Œè¿™ä¸ª<code>main</code>æ–¹æ³•ä¼šè°ƒç”¨<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>&#123;<br>    ......<br>&#125; <span class="hljs-keyword">catch</span> (Zygote.MethodAndArgsCaller caller) &#123;<br>    caller.run();<br>&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    Log.e(TAG, <span class="hljs-string">&quot;System zygote died with exception&quot;</span>, ex);<br>    zygoteServer.closeServerSocket();<br>    <span class="hljs-keyword">throw</span> ex;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æ•è·åˆ°<code>MethodAndArgsCaller</code>å¼‚å¸¸æ—¶ï¼Œå°±ä¼šè°ƒç”¨<code>MethodAndArgsCaller</code>çš„<code>run</code>æ–¹æ³•ï¼Œè·¯å¾„ä¸º<code>/frameworks/base/core/java/com/android/internal/os/Zygote.java</code>ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodAndArgsCaller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span><br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-comment">/** method to call */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method mMethod;<br><br>    <span class="hljs-comment">/** argument array */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] mArgs;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodAndArgsCaller</span><span class="hljs-params">(Method method, String[] args)</span> &#123;<br>        mMethod = method;<br>        mArgs = args;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            mMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; mArgs &#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);<br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>            <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> ex.getCause();<br>            <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> RuntimeException) &#123;<br>                <span class="hljs-keyword">throw</span> (RuntimeException) cause;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> Error) &#123;<br>                <span class="hljs-keyword">throw</span> (Error) cause;<br>            &#125;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬å°†<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•ä½œä¸ºå‚æ•°ä¼ å…¥äº†<code>MethodAndArgsCaller</code>å¼‚å¸¸ä¸­ï¼Œæ‰€ä»¥<code>mMethod.invoke</code>å³æ˜¯<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•çš„<code>invoke</code>ï¼Œå³<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•è¢«è°ƒç”¨ã€‚</p><blockquote><p>æ‰€ä»¥ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨<code>invokeStaticMain</code>æ–¹æ³•ä¸­è°ƒç”¨<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•å‘¢ï¼Œåè€Œæ˜¯è¦é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥è°ƒç”¨ï¼Ÿ</p><p>ç­”ï¼šå› ä¸ºåœ¨<code>Zygote</code>å¯åŠ¨<code>SystemServer</code>è¿›ç¨‹åï¼Œ<code>SystemServer</code>è¿›ç¨‹åšäº†å¾ˆå¤šå‡†å¤‡å·¥ä½œï¼Œè¿™ä½¿å¾—<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•çœ‹èµ·æ¥ä¸åƒæ˜¯<code>SystemServer</code>è¿›ç¨‹çš„å…¥å£æ–¹æ³•ã€‚è€ŒæŠ›å‡ºå¼‚å¸¸çš„å¤„ç†ä¼šæ¸…é™¤æ‰€æœ‰çš„è®¾ç½®è¿‡ç¨‹éœ€è¦çš„å †æ ˆå¸§ï¼Œä¼šä½¿å¾—<code>SystemServer</code>çš„<code>main</code>æ–¹æ³•çœ‹èµ·æ¥åƒæ˜¯<code>SystemServer</code>è¿›ç¨‹çš„å…¥å£æ–¹æ³•ã€‚</p></blockquote><p><code>SystemServer</code>çš„<code>main</code>æ–¹æ³•å¯¹åº”ä»£ç è·¯å¾„ä¸º<code>/frameworks/base/services/java/com/android/server/SystemServer.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemServer</span>().run();<br>&#125;<br>......<br>    <br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        ......<br>        <span class="hljs-comment">//åˆ›å»ºæ¶ˆæ¯Looper</span><br>        Looper.prepareMainLooper();<br>        <span class="hljs-comment">//åŠ è½½åŠ¨æ€åº“libandroid_servers.so</span><br>        System.loadLibrary(<span class="hljs-string">&quot;android_servers&quot;</span>);<br>        performPendingShutdown();<br><br>        <span class="hljs-comment">//åˆ›å»ºç³»ç»Ÿçš„Context</span><br>        createSystemContext();<br><br>        <span class="hljs-comment">//åˆ›å»ºSystemServiceManager</span><br>        mSystemServiceManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemServiceManager</span>(mSystemContext);<br>        mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);<br>        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);<br>        <span class="hljs-comment">// Prepare the thread pool for init tasks that can be parallelized</span><br>        SystemServerInitThreadPool.get();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        traceEnd();  <span class="hljs-comment">// InitBeforeStartServices</span><br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        traceBeginAndSlog(<span class="hljs-string">&quot;StartServices&quot;</span>);<br>        <span class="hljs-comment">//å¯åŠ¨å¼•å¯¼æœåŠ¡</span><br>        startBootstrapServices();<br>        <span class="hljs-comment">//å¯åŠ¨æ ¸å¿ƒæœåŠ¡</span><br>        startCoreServices();<br>        <span class="hljs-comment">//å¯åŠ¨å…¶ä»–æœåŠ¡</span><br>        startOtherServices();<br>        SystemServerInitThreadPool.shutdown();<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        ......<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        traceEnd();<br>    &#125;<br>    ......<br><br>    <span class="hljs-comment">// Loop forever.</span><br>    Looper.loop();<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆä¼šåˆ›å»ºæ¶ˆæ¯<code>Looper</code>ã€åŠ è½½åº“ã€åˆ›å»ºç³»ç»Ÿ<code>context</code>ï¼Œç„¶ååˆ›å»º<code>SystemServiceManager</code>æ¥å¯¹ç³»ç»ŸæœåŠ¡è¿›è¡Œåˆ›å»ºã€å¯åŠ¨å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ç„¶åä¼šå¯åŠ¨å„ç§æœåŠ¡ï¼ŒåŒ…æ‹¬<code>ActivityManagerService</code>ã€<code>PackageManagerService</code>ã€<code>WindowManagerService</code>ç­‰æœåŠ¡ã€‚æœ€å<code>Looper</code>å¾ªç¯ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ã€‚</p><p>æ€»ç»“ä¸€ä¸‹æ•´ä¸ª<code>System Server</code>è¿›ç¨‹é˜¶æ®µçš„ä¸»è¦ä»»åŠ¡ï¼š</p><ol><li>å¯åŠ¨<code>Binder</code>çº¿ç¨‹æ± ã€‚</li><li>åˆ›å»º<code>SystemServiceManager</code>ï¼Œç”¨äºå¯¹ç³»ç»ŸæœåŠ¡è¿›è¡Œåˆ›å»ºã€å¯åŠ¨å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</li><li>å¯åŠ¨å„ç§ç³»ç»ŸæœåŠ¡ã€‚</li></ol><h2 id="2-6-Launcherè¿›ç¨‹é˜¶æ®µ"><a href="#2-6-Launcherè¿›ç¨‹é˜¶æ®µ" class="headerlink" title="2.6 Launcherè¿›ç¨‹é˜¶æ®µ"></a>2.6 Launcherè¿›ç¨‹é˜¶æ®µ</h2><p>ç³»ç»Ÿå¯åŠ¨çš„æœ€åä¸€æ­¥æ˜¯å¯åŠ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºæ¥æ˜¾ç¤ºç³»ç»Ÿä¸­å·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºå°±æ˜¯<code>Launcher</code>ï¼Œé€šä¿—æ¥è®²å°±æ˜¯Androidç³»ç»Ÿçš„æ¡Œé¢ï¼Œå®ƒæ˜¯<code>Zygote</code>è¿›ç¨‹å­µåŒ–çš„ç¬¬ä¸€ä¸ªAPPã€‚<code>Launcher</code>åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè¯·æ±‚<code>PackageManagerService</code>è¿”å›ç³»ç»Ÿä¸­å·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯å°è£…æˆä¸€ä¸ªå¿«æ·å›¾æ ‡åˆ—è¡¨æ˜¾ç¤ºåœ¨ç³»ç»Ÿå±å¹•ä¸Šï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»å›¾æ ‡æ¥å¯åŠ¨ç›¸åº”çš„åº”ç”¨ç¨‹åºã€‚</p><p><code>Launcher</code>é€šè¿‡<code>startOtherServices</code>å¯åŠ¨ï¼Œå¯åŠ¨å…¥å£ä¸º<code>AMS</code>çš„<code>systemReady</code>æ–¹æ³•ï¼ˆç¬¬1646è¡Œï¼‰ï¼Œæ‰€åœ¨è·¯å¾„ä¸º<code>frameworks/base/services/java/com/android/server/SystemServer.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOhterServices</span><span class="hljs-params">()</span>&#123;<br>    ......<br>    mActivityManagerService.systemReady(() -&gt; &#123;<br>            Slog.i(TAG, <span class="hljs-string">&quot;Making services ready&quot;</span>);<br>            traceBeginAndSlog(<span class="hljs-string">&quot;StartActivityManagerReadyPhase&quot;</span>);<br>            mSystemServiceManager.startBootPhase(<br>                    SystemService.PHASE_ACTIVITY_MANAGER_READY);<br>        ......<br>    &#125;<br>......<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>AMS</code>çš„<code>systemReady</code>æ–¹æ³•ä»£ç ï¼Œæ‰€åœ¨è·¯å¾„ä¸º<code>/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">systemReady</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Runnable goingCallback, BootTimingsTraceLog traceLog)</span> &#123;<br>    ......<br>    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) &#123;<br>        ......<br>        mStackSupervisor.resumeFocusedStackTopActivityLocked();<br>        mUserController.sendUserSwitchBroadcastsLocked(-<span class="hljs-number">1</span>, currentUserId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>ActivityStackSupervisor</code>çš„<code>resumeFocusedStackTopActivityLocked</code>æ–¹æ³•ï¼Œæ‰€åœ¨è·¯å¾„ä¸º<code>/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeFocusedStackTopActivityLocked</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> resumeFocusedStackTopActivityLocked(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeFocusedStackTopActivityLocked</span><span class="hljs-params">(</span><br><span class="hljs-params">    ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> &#123;<br>    <span class="hljs-keyword">if</span> (targetStack != <span class="hljs-literal">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;<br>        <span class="hljs-keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);<br>    &#125;<br>    ......<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº†é‡è½½ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨æ˜¯<code>ActivityStack</code>çš„<code>resumeTopActivityUncheckedLocked</code>æ–¹æ³•ï¼Œæ‰€åœ¨è·¯å¾„ä¸º<code>/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeTopActivityUncheckedLocked</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options)</span> &#123;<br>    ......<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// Protect against recursion.</span><br>        mStackSupervisor.inResumeTopActivity = <span class="hljs-literal">true</span>;<br>        result = resumeTopActivityInnerLocked(prev, options);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        mStackSupervisor.inResumeTopActivity = <span class="hljs-literal">false</span>;<br>    &#125;<br>   <br>    mStackSupervisor.checkReadyForSleepLocked();<br><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸»è¦æ˜¯è°ƒç”¨äº†<code>resumeTopActivityInnerLocked</code>æ–¹æ³•ï¼ˆåœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬2305è¡Œï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeTopActivityInnerLocked</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options)</span> &#123;<br>   ......<br>   <span class="hljs-keyword">return</span> isOnHomeDisplay() &amp;&amp;<br>          mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, <span class="hljs-string">&quot;prevFinished&quot;</span>);<br>   ......               <br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®çš„åœ°æ–¹æ˜¯è°ƒç”¨äº†<code>ActivityStackSupervisor</code>çš„<code>resumeHomeStackTask</code>æ–¹æ³•ï¼Œæ‰€åœ¨è·¯å¾„ä¸º<code>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeHomeStackTask</span><span class="hljs-params">(ActivityRecord prev, String reason)</span> &#123;<br>    ......<br>    <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span> &amp;&amp; !r.finishing) &#123;<br>        moveFocusableActivityStackToFrontLocked(r, myReason);<br>        <span class="hljs-keyword">return</span> resumeFocusedStackTopActivityLocked(mHomeStack, prev, <span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> mService.startHomeActivityLocked(mCurrentUser, myReason);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®çš„åœ°æ–¹æ˜¯è°ƒç”¨äº†<code>ActivityService</code>çš„<code>startHomeActivityLocked</code>æ–¹æ³•ï¼Œæ‰€åœ¨è·¯å¾„ä¸º<code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">startHomeActivityLocked</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String reason)</span> &#123;<br>    <span class="hljs-comment">//åˆ¤æ–­å·¥å‚æ¨¡å¼å’ŒmTopActionå€¼ï¼Œç¬¦åˆè¦æ±‚åˆ™ç»§ç»­æ‰§è¡Œ</span><br>    <span class="hljs-keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL<br>        &amp;&amp; mTopAction == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">//åˆ›å»ºLauncherå¯åŠ¨æ‰€éœ€è¦çš„Intent</span><br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> getHomeIntent();<br>    <span class="hljs-comment">//ä½¿ç”¨Intentå¯¹åº”çš„Activityä¿¡æ¯</span><br>    <span class="hljs-type">ActivityInfo</span> <span class="hljs-variable">aInfo</span> <span class="hljs-operator">=</span> resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);<br>    <span class="hljs-keyword">if</span> (aInfo != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// è®¾ç½®Intentçš„ç»„ä»¶ä¸ºè§£æå¾—åˆ°çš„Activityç»„ä»¶</span><br>        intent.setComponent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(aInfo.applicationInfo.packageName, aInfo.name));<br>        <span class="hljs-comment">// åˆ›å»ºæ–°çš„ActivityInfoå¯¹è±¡ï¼Œå¹¶å°†applicationInfoè®¾ç½®ä¸ºç›¸åº”ç”¨æˆ·IDä¸‹çš„åº”ç”¨ç¨‹åºä¿¡æ¯</span><br>        aInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityInfo</span>(aInfo);<br>        aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);<br>        <span class="hljs-comment">// è·å–æŒ‡å®šåç§°å’ŒUIDçš„è¿›ç¨‹è®°å½•</span><br>        <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> getProcessRecordLocked(aInfo.processName, Info.applicationInfo.uid, <span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// å¦‚æœè¿›ç¨‹è®°å½•ä¸å­˜åœ¨æˆ–è¿›ç¨‹è®°å½•æ²¡æœ‰å…³è”çš„instrumentation</span><br>        <span class="hljs-keyword">if</span> (app == <span class="hljs-literal">null</span> || app.instr == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// è®¾ç½®Intentæ ‡å¿—åŒ…å«FLAG_ACTIVITY_NEW_TASKï¼Œè¡¨ç¤ºåœ¨æ–°ä»»åŠ¡ä¸­å¯åŠ¨Homeæ´»åŠ¨</span><br>            intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">resolvedUserId</span> <span class="hljs-operator">=</span> UserHandle.getUserId(aInfo.applicationInfo.uid);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">myReason</span> <span class="hljs-operator">=</span> reason + <span class="hljs-string">&quot;:&quot;</span> + userId + <span class="hljs-string">&quot;:&quot;</span> + resolvedUserId;<br>            <span class="hljs-comment">// å¯åŠ¨Launcher</span><br>            mActivityStarter.startHomeActivityLocked(intent, aInfo, myReason);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Slog.wtf(TAG, <span class="hljs-string">&quot;No home screen found for &quot;</span> + intent, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Throwable</span>());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºäº†ä¸€ä¸ª<code>Intent</code>ï¼Œå¹¶å°†<code>mTopAction</code>å’Œ<code>mTopData</code>ä¼ å…¥ã€‚<code>mTopAction</code>çš„å€¼ä¸º<code>Intent.ACTION_MAIN</code>ï¼Œå¹¶ä¸”å¦‚æœç³»ç»Ÿè¿è¡Œæ¨¡å¼ä½çº§å·¥å‚æ¨¡å¼ï¼Œåˆ™å°†<code>intent</code>çš„<code>Category</code>è®¾ç½®ä¸º<code>android.intent.category.HOME</code>ï¼ˆå…·ä½“ç»†èŠ‚è¯·è·Ÿè¿›<code>getHomeIntent</code>æ–¹æ³•æŸ¥çœ‹ï¼‰ã€‚åœ¨<code>AndroidManifest</code>æ–‡ä»¶ï¼ˆ<code>/packages/apps/Launcher3/AndroidManifest.xml</code>ï¼‰ä¸­æŸ¥çœ‹<code>intent-filter</code>å¯ä»¥çŸ¥é“ï¼Œèƒ½ä¸è¯¥<code>Intent</code>åŒ¹é…çš„æ˜¯<code>Launcher</code>ã€‚ä¹‹åå°±æ˜¯åˆ¤æ–­<code>Launcher</code>æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨<code>ActivityStarter</code>çš„<code>startHomeActivityLocked</code>æ–¹æ³•å¯åŠ¨ï¼Œæ‰€åœ¨è·¯å¾„ä¸º<code>/frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">startHomeActivityLocked</span><span class="hljs-params">(Intent intent, ActivityInfo aInfo, String reason)</span> &#123;<br>    <span class="hljs-comment">//å°†Launcheræ”¾å…¥HomeStackä¸­</span><br>    mSupervisor.moveHomeStackTaskToTop(reason);<br>    <span class="hljs-comment">//å¯åŠ¨Launcher</span><br>mLastHomeActivityStartResult = startActivityLocked(<span class="hljs-literal">null</span> <span class="hljs-comment">/*caller*/</span>, intent,<br><span class="hljs-literal">null</span> <span class="hljs-comment">/*ephemeralIntent*/</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/*resolvedType*/</span>, aInfo, <span class="hljs-literal">null</span> <span class="hljs-comment">/*rInfo*/</span>,<br><span class="hljs-literal">null</span> <span class="hljs-comment">/*voiceSession*/</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/*voiceInteractor*/</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/*resultTo*/</span>,<br><span class="hljs-literal">null</span> <span class="hljs-comment">/*resultWho*/</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/*requestCode*/</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/*callingPid*/</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/*callingUid*/</span>,<br><span class="hljs-literal">null</span> <span class="hljs-comment">/*callingPackage*/</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/*realCallingPid*/</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/*realCallingUid*/</span>,<br><span class="hljs-number">0</span> <span class="hljs-comment">/*startFlags*/</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/*options*/</span>, <span class="hljs-literal">false</span> <span class="hljs-comment">/*ignoreTargetSecurity*/</span>,<br><span class="hljs-literal">false</span> <span class="hljs-comment">/*componentSpecified*/</span>, mLastHomeActivityStartRecord <span class="hljs-comment">/*outActivity*/</span>,<br><span class="hljs-literal">null</span> <span class="hljs-comment">/*container*/</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/*inTask*/</span>, <span class="hljs-string">&quot;startHomeActivity: &quot;</span> + reason);<br>    <span class="hljs-keyword">if</span> (mSupervisor.inResumeTopActivity) &#123;<br>        mSupervisor.scheduleResumeTopActivities();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†<code>Launcher</code>æ”¾å…¥<code>HomeStack</code>ä¸­ï¼Œ<code>HomeStack</code>æ˜¯åœ¨<code>ActivityStackSupervisor</code>ä¸­å®šä¹‰çš„ç”¨äºå­˜å‚¨<code>Launcher</code>çš„å˜é‡ã€‚æ¥ç€è°ƒç”¨<code>startActivityLocked</code>æ–¹æ³•æ¥å¯åŠ¨<code>Launcher</code>ã€‚</p><h1 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h1><p>ä»¥ä¸Šåªæ˜¯ç®€å•çš„æ¢³ç†äº†ä¸€éAndroidç³»ç»Ÿå¯åŠ¨çš„æµç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸ºï¼šè®¾å¤‡å¼€æœºåï¼Œå¤„äº<code>Boot Loader</code>é˜¶æ®µï¼ŒåŠ è½½å¹¶æ‰§è¡Œå¼•å¯¼ç¨‹åºï¼Œä¸ºæ“ä½œç³»ç»Ÿå»ºç«‹å¥½ç¯å¢ƒä¹‹åï¼Œå°†æ§åˆ¶æƒè½¬ç§»ç»™æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œè¿›å…¥åˆ°<code>kernel</code>é˜¶æ®µã€‚<code>kernel</code>é˜¶æ®µä¼šå¯åŠ¨<code>swapper</code>è¿›ç¨‹åˆå§‹åŒ–è¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ï¼ŒåŠ è½½é©±åŠ¨ç­‰ç›¸å…³å·¥ä½œï¼Œå¯åŠ¨<code>kthreadd</code>è¿›ç¨‹ï¼Œä¹‹åä¼šå¯åŠ¨<code>init</code>è¿›ç¨‹è¿›å…¥åˆ°<code>init</code>é˜¶æ®µã€‚<code>init</code>é˜¶æ®µä¼šåˆ›å»ºå’ŒæŒ‚è½½å¯åŠ¨æ‰€éœ€è¦çš„æ–‡ä»¶ç›®å½•ï¼Œåˆå§‹åŒ–å’Œå¯åŠ¨å±æ€§æœåŠ¡ï¼Œä¹‹åå¯åŠ¨<code>zygote</code>è¿›ç¨‹è¿›å…¥åˆ°<code>zygote</code>é˜¶æ®µã€‚<code>zygote</code>é˜¶æ®µä¼šåˆ›å»ºjavaè™šæ‹Ÿæœºå¹¶æ³¨å†Œ<code>JNI</code>æ–¹æ³•ï¼Œä½¿<code>Zygote</code>ä»<code>Native</code>å±‚è¿›å…¥åˆ°<code>java</code>æ¡†æ¶å±‚ï¼Œåˆ›å»ºæœåŠ¡å™¨ç«¯<code>Socket</code>ï¼Œç”¨äºæ¶ˆæ¯é€šä¿¡ï¼Œä¹‹åå¯åŠ¨<code>SystemServer</code>è¿›ç¨‹è¿›å…¥åˆ°<code>SystemServer</code>é˜¶æ®µã€‚<code>SystemServer</code>é˜¶æ®µä¼šå¯åŠ¨<code>Binder</code>çº¿ç¨‹æ± ï¼Œåˆ›å»º<code>SystemServiceManager</code>ç®¡ç†ç³»ç»ŸæœåŠ¡ï¼Œä¹‹åå¯åŠ¨å„ç§ç³»ç»ŸæœåŠ¡ï¼Œå…¶ä¸­åŒ…æ‹¬<code>Launcher</code>ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€å¸¸è§çš„ç³»ç»Ÿæ¡Œé¢ã€‚</p><p>ç„¶è€Œï¼Œæœ¬ç¯‡æ–‡ç« çœç•¥äº†å¾ˆå¤šç»†èŠ‚ï¼Œå¹¶æ²¡æœ‰æ·±å…¥åˆ†æå„ä¸ªé˜¶æ®µçš„ç›¸å…³ä»£ç ï¼Œå¹¶ä¸”åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸€äº›æ²¡æœ‰äº†è§£è¿‡çš„ä¸œè¥¿ï¼Œæ¯”å¦‚<code>rc</code>æ–‡ä»¶ä»¥åŠå¦‚ä½•è§£æ<code>rc</code>æ–‡ä»¶ã€ <code>Binder</code>é€šä¿¡ã€ç³»ç»ŸæœåŠ¡çš„ç®¡ç†ã€Activityçš„ç®¡ç†ç­‰ã€‚è¿™äº›éƒ½éœ€è¦ç§¯ç´¯ä¸€å®šçš„åŸºç¡€ï¼Œè¿›ä¸€æ­¥æ·±å…¥å­¦ä¹ ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="http://liuwangshu.cn/tags/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8/">Androidç³»ç»Ÿå¯åŠ¨ç¯‡ | BATcoder - åˆ˜æœ›èˆ’ (liuwangshu.cn)</a>ï¼ˆAndroidç³»ç»Ÿå¯åŠ¨ç³»åˆ—ç¯‡ï¼‰</p><p><a href="http://gityuan.com/android/">Android æ“ä½œç³»ç»Ÿæ¶æ„å¼€ç¯‡ - Gityuanåšå®¢ | è¢è¾‰è¾‰çš„æŠ€æœ¯åšå®¢</a>ï¼ˆæ‰¾ç³»ç»Ÿå¯åŠ¨ç³»åˆ—ç¯‡ï¼‰</p><p><a href="https://zhuanlan.zhihu.com/p/350204291">æ·±å…¥ç ”ç©¶æºç ï¼šAndroid10.0ç³»ç»Ÿå¯åŠ¨æµç¨‹ï¼ˆä¸€ï¼‰ - çŸ¥ä¹ (zhihu.com)</a>ï¼ˆä¸»é¡µæ‰¾ç³»åˆ—ç¯‡ï¼‰</p><p><a href="https://www.jianshu.com/p/2c1318b0f527">Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/127074795">Androidæ“ä½œç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹æ¦‚è§ˆ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="http://aospxref.com/">AOSPXRef</a></p><p><a href="">ã€ŠAndroidè¿›é˜¶è§£å¯†ã€‹</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>Androidæºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android Intent</title>
    <link href="/2023/07/04/Android%20Intent/"/>
    <url>/2023/07/04/Android%20Intent/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h1><p>Intentæ˜¯Androidå››å¤§ç»„ä»¶é€šä¿¡æ¡¥æ¢ï¼Œå®ƒè´Ÿè´£åœ¨ç»„ä»¶ä¹‹é—´ä¼ é€’æ¶ˆæ¯å’Œæ•°æ®ï¼Œæ˜¯ä¸€ä¸ªæ¶ˆæ¯ä¼ é€’å¯¹è±¡ã€‚é€šè¿‡ä½¿ç”¨Intentï¼Œå¯ä»¥å¯åŠ¨å¦ä¸€ä¸ªæ´»åŠ¨Activityã€æœåŠ¡Serviceã€å¹¿æ’­æ¥æ”¶å™¨BroadcastReceiverï¼Œä»¥åŠå‘é€å’Œæ¥æ”¶æ•°æ®ã€‚</p><h1 id="äºŒã€Intentçš„ä¸¤ç§ç±»å‹"><a href="#äºŒã€Intentçš„ä¸¤ç§ç±»å‹" class="headerlink" title="äºŒã€Intentçš„ä¸¤ç§ç±»å‹"></a>äºŒã€Intentçš„ä¸¤ç§ç±»å‹</h1><p>æ˜¾å¼Intentå¤šç”¨æ¥å®ç°ä¸€ä¸ªåº”ç”¨å†…éƒ¨çš„è·³è½¬ï¼Œè€Œéšå¼intentå¤šç”¨æ¥å®ç°åº”ç”¨ä¸åº”ç”¨ä¹‹é—´çš„è·³è½¬</p><ol><li><p><strong>æ˜¾ç¤ºIntent</strong></p><p>æ˜ç¡®æŒ‡å®šäº†è¦å¯åŠ¨çš„ç›®æ ‡ç»„ä»¶çš„åç§°ã€‚</p><blockquote><p> <strong>å€¼å¾—æ³¨æ„çš„æ˜¯ä»Android 5.0å¼€å§‹ï¼Œ Service åªèƒ½é€šè¿‡æ˜¾å¼ Intent å¯åŠ¨ï¼Œå¦‚æœä½¿ç”¨éšå¼ Intent è°ƒç”¨ bindService()ï¼Œç³»ç»Ÿä¼šå¼•å‘å¼‚å¸¸</strong>ã€‚å› ä¸ºä½¿ç”¨éšå¼ Intent å¯åŠ¨æœåŠ¡å­˜åœ¨å®‰å…¨éšæ‚£ï¼Œæ— æ³•ç¡®å®šå“ªäº›æœåŠ¡å°†å“åº” Intentï¼Œä¸”ç”¨æˆ·æ— æ³•çœ‹åˆ°å“ªäº›æœåŠ¡å·²å¯åŠ¨ã€‚</p></blockquote></li><li><p><strong>éšå¼Intent</strong></p><p>ä¸æŒ‡å®šç»„ä»¶åï¼Œè€Œæ˜¯æŒ‡å®šäº†å¯å¤„ç†è¯¥Intentçš„æŸäº›ç»„ä»¶çš„å±æ€§ï¼Œå¦‚Actionã€Dataã€Categoryç­‰ï¼Œç„¶åç³»ç»Ÿä¼šæ ¹æ®è¿™äº›å±æ€§å»åŒ¹é…AndroidManifest.xmlç›¸å…³ç»„ä»¶çš„Intent-filterï¼Œå¯»æ‰¾åˆ°æ»¡è¶³å±æ€§çš„ç»„ä»¶ï¼Œå½“ä¸æ­¢ä¸€ä¸ªæ»¡è¶³æ—¶, ä¼šå¼¹å‡ºä¸€ä¸ªè®©æˆ‘ä»¬é€‰æ‹©å¯åŠ¨å“ªä¸ªçš„å¯¹è¯æ¡†ã€‚</p></li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>æ¯”å¦‚æˆ‘ä»¬åœ¨æ‰‹æœºä¸Šä¿®æ”¹å¤´åƒï¼Œé€‰æ‹©æœ¬åœ°å›¾ç‰‡åï¼Œè¿™æ—¶å€™ç³»ç»Ÿè‡ªåŠ¨è·³è½¬åˆ°å›¾åº“ï¼Œè¿™ä¸ªå°±æ˜¯æ˜¾ç¤ºIntentï¼ˆä¸å¥½è¯´ï¼Œä¹Ÿè®¸åªæœ‰ä¸€ä¸ªåº”ç”¨èƒ½å“åº”è¯¥Intentï¼‰ã€‚</p><p>å†ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨æ‰‹æœºä¸Šæ‰“å¼€pdfæ–‡ä»¶ï¼Œé€‰æ‹©ç”¨å…¶ä»–åº”ç”¨æ‰“å¼€ï¼Œè¿™æ—¶å€™å°±ä¼šå¼¹å‡ºå¤šä¸ªåº”ç”¨ä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œæ¯”å¦‚WPSã€æµè§ˆå™¨ç­‰ï¼Œè¿™ä¸ªå°±æ˜¯éšå¼Intentã€‚</p><h2 id="2-1-å¼ºåˆ¶ä½¿ç”¨åº”ç”¨é€‰æ‹©å™¨"><a href="#2-1-å¼ºåˆ¶ä½¿ç”¨åº”ç”¨é€‰æ‹©å™¨" class="headerlink" title="2.1 å¼ºåˆ¶ä½¿ç”¨åº”ç”¨é€‰æ‹©å™¨"></a>2.1 å¼ºåˆ¶ä½¿ç”¨åº”ç”¨é€‰æ‹©å™¨</h2><p>å¦‚æœæœ‰å¤šä¸ªåº”ç”¨å“åº”éšå¼ Intentï¼Œåˆ™ç³»ç»Ÿä¼šå¼¹å‡ºå¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©è¦ä½¿ç”¨çš„åº”ç”¨ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥å°†æŸä¸ªåº”ç”¨è®¾ç½®ä¸ºè¯¥æ“ä½œçš„é»˜è®¤é€‰é¡¹ã€‚</p><p>å¦‚æœæƒ³è®©ç”¨æˆ·æ— æ³•é€‰æ‹©ç”¨äºæ“ä½œçš„åº”ç”¨ï¼Œè€Œå¼ºåˆ¶ä½¿ç”¨æŸä¸ªåº”ç”¨å“åº”è¯¥æ“ä½œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Intent</span> <span class="hljs-variable">sendIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SEND);<br> Intent intent=Intent.createChooser(viewIntent,<span class="hljs-string">&quot;åº”ç”¨é€‰æ‹©å™¨&quot;</span>);<br><span class="hljs-comment">//createChooser()åˆ›å»ºæ˜¾å¼è°ƒç”¨é€‰æ‹©å™¨ï¼Œç”¨æˆ·å°†æ— æ³•è®¾å®šé»˜è®¤é€‰é¡¹</span><br><span class="hljs-type">Intent</span> <span class="hljs-variable">chooser</span> <span class="hljs-operator">=</span> Intent.createChooser(sendIntent, title);<br><br><span class="hljs-comment">// åˆ¤æ–­è¯¥Intentæ˜¯å¦å­˜åœ¨å¯å“åº”Activity</span><br><span class="hljs-keyword">if</span> (sendIntent.resolveActivity(getPackageManager()) != <span class="hljs-literal">null</span>) &#123;<br>    startActivity(chooser);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-Intentä½¿ç”¨æµç¨‹"><a href="#2-2-Intentä½¿ç”¨æµç¨‹" class="headerlink" title="2.2 Intentä½¿ç”¨æµç¨‹"></a>2.2 Intentä½¿ç”¨æµç¨‹</h2><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307041427465.jpg"></p><h1 id="ä¸‰ã€Intentçš„ä¸ƒä¸ªå±æ€§"><a href="#ä¸‰ã€Intentçš„ä¸ƒä¸ªå±æ€§" class="headerlink" title="ä¸‰ã€Intentçš„ä¸ƒä¸ªå±æ€§"></a>ä¸‰ã€Intentçš„ä¸ƒä¸ªå±æ€§</h1><h2 id="3-1-ComponentName-ç»„ä»¶åç§°"><a href="#3-1-ComponentName-ç»„ä»¶åç§°" class="headerlink" title="3.1 ComponentName(ç»„ä»¶åç§°)"></a>3.1 ComponentName(ç»„ä»¶åç§°)</h2><p>ç›®æ ‡ç»„ä»¶çš„åç§°ã€‚è¿™æ˜¯å¯é€‰é¡¹ï¼Œå¦‚æœæ„å»ºIntentæ—¶æœ‰ç»„ä»¶åç§°ï¼Œåˆ™ä¸ºæ˜¾å¼Intentï¼Œå¦åˆ™ä¸ºéšå¼Intentã€‚</p><p>ç»„ä»¶åç§°ç”±ç»„ä»¶æ‰€åœ¨åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶ä¸­è®¾ç½®çš„åŒ…å+ç»„ä»¶çš„å…¨é™å®šç±»åç»„æˆã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ComponentName</span> <span class="hljs-variable">componentName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(<span class="hljs-string">&quot;com.example.demo&quot;</span>,<span class="hljs-string">&quot;com.example.demo.DemoActivity&quot;</span>);<br><span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>intent.setComponent(componentName);<br>startActivity(intent);<br></code></pre></td></tr></table></figure><p>ComponentNameä¸­çš„ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¸ºåŒ…åï¼Œç¬¬äºŒä¸ªä¸ºå…¨é™å®šç±»åã€‚å¦‚æœå…¨é™å®šç±»åçš„å‰é¢å’ŒåŒ…åæ˜¯ä¸€æ ·çš„è¯ï¼Œæ˜¯å¯ä»¥çœç•¥çš„ï¼Œä¸Šé¢è¿™ä¸ªä¾‹å­çš„ç»„ä»¶åç§°å¯ä»¥å†™æˆcom.example.demo&#x2F;.DemoActivityã€‚</p><h2 id="3-2-Action-åŠ¨ä½œ"><a href="#3-2-Action-åŠ¨ä½œ" class="headerlink" title="3.2 Action(åŠ¨ä½œ)"></a>3.2 Action(åŠ¨ä½œ)</h2><p>ä¸€ä¸ªæ™®é€šçš„å­—ç¬¦ä¸²ï¼Œä»£è¡¨Intentè¦å®Œæˆçš„ä¸€ä¸ªæŠ½è±¡åŠ¨ä½œï¼Œå®ƒå‘Šè¯‰ç³»ç»Ÿæˆ–å…¶ä»–ç»„ä»¶è¦æ‰§è¡Œä»€ä¹ˆæ“ä½œã€‚</p><h3 id="Actionçš„ä¸¤ç§ç±»å‹"><a href="#Actionçš„ä¸¤ç§ç±»å‹" class="headerlink" title="Actionçš„ä¸¤ç§ç±»å‹"></a>Actionçš„ä¸¤ç§ç±»å‹</h3><ol><li><p><strong>ç³»ç»Ÿå®šä¹‰çš„Action</strong></p><p>Androidç³»ç»Ÿæä¾›äº†è®¸å¤šé¢„å®šä¹‰çš„Actionï¼Œä¾‹å¦‚</p><ul><li><strong>ACTION_VIEW</strong><br> å‘ç”¨æˆ·å±•ç¤ºæŸä¿¡æ¯ï¼Œæ¯”å¦‚ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ç½‘å€ï¼Œç”¨å›¾ç‰‡åº”ç”¨æ˜¾ç¤ºå›¾ç‰‡ç­‰ã€‚</li><li><strong>ACTION_SEND</strong><br> ç”¨äºå‘é€æ•°æ®ï¼Œæ¯”å¦‚ç”µå­é‚®ä»¶åº”ç”¨æˆ–è€…ä¸€äº›ç¤¾äº¤åº”ç”¨ã€‚</li><li><strong>ACTION_DIAL</strong><br> æ˜¾ç¤ºå¸¦æ‹¨å·ç›˜çš„é¡µé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥è¿›è¡Œæ‹¨å·åŠ¨ä½œã€‚</li></ul><p>æ›´å¤šActionå¸¸é‡è¯¦è§<a href="https://developer.android.google.cn/guide/components/intents-common?hl=zh-cn">é€šç”¨ Intent  | Android å¼€å‘è€…  | Android Developers (google.cn)</a></p></li><li><p><strong>åº”ç”¨ç¨‹åºå®šä¹‰çš„Action</strong></p><p>å¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰Actionï¼Œåœ¨åº”ç”¨ç¨‹åºå†…éƒ¨ä½¿ç”¨ï¼Œä½†ç¡®ä¿åŠ å…¥åº”ç”¨çš„è½¯ä»¶åŒ…åç§°ä½œä¸ºå‰ç¼€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_TIMETRAVEL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.example.action.SEND_EMAIL&quot;</span>;<br></code></pre></td></tr></table></figure></li></ol><h2 id="3-3-Category-ç±»åˆ«"><a href="#3-3-Category-ç±»åˆ«" class="headerlink" title="3.3 Category(ç±»åˆ«)"></a>3.3 Category(ç±»åˆ«)</h2><p>ä¸€ä¸ªæ™®é€šçš„å­—ç¬¦ä¸²ï¼Œç”¨äºä¸ºActionæä¾›é¢å¤–çš„é™„åŠ ä¿¡æ¯ã€‚ä¸€ä¸ªIntentå¯¹è±¡å¯ä»¥æœ‰å¤šä¸ªCategoryã€‚</p><h3 id="Categoryçš„ä¸¤ç§ç±»å‹"><a href="#Categoryçš„ä¸¤ç§ç±»å‹" class="headerlink" title="Categoryçš„ä¸¤ç§ç±»å‹"></a>Categoryçš„ä¸¤ç§ç±»å‹</h3><ol><li><p><strong>ç³»ç»Ÿå®šä¹‰çš„Category</strong></p><ul><li><p><strong>CATEGORY_DEFAULT</strong>ï¼šé»˜è®¤ç±»åˆ«ï¼Œè¡¨ç¤ºè¿™ä¸ªIntentæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œå¯ä»¥è¢«ä»»ä½•ä¸ä¹‹åŒ¹é…çš„ç»„ä»¶æ¥å¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªIntentä¸­åªèƒ½æ·»åŠ ä¸€ä¸ªCATEGORY_DEFAULTã€‚</p></li><li><p><strong>CATEGORY_BROWSABLE</strong>ï¼š è¡¨ç¤ºä½ çš„Activityèƒ½å¤Ÿæ‰“å¼€æµè§ˆå™¨å¹¶è®¿é—®ä¸€ä¸ªé“¾æ¥ã€‚å¦‚æœä½ æƒ³åˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿå“åº”http:&#x2F;&#x2F;æˆ–https:&#x2F;&#x2F;é“¾æ¥çš„Activityï¼Œä½ éœ€è¦æ·»åŠ è¿™ä¸ªCategoryã€‚</p></li><li><p><strong>CATEGORY_LAUNCHER</strong>ï¼šè¡¨ç¤ºè¯¥Activityæ˜¯ä¸€ä¸ªå¯åŠ¨å™¨ï¼ˆLauncherï¼‰ï¼Œä¹Ÿå°±æ˜¯å®ƒä¼šåœ¨è®¾å¤‡ä¸Šç”Ÿæˆä¸€ä¸ªå›¾æ ‡ï¼Œå½“ç”¨æˆ·ç‚¹å‡»è¯¥å›¾æ ‡æ—¶ï¼Œç³»ç»Ÿä¼šå¯åŠ¨æ­¤Activityã€‚åœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œåªæœ‰ä¸€ä¸ªActivityå¯ä»¥æ‹¥æœ‰CATEGORY_LAUNCHERå±æ€§ã€‚</p></li></ul></li><li><p><strong>åº”ç”¨ç¨‹åºå®šä¹‰çš„Category</strong></p><p>è‡ªå®šä¹‰çš„Categoryéœ€è¦åœ¨AndroidManifest.xmlé…ç½®æ–‡ä»¶ä¸­è¿›è¡Œå£°æ˜ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.example.myapp.MY_CUSTOM_CATEGORY&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_VIEW);<br>intent.addCategory(<span class="hljs-string">&quot;com.example.myapp.MY_CUSTOM_CATEGORY&quot;</span>);<br>startActivity(intent);<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå…¶ä»–åº”ç”¨ç¨‹åºå°±å¯ä»¥ä½¿ç”¨è¯¥Intent Categoryæ¥å¯åŠ¨ä½ çš„åº”ç”¨ç¨‹åºï¼Œå¹¶æ‰§è¡Œç›¸å…³æ“ä½œã€‚</p></li></ol><h2 id="3-4-Data-æ•°æ®-Type-MIMEç±»å‹"><a href="#3-4-Data-æ•°æ®-Type-MIMEç±»å‹" class="headerlink" title="3.4 Data(æ•°æ®), Type(MIMEç±»å‹)"></a>3.4 Data(æ•°æ®), Type(MIMEç±»å‹)</h2><h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><p>Dataé€šå¸¸ç”¨äºå‘Actionå±æ€§æä¾›æ“ä½œçš„æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªURIå¯¹è±¡ï¼Œè¯¥URIå¯ä»¥è¡¨ç¤ºæ–‡ä»¶ã€ç½‘å€ã€æ•°æ®åº“è¡¨æ ¼ç­‰ä¸åŒç±»å‹çš„æ•°æ®æºã€‚</p><h3 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h3><p>Typeé€šå¸¸ç”¨äºæŒ‡å®šDataæ‰€æŒ‡å®šçš„URIå¯¹åº”çš„MIMEç±»å‹ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„Android MIMEç±»å‹ï¼ˆå…¶ä¸­*æ˜¯é€šé…ç¬¦ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæŸç§ç±»å‹ï¼‰ï¼š</p><ul><li>image&#x2F;*ï¼šæ‰€æœ‰å›¾åƒç±»å‹ã€‚</li><li>audio&#x2F;*ï¼šæ‰€æœ‰éŸ³é¢‘ç±»å‹ã€‚</li><li>video&#x2F;*ï¼šæ‰€æœ‰è§†é¢‘ç±»å‹ã€‚</li><li>text&#x2F;*ï¼šæ‰€æœ‰æ–‡æœ¬ç±»å‹ã€‚</li><li>application&#x2F;pdfï¼šPDFæ–‡ä»¶ç±»å‹</li><li>application&#x2F;zipï¼šZipå‹ç¼©æ–‡ä»¶ç±»å‹</li></ul><p>å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰MIMEç±»å‹ã€‚ä¾‹å¦‚è‡ªå®šä¹‰jsonçš„MIMEç±»å‹ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-built_in">application</span>/json<br></code></pre></td></tr></table></figure><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p><strong>è‹¥è¦åŒæ—¶è®¾ç½® URI å’Œ MIME ç±»å‹ï¼Œè¯·å‹¿è°ƒç”¨ <code>setData()</code> å’Œ <code>setType()</code>ï¼Œå› ä¸ºå®ƒä»¬ä¼šäº’ç›¸æŠµæ¶ˆå½¼æ­¤çš„å€¼ã€‚è¯·å§‹ç»ˆä½¿ç”¨ <code>setDataAndType()</code> åŒæ—¶è®¾ç½® URI å’Œ MIME ç±»å‹ã€‚</strong></p><p>åŸå› å‚è€ƒï¼š<a href="https://www.coder.work/article/671139">Android:å…³äºIntentsï¼Œä¸ºä»€ä¹ˆsetType()å’ŒsetData()ä¼šäº’ç›¸æŠµæ¶ˆï¼Ÿ</a></p><h2 id="3-5-Extra-é¢å¤–ä¿¡æ¯"><a href="#3-5-Extra-é¢å¤–ä¿¡æ¯" class="headerlink" title="3.5 Extra(é¢å¤–ä¿¡æ¯)"></a>3.5 Extra(é¢å¤–ä¿¡æ¯)</h2><p>Extraæ˜¯ä¸€ä¸ªé”®å€¼å¯¹é›†åˆï¼Œç”¨äºä¼ é€’é¢å¤–ä¿¡æ¯ã€‚Extraçš„é”®æ˜¯Stringç±»å‹ï¼Œè€Œå€¼å¯ä»¥æ˜¯ä»»ä½•Parcelableæˆ–Serializableå¯¹è±¡ï¼ˆJavaä¸­ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–å¯¹è±¡çš„æ¥å£ï¼‰ã€‚</p><h2 id="3-6-Flag-æ ‡è®°"><a href="#3-6-Flag-æ ‡è®°" class="headerlink" title="3.6 Flag(æ ‡è®°)"></a>3.6 Flag(æ ‡è®°)</h2><p>å……å½“ Intent çš„å…ƒæ•°æ®ã€‚æŒ‡ç¤º Android ç³»ç»Ÿå¦‚ä½•å¯åŠ¨ Activityï¼ˆä¾‹å¦‚ï¼ŒActivity åº”å±äºå“ªä¸ªä»»åŠ¡ï¼‰ï¼Œä»¥åŠå¯åŠ¨ä¹‹åå¦‚ä½•å¤„ç†ï¼ˆä¾‹å¦‚ï¼Œå®ƒæ˜¯å¦å±äºæœ€è¿‘çš„ Activity åˆ—è¡¨ï¼‰ã€‚</p><p>ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§çš„Flagï¼š</p><ul><li><strong>FLAG_ACTIVITY_NEW_TASK</strong>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡æ ˆæ¥å¯åŠ¨Activityï¼Œå¦‚æœå·²ç»å­˜åœ¨ä¸€ä¸ªç›¸åŒçš„ä»»åŠ¡æ ˆï¼Œåˆ™ç›´æ¥å°†å®ƒè°ƒåˆ°å‰å°ã€‚è¿™ä¸ªFlagé€šå¸¸ç”¨äºä»Serviceå¯åŠ¨ä¸€ä¸ªActivityã€‚</li><li><strong>FLAG_ACTIVITY_CLEAR_TOP</strong>ï¼šæ¸…ç©ºTaskæ ˆé¡¶éƒ¨çš„æ‰€æœ‰Activityï¼Œä½¿å¾—ç›®æ ‡Activityå˜æˆæ ˆé¡¶çš„Activityã€‚å¦‚æœè¯¥Activityä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚è¿™ä¸ªFlagé€šå¸¸ç”¨äºä»æ·±å±‚æ¬¡çš„Activityè¿”å›åˆ°æ ˆé¡¶Activityã€‚</li><li><strong>FLAG_ACTIVITY_SINGLE_TOP</strong>ï¼šå¦‚æœç›®æ ‡Activityå·²ç»ä½äºæ ˆé¡¶ï¼Œåˆ™ä¸åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œè€Œæ˜¯ç»§ç»­ä½¿ç”¨åŸæ¥çš„å®ä¾‹ã€‚è¿™ä¸ªFlagé€šå¸¸ç”¨äºé¿å…é‡å¤åˆ›å»ºActivityçš„æƒ…å†µã€‚</li><li><strong>FLAG_ACTIVITY_NO_HISTORY</strong>ï¼šå¯åŠ¨ä¸€ä¸ªActivityæ—¶ä¸åœ¨Taskæ ˆä¸­ä¿å­˜è¿™ä¸ªActivityçš„å†å²è®°å½•ã€‚è¿™ä¸ªFlagé€šå¸¸ç”¨äºå¯åŠ¨ä¸€ä¸ªä¸´æ—¶æ€§çš„Activityã€‚</li><li><strong>FLAG_ACTIVITY_CLEAR_TASK</strong>ï¼šæ¸…ç©ºæ•´ä¸ªTaskæ ˆï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ–°çš„Taskæ ˆã€‚è¿™ä¸ªFlagé€šå¸¸ç”¨äºå¯åŠ¨ä¸€ä¸ªåº”ç”¨çš„ä¸»ç•Œé¢æˆ–è€…é‡æ–°å¯åŠ¨åº”ç”¨ã€‚</li><li><strong>FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</strong>ï¼šé˜»æ­¢å¯åŠ¨çš„Activityå‡ºç°åœ¨æœ€è¿‘è¿è¡Œçš„åº”ç”¨åˆ—è¡¨ä¸­ã€‚</li></ul><h1 id="å››ã€Intentè¿‡æ»¤å™¨"><a href="#å››ã€Intentè¿‡æ»¤å™¨" class="headerlink" title="å››ã€Intentè¿‡æ»¤å™¨"></a>å››ã€Intentè¿‡æ»¤å™¨</h1><p>Intentè¿‡æ»¤å™¨(Intent-filter)æ˜¯ AndroidMainifest.xml é…ç½®æ–‡ä»¶ä¸­ç»„ä»¶çš„å­æ ‡ç­¾<code>&lt;intent-fileter&gt;</code>ã€‚<strong>ä¸€ä¸ªç»„ä»¶å¯ä»¥å£°æ˜ä¸€ä¸ªæˆ–è€…å¤šä¸ª Intentè¿‡æ»¤å™¨ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªé€šè¿‡åŒ¹é…ï¼Œè¯¥ç»„ä»¶å°±å¯ä»¥å“åº”ç›¸åº” Intentã€‚</strong></p><p>Intentè¿‡æ»¤å™¨é€šè¿‡ Actionã€Categoryã€Data å±æ€§è¿›è¡Œè¿‡æ»¤ï¼Œç­›é€‰å‡ºå¯ä»¥å“åº”çš„ç»„ä»¶ã€‚</p><p>ä¾‹å¦‚å®˜æ–¹æ–‡æ¡£ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;ShareActivity&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- This activity handles &quot;SEND&quot; actions with text data --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.SEND&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.category.DEFAULT&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">data</span> <span class="hljs-attr">android:mimeType</span>=<span class="hljs-string">&quot;text/plain&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- This activity also handles &quot;SEND&quot; and &quot;SEND_MULTIPLE&quot; with media data --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.SEND&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.SEND_MULTIPLE&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.category.DEFAULT&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">data</span> <span class="hljs-attr">android:mimeType</span>=<span class="hljs-string">&quot;application/vnd.google.panorama360+jpg&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">data</span> <span class="hljs-attr">android:mimeType</span>=<span class="hljs-string">&quot;image/*&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">data</span> <span class="hljs-attr">android:mimeType</span>=<span class="hljs-string">&quot;video/*&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º<code>ShareActivity</code>æ—¨åœ¨å‘é€å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æœ¬ã€‚</p><h2 id="4-1-IntentåŒ¹é…è§„åˆ™"><a href="#4-1-IntentåŒ¹é…è§„åˆ™" class="headerlink" title="4.1 IntentåŒ¹é…è§„åˆ™"></a>4.1 IntentåŒ¹é…è§„åˆ™</h2><p>å½“æ”¶åˆ°éšå¼ Intent ä»¥å¯åŠ¨ Activity æ—¶ï¼Œç³»ç»Ÿä¼šæŒ‰ç…§ä¼˜å…ˆçº§ï¼ˆAction &gt; Data &gt; Categoryï¼‰ï¼Œå°†è¯¥ Intent ä¸ Intent è¿‡æ»¤å™¨è¿›è¡Œæ¯”è¾ƒï¼Œæœç´¢è¯¥ Intent çš„æœ€ä½³ Activityã€‚</p><p>å¦‚æœå¤šä¸ª Intent è¿‡æ»¤å™¨éƒ½èƒ½å¤ŸåŒ¹é…åˆ°åŒä¸€ä¸ª Intentï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šæ ¹æ®å®ƒä»¬åœ¨æ¸…å•æ–‡ä»¶ä¸­å£°æ˜çš„é¡ºåºæ¥å†³å®šä½¿ç”¨å“ªä¸€ä¸ª Intent è¿‡æ»¤å™¨ã€‚åœ¨åŒä¸€ä¸ª Intent è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœåŒæ—¶è®¾ç½®äº†å¤šä¸ª action æˆ– categoryï¼Œé‚£ä¹ˆè¿™äº›æ¡ä»¶ä¹‹é—´æ˜¯ â€œæˆ–â€ çš„å…³ç³»ï¼Œåªè¦æ»¡è¶³å…¶ä¸­ä»»æ„ä¸€ä¸ªï¼Œè¯¥ Intent Filter å°±ä¼šè¢«åŒ¹é…åˆ°ã€‚</p><h3 id="ActionåŒ¹é…è§„åˆ™"><a href="#ActionåŒ¹é…è§„åˆ™" class="headerlink" title="ActionåŒ¹é…è§„åˆ™"></a>ActionåŒ¹é…è§„åˆ™</h3><ul><li>Intentåªèƒ½è®¾ç½®ä¸€ä¸ªactionï¼Œä½†ä¸€ä¸ªIntentè¿‡æ»¤å™¨å¯ä»¥å£°æ˜å¤šä¸ªactionã€‚åªè¦Intentä¸­çš„actionä¸Intentè¿‡æ»¤å™¨çš„æŸä¸€é¡¹actionåŒ¹é…ï¼Œå°±å¯ä»¥é€šè¿‡actionæµ‹è¯•ã€‚</li><li>å¦‚æœIntentè¿‡æ»¤å™¨æœªåˆ—å‡ºä»»ä½•actionï¼Œåˆ™ Intent æ²¡æœ‰ä»»ä½•åŒ¹é…é¡¹ï¼Œå› æ­¤æ‰€æœ‰ Intent å‡æ— æ³•é€šè¿‡actionæµ‹è¯•ã€‚</li><li>å¦‚æœ Intent æœªæŒ‡å®šactionï¼Œåˆ™åªè¦Intentè¿‡æ»¤å™¨å†…åŒ…å«è‡³å°‘ä¸€é¡¹actionï¼Œå°±å¯ä»¥é€šè¿‡actionæµ‹è¯•ã€‚</li></ul><h3 id="DataåŒ¹é…è§„åˆ™"><a href="#DataåŒ¹é…è§„åˆ™" class="headerlink" title="DataåŒ¹é…è§„åˆ™"></a>DataåŒ¹é…è§„åˆ™</h3><p>Dataçš„åŒ¹é…è§„åˆ™åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šURIå’ŒMIMEã€‚</p><h4 id="URIåŒ¹é…è§„åˆ™"><a href="#URIåŒ¹é…è§„åˆ™" class="headerlink" title="URIåŒ¹é…è§„åˆ™"></a>URIåŒ¹é…è§„åˆ™</h4><p>URIçš„æ ¼å¼ä¸º<code>&lt;scheme&gt;://&lt;host&gt;:&lt;port&gt;/&lt;path&gt;</code>ï¼Œä¸Šè¿°æ¯ä¸ªå±æ€§å‡ä¸ºå¯é€‰ï¼Œä½†å­˜åœ¨çº¿æ€§ä¾èµ–å…³ç³»ï¼š</p><ul><li>å¦‚æœæœªæŒ‡å®šschemeï¼Œåˆ™ä¼šå¿½ç•¥hostã€‚</li><li>å¦‚æœæœªæŒ‡å®šhostï¼Œåˆ™ä¼šå¿½ç•¥portã€‚</li><li>å¦‚æœæœªæŒ‡å®šschemeå’Œhostï¼Œåˆ™ä¼šå¿½ç•¥path</li></ul><p>Intent ä¸­çš„ URI ä¸è¿‡æ»¤å™¨ä¸­çš„ URI è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œå®ƒä»…ä¸è¿‡æ»¤å™¨ä¸­åŒ…å«çš„éƒ¨åˆ† URI è¿›è¡Œæ¯”è¾ƒï¼ˆå³åˆšæ‰æ‰€è®²åˆ°çš„ä¾èµ–å…³ç³»ï¼‰ã€‚ä¾‹å¦‚ï¼š</p><ul><li>å¦‚æœè¿‡æ»¤å™¨ä»…æŒ‡å®šschemeï¼Œåˆ™å…·æœ‰è¯¥schemeçš„æ‰€æœ‰ URI å‡ä¸è¯¥è¿‡æ»¤å™¨åŒ¹é…ã€‚</li><li>å¦‚æœè¿‡æ»¤å™¨æŒ‡å®šschemeå’Œauthorityï¼Œä½†æœªæŒ‡å®špathï¼Œåˆ™å…·æœ‰ç›¸åŒschemeå’Œauthorityçš„æ‰€æœ‰ URI éƒ½ä¼šé€šè¿‡è¿‡æ»¤å™¨ï¼Œæ— è®ºå…¶pathå¦‚ä½•å‡æ˜¯å¦‚æ­¤ã€‚</li><li>å¦‚æœè¿‡æ»¤å™¨æŒ‡å®šschemeã€authorityå’Œpathï¼Œåˆ™ä»…å…·æœ‰ç›¸åŒschemeã€authorityå’Œpathçš„ URI æ‰ä¼šé€šè¿‡è¿‡æ»¤å™¨ã€‚</li><li>path éƒ¨åˆ†å¯ä»¥ä½¿ç”¨é€šé…ç¬¦(*)ï¼Œä»…éœ€éƒ¨åˆ†åŒ¹é…è·¯å¾„åå³å¯ã€‚</li></ul><h4 id="URIå’ŒMIMEåŒ¹é…è§„åˆ™"><a href="#URIå’ŒMIMEåŒ¹é…è§„åˆ™" class="headerlink" title="URIå’ŒMIMEåŒ¹é…è§„åˆ™"></a>URIå’ŒMIMEåŒ¹é…è§„åˆ™</h4><ol><li>ä»…å½“è¿‡æ»¤å™¨æœªæŒ‡å®šä»»ä½• URI æˆ– MIME ç±»å‹æ—¶ï¼Œä¸å« URI å’Œ MIME ç±»å‹çš„ Intent æ‰ä¼šé€šè¿‡æµ‹è¯•ã€‚</li><li>å¦‚æœ Intent æŒ‡å®š URI æˆ– MIME ç±»å‹ï¼Œè€Œè¿‡æ»¤å™¨ä¸­æ²¡æœ‰å£°æ˜dataå…ƒç´ ï¼Œåˆ™Intentä¸èƒ½é€šè¿‡æµ‹è¯•ã€‚</li><li>å¦‚æœ Intent æŒ‡å®š URI æˆ– MIME ç±»å‹ï¼Œä»…å½“æœ‰è¿‡æ»¤å™¨èƒ½åŒ¹é…å…¶URIå’ŒMIMEç±»å‹æ—¶ï¼Œæ‰ä¼šé€šè¿‡æµ‹è¯•ã€‚</li><li>å¯¹äºåŒ…å« URI ä½†ä¸å« MIME ç±»å‹ï¼ˆæ—¢æœªæ˜¾å¼å£°æ˜ï¼Œä¹Ÿæ— æ³•é€šè¿‡ URI æ¨æ–­å¾—å‡ºï¼‰çš„ Intentï¼Œä»…å½“å…¶ URI ä¸è¿‡æ»¤å™¨çš„ URI æ ¼å¼åŒ¹é…ã€<strong>ä¸”è¿‡æ»¤å™¨åŒæ ·æœªæŒ‡å®š MIME ç±»å‹æ—¶</strong>ï¼Œæ‰ä¼šé€šè¿‡æµ‹è¯•ã€‚</li><li>ä»…å½“è¿‡æ»¤å™¨åˆ—å‡ºç›¸åŒçš„ MIME ç±»å‹ä¸”æœªæŒ‡å®š URI æ ¼å¼æ—¶ï¼ŒåŒ…å« MIME ç±»å‹ä½†ä¸å« URI çš„ Intent æ‰ä¼šé€šè¿‡æµ‹è¯•ã€‚</li><li>å¦‚æœè¿‡æ»¤å™¨åªæ˜¯åˆ—å‡º MIME ç±»å‹ï¼Œåˆ™é»˜è®¤æ”¯æŒURIå« <code>content:</code> æˆ– <code>file:</code>çš„æ•°æ®ã€‚</li></ol><p>ç”±äºå¤§éƒ¨åˆ†å¯ç”¨æ•°æ®å‡ç”±å†…å®¹æä¾›ç¨‹åºåˆ†å‘ï¼Œå› æ­¤æŒ‡å®šæ•°æ®ç±»å‹ï¼ˆè€Œé URIï¼‰çš„è¿‡æ»¤å™¨ä¹Ÿè®¸æœ€ä¸ºå¸¸è§ã€‚</p><p>å¦ä¸€å¸¸è§çš„é…ç½®æ˜¯å…·æœ‰æ¶æ„å’Œæ•°æ®ç±»å‹çš„è¿‡æ»¤å™¨ï¼Œå¦‚ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">data</span> <span class="hljs-attr">android:scheme</span>=<span class="hljs-string">&quot;http&quot;</span> <span class="hljs-attr">android:mimeType</span>=<span class="hljs-string">&quot;video/*&quot;</span> /&gt;</span><br>    ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="CategoryåŒ¹é…è§„åˆ™"><a href="#CategoryåŒ¹é…è§„åˆ™" class="headerlink" title="CategoryåŒ¹é…è§„åˆ™"></a>CategoryåŒ¹é…è§„åˆ™</h3><ul><li>Intent å¯ä»¥åŒ…å«å¤šé¡¹ categoryï¼ŒIntent è¿‡æ»¤å™¨ä¹Ÿå¯ä»¥åŒ…å«å¤šé¡¹ categoryã€‚Intent ä¸­çš„æ¯é¡¹category å¿…é¡»åœ¨Intentè¿‡æ»¤å™¨ä¸­éƒ½æœ‰å¯¹åº”é¡¹ï¼Œæ‰èƒ½é€šè¿‡category æµ‹è¯•ã€‚ï¼ˆIntentè¿‡æ»¤å™¨å£°æ˜çš„categoryå¯ä»¥è¶…è¿‡Intentä¸­çš„categoryæ•°é‡ï¼‰</li><li>ä¸å«categoryçš„Intentå§‹ç»ˆä¼šé€šè¿‡Intentè¿‡æ»¤å™¨ä¸­çš„categoryæµ‹è¯•ã€‚</li><li>å½“ç›®æ ‡ç»„ä»¶ä¸º Activity æ—¶ï¼Œå¦‚éœ€å“åº”éšå¼ Intentï¼Œå¿…é¡»æ·»åŠ  â€œandroid.intent.category.DEFAULTâ€ åˆ° Intent è¿‡æ»¤å™¨ä¸­ã€‚</li><li>ç›®æ ‡ç»„ä»¶ä¸ºå¹¿æ’­æ—¶ï¼ŒIntent å’Œ Intent è¿‡æ»¤å™¨éƒ½ä¸è®¾ç½® categoryï¼Œå¯é€šè¿‡åŒ¹é…ã€‚</li></ul><h1 id="äº”ã€Intentæ•°æ®ä¼ é€’"><a href="#äº”ã€Intentæ•°æ®ä¼ é€’" class="headerlink" title="äº”ã€Intentæ•°æ®ä¼ é€’"></a>äº”ã€Intentæ•°æ®ä¼ é€’</h1><p>Intentä¸ä»…å¯ä»¥ç”¨æ¥å¯åŠ¨ç»„ä»¶ï¼Œè¿˜å¯ä»¥ç”¨æ¥ä¼ é€’æ•°æ®ã€‚</p><p>Intentä¼ é€æ•°æ®æ˜¯ä»¥é”®å€¼å¯¹çš„å½¢å¼ã€‚</p><p>ä¼ é€’å•ä¸ªæ•°æ®æ—¶ï¼Œä¸»è¦é€šè¿‡<code>putExtra()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ•°æ®çš„é”®ï¼Œç¬¬äºŒä¸ªæ˜¯æ•°æ®çš„å€¼ã€‚</p><p>ä¼ é€’å¤šä¸ªæ•°æ®æ—¶ï¼Œä½¿ç”¨Bundleå¯¹è±¡ä½œä¸ºå®¹å™¨ï¼Œå…ˆå°†æ•°æ®å­˜å‚¨åˆ°Bundleä¸­ï¼Œç„¶åé€šè¿‡<code>putExtras()</code>æ–¹æ³•ä¼ å…¥Intentä¸­ã€‚</p><p>Intentä¼ é€’çš„æ•°æ®å¯åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p><ol><li><strong>åŸºæœ¬ç±»å‹æ•°æ®</strong>ï¼šå¦‚intã€floatã€doubleç­‰ã€‚</li><li><strong>å­—ç¬¦ä¸²ç±»å‹æ•°æ®</strong>ï¼šå¦‚Stringã€CharSequenceç­‰ã€‚</li><li><strong>åºåˆ—åŒ–æ•°æ®ç±»å‹</strong>ï¼šå¦‚ArrayListã€Bundleç­‰ã€‚</li><li><strong>è‡ªå®šä¹‰æ•°æ®ç±»å‹</strong>ï¼šå¦‚Parcelableã€Serializableå¯¹è±¡ã€‚</li></ol><h2 id="5-1-Intentæ•°æ®å›ä¼ "><a href="#5-1-Intentæ•°æ®å›ä¼ " class="headerlink" title="5.1 Intentæ•°æ®å›ä¼ "></a>5.1 Intentæ•°æ®å›ä¼ </h2><p>ä¸€ä¸ªActivityå¯ä»¥é€šè¿‡Intentå¯åŠ¨å¦ä¸€ä¸ªActivityï¼Œæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›åè€…èƒ½å¤Ÿè¿”å›ä¸€äº›æ•°æ®ç»™å‰è€…ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨æ•°æ®å›ä¼ ã€‚å…¸å‹çš„åº”ç”¨åœºæ™¯å¦‚ï¼šå……å€¼ã€‚</p><p>æ•°æ®å›ä¼ çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åœ¨è°ƒç”¨è€… Activity ä¸­ï¼Œé‡å†™ <code>onActivityResult(int requestCode, int resultCode, Intent intent) </code> æ–¹æ³•ã€‚å…¶ä¸­<code>requestCode</code>æ˜¯è¯·æ±‚ç ï¼Œ<code>resultCode</code>æ˜¯ç»“æœç ã€‚</li><li>åœ¨è°ƒç”¨è€… Activity ä¸­ï¼Œä½¿ç”¨ <code>startActivityForResult(Intent intent, int requestCode)</code> æ–¹æ³•å¯åŠ¨å¦ä¸€ä¸ª Activityã€‚å…¶ä¸­è¯·æ±‚ç ç”±æˆ‘ä»¬è‡ªå·±è®¾å®šï¼Œç”¨äºåŒºåˆ†è¯·æ±‚æ¥æºã€‚</li><li>åœ¨è¢«è°ƒç”¨çš„ Activity ä¸­ï¼Œè·å–éœ€è¦è¿”å›çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ”¾å…¥ä¸€ä¸ª Intent å¯¹è±¡ä¸­ã€‚</li><li>åœ¨è¢«è°ƒç”¨çš„ Activity ä¸­ï¼Œè°ƒç”¨ <code>setResult(int resultCode, Intent data)</code> æ–¹æ³•æ¥è®¾ç½®è¿”å›ç»“æœå’Œç»“æœç ã€‚</li><li>åœ¨è¢«è°ƒç”¨çš„ Activity ä¸­ï¼Œè°ƒç”¨ <code>finish() </code>æ–¹æ³•æ¥ç»“æŸå½“å‰ Activity çš„ç”Ÿå‘½å‘¨æœŸã€‚å½“è¢«è¯·æ±‚çš„ Activity è¢«å…³é—­æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¯·æ±‚è€…Activityçš„<code>onActivityResult()</code> æ–¹æ³•ã€‚</li></ol><p><strong>è¯·æ±‚ç </strong>å’Œ<strong>ç»“æœç </strong>çš„ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><strong>åŒºåˆ†ä¸åŒçš„è¯·æ±‚</strong>ï¼šå¦‚æœä¸€ä¸ª Activity å‘é€äº†å¤šä¸ªä¸åŒçš„è¯·æ±‚ï¼Œåœ¨ onActivityResult æ–¹æ³•ä¸­ä½¿ç”¨è¯·æ±‚ç æ¥åŒºåˆ«ä¸åŒçš„è¯·æ±‚ï¼Œä»¥ä¾¿åšå‡ºä¸åŒçš„å¤„ç†ã€‚</li><li><strong>æ ‡è¯†æ“ä½œæ‰§è¡Œç»“æœ</strong>ï¼šç»“æœç ç”¨äºæ ‡è¯†æ“ä½œçš„æ‰§è¡Œç»“æœï¼Œæ¯”å¦‚æˆåŠŸã€å¤±è´¥ã€ç”¨æˆ·å–æ¶ˆç­‰ã€‚è¿™å¯ä»¥å‘Šè¯‰è°ƒç”¨æ–¹æ‰§è¡Œçš„æ“ä½œæ˜¯å¦æˆåŠŸã€‚</li><li><strong>ä¿è¯æ•°æ®æ­£ç¡®æ€§</strong>ï¼šä½¿ç”¨è¯·æ±‚ç å’Œç»“æœç å¯ä»¥ç¡®ä¿è¿”å›çš„æ•°æ®æ¥è‡ªäºæ­£ç¡®çš„ Activityï¼Œé˜²æ­¢æ•°æ®è¢«æ¶æ„ç¯¡æ”¹æˆ–è€…è¢«å…¶ä»–ç¨‹åºé”™è¯¯åœ°è¿”å›ã€‚</li><li><strong>ç®€åŒ–ä»£ç ç¼–å†™</strong>ï¼šä½¿ç”¨è¯·æ±‚ç å’Œç»“æœç ï¼Œå¼€å‘è€…å¯ä»¥æ›´åŠ ç®€å•æ–¹ä¾¿åœ°å®ç° Activity ä¹‹é—´çš„æ•°æ®ä¼ é€’ï¼Œå‡å°‘ç¼–å†™å†—é•¿ä»£ç çš„å·¥ä½œé‡ã€‚</li></ul><h1 id="å…­ã€å¾…å®šIntent"><a href="#å…­ã€å¾…å®šIntent" class="headerlink" title="å…­ã€å¾…å®šIntent"></a>å…­ã€å¾…å®šIntent</h1><p>å¾…å®šIntentï¼ˆPending Intentï¼‰æ˜¯Androidå¹³å°ä¸­çš„ä¸€ç§ç‰¹æ®Šç±»å‹çš„Intentå¯¹è±¡ï¼Œé€šå¸¸è¢«ç”¨äºå»¶è¿Ÿæ‰§è¡ŒæŸä¸ªåŠ¨ä½œã€‚å¾…å®šIntentå’Œæ™®é€šIntentçš„åŒºåˆ«åœ¨äºï¼Œå¾…å®šIntentæ˜¯åœ¨ç¨æœ‰çš„å®è·µç‚¹ç”±ç³»ç»Ÿä»£ç†æ‰§è¡Œï¼Œè€Œä¸æ˜¯ç«‹åˆ»æ‰§è¡Œã€‚</p><p>å…¸å‹çš„åº”ç”¨åœºæ™¯å¦‚ï¼šè®¾ç½®é—¹é’Ÿã€å¤‡å¿˜å½•ã€‚</p><h3 id="6-1-PendingIntentçš„ç›¸å…³æ–¹æ³•"><a href="#6-1-PendingIntentçš„ç›¸å…³æ–¹æ³•" class="headerlink" title="6.1 PendingIntentçš„ç›¸å…³æ–¹æ³•"></a>6.1 PendingIntentçš„ç›¸å…³æ–¹æ³•</h3><ul><li>getActivity()ï¼šè¿”å›ä¸€ä¸ªå¯åŠ¨ Activity çš„ PendingIntentã€‚</li><li>getService()ï¼šè¿”å›ä¸€ä¸ªå¯åŠ¨ Service çš„ PendingIntentã€‚</li><li>getBroadcast()ï¼šè¿”å›ä¸€ä¸ªå‘é€å¹¿æ’­çš„ PendingIntentã€‚</li><li>cancel()ï¼šå–æ¶ˆå½“å‰çš„ PendingIntentã€‚</li><li>send()ï¼šå‘é€å½“å‰çš„ PendingIntentã€‚</li></ul><h3 id="6-2-PendingIntentçš„æ ‡å¿—ä½"><a href="#6-2-PendingIntentçš„æ ‡å¿—ä½" class="headerlink" title="6.2 PendingIntentçš„æ ‡å¿—ä½"></a>6.2 PendingIntentçš„æ ‡å¿—ä½</h3><p>åœ¨åˆ›å»ºå¾…å®š Intent æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¾ç½® PendingIntent.FLAG_XXXç­‰æ ‡å¿—ä½ã€‚è¿™äº›æ ‡å¿—ä½ä¸»è¦ç”¨äºæ§åˆ¶ PendingIntent çš„ä¸€äº›è¡Œä¸ºå’Œå±æ€§ï¼Œä»¥ä¸‹æ˜¯å‡ ç§å¸¸ç”¨çš„æ ‡å¿—ä½ï¼š</p><ul><li><strong>FLAG_ONE_SHOT</strong>ï¼šè¡¨ç¤º PendingIntent åªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡ã€‚</li><li><strong>FLAG_CANCEL_CURRENT</strong>ï¼šè¡¨ç¤ºå¦‚æœ PendingIntent å·²ç»å­˜åœ¨ï¼Œåˆ™ä¼šå…ˆå–æ¶ˆå½“å‰çš„ PendingIntentï¼Œç„¶åé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ PendingIntentã€‚</li><li><strong>FLAG_UPDATE_CURRENT</strong>ï¼šè¡¨ç¤ºå¦‚æœ PendingIntent å·²ç»å­˜åœ¨ï¼Œåˆ™ä¼šæ›´æ–°å®ƒçš„ Extras æ•°æ®ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ PendingIntentã€‚</li><li><strong>FLAG_NO_CREATE</strong>ï¼šè¡¨ç¤ºå¦‚æœ PendingIntent å·²ç»å­˜åœ¨ï¼Œè¿”å›å®ƒï¼Œå¦åˆ™è¿”å› nullã€‚</li></ul><hr><p>å‚è€ƒï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/165542980">Intentè¯¦è§£ä»¥åŠActivityçš„è·³è½¬ä¸æ•°æ®ä¼ é€’ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://www.runoob.com/w3cnote/android-tutorial-intent-base.html">4.5.1 Intentçš„åŸºæœ¬ä½¿ç”¨ | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></p><p><a href="https://developer.android.google.cn/guide/components/intents-filters?hl=zh-cn#Building">Intent å’Œ Intent è¿‡æ»¤å™¨  | Android å¼€å‘è€…  | Android Developers (google.cn)</a></p><p><a href="https://www.jianshu.com/p/19147a69e970">Android Intentè¯¦è§£ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/45397580">Android-Intent-Intent Filterç¯‡ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidå››å¤§ç»„ä»¶</title>
    <link href="/2023/07/04/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/"/>
    <url>/2023/07/04/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h1><p>Androidå››å¤§åŸºæœ¬ç»„ä»¶åˆ†åˆ«æ˜¯Activityã€ServiceæœåŠ¡ã€ContentProviderå†…å®¹æä¾›è€…ã€BroadcastReceiverå¹¿æ’­æ¥æ”¶å™¨ã€‚å®ƒä»¬éƒ½éœ€è¦åœ¨AndroidManifest.xmlé…ç½®æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œã€‚</p><h1 id="äºŒã€å››å¤§ç»„ä»¶"><a href="#äºŒã€å››å¤§ç»„ä»¶" class="headerlink" title="äºŒã€å››å¤§ç»„ä»¶"></a>äºŒã€å››å¤§ç»„ä»¶</h1><h2 id="2-1-Activity"><a href="#2-1-Activity" class="headerlink" title="2.1 Activity"></a>2.1 Activity</h2><p>Activityåœ¨å±å¹•ä¸Šä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªGUIç•Œé¢ï¼Œå…è®¸ç”¨æˆ·åœ¨ä¸Šé¢åšä¸€äº›äº¤äº’æ€§çš„æ“ä½œï¼Œ æ¯”å¦‚æ‰“ç”µè¯ã€ç…§ç›¸ã€å‘é€é‚®ä»¶ã€‚</p><ol><li>ä¸€ä¸ªAndroidåº”ç”¨ä¸€èˆ¬æœ‰å¤šä¸ªActivityã€‚</li><li>Activityä¹‹é—´é€šè¿‡Intentè¿›è¡Œé€šä¿¡ã€‚</li><li>Andoridåº”ç”¨ä¸­æ¯ä¸ªActivityéƒ½å¿…é¡»åœ¨AndroidManifest.xmlé…ç½®æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œï¼Œå¦åˆ™ç³»ç»Ÿå°†ä¸è¯†åˆ«ä¹Ÿä¸æ‰§è¡Œè¯¥Activityã€‚</li></ol><h3 id="Activityçš„ç›¸å…³æ–¹æ³•"><a href="#Activityçš„ç›¸å…³æ–¹æ³•" class="headerlink" title="Activityçš„ç›¸å…³æ–¹æ³•"></a>Activityçš„ç›¸å…³æ–¹æ³•</h3><ul><li><strong>onCreate()<strong>ï¼šåªåœ¨Activityåˆ›å»ºæ—¶è°ƒç”¨ï¼Œé€šå¸¸åšä¸€äº›åˆå§‹åŒ–è®¾ç½®ï¼Œ</strong>ä¸å¯è§</strong>ã€‚</li><li><strong>onStart()<strong>ï¼šåœ¨Activityç”±ä¸å¯è§å˜ä¸ºå¯è§æ—¶è°ƒç”¨ï¼Œ</strong>å¯è§</strong>ï¼Œæ­¤æ—¶ç”¨æˆ·å¯ä»¥çœ‹åˆ°ç•Œé¢ï¼Œä½†æ²¡æœ‰è·å–åˆ°ç„¦ç‚¹ï¼Œç”¨æˆ·ä¸èƒ½è¿›è¡Œæ“ä½œã€‚</li><li><strong>onResume()<strong>ï¼šæ­¤æ—¶Activityè·å–åˆ°ç„¦ç‚¹ï¼Œèƒ½å¤Ÿä¸ç”¨æˆ·äº¤äº’ï¼Œ</strong>å¯è§</strong>ã€‚æ­¤æ–¹æ³•æ˜¯åœ¨ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’æ—¶è°ƒç”¨ã€‚</li><li><strong>onPause()<strong>ï¼šåœ¨å½“å‰Activityè¢«å…¶å®ƒActivityè¦†ç›–æˆ–é”å±æ—¶è°ƒç”¨ï¼Œ</strong>å¯è§</strong>ï¼Œä½†å¤±å»ç„¦ç‚¹ã€‚æ­¤æ—¶ä¼šå¯¹çŠ¶æ€ä¿¡æ¯å’Œæ•°æ®è¿›è¡Œä¿å­˜ã€‚</li><li><strong>onStop()<strong>ï¼šåœ¨Activityä¸å¯è§æ—¶è°ƒç”¨ï¼Œ</strong>ä¸å¯è§</strong>ï¼ŒActivityè¿›å…¥åˆ°äº†åå°ï¼Œä¸”Activityå¯¹è±¡ä»åœ¨å†…å­˜ä¸­ã€‚</li><li>**onDestroy()**ï¼šåœ¨Activityé”€æ¯æ—¶è°ƒç”¨ã€‚</li><li>**onRestart()**ï¼šå½“å¤„äºStoppedçŠ¶æ€çš„æ´»åŠ¨éœ€è¦å†æ¬¡å±•ç°ç»™ç”¨æˆ·æ—¶è°ƒç”¨ã€‚</li></ul><h3 id="Activityçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Activityçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Activityçš„ç”Ÿå‘½å‘¨æœŸ"></a>Activityçš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307041425246.jpg"></p><p>ä¸Šè¿°å›¾ç‰‡ä¸­ï¼Œå­˜åœ¨ä¸‰ä¸ªå‘¨æœŸï¼š</p><ol><li>æ•´ä¸ªçš„ç”Ÿå‘½å‘¨æœŸï¼šonCreate() â†’ onStart() â†’ onResume() â†’ Activity running â†’ onPause() â†’ onStop() â†’ onDestory()</li><li>å¯è§çš„ç”Ÿå‘½å‘¨æœŸï¼šonStart() â†’ onResume() â†’ Activity running â†’ onPause() â†’ onStop() â†’ onRestart()</li><li>å‰å°çš„ç”Ÿå‘½å‘¨æœŸï¼šonResume() â†’ Activity running â†’ onPause()</li></ol><h3 id="Activityæ ˆ"><a href="#Activityæ ˆ" class="headerlink" title="Activityæ ˆ"></a>Activityæ ˆ</h3><p>Androidç³»ç»Ÿé‡‡ç”¨æ ˆç»“æ„æ¥ç®¡ç†åº”ç”¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ‰€å¯åŠ¨çš„Activityï¼Œå³Activityæ ˆã€‚</p><p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307041424674.png"></p><h3 id="Activityçš„å››ç§çŠ¶æ€"><a href="#Activityçš„å››ç§çŠ¶æ€" class="headerlink" title="Activityçš„å››ç§çŠ¶æ€"></a>Activityçš„å››ç§çŠ¶æ€</h3><ol><li><p><strong>Active&#x2F;Running</strong></p><p>å½“å‰Activityå¤„åœ¨å±å¹•æœ€å‰ç«¯ï¼ˆåœ¨Activityæ ˆçš„é¡¶éƒ¨ï¼‰ï¼Œæ­¤æ—¶å¯ä»¥ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ï¼Œå«åšæ´»åŠ¨çŠ¶æ€æˆ–è¿è¡ŒçŠ¶æ€ã€‚</p></li><li><p><strong>Paused</strong></p><p>å¦‚æœå½“å‰Activityè¢«ä¸€ä¸ªæ–°çš„éå…¨å±çš„Activity æˆ–è€…ä¸€ä¸ªé€æ˜çš„Activity è¦†ç›–æ—¶ï¼Œæ­¤æ—¶çš„çŠ¶æ€å«åšæš‚åœçŠ¶æ€ï¼ˆPausedï¼‰ã€‚æ­¤æ—¶å®ƒä¾ç„¶ä¿æŒæ´»åŠ›ï¼ˆä¿æŒæ‰€æœ‰çš„çŠ¶æ€ï¼Œæˆå‘˜ä¿¡æ¯ï¼Œå’Œçª—å£ç®¡ç†å™¨ä¿æŒè¿æ¥ï¼‰ï¼Œæ‰€ä»¥å®ƒä»ç„¶å¯è§ï¼Œä½†å·²ç»å¤±å»äº†ç„¦ç‚¹æ•…ä¸å¯ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ã€‚å½“å†…å­˜ä¸è¶³æ—¶ï¼ŒActivityé€šå¸¸ä¼šè¢«ç³»ç»Ÿæ€æ­»ã€‚</p></li><li><p><strong>Stopped</strong></p><p>å¦‚æœå½“å‰çš„Activityè¢«å¦ä¸€ä¸ªActivityå®Œå…¨é®æŒ¡ï¼Œæ­¤æ—¶çŠ¶æ€å«åšåœæ­¢çŠ¶æ€ï¼ˆStoppedï¼‰ã€‚å®ƒä»ç„¶ä¿ç•™æ‰€æœ‰çŠ¶æ€å’Œæˆå‘˜ä¿¡æ¯ï¼Œä½†æ˜¯å®ƒä¸å†å¯¹ç”¨æˆ·å¯è§ã€‚å½“å†…å­˜ä¸è¶³æ—¶ï¼ŒActivityé€šå¸¸ä¼šè¢«ç³»ç»Ÿæ€æ­»ã€‚</p></li><li><p><strong>Killed</strong></p><p>Activityè¢«ç³»ç»Ÿç»ˆæ­¢è¿›ç¨‹ï¼Œå°†è¯¥Activityä»å†…å­˜ä¸­åˆ é™¤ã€‚</p></li></ol><h3 id="Activityçš„å¯åŠ¨æ¨¡å¼"><a href="#Activityçš„å¯åŠ¨æ¨¡å¼" class="headerlink" title="Activityçš„å¯åŠ¨æ¨¡å¼"></a>Activityçš„å¯åŠ¨æ¨¡å¼</h3><ol><li><p><strong>Standard</strong>æ ‡å‡†æ¨¡å¼ </p><p>Activityçš„é»˜è®¤å¯åŠ¨æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼ŒåŒä¸€ä¸ªActivityå¯ä»¥è¢«å¤šæ¬¡å®ä¾‹åŒ–ã€‚</p></li><li><p><strong>singleTop</strong> æ ˆé¡¶å•ä¾‹æ¨¡å¼ </p><p>å¦‚æœéœ€è¦å¯åŠ¨çš„Activityå­˜åœ¨ä¸”ä½äºæ ˆé¡¶ï¼Œåˆ™ä¸ä¼šé‡æ–°åˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨æ ˆé¡¶çš„Activityã€‚ä½†æ˜¯ï¼Œå¦‚æœéœ€è¦å¯åŠ¨çš„Activityå­˜åœ¨ä½†ä¸ä½äºæ ˆé¡¶ï¼Œé‚£ä¹ˆä»åˆ›å»ºæ–°çš„Activityã€‚</p></li><li><p><strong>singleTask</strong>æ ˆå†…å•ä¾‹æ¨¡å¼</p><p>åŒä¸€ä¸ªActivityåªè¢«å…è®¸åœ¨ç³»ç»Ÿä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªActivityå®ä¾‹ã€‚å¦‚æœç³»ç»Ÿä¸­å·²ç»æœ‰äº†ä¸€ä¸ªå®ä¾‹ï¼Œ æŒæœ‰è¿™ä¸ªå®ä¾‹çš„ä»»åŠ¡å°†ç§»åŠ¨åˆ°é¡¶éƒ¨ï¼ŒåŒæ—¶intentå°†è¢«é€šè¿‡onNewIntent()å‘é€ã€‚ å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Activityå¹¶ç½®æ”¾åœ¨åˆé€‚çš„ä»»åŠ¡ä¸­ã€‚</p></li><li><p><strong>singleInstance</strong>å…¨å±€å•ä¾‹æ¨¡å¼ </p><p>ä¸Šé¢ä¸‰ç§æ¨¡å¼éƒ½æ˜¯åœ¨åŒä¸€ä¸ªä»»åŠ¡æ ˆä¸­è¿›è¡Œçš„ï¼Œè€Œè¿™ä¸ªæ¨¡å¼å®ƒä¼šå¦èµ·ä¸€ä¸ªæ–°çš„ä»»åŠ¡æ ˆã€‚å°†ä¸€ä¸ªActivityæŒ‡å®šä¸ºsingleInstanceæ¨¡å¼ï¼Œå½“å¯åŠ¨è¿™ä¸ªActiviyæ—¶ä¼šä½¿ç”¨ä¸€ä¸ªæ–°çš„ä»»åŠ¡æ ˆæ¥ç®¡ç†å®ƒï¼Œä¸singleTaskç›¸åŒï¼Œ åŒä¸€æ—¶åˆ»åœ¨ç³»ç»Ÿä¸­åªä¼šå­˜åœ¨ä¸€ä¸ªè¿™æ ·çš„Activityå®ä¾‹ã€‚</p></li></ol><h2 id="2-2-Service"><a href="#2-2-Service" class="headerlink" title="2.2 Service"></a>2.2 Service</h2><p>Serviceæ˜¯ä¸€ç§å¯ä»¥é•¿æ—¶é—´è¿è¡Œåœ¨åå°çš„ï¼Œæ— ç•Œé¢çš„æœåŠ¡ç¨‹åºã€‚å®ƒå¯ä»¥å’Œå…¶ä»–ç»„ä»¶è¿›è¡Œäº¤äº’ã€‚Serviceéœ€è¦åœ¨AndroidManifest.xmlé…ç½®æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚éŸ³ä¹æ’­æ”¾å™¨åœ¨åå°ä»ç„¶å¯ä»¥è¿›è¡ŒéŸ³ä¹çš„æ’­æ”¾ã€æš‚åœã€åˆ‡æ­Œç­‰æ“ä½œï¼Œè¿™äº›éƒ½æ˜¯ç”±æ’­æ”¾éŸ³ä¹çš„Serviceè¿›è¡Œæ§åˆ¶ã€‚</p><h3 id="Serviceçš„ç›¸å…³æ–¹æ³•"><a href="#Serviceçš„ç›¸å…³æ–¹æ³•" class="headerlink" title="Serviceçš„ç›¸å…³æ–¹æ³•"></a>Serviceçš„ç›¸å…³æ–¹æ³•</h3><ul><li>**onCreate()**ï¼šServiceé¦–æ¬¡è¢«åˆ›å»ºæ—¶æ‰ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚</li><li>**onDestory()**ï¼šServiceè¢«å…³é—­æ—¶ä¼šå›è°ƒè¯¥æ–¹æ³•ã€‚</li><li>**onStartCommand()**ï¼šå½“Serviceè¢«å¯åŠ¨æ—¶è°ƒç”¨è¯¥æ–¹æ³•ã€‚åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œå¯ä»¥æ‰§è¡Œå¦‚æ’­æ”¾åª’ä½“æ–‡ä»¶ã€ä¸‹è½½èµ„æºç­‰ä»»åŠ¡ã€‚</li><li>**onbind()**ï¼šä¸ç›®æ ‡å®¢æˆ·ç«¯è¿›è¡Œç»‘å®šï¼Œè¿”å›ä¸€ä¸ª IBinder å¯¹è±¡ï¼Œappé€šè¿‡è¯¥å¯¹è±¡ä¸Serviceç»„ä»¶è¿›è¡Œé€šä¿¡ã€‚</li><li>**onUnbind()**ï¼šåªæœ‰ä¸Serviceç»‘å®šçš„æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å–æ¶ˆç»‘å®šæ—¶ï¼Œæ‰ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚</li><li>**stopSelf()**ï¼šæœåŠ¡è‡ªèº«è°ƒç”¨ï¼Œç”¨äºåœæ­¢æœåŠ¡ã€‚</li><li>**startService()**ï¼šå®¢æˆ·ç«¯è¯·æ±‚å¯åŠ¨æœåŠ¡ï¼Œä½¿æœåŠ¡è¿›å…¥â€œstartedâ€çŠ¶æ€ï¼Œå³ä½¿åº”ç”¨ç¨‹åºå·²ç»åœæ­¢æˆ–è€…å·²ç»é”€æ¯ï¼ŒæœåŠ¡ä»ç„¶å¯ä»¥ç»§ç»­è¿è¡Œã€‚</li><li>**stopService()**ï¼šå®¢æˆ·ç«¯è¯·æ±‚åœæ­¢æœåŠ¡ï¼Œé‡Šæ”¾æ‰€å ç”¨çš„èµ„æºã€‚</li><li>**bindService()**ï¼šå®¢æˆ·ç«¯è¯·æ±‚ç»‘å®šæœåŠ¡ã€‚</li><li>**unbindService()**ï¼šå®¢æˆ·ç«¯è¯·æ±‚è§£é™¤æœåŠ¡ç»‘å®šã€‚è¿™ä¸ªæ–¹æ³•ç”¨äºæ–­å¼€å®¢æˆ·ç«¯ä¸æœåŠ¡ä¹‹é—´çš„è¿æ¥ã€‚</li></ul><h3 id="Serviceçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Serviceçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Serviceçš„ç”Ÿå‘½å‘¨æœŸ"></a>Serviceçš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307041423993.png"></p><p>ä¸Šè¿°å›¾ç‰‡ä¸­ï¼Œå­˜åœ¨ä¸¤ç§å‘¨æœŸï¼š</p><ol><li><p><strong>StartService</strong></p><p>onCreate() â†’ onStartCommand() â†’ Service running â†’ onDestory()</p></li><li><p><strong>BindService</strong></p><p>onCreate() â†’ onBind() â†’ â€¦â€¦ â†’ onUnbind() â†’ onDestory()</p></li></ol><h3 id="Serviceçš„ä¸¤ç§å¯åŠ¨æ–¹å¼"><a href="#Serviceçš„ä¸¤ç§å¯åŠ¨æ–¹å¼" class="headerlink" title="Serviceçš„ä¸¤ç§å¯åŠ¨æ–¹å¼"></a>Serviceçš„ä¸¤ç§å¯åŠ¨æ–¹å¼</h3><ol><li><strong>StartService</strong><ul><li>ç³»ç»Ÿå¯¹åŒä¸€ä¸ªServiceåªä¼šåˆ›å»ºä¸€ä¸ªServiceå®ä¾‹ã€‚å¦‚æœServiceå®ä¾‹ä¸å­˜åœ¨ï¼Œè°ƒç”¨startServiceåˆ™ä¼šå®ä¾‹åŒ–ä¸€ä¸ªServiceå¯¹è±¡ï¼Œå¦åˆ™å¤ç”¨ä¹‹å‰åˆ›å»ºçš„Serviceå®ä¾‹ã€‚</li><li>é€šè¿‡stopSelf()æˆ–StopService()å…³é—­Serviceã€‚</li><li>å¦‚æœè°ƒç”¨è€…ç›´æ¥é€€å‡ºè€Œæ²¡æœ‰è°ƒç”¨StopServiceï¼ŒServiceä¼šä¸€ç›´åœ¨åå°è¿è¡Œã€‚è¯¥Serviceçš„è°ƒç”¨è€…å†å¯åŠ¨èµ·æ¥åå¯ä»¥é€šè¿‡stopServiceå…³é—­Serviceã€‚</li></ul></li><li><strong>BindService</strong><ul><li>ç³»ç»Ÿå¯¹åŒä¸€ä¸ªServiceåªä¼šåˆ›å»ºä¸€ä¸ªServiceå®ä¾‹ã€‚å¦‚æœServiceå®ä¾‹ä¸å­˜åœ¨ï¼Œè°ƒç”¨bindServiceåˆ™ä¼šå®ä¾‹åŒ–ä¸€ä¸ªServiceå¯¹è±¡ï¼Œå¦åˆ™å¤ç”¨ä¹‹å‰åˆ›å»ºçš„Serviceå®ä¾‹ã€‚</li><li>å½“Serviceåªä¸ä¸€ä¸ªå®¢æˆ·ç«¯ç»‘å®šæ—¶ï¼Œè°ƒç”¨unbindService()æˆ–è€…è°ƒç”¨è€…é€€å‡ºï¼ŒServiceä¼šè¢«é”€æ¯ã€‚å½“Serviceä¸å¤šä¸ªå®¢æˆ·ç«¯ç»‘å®šæ—¶ï¼Œåªæœ‰ä¸æ‰€æœ‰å®¢æˆ·ç«¯å–æ¶ˆç»‘å®šåï¼ŒServiceæ‰ä¼šè¢«é”€æ¯ã€‚</li></ul></li></ol><h2 id="2-3-BroadcastReceiver"><a href="#2-3-BroadcastReceiver" class="headerlink" title="2.3 BroadcastReceiver"></a>2.3 BroadcastReceiver</h2><p>Broadcastæ˜¯ä¸€ç§å¹¿æ³›è¿ç”¨çš„åœ¨åº”ç”¨ç¨‹åºä¹‹é—´ä¼ è¾“ä¿¡æ¯çš„æœºåˆ¶ã€‚è€ŒBroadcastReceiver æ˜¯å¯¹å‘é€å‡ºæ¥çš„Broadcastè¿›è¡Œè¿‡æ»¤æ¥å—å¹¶å“åº”çš„ä¸€ç±»ç»„ä»¶ã€‚å¯ä»¥ä½¿ç”¨BroadcastReceiver æ¥è®©åº”ç”¨å¯¹å¤–éƒ¨çš„äº‹ä»¶åšå‡ºå“åº”ã€‚</p><p>BroadcastReceiveråªèƒ½æ‰§è¡Œéå¸¸æœ‰é™çš„æ“ä½œï¼Œå› ä¸ºå®ƒæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¹¶ä¸”ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œè¢«ç³»ç»Ÿæ€æ­»ä»¥é‡Šæ”¾èµ„æºã€‚å¦‚æœBroadcastReceiveréœ€è¦æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œå»ºè®®ä½¿ç”¨IntentServiceæˆ–è€…å¼€å¯æ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><h3 id="BroadcastReceiverçš„ç›¸å…³æ–¹æ³•"><a href="#BroadcastReceiverçš„ç›¸å…³æ–¹æ³•" class="headerlink" title="BroadcastReceiverçš„ç›¸å…³æ–¹æ³•"></a>BroadcastReceiverçš„ç›¸å…³æ–¹æ³•</h3><ul><li><p>**onReceive()**ï¼šBroadcastReceiver å¿…é¡»å®ç°çš„æ–¹æ³•ã€‚åœ¨æ¥æ”¶åˆ°å¹¿æ’­æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚</p></li><li><p>**setResult()**ï¼šè®¾ç½®è¿”å›ç»“æœå’Œæ•°æ®ã€‚</p></li><li><p>**getResultCode()**ï¼šè·å–BroadcastReceiver è¿”å›ç»“æœçš„çŠ¶æ€ç ã€‚</p></li><li><p>**getResultData()**ï¼šè·å–BroadcastReceiver è¿”å›çš„æ•°æ®ã€‚</p></li><li><p>**getResultExtras()**ï¼šè·å–BroadcastReceiver è¿”å›çš„é¢å¤–æ•°æ®ã€‚</p></li><li><p>**peekService()**ï¼šæ£€æŸ¥æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ï¼Œè¿”å›å¯¹åº”çš„ IBinderå¯¹è±¡ã€‚</p></li><li><p>**setAbortBroadcast()**ï¼šç»ˆæ­¢å¹¿æ’­ä¼ é€’ï¼Œä½¿å…¶ä»–BroadcastReceiver æ¥æ”¶ä¸åˆ°è¯¥å¹¿æ’­ã€‚</p></li><li><p>**getInstance()**ï¼šè·å¾—å¹¿æ’­å®ä¾‹</p></li><li><p>**registerReceiver()**ï¼šæ³¨å†ŒBroadcastReceiver </p></li><li><p>**sendBroadcast()**ï¼šå‘é€å¹¿æ’­</p></li><li><p>**unregisterReceiver()**ï¼šé”€æ¯BroadcastReceiver</p></li></ul><h3 id="Broadcastçš„ä¸¤ç§ç±»å‹"><a href="#Broadcastçš„ä¸¤ç§ç±»å‹" class="headerlink" title="Broadcastçš„ä¸¤ç§ç±»å‹"></a>Broadcastçš„ä¸¤ç§ç±»å‹</h3><ol><li><p><strong>æ ‡å‡†å¹¿æ’­</strong></p><p>å®Œå…¨å¼‚æ­¥æ‰§è¡Œçš„å¹¿æ’­ï¼Œæ‰€æœ‰çš„æ¥æ”¶è€…å‡ ä¹åŒæ—¶æ¥æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ã€‚è¿™ç§å¹¿æ’­ä¸ä¿è¯æ¥æ”¶è€…èƒ½å¤ŸåŒæ—¶å¤„ç†å¹¿æ’­ï¼Œä¹Ÿä¸èƒ½ä¿è¯æ¥æ”¶è€…æŒ‰ç…§ç‰¹å®šçš„é¡ºåºæ¥æ”¶åˆ°å¹¿æ’­ã€‚</p></li><li><p><strong>æœ‰åºå¹¿æ’­</strong></p><p>åŒæ­¥æ‰§è¡Œçš„ä¸€ç§å¹¿æ’­ï¼Œå‘å‡ºå¹¿æ’­åï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå¹¿æ’­æ¥å—è€…èƒ½æ”¶åˆ°ï¼Œå½“è¿™ä¸ªå¹¿æ’­æ¥æ”¶è€…çš„é€»è¾‘æ‰§è¡Œå®Œåï¼Œæ‰ä¼šä¼ é€’åˆ°ä¸‹ä¸€ä¸ªæ¥æ”¶è€…ã€‚å½“ç„¶ï¼Œå‰é¢çš„æ¥å—è€…è¿˜å¯ä»¥æˆªæ–­å¹¿æ’­çš„ç»§ç»­ä¼ é€’ï¼Œé‚£ä¹ˆåç»­æ¥å—è€…å°±æ— æ³•æ”¶åˆ°å¹¿æ’­ä¿¡æ¯äº†ã€‚</p></li></ol><h3 id="BroadcastReceiverçš„ä¸¤ç§æ³¨å†Œæ–¹æ³•"><a href="#BroadcastReceiverçš„ä¸¤ç§æ³¨å†Œæ–¹æ³•" class="headerlink" title="BroadcastReceiverçš„ä¸¤ç§æ³¨å†Œæ–¹æ³•"></a>BroadcastReceiverçš„ä¸¤ç§æ³¨å†Œæ–¹æ³•</h3><ol><li><p>é™æ€æ³¨å†Œ</p><p>åœ¨AndroidManifest,xmlé…ç½®æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œã€‚</p></li><li><p>åŠ¨æ€æ³¨å†Œ</p><p>åœ¨ä»£ç ä¸­ä½¿ç”¨ Context.registerReceiver() è¿›è¡Œæ³¨å†Œã€‚</p></li></ol><h4 id="ä¸¤è€…åŒºåˆ«"><a href="#ä¸¤è€…åŒºåˆ«" class="headerlink" title="ä¸¤è€…åŒºåˆ«"></a>ä¸¤è€…åŒºåˆ«</h4><ul><li>åŠ¨æ€æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸æ³¨å†Œå®ƒçš„Activityå…±å­˜äº¡ã€‚</li><li>é™æ€æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸è®¾å¤‡å…±å­˜äº¡ã€‚</li></ul><h2 id="2-4-ContentProvider"><a href="#2-4-ContentProvider" class="headerlink" title="2.4 ContentProvider"></a>2.4 ContentProvider</h2><p>ContentProviderå…è®¸åº”ç”¨ç¨‹åºå…±äº«æ•°æ®ï¼Œå¹¶é€šè¿‡URIè¿›è¡Œè®¿é—®ã€‚å¦‚æœä¸€ä¸ªContentProviderç®¡ç†å¤šä¸ªæ•°æ®é›†ï¼Œå…¶å°†ä¼šä¸ºæ¯ä¸ªæ•°æ®é›†åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„URIã€‚</p><p>Androidæ‰€æä¾›çš„ContentProvideréƒ½å­˜æ”¾åœ¨android.providerè¿™ä¸ªåŒ…é‡Œé¢ã€‚</p><p>ContentProvideréœ€è¦åœ¨AndroidManifest.xmlé…ç½®æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œã€‚</p><h3 id="ContentProviderçš„ç›¸å…³æ–¹æ³•"><a href="#ContentProviderçš„ç›¸å…³æ–¹æ³•" class="headerlink" title="ContentProviderçš„ç›¸å…³æ–¹æ³•"></a>ContentProviderçš„ç›¸å…³æ–¹æ³•</h3><p>ContentProvider ä½¿ç”¨ URI æ¥å®šä¹‰æ•°æ®é›†åˆï¼Œå¹¶æä¾›äº†ä¸€äº›æ ‡å‡†æ–¹æ³•ï¼Œå¦‚æŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ç­‰ï¼Œä»¥ä¾¿å…¶ä»–åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ ContentResolver è®¿é—®å’Œæ“ä½œæ•°æ®ã€‚ContentResolver å¯ä»¥é€šè¿‡ Context.getContentResolver() æ–¹æ³•è·å¾—ã€‚</p><ul><li>**onCreate()**ï¼šåœ¨ ContentProvider è¢«åˆ›å»ºæ—¶è°ƒç”¨ï¼Œä¼šåŠé€†è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œã€‚</li><li>**query()**ï¼šç”¨äºè·å– ContentProvider ä¸­çš„æ•°æ®ã€‚</li><li>**insert()**ï¼šç”¨äºå‘ ContentProvider ä¸­æ’å…¥æ•°æ®ã€‚</li><li>**update()**ï¼šç”¨äºæ›´æ–° ContentProvider ä¸­ç°æœ‰çš„æ•°æ®ã€‚</li><li>**delete()**ï¼šç”¨äºä» ContentProviderä¸­åˆ é™¤æ•°æ®ã€‚</li></ul><h3 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h3><p>URI(Universal Resource Identifier) ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼Œæ¯ä¸€ä¸ª ContentProvider éƒ½å¯¹å¤–æä¾›ä¸€ä¸ªèƒ½å¤Ÿå”¯ä¸€æ ‡è¯†è‡ªå·±æ•°æ®é›†çš„å…¬å¼€URIï¼Œè¿™ä¸ªURIç”¨äºè¡¨ç¤ºè¿™ä¸ªContent Provideræä¾›çš„æ•°æ®ã€‚</p><p>URIè¢«ç”¨æ¥æ ‡è¯†æ•°æ®æºå’Œæ“ä½œç±»å‹ï¼Œå®ƒé€šå¸¸ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š</p><ol><li>**æ–¹æ¡ˆ(scheme)**ï¼šç”¨äºæŒ‡å®šè®¿é—®èµ„æºæ‰€éœ€è¦çš„åè®®æˆ–ç±»å‹ï¼Œä¾‹å¦‚httpã€httpsã€fileã€contentç­‰ã€‚</li><li>**æˆæƒ(authority)**ï¼šåˆ†ä¸ºä¸»æœº(host)å’Œç«¯å£(port)ã€‚ä¸»æœºç”¨äºæ ‡è¯†è¦è®¿é—®çš„ä¸»æœºåæˆ–IPåœ°å€ï¼Œå¯¹äºæœ¬åœ°æ–‡ä»¶ï¼Œä¸»æœºå¯ä»¥æ˜¯localhostæˆ–ç©ºã€‚ç«¯å£å¯é€‰ã€‚</li><li>**è·¯å¾„(Path)**ï¼šç”¨äºæ ‡è¯†è¦è®¿é—®çš„èµ„æºåœ¨æœåŠ¡å™¨ä¸­çš„ä½ç½®ã€‚å®ƒç”±å¤šä¸ªå•è¯ç»„æˆï¼Œå¹¶é€šè¿‡â€™&#x2F;â€˜åˆ†å‰²å¼€æ¥ï¼Œä¾‹å¦‚â€œcontacts&#x2F;people&#x2F;3â€ã€‚åé¢å¯ä»¥å¢æ·»æŸ¥è¯¢å‚æ•°ï¼ˆç”¨äºä¼ é€’é”®å€¼å¯¹å½¢å¼çš„æ•°æ®ï¼‰å’Œç‰‡æ®µæ ‡è¯†ç¬¦(Fragment Identifierï¼Œç”¨äºè¡¨ç¤ºèµ„æºä¸­ç‰¹å®šéƒ¨åˆ†ï¼Œä¾‹å¦‚HTMLä¸­çš„é”šç‚¹ï¼‰ã€‚</li></ol><p>URIé€šå¸¸æœ‰ä»¥ä¸‹ä¸‰ç§å½¢å¼ï¼š</p><ul><li>scheme**:**&#x2F;&#x2F;authority&#x2F;path?query#fragmentï¼ˆç”¨äºè®¿é—®æœ¬åœ°èµ„æºï¼‰</li><li>scheme**:<strong>&#x2F;&#x2F;host</strong>:**port&#x2F;path?query#fragmentï¼ˆç”¨äºè®¿é—®ç½‘ç»œèµ„æºï¼‰</li><li>scheme**:**scheme-specific-part#fragmentï¼ˆç”¨äºæ‰“ç”µè¯ç­‰æœåŠ¡ï¼‰</li></ul><p>ä¸€ä¸ªå®Œæ•´çš„URIç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">content:<span class="hljs-regexp">//</span>com.example.provider<span class="hljs-regexp">/contacts/</span>people/<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/628232942">AndroidåŸºç¡€çŸ¥è¯†â€”â€”å››å¤§ç»„ä»¶ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://www.runoob.com/w3cnote/android-tutorial-activity.html">4.1.1 Activityåˆå­¦ä¹ç»ƒ | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidç³»ç»Ÿæ¶æ„</title>
    <link href="/2023/07/04/Android%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"/>
    <url>/2023/07/04/Android%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€Androidç³»ç»Ÿæ¶æ„"><a href="#ä¸€ã€Androidç³»ç»Ÿæ¶æ„" class="headerlink" title="ä¸€ã€Androidç³»ç»Ÿæ¶æ„"></a>ä¸€ã€Androidç³»ç»Ÿæ¶æ„</h1><h2 id="1-1-æ¦‚è¿°"><a href="#1-1-æ¦‚è¿°" class="headerlink" title="1.1 æ¦‚è¿°"></a>1.1 æ¦‚è¿°</h2><p>Googleåœ¨Android 8ç‰ˆæœ¬æ—¶å¼€å±•äº† <code>Treble</code> è®¡åˆ’ï¼Œå¯¹Androidç³»ç»Ÿè¿›è¡Œäº†é‡æ–°æ¶æ„ï¼Œå°†å®‰å“ç³»ç»Ÿæ¡†æ¶ä¸Vendorå±‚è§£è€¦ï¼ŒåŠ›æ±‚å½»åº•è§£å†³å®‰å“ç¢ç‰‡åŒ–çš„é—®é¢˜ï¼Œè¿™æ˜¯å®‰å“ç³»ç»Ÿæ¶æ„æœ€å¤§çš„å˜åŒ–ã€‚</p><p>Android 8å‰åä¸¤è€…åŒºåˆ«åœ¨äºAndroid 8 ä¹‹åçš„ç³»ç»Ÿæ¶æ„å¤šäº†ä¸€å±‚ç¡¬ä»¶æŠ½è±¡å±‚(HAL)ã€‚ï¼Œå…¶ç›®çš„æ˜¯å°†ç‰©ç†ç¡¬ä»¶ä¸æ“ä½œç³»ç»Ÿåˆ†ç¦»ï¼Œä½¿å¼€å‘äººå‘˜å¯ä»¥æ›´åŠ æ–¹ä¾¿åœ°ç¼–å†™ç¡¬ä»¶é©±åŠ¨ç¨‹åºï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨å„ç§ä¸åŒåœ°ç¡¬ä»¶å¹³å°ä¹‹é—´è¿›è¡Œç§»æ¤ã€‚</p><p>ä»¥ä¸‹æ˜¯å®˜æ–¹ç»™å‡ºçš„Android 8ç³»ç»Ÿä¹‹ååœ°åˆ†å±‚æ¶æ„å›¾ï¼Œæ€»å…±åˆ†ä¸º5å±‚ï¼Œä»ä¸‹å¾€ä¸Šä¾æ¬¡åˆ†ä¸ºLinuxå†…æ ¸ã€ç¡¬ä»¶æŠ½è±¡å±‚(HAL)ã€åŸç”Ÿ Native åº“å’Œ Android Runtimeã€Java API æ¡†æ¶ä»¥åŠåº”ç”¨å±‚ï¼Œå…¶ä¸­æ¯ä¸€å±‚éƒ½åŒ…å«å¤§é‡çš„å­æ¨¡å—æˆ–å­ç³»ç»Ÿã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202307041139788.png"/><h2 id="1-2-Linuxå†…æ ¸"><a href="#1-2-Linuxå†…æ ¸" class="headerlink" title="1.2 Linuxå†…æ ¸"></a>1.2 Linuxå†…æ ¸</h2><p>Androidç³»ç»Ÿçš„åº•å±‚åŸºç¡€æ˜¯Linuxå†…æ ¸å±‚ï¼Œå…¶ä¸»è¦èŒè´£æ˜¯ç®¡ç†ç¡¬ä»¶èµ„æºå’Œè¿›ç¨‹æ§åˆ¶ã€‚å…¶ä¸­åŒ…æ‹¬äº†è®¾å¤‡é©±åŠ¨ç¨‹åºã€å†…å­˜ç®¡ç†ã€ç½‘ç»œåè®®æ ˆç­‰ã€‚è¿™äº›åŠŸèƒ½ä¸ºä¸Šå±‚çš„åº”ç”¨ç¨‹åºæä¾›äº†ç¨³å®šçš„åŸºç¡€æœåŠ¡ã€‚</p><p>å…¶ä¸­ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºæ˜¯Linuxå†…æ ¸éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£ä¸ç¡¬ä»¶è¿›è¡Œäº¤äº’ï¼ŒåŒ…æ‹¬æ‘„åƒå¤´ã€æ˜¾ç¤ºå™¨ã€WiFiã€è“ç‰™ç­‰ã€‚é€šè¿‡è°ƒç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºï¼ŒAndroidç³»ç»Ÿæ‰èƒ½å®Œæˆä¸ç¡¬ä»¶è®¾å¤‡çš„é€šä¿¡å’Œæ“ä½œã€‚</p><h2 id="1-3-ç¡¬ä»¶æŠ½è±¡å±‚-HAL"><a href="#1-3-ç¡¬ä»¶æŠ½è±¡å±‚-HAL" class="headerlink" title="1.3 ç¡¬ä»¶æŠ½è±¡å±‚(HAL)"></a>1.3 ç¡¬ä»¶æŠ½è±¡å±‚(HAL)</h2><p>HALæ˜¯ä½äºæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ç¡¬ä»¶ç”µè·¯ä¹‹é—´çš„æ¥å£å±‚ï¼Œå…¶ç›®çš„åœ¨äºå°†ç¡¬ä»¶æŠ½è±¡åŒ–ã€‚HALå®šä¹‰äº†ä¸€ç³»åˆ—æ ‡å‡†æ¥å£å’ŒæŠ½è±¡ç±»ï¼Œè¿™äº›æ¥å£å’ŒæŠ½è±¡ç±»æè¿°äº†è®¸å¤šç¡¬ä»¶è®¾å¤‡çš„é€šç”¨è¡Œä¸ºå’Œå±æ€§ã€‚æ¯ä¸ªHALæ¨¡å—éƒ½å¯¹åº”ä¸€ä¸ªç¡¬ä»¶è®¾å¤‡ç±»å‹ï¼Œä¾‹å¦‚ç›¸æœºã€è“ç‰™ç­‰ã€‚å½“Androidç³»ç»Ÿéœ€è¦ä½¿ç”¨æŸä¸ªç¡¬ä»¶è®¾å¤‡æ—¶ï¼Œå®ƒä¼šæ ¹æ®è®¾å¤‡ç±»å‹é€‰æ‹©åˆé€‚çš„HALæ¨¡å—ï¼Œç„¶åè°ƒç”¨è¯¥æ¨¡å—æä¾›çš„APIæ¥è®¿é—®è®¾å¤‡ã€‚</p><h2 id="1-4-åŸç”Ÿ-C-x2F-C-åº“"><a href="#1-4-åŸç”Ÿ-C-x2F-C-åº“" class="headerlink" title="1.4 åŸç”Ÿ C&#x2F;C++ åº“"></a>1.4 åŸç”Ÿ C&#x2F;C++ åº“</h2><p>Native C&#x2F;C++ å±‚æ˜¯æŒ‡ä½¿ç”¨ C å’Œ C++ è¯­è¨€ç¼–å†™çš„ä»£ç ï¼Œé€šå¸¸è¢«ç§°ä¸ºæœ¬åœ°å±‚ã€‚åœ¨ Android åº”ç”¨ç¨‹åºä¸­ï¼Œæœ¬åœ°å±‚ä¸»è¦ç”¨äºè®¿é—®åº•å±‚ç³»ç»Ÿèµ„æºï¼Œä¾‹å¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåè®®æ ˆå’Œç¡¬ä»¶æ¥å£ç­‰ã€‚æœ¬åœ°å±‚è¿˜å¯ä»¥æä¾›ä¸ Java ä»£ç çš„äº’æ“ä½œæ€§ï¼Œä½¿å¾— Android åº”ç”¨ç¨‹åºèƒ½å¤Ÿå……åˆ†åˆ©ç”¨æœ¬åœ°ä»£ç çš„ä¼˜åŠ¿ï¼Œä¾‹å¦‚é«˜æ•ˆçš„å†…å­˜ç®¡ç†å’Œå¿«é€Ÿçš„ç®—æ³•æ‰§è¡Œé€Ÿåº¦ã€‚</p><p>åœ¨ Android æ¶æ„ä¸­ï¼Œæœ¬åœ°å±‚ä¸»è¦è´Ÿè´£ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„ä»»åŠ¡ï¼š</p><ol><li><p>æä¾›ä¸ç¡¬ä»¶äº¤äº’çš„æ¥å£ï¼šæœ¬åœ°å±‚å¯ä»¥å®ç°ä¸ç¡¬ä»¶è®¾å¤‡çš„äº¤äº’ï¼Œä¾‹å¦‚ç›¸æœºã€éŸ³é¢‘å’Œä¼ æ„Ÿå™¨ç­‰ã€‚è¿™äº›è®¾å¤‡é€šå¸¸éœ€è¦ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿèµ„æºï¼Œå› æ­¤éœ€è¦ä½¿ç”¨æœ¬åœ°å±‚çš„åŠŸèƒ½æ¥è®¿é—®å®ƒä»¬ã€‚</p></li><li><p>å®ç°é«˜æ€§èƒ½ç®—æ³•ï¼šä»¥ C å’Œ C++ è¯­è¨€ç¼–å†™çš„ä»£ç é€šå¸¸æ¯” Java ä»£ç æ›´å…·æœ‰é«˜æ€§èƒ½å’Œé«˜æ•ˆç‡ã€‚å½“éœ€è¦å¤„ç†å¤§é‡æ•°æ®æˆ–è¿›è¡Œå¤æ‚è®¡ç®—æ—¶ï¼Œæœ¬åœ°å±‚å¯ä»¥æä¾›æ›´å¥½çš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œå›¾åƒå¤„ç†å’ŒéŸ³é¢‘å¤„ç†ç­‰åº”ç”¨ç¨‹åºé€šå¸¸ä¼šä½¿ç”¨æœ¬åœ°åº“æ¥æé«˜æ€§èƒ½ã€‚</p></li><li><p>è·¨å¹³å°ç§»æ¤æ”¯æŒï¼šç”±äº C å’Œ C++ è¯­è¨€æ˜¯è·¨å¹³å°çš„ï¼Œå› æ­¤æœ¬åœ°å±‚å¯ä»¥è½»æ¾åœ°åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œå¤„ç†å™¨æ¶æ„ä¹‹é—´è¿›è¡Œç§»æ¤ã€‚è¿™æ ·å¯ä»¥ä½¿å¾—åº”ç”¨ç¨‹åºæ›´å…·æœ‰å¯ç§»æ¤æ€§ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å……åˆ†åˆ©ç”¨å„ç§ä¸åŒç¡¬ä»¶å¹³å°çš„ä¼˜åŠ¿ã€‚</p></li></ol><p>ä»¥ä¸‹æ˜¯è¯¥åº“çš„ä¸€äº›APIï¼š</p><ul><li><strong>WebKit</strong>ï¼šä¸€å¥—ç½‘é¡µæµè§ˆå™¨çš„è½¯ä»¶å¼•æ“ã€‚</li><li><strong>OpenMAX AL</strong>ï¼šç”¨äºå®ç°éŸ³é¢‘æˆ–è§†é¢‘æ’­æ”¾åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ§åˆ¶éŸ³é¢‘è¾“å‡ºè®¾å¤‡ã€è¯»å–éŸ³é¢‘æ–‡ä»¶ã€è§£ç éŸ³é¢‘æµã€ç”ŸæˆéŸ³é¢‘è¾“å‡ºç­‰ã€‚</li><li><strong>Libc</strong>ï¼šä»BSDç»§æ‰¿æ¥çš„æ ‡å‡†Cç³»ç»Ÿå‡½æ•°åº“ï¼Œä¸“é—¨ä¸ºåŸºäºåµŒå…¥å¼linuxçš„è®¾å¤‡å®šåˆ¶ã€‚</li><li><strong>Media Framework</strong>ï¼šå¤šåª’ä½“åº“ï¼Œæ”¯æŒå¤šç§å¸¸ç”¨çš„éŸ³é¢‘ã€è§†é¢‘æ ¼å¼å½•åˆ¶å’Œå›æ”¾ã€‚</li><li><strong>OpenGL ES</strong>ï¼š3Dç»˜å›¾å‡½æ•°åº“ã€‚</li></ul><h2 id="1-5-Android-Runtime"><a href="#1-5-Android-Runtime" class="headerlink" title="1.5 Android Runtime"></a>1.5 Android Runtime</h2><p>Android Runtimeåˆå¯ä»¥åˆ†ä¸ºARTè™šæ‹Ÿæœºå’Œæ ¸å¿ƒåº“ä¸¤éƒ¨åˆ†ã€‚</p><h3 id="æ ¸å¿ƒåº“"><a href="#æ ¸å¿ƒåº“" class="headerlink" title="æ ¸å¿ƒåº“"></a>æ ¸å¿ƒåº“</h3><p>æ ¸å¿ƒåº“æ˜¯ä¸€ç»„åŸºç¡€ç±»åº“ï¼Œæä¾› Java API æ¡†æ¶æ‰€ä½¿ç”¨çš„ Java ç¼–ç¨‹è¯­è¨€ä¸­çš„å¤§éƒ¨åˆ†åŠŸèƒ½ï¼ŒåŒ…æ‹¬äº†ä¸“é—¨ä¸º Android å¼€å‘çš„åŸºäº Java çš„ç¨‹åºåº“ï¼Œè¿™æ ·å¼€å‘è€…å¯ä»¥ä½¿ç”¨Javaè¯­è¨€æ¥ç¼–å†™Androidåº”ç”¨ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„åº“ï¼š</p><ul><li>android.appï¼šæä¾›åº”ç”¨ç¨‹åºæ¨¡å‹çš„è®¿é—®ï¼Œæ˜¯æ‰€æœ‰ Android åº”ç”¨ç¨‹åºçš„åŸºçŸ³ã€‚</li><li>android.contentï¼šæ–¹ä¾¿åº”ç”¨ç¨‹åºä¹‹é—´ï¼Œåº”ç”¨ç¨‹åºç»„ä»¶ä¹‹é—´çš„å†…å®¹è®¿é—®ï¼Œå‘å¸ƒï¼Œæ¶ˆæ¯ä¼ é€’ã€‚</li><li>android.databaseï¼šç”¨äºè®¿é—®å†…å®¹æä¾›è€…å‘å¸ƒçš„æ•°æ®ï¼ŒåŒ…å« SQLite æ•°æ®åº“ç®¡ç†ç±»ã€‚</li><li>android.osï¼šæä¾›åº”ç”¨ç¨‹åºè®¿é—®æ ‡æ³¨æ“ä½œç³»ç»ŸæœåŠ¡çš„èƒ½åŠ›ï¼ŒåŒ…æ‹¬æ¶ˆæ¯ï¼Œç³»ç»ŸæœåŠ¡å’Œè¿›ç¨‹é—´é€šä¿¡ã€‚</li><li>android.textï¼šåœ¨è®¾å¤‡æ˜¾ç¤ºä¸Šæ¸²æŸ“å’Œæ“ä½œæ–‡æœ¬ã€‚</li><li>android.viewï¼šåº”ç”¨ç¨‹åºç”¨æˆ·ç•Œé¢çš„åŸºç¡€æ„å»ºå—ã€‚</li><li>android.widgetï¼šä¸°å¯Œçš„é¢„ç½®ç”¨æˆ·ç•Œé¢ç»„ä»¶é›†åˆï¼ŒåŒ…æ‹¬æŒ‰é’®ï¼Œæ ‡ç­¾ï¼Œåˆ—è¡¨ï¼Œå¸ƒå±€ç®¡ç†ï¼Œå•é€‰æŒ‰é’®ç­‰ã€‚</li><li>android.webkitï¼šä¸€ç³»åˆ—ç±»çš„é›†åˆï¼Œå…è®¸ä¸ºåº”ç”¨ç¨‹åºæä¾›å†…å»ºçš„ Web æµè§ˆèƒ½åŠ›ã€‚</li></ul><h3 id="ARTè™šæ‹Ÿæœº"><a href="#ARTè™šæ‹Ÿæœº" class="headerlink" title="ARTè™šæ‹Ÿæœº"></a>ARTè™šæ‹Ÿæœº</h3><p>ART è™šæ‹Ÿæœºæ˜¯ Android 5.0 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­é»˜è®¤ä½¿ç”¨çš„è™šæ‹Ÿæœºï¼Œä»£æ›¿äº†Android 5.0ä»¥ä¸‹ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„Dalvikè™šæ‹Ÿæœºã€‚å®ƒç”¨äºå°†åº”ç”¨ç¨‹åºä»£ç ç¿»è¯‘æˆå¯åœ¨ Android è®¾å¤‡ä¸Šè¿è¡Œçš„æœºå™¨è¯­è¨€ã€‚</p><p>å®ƒä¸æ—§ç‰ˆ Dalvik è™šæ‹Ÿæœºç›¸æ¯”å…·æœ‰æ›´å¥½çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚ä¸ Dalvik ç›¸æ¯”ï¼ŒART çš„ä¸»è¦ä¼˜åŠ¿æ˜¯ Ahead-of-time ï¼ˆAOTï¼‰ç¼–è¯‘æŠ€æœ¯ï¼Œå¯ä»¥åœ¨åº”ç”¨ç¨‹åºå®‰è£…æ—¶é¢„å…ˆç¼–è¯‘ä»£ç ï¼ˆç¼–è¯‘æˆELFå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œä»¥æé«˜åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ—¶é—´å’Œæ€§èƒ½ã€‚</p><p>å½“ç”¨æˆ·æ‰“å¼€ä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¶ï¼ŒART ä¼šåœ¨åå°ä½¿ç”¨ AOT ç¼–è¯‘å™¨å°†åº”ç”¨ç¨‹åºçš„ Dex å­—èŠ‚ç è½¬æ¢æˆæœ¬åœ°æœºå™¨ä»£ç ï¼Œå¹¶å­˜å‚¨åœ¨è®¾å¤‡çš„å­˜å‚¨ç©ºé—´ä¸­ã€‚è¿™æ ·ï¼Œåœ¨ä¸‹æ¬¡æ‰“å¼€åº”ç”¨ç¨‹åºæ—¶ï¼Œå°±å¯ä»¥ç›´æ¥åŠ è½½å·²ç»ç¼–è¯‘å¥½çš„ä»£ç ï¼Œé¿å…äº†è§£é‡Šæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œä»è€Œæé«˜äº†åº”ç”¨ç¨‹åºçš„è¿è¡Œé€Ÿåº¦å’Œå“åº”æ—¶é—´ã€‚</p><p>æ­¤å¤–ï¼ŒART è¿˜æ”¯æŒ Just-In-Timeï¼ˆ JITï¼‰ç¼–è¯‘æŠ€æœ¯ï¼Œå¯ä»¥åœ¨åº”ç”¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¯¹é¢‘ç¹æ‰§è¡Œçš„ä»£ç è¿›è¡Œå®æ—¶ç¼–è¯‘ï¼Œè¿›ä¸€æ­¥æé«˜åº”ç”¨ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p><h2 id="1-6-Java-API-æ¡†æ¶"><a href="#1-6-Java-API-æ¡†æ¶" class="headerlink" title="1.6 Java API æ¡†æ¶"></a>1.6 Java API æ¡†æ¶</h2><p>Java API æ¡†æ¶å±‚æä¾›äº†è®¸å¤šAPIæ¥å£ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜å¼€å‘å„ç§åº”ç”¨ç¨‹åºã€‚è¿™äº›APIåŒ…æ‹¬äº†ï¼š</p><ul><li><strong>Content Provider</strong>ï¼šç”¨äºåº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æ•°æ®ã€‚</li><li><strong>View System</strong>ï¼šæ§åˆ¶UIç•Œé¢çš„æ¸²æŸ“å’Œäº¤äº’ã€‚</li><li><strong>Activity Manager</strong>ï¼šç®¡ç†å„ä¸ªActivityå’ŒTaskçš„ç»„ä»¶ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥åœ¨ä¸åŒçš„Activityä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚</li><li><strong>Location Manager</strong>ï¼šæä¾›åœ°ç†ä½ç½®åŠå®šä½åŠŸèƒ½æœåŠ¡ã€‚</li><li><strong>Package Manager</strong>ï¼šç®¡ç†æ‰€æœ‰å®‰è£…åœ¨Androidç³»ç»Ÿä¸­çš„åº”ç”¨ç¨‹åºã€‚</li><li><strong>Notification Manager</strong>ï¼šå¯è®©æ‰€æœ‰åº”ç”¨åœ¨çŠ¶æ€æ ä¸­æ˜¾ç¤ºè‡ªå®šä¹‰æé†’ã€‚</li><li><strong>Resource Manager</strong>ï¼šç”¨äºè®¿é—®éä»£ç èµ„æºï¼Œä¾‹å¦‚æœ¬åœ°åŒ–çš„å­—ç¬¦ä¸²ã€å›¾å½¢å’Œå¸ƒå±€æ–‡ä»¶ã€‚</li><li><strong>Telephony Manager</strong>ï¼šç®¡ç†æ‰€æœ‰çš„ç§»åŠ¨è®¾å¤‡åŠŸèƒ½ã€‚</li><li><strong>Window Manager</strong>ï¼šç®¡ç†æ‰€æœ‰çš„çª—å£ç¨‹åºã€‚</li></ul><h2 id="1-7-ç³»ç»Ÿåº”ç”¨"><a href="#1-7-ç³»ç»Ÿåº”ç”¨" class="headerlink" title="1.7 ç³»ç»Ÿåº”ç”¨"></a>1.7 ç³»ç»Ÿåº”ç”¨</h2><p>æœ€åä¸€ä¸ªå±‚æ¬¡æ˜¯ç³»ç»Ÿåº”ç”¨å±‚ï¼Œè¿™æ˜¯ç”¨æˆ·ç›´æ¥é¢å¯¹çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯Androidç³»ç»Ÿæœ€é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚ç³»ç»Ÿåº”ç”¨å±‚åŒ…æ‹¬äº†é€šè®¯å½•ã€çŸ­ä¿¡ã€ç”µè¯ã€ç›¸æœºã€æµè§ˆå™¨ç­‰å„ç§å¸¸è§åº”ç”¨ç¨‹åºã€‚æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½å¯ä»¥é€šè¿‡è°ƒç”¨ä¸Šé¢å‡ ä¸ªå±‚æ¬¡æä¾›çš„APIæ¥å£ï¼Œæ¥å®Œæˆè‡ªå·±çš„ä»»åŠ¡ã€‚</p><h1 id="äºŒã€æ€»ç»“"><a href="#äºŒã€æ€»ç»“" class="headerlink" title="äºŒã€æ€»ç»“"></a>äºŒã€æ€»ç»“</h1><p>ä»¥ä¸Šåªæ˜¯é™æ€åˆ†æäº†Androidç³»ç»Ÿæ¶æ„ï¼Œè™½ç„¶å¯ä»¥äº†è§£Androidæ¶æ„åœ°å±‚æ¬¡å’ŒåŠŸèƒ½ï¼Œä½†ä¸è¶³ä»¥äº†è§£Androidæ•´ä¸ªç³»ç»Ÿè¿è¡Œæ—¶å„å±‚æ¬¡ä¹‹é—´çš„ä¿¡æ¯ä¼ é€’å’Œäº¤äº’ï¼Œå³ä¸èƒ½çœŸæ­£çœ‹ç©¿Androidçš„è¿è¡Œæœºç†ï¼Œæ•…è¿˜éœ€è¿›ä¸€æ­¥å­¦ä¹ ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://developer.android.google.cn/guide/platform?hl=zh-cn">å¹³å°æ¶æ„  | Android å¼€å‘è€…  | Android Developers (google.cn)</a></p><p><a href="https://source.android.google.cn/docs/core/runtime?hl=zh-cn">Android Runtime (ART) å’Œ Dalvik  | Android å¼€æºé¡¹ç›®  | Android Open Source Project (google.cn)</a></p><p><a href="http://gityuan.com/android/">Android æ“ä½œç³»ç»Ÿæ¶æ„å¼€ç¯‡ - Gityuanåšå®¢ | è¢è¾‰è¾‰çš„æŠ€æœ¯åšå®¢</a></p><p><a href="https://blog.csdn.net/Gityuan/article/details/88779176">AndroidæŠ€æœ¯æ¶æ„æ¼”è¿›ä¸æœªæ¥_Gityuançš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://juejin.cn/post/7119763605620260894">Androidç³»ç»Ÿæ¶æ„åŠå…¶ç›¸å…³æ¨¡å—è¯´æ˜</a></p><p><a href="https://zhuanlan.zhihu.com/p/146863957">Dalvik å’Œ ART æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ·±æ‰’ Android è™šæ‹Ÿæœºå‘å±•å²ï¼ŒçœŸç›¸å´å‡ºä¹æ„æ–™ï¼ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BUUCTF-Reverseâ€”â€”Prombles Of Page Two</title>
    <link href="/2023/07/04/BUUCTF_Reverse_Prombles%20Of%20Page%20Two/"/>
    <url>/2023/07/04/BUUCTF_Reverse_Prombles%20Of%20Page%20Two/</url>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œå°±é™„ä¸Šé“¾æ¥ï¼š</p><p><a href="https://blog.csdn.net/qq_52193383/article/details/131529421?spm=1001.2014.3001.5501">BUUCTF-Reverse â€”â€” ç¬¬äºŒé¡µçš„é¢˜ç›®é›†åˆ_gal2xyçš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BUUCTF-Reverseâ€”â€”Prombles Of Page One</title>
    <link href="/2023/07/04/BUUCTF_Reverse_Prombles%20Of%20Page%20One/"/>
    <url>/2023/07/04/BUUCTF_Reverse_Prombles%20Of%20Page%20One/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å‡ ä¸ªæœˆè™½ç„¶æœ‰å†™åšå®¢ï¼Œä¸è¿‡å› ä¸ºå«Œéº»çƒ¦ä¸æƒ³å‘ï¼ˆæ–‡ç« ç§¯ç´¯å¤šäº†ï¼Œå›¾ç‰‡æ›´å¤šï¼Œå‘åˆ°githubåšå®¢ä¸Šè¿˜è¦åšä¸€äº›æ ¼å¼ä¸Šçš„å¤„ç†ï¼Œå°±è¿™æ ·è¶Šæ‹–è¶Šä¸æƒ³å‘åšå®¢ï¼‰ã€‚ä¸è¿‡æœ€è¿‘å‡ å¤©è¿˜æ˜¯æƒ³ç€å¤„ç†ä¸€ä¸‹ï¼Œä¸ç„¶åˆ°æ—¶å€™åšå®¢ç½‘ç«™çœŸè’åºŸäº†ï¼</p><p>BUUCTFçš„Reverseä¸“åŒºå› ä¸ºå›¾ç‰‡å¤ªå¤šï¼Œå°±å‘CSDNä¸Šäº†ï¼Œå› ä¸ºå¤„ç†èµ·æ¥æ¯”è¾ƒå®¹æ˜“ã€‚è¿™é‡Œå°±é™„ä¸Šé“¾æ¥ï¼š</p><p><a href="https://blog.csdn.net/qq_52193383/article/details/131528938?spm=1001.2014.3001.5501">BUUCTF-Reverse â€”â€” ç¬¬ä¸€é¡µçš„é¢˜ç›®é›†åˆ_gal2xyçš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022DASTFåæœˆèµ›</title>
    <link href="/2022/10/26/2022DASTF%E5%8D%81%E6%9C%88%E8%B5%9B/"/>
    <url>/2022/10/26/2022DASTF%E5%8D%81%E6%9C%88%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt1</span>(<span class="hljs-params">n</span>):<br>    n1 = <span class="hljs-built_in">hex</span>(n&gt;&gt;<span class="hljs-number">200</span>).encode()<br>    n2 = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(n))[<span class="hljs-number">20</span>:].encode()<br>    <span class="hljs-keyword">return</span> n1,n2<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt2</span>(<span class="hljs-params">m , n_1</span>):<br>    c_1 = <span class="hljs-built_in">pow</span>(m,e_1,n_1)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c_1 = &#x27;</span>+<span class="hljs-built_in">str</span>(c_1))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt3</span>(<span class="hljs-params">m , n_2</span>):<br>    c_2 = <span class="hljs-built_in">pow</span>( m , e_2 , n_2)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c_2 = &#x27;</span>+<span class="hljs-built_in">str</span>(c_2))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt4</span>(<span class="hljs-params">m</span>):<br>    k = getPrime(<span class="hljs-number">512</span>)<br>    m = m % k<br>    c_3 = <span class="hljs-built_in">pow</span>(m, e_2, n_3)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c_3 = &#x27;</span> + <span class="hljs-built_in">str</span>(c_3))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;m = &#x27;</span> + <span class="hljs-built_in">str</span>(m))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;k = &#x27;</span> + <span class="hljs-built_in">str</span>(k))<br><br>m1,m2 = encrypt1(flag)<br>m1 = bytes_to_long(m1)<br>m2 = bytes_to_long(m2)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n_2 = &#x27;</span> + <span class="hljs-built_in">str</span>(n_2))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n_3 = &#x27;</span> + <span class="hljs-built_in">str</span>(n_3))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;e_1 = &#x27;</span> + <span class="hljs-built_in">str</span>(e_1))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;e_2 = &#x27;</span> + <span class="hljs-built_in">str</span>(e_2))<br><br>encrypt2(m1,n_1)<br>encrypt3(n_1,n_2)<br>encrypt4(m2)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">n_2 = 675835056744450121024004008337170937331109883435712066354955474563267257037603081555653829598886559337325172694278764741403348512872239277008719548968016702852609803016353158454788807563316656327979897318887566108985783153878668451688372252234938716250621575338314779485058267785731636967957494369458211599823364746908763588582489400785865427060804408606617016267936273888743392372620816053927031794575978032607311497491069242347165424963308662091557862342478844612402720375931726316909635118113432836702120449010</span><br><span class="hljs-string">n_3 = 91294511667572917673898699346231897684542006136956966126836916292947639514392684487940336406038086150289315439796780158189004157494824987037667065310517044311794725172075653186677331434123198117797575528982908532086038107428540586044471407073066169603930082133459486076777574046803264038780927350142555712567</span><br><span class="hljs-string">e_1 = 65537</span><br><span class="hljs-string">e_2 = 3</span><br><span class="hljs-string">c_1 = 47029848959680138397125259006172340325269302342762903311733700258745280761154948381409328053449580957972265859283407071931484707002138926840483316880087281153554181290481533</span><br><span class="hljs-string">c_2 = 332431</span><br><span class="hljs-string">c_3 = 11951299411967534922967467740790967733301092706094553308467975774492025797106594440070380723007894861454249455013202734019215071856834943490096156048504952328784989777263664832098681831398770963056616417301705739505187754236801407014715780468333977293887519001724078504320344074325196167699818117367329779609</span><br><span class="hljs-string">m = 9530454742891231590945778054072843874837824815724564463369259282490619049557772650832818763768769359762168560563265763313176741847581931364</span><br><span class="hljs-string">k = 8139616873420730499092246564709331937498029453340099806219977060224838957080870950877930756958455278369862703151353509623205172658012437573652818022676431</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>è§£<code>m1</code>è¦å…ˆæ±‚å‡º<code>n_1</code>ï¼Œ<code>n_1</code>çš„åŠ å¯†ä¸ºä½æŒ‡æ•°åŠ å¯†ï¼Œçˆ†ç ´å¯ä»¥å¾—å‡º<code>n_1</code>ï¼Œyafuåˆ†è§£ç„¶åè§£å¯†<code>c_1</code>ã€‚</p><p><code>m2</code>éƒ¨åˆ†æ ¹æ®ä»£ç æœ‰å…¬å¼<br>$$<br>\begin{cases}<br>m_2 &#x3D; m + t*k\\<br>c_3 &#x3D; m^{e_2}\mod n_3<br>\end{cases}<br>&#x3D;&#x3D;&gt;c_3&#x3D;(m_2-t*k)^{e_2}\mod n_3<br>$$<br>äºæ˜¯åœ¨æ¨¡$n_3$çš„åŸŸä¸Šæ„é€ $f &#x3D; (m_2-t*k)^{e_2} - c_3$ ï¼Œè§£å‡º$t&#x3D;0$ï¼Œå³$m_2&#x3D;m$ã€‚</p><p>$m_1$ï¼Œ$m_2$è§£å‡ºæ¥çš„æœ‰é‡å éƒ¨åˆ†ï¼Œéœ€å»é™¤ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> hexlify,unhexlify<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> iroot,invert<br><br><span class="hljs-comment">#n_2æ˜¯å¶æ•°</span><br>n_2 = <span class="hljs-number">675835056744450121024004008337170937331109883435712066354955474563267257037603081555653829598886559337325172694278764741403348512872239277008719548968016702852609803016353158454788807563316656327979897318887566108985783153878668451688372252234938716250621575338314779485058267785731636967957494369458211599823364746908763588582489400785865427060804408606617016267936273888743392372620816053927031794575978032607311497491069242347165424963308662091557862342478844612402720375931726316909635118113432836702120449010</span><br>n_3 = <span class="hljs-number">91294511667572917673898699346231897684542006136956966126836916292947639514392684487940336406038086150289315439796780158189004157494824987037667065310517044311794725172075653186677331434123198117797575528982908532086038107428540586044471407073066169603930082133459486076777574046803264038780927350142555712567</span><br>e_1 = <span class="hljs-number">65537</span><br>e_2 = <span class="hljs-number">3</span><br>c_1 = <span class="hljs-number">47029848959680138397125259006172340325269302342762903311733700258745280761154948381409328053449580957972265859283407071931484707002138926840483316880087281153554181290481533</span><br>c_2 = <span class="hljs-number">332431</span><br>c_3 = <span class="hljs-number">11951299411967534922967467740790967733301092706094553308467975774492025797106594440070380723007894861454249455013202734019215071856834943490096156048504952328784989777263664832098681831398770963056616417301705739505187754236801407014715780468333977293887519001724078504320344074325196167699818117367329779609</span><br>m = <span class="hljs-number">9530454742891231590945778054072843874837824815724564463369259282490619049557772650832818763768769359762168560563265763313176741847581931364</span><br>k = <span class="hljs-number">8139616873420730499092246564709331937498029453340099806219977060224838957080870950877930756958455278369862703151353509623205172658012437573652818022676431</span><br><br><span class="hljs-comment">#ä½æŒ‡æ•°çˆ†ç ´</span><br>t = <span class="hljs-number">0</span><br>tmp = c_2<br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span>(iroot(tmp,<span class="hljs-number">3</span>)[<span class="hljs-number">1</span>]):<br>        n_1 = iroot(tmp,<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;n_1 = <span class="hljs-subst">&#123;n_1&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;t=<span class="hljs-subst">&#123;t&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">break</span><br>    tmp += n_2<br>    t += <span class="hljs-number">1</span><br><br><span class="hljs-comment">#yafu n_1</span><br>p = <span class="hljs-number">2224243981</span><br>q = <span class="hljs-number">2732337821</span><br>r = <span class="hljs-number">11585031296201346891716939633970482508158508580350404805965250133832632323150440185890235814142601827544669601048550999405490149435265122374459158586377571</span><br><br>phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)*(r-<span class="hljs-number">1</span>)<br>d = invert(e_1,phi)<br>m1 = <span class="hljs-built_in">pow</span>(c_1,d,n_1)<br><span class="hljs-comment"># print(long_to_bytes(m1))</span><br><span class="hljs-comment">#0x666c61677b3230366538353964</span><br>mm = <span class="hljs-number">0x666c61677b3230366538353964</span><br>flag1 = long_to_bytes(mm)<br><span class="hljs-built_in">print</span>(flag1)<br><span class="hljs-string">&#x27;&#x27;&#x27;sage</span><br><span class="hljs-string">n_3 = 91294511667572917673898699346231897684542006136956966126836916292947639514392684487940336406038086150289315439796780158189004157494824987037667065310517044311794725172075653186677331434123198117797575528982908532086038107428540586044471407073066169603930082133459486076777574046803264038780927350142555712567</span><br><span class="hljs-string">e_2 = 3</span><br><span class="hljs-string">c_3 = 11951299411967534922967467740790967733301092706094553308467975774492025797106594440070380723007894861454249455013202734019215071856834943490096156048504952328784989777263664832098681831398770963056616417301705739505187754236801407014715780468333977293887519001724078504320344074325196167699818117367329779609</span><br><span class="hljs-string">m = 9530454742891231590945778054072843874837824815724564463369259282490619049557772650832818763768769359762168560563265763313176741847581931364</span><br><span class="hljs-string">k = 8139616873420730499092246564709331937498029453340099806219977060224838957080870950877930756958455278369862703151353509623205172658012437573652818022676431</span><br><span class="hljs-string">p.&lt;x&gt; = PolynomialRing(Zmod(n_3))</span><br><span class="hljs-string">f= (m+x*k)^3 - c_3</span><br><span class="hljs-string">print(f.monic().small_roots())</span><br><span class="hljs-string"># [0]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">assert</span> m**<span class="hljs-number">3</span> % n_3 == c_3<br>flag2 = unhexlify(long_to_bytes(m))<br><span class="hljs-built_in">print</span>(flag2)<br><span class="hljs-comment">#æœ‰é‡å¤çš„å­—ç¬¦</span><br><span class="hljs-comment"># flag&#123;206e859d859d8e854c4f600cb12757bbf9f5&#125;</span><br><span class="hljs-comment"># DASCTF&#123;206e859d8e854c4f600cb12757bbf9f5&#125;</span><br></code></pre></td></tr></table></figure><h2 id="Proof-Yourself"><a href="#Proof-Yourself" class="headerlink" title="Proof_Yourself"></a>Proof_Yourself</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2 <span class="hljs-keyword">as</span> gy<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> functools<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> os<br><br>_N = gy.next_prime(<span class="hljs-number">2</span> ** <span class="hljs-number">512</span>)<br>_rand_int = functools.partial(random.SystemRandom().randint, <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Encryptor</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.priKey = <span class="hljs-literal">None</span><br>        self.r = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__gen_prime__</span>(<span class="hljs-params">self, rs, n_bits</span>):<br>        p = gy.mpz_urandomb(rs, n_bits)<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> gy.is_prime(p):<br>            p += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> p<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__key_gen__</span>(<span class="hljs-params">self, n_bits=<span class="hljs-number">512</span></span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            rs = gy.random_state(datetime.now().microsecond)<br>            p = self.__gen_prime__(rs, n_bits)<br>            q = self.__gen_prime__(rs, n_bits)<br>            n = p * q<br>            lmd = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> gy.gcd(n, lmd) == <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">break</span><br><br>        g = n + <span class="hljs-number">1</span><br>        mu = gy.invert(lmd, n)<br>        self.pubKey = [n, g]<br>        self.priKey = [lmd, mu]<br>        <span class="hljs-keyword">return</span> (self.pubKey, self.priKey)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encipher</span>(<span class="hljs-params">self, plaintext</span>):<br>        m = plaintext<br>        n, g = self.pubKey<br>        <span class="hljs-keyword">if</span> self.r <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            r = gy.mpz_random(gy.random_state(datetime.now().microsecond), n)<br>            <span class="hljs-keyword">while</span> gy.gcd(n, r) != <span class="hljs-number">1</span>:<br>                r += <span class="hljs-number">1</span><br>            self.r = r<br>        <span class="hljs-keyword">else</span>:<br>            r = self.r<br>        ciphertext = gy.powmod(g, m, n ** <span class="hljs-number">2</span>) * gy.powmod(r, n, n ** <span class="hljs-number">2</span>) % (n ** <span class="hljs-number">2</span>)<span class="hljs-comment">#PaillieråŒæ€åŠ å¯†</span><br>        <span class="hljs-keyword">return</span> ciphertext<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decipher</span>(<span class="hljs-params">self, ciphertext</span>):<br>        <span class="hljs-comment"># The decryption process is hidden</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0xffffffff</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Proof</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.proof_param = <span class="hljs-literal">None</span><br>        self.pre_param = <span class="hljs-literal">None</span><br>        self.d = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params">self, pk, c1, c2, c3, m1, m2, r1, r2, r3</span>):<br>        self.pubKey = pk<br>        self.proof_param = [c1, c2, c3, m1, m2, r1, r2, r3]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pre_work_verify</span>(<span class="hljs-params">self</span>):<br>        c1, c2, c3, m1, m2, r1, r2, r3 = self.proof_param<br>        m4 = gy.mpz_random(gy.random_state(datetime.now().microsecond), self.pubKey[<span class="hljs-number">0</span>])<br>        pai = Encryptor()<br>        pai.pubKey = self.pubKey<br>        c4 = pai.encipher(m4)<br>        r4 = pai.r<br>        pai.r = <span class="hljs-literal">None</span> <span class="hljs-comment">#ç„¶åä¼šé‡æ–°ç”Ÿæˆr</span><br><br>        c5 = pai.encipher(m2 * m4)<br>        r5 = pai.r<br>        pai.r = <span class="hljs-literal">None</span><br><br>        self.pre_param = [c4, m4, r4, c5, r5]<br>        <span class="hljs-keyword">return</span> c4, c5<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_d</span>(<span class="hljs-params">self, d</span>):<br>        self.d = d<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">self</span>):<br>        n_2q = self.pubKey[<span class="hljs-number">0</span>] ** <span class="hljs-number">2</span><br>        c1, c2, c3, m1, m2, r1, r2, r3 = self.proof_param<br>        c4, m4, r4, c5, r5 = self.pre_param<br>        d = self.d<br><br>        e = d * m1 + m4<br>        a1 = <span class="hljs-built_in">pow</span>(r1, d, n_2q) * r4 % n_2q<br>        b1 = r5 * <span class="hljs-built_in">pow</span>(r3, d, n_2q) % n_2q<br>        a2 = <span class="hljs-built_in">pow</span>(r2, e, n_2q) * gy.invert(b1, n_2q) % n_2q<br>        b2 = <span class="hljs-built_in">pow</span>(c3, d, n_2q) * c5 % n_2q<br><br>        enc = Encryptor()<br>        enc.pubKey = self.pubKey<br>        enc.r = <span class="hljs-built_in">pow</span>(r1, d, n_2q) * r4 % n_2q<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">pow</span>(c1, d, n_2q) * c4 % n_2q != enc.encipher(d * m1 + m4): <span class="hljs-comment"># è¿™é‡Œè¦ ==</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        enc.r = a2<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(c2, e, n_2q) * gy.invert(b2, n_2q) % n_2q == enc.encipher(<span class="hljs-number">0</span>) <span class="hljs-comment">#å¿…é¡»ä»è¿™é‡Œè¿”å›ï¼Œä¸”ä¸ºTrue</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MProof</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.priKey = <span class="hljs-literal">None</span><br>        self.cs = <span class="hljs-literal">None</span><br>        self.rs = <span class="hljs-literal">None</span><br>        self.k = <span class="hljs-literal">None</span><br>        self.t = <span class="hljs-number">9</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_param</span>(<span class="hljs-params">self, pk, cs, rs, k</span>):<br>        self.pubKey = pk[<span class="hljs-number">0</span>]<br>        self.priKey = pk[<span class="hljs-number">1</span>]<br>        self.cs = cs<br>        self.rs = rs<br>        self.k = k<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">self, d</span>):<br>        enc = Encryptor()<br>        enc.pubKey = self.pubKey<br>        enc.priKey = self.priKey<br>        cs = self.cs<br>        rs = self.rs<br>        k = self.k<br>        t = self.t<br>        <span class="hljs-keyword">assert</span> k == enc.decipher(cs[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, t - <span class="hljs-number">1</span>):<br>            c1 = cs[<span class="hljs-number">0</span>]<br>            c2 = cs[i - <span class="hljs-number">1</span>]<br>            c3 = cs[i]<br>            m2 = enc.decipher(cs[i - <span class="hljs-number">1</span>])<br>            r1 = rs[<span class="hljs-number">0</span>]<br>            r2 = rs[i - <span class="hljs-number">1</span>]<br>            r3 = rs[i]<br><br>            proof = Proof()<br>            proof.setup(self.pubKey, c1, c2, c3, k, m2, r1, r2, r3)<br><br>            proof.pre_work_verify()<br>            proof.set_d(d)<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> proof.verify(): <span class="hljs-comment"># è¿™é‡Œè¦è¿”å›True</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    flag = os.environ[<span class="hljs-string">&quot;flag for GFCTF2022-Crypto Proof Yourself&quot;</span>]<br>    k = _rand_int(_N - <span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;k: &quot;</span>, k)<br>    d = _rand_int(_N - <span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;d: &quot;</span>, d)<br>    param = <span class="hljs-built_in">eval</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;please proof yourself: &quot;</span>))<br><br>    cs = param[<span class="hljs-string">&#x27;cs&#x27;</span>]<br>    rs = param[<span class="hljs-string">&#x27;rs&#x27;</span>]<br>    pk = param[<span class="hljs-string">&#x27;pk&#x27;</span>]<br><br>    <span class="hljs-built_in">print</span>(pk[<span class="hljs-number">0</span>])<br>    <span class="hljs-built_in">print</span>(rs)<br>    mp = MProof()<br>    mp.generate_param(pk, cs, rs, k)<br>    <span class="hljs-keyword">if</span> mp.verify(d):<br>        s = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cs:<br>            s *= i<br>            s %= _N<br>        aes = AES.new(<span class="hljs-built_in">str</span>(s)[:<span class="hljs-number">32</span>].encode(), AES.MODE_ECB)<br>        flag = flag.encode()<br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(flag) % AES.block_size != <span class="hljs-number">0</span>:<br>            flag += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>        c = aes.encrypt(flag)<br>        c = base64.b64encode(c)<br>        <span class="hljs-built_in">print</span>(c)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;you&#x27;re not yourself!&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br><br></code></pre></td></tr></table></figure><ul><li><p>MProofç±»ä¸­çš„verify()éƒ¨åˆ†</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">k</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> enc.decipher(cs[<span class="hljs-number">0</span>])<br><span class="hljs-attribute">m2</span> <span class="hljs-operator">=</span> enc.decipher(cs[i - <span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure><p>è¯´æ˜ $k(m_1)$ ä¸ $c_1(cs[0])$æ˜¯ä¸€ç»„æ˜å¯†æ–‡ï¼Œ$m_2$ ä¸ $c_2(cs[i-1])$æ˜¯ä¸€ç»„æ˜å¯†æ–‡ã€‚</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-built_in">proof</span>.pre_work_verify()<br></code></pre></td></tr></table></figure><p>è¯´æ˜$c_4,m_4,r_4$æ˜¯ä¸€ç»„ï¼Œ$c_5,m_2*m_4$æ˜¯ä¸€ç»„ã€‚</p></li><li><p>Proofç±»ä¸­çš„verify()éƒ¨åˆ†</p><p>å°±æ˜¯ä¸€å †å…¬å¼ç„¶åä¸æ–­åŒ–ç®€ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®verifyè¿”å›çš„å€¼å¿…é¡»æ˜¯Trueï¼Œä¹Ÿå°±æ˜¯ä»æœ€åä¸€ä¸ªreturnè¿”å›ï¼Œæ‰€ä»¥ä»¥ä¸‹ä¸¤ä¸ªç­‰å¼æˆç«‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">â‘  <span class="hljs-built_in">pow</span>(c1, d, n_2q) * c4 % n_2q == enc.encipher(d * m1 + m4)<br>â‘¡ <span class="hljs-built_in">pow</span>(c2, e, n_2q) * gy.invert(b2, n_2q) % n_2q == enc.encipher(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p>æ ¹æ®ä»£ç æœ‰ä»¥ä¸‹å…¬å¼<br>$$<br>\begin{cases}<br>\quad e &#x3D; d*m_1+m_4\\<br>\quad a_1 &#x3D; r_1^d*r_4 \% n^2\\<br>\quad b_1 &#x3D; r_5*r_3^d \% n^2\\<br>\quad a_2 &#x3D; r_2^e*b_1^{-1} \% n^2\\<br>\quad b_2 &#x3D; c_3^d*c_5 \% n^2\\<br>\quad r &#x3D; r_1^d*r_4 \% n^2(åœ¨â‘ ä¸­)\\<br>\quad r &#x3D; r_2^e*b_1^{-1} \% n^2(åœ¨â‘¡ä¸­)<br>\end{cases}<br>$$<br>å¯¹â‘ è¿›è¡ŒåŒ–ç®€ï¼Œæœ‰<br>$$<br>\begin{align}<br>c_1^d*c_4 &amp;â‰¡ g^{d*m_1+m_4}*r^n \mod n^2\\<br>c_1^d*c_4 &amp;â‰¡ g^{d*m_1}*g^{m_4}*r_1^{d*n}*r_4^n \mod n^2\\<br>c_1^d &amp;â‰¡ g^{d*m_1}*r_1^{d*n} \mod n^2\\<br>c_1 &amp;â‰¡ g^{m_1}*r_1^n \mod n^2\<br>\end{align}<br>$$<br>å› ä¸ºä¸å¯èƒ½ä»è¿™é‡Œè¿”å›Falseï¼Œæ‰€ä»¥$c_1,m_1,r_1$æ˜¯ä¸€ç»„ã€‚</p><p>å¯¹â‘¡è¿›è¡ŒåŒ–ç®€ï¼Œæœ‰<br>$$<br>\begin{align}<br>c_2^e*b_2^{-1}&amp;â‰¡r^n \mod n^2\\<br>c_2^e*b_2^{-1} &amp;â‰¡ r_2^{e*n}*b_1^{-n} \mod n^2\\<br>c_2^{e}*b_1^n&amp;â‰¡r_2^{e*n}*b_2 \mod n^2\\<br>c_2^{e}*r_5^n*r_3^{d*n}&amp;â‰¡r_2^{e*n}*c_3^d*c_5 \mod n^2\\<br>c_2^e*(g^{m_2*m_4}*r_5^n)*r_3^{d*n} &amp;â‰¡ r_2^{e*n}*c_3^d*c_5*g^{m_2*m_4} \mod n^2\\<br>c_2^e*r_3^{d*n} &amp;â‰¡ r_2^{e*n}*c_3^d*g^{m_2*m_4} \mod n^2\\<br>g^{e*m_2}*(c_2^e)*(g^{m_3*d}*r_3^{d*n})&amp;â‰¡(g^{e*m_2}*r_2^{e*n})*(c_3^d)*g^{m_3*d}*g^{m_2*m_4} \mod n^2\\<br>g^{e*m_2}*(c_2^e)*(g^{m_3}*r_3^n)^d&amp;â‰¡(g^{m_2}*r_2^n)^e*(c_3^d)*g^{m_3*d+m_2*m_4}\mod n^2<br>\end{align}<br>$$<br>å› ä¸ºæ˜¯PaillieråŒæ€åŠ å¯†ï¼Œè¦ä½¿å¾—â‘¡æˆç«‹ï¼Œææœ‰å¯èƒ½æ˜¯$m_2,c_2,r_2$å’Œ$m_3,c_3,r_3$åˆ†åˆ«ä¸ºä¸€ç»„ã€‚æ•…<br>$$<br>\begin{align}<br>g^{e*m_2}&amp;â‰¡g^{m_3*d+m_2*m_4}\mod n^2\\<br>e*m_2 &amp;â‰¡ m_3*d+m_2*m_4\mod Ï†(n^2)\\<br>m_1*m_2&amp;â‰¡m_3\mod Ï†(n^2)<br>\end{align}<br>$$<br>å› ä¸ºæˆ‘ä»¬è¦æ±‚$c_i(å³cs[i])$ï¼Œæ‰€ä»¥å°†ä¸Šè¿°ç­‰å¼è½¬æ¢ä¸º<br>$$<br>\begin{align}<br>m_1*m_2&amp;â‰¡m_3\mod Ï†(n^2)\\<br>g^{m_1*m_2} &amp;â‰¡ g^{m_3} \mod n^2\\<br>c_3 &amp;â‰¡ g^{m_1*m_2}*r_3^n \mod n^2\\<br>cs_i &amp;â‰¡ g^{m_0*m_{i-1}}*r_i^n \mod n^2 \quad,iâˆˆ[1,t-1](è½¬æ¢æˆè·Ÿcs_iå¯¹åº”çš„ä¸‹æ ‡)<br>\end{align}<br>$$<br>å‰é¢çš„ç­‰å¼â‘ çš„æ¨å¯¼å·²ç»å¾—åˆ°äº†$cs_0$çš„åŠ å¯†å…¬å¼ä¸º<br>$$<br>cs_0 â‰¡ g^{m_0}*r_0^n\mod n^2<br>$$<br>ç„¶åæ ¹æ®MProof.verify()ä¸­çš„forå¾ªç¯ï¼Œæœ‰<br>$$<br>\begin{align}<br>i&#x3D;1æ—¶,æœ‰m_1&amp;&#x3D;m_0*m_0&#x3D;k^2\\<br>i&#x3D;2æ—¶,æœ‰m_2&amp;&#x3D;m_0*m_1&#x3D;k^3\\â€¦<br>\end{align}<br>$$<br>è€Œ$m_0 &#x3D; k$ï¼Œæ•…$m_i &#x3D; k^{(i+1)}$ï¼Œ$iâˆˆ[0,t-1]$ã€‚æ•…æ±‚$cs_iå’Œcs_0$çš„å…¬å¼å¯åˆå¹¶ä¸º<br>$$<br>cs_i â‰¡ g^{k^{(i+1)}}*r_i^n \mod n^2 \quad,iâˆˆ[0,t-1]<br>$$</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> gmpy2<br><br>t = <span class="hljs-number">9</span><br>k = <span class="hljs-number">11279504534075664648994853756208309836888259081316987836068134565254532996039360827546417609514423428910384542842117375028420780633866653159695275393368525</span><br>d = <span class="hljs-number">10221665185656075870670995630062725196664430105025904882602057721789662854574978018794504264934209067929011475979200882531626936657436063908347321906634698</span><br>n, g = pk = [<span class="hljs-number">48818225666351727287207574448645102762537417687444983843100304919285725062598967011116889972414214836241381602471131430626879759533369143920487299838261148460925610689261484965443528954172944323770181595455493018560585886136460076911284321702606299935385905187490733877700172236929823996030434548431963845417</span>, <span class="hljs-number">48818225666351727287207574448645102762537417687444983843100304919285725062598967011116889972414214836241381602471131430626879759533369143920487299838261148460925610689261484965443528954172944323770181595455493018560585886136460076911284321702606299935385905187490733877700172236929823996030434548431963845418</span>]<br>rs = [<span class="hljs-number">7017835444643249654271082822123622319668823350427792339866057586668389112104752762656197513200543360993520983724957230042201508973227162755834455588213955577427129770220944523362675094151087610149577572745132843096125306714661937578722687485657829513505193501779196974947234280267216675125252078851200384511</span>, <span class="hljs-number">11926419785881734844311665235521692826579887231998046623960612782040667947241499738956574205257924912658501445776452678070116549164041547529876699253294424780763676555577471679864402445858336882095147665188840642566915806261768356998922735189200720213585973193760859762565499482788728104626011895319246070666</span>, <span class="hljs-number">42849056994192303821377400100288133996583852078950720125488290595760149056455393645072193770289570081775019724341661792638180771853532605128714550478335577195726229688940314874397525687446284173037582151644404387768530054222357908795147990398041926171515316417608763369700129500666902309717940977358807727525</span>, <span class="hljs-number">569456034348887900543839220414996643340590767934767190156995758515165897120739581783360541347732807472270912131379832279120488198273011491688831841399829273608264595546111772893429063435258947915507670361144515456182164834954215193382047579447153761545329658264080907041640135001986168270265476743567482692</span>, <span class="hljs-number">3882702856238247498776796661311784006527802920550510293689922477675526354665322642479849874736259591551374176143098918760791897417239069537473431992448934909453262242143947844529634470612342500819944459175262578570970986439077317400529787443727039336276584314877540411569781766947088676007567558786204756622</span>, <span class="hljs-number">34782235652997768305926510863494232383450368915240504241174297907018847182768375070693257841105403770877838315164696945795337955510221866283665914601590428884905858716454103802020812133141150426745257298797890891272342044576267512614330845263269719988690131903885166576787904418689220619969803389055644879283</span>, <span class="hljs-number">41592967491176047854989428284345162501007190601227408901070248204262133730525966700579489348638677097892234799114781714483501047161590906530561145043956218048476973681993844049727301616425300184917461748554561251157129032137452031152035104390819324726028213814331358281835310137578997975640720667608761964678</span>, <span class="hljs-number">2578609445428238934369429276761562264275224240462388961086309951471476260768389780485799474959219453117497280460546287104687546269870223859389440049894002336889078632572487931627548008400365190508858547984095575105551066221392543458691134989381950316158817283668533035090342510306180189918351739923749743570</span>]<br><span class="hljs-comment">#len(rs) = 8</span><br>_N = gmpy2.next_prime(<span class="hljs-number">2</span> ** <span class="hljs-number">512</span>)<br>c = <span class="hljs-string">b&#x27;Oq5bkAPCCT6W3CskX+2uqtY5wrhs+2DqupzjIJ0u/Yl0m/Ig1/uvrSWdezrqLxHG&#x27;</span><br><br>cs = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rs))]<br>n_2 = n**<span class="hljs-number">2</span><br><span class="hljs-comment"># cs[0] = pow(g, k, n_2)*pow(rs[0], n, n_2) % n_2</span><br>m_list = [k**(i+<span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rs))]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rs)):<br>    cs[i] = <span class="hljs-built_in">pow</span>(g, m_list[i], n_2)*<span class="hljs-built_in">pow</span>(rs[i], n, n_2) % n_2<br><br>s = <span class="hljs-number">1</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cs:<br>    s *= i<br>    s %= _N<br>aes = AES.new(<span class="hljs-built_in">str</span>(s)[:<span class="hljs-number">32</span>].encode(), AES.MODE_ECB)<br>c = base64.b64decode(c)<br>flag = aes.decrypt(c)<br><span class="hljs-built_in">print</span>(flag)<br><br></code></pre></td></tr></table></figure><h2 id="Recover-Secret"><a href="#Recover-Secret" class="headerlink" title="Recover_Secret"></a>Recover_Secret</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2 <span class="hljs-keyword">as</span> gy<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> functools<br><span class="hljs-keyword">import</span> libnum<br><span class="hljs-keyword">from</span> Crypto.Util <span class="hljs-keyword">import</span> number<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><br>of = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;output&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br>sys.stdout = of<br>_N = gy.next_prime(<span class="hljs-number">2</span> ** <span class="hljs-number">512</span>)<br>_rand_int = functools.partial(random.SystemRandom().randint, <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Encryptor</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.priKey = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__gen_prime__</span>(<span class="hljs-params">self, rs, n_bits</span>):<br>        p = gy.mpz_urandomb(rs, n_bits)<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> gy.is_prime(p):<br>            p += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> p<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__key_gen__</span>(<span class="hljs-params">self, n_bits=<span class="hljs-number">512</span></span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            rs = gy.random_state(datetime.now().microsecond)<br>            p = self.__gen_prime__(rs, n_bits)<br>            q = self.__gen_prime__(rs, n_bits)<br>            n = p * q<br>            lmd = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> gy.gcd(n, lmd) == <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">break</span><br><br>        g = n + <span class="hljs-number">1</span><br>        mu = gy.invert(lmd, n)<br>        self.pubKey = [n, g]<br>        self.priKey = [lmd, mu]<br>        <span class="hljs-keyword">return</span> (self.pubKey, self.priKey)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encipher</span>(<span class="hljs-params">self, plaintext</span>):<br>        m = plaintext<br>        n, g = self.pubKey<br>        r = gy.mpz_random(gy.random_state(datetime.now().microsecond), n)<br>        <span class="hljs-keyword">while</span> gy.gcd(n, r) != <span class="hljs-number">1</span>:<br>            r += <span class="hljs-number">1</span><br>        ciphertext = gy.powmod(g, m, n ** <span class="hljs-number">2</span>) * gy.powmod(r, n, n ** <span class="hljs-number">2</span>) % (n ** <span class="hljs-number">2</span>) <span class="hljs-comment">#PaillieråŒæ€åŠ å¯†</span><br>        <span class="hljs-keyword">return</span> ciphertext<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Commit</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.param = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__key_gen__</span>(<span class="hljs-params">self, n</span>): <span class="hljs-comment"># å‚æ•°nç›¸åŒï¼Œåˆ™äº§ç”Ÿçš„q,g,hç›¸åŒ</span><br>        p = n<br>        r = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            q = r * p + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> gy.is_prime(q):<br>                <span class="hljs-keyword">break</span><br>            r += <span class="hljs-number">1</span><br>        x = q - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            g = x ** r % q<br>            <span class="hljs-keyword">if</span> g != <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">break</span><br>            x -= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            h = x ** r % q<br>            <span class="hljs-keyword">if</span>(g != h <span class="hljs-keyword">and</span> h != <span class="hljs-number">1</span>):<br>                <span class="hljs-keyword">break</span><br>            x -= <span class="hljs-number">1</span><br>        self.param = q, g, h<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">commit</span>(<span class="hljs-params">self, m</span>):<br>        q, g, h = self.param<br>        r = number.getRandomRange(<span class="hljs-number">1</span>, q - <span class="hljs-number">1</span>)<br>        c = (<span class="hljs-built_in">pow</span>(g, m, q) * <span class="hljs-built_in">pow</span>(h, r, q)) % q <span class="hljs-comment">#BenalohåŠ å¯†</span><br>        <span class="hljs-keyword">return</span> c, r<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">shuffle</span>(<span class="hljs-params">X, Y, x</span>):<br>    res = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(X)):<br>        res.append([i, X[i], Y[i]])<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(x):<br>            res.append([i, X[i] + random.randint(-X[i], X[i]), Y[i] + random.randint(-Y[i], Y[i])])<br>    random.shuffle(res) <span class="hljs-comment">#éšæœºæ’åº</span><br>    <span class="hljs-keyword">return</span> res<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    k = <span class="hljs-number">6</span><br>    sk = []<br>    flag = os.environ[<span class="hljs-string">&quot;flag for GFCTF2022-Crypto Recover Secret&quot;</span>]<br>    secret = libnum.s2n(flag)<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">bin</span>(secret)) &lt; <span class="hljs-number">514</span><br>    enc = Encryptor()<br>    sk = [enc.__key_gen__() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k)]<br>    <span class="hljs-built_in">print</span>(sk)<br><br>    s = [_rand_int(_N - <span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k)]<br>    s[<span class="hljs-number">0</span>] = secret<br><br>    v = Commit()<br>    v.__key_gen__(_N)<br>    <span class="hljs-built_in">print</span>(v.param)<br>    cr = [v.commit(s[i]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k)]<br>    c = [i[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cr]<br>    <span class="hljs-built_in">print</span>(c)<br><br>    X = []<br>    Y = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, k + <span class="hljs-number">1</span>):<br>        xs = <span class="hljs-number">1</span><br>        enc.pubKey = sk[i - <span class="hljs-number">1</span>][<span class="hljs-number">0</span>]  <span class="hljs-comment"># [n_i,g_i]</span><br>        n_2q = enc.pubKey[<span class="hljs-number">0</span>] ** <span class="hljs-number">2</span>  <span class="hljs-comment"># n_i^2</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>            xs *= <span class="hljs-built_in">pow</span>(enc.encipher(i ** j), cr[j][<span class="hljs-number">1</span>], n_2q)<br>        X.append(xs)<br><br>        ys = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>            ys *= <span class="hljs-built_in">pow</span>(enc.encipher(i ** j), s[j], n_2q)<br>        Y.append(ys)<br><br>    X_Y = shuffle(X, Y, <span class="hljs-number">51</span>)<br>    <span class="hljs-built_in">print</span>(X_Y)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>ç±»Encryptoræ˜¯PaillieråŒæ€åŠ å¯†ï¼Œç±»Commitè²Œä¼¼æ˜¯BenalohåŠ å¯†ã€‚</p><p>é‡ç‚¹åœ¨Xã€Yçš„ç”Ÿæˆä»¥åŠshuffleæ··æ·†ï¼Œå…ˆçœ‹Xã€Yçš„ç”Ÿæˆï¼Œä»–ä»¬çš„ç”Ÿæˆå…¬å¼ç±»ä¼¼ï¼Œä¸º<br>$$<br>xs_i &#x3D; E(i^0,r_0)^{cr_0}*E(i^1,r_1)^{cr_1}*â€¦*E(i^5,r_5)^{cr_5}\mod n_i^2 \tag{1}<br>$$</p><p>$$<br>ys_i &#x3D; E(i^0,r_0)^{s_0}*E(i^1,r_1)^{s_1}*â€¦*E(i^5,r_5)^{s_5}\mod n_i^2 \tag{2}<br>$$</p><p>ï¼ˆè¿™é‡Œçš„$cr$æŒ‡$cr$ä¸­çš„$r$ã€‚ï¼‰</p><p>æ ¹æ®PaillieråŒæ€åŠ å¯†çš„ç‰¹ç‚¹ï¼Œæœ‰<br>$$<br>D(E(m_1,r_1),E(m_2,r_2)\mod n^2) &#x3D; m_1+m_2\mod n<br>$$</p><p>$$<br>D(E(m_1,r_1)^k\mod n^2)&#x3D;k*m\mod n<br>$$</p><p>äºæ˜¯å…¬å¼(1)(2)çš„è§£å¯†å…¬å¼ä¸º<br>$$<br>D(xs_i) &#x3D; cr_0*i^0+â€¦+cr_5*i^5 \mod n_i<br>$$</p><p>$$<br>D(ys_i) &#x3D; s_0*i^0+â€¦+s_5*i^5 \mod n_i<br>$$</p><p>å› ä¸º$xs,ys$éƒ½æœ‰6ä¸ªï¼Œè€Œç³»æ•°å·²çŸ¥ï¼Œæ‰€ä»¥å¯ä»¥æ„å»ºçŸ©é˜µæ–¹ç¨‹è§£å‡º$cr_i,s_i$ã€‚</p><p>ä½†æ˜¯$X,Y$è¢«æ‰“ä¹±äº†é¡ºåºã€‚</p><p>æ ¹æ®commit()å‡½æ•°ï¼Œæœ‰<br>$$<br>c_i &#x3D; g^{s_i}*h^{cr_i}<br>$$<br>è¿›è¡Œå¦‚ä¸‹è½¬æ¢<br>$$<br>c_0 &#x3D; g^{s_0}*h^{cr_0}ï¼Œc_1^i &#x3D; g^{s_1*i}*h^{cr_1*i},c_2^{i^2} &#x3D; g^{s_2*i^2}*h^{cr_2*i^2},â€¦\<br>$$<br>äºæ˜¯æœ‰<br>$$<br>\begin{align}<br>c_0*c_1^i*c_2^{i^2}*â€¦*c_5^{i^5}<br>&amp;&#x3D; g^{s_0+s_1*i+s_2*i^2+â€¦+s_5*i^5}*h^{cr_0+c_r1*i+cr_2*i^2+â€¦+cr_5*i^5}\\<br>&amp;&#x3D;g^{D(ys_i)}*h^{D(xs_i)}\mod q<br>\end{align}<br>$$<br>å› æ­¤é€šè¿‡æ­¤ç­‰å¼å¯å¾—åˆ°æ­£ç¡®çš„$X,Y$ã€‚</p><p>æ±‚å‡º$Y$åï¼Œå› ä¸ºæœ‰å…­ä¸ªæœªçŸ¥æ•°å’Œå…­ä¸ªæ–¹ç¨‹ï¼Œæ‰€ä»¥å»ºä¸ªçŸ©é˜µæ±‚è§£<br>$$<br>{\left[<br>\matrix{<br>  s_0 &amp; s_1 &amp; â€¦ &amp; s_5<br>}<br>\right]}<br>*<br>\left[<br>\matrix{<br>  1^0 &amp; 2^0 &amp; â€¦ &amp; 5^0\\<br>  1^1 &amp; 2^1 &amp; â€¦ &amp; 5^1\\<br>  â€¦\\<br>  1^6 &amp; 2^6 &amp; â€¦ &amp; 5^6<br>}<br>\right]<br>&#x3D;\left[<br>\matrix{<br>  dec\_y_0 &amp; dec\_y_1 &amp; â€¦ &amp; dec\_y_5<br>}<br>\right]<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> mpz,next_prime<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Encryptor</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.pubKey = <span class="hljs-literal">None</span><br>        self.priKey = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decipher</span>(<span class="hljs-params">self, ciphertext</span>):<br>        n, g = self.pubKey<br>        lmd, mu = self.priKey<br>        plaintext = (<span class="hljs-built_in">pow</span>(ciphertext, lmd, n**<span class="hljs-number">2</span>) - <span class="hljs-number">1</span>)*mu//n % n <span class="hljs-comment"># PaillieråŒæ€è§£å¯†</span><br>        <span class="hljs-comment"># plaintext = (pow(ciphertext, lmd, n ** 2) - 1) // n  * mu % n</span><br>        <span class="hljs-keyword">return</span> plaintext<br><br><br>_N = next_prime(<span class="hljs-number">2</span> ** <span class="hljs-number">512</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;output&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    sk = <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    vparam = <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    c = <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    X_Y = <span class="hljs-built_in">eval</span>(f.readline().decode())<br><br>X_Y = <span class="hljs-built_in">sorted</span>(X_Y, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])<br>k = <span class="hljs-number">6</span><br>q, g, h = vparam<br><br><br>m_cs = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, k + <span class="hljs-number">1</span>):<br>    cs = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>        cs = cs * <span class="hljs-built_in">pow</span>(c[j], i**j, q) % q <span class="hljs-comment">#é”™è¯¯æ“ä½œ-&gt; cs *= pow(c[j], i**j, q) % q å–ä½™åœ¨ç›¸ä¹˜</span><br>    m_cs.append(cs)<br><br><br>real_XY = []<br>enc = Encryptor()<br><span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> X_Y:<br>    i = each[<span class="hljs-number">0</span>]<br>    enc.pubKey = sk[i][<span class="hljs-number">0</span>]<br>    enc.priKey = sk[i][<span class="hljs-number">1</span>]<br>    de_xs = enc.decipher(each[<span class="hljs-number">1</span>])<br>    de_ys = enc.decipher(each[<span class="hljs-number">2</span>])<br>    gh = <span class="hljs-built_in">pow</span>(g, de_ys, q)*<span class="hljs-built_in">pow</span>(h, de_xs, q) % q<br>    <span class="hljs-keyword">if</span> gh == m_cs[i]:<br>        real_XY.append([i, de_xs, de_ys])<br><br><span class="hljs-comment"># print(real_XY)</span><br>k = <span class="hljs-number">6</span><br>Y = [<span class="hljs-built_in">int</span>(each[<span class="hljs-number">2</span>]) <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> real_XY]<br>Y = Matrix(Y)<br><br>A = []<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>    v = [i**j <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,k+<span class="hljs-number">1</span>)]<br>    A.append(v)<br>A = Matrix(A)<br><br>S = A.solve_left(Y)<br><span class="hljs-built_in">print</span>(S)<br><span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-built_in">int</span>(S[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>])))<br><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzU1MzE3Njg2Mw==&mid=2247502987&idx=1&sn=39df1e5a1638db91f716f975fbeb69c1&chksm=fbf456fbcc83dfedf587a21112de8e6fae17942e848974c5eafd827ab94af9d65aa87bef424b&mpshare=1&scene=23&srcid=1025Lu8HWtUrWliFNcbdKzJS&sharer_sharetime=1666670305035&sharer_shareid=c677d9dd25d4fd3a57ca8bd9a85e6569#rd">DASCTF X GFCTF 2022 ï½œåæœˆèµ›å®˜æ–¹Write Up (qq.com)</a></p><p><a href="https://lazzzaro.github.io/2020/05/13/crypto-%E5%85%B6%E4%BB%96%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/#Paillier%E5%90%8C%E6%80%81%E5%8A%A0%E5%AF%86">å…¶ä»–åŠ å¯†ç®—æ³• | Lazzaro (lazzzaro.github.io)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä½æŒ‡æ•°çˆ†ç ´</tag>
      
      <tag>Paillier</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022èµ£è‚²æ¯</title>
    <link href="/2022/10/24/2022%E8%B5%A3%E8%82%B2%E6%9D%AF/"/>
    <url>/2022/10/24/2022%E8%B5%A3%E8%82%B2%E6%9D%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="Wilson"><a href="#Wilson" class="headerlink" title="Wilson"></a>Wilson</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> urandom<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> next_prime<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> getPrime, bytes_to_long<br><br>p = getPrime(<span class="hljs-number">512</span>)<br>q = next_prime(p)<br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>)<br>flag = bytes_to_long(f.read() + urandom(<span class="hljs-number">80</span>))<br>f.close()<br><br>N = <span class="hljs-number">1</span><br>a = p * q<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, p):<br>    N = (N * i) % a<br>e = <span class="hljs-number">65537</span><br>m = N * flag % a<br>c = <span class="hljs-built_in">pow</span>(m, e, a)<br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;Encode.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>f.write(<span class="hljs-string">f&#x27;a = <span class="hljs-subst">&#123;a&#125;</span>\n&#x27;</span>)<br>f.write(<span class="hljs-string">f&#x27;c = <span class="hljs-subst">&#123;c&#125;</span>\n&#x27;</span>)<br>f.close()<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">a = 156853895847604116708242664263151514811095704969640303272039451331791888050995073274981545693518063639560286348739938318495685137088495867703518198511200409009953879436648706837731243061114851474801565873584183542649886358523850682697732574913523360866915083642887238043256280849100274825940626065115676325169</span><br><span class="hljs-string">c = 3459715117165130065996389169943285249501133832272446001239391765859259811270526185228996906338576254353123756173289118671028939933226544773197852424767051933844004667155191851195814295922794480300237399956789038592856532530692732011427288405114650955620859282144504446058845961744702163836107847961388150810</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>p,qè¿‘ä¼¼ï¼Œå¯¹aå¼€æ ¹æ±‚å‰åç´ æ•°å¾—p,qï¼Œè§£å¯†å¾—åˆ°mã€‚æ ¹æ®é¢˜ç›®åç§°ï¼Œéœ€è¦ç”¨åˆ°Wilsonå®šç†ã€‚å…¬å¼å¦‚ä¸‹<br>$$<br>m &#x3D; N*flag &#x3D; (p-1)!*flag &#x3D; -flag \mod p\<br>&#x3D;&#x3D;&gt;flag &#x3D; -m \mod p<br>$$<br>ä½†æ˜¯ä»…ä»…åªé€šè¿‡å¯¹æ¨¡æ•°påº”ç”¨Wilsonå®šç†æ˜¯ä¸èƒ½æ±‚å‡ºflagçš„ï¼Œè¿˜éœ€è¦å¯¹æ¨¡æ•°qåº”ç”¨Wilsonå®šç†ï¼Œå…¬å¼å¦‚ä¸‹<br>$$<br>m &#x3D; N*flag &#x3D; (p-1)!*flag\mod p*q<br>$$</p><p>$$<br>&#x3D;&#x3D;&gt;m*p*â€¦â€¦*(q-1) &#x3D; (q-1)!*flag\mod p*q<br>$$</p><p>$$<br>&#x3D;&#x3D;&gt;flag &#x3D; -m*p*â€¦â€¦*(q-1) \mod q<br>$$</p><p>ç„¶åå¯¹è¿™ä¸¤ä¸ªç»“æœè¿ç”¨ä¸­å›½å‰©ä½™å®šç†å³å¯æ±‚å‡ºflagã€‚</p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">broadcast_attack</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extended_gcd</span>(<span class="hljs-params">a,b</span>):<br>        x,y = <span class="hljs-number">0</span>,<span class="hljs-number">1</span><br>        lastx,lasty = <span class="hljs-number">1</span>,<span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> b:<br>            a,(q,b) = b,<span class="hljs-built_in">divmod</span>(a,b)<br>            x,lastx = lastx-q*x,x<br>            y,lasty = lasty-q*y,y<br>        <span class="hljs-keyword">return</span> (lastx,lasty,a)<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chinese_remaindor_theorem</span>(<span class="hljs-params">items</span>):<br>        N = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> a,n <span class="hljs-keyword">in</span> items:<br>            N *= n<br>        result = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> a,n <span class="hljs-keyword">in</span> items:<br>            m = N//n<br>            r,s,d = extended_gcd(n,m)<br>            <span class="hljs-keyword">if</span> d != <span class="hljs-number">1</span>:<br>                N = N//n<br>                <span class="hljs-keyword">continue</span><br>            result += a*s*m<br>        <span class="hljs-keyword">return</span> result%N ,N<br>    x, n = chinese_remaindor_theorem(data)<br>    <span class="hljs-keyword">return</span> x<br><br>a = <span class="hljs-number">156853895847604116708242664263151514811095704969640303272039451331791888050995073274981545693518063639560286348739938318495685137088495867703518198511200409009953879436648706837731243061114851474801565873584183542649886358523850682697732574913523360866915083642887238043256280849100274825940626065115676325169</span><br>c = <span class="hljs-number">3459715117165130065996389169943285249501133832272446001239391765859259811270526185228996906338576254353123756173289118671028939933226544773197852424767051933844004667155191851195814295922794480300237399956789038592856532530692732011427288405114650955620859282144504446058845961744702163836107847961388150810</span><br><br>tmp = <span class="hljs-built_in">int</span>(gmpy2.iroot(a, <span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])<br>q = gmpy2.next_prime(tmp)<br>p = a // q<br><span class="hljs-keyword">assert</span> p*q == a <span class="hljs-keyword">and</span> p &lt; q <span class="hljs-keyword">and</span> isPrime(p)<br>e = <span class="hljs-number">65537</span><br>d = gmpy2.invert(e, (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c, d, a)<br><span class="hljs-keyword">assert</span> <span class="hljs-built_in">pow</span>(m, e, a) == c<br>mp = (-m) % p<br>mq = (-m) % q<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(p, q):<br>    mq = (mq*i) % q<br><br>data = [(mp,p),(mq,q)]<br>f = broadcast_attack(data)<br><span class="hljs-built_in">print</span>(long_to_bytes(f))<br><span class="hljs-string">&#x27;&#x27;&#x27;code 2</span><br><span class="hljs-string">from gmpy2 import invert</span><br><span class="hljs-string">from Crypto.Util.number import long_to_bytes</span><br><span class="hljs-string">from functools import reduce</span><br><span class="hljs-string">a = 156853895847604116708242664263151514811095704969640303272039451331791888050995073274981545693518063639560286348739938318495685137088495867703518198511200409009953879436648706837731243061114851474801565873584183542649886358523850682697732574913523360866915083642887238043256280849100274825940626065115676325169</span><br><span class="hljs-string">c = 3459715117165130065996389169943285249501133832272446001239391765859259811270526185228996906338576254353123756173289118671028939933226544773197852424767051933844004667155191851195814295922794480300237399956789038592856532530692732011427288405114650955620859282144504446058845961744702163836107847961388150810</span><br><span class="hljs-string">p = 12524132538727147976454683542869473176723933298740764667643646868771435739017779964538584767004546975861773724104399289331497224456192089483187179727966053</span><br><span class="hljs-string">q = 12524132538727147976454683542869473176723933298740764667643646868771435739017779964538584767004546975861773724104399289331497224456192089483187179727966173</span><br><span class="hljs-string">e = 65537</span><br><span class="hljs-string">assert p &lt; q</span><br><span class="hljs-string">m = pow(c,int(invert(e,(p-1)*(q-1))),a)</span><br><span class="hljs-string">flag1 = -m % p</span><br><span class="hljs-string">flag2 = -m*reduce(lambda x,y:x*y,range(p,q)) % q</span><br><span class="hljs-string">flag = (flag1*q*int(invert(q,p)) + flag2*p*invert(p,q)) % a</span><br><span class="hljs-string">print(long_to_bytes(flag))</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="lost-N"><a href="#lost-N" class="headerlink" title="lost_N"></a>lost_N</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># part1</span><br>flag = <span class="hljs-string">b&#x27;SangFor&#123;&#125;&#x27;</span><br>d = getPrime(<span class="hljs-number">435</span>)<br>count = <span class="hljs-number">5</span><br><span class="hljs-keyword">while</span> count &gt; <span class="hljs-number">0</span>:<br>    p = getPrime(<span class="hljs-number">512</span>)<br>    q = getPrime(<span class="hljs-number">512</span>)<br>    n = p * q<br>    phi = (p-<span class="hljs-number">1</span>) * (q-<span class="hljs-number">1</span>)<br>    e = gmpy2.invert(d, phi)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c =&#x27;</span>, <span class="hljs-built_in">pow</span>(bytes_to_long(flag), e, n))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n =&#x27;</span>, n)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;e =&#x27;</span>, e)<br>    count -= <span class="hljs-number">1</span><br><br><span class="hljs-comment"># part2</span><br>p = getPrime(<span class="hljs-number">1024</span>)<br>q = getPrime(<span class="hljs-number">1024</span>)<br>n = p * q<br>e = <span class="hljs-number">0x10001</span><br>s = <span class="hljs-built_in">pow</span>(<span class="hljs-number">900</span>*p - <span class="hljs-number">218</span>*q, n-p-q, n)<br>c = <span class="hljs-built_in">pow</span>(last_n, e, n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n =&#x27;</span>, n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c =&#x27;</span>, c)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;s =&#x27;</span>, s)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">c = 13007070082982086015048648249698272815655157209727275797297990841215796701955079738986996208838342773211678208282162295881823413924960399315068498509939876883297864092435101096694113071462267388158595518905101264654742860199638059278239359756219217345342001728599121265614144789005805619626458575126846199823</span><br><span class="hljs-string">n = 145575036089862184772968012014750816659166028840828357885024516131565102712346345625910708214596157522939248398359985832422106056149116726640753670919394145037581595172384392223713667048639158944450925280598688178812170253438103664700756173806183649477673497327790421063029596049211220930285435947389700047717</span><br><span class="hljs-string">e = 6104905725583061487097813130111812725712623687061285535333592835899028572315489283518324105546236465450024687400996793197533588656449965379858202658832799573292015786259804984314040621630959455897094519928941186899832366216111359619637121411868069759469878142871432060850651758192209783752650530390826992241</span><br><span class="hljs-string">c = 59089700172263364510471541430195724136973801897202789650586019199451669728729101831161257990233999290546484165767660146638244043033774379664984894178111808280076960669616271416462197675878517863817855762681885790347812435849975072020273928469523961698304409181769820692602979823921421820511589311465948726144</span><br><span class="hljs-string">n = 171055961405321566289532118753767563629109197214150143506779656820887080836894368955104877312070939117885512468517951216152955714212079279910802095156350517032659766690101321767892798466184405283403136505441356956934759143173462058806620784497304916652269667097971495139608875846338091109621496242787157524093</span><br><span class="hljs-string">e = 30639328953696065722075015079387560065304228779854040351182305267894609577068955234152835797506237100956072519388029280776532681675227753068574540049244778077615881093270476533536257809592871380358708151151683035275615961208943826349952952069226829397420921321531951316523368786223865432179572145636266109841</span><br><span class="hljs-string">c = 24257648301491609274972482189063774024772127961295257418254600487615473027418329077996964279110710299066082437371516700591657843057597234861450272363240630164504734590903528165056021531272324846249133757036680429476939369309982196345252669711604534774523215422683385359295249160897422071732828044179085194829</span><br><span class="hljs-string">n = 99735998821682404719682435155046621256882035421263371444758755082217342389922499214602126376005623406797486880520535486455942687180959663032781490782870080236095770591995437146834606144553095293546973559144743704707021952152013362323293717685161426469215016058837362232410103330238322051089471439573994907641</span><br><span class="hljs-string">e = 81580834845272005549352820344384188734735397414102222005750919291263464191246301214086773744759605577533897859454210564034313392997143493147211816886655474145064723790935089304983994174659126346174766206623180477360887938029897557683160392738708450965784921553806400996559956745732829531154835363767773681061</span><br><span class="hljs-string">c = 105310270039347542993580213074911114373638987155564864341577443142664062749969114572669295115218200093381519732560445712425129105002834596010587656544575627162469582470245756143405705971157024449801127133755773536097173259762599166367688198314997549663330392481942723997656023552049910279885657664434799986156</span><br><span class="hljs-string">n = 118810172988175650374012494943583618875926370822995080847518376655089884052560062524542984436965153851285471302754389325839857100631601002627184437173686224779115595776898914116490948408328080895524604124937295381872443370706017215743101755848741173976351916104362193751372512936063892260855907424754174906407</span><br><span class="hljs-string">e = 57970672598245590037421993575987847127437841761387257183798066822318596392918179916711068560675528926294272336883938499809087281773070750919594701600347605662910664129043903749270935721912605279738208730075557097647316659218872977257614306133047318781156168440924237849014715453590776000659069078250493480521</span><br><span class="hljs-string">c = 50430341205487530895874157969557709374947862873979946417751686643857339147558892228311050765271667685452170747716439387141655285820549605442067496018168606163031122498272292974227360674531814593351170403519198099247839499352696883293133549658442172721339510734646474794377043195182186423251146266787514560008</span><br><span class="hljs-string">n = 80837118813383038376595037732171926303253457956240963765871280771175535050976501573174357090322706934194338649978803681581485022992041019276854467388155755920855237665754031077890133388056350355753218650482718197635332681450734918373003830855184694566883308495322647552169761087814135330222306083205629967447</span><br><span class="hljs-string">e = 51172856769626923894369204019063376718507295306271724506808987836327051371415876890252665691760404489737902233106400428873399230724307065583727090788789453353097657968301923726049631007431604461521879288667433292135840271678776989737261214286587609316530839676362375173635542358540766454865624476392874630929</span><br><span class="hljs-string">c = 24533435736573623334539431528997922833496063510219641412038735658846891237553927656156039267456590702682308774830590768888594750053426705504840854071081487058180327084899496154314864910274839867793265086899109787190447838634454294468362549369144295591261617705578124672391399319219038350878856530074063011081</span><br><span class="hljs-string"></span><br><span class="hljs-string">?</span><br><span class="hljs-string">?</span><br><span class="hljs-string">?</span><br><span class="hljs-string">?</span><br><span class="hljs-string">?</span><br><span class="hljs-string"></span><br><span class="hljs-string">e = 71905546659735491498365580186225996341462093571074706903142472266442052559638067842283521897292088493599089076218507596455101425837547743511983105386966540811629138324774640350969049873787070380161376295760563611617178869788237730560614549740931199083194226891873779907795120035746039593933256380499568775673</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">n = 20955464633057600258987829727550073699845816289000240676927869818926752810905511184835302717855745473943671910742784074561535017974853574714483642916831791020944940633062963043482236587316552330558006573820423830770910893877191630012247591380869307656539553888318621170921800017818132160253923739647771452839191101104391894609403591447166963426444018303147924843072923713248135717578047687411974516038299879758561542241544862102935741869647633013298181782208467117482306148238724598730801037692668154263059348953587766571379262442743822007387408949824805991797355089583176028081305319076896384126383926193964322235633</span><br><span class="hljs-string">c = 14815997295683082265558346455845370590765145583224067337292601455640475216349267044144296003388877395546880235511728120803143112914764263292087421926972160283428440959367872665892349776616002018624301524264223581314248857537034849571849747613963209414193510408342387107662655487869098045345428379025731617851483935711671021438908270746316921057871871545763798735895118697635903815383424855759281301248295597297869474539060531099443223045844791615425429748703429968627505406271675074549912664863784774239200764403372298995457799473112713379340870305136776932539188516395526955161359417473843082895317392495109895085666</span><br><span class="hljs-string">s = 14728527428626630951705148488338433865446345521255631461200851513782412494843597938863837697938230856843797646287742397249258609197032095158567448934855031190354034543862057663422053672290704598313096289223478302733688501373756860855445632789922930577582465209872782549135254792729915747104521949095814028476908208917363509089190935273004331739978623136706041729628143765893264698948654175039064609891374587695812144855411176143224066975193255513405865992328257766815240718115442741846443490733767716842367336385132648983241895710001620533668392060358573295789752856876282590472528110546264872047138094995909454134250</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>å®¡è®¡ä»£ç ï¼Œpart1ä¸­çš„RSAåŠ å¯†å…±ç”¨ä¸€ä¸ªç§é’¥dï¼Œè€Œe,nä¸åŒï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨<strong>å…±ç§é’¥æŒ‡æ•°æ”»å‡»</strong>(<a href="https://lazzzaro.github.io/2020/05/06/crypto-RSA/#Common-Private-Exponent%EF%BC%88%E5%85%B1%E7%A7%81%E9%92%A5%E6%8C%87%E6%95%B0%E6%94%BB%E5%87%BB%EF%BC%8Cd%E7%9B%B8%E5%90%8C%EF%BC%89">RSA | Lazzaro (lazzzaro.github.io)</a>)ã€‚ä½†ç”±äºç¼ºå°‘æœ€åä¸€ä¸ªnï¼Œéœ€è¦é€šè¿‡part2æ±‚å‡ºã€‚æ±‚è§£part2çš„å…¬å¼æ¨å¯¼å¦‚ä¸‹<br>$$<br>s &#x3D; (900*p-218*q)^{n-p-q}\mod n<br>$$<br>æ ¹æ®Eulerå®šç†æœ‰<br>$$<br>s*(900*p-218*q) &#x3D; (900*p-218*q)^{n-p-q+1}&#x3D;(900*p-218*q)^{Ï†(n)}&#x3D;1\mod n<br>$$<br>å³<br>$$<br>900*p-218*q &#x3D; s^{-1}\mod n<br>$$<br>å‡è®¾è§£å‡ºä¸ºtmpï¼Œè”ç«‹å¦‚ä¸‹å…¬å¼ï¼Œå»ºç«‹æ–¹ç¨‹è§£å‡ºp,q<br>$$<br>\begin{cases}<br>900*p-218*q&#x3D;tmp\\<br>n&#x3D;p*q<br>\end{cases}<br>&#x3D;&#x3D;&gt;900*p^2-tmp*p-218*n&#x3D;0<br>$$<br>å¾—åˆ°p,qåï¼Œå®¹æ˜“è§£å‡ºlast_nã€‚å¾—åˆ°æ‰€æœ‰(c,n,e)ä¹‹åï¼Œæ„å»ºæ ¼å¦‚ä¸‹<br>$$<br>L &#x3D; \left[\matrix{<br>M &amp; e0 &amp; e1 &amp; e2 &amp; e3 &amp; e4 &amp; e5\\<br>0 &amp; -n0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\<br>0 &amp; 0 &amp; -n1 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\<br>0 &amp; 0 &amp; 0 &amp; -n2 &amp; 0 &amp; 0 &amp; 0\\<br>0 &amp; 0 &amp; 0 &amp; 0 &amp; -n3 &amp; 0 &amp; 0\\<br>0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; -n4 &amp; 0\\<br>0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; -n5\\<br>}\right]<br>$$<br>å…¶ä¸­$M&#x3D;\lfloor n_5^{\frac{1}{2}}\rfloor$ã€‚å†åˆ©ç”¨LLLè¿›è¡Œè§„çº¦ï¼Œå–ç¬¬ä¸€ä¸ªåˆ†é‡çš„ç¬¬ä¸€ä¸ªå€¼é™¤ä»¥Må°±æ˜¯ç§é’¥däº†ï¼Œéšä¾¿æ‹¿ä¸€ä¸ªå¯†æ–‡è§£å¯†å³å¯å¾—åˆ°flagã€‚</p><p>part2ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python</span><br><span class="hljs-keyword">import</span> gmpy2<br><br>e = <span class="hljs-number">0x10001</span><br>n = <span class="hljs-number">20955464633057600258987829727550073699845816289000240676927869818926752810905511184835302717855745473943671910742784074561535017974853574714483642916831791020944940633062963043482236587316552330558006573820423830770910893877191630012247591380869307656539553888318621170921800017818132160253923739647771452839191101104391894609403591447166963426444018303147924843072923713248135717578047687411974516038299879758561542241544862102935741869647633013298181782208467117482306148238724598730801037692668154263059348953587766571379262442743822007387408949824805991797355089583176028081305319076896384126383926193964322235633</span><br>c = <span class="hljs-number">14815997295683082265558346455845370590765145583224067337292601455640475216349267044144296003388877395546880235511728120803143112914764263292087421926972160283428440959367872665892349776616002018624301524264223581314248857537034849571849747613963209414193510408342387107662655487869098045345428379025731617851483935711671021438908270746316921057871871545763798735895118697635903815383424855759281301248295597297869474539060531099443223045844791615425429748703429968627505406271675074549912664863784774239200764403372298995457799473112713379340870305136776932539188516395526955161359417473843082895317392495109895085666</span><br>s = <span class="hljs-number">14728527428626630951705148488338433865446345521255631461200851513782412494843597938863837697938230856843797646287742397249258609197032095158567448934855031190354034543862057663422053672290704598313096289223478302733688501373756860855445632789922930577582465209872782549135254792729915747104521949095814028476908208917363509089190935273004331739978623136706041729628143765893264698948654175039064609891374587695812144855411176143224066975193255513405865992328257766815240718115442741846443490733767716842367336385132648983241895710001620533668392060358573295789752856876282590472528110546264872047138094995909454134250</span><br><br>tmp = gmpy2.invert(s,n)<br><br>delta = tmp**<span class="hljs-number">2</span> - <span class="hljs-number">4</span>*<span class="hljs-number">900</span>*(-<span class="hljs-number">218</span>*n)<br><span class="hljs-keyword">if</span> delta &gt;=<span class="hljs-number">0</span>:<br>    delta = <span class="hljs-built_in">int</span>(gmpy2.iroot(delta,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])<br>    p1 = (tmp+delta)//(<span class="hljs-number">2</span>*<span class="hljs-number">900</span>)<br>    <span class="hljs-comment"># p2 = (tmp-delta)//(2*900)</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;p = <span class="hljs-subst">&#123;p1&#125;</span>&#x27;</span>)<br><br>p = p1<br>q = n//p<br><span class="hljs-keyword">assert</span> p*q == n<br><br>d = gmpy2.invert(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>last_n = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;last_n = <span class="hljs-subst">&#123;last_n&#125;</span>&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>part1ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br>c0 = <span class="hljs-number">13007070082982086015048648249698272815655157209727275797297990841215796701955079738986996208838342773211678208282162295881823413924960399315068498509939876883297864092435101096694113071462267388158595518905101264654742860199638059278239359756219217345342001728599121265614144789005805619626458575126846199823</span><br>n0 = <span class="hljs-number">145575036089862184772968012014750816659166028840828357885024516131565102712346345625910708214596157522939248398359985832422106056149116726640753670919394145037581595172384392223713667048639158944450925280598688178812170253438103664700756173806183649477673497327790421063029596049211220930285435947389700047717</span><br>e0 = <span class="hljs-number">6104905725583061487097813130111812725712623687061285535333592835899028572315489283518324105546236465450024687400996793197533588656449965379858202658832799573292015786259804984314040621630959455897094519928941186899832366216111359619637121411868069759469878142871432060850651758192209783752650530390826992241</span><br>c1 = <span class="hljs-number">59089700172263364510471541430195724136973801897202789650586019199451669728729101831161257990233999290546484165767660146638244043033774379664984894178111808280076960669616271416462197675878517863817855762681885790347812435849975072020273928469523961698304409181769820692602979823921421820511589311465948726144</span><br>n1 = <span class="hljs-number">171055961405321566289532118753767563629109197214150143506779656820887080836894368955104877312070939117885512468517951216152955714212079279910802095156350517032659766690101321767892798466184405283403136505441356956934759143173462058806620784497304916652269667097971495139608875846338091109621496242787157524093</span><br>e1 = <span class="hljs-number">30639328953696065722075015079387560065304228779854040351182305267894609577068955234152835797506237100956072519388029280776532681675227753068574540049244778077615881093270476533536257809592871380358708151151683035275615961208943826349952952069226829397420921321531951316523368786223865432179572145636266109841</span><br>c2 = <span class="hljs-number">24257648301491609274972482189063774024772127961295257418254600487615473027418329077996964279110710299066082437371516700591657843057597234861450272363240630164504734590903528165056021531272324846249133757036680429476939369309982196345252669711604534774523215422683385359295249160897422071732828044179085194829</span><br>n2 = <span class="hljs-number">99735998821682404719682435155046621256882035421263371444758755082217342389922499214602126376005623406797486880520535486455942687180959663032781490782870080236095770591995437146834606144553095293546973559144743704707021952152013362323293717685161426469215016058837362232410103330238322051089471439573994907641</span><br>e2 = <span class="hljs-number">81580834845272005549352820344384188734735397414102222005750919291263464191246301214086773744759605577533897859454210564034313392997143493147211816886655474145064723790935089304983994174659126346174766206623180477360887938029897557683160392738708450965784921553806400996559956745732829531154835363767773681061</span><br>c3 = <span class="hljs-number">105310270039347542993580213074911114373638987155564864341577443142664062749969114572669295115218200093381519732560445712425129105002834596010587656544575627162469582470245756143405705971157024449801127133755773536097173259762599166367688198314997549663330392481942723997656023552049910279885657664434799986156</span><br>n3 = <span class="hljs-number">118810172988175650374012494943583618875926370822995080847518376655089884052560062524542984436965153851285471302754389325839857100631601002627184437173686224779115595776898914116490948408328080895524604124937295381872443370706017215743101755848741173976351916104362193751372512936063892260855907424754174906407</span><br>e3 = <span class="hljs-number">57970672598245590037421993575987847127437841761387257183798066822318596392918179916711068560675528926294272336883938499809087281773070750919594701600347605662910664129043903749270935721912605279738208730075557097647316659218872977257614306133047318781156168440924237849014715453590776000659069078250493480521</span><br>c4 = <span class="hljs-number">50430341205487530895874157969557709374947862873979946417751686643857339147558892228311050765271667685452170747716439387141655285820549605442067496018168606163031122498272292974227360674531814593351170403519198099247839499352696883293133549658442172721339510734646474794377043195182186423251146266787514560008</span><br>n4 = <span class="hljs-number">80837118813383038376595037732171926303253457956240963765871280771175535050976501573174357090322706934194338649978803681581485022992041019276854467388155755920855237665754031077890133388056350355753218650482718197635332681450734918373003830855184694566883308495322647552169761087814135330222306083205629967447</span><br>e4 = <span class="hljs-number">51172856769626923894369204019063376718507295306271724506808987836327051371415876890252665691760404489737902233106400428873399230724307065583727090788789453353097657968301923726049631007431604461521879288667433292135840271678776989737261214286587609316530839676362375173635542358540766454865624476392874630929</span><br>c5 = <span class="hljs-number">24533435736573623334539431528997922833496063510219641412038735658846891237553927656156039267456590702682308774830590768888594750053426705504840854071081487058180327084899496154314864910274839867793265086899109787190447838634454294468362549369144295591261617705578124672391399319219038350878856530074063011081</span><br>n5 = <span class="hljs-number">108185319218897738268746205017540795873825112956591206743419271090891318238813558017643338501521098978024727760981025765573563469927135773358034691827660887010169178863498411277779419515872567620180674209868666624722965176088860357351459585091952847193607478681852858872736580818017021511957182389670032728751</span><br>e5 = <span class="hljs-number">71905546659735491498365580186225996341462093571074706903142472266442052559638067842283521897292088493599089076218507596455101425837547743511983105386966540811629138324774640350969049873787070380161376295760563611617178869788237730560614549740931199083194226891873779907795120035746039593933256380499568775673</span><br><br>M=<span class="hljs-built_in">int</span>(iroot(<span class="hljs-built_in">int</span>(n5),<span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>))[<span class="hljs-number">0</span>])<br>n_l = [n0,n1,n2,n3,n4,n5]<br>L = []<br>L.append([M,e0,e1,e2,e3,e4,e5])<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">7</span>):<br>    t = [<span class="hljs-number">0</span>]*<span class="hljs-number">7</span><br>    t[i] = n_l[i-<span class="hljs-number">1</span>]<br>    L.append(t)<br><br>L = matrix(ZZ,L)<br>L = L.LLL()<br>d = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">abs</span>(L[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>])//M)<br><span class="hljs-built_in">print</span>(d)<br>m = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(c0,d,n0))<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
      <tag>Wilson</tag>
      
      <tag>Common Private Exponent</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GXYCTF2019-CommonModulusAttack</title>
    <link href="/2022/10/06/GXYCTF2019-CommonModulusAttack/"/>
    <url>/2022/10/06/GXYCTF2019-CommonModulusAttack/</url>
    
    <content type="html"><![CDATA[<p>æ­¤ä¸ºBUUä¸Šçš„ä¸€é“é¢˜ã€‚</p><hr><p>åˆ†æä¸€ä¸‹å„å‡½æ•°åŠŸèƒ½</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">oldtest</span>():äº§ç”Ÿ<span class="hljs-number">20</span>ä¸ªéšæœºæ•°ï¼Œå†™å…¥old.txtä¸­<br><span class="hljs-built_in">generate_init_state</span>(): åŠŸèƒ½æ˜“æ‡‚ï¼Œä½†å­—å¤ªå¤šä¸å†™äº†ã€‚<br><span class="hljs-built_in">gen_states</span>():ç”Ÿæˆp,q,n,åŠ å¯†mï¼Œå°†nå†™å…¥productä¸­ï¼Œcå†™å…¥states<br><span class="hljs-built_in">encrypt</span>():CBCåŠ å¯†<br><span class="hljs-built_in">gen_new_states</span>():å°†statesçš„å‰<span class="hljs-number">24</span>ä¸ªæ•°æ®æŒ‰é¡ºåºè¿›è¡ŒCBCåŠ å¯†ï¼Œå†™å…¥statesï¼ŒåŒæ—¶stateselse += <span class="hljs-number">24</span><br><span class="hljs-built_in">stateconvert</span>():è¿”å›CBCåŠ å¯†åçš„ç»“æœ<br><span class="hljs-built_in">lrandout</span>():stateselse&gt;<span class="hljs-number">0</span>æ—¶ï¼ŒæŒ‰é¡ºåºå–statesä¸­çš„æ•°æ®å¹¶è¿›è¡ŒCBCåŠ å¯†;stateselse&lt;<span class="hljs-number">0</span>æ—¶ï¼Œå…ˆ<span class="hljs-built_in">gen_new_states</span>()<br>å†å–æ•°æ®<br><span class="hljs-built_in">byte2hex</span>():é¡¾åæ€ä¹‰ï¼Œå­—èŠ‚è½¬<span class="hljs-number">16</span>è¿›åˆ¶<br><span class="hljs-built_in">convert_2_binary</span>():å­—èŠ‚è½¬<span class="hljs-number">2</span>è¿›åˆ¶<br><span class="hljs-built_in">initseed</span>():flagåšåˆå§‹seed<br></code></pre></td></tr></table></figure><p>æ•´ä½“è¿‡ç¨‹ä¸ºï¼Œé¦–å…ˆæ˜¯ä¸€é”®ä¸‰è¿ï¼ˆ<code>oldtest()</code>ã€<code>initseed()</code>ã€<code>gen_states()</code>ï¼‰ï¼Œç„¶åå¾ªç¯24æ¬¡<code>lrandout()</code>ï¼Œæ­¤æ—¶<code>stateselse=0,statespoint=24</code>ï¼Œä¼šè¿›è¡Œä¾æ¬¡<code>gen_new_states()</code>ï¼Œç„¶åå†æ¬¡è¿›è¡Œ24æ¬¡<code>lrandout()</code>ï¼Œå†™å…¥<code>new.txt</code>ä¸­çš„æ•°æ®ä¾æ¬¡æ˜¯$E_{CBC}(E_{CBC}(RSA_{0}))$~$E_{CBC}(E_{CBC}(RSA_{23}))$ï¼Œä¹Ÿå°±æ˜¯<code>state[:24]</code>è¿›è¡Œäº†ä¸¤æ¬¡<code>CBC</code>åŠ å¯†ã€‚</p><p>è§£é¢˜å…³é”®åœ¨äºç ´è§£CBCçš„å¯†é’¥ï¼Œè¿™å¯èƒ½éœ€è¦é¢„æµ‹éšæœºæ•°ï¼ŒæŸ¥è¯¢å¾—çŸ¥<code>java.util.Random.nextInt()</code>ä½¿ç”¨çš„æ˜¯çº¿æ€§åŒä½™å‘ç”Ÿå™¨LCGã€‚<code>java</code>ä½¿ç”¨çš„å‚æ•°å’Œæ–¹ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">a</span> = <span class="hljs-number">25214903917</span>, b = <span class="hljs-number">11</span>, m = <span class="hljs-number">281474976710655</span><br><span class="hljs-attr">seed</span> = (a*seed + b) &amp; m<br></code></pre></td></tr></table></figure><p>ï¼ˆé™„ä¸ŠæŸä¹¦çš„ç›¸å…³å›¾ç‰‡ï¼‰</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210061556802.jpg"/><p>çˆ†ç ´<code>seed</code>è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x5deece66dL</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">11L</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-number">0xffffffffffffL</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">crack_seed</span><span class="hljs-params">(<span class="hljs-type">long</span> out1, <span class="hljs-type">long</span> out2)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">0xffff</span>; i++) &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">seed</span> <span class="hljs-operator">=</span> (out1 &lt;&lt; <span class="hljs-number">16</span>) + i;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">guess_out2</span> <span class="hljs-operator">=</span> (a * seed + b &amp; m) &gt;&gt;&gt; <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">if</span> (guess_out2 == out2) &#123;<br>            System.out.println(<span class="hljs-string">&quot;[+] PRNG&#x27;s seed: &quot;</span> + String.valueOf(seed));<br>            <span class="hljs-keyword">return</span> seed;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;[!] PRNG crack failed!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾—åˆ°<code>seed</code>ä¹‹åï¼Œå°±å¯ä»¥é¢„æµ‹<code>AES/CBC</code>çš„å¯†é’¥<code>key</code>ï¼Œä»¥åŠ<code>RSA</code>çš„<code>p,q</code>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é¡ºåºå’Œæ¬¡æ•°çš„é—®é¢˜</p><ul><li>é¦–å…ˆè¿‡æ»¤<code>old.txt</code>äº§ç”Ÿçš„éšæœºæ•°å…±è®¡19æ¬¡</li><li>ç„¶åç”Ÿæˆ<code>RSA</code>çš„<code>p,q</code>å…±è®¡24æ¬¡</li><li>æœ€åæ˜¯<code>AES/CBC</code>å…±72æ¬¡ï¼Œå‰24æ¬¡çš„éšæœºæ•°å¯¹è§£é¢˜æ— ç”¨ï¼Œä¸­é—´24æ¬¡çš„éšæœºæ•°æ˜¯$E_{CBC}(RSA_c)$çš„å¯†é’¥<code>key1</code>ï¼Œæœ€å24æ¬¡æ˜¯$E_{CBC}(E_{CBC}(RSA_{c}))$çš„å¯†é’¥<code>key2</code>ã€‚éœ€è¦æ³¨æ„è‹¥å°†éšæœºæ•°ç›´æ¥å­˜å…¥æ–‡ä»¶å†è¯»å–ï¼Œé•¿åº¦ä¸å¤Ÿ16bitï¼Œéœ€è¦è¿›è¡Œ<code>byte2hex()</code>ã€‚</li></ul><p>javaä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.lang.*;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">crak_into_RSA</span> &#123;<br>    <br>    <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x5deece66dL</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">11L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-number">0xffffffffffffL</span>;<br>    <span class="hljs-comment">//çˆ†ç ´ç§å­</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">crack_seed</span><span class="hljs-params">(<span class="hljs-type">long</span> out1, <span class="hljs-type">long</span> out2)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">0xffff</span>; i++) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">seed</span> <span class="hljs-operator">=</span> (out1 &lt;&lt; <span class="hljs-number">16</span>) + i;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">guess_out2</span> <span class="hljs-operator">=</span> (a * seed + b &amp; m) &gt;&gt;&gt; <span class="hljs-number">16</span>;<br>            <span class="hljs-keyword">if</span> (guess_out2 == out2) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[+] PRNG&#x27;s seed: &quot;</span> + String.valueOf(seed));<br>                <span class="hljs-keyword">return</span> seed;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;[!] PRNG crack failed!&quot;</span>);<br>    &#125;<br><span class="hljs-comment">//è®¾ç½®ç§å­</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">SetSeed</span><span class="hljs-params">(<span class="hljs-type">long</span> seed)</span>&#123;<br>        <span class="hljs-built_in">this</span>.random.setSeed(seed ^ a);<br>    &#125;<br><span class="hljs-comment">//è¯»æ–‡ä»¶</span><br>    <span class="hljs-keyword">public</span> ArrayList&lt;Long&gt; <span class="hljs-title function_">ReadFile</span><span class="hljs-params">(String fileName)</span> &#123;<br>        ArrayList&lt;Long&gt; states = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-number">24</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(fileName);<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(file));<br>            <span class="hljs-type">String</span> <span class="hljs-variable">tempString</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">while</span> ((tempString = reader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                states.add(Long.valueOf(tempString));<br>            &#125;<br>            reader.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> states;<br>    &#125;<br><span class="hljs-comment">//è¿‡æ»¤å‰24ä¸ªéšæœºæ•°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">oldtest</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-comment">//        ArrayList&lt;Integer&gt; old = new ArrayList&lt;Integer&gt;();</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">19</span>;i++)&#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.random.nextInt();<br><span class="hljs-comment">//            old.add(tmp);</span><br>        &#125;<br>    &#125;<br><span class="hljs-comment">//åˆ©ç”¨éšæœºæ•°å‘ç”Ÿå™¨äº§ç”ŸRSAçš„p,q</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">gen_RSA</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> BigInteger.valueOf(<span class="hljs-number">17L</span>);<br>        <span class="hljs-type">ArrayList</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-number">24</span>);<br>        <span class="hljs-type">ArrayList</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-number">24</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; <span class="hljs-number">24</span>; ++var5) &#123;<br>            <span class="hljs-type">BigInteger</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> BigInteger.probablePrime(<span class="hljs-number">512</span>, <span class="hljs-built_in">this</span>.random);<br>            <span class="hljs-type">BigInteger</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> BigInteger.probablePrime(<span class="hljs-number">512</span>, <span class="hljs-built_in">this</span>.random);<br><br>            var3.add(var6);<br>            var3.add(var7);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-string">&quot;p_and_q&quot;</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var12</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var12 &lt; <span class="hljs-number">24</span>*<span class="hljs-number">2</span>; ++var12) &#123;<br>                var11.println(((BigInteger)var3.get(var12)).toString());<br>            &#125;<br>            var11.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var10) &#123;<br>            var10.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">byte2hex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] var0)</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(var0.length * <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var2 &lt; var0.length; ++var2) &#123;<br>            <span class="hljs-keyword">if</span> ((var0[var2] &amp; <span class="hljs-number">255</span>) &lt; <span class="hljs-number">16</span>) &#123;<br>                var1.append(<span class="hljs-string">&quot;0&quot;</span>);<br>            &#125;<br><br>            var1.append(Long.toString((<span class="hljs-type">long</span>)(var0[var2] &amp; <span class="hljs-number">255</span>), <span class="hljs-number">16</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> var1.toString();<br>    &#125;<br><span class="hljs-comment">//åˆ©ç”¨éšæœºæ•°å‘ç”Ÿå™¨äº§ç”ŸAES/CBCçš„key</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">gen_CBC_key</span><span class="hljs-params">()</span>&#123;<br><br>        <span class="hljs-comment">//24æ¬¡æ— ç”¨</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">24</span>;i++)&#123;<br>            <span class="hljs-type">byte</span>[] var3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>            <span class="hljs-built_in">this</span>.random.nextBytes(var3);<br>        &#125;<br><br>        <span class="hljs-type">ArrayList</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-number">48</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">48</span>;i++)&#123;<br>            <span class="hljs-type">byte</span>[] var3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>            <span class="hljs-built_in">this</span>.random.nextBytes(var3);<br>            var4.add(byte2hex(var3));<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-string">&quot;CBC_key&quot;</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var12</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var12 &lt; <span class="hljs-number">48</span>; ++var12) &#123;<br>                var11.println(var4.get(var12));<br>            &#125;<br>            var11.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var10) &#123;<br>            var10.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">crak_into_RSA</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">crak_into_RSA</span>();<br>        ArrayList&lt;Long&gt; old = obj.ReadFile(<span class="hljs-string">&quot;old.txt&quot;</span>);<br>        System.out.println(old);<br>        <span class="hljs-type">long</span> seed;<br>        <span class="hljs-keyword">try</span> &#123;<br>            seed = obj.crack_seed(old.get(<span class="hljs-number">0</span>), old.get(<span class="hljs-number">1</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        obj.SetSeed(seed);<br>        obj.oldtest();<br><br>        obj.gen_RSA();<br>        obj.gen_CBC_key();<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>(æˆ‘æ‰¿è®¤æˆ‘<code>java</code>å¾ˆèœï¼Œä¸å–œæ¬¢ç”¨javaï¼Œç±»å‹è½¬æ¢éƒ½å¤Ÿå‘›çš„)</p><p>æ¥ä¸‹æ¥å°±æ˜¯åˆ©ç”¨å¾—åˆ°çš„å¯†é’¥<code>key</code>ï¼ˆIVå‘é‡æ ¹æ®ä»£ç å¯çŸ¥ä¸ºç©ºï¼Œå³å…¨0ï¼‰ä»¥åŠ<code>p,q</code>è§£å¯†å¾—åˆ°<code>generate_init_state()</code>ä¹‹åçš„<code>c</code>ï¼Œè¦æƒ³è¿›ä¸€æ­¥å¾—åˆ°<code>flag</code>åªéœ€è¦ä¸æ–­é‡å¤<code>generate_init_state()</code>ã€‚ï¼ˆè¯è¯´è¿™å‘¨æœŸæ€§æ˜¯æ€ä¹ˆçœ‹å‡ºæ¥çš„ï¼‰</p><p>pythonä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> randcrack <span class="hljs-keyword">import</span> RandCrack<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> unhexlify<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dec_CBC</span>(<span class="hljs-params">key,eenc</span>):<br>    key1, key2 = key[:<span class="hljs-number">24</span>], key[<span class="hljs-number">24</span>:]<br>    rsac = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">24</span>):<br>        aes1 = AES.new(key1[i], AES.MODE_CBC, iv=<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">16</span>)<br>        aes2 = AES.new(key2[i], AES.MODE_CBC, iv=<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">16</span>)<br>        enc = aes2.decrypt(eenc[i])<br>        rsac.append(bytes_to_long(aes1.decrypt(enc)))<br><br>    <span class="hljs-keyword">return</span> rsac<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ReadFile</span>():<br>    modulus = []<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;product&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        txt = f.readlines()<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> txt:<br>            modulus.append(<span class="hljs-built_in">int</span>(line))<br><br>    key = []<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;CBC_key&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        txt = f.readlines()<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> txt:<br>            key.append(unhexlify(line.strip()))<br><br>    pq = []<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;p_and_q&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        txt = f.readlines()<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(txt),<span class="hljs-number">2</span>):<br>            (p,q) = <span class="hljs-built_in">int</span>(txt[i]),<span class="hljs-built_in">int</span>(txt[i+<span class="hljs-number">1</span>])<br>            pq.append((p,q))<br><br>    <span class="hljs-comment"># for i in range(len(modulus)):</span><br>    <span class="hljs-comment">#    assert(modulus[i] == pq[i][0]*pq[i][1]) and isPrime(pq[i][0]) and isPrime(pq[i][1])</span><br><br>    new = []<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;new.txt&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        txt = f.readlines()<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> txt:<br>            new.append(unhexlify(line.strip()))<br><br>    <span class="hljs-keyword">return</span> modulus, key, pq, new<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dec_RSA</span>(<span class="hljs-params">c,pq</span>):<br>    e = <span class="hljs-number">17</span><br>    m = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">24</span>):<br>        <span class="hljs-keyword">try</span>:<br>            p, q = pq[i][<span class="hljs-number">0</span>], pq[i][<span class="hljs-number">1</span>]<br>            d = invert(e, (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>            m.append(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(c[i], d, p*q)))<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">return</span> m<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_init</span>(<span class="hljs-params">seed</span>):<br>    var = <span class="hljs-number">0</span><br>    binseed = <span class="hljs-built_in">bin</span>(seed)[<span class="hljs-number">2</span>:]<br>    <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> binseed:<br>        var = var &lt;&lt; <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> each == <span class="hljs-string">&#x27;1&#x27;</span>:<br>            var = var ^ seed<br>        <span class="hljs-keyword">if</span> (var &gt;&gt; <span class="hljs-number">256</span>) != <span class="hljs-number">0</span>:<br>            var = var ^ <span class="hljs-number">0x10000000000000000000000000000000000000000000000000000000000000223</span><br>    <span class="hljs-keyword">return</span> var<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dec_init_state</span>(<span class="hljs-params">m</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        m = gen_init(m)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;flag&quot;</span> <span class="hljs-keyword">in</span> long_to_bytes(m):<br>            <span class="hljs-built_in">print</span>(long_to_bytes(m))<br>            <span class="hljs-keyword">break</span><br><br>modulus, key, pq, new = ReadFile()<br>rsac = dec_CBC(key, new)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;modulus = <span class="hljs-subst">&#123;modulus&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;rsac = <span class="hljs-subst">&#123;rsac&#125;</span>&#x27;</span>)<br>m = dec_RSA(rsac, pq)<br><span class="hljs-built_in">print</span>(m[<span class="hljs-number">0</span>])<br>dec_init_state(m[<span class="hljs-number">0</span>])<br><br></code></pre></td></tr></table></figure><p>æ ¹æ®é¢˜ç›®ä¸­RSAçš„å‚æ•°çš„ç‰¹ç‚¹ï¼Œå³ä½¿ç”¨åŒä¸€ä¸ªåŠ å¯†æŒ‡æ•°<code>e</code>åŠ å¯†åŒä¸€ä¸ªæ˜æ–‡ï¼Œè¿™æ ·æ˜¯å¯ä»¥é€šè¿‡<strong>ä½åŠ å¯†æŒ‡æ•°å¹¿æ’­æ”»å‡»ï¼ˆHastadæ”»å‡»ï¼‰</strong>ç ´è§£çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br>modulus = [<span class="hljs-number">98814919313645615562227632501842353623335365853705229901835148468883495797275597414884229673154676216661172834551301610934651963240119409868685277777800714566912405986645043974924445077030680918856209854280255930507129711147257107127165995928330446921396988707590674551893978543347857267274126479566133964621</span>, <span class="hljs-number">120309037005681976370949305207133746746983392014859786008077885868206237066288839457678467372792330832240493847319506910624107293327355575990265009395111812157069795648694878932912724266067108352114568041606927740805295578389613410752347225302683181568493377905133685788806771897944116380798383235212880787111</span>, <span class="hljs-number">111785936365127017878364692255320290881390250034420261152076893236497751708479451558829998875477413370296672127312833416766071239043340476618512716523841455668113510503541200502811971438914643566444202595134432922460265282115077045761511350952491133678485898016929814918158114380643876728495327499109907572429</span>, <span class="hljs-number">79107360215620077532659896175026195404235793190726547917783395438823337589603205953575483353228931287967504796791548380004359471560051416284517914649068134828827258371600937675407475086859499975654685415750272651221034077150245371035999615125332427139552452769011676593964204925071318469088799724530215124831</span>, <span class="hljs-number">76569172668426111655559325602270543124911618387292779930876870738135074619169375835923184222768365842868492168017456879360896599138595315395127482484106260530315856131196505195380380922891702380525990613251179620270889682827012451440651535676227547036408820876146886053832887455868205776680614430725735043793</span>, <span class="hljs-number">103550587454386321582558194662757829135212617455098189704465201424747083811259424236094773443146797074227050243796231001527513188517222102533609879856271977599085359214761995812013304273705087884012864870860316140959386263712261023431338642036955538675194995254860356196860928948904910104782072744666235086537</span>, <span class="hljs-number">90971837642433291280873621883216367817998065218607475308728029342384397984877685262773211911225017685122069795492703551175449897609664953357038478590596118164908410836795589316859218558924908109018646584994451050418244132783990484997446700555849562546557811117907782116545477224921738603975274933186794342491</span>, <span class="hljs-number">73413351017881312712468977975284224969712424335838849844092642943213311672854945671322891541815396298565073974489398966168460398863368939081968582617939378670552898186310210195570878457837228086549976345444751087428844389630498481701518885699105988150105202350202767346091098175295783591431654750734894877399</span>, <span class="hljs-number">71566039368566410696192366523253937232453984906766927106190688497758283492117264515150487759343943529526150027981496199751072735188260477291107672692545413595715319871286731540613403720279178498965086799594314786942108180966532474527957866789627251162692053119249102334395349645969466674380262856097693438521</span>, <span class="hljs-number">107628356419937581357884846311454393897766095193524472406415741434987693671384322405146875604772875861371298399663792861133695195849541253920791194728970646177177601304422827790522809107774220027822016584419667805968358988156290174765868439478153696514808349459959439415529354636614886500694506023255079823373</span>, <span class="hljs-number">91790474865200416562498525223387195736004778541952759476953293702991209352845230506773341766471835481185571572235140157043225934157398559619371693860888447188748144001978514611594339471810299348783446801794220036396407380964251612645759456101262295721935493095278291895678614455197784652961018115949658419209</span>, <span class="hljs-number">57745662696838303754303952465503228135078930819394673548775585096093512474118594638537980679427929033618503594855631276864271074749153391716985704043006635120113738881223783140512431675306017867810186495417036064170392661338259312054070420545443175282250796188844807847223002952495291671792316319261526203977</span>, <span class="hljs-number">74932280401824987073956870313685377085306206587423235348665346009152728684240450812927074555554879023572849407016961782430835249861002565952666939003777340922054220851625176505153442063005452154788416303298829441483147485245199232639360652800187172042662155481290924850141197767078965685536829327773869523877</span>, <span class="hljs-number">151358344215033244675875489778202324190602535755100062795559941742660074031432793530151212013764307368624092680307412309928239344375084702784223862577115959360359550888626830285200297868200193432953229394288774622849280647658223840091169768900707469559531106032962678397359686688885464319205469445395775505261</span>, <span class="hljs-number">58689109871391516446867152324943075006307619674297402783356934482330092148515973708298623302336452436909987582230530380141926976193048683919739669740152340284783548654140031841997682049142230063299924009372163169151602233027862127015614058254349505308306391730351101028876962457506249662645940599043284890479</span>, <span class="hljs-number">75861752129011706039232551442557324749632957472023260501544821732788259510015930776827063124846257933592600211419172200445500819665741080443558399298477165580569304097320488157982369509484537407955071525374169099071933569693698855275672496186292197585298047755984716638462181339492749181406670186116294083207</span>, <span class="hljs-number">95346418806667240579084074666101586656652563700979849442906833893357500903462274404419599353579163690013564626109399908623932855557157233581946448703748443415302152330984340846031484190075840945839657868726300498034388094371265188156182339601979104590181781634872909781460522645431312963619475713195057529053</span>, <span class="hljs-number">111263984476673436627489757275903278242507559263558167504820261180694675496975214444112803028740397579682261168188209236682419315487324285379489604372214244677171978542867983223205255696183564627476468236388981120865570003958834885830340089377367925355956102357809150294822256788916694056156982524732649022121</span>, <span class="hljs-number">96342125779778036941833551361632436941989127906210900570779845131168275089639216016217308560788807120832119537472979904464676694024827555869317191603939804273190020844614998671864808084618549460537796585180744783403305042282594096501853485099449520451347637383758909023665498253598410753186362009460492830077</span>, <span class="hljs-number">123521857465916800677857353280191063787794382070207831208108072146961113332349472274610835066727682678338330153931986264103329376246220375119477195903647449590640978718531623595252346576912612285734791871663640158415800617586885197074330899616507185403383799265717845801374846656401529390641443616981589591271</span>, <span class="hljs-number">131405795868049704946945078209025643754825946515862168268539786167707046891586623717476673108436285639575419309084969446295535565904197185085776823271112656565198238246280988380382110403894156666473014985911785626169140414905488725615795364652211328520244008235414509954941587909513975543894548408022461287151</span>, <span class="hljs-number">70967114730909286832264494950640090470702806737946498609585048455374288588521539757280256786923900427556094520842779667859333365003824139739221992299308163341116429010529334098884182035133381995880826298540167736908299468072146475041847885773746257305103221598524542443653591683985019129894558266194325182821</span>, <span class="hljs-number">107979432465960445003549108683102634118917861056034954024622240724163563602890130060316628069849623795318199576811119794560257267198435021465634488362082571221559448800322437539178387390819167699914898519745802727807447711037649579119174492560260601959406822151422632429549878526990294167401411360169366398309</span>, <span class="hljs-number">118859893624530448832013335940179713922013208072805796098733098460272093097271354351290476904722130296985679088987020794135009361338702308650147800222344594443187427748099291365938946361540610154000110289387874941903994296345375923386002742685159036859796319092682744673080262820281354319298093885235987771731</span>]<br>rsac = [<span class="hljs-number">74504458879652943718663653850001437748341706690464761040767162486051250985910710402432140664943614478998161249571034628851708336587661498323826689121364093982543580220191566185998828898605279747505344794840238227684405607409399902867487210576304571314924605590164238090018623295565709785325901829375477233824</span>, <span class="hljs-number">90677687219451530935331531248712316796517647127110471932385574260084489206678436536025506136368980291362036895801209630370143728770276253819338126007059869043902337086043255709746216137616247630906044373779975724955439086975040791603062792477039660332639822636527898261073298224224617779978714534530831926382</span>, <span class="hljs-number">10441054926050260515775358807238672134995234707241729080928053791607295564961937959033050961406260156072418199349907188140011493317693815061021500276765874984758886044928346932845924300744885188311089620531981448619278771578819713090509906031204293324113030585264611939296118692099522756767915057220802371922</span>, <span class="hljs-number">75065942418049435620654589688902391988060904032224001083231877620990198917295603935365374839889910973316542865166711278558219477270958110193289958891670566730226744983567315102048352813458563913653693662545337119770268597757415606316643719527194000516770694472830033240065407861002018776722640989245914933864</span>, <span class="hljs-number">15967158178072756422697064801486297052470586035506805260212161467461991259373987383255280185122289231578694016246952580063663344331526433996641826455260971239990061316068805505099845909759948602603228604199884069913782124385897091085229540639182230053801383267057411228014418697121534096948589529087973618030</span>, <span class="hljs-number">37689478205889636617142877564157174378274716740702285559079324695046266180134126621576800675259844590798526867151978596131919317434518210642866030066928530109056429979286677519091178622240424270292632823938720664459741648575643188292206339090139580383397462178781885540845296443902839519200711798152861266216</span>, <span class="hljs-number">89991079171246842344250963909361678745600967560853729184873707321755423054752908194189661108220419993798870795216751075958380000036114708766326933569202097724367289862510179697851125292225500668270519323126824977283310811921738440461634618096070254683166891178610983021175889405723063903744760830044483553015</span>, <span class="hljs-number">12564784640138976223050478455073663507636463279004472970307500669890867813114565499438039688204577264309094677815359383327303659158283614635750329846385518405508451739233890320129606029814764719198822399536313264962983904837928212526895349327777003147602280321802339650663070755926837928479100067496182740015</span>, <span class="hljs-number">11644943444021682061705775758222178592151216531043485095365213895064672411659588784299149458722852375507456625497581474106874839986786922479523762090697979412491760703258217221044871874588203242834670991968225018330747687499319134596164253217457822290251577010138433021634093698922228165988834742170304034937</span>, <span class="hljs-number">7440952483263968136543488133538954176720150568935036124555561636558405472861937899311692100225854466894641991674736586071693917092584709253652133242676032360332823213448817914514598770449974685391866088874604994277625053485651836603598675134877502825868995744877182003110720548987649603439409541560443056233</span>, <span class="hljs-number">26432139649644724258156851399015803833287203554853089382176324578551505137460733413666096695203082335960652170254261514531360519569163381379304943388941105657952632544172898150281406145833476518212352728023813500749575869340588121411252877723139411912575077520300256718257321039492671708893676087174130127627</span>, <span class="hljs-number">57123543722088565652435248193112878912919477826104699980308653915041296324381912869705895816597336792356053129908891429078049803245912627548678533968825391714890250901090173610814507250901176738461218113028322059386190976395617728466608881544720668647826686193434008738860268283215016301583387030358145368979</span>, <span class="hljs-number">23345145988953014746994009332494104314006269768459845287686772564449193680626141627252617993162588712706111487450314527081815527083176603353888026799539264957926735851981959663747313504865883507010317064677343050012331837540653419457977282011143696513646910221917021350965089365064108284126991594769804195958</span>, <span class="hljs-number">18584786192890585340554251103045488911640395930311242880183603291612729344818076657431110151188845846461865668722727322657706096938157538175405143087120939463583993015116566820907628655632261436234097039735321279198185020071927791315164532898161858419324906856694850350127947939219274692570387210945622160425</span>, <span class="hljs-number">32032100783803280101506640700407146214507106934402623014894345433328319560672855179559658148321460290731133069045000363251832955885416381476803469919752501472790597059954145215453484924607402213833208606478061431892867099951406127186058725643977545110983793482369725606454118192673307075130629848277572761800</span>, <span class="hljs-number">33553261797062509715636247635116146924068973136236402732133070162363574617308632416380426301032863871980545883634361689918994364261326716216183140972627635354327281418414737356206607530518178640605226107447668012418064780102828536450110475122533604086967729782507101136102693107027580346060700369982449268926</span>, <span class="hljs-number">89670084243832433804089281202232826269625530193093980037641998743679243635754393741282858947768060115028683001038661205854054299192392452008668561209116501939507252886741566691289008796906111249663270020473187990112802944098815756041580119043386176229088695930061919546816589198630865246014946002351028640824</span>, <span class="hljs-number">1885172266369210136727710999528571764220354997431579368990444202265790166417523564316711055628257703430143702613679953660332632889708772965357813478003529054531405806804431450226099406126799278914742462302125596290589751898179861813384971843398481071872868293514166981185749346457303403593450424312260349932</span>, <span class="hljs-number">38315205924420685030274312234361688998295987101811658111889610086810814657639278790542984546365338373266315310027165402200622668761747894472059459061618323576723570481849451043583002607285263178217863197890339568464658591355554682896748372777684662342898583067137754082163049279790489618727974756059268134757</span>, <span class="hljs-number">1503390686484331392720378357968284034985922228277965470494601879150160036004097286813280072280703228267019910176646779550924896975837747296612147447328318954616213255299480731492038869675560914084449670874184183238901906564172317022457453828770471467222933579318607818146238931448210350167812730883209706573</span>, <span class="hljs-number">18261213979022925288437196949092892081418030897865208654146190002058335053744268642563789748028557517530508560801191795766191341328352904811764022501596832195139424135209021776110924124039296421367751450136220305469912616827010861330256881960646842786938701289977933762823676627250459890848839915051749826759</span>, <span class="hljs-number">23533732290079220996981259709972499473689463975286699510373965623743642991317196761881160594348850261577119383002784894244669591774257030880479791202186436732524028353661327508406190257273456035705131167830367903206715636687652856796934500412120422271222540504288448174980494038298906213387391904497984121223</span>, <span class="hljs-number">4947065111438996960526894808482046817149283280661743322149062731884606781783471692517417963283291589117647621522497791685498761948515564261734860969232487531299769159613422384551359597280388941714265690573934157839829726977812657605906204879891549647528887678395428467400579365987072840270925293902595715999</span>, <span class="hljs-number">67653403106052782639824505158253042492359705399959732418763452025230197898542624747634303715085261173616195255069462499517424774656996471734918800423899632652788451324107959871547187612032289791267004085024256214283694845473459442053468102390886723908204278002126105750462941050782644578760981771561025922699</span>]<br>M = crt(rsac,modulus)<br>f = x^<span class="hljs-number">17</span> - M<br><span class="hljs-built_in">print</span>(f.roots())<br><span class="hljs-comment">#[(66869997917800083972572187953062445239249136563973495502684696601787248828812, 1)]</span><br></code></pre></td></tr></table></figure><hr><p><a href="https://dunkirkturbo.github.io/2020/08/12/CTF-Training-Record-2/">CTF-Training-Record-2 | 0xDktbâ€™s Blog (dunkirkturbo.github.io)</a></p><p><a href="https://lazzzaro.github.io/2020/05/06/crypto-RSA/#%E4%BD%8E%E5%8A%A0%E5%AF%86%E6%8C%87%E6%95%B0%E5%B9%BF%E6%92%AD%E6%94%BB%E5%87%BB%EF%BC%88Hastad%E6%94%BB%E5%87%BB%EF%BC%89">RSA | Lazzaro (lazzzaro.github.io)</a></p><p><a href="https://blog.csdn.net/weixin_45883223/article/details/115299389">LCG(çº¿æ€§åŒä½™ç”Ÿæˆå™¨)_WustHandyçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://www.jianshu.com/p/d46a7c7edea4">æµ…è°ˆJavaçš„ä¼ªéšæœºæ•°å‘ç”Ÿå™¨å’Œçº¿æ€§åŒä½™æ³• - ç®€ä¹¦ (jianshu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>LCG</tag>
      
      <tag>Hastadæ”»å‡»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022ç¬¬äº”ç©ºé—´</title>
    <link href="/2022/10/03/2022%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4/"/>
    <url>/2022/10/03/2022%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4/</url>
    
    <content type="html"><![CDATA[<h1 id="2022ç¬¬äº”ç©ºé—´ç½‘ç»œå®‰å…¨å¤§èµ›"><a href="#2022ç¬¬äº”ç©ºé—´ç½‘ç»œå®‰å…¨å¤§èµ›" class="headerlink" title="2022ç¬¬äº”ç©ºé—´ç½‘ç»œå®‰å…¨å¤§èµ›"></a>2022ç¬¬äº”ç©ºé—´ç½‘ç»œå®‰å…¨å¤§èµ›</h1><h2 id="5-vgcd"><a href="#5-vgcd" class="headerlink" title="5_vgcd"></a>5_vgcd</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> getrandbits, seed<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> getPrime, inverse, bytes_to_long, isPrime<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> urandom<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sample</span>(<span class="hljs-params">rho, eta, gamma, p</span>):<br>    seed(urandom(<span class="hljs-number">8</span>))<br>    <span class="hljs-keyword">return</span> p * getrandbits(gamma - eta) + getrandbits(rho)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_vector</span>(<span class="hljs-params">rho, eta, gamma, m, p, K</span>):<br>    v = vector([sample(rho, eta, gamma, p) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m)])<br>    <span class="hljs-keyword">return</span> K*v <br>    <br>rho = <span class="hljs-number">6</span><br>m = <span class="hljs-number">3</span><br>eta = <span class="hljs-number">288</span><br>gamma = <span class="hljs-number">512</span><br>p = getPrime(gamma)<br>q = getPrime(gamma)<br>n = p * q<br>e = <span class="hljs-number">65537</span><br>phi = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>c = <span class="hljs-built_in">pow</span>(bytes_to_long(flag), e, n)<br><span class="hljs-built_in">print</span>(n)<br><span class="hljs-built_in">print</span>(c)<br><br>pp = p &gt;&gt; (gamma - eta)<br><span class="hljs-keyword">assert</span> isPrime(pp)<br>K = Matrix.random(Integers(pp), m, m).lift()<br>t1 = [gen_vector(rho, eta, gamma, m, pp, K) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1024</span>)]<br><span class="hljs-built_in">print</span>(t1)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    t2 = [gen_vector(rho, eta, gamma, m, pp, K) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">512</span>)]<br>    <span class="hljs-built_in">print</span>(t2)<br><br></code></pre></td></tr></table></figure><p><code>t1</code>å’Œ<code>t2</code>ç”±è‹¥å¹²ä¸ª$K*v$ç»„æˆã€‚(è¿™ä¸ªä¸åº”è¯¥æ˜¯$v*K$å—ï¼Ÿ)<br>$$<br>\begin{align}<br>K*v &amp;&#x3D;<br>\left[<br>\begin{matrix}<br>  k_{11} &amp; k_{12} &amp; k_{13}\\<br>  k_{21} &amp; k_{22} &amp; k_{23}\\<br>  k_{31} &amp; k_{32} &amp; k_{33}<br>\end{matrix}<br>\right]<br>*<br>\left[<br>\begin{matrix}<br>  (pp*r_{226}+r_6) &amp; (pp*rr_{226}+rr_6) &amp; (pp*rrr_{226}+rrr_6)<br>\end{matrix}<br>\right]<br>\\&amp;&#x3D;<br>\left[<br>\begin{matrix}<br>  a_1*pp+b_1 &amp; a_2*pp+b_2 &amp; a_3*pp+b_3<br>\end{matrix}<br>\right]<br>\end{align}<br>$$</p><p>å…¶ä¸­$a_i,b_i$è¡¨ç¤ºå¦‚ä¸‹<br>$$<br>\begin{align}<br>a_i &amp;&#x3D; k_{1i}*r_{226}+k_{2i}*rr_{226}+k_{3i}*rrr_{226}\\<br>b_i &amp;&#x3D; k_{1i}*r_{6}+k_{2i}*rr_{6}+k_{3i}*rrr_{6}<br>\end{align}<br>$$<br>æœ‰è¿™ä¹ˆå¤šå½¢å¦‚$a*pp+b$ï¼Œå¯ä»¥é€šè¿‡æ¶ˆå»$b$ç„¶åæ±‚å…¬çº¦æ•°å¾—åˆ°$pp$ï¼Œæœ€å$coppersmith$å·²çŸ¥é«˜ä½æ±‚ä½ä½æ±‚è§£$p$ã€‚</p><p>è¿™é‡Œéœ€è¦ç”¨åˆ°<u>ç”Ÿæ—¥æ”»å‡»</u>ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºåœ¨è¿™ä¹ˆå¤šæ•°ä¸­ï¼Œæœ‰å¾ˆå¤§æ¦‚ç‡å­˜åœ¨ç›¸åŒ$r_6,r_6,râ€™â€™_6$ï¼Œå› æ­¤å¯ä»¥å¾ªç¯éå†ä¸€ä¸‹æ‰€æœ‰çš„$K*v$ã€‚</p><p>ç®—ä¸€ä¸‹å¤§è‡´çš„æ¦‚ç‡ã€‚$r_6,r_6,râ€™â€™_6$çš„ç»„åˆæœ‰$2^{18}$ç§å¯èƒ½ï¼Œæ‰€ç»™æ•°æ®æœ‰$3072$ä¸ªï¼Œå¥—ç”¨å…¬å¼å¾—å­˜åœ¨ç›¸åŒçš„æ¦‚ç‡è¿‘ä¼¼$100\%$ã€‚</p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> gcd,is_prime,invert<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>e = <span class="hljs-number">65537</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;output10.txt&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    n = <span class="hljs-built_in">int</span>(f.readline().decode())<br>    c = <span class="hljs-built_in">int</span>(f.readline().decode())<br>    L = <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    L += <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    L += <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    L += <span class="hljs-built_in">eval</span>(f.readline().decode())<br>    L += <span class="hljs-built_in">eval</span>(f.readline().decode())<br><br><span class="hljs-built_in">print</span>(n)<br><span class="hljs-built_in">print</span>(c)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(L))):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i+<span class="hljs-number">1</span>,<span class="hljs-built_in">len</span>(L)):<br>        x1 = L[i][<span class="hljs-number">0</span>] - L[j][<span class="hljs-number">0</span>]<br>        x2 = L[i][<span class="hljs-number">1</span>] - L[j][<span class="hljs-number">1</span>]<br>        pp = <span class="hljs-built_in">int</span>(gcd(x1,x2))<br>        <span class="hljs-keyword">if</span> pp.bit_length() == <span class="hljs-number">288</span> <span class="hljs-keyword">and</span> is_prime(pp):<br>            R.&lt;x&gt; = PolynomialRing(Zmod(n))<br>            f = (pp &lt;&lt; <span class="hljs-number">224</span>) + x<br>            re = f.small_roots(X = <span class="hljs-number">2</span>^<span class="hljs-number">224</span>,beta=<span class="hljs-number">0.4</span>)<br>            <span class="hljs-keyword">if</span> re:<br>                p = <span class="hljs-built_in">int</span>(f(re[<span class="hljs-number">0</span>]))<br>                q = n//p<br>                phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>                d = <span class="hljs-built_in">int</span>(invert(e,phi))<br>                m = <span class="hljs-built_in">pow</span>(c,d,n)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;p=<span class="hljs-subst">&#123;p&#125;</span>,q=<span class="hljs-subst">&#123;q&#125;</span>&#x27;</span>)<br>                <span class="hljs-built_in">print</span>(long_to_bytes(m))<br>                <br><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/u010883831/article/details/126944260">ã€2022 ç¬¬äº”ç©ºé—´ã€‘5_vgcd WriteUP_Mr_AgNO3çš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç”Ÿæ—¥æ”»å‡»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022æ±Ÿè¥¿çœæŒ¯å…´æ¯</title>
    <link href="/2022/10/03/2022%E6%B1%9F%E8%A5%BF%E7%9C%81%E6%8C%AF%E5%85%B4%E6%9D%AF/"/>
    <url>/2022/10/03/2022%E6%B1%9F%E8%A5%BF%E7%9C%81%E6%8C%AF%E5%85%B4%E6%9D%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="ç®€å•çš„RSAç®—æ³•"><a href="#ç®€å•çš„RSAç®—æ³•" class="headerlink" title="ç®€å•çš„RSAç®—æ³•"></a>ç®€å•çš„RSAç®—æ³•</h2><p>yafuåˆ†è§£nï¼Œå¾—åˆ°p,qï¼Œç„¶åè¿›è¡Œè§£å¯†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>c = <span class="hljs-number">127787005372346984201114973214509899116</span><br>n = <span class="hljs-number">249875510135225835839025820066377585461</span><br>p = <span class="hljs-number">15849223833777174791</span><br>q = <span class="hljs-number">15765788454744518371</span><br>e = <span class="hljs-number">16573</span><br><span class="hljs-keyword">assert</span> n == p*q<br>d = gmpy2.invert(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(c,d,n))<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br></code></pre></td></tr></table></figure><p>å¾—åˆ°</p><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sml">b&#x27;&#125;c2s_45R_Xj&#123;galf&#x27;<br></code></pre></td></tr></table></figure><p>åè¿‡æ¥å°±æ˜¯flag</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">flag</span><span class="hljs-template-variable">&#123;jX_R54_s2c&#125;</span><br></code></pre></td></tr></table></figure><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="PLCæµé‡åˆ†æ"><a href="#PLCæµé‡åˆ†æ" class="headerlink" title="PLCæµé‡åˆ†æ"></a>PLCæµé‡åˆ†æ</h2><p>è¿›è¡Œæµé‡è¿½è¸ªï¼Œå‘ç°äº†å¯ç–‘å­—ç¬¦<code>flag&#123;fake_flag&#125;</code>å’Œ<code>R3</code>ä»¥åŠ<code>41</code>ã€‚å¹¶ä¸”ä¼¼ä¹æ‰¾åˆ°äº†è§„å¾‹ï¼Œå°±æ˜¯æ¯ä¸€æ¬¡å‘é€è¿™äº›å­—ç¬¦å‰éƒ½ä¼šåŒæ–¹éƒ½ä¼šå‘é€ä¸€ç³»åˆ—å¯æ‰“å°å­—ç¬¦ï¼Œä½œä¸ºå¼€å¤´ã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032138795.png"/><p>å°è¯•å°†<code>flag&#123;R341&#125;</code>ä½œä¸ºflagï¼Œç»“æœä¸è¡Œã€‚çœ‹åˆ°<code>fake</code>æƒ³åˆ°äº†<code>real</code>ï¼Œè€Œè·Ÿè¿™ä¸ªç›¸ä¼¼çš„å°±æ˜¯<code>R341</code>äº†ï¼Œäºæ˜¯è¿›è¡Œæ›¿æ¢ã€‚å¾—åˆ°flag</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">flag</span><span class="hljs-template-variable">&#123;R341_flag&#125;</span><br></code></pre></td></tr></table></figure><h2 id="æµé‡ä¸­çš„ç¥ç§˜ä¿¡æ¯"><a href="#æµé‡ä¸­çš„ç¥ç§˜ä¿¡æ¯" class="headerlink" title="æµé‡ä¸­çš„ç¥ç§˜ä¿¡æ¯"></a>æµé‡ä¸­çš„ç¥ç§˜ä¿¡æ¯</h2><p>æ‰”è¿›<code>Wireshark</code>è¿›è¡Œæµé‡è¿½è¸ªï¼Œç»è¿‡å¤šæ¬¡å°è¯•æ‰¾åˆ°äº†çœŸæ­£çš„flag</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032139868.png"/><p>å³</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">flag&#123;d2UxY29tZVQwQ2hpbmE<span class="hljs-operator">=</span>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œæ‹¬å·å†…çš„è¦è¿›è¡ŒBase64è§£ç ï¼Œæœ€ç»ˆflagä¸º</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">flag</span><span class="hljs-template-variable">&#123;we1comeT0China&#125;</span><br></code></pre></td></tr></table></figure><h2 id="modbusæµé‡åˆ†æ"><a href="#modbusæµé‡åˆ†æ" class="headerlink" title="modbusæµé‡åˆ†æ"></a>modbusæµé‡åˆ†æ</h2><p>æ‰”è¿›<code>Wireshark</code>è¿›è¡Œåˆ†æï¼Œæµé‡è¿½è¸ªå¹¶æ²¡æœ‰çœ‹å‡ºæœ‰ç”¨çš„å†…å®¹ã€‚äºæ˜¯å°è¯•æ‰¾æœ€é•¿çš„åŒ…ï¼Œå‘ç°äº†å¯ç–‘çš„å†…å®¹ã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032139553.png"/><p>å°†è¿™äº›æ”¶é›†èµ·æ¥å¹¶ç›´æ¥<code>chr()</code>æˆå­—ç¬¦ï¼Œå¯æƒœå¹¶ä¸æ˜¯è¿™ä¹ˆæ“ä½œ</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032139228.png"/><p>ä½†æå¤§æ¦‚ç‡è¿™æ˜¯flagã€‚å°è¯•ä¸flagçš„å›ºå®šæ ¼å¼è¿›è¡ŒåŒ¹é…ï¼Œå‘ç°äº†è§„å¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">m = <span class="hljs-string">&#x27;153 147 158 152 132 146 144 155 157 138 140 160 150 140 160 154 158 140 134 130&#x27;</span>.split()<br>m = [<span class="hljs-built_in">int</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> m]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> m:<br>    <span class="hljs-built_in">print</span>(i, end=<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-built_in">print</span>()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;flag&#123;&#x27;</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">ord</span>(i), end=<span class="hljs-string">&#x27; &#x27;</span>)<br></code></pre></td></tr></table></figure><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032139116.png"/><p>è§„å¾‹ä¸ºå¯¹åº”æ•°å­—è¿›è¡Œç›¸åŠ æ€»ä¸º255ã€‚äºæ˜¯è§£å¯†è„šæœ¬ä¸º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">m = <span class="hljs-string">&#x27;153 147 158 152 132 146 144 155 157 138 140 160 150 140 160 154 158 140 134 130&#x27;</span>.split()<br>m = [<span class="hljs-built_in">int</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> m]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> m:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(<span class="hljs-number">255</span>-i),end=<span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>å¾—åˆ°flag</p><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ceylon">flag&#123;modbus<span class="hljs-number">_</span><span class="hljs-keyword">is</span><span class="hljs-number">_</span>easy&#125;<br></code></pre></td></tr></table></figure><h1 id="STAGE"><a href="#STAGE" class="headerlink" title="STAGE"></a>STAGE</h1><h2 id="PCLå›¾ç‰‡åˆ†æ"><a href="#PCLå›¾ç‰‡åˆ†æ" class="headerlink" title="PCLå›¾ç‰‡åˆ†æ"></a>PCLå›¾ç‰‡åˆ†æ</h2><p>æ”¾å…¥winhexåˆ†æï¼Œæœ€åé¢æœ‰flag.txtï¼Œæ›´æ”¹åç¼€ä¸ºzipï¼Œé‡Œé¢æœ‰ä¸€ä¸ªéœ€è¦å¯†ç çš„flag.txtã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032140550.png"/><p>ä»æ›´æ”¹å›¾ç‰‡å®½é«˜å…¥æ‰‹ï¼Œæ‰¾åˆ°äº†éƒ¨åˆ†å¯†ç </p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032140311.png"/><p>è¿›è¡Œæ¨¡æ¿çˆ†ç ´ï¼Œ</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032140256.png"/><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032140459.png"/><p>æœ€ç»ˆå¾—åˆ°flag</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">flag</span><span class="hljs-template-variable">&#123;plc_sec_master&#125;</span><br></code></pre></td></tr></table></figure><h2 id="å·¥æ§ä¸»æœºä¸­çš„å¼‚å¸¸æ–‡ä»¶"><a href="#å·¥æ§ä¸»æœºä¸­çš„å¼‚å¸¸æ–‡ä»¶" class="headerlink" title="å·¥æ§ä¸»æœºä¸­çš„å¼‚å¸¸æ–‡ä»¶"></a>å·¥æ§ä¸»æœºä¸­çš„å¼‚å¸¸æ–‡ä»¶</h2><p>æ‰”å…¥winhexåˆ†æï¼Œå‘ç°å°¾éƒ¨æœ‰<code>oru-flag.jpg</code>ï¼Œç›´æ¥å°†æ–‡ä»¶åç¼€æ”¹æˆ<code>.zip</code>ä¸è¡Œã€‚ä»”ç»†è§‚å¯Ÿå‘ç°é¦–éƒ¨æ–‡ä»¶å¤´ä¸º<code>KP</code>ï¼Œ</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032141410.png"/><p>ä½†æˆ‘åªè§è¿‡<code>PK</code>çš„æ–‡ä»¶å¤´ã€‚äºæ˜¯å°†<code>04034B50</code>æ›´æ”¹æˆ<code>504B0304</code>ï¼Œæ›´æ”¹åç¼€åä¸º<code>.zip</code>ã€‚å¾—åˆ°éœ€è¦å¯†ç çš„jpgå›¾ç‰‡ã€‚</p><p>ç”¨çˆ†ç ´å·¥å…·è¿›è¡Œçˆ†ç ´ï¼Œä¸€å¼€å§‹å°è¯•å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼Œåˆ°åé¢çˆ†ç ´æ—¶é—´å¤ªé•¿å°±å‡å°‘å­—ç¬¦é›†ï¼Œæœ€ç»ˆå¾—åˆ°</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032141180.png"/><p>å›¾ç‰‡ä¸­å«æœ‰flag</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032141323.png"/><h1 id="PPC"><a href="#PPC" class="headerlink" title="PPC"></a>PPC</h1><h2 id="è¢«æˆªè·çš„æœºå¯†æ–‡ä»¶"><a href="#è¢«æˆªè·çš„æœºå¯†æ–‡ä»¶" class="headerlink" title="è¢«æˆªè·çš„æœºå¯†æ–‡ä»¶"></a>è¢«æˆªè·çš„æœºå¯†æ–‡ä»¶</h2><p>æ‰”è¿›winhexæ‰“å¼€ï¼Œå‘ç°æ–‡ä»¶å¤´ä¸ºPKï¼Œæ›´æ”¹æ–‡ä»¶åç¼€ä¸º.zipã€‚è§£å‹ç¼©å¾—åˆ°ä¸€ç³»åˆ—æ–‡ä»¶ã€‚</p><p>ä¾æ¬¡æŸ¥çœ‹è¿™äº›æ–‡ä»¶ï¼Œå‘ç°<code>func1.fcb</code>ï¼ˆè¿™æ–‡ä»¶åå–çš„è®©äººå®¹æ˜“çŸ¥é“è¿™æ˜¯å®ç°å•¥åŠŸèƒ½çš„æ¨¡å—ä»£ç ï¼‰é‡Œé¢æœ‰æœ‰ä¸€æ®µå¼‚æˆ–çš„åŠ å¯†ä»£ç ï¼Œ</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210032141034.png"/><p>æ ¹æ®ä¸Šè¿°ä»£ç ï¼Œå·²çŸ¥<code>buf</code>å’Œ<code>var</code>ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯æ±‚<code>W</code>ã€‚å†™å‡ºpythonè„šæœ¬å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">buf = [<span class="hljs-number">177</span>, <span class="hljs-number">146</span>, <span class="hljs-number">158</span>, <span class="hljs-number">156</span>, <span class="hljs-number">137</span>, <span class="hljs-number">148</span>, <span class="hljs-number">146</span>, <span class="hljs-number">147</span>, <span class="hljs-number">180</span>, <span class="hljs-number">142</span>, <span class="hljs-number">188</span>, <span class="hljs-number">137</span>, <span class="hljs-number">204</span>, <span class="hljs-number">197</span>, <span class="hljs-number">205</span>, <span class="hljs-number">203</span>, <span class="hljs-number">186</span>, <span class="hljs-number">143</span>, <span class="hljs-number">156</span>, <span class="hljs-number">147</span>, <span class="hljs-number">153</span>, <span class="hljs-number">139</span>, <span class="hljs-number">148</span>, <span class="hljs-number">152</span>, <span class="hljs-number">138</span>, <span class="hljs-number">181</span>, <span class="hljs-number">146</span>, <span class="hljs-number">137</span>, <span class="hljs-number">152</span>, <span class="hljs-number">145</span>]<br>var = <span class="hljs-number">0xfd</span><br>text = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>    val = buf[i] ^ var<br>    text += <span class="hljs-built_in">chr</span>(val)<br><br><span class="hljs-built_in">print</span>(text)<br><span class="hljs-comment">#LocationIsAt1806GrandviewHotel</span><br></code></pre></td></tr></table></figure><p>å¾—åˆ°flag</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">flag</span><span class="hljs-template-variable">&#123;LocationIsAt1806GrandviewHotel&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>æµé‡åˆ†æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Githubå›¾åºŠæ­å»ºé—®é¢˜</title>
    <link href="/2022/10/03/Github%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA%E9%97%AE%E9%A2%98/"/>
    <url>/2022/10/03/Github%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>æˆ‘æ‰€é‡è§çš„é—®é¢˜æ˜¯è¿™æ ·çš„ã€‚ä½¿ç”¨PicGo+Githubæ­å»ºå›¾åºŠï¼Œè™½ç„¶PicGoä¸Šä¼ å›¾ç‰‡æˆåŠŸäº†ï¼Œä½†æ˜¯åœ¨ç›¸å†Œå’Œç½‘ç«™ä¸Šéƒ½æ— æ³•æ˜¾ç¤ºï¼Œå°è¯•è¿‡ç½‘ä¸Šçš„ä¸€äº›æ–¹æ³•ï¼ˆé‡å¤çš„æ–‡ç« çœŸçš„å¤šï¼ï¼‰ï¼Œæ— ä¸€ä¾‹å¤–éƒ½æ²¡æœ‰æ•ˆæœã€‚åç»è‡ªå·±çš„çŒœæƒ³å’Œå®è·µï¼Œå°†é—®é¢˜è§£å†³äº†ã€‚</p><hr><p>ä¸€å¼€å§‹PicGoä¸Šçš„Githubé…ç½®æˆ‘æ˜¯æŒ‰ç…§ç½‘ä¸Šé…ç½®çš„ã€‚ï¼ˆä¸»è¦æ˜¯æ”¹äº†æˆ‘ä¹Ÿä¸è®°å¾—ä¹‹å‰çš„é…ç½®äº†ï¼‰</p><p>å°†ä¸Šä¼ æˆåŠŸçš„å›¾ç‰‡åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œå…¶urlä¸º</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031052750.png"/><p>ä½†æ˜¯åœ¨Githubçš„ä»“åº“é‡Œï¼Œå°†å›¾ç‰‡æ‹–å‡ºæ¥æŸ¥çœ‹ï¼Œå…¶urlå´æ˜¯è¿™æ ·çš„</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031055720.png"/><p>æŒ‰é“ç†ä¸¤è€…urlåº”è¯¥ä¸€è‡´æ‰å¯¹ï¼Œæ‰€ä»¥PicGoä¸Šçš„Githubçš„åŸŸååº”è¯¥æ”¹ä¸ºèƒ½æˆåŠŸçœ‹åˆ°çš„åŸŸåï¼ˆå³å°†&#x2F;imgå‰é¢çš„å¤åˆ¶ç²˜è´´è¿‡æ¥å°±å¯ä»¥äº†ï¼‰</p><p>æˆ‘è¿™é‡Œçš„é…ç½®å¦‚ä¸‹</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/gal2xy/</span>blog_img<span class="hljs-regexp">/main/</span><br></code></pre></td></tr></table></figure><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031102486.png"/><p>äºæ˜¯å°±å¯ä»¥åœ¨ç›¸å†Œä¸­æŸ¥çœ‹ï¼Œåšå®¢ä¸Šä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤ºã€‚</p><hr><p>2022&#x2F;10&#x2F;6</p><p>è¿™ä¸ªæ–¹æ³•æœ‰æ—¶å€™ä¼šå¤±æ•ˆï¼Œæ·¦ï¼Œå¤ªéš¾å—äº†ã€‚</p><hr><p>203&#x2F;7&#x2F;4</p><p>å› ä¸ºTokenè¿‡æœŸï¼Œé‡æ–°é…ç½®åï¼Œä»ç„¶æ— æ³•æ˜¾ç¤ºå›¾ç‰‡ã€‚ä¸è¿‡å¥½åœ¨å¯»æ‰¾åˆ°äº†æ–¹æ³•ï¼š<a href="https://blog.csdn.net/ZMMMOO/article/details/127270446">picgoä½¿ç”¨githubåšå›¾åºŠï¼Œå›¾ç‰‡åœ¨ç›¸å†Œä¸æ˜¾ç¤ºï¼Œåœ¨githubä¸Šä¹Ÿæ— æ³•æŸ¥çœ‹_picgoç›¸å†Œé‡Œæ˜¾ç¤ºä¸äº†å›¾ç‰‡_è‚‰ä¸ä¸åˆ‡ç‰‡çš„åšå®¢-CSDNåšå®¢</a></p><p>åŸå› æ˜¯<code>GitHub</code>çš„<code>raw.githubusercontent.com</code>åŸŸåè§£æè¢«æ±¡æŸ“äº†ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>å›¾åºŠæ­å»º</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022ByteCTF</title>
    <link href="/2022/10/02/2022ByteCTF/"/>
    <url>/2022/10/02/2022ByteCTF/</url>
    
    <content type="html"><![CDATA[<h1 id="2022ByteCTF"><a href="#2022ByteCTF" class="headerlink" title="2022ByteCTF"></a>2022ByteCTF</h1><h2 id="CardShark"><a href="#CardShark" class="headerlink" title="CardShark"></a>CardShark</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3.9</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> socketserver<br><span class="hljs-keyword">import</span> signal<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> urandom<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">from</span> flag <span class="hljs-keyword">import</span> FLAG<br><br>BANNER = <span class="hljs-string">rb&quot;&quot;&quot;</span><br><span class="hljs-string">.--------.--------.--------.--------.     .--------.--------.--------.--------.--------.</span><br><span class="hljs-string">| C.--.  | A.--.  | R.--.  | D.--.  |.-.  | S.--.  | H.--.  | A.--.  | R.--.  | K.--.  |</span><br><span class="hljs-string">|  :/\:  |  (\/)  |  :():  |  :/\:  (( )) |  :/\:  |  :/\:  |  (\/)  |  :():  |  :/\:  |</span><br><span class="hljs-string">|  :\/:  |  :\/:  |  ()()  |  (__)  |&#x27;-.-.|  :\/:  |  (__)  |  :\/:  |  ()()  |  :\/:  |</span><br><span class="hljs-string">|  &#x27;--&#x27;C |  &#x27;--&#x27;A |  &#x27;--&#x27;R |  &#x27;--&#x27;D | (( ))  &#x27;--&#x27;S |  &#x27;--&#x27;H |  &#x27;--&#x27;A |  &#x27;--&#x27;R |  &#x27;--&#x27;K |</span><br><span class="hljs-string">`--------`--------`--------`--------&#x27;  &#x27;-&#x27;`--------`--------`--------`--------`--------&#x27;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Card</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        random.seed(urandom(<span class="hljs-number">32</span>))<br>        self.cards = []<br>        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;Hearts&#x27;</span>, <span class="hljs-string">&#x27;Spades&#x27;</span>, <span class="hljs-string">&#x27;Diamonds&#x27;</span>, <span class="hljs-string">&#x27;Clubs&#x27;</span>):<br>            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>):<br>                self.cards.append(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;p&#125;</span> <span class="hljs-subst">&#123;t&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">deal</span>(<span class="hljs-params">self</span>):<br>        n = random.getrandbits(<span class="hljs-number">4</span>)<br>        <span class="hljs-keyword">return</span> self.cards[n]<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span>(socketserver.BaseRequestHandler):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_recv_all</span>(<span class="hljs-params">self</span>):<br>        BUFF_SIZE = <span class="hljs-number">1024</span><br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            part = self.request.recv(BUFF_SIZE)<br>            data += part<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(part) &lt; BUFF_SIZE:<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">return</span> data.strip()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, msg, newline=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(msg, <span class="hljs-built_in">str</span>):<br>            msg = msg.encode()<br>        <span class="hljs-keyword">if</span> newline:<br>            msg += <span class="hljs-string">b&#x27;\n&#x27;</span><br>        self.request.sendall(msg)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recv</span>(<span class="hljs-params">self, prompt=<span class="hljs-string">&#x27;&gt; &#x27;</span></span>):<br>        self.send(prompt, newline=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">return</span> self._recv_all()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">proof_of_work</span>(<span class="hljs-params">self</span>):<br>        random.seed(urandom(<span class="hljs-number">32</span>))<br>        alphabet = string.ascii_letters + string.digits<br>        proof = <span class="hljs-string">&#x27;&#x27;</span>.join(random.choices(alphabet, k=<span class="hljs-number">32</span>))<br>        hash_value = sha256(proof.encode()).hexdigest()<br>        self.send(<span class="hljs-string">f&#x27;sha256(XXXX+<span class="hljs-subst">&#123;proof[<span class="hljs-number">4</span>:]&#125;</span>) == <span class="hljs-subst">&#123;hash_value&#125;</span>&#x27;</span>)<br>        nonce = self.recv(prompt=<span class="hljs-string">&#x27;Give me XXXX &gt; &#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nonce) != <span class="hljs-number">4</span> <span class="hljs-keyword">or</span> sha256(nonce + proof[<span class="hljs-number">4</span>:].encode()).hexdigest() != hash_value:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">timeout_handler</span>(<span class="hljs-params">self, signum, frame</span>):<br>        <span class="hljs-keyword">raise</span> TimeoutError<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">try</span>:<br>            self.send(BANNER)<br><br>            signal.signal(signal.SIGALRM, self.timeout_handler)<br>            signal.alarm(<span class="hljs-number">60</span>)<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.proof_of_work():<br>                self.send(<span class="hljs-string">&#x27;Wrong!&#x27;</span>)<br>                <span class="hljs-keyword">return</span><br><br>            card = Card()<br>            coin = <span class="hljs-number">5200</span><br>            count = <span class="hljs-number">0</span><br><br>            self.send(<span class="hljs-string">&#x27;Greetings! I will give you my secret, if you can guess my card 200 times in a row. &#x27;</span><br>                      <span class="hljs-string">&#x27;One coin, one chance.&#x27;</span>)<br><br>            signal.alarm(<span class="hljs-number">3600</span>)<br><br>            <span class="hljs-keyword">while</span> coin &gt; <span class="hljs-number">0</span>:<br>                coin -= <span class="hljs-number">1</span><br>                c = card.deal()<br>                r = self.recv(prompt=<span class="hljs-string">&#x27;Your guess &gt; &#x27;</span>).decode(<span class="hljs-string">&#x27;l1&#x27;</span>)<br>                <span class="hljs-keyword">if</span> r == c:<br>                    count += <span class="hljs-number">1</span><br>                    self.send(<span class="hljs-string">f&#x27;Correct! Your progress: <span class="hljs-subst">&#123;count&#125;</span>/200.&#x27;</span>)<br>                    <span class="hljs-keyword">if</span> count &gt;= <span class="hljs-number">200</span>:<br>                        self.send(<span class="hljs-string">&#x27;You are the Card Shark! Flag is yours:&#x27;</span>)<br>                        self.send(FLAG)<br>                        <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">else</span>:<br>                    count = <span class="hljs-number">0</span><br>                    self.send(<span class="hljs-string">f&#x27;Sorry! My card is <span class="hljs-subst">&#123;c&#125;</span>.&#x27;</span>)<br><br>            <span class="hljs-keyword">if</span> coin == <span class="hljs-number">0</span>:<br>                self.send(<span class="hljs-string">&#x27;You have no money! See you another day.&#x27;</span>)<br><br>            self.send(<span class="hljs-string">&#x27;Bye!&#x27;</span>)<br><br>        <span class="hljs-keyword">except</span> TimeoutError:<br>            self.send(<span class="hljs-string">&#x27;Timeout!&#x27;</span>)<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br>        <span class="hljs-keyword">finally</span>:<br>            self.request.close()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ForkedServer</span>(socketserver.ForkingMixIn, socketserver.TCPServer):<br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    HOST, PORT = <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">10000</span><br>    <span class="hljs-built_in">print</span>(HOST, PORT)<br>    server = ForkedServer((HOST, PORT), Task)<br>    server.allow_reuse_address = <span class="hljs-literal">True</span><br>    server.serve_forever()<br><br></code></pre></td></tr></table></figure><p>å®¡è®¡ä»£ç ï¼Œå®¹æ˜“çœ‹å‡ºå…ˆæ˜¯å››ä½å“ˆå¸Œçˆ†ç ´ï¼Œç„¶åæ˜¯éšæœºæ•°é¢„æµ‹é—®é¢˜ã€‚ä½†èµ·åˆä»¥ä¸ºå¯ä»¥ç”¨RandCrackæ¥è§£å†³è¿™ä¸ªéšæœºæ•°é¢„æµ‹é—®é¢˜ï¼Œçœ‹æ¥æ˜¯æƒ³ç®€å•äº†ã€‚</p><p>éšå³é¢„æµ‹å·¥å…·ï¼š<a href="https://github.com/JuliaPoo/MT19937-Symbolic-Execution-and-Solver">JuliaPoo&#x2F;MT19937-Symbolic-Execution-and-Solver: Python implementation of a symbolic execution of MT19937 and a solver for GF(2) matrices (github.com)</a></p><p>ç›¸ä¼¼é¢˜ç›®ï¼š<a href="https://www.anquanke.com/post/id/205861#h3-9">æµ…æMT19937ä¼ªéšæœºæ•°ç”Ÿæˆç®—æ³•-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">from</span> randcrack <span class="hljs-keyword">import</span> RandCrack<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">from</span> MT19937 <span class="hljs-keyword">import</span> MT19937, MT19937_symbolic<br><br>alphabet = string.ascii_letters + string.digits<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">proof</span>(<span class="hljs-params"><span class="hljs-built_in">hash</span>, part</span>):<br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> alphabet:<br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> alphabet:<br>            <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> alphabet:<br>                <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> alphabet:<br>                    s = (a+b+c+d).encode() + part<br>                    <span class="hljs-keyword">if</span> sha256(s).hexdigest() == <span class="hljs-built_in">hash</span>.decode():<br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Found XXXX: <span class="hljs-subst">&#123;a+b+c+d&#125;</span>&#x27;</span>)<br>                        <span class="hljs-keyword">return</span> a+b+c+d<br><br><br>ID = <span class="hljs-string">&#x27;dcb894124cb27c186d8a996bdbb43602&#x27;</span><br>s = remote(ID + <span class="hljs-string">&#x27;.2022.capturetheflag.fun&#x27;</span>, <span class="hljs-number">1337</span>, ssl=<span class="hljs-literal">True</span>)<br>s.recvuntil(<span class="hljs-string">b&#x27;XXX+&#x27;</span>)<br>part = s.recvuntil(<span class="hljs-string">b&#x27;)&#x27;</span>)[:-<span class="hljs-number">1</span>]<br>s.recvuntil(<span class="hljs-string">b&#x27;== &#x27;</span>)<br><span class="hljs-built_in">hash</span> = s.recvline()[:-<span class="hljs-number">1</span>]<br><br>s.send(proof(<span class="hljs-built_in">hash</span>, part).encode())<br><br>cards = []<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;Hearts&#x27;</span>, <span class="hljs-string">&#x27;Spades&#x27;</span>, <span class="hljs-string">&#x27;Diamonds&#x27;</span>, <span class="hljs-string">&#x27;Clubs&#x27;</span>):<br>     <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>):<br>           cards.append(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;p&#125;</span> <span class="hljs-subst">&#123;t&#125;</span>&#x27;</span>)<br><br>known = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-number">4992</span>)):<br>    s.send(<span class="hljs-string">&#x27;J&#x27;</span>.encode())<br>    s.recvuntil(<span class="hljs-string">b&#x27;is &#x27;</span>)<br>    key = s.recvline()[:-<span class="hljs-number">2</span>].decode()<br>    pos = cards.index(key)<br>    known.append(pos)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">#é¢„æµ‹</span><br><span class="hljs-string">rc = RandCrack()</span><br><span class="hljs-string">for i in known:</span><br><span class="hljs-string">    rc.submit(i)</span><br><span class="hljs-string"></span><br><span class="hljs-string">cnt = 0</span><br><span class="hljs-string">for i in tqdm(range(205)):</span><br><span class="hljs-string">    pos = rc.predict_getrandbits(4)</span><br><span class="hljs-string">    s.send(cards[pos].encode())</span><br><span class="hljs-string">    res = s.recvline().decode()</span><br><span class="hljs-string">    print(res)</span><br><span class="hljs-string">    if &#x27;Correct&#x27; in res:</span><br><span class="hljs-string">        cnt += 1</span><br><span class="hljs-string">        if cnt &gt;= 200:</span><br><span class="hljs-string">            s.interactive()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#é¢„æµ‹</span><br>rc = MT19937(state_from_data=(known, <span class="hljs-number">4</span>))<br><br><span class="hljs-comment">#å¥½åƒä¸€å¼€å§‹æ˜¯åˆå§‹æ€ï¼Œå¾—å…ˆè¿‡4992ä¸ª</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> known:<br>    <span class="hljs-keyword">assert</span> i == rc() &gt;&gt; (<span class="hljs-number">32</span>-<span class="hljs-number">4</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Cloning successful!&quot;</span>)<br><br>cnt = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">205</span>):<br>    pos = rc() &gt;&gt; (<span class="hljs-number">32</span>-<span class="hljs-number">4</span>)<br>    <span class="hljs-comment"># s.sendlineafter(b&#x27;Your guess &gt; &#x27;, cards[pos].encode())</span><br>    s.send(cards[pos].encode())<br>    res = s.recvline().decode()<br>    <span class="hljs-built_in">print</span>(res)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Correct&#x27;</span> <span class="hljs-keyword">in</span> res:<br>        cnt += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> cnt &gt;= <span class="hljs-number">200</span>:<br>            s.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="Compare"><a href="#Compare" class="headerlink" title="Compare"></a>Compare</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> getPrime, getRandomNBitInteger, inverse<br><span class="hljs-keyword">from</span> fractions <span class="hljs-keyword">import</span> Fraction<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> lcm<br><span class="hljs-keyword">import</span> re<br><br>N = <span class="hljs-number">512</span><br>safe_expr = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;^([-+*/0-9.~%^&amp;()=|&lt;&gt;]|and|or|not|MSG)+$&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">m, n, g</span>):<br>    r = getRandomNBitInteger(N)<br>    c = <span class="hljs-built_in">pow</span>(g, m, n*n) * <span class="hljs-built_in">pow</span>(r, n, n*n) % (n*n)<br>    <span class="hljs-keyword">return</span> c<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">c, n, l, u</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(Fraction(<span class="hljs-built_in">pow</span>(c, l, n * n) - <span class="hljs-number">1</span>, n) * u % n)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">round</span>(<span class="hljs-params">expr</span>):<br>    p = getPrime(N)<br>    q = getPrime(N)<br><br>    n = p * q<br>    g = getRandomNBitInteger(N)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n =&#x27;</span>, n)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;g =&#x27;</span>, g)<br><br>    a = getRandomNBitInteger(N)<br>    b = getRandomNBitInteger(N)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;a =&#x27;</span>, encode(a, n, g))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;b =&#x27;</span>, encode(b, n, g))<br><br>    msg = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;msg = &quot;</span>))<br><br>    l = <span class="hljs-built_in">int</span>(lcm(p - <span class="hljs-number">1</span>, q - <span class="hljs-number">1</span>))<br>    u = inverse(Fraction(<span class="hljs-built_in">pow</span>(g, l, n * n) - <span class="hljs-number">1</span>, n), n)<br><br>    <span class="hljs-keyword">return</span> (a &gt; b) <span class="hljs-keyword">is</span> <span class="hljs-built_in">bool</span>(<span class="hljs-built_in">eval</span>(expr, <span class="hljs-literal">None</span>, &#123;<span class="hljs-string">&#x27;MSG&#x27;</span>: decode(msg, n, l, u)&#125;))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    expr = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Hello, Give me your expr: &#x27;</span>)<br>    expr = re.sub(<span class="hljs-string">r&#x27;\s&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, expr)<br><br><br>    <span class="hljs-keyword">if</span> safe_expr.<span class="hljs-keyword">match</span>(expr) <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Hacker?&#x27;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Round:&#x27;</span>, i)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">round</span>(expr)<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;You lost.&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Congratulations!&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>).read())<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>PaillieråŒæ€åŠ å¯†ï¼Œç”±äºå…¶æ»¡è¶³åŠ æ³•åŒæ€ï¼Œå³<br>$$<br>\begin{cases}<br>E(a) &#x3D; g^a*r_1^n\quad mod\ n^2\\<br>E(b) &#x3D; g^b*r_2^n\quad mod\ n^2\\<br>\end{cases}<br>$$</p><p>$$<br>&#x3D;&#x3D;&gt; E(a+b) &#x3D; E(a)*E(b) &#x3D; g^{a+b}*(r_1*r_2)^n\quad mod\ n^2<br>$$</p><p>é‚£ä¹ˆè§£å¯†å°±ä¼šå¾—åˆ°<br>$$<br>D(E(a)*E(b))&#x3D;a+b<br>$$<br>æˆ‘ä»¬åªè¦ç¨å¾®æ”¹å˜ä¸€ä¸‹å°±å¯ä»¥å¾—åˆ°$a-b$ï¼Œè¿‡ç¨‹å¦‚ä¸‹</p><p>å¯¹$E(b)$å–é€†å¾—<br>$$<br>E(b)^{-1} &#x3D; g^{-b}*(r_2^{-1})^n\quad mod\ n^2<br>$$<br>$E(a)*E(b)^{-1}$å¾—<br>$$<br>E(a)*E(b)^{-1} &#x3D; g^{a-b}*(r_1*r_2^{-1})^n\quad mod\ n^2<br>$$<br>å› æ­¤è§£å¯†å°±å¾—åˆ°<br>$$<br>D(E(a)*E(b)^{-1})&#x3D;a-b<br>$$<br>å¦‚ä½•æ„é€ <code>expr</code>ï¼Ÿå¦‚æœ$a-b&gt;0$ï¼Œåˆ™$(a-b)\%2^{1024}&lt;&#x3D;2^{512}$ï¼Œä½†å¦‚æœ$a-b&lt;0$ï¼Œåˆ™$(a-b)\%n&gt;2^{512}$å·¦å³ï¼Œå› æ­¤å¯ä»¥æ„é€ <code>expr</code>ä¸º$MSG\%2^{1024}&lt;&#x3D;2^{512}$ã€‚å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®æ­£è´Ÿæ•°å¯¹æ•´é™¤ç¬¦å·çš„è¿ç®—ç»“æœçš„å·®å¼‚æ€§æ„é€ $MSG&#x2F;&#x2F;2^{512}&#x3D;&#x3D;0$ã€‚</p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> invert<br><br>ID = <span class="hljs-string">&#x27;dcb894124cb27c186d8a996bdbb43602&#x27;</span><br>s = remote(ID + <span class="hljs-string">&#x27;.2022.capturetheflag.fun&#x27;</span>, <span class="hljs-number">1337</span>, ssl=<span class="hljs-literal">True</span>)<br><br>MSG = <span class="hljs-string">b&#x27;MSG//2**512==0&#x27;</span><br>s.recvuntil(<span class="hljs-string">b&#x27;expr: &#x27;</span>)<br>s.send(MSG)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    s.recvuntil(<span class="hljs-string">b&#x27;n =&#x27;</span>)<br>    n = <span class="hljs-built_in">int</span>(s.recvline()[:-<span class="hljs-number">1</span>].decode())<br>    s.recvuntil(<span class="hljs-string">b&#x27;g =&#x27;</span>)<br>    g = <span class="hljs-built_in">int</span>(s.recvline()[:-<span class="hljs-number">1</span>].decode())<br>    s.recvuntil(<span class="hljs-string">b&#x27;a =&#x27;</span>)<br>    a = <span class="hljs-built_in">int</span>(s.recvline()[:-<span class="hljs-number">1</span>].decode())<br>    s.recvuntil(<span class="hljs-string">b&#x27;b =&#x27;</span>)<br>    b = <span class="hljs-built_in">int</span>(s.recvline()[:-<span class="hljs-number">1</span>].decode())<br>    inv_b = <span class="hljs-built_in">int</span>(invert(b, n**<span class="hljs-number">2</span>))<br>    msg = a*inv_b % (n**<span class="hljs-number">2</span>)<br>    s.recvuntil(<span class="hljs-string">b&#x27;msg = &#x27;</span>)<br>    s.send(<span class="hljs-built_in">str</span>(msg).encode())<br>    <span class="hljs-comment"># r.sendlineafter(b&#x27;msg = &#x27;, f&#x27;&#123;x&#125;&#x27;.encode())</span><br>s.interactive()<br></code></pre></td></tr></table></figure><h2 id="Choose-U-Flag"><a href="#Choose-U-Flag" class="headerlink" title="Choose_U_Flag"></a>Choose_U_Flag</h2><p>ç»™å‡ºä¸¤ä¸ªä»£ç ï¼Œå…¶ä¸­<code>task.py</code>å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> ast<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> signal<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> ZZ, Poly<br><span class="hljs-keyword">from</span> sympy.abc <span class="hljs-keyword">import</span> x<br><br><span class="hljs-keyword">from</span> ntru <span class="hljs-keyword">import</span> NTRUCipher<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exitHandler</span>(<span class="hljs-params">signum, frame</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;timeout&quot;</span>)<br>    exit()<br><br><br>signal.signal(signal.SIGALRM, exitHandler)<br>signal.alarm(<span class="hljs-number">30</span>)<br><br>flag = os.environ.get(<span class="hljs-string">&quot;CTF_CHALLENGE_FLAG&quot;</span>)<br><br>N = <span class="hljs-number">107</span><br>p = <span class="hljs-number">3</span><br>q = <span class="hljs-number">64</span><br><br>cipher = NTRUCipher(N, p, q)<br>cipher.generate()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]h_poly: <span class="hljs-subst">&#123;cipher.h_poly.all_coeffs()&#125;</span>&quot;</span>)<br><br>random_key = <span class="hljs-string">&#x27;&#x27;</span>.join(random.sample(string.printable, <span class="hljs-number">12</span>))<br>key_arr = np.unpackbits(np.frombuffer(random_key.encode(), dtype=np.uint8))<br>key_enc = cipher.encrypt(Poly(key_arr, x).set_domain(ZZ))<br>key_coeffs = key_enc.all_coeffs()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]key coeffs: <span class="hljs-subst">&#123;key_coeffs&#125;</span>&quot;</span>)<br><br>dec_data = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;decrypt data &gt; &quot;</span>)<br>dec_arr = ast.literal_eval(dec_data)<br><span class="hljs-keyword">if</span> dec_arr == key_coeffs:<br>    exit(-<span class="hljs-number">1</span>)<br>dec = cipher.decrypt(Poly(dec_arr, x).set_domain(ZZ))<br>dec_coeffs = dec.all_coeffs()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+]decrypt coeffs: <span class="hljs-subst">&#123;dec_coeffs&#125;</span>&quot;</span>)<br><br><span class="hljs-keyword">while</span> N &gt; <span class="hljs-number">0</span>:<br>    <span class="hljs-keyword">try</span>:<br>        u_key = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;u key &gt; &quot;</span>)<br>        <span class="hljs-keyword">if</span> u_key == random_key:<br>            <span class="hljs-built_in">print</span>(flag)<br>            exit(-<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;key err&quot;</span>)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;input err&quot;</span>)<br>    N = N - <span class="hljs-number">1</span><br><br></code></pre></td></tr></table></figure><p>ç»™å‡ºäº†$N,p,q,h,c$ï¼Œå…è®¸æˆ‘ä»¬æä¾›$câ€™(!&#x3D;c)$ï¼Œæ±‚å‡º$key$ã€‚å…¶å®åªè¦ç»™$c$åŠ ä¸ªæ¨¡æ•°å°±èƒ½ç»•è¿‡è¿™ä¸ªé™åˆ¶æ¡ä»¶ï¼Œä»è€Œå¾—åˆ°çš„è§£å¯†å†…å®¹å³ä¸º$key$ã€‚</p><p>æ ¹æ®NTRUçš„è§£å¯†è¿‡ç¨‹ï¼Œæœ‰<br>$$<br>a &#x3D; f*c\mod (q)<br>$$<br>å› ä¸ºæ¨¡æ•°æ˜¯$q$ï¼Œæ‰€ä»¥æ·»åŠ $q$ä»ç„¶å¯ä»¥å¾—åˆ°æ­£ç¡®çš„$a$<br>$$<br>a &#x3D; f*(c+q)&#x3D;f*c\mod (q)<br>$$</p><p>ä¸ç®¡NTRUæ˜¯å»ºç«‹åœ¨å¤šé¡¹å¼ä¸Šè¿˜æ˜¯æ•´æ•°ä¸Šï¼Œå…¶åŠ è§£å¯†åŸç†æ˜¯ä¸å˜çš„ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼ˆæ²¡ç¯å¢ƒäº†ï¼Œåªèƒ½è´´ä¸€ä¸‹åˆ«äººçš„ä»£ç ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>CHALLENGE_ID = <span class="hljs-string">&#x27;bb3fcb3fc9708bfdcdf710895615ba6e&#x27;</span><br>sh = remote(CHALLENGE_ID + <span class="hljs-string">&#x27;.2022.capturetheflag.fun&#x27;</span>, <span class="hljs-number">1337</span>, ssl=<span class="hljs-literal">True</span>)<br><br>sh.recvuntil(<span class="hljs-string">&quot;[+]key coeffs: &quot;</span>)<br>cipher = <span class="hljs-built_in">eval</span>(sh.recvline(<span class="hljs-literal">False</span>))<br>cipher[-<span class="hljs-number">1</span>] += <span class="hljs-number">64</span><br><br>sh.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>sh.sendline(<span class="hljs-built_in">str</span>(cipher).encode())<br><br>sh.recvuntil(<span class="hljs-string">&quot;coeffs: &quot;</span>)<br>key = <span class="hljs-built_in">eval</span>(sh.recvline(<span class="hljs-literal">False</span>))<br><br>tmp = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> key:<br>    tmp += <span class="hljs-built_in">str</span>(i)<br>res = long_to_bytes(<span class="hljs-built_in">int</span>(tmp, <span class="hljs-number">2</span>))<br>sh.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>sh.sendline(res)<br>flag = sh.recvline(<span class="hljs-literal">False</span>)<br><span class="hljs-built_in">print</span>(flag)<br><br><span class="hljs-comment"># sh.interactive()</span><br>sh.close()<br></code></pre></td></tr></table></figure><hr><p>è¦æ˜¯ä¸çŸ¥é“è¿™äº›å‡½æ•°çš„åŠŸèƒ½ï¼Œå°±æŒ¨ä¸ªè¯•ä¸€ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">random.sample(string.printable, <span class="hljs-number">12</span>)<span class="hljs-comment">#éšæœºäº§ç”Ÿ12ä¸ªå¯æ‰“å°å­—ç¬¦</span><br>np.frombuffer(random_key.encode(), dtype=np.uint8)<span class="hljs-comment">#è½¬æˆæ•°ç»„ï¼Œæ•°æ®å¥½åƒæ˜¯å­—ç¬¦ord()</span><br>np.unpackbits()<span class="hljs-comment">#è½¬æˆäºŒè¿›åˆ¶æ•°ç»„ï¼Œå³æ•°æ®äºŒè¿›åˆ¶åŒ–</span><br>Poly(key_arr, x).set_domain(ZZ)<span class="hljs-comment">#ä»¥key_arrçš„æ•°æ®ä¸ºç³»æ•°ï¼Œxä¸ºå˜é‡ï¼Œåœ¨æ•´æ•°åŸŸä¸Šçš„å¤šé¡¹å¼</span><br>np.zeros(<span class="hljs-built_in">len</span>)<span class="hljs-comment">#å…¨0æ•°ç»„,é•¿åº¦ä¸ºlen</span><br>np.ones(<span class="hljs-built_in">len</span>)<span class="hljs-comment">#å…¨1æ•°ç»„</span><br>np.concatenate((x,y,z))<span class="hljs-comment">#è¿æ¥x,y,zï¼Œç»„æˆä¸€ä¸ªæ•°ç»„</span><br>np.random.permutation()<span class="hljs-comment">#éšæœºæ’åˆ—</span><br>(rand_poly * self.h_poly).trunc(self.q)<br>h_poly.all_coeffs()<span class="hljs-comment">#å¤šé¡¹å¼è½¬æ¢æˆç³»æ•°æ•°ç»„</span><br><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://lazzzaro.github.io/2020/05/13/crypto-%E5%85%B6%E4%BB%96%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/#Paillier%E5%90%8C%E6%80%81%E5%8A%A0%E5%AF%86">å…¶ä»–åŠ å¯†ç®—æ³• | Lazzaro (lazzzaro.github.io)</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/28/">ByteCTF 2022 By W&amp;M - W&amp;M Team (wm-team.cn)</a></p><p><a href="">ByteCTF WriteUp By Nu1L.pdf</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MT19937</tag>
      
      <tag>PaillieråŒæ€åŠ å¯†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022 DASCTF X CBCTFä¹æœˆèµ›</title>
    <link href="/2022/09/21/2022DASCTF%20X%20CBCTF%E4%B9%9D%E6%9C%88%E8%B5%9B/"/>
    <url>/2022/09/21/2022DASCTF%20X%20CBCTF%E4%B9%9D%E6%9C%88%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="DASCTF-X-CBCTF-2022ä¹æœˆæŒ‘æˆ˜èµ›"><a href="#DASCTF-X-CBCTF-2022ä¹æœˆæŒ‘æˆ˜èµ›" class="headerlink" title="DASCTF X CBCTF 2022ä¹æœˆæŒ‘æˆ˜èµ›"></a>DASCTF X CBCTF 2022ä¹æœˆæŒ‘æˆ˜èµ›</h1><h2 id="LittleRSA"><a href="#LittleRSA" class="headerlink" title="LittleRSA"></a>LittleRSA</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sympy<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br>m = bytes_to_long(flag)<br>p = getPrime(<span class="hljs-number">512</span>)<br>q = getPrime(<span class="hljs-number">512</span>)<br>phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>e = <span class="hljs-number">65537</span><br>n = p * q<br>c = <span class="hljs-built_in">pow</span>(m, e, n)<br><br>s = getPrime(<span class="hljs-number">300</span>)<br>N = getPrime(<span class="hljs-number">2048</span>)<br>g = p * inverse(s,N)**<span class="hljs-number">2</span> % (N**<span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span>(N)<br><span class="hljs-built_in">print</span>(g)<br><span class="hljs-built_in">print</span>(n)<br><span class="hljs-built_in">print</span>(c)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">N = 19351301035801508116955552063316327463227928638319284082504070745230119792307421099534903837766317639913937954784857576991401214861067471772614753337821871108189780331081099041824669243928056765115068764246765680962348646383991303828426125303844394268682191775232611288039200316595279055408827296256289143602827525373267536643865729646353071637054367702218515803980122435811129935450486950137279824491461041391572264371799797200331838690523349105589985032730668315787318829244743317257793753147209875458127340875400367081865762286565978620979196410411241442894450955280237513249393612603560410291825805553536595543937</span><br><span class="hljs-string">g = 101172011079013273946711882340439823149055809449035744718659818796135714101721641190114954130041477714466321498903210220694435354795744225843314447645623337668697058127975104586375292636080114347294697007231487782548846095107329445479367324424672776003899748234353857872627585595343736452088156885081907758727085723312506489549364721644636251780350312413098132506051531311685636921117457469745637347738336829350634994271419554741425590636953154753970902976959308323838617091060754826727417688836026597614894745348808019654100196615719730109909578899299246848916182034705259206906552769087038179288139086772719994577168184701096922291610523676039127012518100023765548552210944426749474888311751069936144583375194023227887848704267587915237057432609663328145608194550736074250822416779448467084842127165553649513397606464059847361880649213934069715996589751778384513724306521043255299443480482640183740131563318058454711913397533436985618182923646192481486120942073719321372236539019107909910597047133371708017755744495134116771999521953654596632221519266339372439452558083199640035069852530373510758859460350025736629801086757717838159774542506755335660607766677992105601518694405113552321342152041808586187181800679845672788746273313</span><br><span class="hljs-string">n = 90106928919727272173474070618911951313216606598108495724382284361415375454490594410306345748069424740100772955015304592942129026096113424198209327375124576666577469761124470792842854884924199449996929134613382626394351988541980388358156143332979538058465890179760337315789398915560641465656968797050755849799</span><br><span class="hljs-string">c = 51609249982849856103564442566936515708380814106997783395400669324617748952940831076546581735494963467680719842859574144530848473300102236821201997786375946601413660428461473204032985053128283751860315027843200214217715401391736262811016964783589439740884991543059175666298728428567481043422497862838127903980</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>æœ‰å¦‚ä¸‹å…¬å¼<br>$$<br>g &#x3D; p*s^{-2}\quad mod\ N^2\quad&#x3D;&#x3D;&gt;\quad g*s^2&#x3D;p\quad mod\ N \tag{1}<br>$$<br>æ‰€ä»¥æ„é€ æ ¼å¦‚ä¸‹<br>$$<br>M&#x3D;\left[<br>\matrix{<br>  1&amp; g\\<br>  0 &amp; N<br>}<br>\right]<br>$$<br>ç¨å¾®è§£é‡Šä¸€ä¸‹ã€‚æ ¹æ®å…¬å¼(1)æœ‰<br>$$<br>g*s^2-k*N&#x3D;p<br>$$<br>é‚£ä¹ˆ<br>$$<br>\left[<br>\matrix{<br>  s^2&amp;-k<br>}<br>\right]<br>*<br>\left[<br>\matrix{<br>  1&amp; g\\<br>  0 &amp; N<br>}<br>\right]<br>&#x3D;<br>\left[<br>\matrix{<br>  s^2&amp;p<br>}<br>\right]<br>$$<br>ä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡å¯¹çŸ©é˜µMè¿›è¡Œæ ¼åŸºè§„çº¦å¾—åˆ°å«pçš„å‘é‡ã€‚</p><p>è¯¦ç»†å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/7163">ä»ä¸€é“CTFé¢˜åˆæ¢NTRUæ ¼å¯†ç  - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a>ï¼ˆç»å…¸ä¸”è¯¦ç»†ï¼Œéå¸¸å—ç”¨ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>N = <span class="hljs-number">19351301035801508116955552063316327463227928638319284082504070745230119792307421099534903837766317639913937954784857576991401214861067471772614753337821871108189780331081099041824669243928056765115068764246765680962348646383991303828426125303844394268682191775232611288039200316595279055408827296256289143602827525373267536643865729646353071637054367702218515803980122435811129935450486950137279824491461041391572264371799797200331838690523349105589985032730668315787318829244743317257793753147209875458127340875400367081865762286565978620979196410411241442894450955280237513249393612603560410291825805553536595543937</span><br>g = <span class="hljs-number">101172011079013273946711882340439823149055809449035744718659818796135714101721641190114954130041477714466321498903210220694435354795744225843314447645623337668697058127975104586375292636080114347294697007231487782548846095107329445479367324424672776003899748234353857872627585595343736452088156885081907758727085723312506489549364721644636251780350312413098132506051531311685636921117457469745637347738336829350634994271419554741425590636953154753970902976959308323838617091060754826727417688836026597614894745348808019654100196615719730109909578899299246848916182034705259206906552769087038179288139086772719994577168184701096922291610523676039127012518100023765548552210944426749474888311751069936144583375194023227887848704267587915237057432609663328145608194550736074250822416779448467084842127165553649513397606464059847361880649213934069715996589751778384513724306521043255299443480482640183740131563318058454711913397533436985618182923646192481486120942073719321372236539019107909910597047133371708017755744495134116771999521953654596632221519266339372439452558083199640035069852530373510758859460350025736629801086757717838159774542506755335660607766677992105601518694405113552321342152041808586187181800679845672788746273313</span><br>n = <span class="hljs-number">90106928919727272173474070618911951313216606598108495724382284361415375454490594410306345748069424740100772955015304592942129026096113424198209327375124576666577469761124470792842854884924199449996929134613382626394351988541980388358156143332979538058465890179760337315789398915560641465656968797050755849799</span><br>c = <span class="hljs-number">51609249982849856103564442566936515708380814106997783395400669324617748952940831076546581735494963467680719842859574144530848473300102236821201997786375946601413660428461473204032985053128283751860315027843200214217715401391736262811016964783589439740884991543059175666298728428567481043422497862838127903980</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;sage</span><br><span class="hljs-string">g = 101172011079013273946711882340439823149055809449035744718659818796135714101721641190114954130041477714466321498903210220694435354795744225843314447645623337668697058127975104586375292636080114347294697007231487782548846095107329445479367324424672776003899748234353857872627585595343736452088156885081907758727085723312506489549364721644636251780350312413098132506051531311685636921117457469745637347738336829350634994271419554741425590636953154753970902976959308323838617091060754826727417688836026597614894745348808019654100196615719730109909578899299246848916182034705259206906552769087038179288139086772719994577168184701096922291610523676039127012518100023765548552210944426749474888311751069936144583375194023227887848704267587915237057432609663328145608194550736074250822416779448467084842127165553649513397606464059847361880649213934069715996589751778384513724306521043255299443480482640183740131563318058454711913397533436985618182923646192481486120942073719321372236539019107909910597047133371708017755744495134116771999521953654596632221519266339372439452558083199640035069852530373510758859460350025736629801086757717838159774542506755335660607766677992105601518694405113552321342152041808586187181800679845672788746273313</span><br><span class="hljs-string">N = 19351301035801508116955552063316327463227928638319284082504070745230119792307421099534903837766317639913937954784857576991401214861067471772614753337821871108189780331081099041824669243928056765115068764246765680962348646383991303828426125303844394268682191775232611288039200316595279055408827296256289143602827525373267536643865729646353071637054367702218515803980122435811129935450486950137279824491461041391572264371799797200331838690523349105589985032730668315787318829244743317257793753147209875458127340875400367081865762286565978620979196410411241442894450955280237513249393612603560410291825805553536595543937</span><br><span class="hljs-string">v1 = vector(ZZ, [1, g])</span><br><span class="hljs-string">v2 = vector(ZZ, [0, N])</span><br><span class="hljs-string">m = matrix([v1,v2])</span><br><span class="hljs-string">shortest_vector = m.LLL()[0]</span><br><span class="hljs-string">print(shortest_vector)</span><br><span class="hljs-string">#(-1703096866219569817841710120722024801172129285713276062493657151527831376599274719653327578175460913670322546273486052217558990179451330534956630028900812517189053457400581665150009, -8640002811717397823892474058167788615113205903077061861590520377451867637348771860824972890020165996777729868251869232382053496274304375769436361474547973)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>p = <span class="hljs-number">8640002811717397823892474058167788615113205903077061861590520377451867637348771860824972890020165996777729868251869232382053496274304375769436361474547973</span><br><span class="hljs-keyword">assert</span> n%p == <span class="hljs-number">0</span><br>q = n//p<br>e = <span class="hljs-number">65537</span><br>d = gmpy2.invert(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br></code></pre></td></tr></table></figure><h2 id="easySignIn"><a href="#easySignIn" class="headerlink" title="easySignIn"></a>easySignIn</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> libnum<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br>p = getPrime(<span class="hljs-number">512</span>)<br>d = getPrime(<span class="hljs-number">40</span>)<br>m = libnum.s2n(flag)<br>a = randint(<span class="hljs-number">2</span>,p)<br>b = randint(<span class="hljs-number">2</span>,p)<br>c = randint(<span class="hljs-number">2</span>,p)<br>g = d<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    g = (c*d^<span class="hljs-number">2</span> + b*g + a)%p<br>    a = (a*b - c) % p<br>    b = (b*c - a) % p <br>    c = (c*a - b) % p <br><br>t = (m+d)^<span class="hljs-number">2</span> %p<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;p=&#x27;</span>,p)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;a=&#x27;</span>,a)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;b=&#x27;</span>,b)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c=&#x27;</span>,c)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;g=&#x27;</span>,g)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;t=&#x27;</span>,t)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">p= 7591656713055743077369340861541583433090841738590989539280316533530045331013958613146671718809022799047779468311222607020894006899032327866283558110087799</span><br><span class="hljs-string">a= 4392865163304254999527172406061971162689920565151840813033448791785156740502864894051809689255751412382468345217962713758808061870635744521996229554057672</span><br><span class="hljs-string">b= 2119856022628544669301306700581535843188073099896481101405665476192582614655960576092254118367775147735092457551317887281026710342124525625026559538165667</span><br><span class="hljs-string">c= 3370586754351688470908526079815435343732016329743637661764947106415792049906966624513736208696137655804912688128186282852926377345819134856707156640355705</span><br><span class="hljs-string">g= 2221154642536617375933147254663757148609834736621720750750043572054496685087600339999953459509198087870095805651320901316659013390557077204194753685935362</span><br><span class="hljs-string">t= 6426975621182152052236088849377616252912408340750729257254509090637526282051064469268808395760737262115678691330037039061905028548054911000486882481093832</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®<br>$$<br>t &#x3D; (m+d)^2\quad mod\ p<br>$$<br>é€šè¿‡å¹³æ–¹å‰©ä½™å¯ä»¥æ±‚å‡º<code>m+d</code>ã€‚ç„¶åæ˜¯æ±‚<code>d</code>ã€‚</p><p>è§‚å¯Ÿå¾ªç¯ä¸­çš„ä»£ç ï¼Œå¾ˆæ˜æ˜¾å¯ä»¥é€šè¿‡ç»™å‡ºçš„<code>a,b,c</code>æ¨å‡º<code>i=8</code>è¿™ä¸€è½®çš„<code>a,b,c</code>ï¼Œä½†å¹¶ä¸èƒ½è§£å‡ºdï¼Œå› ä¸º<code>i=8</code>è¿™ä¸€è½®çš„<code>g</code>æœªçŸ¥ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰ä¸¤ä¸ªæœªçŸ¥æ•°ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ¶ˆé™¤æ‰ä¸€ä¸ªæœªçŸ¥æ•°ï¼Œæ ¹æ®æœ€åˆçš„<code>g=d</code>å¯çŸ¥ï¼Œå¦‚æœæˆ‘ä»¬ä»æœ€åˆå¼€å§‹æ¨<code>g</code>çš„ç”Ÿæˆå¼ï¼Œé‚£ä¹ˆæœ€ç»ˆå°±åªæœ‰æœªçŸ¥æ•°<code>d</code>ï¼Œé€šè¿‡sageè§£è¿™ä¸ªæ–¹ç¨‹å°±å¯ä»¥å¾—åˆ°<code>d</code>ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes,inverse<br><br>p= <span class="hljs-number">7591656713055743077369340861541583433090841738590989539280316533530045331013958613146671718809022799047779468311222607020894006899032327866283558110087799</span><br>a= <span class="hljs-number">4392865163304254999527172406061971162689920565151840813033448791785156740502864894051809689255751412382468345217962713758808061870635744521996229554057672</span><br>b= <span class="hljs-number">2119856022628544669301306700581535843188073099896481101405665476192582614655960576092254118367775147735092457551317887281026710342124525625026559538165667</span><br>c= <span class="hljs-number">3370586754351688470908526079815435343732016329743637661764947106415792049906966624513736208696137655804912688128186282852926377345819134856707156640355705</span><br>g= <span class="hljs-number">2221154642536617375933147254663757148609834736621720750750043572054496685087600339999953459509198087870095805651320901316659013390557077204194753685935362</span><br>t= <span class="hljs-number">6426975621182152052236088849377616252912408340750729257254509090637526282051064469268808395760737262115678691330037039061905028548054911000486882481093832</span><br><br>R.&lt;x&gt; = PolynomialRing(Zmod(p))<br>f = x^<span class="hljs-number">2</span> - t<br>result = f.roots()<br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-comment">#[(7591656713055743077369340861541583433090841738590989539280316533529914669358031382351028958377643759269145794938649787861165963022699333466670422633862441, 1), (130661655927230795642760431379039778633673372572819159728043876332994399613135476225358, 1)]</span><br><br>m = <span class="hljs-number">130661655927230795642760431379039778633673372572819159728043876332994399613135476225358</span><br><br>_a = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]<br>_b = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]<br>_c = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    c = (c+b)*inverse(a,p) % p<br>    b = (b+a)*inverse(c,p) % p<br>    a = (a+c)*inverse(b,p) % p<br>    _a[i] = a<br>    _b[i] = b<br>    _c[i] = c<br><br>_a = _a[::-<span class="hljs-number">1</span>]<br>_b = _b[::-<span class="hljs-number">1</span>]<br>_c = _c[::-<span class="hljs-number">1</span>]<br><br>R.&lt;x&gt; = PolynomialRing(Zmod(p))<br>y = x<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    y = _c[i]*x^<span class="hljs-number">2</span> + _b[i]*y + _a[i]<br><br>y = y - g<br>result = y.roots()<br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-keyword">for</span> ans <span class="hljs-keyword">in</span> result:<br>    <span class="hljs-keyword">if</span> ans[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">2</span>**<span class="hljs-number">40</span>:<br>        flag = long_to_bytes(m-<span class="hljs-built_in">int</span>(ans[<span class="hljs-number">0</span>]))<br>        <span class="hljs-built_in">print</span>(flag)<br><br></code></pre></td></tr></table></figure><h2 id="easyRSA"><a href="#easyRSA" class="headerlink" title="easyRSA"></a>easyRSA</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br>bitlen = <span class="hljs-number">512</span><br>p = getPrime(bitlen)<br>q = getPrime(bitlen)<br>r = getPrime(bitlen)<br><br><span class="hljs-keyword">assert</span> p != q <span class="hljs-keyword">and</span> q != r <span class="hljs-keyword">and</span> p != r<br><br>n = p*q*r<br>phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)*(r-<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    d = getPrime(<span class="hljs-number">256</span>)<br>    <span class="hljs-keyword">try</span>:<br>        e = <span class="hljs-built_in">int</span>(gmpy2.invert(d,phi))<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> gmpy2.gcd(e,phi) == <span class="hljs-number">1</span> :<br>        <span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">assert</span> flag.startswith(<span class="hljs-string">b&#x27;CBCTF&#123;&#x27;</span>)<br>m = bytes_to_long(flag)<br>c = <span class="hljs-built_in">pow</span>(m,e,n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;c =&#x27;</span>,c)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;e =&#x27;</span>,e)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n =&#x27;</span>,n)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">c = 262857004135341325365954795119195630698138090729973647118817900621693212191529885499646534515610526918027363734446577563494752228693708806585707918542489830672358210151020370518277425565514835701391091303404848540885538503732425887366285924392127448359616405690101810030200914619945580943356783421516140571033192987307744023953015589089516394737132984255621681367783910322351237287242642322145388520883300325056201966188529192590458358240120864932085960411656176</span><br><span class="hljs-string">e = 543692319895782434793586873362429927694979810701836714789970907812484502410531778466160541800747280593649956771388714635910591027174563094783670038038010184716677689452322851994224499684261265932205144517234930255520680863639225944193081925826378155392210125821339725503707170148367775432197885080200905199759978521133059068268880934032358791127722994561887633750878103807550657534488433148655178897962564751738161286704558463757099712005140968975623690058829135</span><br><span class="hljs-string">n = 836627566032090527121140632018409744681773229395209292887236112065366141357802504651617810307617423900626216577416313395633967979093729729146808472187283672097414226162248255028374822667730942095319401316780150886857701380015637144123656111055773881542557503200322153966380830297951374202391216434278247679934469711771381749572937777892991364186158273504206025260342916835148914378411684678800808038832601224951586507845486535271925600310647409016210737881912119</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p> $e$æ¯”$n$è¿˜å¤§ï¼Ÿå¯èƒ½æ˜¯<code>Wiener&#39;s Attack</code>ï¼Œä¸è¿‡ä¸‰ä¸ªç´ æ•°çš„$n$ç”¨<code>Wiener&#39;s Attack</code>æˆ‘è¿˜æ²¡è§åˆ°è¿‡ã€‚</p><p>æ ¹æ®<code>Wiener&#39;s Attack</code>ï¼Œå¯¹$\dfrac{e}{N}$è¿›è¡Œè¿åˆ†æ•°å±•å¼€ï¼Œå¯ä»¥è¿‘ä¼¼å¾—åˆ°$kï¼Œd*g$ã€‚</p><p>å¦‚æœå¯ä»¥å¾—åˆ°å¤šä¸ª$d*g$ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è´ç¥–ç­‰å¼æ±‚å‡ºå…¬çº¦æ•°$d$ã€‚å› ä¸ºæ˜¯è¿åˆ†æ•°çš„æ€§è´¨ï¼Œæ‰€ä»¥å¦‚æœå­˜åœ¨å¤šä¸ª$d*g$ï¼Œé‚£ä¹ˆè¿™äº›æ˜¯è¿ç»­å­˜åœ¨çš„ã€‚</p><p>ï¼ˆä»£ç æ¬è¿‡æ¥äº†ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plus</span>(<span class="hljs-params">e, n</span>):<br>    m = <span class="hljs-number">2</span><br>    c = <span class="hljs-built_in">pow</span>(m, e, n)<br>    q0 = <span class="hljs-number">1</span><br><br>    list1 = continued_fraction(Integer(e)/Integer(n))<br>    conv = list1.convergents()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> conv:<br>        k = i.numerator()<br>        <span class="hljs-comment">#print(k)</span><br>        q1 = i.denominator()<br>        <span class="hljs-comment">#print(q1)</span><br><br>        <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):<br>            <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):<br>                d = r*q1 + s*q0<br>                m1 = <span class="hljs-built_in">pow</span>(c, d, n)<br>                <span class="hljs-keyword">if</span> m1 == m:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;q1=<span class="hljs-subst">&#123;q1&#125;</span>,q0=<span class="hljs-subst">&#123;q0&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(r,s)<br>                    <span class="hljs-keyword">return</span> d<br>     <br>        q0 = q1<br>        <br>c = <span class="hljs-number">262857004135341325365954795119195630698138090729973647118817900621693212191529885499646534515610526918027363734446577563494752228693708806585707918542489830672358210151020370518277425565514835701391091303404848540885538503732425887366285924392127448359616405690101810030200914619945580943356783421516140571033192987307744023953015589089516394737132984255621681367783910322351237287242642322145388520883300325056201966188529192590458358240120864932085960411656176</span><br>e = <span class="hljs-number">543692319895782434793586873362429927694979810701836714789970907812484502410531778466160541800747280593649956771388714635910591027174563094783670038038010184716677689452322851994224499684261265932205144517234930255520680863639225944193081925826378155392210125821339725503707170148367775432197885080200905199759978521133059068268880934032358791127722994561887633750878103807550657534488433148655178897962564751738161286704558463757099712005140968975623690058829135</span><br>n = <span class="hljs-number">836627566032090527121140632018409744681773229395209292887236112065366141357802504651617810307617423900626216577416313395633967979093729729146808472187283672097414226162248255028374822667730942095319401316780150886857701380015637144123656111055773881542557503200322153966380830297951374202391216434278247679934469711771381749572937777892991364186158273504206025260342916835148914378411684678800808038832601224951586507845486535271925600310647409016210737881912119</span><br><br>d = plus(e, n)<br><span class="hljs-built_in">print</span>(d)<br><span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(c,d,n))))<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="http://www.ctfiot.com/57949.html">DASCTF X CBCTF 2022ï½œ ä¹æœˆæŒ‘æˆ˜èµ›å®˜æ–¹Write Up | CTFå¯¼èˆª (ctfiot.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
      <tag>Wiener&#39;s Attack</tag>
      
      <tag>Lattice</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬äºŒå±Šé•¿åŸæ¯</title>
    <link href="/2022/09/12/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/"/>
    <url>/2022/09/12/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="known-phi"><a href="#known-phi" class="headerlink" title="known_phi"></a>known_phi</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> getPrime, bytes_to_long, inverse, long_to_bytes<br><span class="hljs-keyword">from</span> Crypto.PublicKey <span class="hljs-keyword">import</span> DSA<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen</span>(<span class="hljs-params">a</span>):<br>    p = getPrime(a) <br>    q = getPrime(a)<br>    r = getPrime(a)<br>    x = getPrime(a)<br>    n = p*q*r*x<br>    phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)*(r-<span class="hljs-number">1</span>)*(x-<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">return</span> n, phi, [p, q, r, x]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sign</span>(<span class="hljs-params">m, k, x, p, q, g</span>):<br>    hm = bytes_to_long(sha256(m).digest())<br>    r = <span class="hljs-built_in">pow</span>(g, k, p) % q<br>    s = (hm + x*r) * inverse(k, q) % q<br><br>    <span class="hljs-keyword">return</span> r,s<br><br>e = <span class="hljs-number">65537</span><br>a = <span class="hljs-number">256</span><br>x = bytes_to_long(flag)<br><span class="hljs-comment"># print(x)</span><br><br>n, phi, n_factors = gen(a)<br>n_factors = <span class="hljs-built_in">sorted</span>(n_factors)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;n = <span class="hljs-subst">&#123;n&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;phi = <span class="hljs-subst">&#123;phi&#125;</span>&#x27;</span>)<br>m1 = long_to_bytes(n_factors[<span class="hljs-number">0</span>] + n_factors[<span class="hljs-number">3</span>])<br>m2 = long_to_bytes(n_factors[<span class="hljs-number">1</span>] + n_factors[<span class="hljs-number">2</span>])<br><span class="hljs-comment"># print(f&#x27;m1 = &#123;m1&#125;&#x27;)</span><br><span class="hljs-comment"># print(f&#x27;m2 = &#123;m2&#125;&#x27;)</span><br><br>key = DSA.generate(<span class="hljs-built_in">int</span>(<span class="hljs-number">2048</span>))<br>q = key.q<br>p = key.p<br>g = key.g<br><span class="hljs-keyword">assert</span> q &gt; x<br>k = random.randint(<span class="hljs-number">1</span>, q-<span class="hljs-number">1</span>)<br>r1, s1 = sign(m1, k, x, p, q, g)<br>r2, s2 = sign(m2, k, x, p, q, g)<br><span class="hljs-comment"># print(f&#x27;k = &#123;k&#125;&#x27;)</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;q = <span class="hljs-subst">&#123;q&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;s1 = <span class="hljs-subst">&#123;s1&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;r1 = <span class="hljs-subst">&#123;r1&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;s1 = <span class="hljs-subst">&#123;s1&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;r2 = <span class="hljs-subst">&#123;r2&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;s2 = <span class="hljs-subst">&#123;s2&#125;</span>&#x27;</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">n = 104228256293611313959676852310116852553951496121352860038971098657350022997841589403091722735802150153734050783858816709247647536393314564077002364012463220999962114186339228164032217361145009468516448617173972835797623658266515762201804936729547278758839604969469770650218191574897316410254695420895895051693</span><br><span class="hljs-string">phi = 104228256293611313959676852310116852553951496121352860038971098657350022997837434645707418205268240995284026522165519145773852565112344453740579163420312890001524537570675468046604347184376661743552799809753709321949095844960227307733389258381950812717245522599433727311919405966404418872873961877021696812800</span><br><span class="hljs-string">q = 24513014442114004234202354110477737650785387286781126308169912007819</span><br><span class="hljs-string">s1 = 764450933738974696530033347966845551587903750431946039815672438603</span><br><span class="hljs-string">r1 = 8881880595434882344509893789458546908449907797285477983407324325035</span><br><span class="hljs-string">s1 = 764450933738974696530033347966845551587903750431946039815672438603</span><br><span class="hljs-string">r2 = 8881880595434882344509893789458546908449907797285477983407324325035#r1==r2</span><br><span class="hljs-string">s2 = 22099482232399385060035569388467035727015978742301259782677969649659</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>ä¸ªäººè®¤ä¸ºé¢˜ç›®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†é€šè¿‡nå’Œphiåˆ†è§£nï¼Œç¬¬äºŒéƒ¨åˆ†åˆ™æ˜¯DSAã€‚</p><p>åˆ†è§£næ‰¾åˆ°äº†ç›¸åº”çš„è®ºæ–‡å’Œä»£ç ï¼ˆ<a href="https://link.springer.com/content/pdf/10.1007/3-540-36492-7_25.pdf">3-540-36492-7_25.pdf (springer.com)</a>ï¼‰</p><p>DSAéƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œæ˜¯ç§é’¥kå¤ç”¨é—®é¢˜ï¼Œæœ‰å¦‚ä¸‹å¼å­<br>$$<br>\begin{cases}<br>s_1&#x3D;(hm_1+x*r_1)k^{-1}\quad mod\ q\\<br>s_2&#x3D;(hm_2+x*r_2)k^{-1}\quad mod\ q<br>\end{cases}<br>$$<br>ä¸¤å¼ç›¸ä¹˜æœ‰<br>$$<br>s_1*(hm_2+x*r_2)k^{-1}â‰¡s_2*(hm_1+x*r_1)k^{-1}\quad mod\ q<br>$$<br>åŒ–ç®€<br>$$<br>xâ‰¡(hm_1*s_2-hm_2*s_1)*(r_2*s_1-r_1*s_2)^{-1}\quad mod\ q<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> bytes_to_long, long_to_bytes<br><span class="hljs-keyword">from</span> Crypto.PublicKey <span class="hljs-keyword">import</span> DSA<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> is_prime, invert<br><span class="hljs-keyword">from</span> math <span class="hljs-keyword">import</span> gcd<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randrange<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">factorize_multi_prime</span>(<span class="hljs-params">N, phi</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Recovers the prime factors from a modulus if Euler&#x27;s totient is known.</span><br><span class="hljs-string">    This method works for a modulus consisting of any number of primes, but is considerably be slower than factorize.</span><br><span class="hljs-string">    More information: Hinek M. J., Low M. K., Teske E., &quot;On Some Attacks on Multi-prime RSA&quot; (Section 3)</span><br><span class="hljs-string">    :param N: the modulus</span><br><span class="hljs-string">    :param phi: Euler&#x27;s totient, the order of the multiplicative group modulo N</span><br><span class="hljs-string">    :return: a tuple containing the prime factors</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    prime_factors = <span class="hljs-built_in">set</span>()<br>    factors = [N]<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(factors) &gt; <span class="hljs-number">0</span>:<br>        <span class="hljs-comment"># Element to factorize.</span><br>        N = factors[<span class="hljs-number">0</span>]<br><br>        w = randrange(<span class="hljs-number">2</span>, N - <span class="hljs-number">1</span>)<br>        i = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> phi % (<span class="hljs-number">2</span> ** i) == <span class="hljs-number">0</span>:<br>            sqrt_1 = <span class="hljs-built_in">pow</span>(w, phi // (<span class="hljs-number">2</span> ** i), N)<br>            <span class="hljs-keyword">if</span> sqrt_1 &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sqrt_1 != N - <span class="hljs-number">1</span>:<br>                <span class="hljs-comment"># We can remove the element to factorize now, because we have a factorization.</span><br>                factors = factors[<span class="hljs-number">1</span>:]<br><br>                p = gcd(N, sqrt_1 + <span class="hljs-number">1</span>)<br>                q = N // p<br><br>                <span class="hljs-keyword">if</span> is_prime(p):<br>                    prime_factors.add(p)<br>                <span class="hljs-keyword">elif</span> p &gt; <span class="hljs-number">1</span>:<br>                    factors.append(p)<br><br>                <span class="hljs-keyword">if</span> is_prime(q):<br>                    prime_factors.add(q)<br>                <span class="hljs-keyword">elif</span> q &gt; <span class="hljs-number">1</span>:<br>                    factors.append(q)<br><br>                <span class="hljs-comment"># Continue in the outer loop</span><br>                <span class="hljs-keyword">break</span><br><br>            i += <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(prime_factors)<br><br>n = <span class="hljs-number">104228256293611313959676852310116852553951496121352860038971098657350022997841589403091722735802150153734050783858816709247647536393314564077002364012463220999962114186339228164032217361145009468516448617173972835797623658266515762201804936729547278758839604969469770650218191574897316410254695420895895051693</span><br>phi = <span class="hljs-number">104228256293611313959676852310116852553951496121352860038971098657350022997837434645707418205268240995284026522165519145773852565112344453740579163420312890001524537570675468046604347184376661743552799809753709321949095844960227307733389258381950812717245522599433727311919405966404418872873961877021696812800</span><br>q = <span class="hljs-number">24513014442114004234202354110477737650785387286781126308169912007819</span><br>s1 = <span class="hljs-number">764450933738974696530033347966845551587903750431946039815672438603</span><br>r1 = <span class="hljs-number">8881880595434882344509893789458546908449907797285477983407324325035</span><br>r2 = <span class="hljs-number">8881880595434882344509893789458546908449907797285477983407324325035</span> <span class="hljs-comment">#r1==r2</span><br>s2 = <span class="hljs-number">22099482232399385060035569388467035727015978742301259782677969649659</span><br><br>n_factors = factorize_multi_prime(n,phi)<br>n_factors = <span class="hljs-built_in">sorted</span>(n_factors)<br>m1 = long_to_bytes(n_factors[<span class="hljs-number">0</span>] + n_factors[<span class="hljs-number">3</span>])<br>m2 = long_to_bytes(n_factors[<span class="hljs-number">1</span>] + n_factors[<span class="hljs-number">2</span>])<br>hm1 = bytes_to_long(sha256(m1).digest())<br>hm2 = bytes_to_long(sha256(m2).digest())<br><br>tmp = (hm1*s2 - hm2*s1)<br>inv = invert(r2*s1-r1*s2, q)<br>x = inv*tmp%q<br><span class="hljs-built_in">print</span>(long_to_bytes(x))<br></code></pre></td></tr></table></figure><h1 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> bytes_to_long, getPrime, isPrime<br><span class="hljs-keyword">import</span> win32gui,PIL,numpy,operator,pymouse<br><span class="hljs-keyword">from</span> Crypto.Random <span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> getrandbits<br><span class="hljs-keyword">from</span> sympy.ntheory.residue_ntheory <span class="hljs-keyword">import</span> nthroot_mod<br><span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> nextprime<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_primes</span>(<span class="hljs-params">m</span>):<br>    p = getPrime(Bits)<br>    pl = p &amp; <span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;f&#x27;</span>*(m//<span class="hljs-number">4</span>), <span class="hljs-number">16</span>)<span class="hljs-comment">#p&amp;(2**(200)-1)</span><br>    q = (getrandbits(Bits - m) &lt;&lt; m)^^pl<span class="hljs-comment">#rand+pçš„ä½200bit</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> isPrime(q):<br>        q = (getrandbits(Bits - m) &lt;&lt; m)^^pl<br>    <span class="hljs-keyword">return</span> (p, q)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_key</span>(<span class="hljs-params">p, q, delta, beta, Bits</span>):<br>    phi = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>    d1 = getPrime(floor(<span class="hljs-number">2</span> * Bits * delta))<br>    e1 = inverse_mod(d1, phi)<br>    d2 = nextprime(d1 ^^ getrandbits(floor(<span class="hljs-number">2</span> * Bits * beta)))<br>    e2 = inverse_mod(d2, phi)<br>    d3 = getPrime(floor(<span class="hljs-number">2</span> * Bits * delta))<br>    e3 = inverse_mod(d3, phi)<br>    <span class="hljs-keyword">return</span> (e1, e2, e3, d1, d2, d3)<br><br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    Bits = <span class="hljs-number">1024</span> <br>    alpha = <span class="hljs-number">0.098</span><br>    delta = <span class="hljs-number">0.536</span><br>    beta = delta<br>    gamma = <span class="hljs-number">1</span><br>    m = floor(<span class="hljs-number">2</span> * alpha * Bits)<span class="hljs-comment">#200bit&lt;n^(1/4)</span><br><br>    p, q = get_primes(m)<br>    n = p * q<br>    <span class="hljs-keyword">assert</span> n % <span class="hljs-number">2</span>^<span class="hljs-number">3</span> == <span class="hljs-number">1</span><br>    u0 = nthroot_mod(n, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>^m, all_roots=<span class="hljs-literal">False</span>)<br>    v0 = (<span class="hljs-number">2</span>*u0 + ((n - u0^<span class="hljs-number">2</span>) * inverse_mod(u0, <span class="hljs-number">2</span>^(<span class="hljs-number">2</span>*m)) % <span class="hljs-number">2</span>^(<span class="hljs-number">2</span>*m)))<br>    e1, e2, e3, d1, d2, d3 = get_key(p, q, delta, beta, Bits)<br><br>    flag = bytes_to_long(flag)<br>    c = <span class="hljs-built_in">pow</span>(flag, e3, n)<br>    l0 = d1 - d2<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;N = <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(n)&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e1 = <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(e1)&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e2 = <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(e2)&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e3 = <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(e3)&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;c = <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(c)&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;v0 = <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(v0)&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;l0 = <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(l0)&#125;</span>&#x27;</span>)<br><br><span class="hljs-comment"># N = 0x62c048bc886075bffb9ad01255786dd8ef2480ba510f13689c1e84ffaaf21dfb5695a4d83f4ba22093bdd75bfc8f5979185d29724ecccf045e1857b1b2a4757dd82dc44318c054c9fce9bc451e6beecb97bbda6562420fc8c295521c5455443413f90403cf1af6271fb6d2d54378b86ced18ae6844a877890ea853a215880a09c68c517a75c1183c067b706ce630f3f0913591f7354cfa60c8f6b7ab2f15e466a1ea6e8034417a5fc3c11b8ba746596c22c734b09257e9a6fb18358738d416eda0ba0e7b028dd2d550b1e018b180916ac25f47910657a5db2410946c0593b7e23ed1659a811083f363ad4eb65642091a040befbd643089bbee376634d2394d11</span><br><span class="hljs-comment"># e1 = 0x124241a12ea2be53f9b9b1fd92e10d089cfa32aa07e6c2cace848aaa6c73ff06d4c6c92b7d1f29160b2eef95a5f580915d3f15c0ea23975cbadfe8347a10daab2bd0827d7e909b329ec53c5eb306f0a5125b3817e7ea0c15b2317a46c36c4f34fc626dadc6c769bcc7be18ddf7954fae8dde3fd4ce3c5146c019bdb0d9552af1dc9ef7186e06b1d59e763fb05c7cd21fbb3f509fee52d4e24921ebfa76bb8302ea6760e92606e440907cc1c110946af53900904e84dbc309fcef15ea060c667070e5e0310891606df151609ff609bcc6125c6043c35119b25df78b4d5ca61ab6492753cc5e5b32e044fce0aeb0442464f36298add254e9fb6505fa4cddae1cf7</span><br><span class="hljs-comment"># e2 = 0x17b3937cec3ca5fdddad8db29c6dc4efae1408bf5b4aa2ff602112c50f302e9698c79c7ab79fef0210c621dcc218d91d358b7f93a978c4e3f2b982794697c4797cef89189d1464ed1c767bf72433092922352885f8e355952c558ad2c9ade58a19375ddc5dcf3f9fa28c68a5cff158734d94224b85f77bd939133f39ab7884ece61d9fb3496373008827c2ae694dfe7da08eee348ef99c3a6737a4b088b62978cf209ef3d1140a30d42872615b94378108266e3d344caf51b497a585a4b5ef8619cc46959bad9b89f59f36175fbf9b64363443f3f7743896c72a198decedf89c518fa07b1d401d0359578a4926b7d67de86232ee24751f17dafbc749c0783b33</span><br><span class="hljs-comment"># e3 = 0x5647c4490bda9e7e497651551600572c5ef4e2d889b9b1ba0e9a493660497e10877e975c01da9aebae5e3ba9aad976a1a783b39191e8fd799689dfa26b069264d60543602d514ac412ac75d827d67c78ad544bda633f0fa69fb5bbc37e0f6b95714576ff53bae3f7f991d143a4b1e841730d5d580d4effeb8fb02e8b3c3c9a1f1899d2eb411ce37f16d30cfa1f7af7322be4f42f5d012f484a1181fa4aa0b5f420a472030a5c08c80bff76ab82ef5768bfd495abcdc5f22aae1891561322dfb28ff63c4e467411c8b73c11d64b05f411e2a1de0c7754c6a62d1f72cded9e2592ccc21be3fce4ea6f083a617a246fd3fe464ef2487adbfabfb628c882ea991675</span><br><span class="hljs-comment"># c = 0x45f2ee650d622d1e0f0e2e2e861001e9866c541f9f1dd2ec1dec18194f8b7224914916ecd68bbc74b28a000d2664e671586aed63b54c0928a939caf28d39eeba03c0ce3afcf2cdc5805e8e2792d76e88545aa4dee11078ba1e2e5b56ee23d58e443d7aff180d4e7463ae66ea8e96e0c8d4e1443e7664b99599af14e591e28cf2f833bd30b44b89c396b5fc1ee81ea3f7bc08dab426b1871eb66829c81d57e2ebf5c7a3e9c593ce496f0b0c4237906b019ae75ca551d6b0b1adfe64958c2ead6c39e517eb75eaf4b4d72402bea40f043cf0a80317aa2f1a996c727e195e15f903c0cac618f668af1015ee479d1c7b1c1b370fd4a5a76f5bf295e6bd7d0f4ae56f</span><br><span class="hljs-comment"># v0 = 0x2c77a013f2595a90c4e10a53a0f863d02b361c7407dad7d59db7c98df427da00c8d8627dbaef9557279ca31227cdb402d2d2</span><br><span class="hljs-comment"># l0 = 0x3dbabf6ea5b801221c283bd234f04264d292c8f3048c8b59c21e003cda983a3a41e4392c6ea77a706631de60d261f2b367027e037d37fda5a13a8e01b2c6c0f48a3112315cffe7420a50a3ebada09aba61f8e6da793654a467b9f780c20c5085012e064ab9205c076073b4fb4895e01d0d568fd5c30159879180093855d39d5548a1389a94f57c680c</span><br></code></pre></td></tr></table></figure><p>æœ‰ç­‰å¼å¦‚ä¸‹<br>$$<br>\begin{cases}<br>e_1*d_1 â‰¡ 1\quad mod\ phi\\<br>e_2*d_2 â‰¡ 1\quad mod\ phi\\<br>d_1-d_2&#x3D;l_0<br>\end{cases}<br>$$<br>åŒ–ç®€æœ‰<br>$$<br>e_1*e_2*l_0 â‰¡ (e_2-e_1)\quad mod\ phi\quad &#x3D;&#x3D;&gt;\quad k*phi&#x3D;e_1*e_2*l_0 - (e_2 - e_1)<br>$$<br>åœ¨æ¨¡ä¸º<code>k*phi</code>çš„åŸŸä¸Šï¼Œæœ‰<br>$$<br>e_3*d_3â€™â‰¡1\quad mod\ (k*phi)\<br>$$<br>æ ¹æ®RSAçš„åŠ è§£å¯†å…¬å¼æ¨å¯¼æœ‰<br>$$<br>\begin{align}<br>c &amp;â‰¡ m^{e_3} \\<br>&#x3D;&#x3D;&gt;c^{d_3â€™} &amp;â‰¡ m^{e_3*d_3â€™}\\<br>&amp;â‰¡ m^{1+k_1*k*phi}\\<br>&amp;â‰¡ m^{1+K*phi}\\<br>&amp;&#x3D; m \quad mod\ (N)<br>\end{align}<br>$$</p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes, inverse<br><br>N = <span class="hljs-number">0x62c048bc886075bffb9ad01255786dd8ef2480ba510f13689c1e84ffaaf21dfb5695a4d83f4ba22093bdd75bfc8f5979185d29724ecccf045e1857b1b2a4757dd82dc44318c054c9fce9bc451e6beecb97bbda6562420fc8c295521c5455443413f90403cf1af6271fb6d2d54378b86ced18ae6844a877890ea853a215880a09c68c517a75c1183c067b706ce630f3f0913591f7354cfa60c8f6b7ab2f15e466a1ea6e8034417a5fc3c11b8ba746596c22c734b09257e9a6fb18358738d416eda0ba0e7b028dd2d550b1e018b180916ac25f47910657a5db2410946c0593b7e23ed1659a811083f363ad4eb65642091a040befbd643089bbee376634d2394d11</span><br>e1 = <span class="hljs-number">0x124241a12ea2be53f9b9b1fd92e10d089cfa32aa07e6c2cace848aaa6c73ff06d4c6c92b7d1f29160b2eef95a5f580915d3f15c0ea23975cbadfe8347a10daab2bd0827d7e909b329ec53c5eb306f0a5125b3817e7ea0c15b2317a46c36c4f34fc626dadc6c769bcc7be18ddf7954fae8dde3fd4ce3c5146c019bdb0d9552af1dc9ef7186e06b1d59e763fb05c7cd21fbb3f509fee52d4e24921ebfa76bb8302ea6760e92606e440907cc1c110946af53900904e84dbc309fcef15ea060c667070e5e0310891606df151609ff609bcc6125c6043c35119b25df78b4d5ca61ab6492753cc5e5b32e044fce0aeb0442464f36298add254e9fb6505fa4cddae1cf7</span><br>e2 = <span class="hljs-number">0x17b3937cec3ca5fdddad8db29c6dc4efae1408bf5b4aa2ff602112c50f302e9698c79c7ab79fef0210c621dcc218d91d358b7f93a978c4e3f2b982794697c4797cef89189d1464ed1c767bf72433092922352885f8e355952c558ad2c9ade58a19375ddc5dcf3f9fa28c68a5cff158734d94224b85f77bd939133f39ab7884ece61d9fb3496373008827c2ae694dfe7da08eee348ef99c3a6737a4b088b62978cf209ef3d1140a30d42872615b94378108266e3d344caf51b497a585a4b5ef8619cc46959bad9b89f59f36175fbf9b64363443f3f7743896c72a198decedf89c518fa07b1d401d0359578a4926b7d67de86232ee24751f17dafbc749c0783b33</span><br>e3 = <span class="hljs-number">0x5647c4490bda9e7e497651551600572c5ef4e2d889b9b1ba0e9a493660497e10877e975c01da9aebae5e3ba9aad976a1a783b39191e8fd799689dfa26b069264d60543602d514ac412ac75d827d67c78ad544bda633f0fa69fb5bbc37e0f6b95714576ff53bae3f7f991d143a4b1e841730d5d580d4effeb8fb02e8b3c3c9a1f1899d2eb411ce37f16d30cfa1f7af7322be4f42f5d012f484a1181fa4aa0b5f420a472030a5c08c80bff76ab82ef5768bfd495abcdc5f22aae1891561322dfb28ff63c4e467411c8b73c11d64b05f411e2a1de0c7754c6a62d1f72cded9e2592ccc21be3fce4ea6f083a617a246fd3fe464ef2487adbfabfb628c882ea991675</span><br>c = <span class="hljs-number">0x45f2ee650d622d1e0f0e2e2e861001e9866c541f9f1dd2ec1dec18194f8b7224914916ecd68bbc74b28a000d2664e671586aed63b54c0928a939caf28d39eeba03c0ce3afcf2cdc5805e8e2792d76e88545aa4dee11078ba1e2e5b56ee23d58e443d7aff180d4e7463ae66ea8e96e0c8d4e1443e7664b99599af14e591e28cf2f833bd30b44b89c396b5fc1ee81ea3f7bc08dab426b1871eb66829c81d57e2ebf5c7a3e9c593ce496f0b0c4237906b019ae75ca551d6b0b1adfe64958c2ead6c39e517eb75eaf4b4d72402bea40f043cf0a80317aa2f1a996c727e195e15f903c0cac618f668af1015ee479d1c7b1c1b370fd4a5a76f5bf295e6bd7d0f4ae56f</span><br>v0 = <span class="hljs-number">0x2c77a013f2595a90c4e10a53a0f863d02b361c7407dad7d59db7c98df427da00c8d8627dbaef9557279ca31227cdb402d2d2</span><br>l0 = <span class="hljs-number">0x3dbabf6ea5b801221c283bd234f04264d292c8f3048c8b59c21e003cda983a3a41e4392c6ea77a706631de60d261f2b367027e037d37fda5a13a8e01b2c6c0f48a3112315cffe7420a50a3ebada09aba61f8e6da793654a467b9f780c20c5085012e064ab9205c076073b4fb4895e01d0d568fd5c30159879180093855d39d5548a1389a94f57c680c</span><br><br>kphi = e1*e2*l0 - (e2 - e1)<br>d3 = inverse(e3, kphi)<br>m = <span class="hljs-built_in">pow</span>(c, d3, N)<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022ç¬¬ä¸‰å±Šç½‘é¼æ¯é’é¾™ç»„</title>
    <link href="/2022/08/26/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/"/>
    <url>/2022/08/26/2022%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/</url>
    
    <content type="html"><![CDATA[<h1 id="crypto405"><a href="#crypto405" class="headerlink" title="crypto405"></a>crypto405</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randrange<br><br><span class="hljs-keyword">from</span> grassfield <span class="hljs-keyword">import</span> flag<br><br>p = getPrime(<span class="hljs-number">16</span>)<br><br>k = [randrange(<span class="hljs-number">1</span>,p) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(flag)):<br>    grasshopper = flag[i]<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        k[j] = grasshopper = grasshopper * k[j] % p<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Grasshopper#&#x27;</span>+<span class="hljs-built_in">str</span>(i).zfill(<span class="hljs-number">2</span>)+<span class="hljs-string">&#x27;:&#x27;</span>+<span class="hljs-built_in">hex</span>(grasshopper)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>))<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨å¥½flagçš„æ ¼å¼è¿›è¡Œåˆ†æã€‚</p><p>å°†å‰5ä¸ª<code>grasshopper</code>çš„äº§ç”Ÿè¿‡ç¨‹åˆ—å‡ºå…¬å¼æ¥ï¼Œæœ‰ï¼š</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031009312.png"/><p>æˆ‘ä»¬å·²çŸ¥$k_{14},k_{24},k_{34},k_{44},k_{54}$ï¼Œå°±å¯ä»¥æ¨å‡º$k_{23},k_{33},k_{43},k_{53}$ï¼Œå¦‚$k_{23}&#x3D;k_{24}*invert(k_{14},p)\%p$ï¼ŒåŒç†å¯ä»¥æ±‚å‡º$k_{32},k_{42},k_{52}$ï¼Œç»§ç»­æœ‰$k_{41},k_{51}$ï¼Œæœ€åæ±‚å‡º$k_{50}$ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±æ±‚å‡ºäº†$k_{50},k_{51},k_{52},k_{53},k_{54}$ï¼Œå³åŠ å¯† â€˜{â€˜ ä¹‹åçš„å¯†é’¥<code>k</code>ã€‚</p><p>çŸ¥é“å¯†é’¥<code>k</code>ï¼Œé€šè¿‡<code>g_i*invert(k0*k1*k2*k3*k4,p)%p</code>æ±‚å¾—æ˜æ–‡å­—ç¬¦ï¼Œç„¶åé‡å¤ä¸€éåŠ å¯†è¿‡ç¨‹å¯ä»¥å¾—åˆ°ä¸‹ä¸€è½®çš„å¯†é’¥<code>k</code>ã€‚</p><p>pçš„å€¼å¯ä»¥è¿›è¡Œçˆ†ç ´ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> invert,gcd<br><span class="hljs-comment">#åˆ©ç”¨flagæ ¼å¼flag&#123;      &#125;</span><br>know = <span class="hljs-string">b&#x27;flag&#123;&#x27;</span><br><span class="hljs-comment">#çˆ†ç ´p</span><br>g = [<span class="hljs-number">0x2066</span>, <span class="hljs-number">0xa222</span>, <span class="hljs-number">0xcbb1</span>, <span class="hljs-number">0xdbb4</span>, <span class="hljs-number">0xdeb4</span>, <span class="hljs-number">0xb1c5</span>, <span class="hljs-number">0x33a4</span>, <span class="hljs-number">0xc051</span>, <span class="hljs-number">0x3b79</span>, <span class="hljs-number">0x6bf8</span>, <span class="hljs-number">0x2131</span>, <span class="hljs-number">0x2c40</span>, <span class="hljs-number">0x91ba</span>, <span class="hljs-number">0x7b44</span>, <span class="hljs-number">0x5f25</span>, <span class="hljs-number">0x0208</span>, <span class="hljs-number">0x7edb</span>, <span class="hljs-number">0x62b5</span>, <span class="hljs-number">0xcec5</span>, <span class="hljs-number">0x5ab3</span>, <span class="hljs-number">0x3c46</span>, <span class="hljs-number">0xc272</span>, <span class="hljs-number">0x714b</span>, <span class="hljs-number">0x9e0b</span>, <span class="hljs-number">0x48ee</span>, <span class="hljs-number">0x44cc</span>, <span class="hljs-number">0x05a0</span>, <span class="hljs-number">0x3da3</span>, <span class="hljs-number">0x11b1</span>, <span class="hljs-number">0x259f</span>, <span class="hljs-number">0x899d</span>, <span class="hljs-number">0xa130</span>, <span class="hljs-number">0xe58f</span>, <span class="hljs-number">0x23f3</span>, <span class="hljs-number">0x5829</span>, <span class="hljs-number">0x6beb</span>, <span class="hljs-number">0x3681</span>, <span class="hljs-number">0x0054</span>, <span class="hljs-number">0xa189</span>, <span class="hljs-number">0x2765</span>, <span class="hljs-number">0xc63d</span>, <span class="hljs-number">0xbc68</span>]<br>maxg = <span class="hljs-built_in">max</span>(g)<br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(maxg+<span class="hljs-number">1</span>, <span class="hljs-number">2</span>**<span class="hljs-number">16</span>):<br>    <span class="hljs-keyword">if</span> gcd(know[<span class="hljs-number">0</span>], p) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> gcd(know[<span class="hljs-number">1</span>], p) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> gcd(know[<span class="hljs-number">2</span>], p) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> gcd(know[<span class="hljs-number">3</span>], p) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> gcd(know[<span class="hljs-number">4</span>], p) == <span class="hljs-number">1</span>:<br>        g04 = g[<span class="hljs-number">0</span>]<br><br>        g14 = g[<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> gcd(g04,p) != <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">continue</span><br>        g13 = g14 * invert(g04, p) % p<br><br>        g24 = g[<span class="hljs-number">2</span>]<br>        <span class="hljs-keyword">if</span> gcd(g14,p) != <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> gcd(g13,p) != <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">continue</span><br>        g23 = g24 * invert(g14, p) % p<br>        g22 = g23 * invert(g13, p) % p<br><br>        g34 = g[<span class="hljs-number">3</span>]<br>        <span class="hljs-keyword">if</span> gcd(g24,p) != <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> gcd(g23,p) != <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> gcd(g22,p) != <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">continue</span><br>        g33 = g34 * invert(g24, p) % p<br>        g32 = g33 * invert(g23, p) % p<br>        g31 = g32 * invert(g22, p) % p<br><br>        g44 = g[<span class="hljs-number">4</span>]<br>        <span class="hljs-keyword">if</span> gcd(g34,p) != <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> gcd(g33,p) != <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> gcd(g32,p) != <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> gcd(g31,p) != <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">continue</span><br>        g43 = g44 * invert(g34, p) % p<br>        g42 = g43 * invert(g33, p) % p<br>        g41 = g42 * invert(g32, p) % p<br>        g40 = g41 * invert(g31, p) % p<br><br>        k = [g40, g41, g42, g43, g44]<br>        flag = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>,<span class="hljs-number">42</span>):<br>            _k = k[<span class="hljs-number">0</span>]*k[<span class="hljs-number">1</span>]*k[<span class="hljs-number">2</span>]*k[<span class="hljs-number">3</span>]*k[<span class="hljs-number">4</span>]<br>            <span class="hljs-keyword">if</span> gcd(_k, p) != <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">break</span><br>            alp = g[i] * invert(_k, p) % p<br>            flag += <span class="hljs-built_in">chr</span>(alp)<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>                k[j] = alp = alp * k[j] % p<br><br>        <span class="hljs-keyword">if</span> flag.endswith(<span class="hljs-string">&#x27;&#125;&#x27;</span>):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;p = <span class="hljs-subst">&#123;p&#125;</span>&#x27;</span>)<br>            <span class="hljs-built_in">print</span>(flag.encode())<br><span class="hljs-comment">#flag&#123;749d39d4-78db-4c55-b4ff-bca873d0f18e&#125;</span><br></code></pre></td></tr></table></figure><h1 id="crypto162"><a href="#crypto162" class="headerlink" title="crypto162"></a>crypto162</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5,sha256<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br>cof_t = [[<span class="hljs-number">353</span>, -<span class="hljs-number">1162</span>, <span class="hljs-number">32767</span>], [<span class="hljs-number">206</span>, -<span class="hljs-number">8021</span>, <span class="hljs-number">42110</span>], [<span class="hljs-number">262</span>, -<span class="hljs-number">7088</span>, <span class="hljs-number">31882</span>], [<span class="hljs-number">388</span>, -<span class="hljs-number">6394</span>, <span class="hljs-number">21225</span>], [<span class="hljs-number">295</span>, -<span class="hljs-number">9469</span>, <span class="hljs-number">44468</span>], [<span class="hljs-number">749</span>, -<span class="hljs-number">3501</span>, <span class="hljs-number">40559</span>], [<span class="hljs-number">528</span>, -<span class="hljs-number">2690</span>, <span class="hljs-number">10210</span>], [<span class="hljs-number">354</span>, -<span class="hljs-number">5383</span>, <span class="hljs-number">18437</span>], [<span class="hljs-number">491</span>, -<span class="hljs-number">8467</span>, <span class="hljs-number">26892</span>], [<span class="hljs-number">932</span>, -<span class="hljs-number">6984</span>, <span class="hljs-number">20447</span>], [<span class="hljs-number">731</span>, -<span class="hljs-number">6281</span>, <span class="hljs-number">11340</span>], [<span class="hljs-number">420</span>, -<span class="hljs-number">5392</span>, <span class="hljs-number">44071</span>], [<span class="hljs-number">685</span>, -<span class="hljs-number">6555</span>, <span class="hljs-number">40938</span>], [<span class="hljs-number">408</span>, -<span class="hljs-number">8070</span>, <span class="hljs-number">47959</span>], [<span class="hljs-number">182</span>, -<span class="hljs-number">9857</span>, <span class="hljs-number">49477</span>], [<span class="hljs-number">593</span>, -<span class="hljs-number">3584</span>, <span class="hljs-number">49243</span>], [<span class="hljs-number">929</span>, -<span class="hljs-number">7410</span>, <span class="hljs-number">31929</span>], [<span class="hljs-number">970</span>, -<span class="hljs-number">4549</span>, <span class="hljs-number">17160</span>], [<span class="hljs-number">141</span>, -<span class="hljs-number">2435</span>, <span class="hljs-number">36408</span>], [<span class="hljs-number">344</span>, -<span class="hljs-number">3814</span>, <span class="hljs-number">18949</span>], [<span class="hljs-number">291</span>, -<span class="hljs-number">7457</span>, <span class="hljs-number">40587</span>], [<span class="hljs-number">765</span>, -<span class="hljs-number">7011</span>, <span class="hljs-number">32097</span>], [<span class="hljs-number">700</span>, -<span class="hljs-number">8534</span>, <span class="hljs-number">18013</span>], [<span class="hljs-number">267</span>, -<span class="hljs-number">2541</span>, <span class="hljs-number">33488</span>], [<span class="hljs-number">249</span>, -<span class="hljs-number">8934</span>, <span class="hljs-number">12321</span>], [<span class="hljs-number">589</span>, -<span class="hljs-number">9617</span>, <span class="hljs-number">41998</span>], [<span class="hljs-number">840</span>, -<span class="hljs-number">1166</span>, <span class="hljs-number">22814</span>], [<span class="hljs-number">947</span>, -<span class="hljs-number">5660</span>, <span class="hljs-number">41003</span>], [<span class="hljs-number">206</span>, -<span class="hljs-number">7195</span>, <span class="hljs-number">46261</span>], [<span class="hljs-number">784</span>, -<span class="hljs-number">9270</span>, <span class="hljs-number">28410</span>], [<span class="hljs-number">338</span>, -<span class="hljs-number">3690</span>, <span class="hljs-number">19608</span>], [<span class="hljs-number">559</span>, -<span class="hljs-number">2078</span>, <span class="hljs-number">44397</span>], [<span class="hljs-number">534</span>, -<span class="hljs-number">3438</span>, <span class="hljs-number">47830</span>], [<span class="hljs-number">515</span>, -<span class="hljs-number">2139</span>, <span class="hljs-number">39546</span>], [<span class="hljs-number">603</span>, -<span class="hljs-number">6460</span>, <span class="hljs-number">49953</span>], [<span class="hljs-number">234</span>, -<span class="hljs-number">6824</span>, <span class="hljs-number">12579</span>], [<span class="hljs-number">805</span>, -<span class="hljs-number">8793</span>, <span class="hljs-number">36465</span>], [<span class="hljs-number">245</span>, -<span class="hljs-number">5886</span>, <span class="hljs-number">21077</span>], [<span class="hljs-number">190</span>, -<span class="hljs-number">7658</span>, <span class="hljs-number">20396</span>], [<span class="hljs-number">392</span>, -<span class="hljs-number">7053</span>, <span class="hljs-number">19739</span>], [<span class="hljs-number">609</span>, -<span class="hljs-number">5399</span>, <span class="hljs-number">39959</span>], [<span class="hljs-number">479</span>, -<span class="hljs-number">8172</span>, <span class="hljs-number">45734</span>], [<span class="hljs-number">321</span>, -<span class="hljs-number">7102</span>, <span class="hljs-number">41224</span>], [<span class="hljs-number">720</span>, -<span class="hljs-number">4487</span>, <span class="hljs-number">11055</span>], [<span class="hljs-number">208</span>, -<span class="hljs-number">1897</span>, <span class="hljs-number">15237</span>], [<span class="hljs-number">890</span>, -<span class="hljs-number">4427</span>, <span class="hljs-number">35168</span>], [<span class="hljs-number">513</span>, -<span class="hljs-number">5106</span>, <span class="hljs-number">45849</span>], [<span class="hljs-number">666</span>, -<span class="hljs-number">1137</span>, <span class="hljs-number">23725</span>], [<span class="hljs-number">755</span>, -<span class="hljs-number">6732</span>, <span class="hljs-number">39995</span>], [<span class="hljs-number">589</span>, -<span class="hljs-number">6421</span>, <span class="hljs-number">43716</span>], [<span class="hljs-number">866</span>, -<span class="hljs-number">3265</span>, <span class="hljs-number">30017</span>], [<span class="hljs-number">416</span>, -<span class="hljs-number">6540</span>, <span class="hljs-number">34979</span>], [<span class="hljs-number">840</span>, -<span class="hljs-number">1305</span>, <span class="hljs-number">18242</span>], [<span class="hljs-number">731</span>, -<span class="hljs-number">6844</span>, <span class="hljs-number">13781</span>], [<span class="hljs-number">561</span>, -<span class="hljs-number">2728</span>, <span class="hljs-number">10298</span>], [<span class="hljs-number">863</span>, -<span class="hljs-number">5953</span>, <span class="hljs-number">23132</span>], [<span class="hljs-number">204</span>, -<span class="hljs-number">4208</span>, <span class="hljs-number">27492</span>], [<span class="hljs-number">158</span>, -<span class="hljs-number">8701</span>, <span class="hljs-number">12720</span>], [<span class="hljs-number">802</span>, -<span class="hljs-number">4740</span>, <span class="hljs-number">16628</span>], [<span class="hljs-number">491</span>, -<span class="hljs-number">6874</span>, <span class="hljs-number">29057</span>], [<span class="hljs-number">531</span>, -<span class="hljs-number">4829</span>, <span class="hljs-number">29205</span>], [<span class="hljs-number">363</span>, -<span class="hljs-number">4775</span>, <span class="hljs-number">41711</span>], [<span class="hljs-number">319</span>, -<span class="hljs-number">9206</span>, <span class="hljs-number">46164</span>], [<span class="hljs-number">317</span>, -<span class="hljs-number">9270</span>, <span class="hljs-number">18290</span>], [<span class="hljs-number">680</span>, -<span class="hljs-number">5136</span>, <span class="hljs-number">12009</span>], [<span class="hljs-number">880</span>, -<span class="hljs-number">2940</span>, <span class="hljs-number">34900</span>], [<span class="hljs-number">162</span>, -<span class="hljs-number">2587</span>, <span class="hljs-number">49881</span>], [<span class="hljs-number">997</span>, -<span class="hljs-number">5265</span>, <span class="hljs-number">20890</span>], [<span class="hljs-number">485</span>, -<span class="hljs-number">9395</span>, <span class="hljs-number">23048</span>], [<span class="hljs-number">867</span>, -<span class="hljs-number">1652</span>, <span class="hljs-number">18926</span>], [<span class="hljs-number">691</span>, -<span class="hljs-number">7844</span>, <span class="hljs-number">11180</span>], [<span class="hljs-number">355</span>, -<span class="hljs-number">5990</span>, <span class="hljs-number">13172</span>], [<span class="hljs-number">923</span>, -<span class="hljs-number">2018</span>, <span class="hljs-number">23110</span>], [<span class="hljs-number">214</span>, -<span class="hljs-number">4719</span>, <span class="hljs-number">23005</span>], [<span class="hljs-number">921</span>, -<span class="hljs-number">9528</span>, <span class="hljs-number">29351</span>], [<span class="hljs-number">349</span>, -<span class="hljs-number">7957</span>, <span class="hljs-number">20161</span>], [<span class="hljs-number">470</span>, -<span class="hljs-number">1889</span>, <span class="hljs-number">46170</span>], [<span class="hljs-number">244</span>, -<span class="hljs-number">6106</span>, <span class="hljs-number">23879</span>], [<span class="hljs-number">419</span>, -<span class="hljs-number">5440</span>, <span class="hljs-number">43576</span>], [<span class="hljs-number">930</span>, -<span class="hljs-number">1123</span>, <span class="hljs-number">29859</span>], [<span class="hljs-number">151</span>, -<span class="hljs-number">5759</span>, <span class="hljs-number">23405</span>], [<span class="hljs-number">843</span>, -<span class="hljs-number">6770</span>, <span class="hljs-number">36558</span>], [<span class="hljs-number">574</span>, -<span class="hljs-number">6171</span>, <span class="hljs-number">33778</span>], [<span class="hljs-number">772</span>, -<span class="hljs-number">1073</span>, <span class="hljs-number">44718</span>], [<span class="hljs-number">932</span>, -<span class="hljs-number">4037</span>, <span class="hljs-number">40088</span>], [<span class="hljs-number">848</span>, -<span class="hljs-number">5813</span>, <span class="hljs-number">27304</span>], [<span class="hljs-number">194</span>, -<span class="hljs-number">6016</span>, <span class="hljs-number">39770</span>], [<span class="hljs-number">966</span>, -<span class="hljs-number">6789</span>, <span class="hljs-number">14217</span>], [<span class="hljs-number">219</span>, -<span class="hljs-number">6849</span>, <span class="hljs-number">40922</span>], [<span class="hljs-number">352</span>, -<span class="hljs-number">6046</span>, <span class="hljs-number">18558</span>], [<span class="hljs-number">794</span>, -<span class="hljs-number">8254</span>, <span class="hljs-number">29748</span>], [<span class="hljs-number">618</span>, -<span class="hljs-number">5887</span>, <span class="hljs-number">15535</span>], [<span class="hljs-number">202</span>, -<span class="hljs-number">9288</span>, <span class="hljs-number">26590</span>], [<span class="hljs-number">611</span>, -<span class="hljs-number">4341</span>, <span class="hljs-number">46682</span>], [<span class="hljs-number">155</span>, -<span class="hljs-number">7909</span>, <span class="hljs-number">16654</span>], [<span class="hljs-number">935</span>, -<span class="hljs-number">5739</span>, <span class="hljs-number">39342</span>], [<span class="hljs-number">998</span>, -<span class="hljs-number">6538</span>, <span class="hljs-number">24363</span>], [<span class="hljs-number">125</span>, -<span class="hljs-number">5679</span>, <span class="hljs-number">36725</span>], [<span class="hljs-number">507</span>, -<span class="hljs-number">7074</span>, <span class="hljs-number">15475</span>], [<span class="hljs-number">699</span>, -<span class="hljs-number">5836</span>, <span class="hljs-number">47549</span>]]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cal</span>(<span class="hljs-params">i,cof</span>):<br>    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">3</span>:<br>        <span class="hljs-keyword">return</span> i+<span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> cof[<span class="hljs-number">2</span>]*cal(i-<span class="hljs-number">3</span>,cof)+cof[<span class="hljs-number">1</span>]*cal(i-<span class="hljs-number">2</span>,cof)+cof[<span class="hljs-number">0</span>]*cal(i-<span class="hljs-number">1</span>,cof)<br><br>s = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    s += cal(<span class="hljs-number">200000</span>,cof_t[i])<br><br><span class="hljs-built_in">print</span>(s)<br>s = <span class="hljs-built_in">str</span>(s)[-<span class="hljs-number">2000</span>:-<span class="hljs-number">1000</span>]<br>key = md5(s).hexdigest().decode(<span class="hljs-string">&#x27;hex&#x27;</span>)<br>check = sha256(key).hexdigest()<br>verify = <span class="hljs-string">&#x27;2cf44ec396e3bb9ed0f2f3bdbe4fab6325ae9d9ec3107881308156069452a6d5&#x27;</span><br><span class="hljs-keyword">assert</span>(check == verify)<br>aes = AES.new(key,AES.MODE_ECB)<br>data = flag + (<span class="hljs-number">16</span>-<span class="hljs-built_in">len</span>(flag)%<span class="hljs-number">16</span>)*<span class="hljs-string">&quot;\x00&quot;</span><br><span class="hljs-built_in">print</span> (aes.encrypt(data).encode(<span class="hljs-string">&#x27;hex&#x27;</span>))<br><span class="hljs-comment">#4f12b3a3eadc4146386f4732266f02bd03114a404ba4cb2dabae213ecec451c9d52c70dc3d25154b5af8a304afafed87</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®é¢˜ç›®æç¤ºï¼Œæƒ³åˆ°å°†é€’å½’å…¬å¼è½¬æ¢æˆçŸ©é˜µï¼ˆå‚è€ƒ<a href="https://blog.csdn.net/wdq347/article/details/8919645"> çº¿æ€§ä»£æ•°æ±‚è§£é€’æ¨å½¢å¼æ•°åˆ—çš„é€šé¡¹å…¬å¼_wdq347çš„åšå®¢-CSDNåšå®¢</a>ï¼‰</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031009349.png"/><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sagemath</span><br>cof_t = [[<span class="hljs-number">353</span>, -<span class="hljs-number">1162</span>, <span class="hljs-number">32767</span>], [<span class="hljs-number">206</span>, -<span class="hljs-number">8021</span>, <span class="hljs-number">42110</span>], [<span class="hljs-number">262</span>, -<span class="hljs-number">7088</span>, <span class="hljs-number">31882</span>], [<span class="hljs-number">388</span>, -<span class="hljs-number">6394</span>, <span class="hljs-number">21225</span>], [<span class="hljs-number">295</span>, -<span class="hljs-number">9469</span>, <span class="hljs-number">44468</span>], [<span class="hljs-number">749</span>, -<span class="hljs-number">3501</span>, <span class="hljs-number">40559</span>], [<span class="hljs-number">528</span>, -<span class="hljs-number">2690</span>, <span class="hljs-number">10210</span>], [<span class="hljs-number">354</span>, -<span class="hljs-number">5383</span>, <span class="hljs-number">18437</span>], [<span class="hljs-number">491</span>, -<span class="hljs-number">8467</span>, <span class="hljs-number">26892</span>], [<span class="hljs-number">932</span>, -<span class="hljs-number">6984</span>, <span class="hljs-number">20447</span>], [<span class="hljs-number">731</span>, -<span class="hljs-number">6281</span>, <span class="hljs-number">11340</span>], [<span class="hljs-number">420</span>, -<span class="hljs-number">5392</span>, <span class="hljs-number">44071</span>], [<span class="hljs-number">685</span>, -<span class="hljs-number">6555</span>, <span class="hljs-number">40938</span>], [<span class="hljs-number">408</span>, -<span class="hljs-number">8070</span>, <span class="hljs-number">47959</span>], [<span class="hljs-number">182</span>, -<span class="hljs-number">9857</span>, <span class="hljs-number">49477</span>], [<span class="hljs-number">593</span>, -<span class="hljs-number">3584</span>, <span class="hljs-number">49243</span>], [<span class="hljs-number">929</span>, -<span class="hljs-number">7410</span>, <span class="hljs-number">31929</span>], [<span class="hljs-number">970</span>, -<span class="hljs-number">4549</span>, <span class="hljs-number">17160</span>], [<span class="hljs-number">141</span>, -<span class="hljs-number">2435</span>, <span class="hljs-number">36408</span>], [<span class="hljs-number">344</span>, -<span class="hljs-number">3814</span>, <span class="hljs-number">18949</span>], [<span class="hljs-number">291</span>, -<span class="hljs-number">7457</span>, <span class="hljs-number">40587</span>], [<span class="hljs-number">765</span>, -<span class="hljs-number">7011</span>, <span class="hljs-number">32097</span>], [<span class="hljs-number">700</span>, -<span class="hljs-number">8534</span>, <span class="hljs-number">18013</span>], [<span class="hljs-number">267</span>, -<span class="hljs-number">2541</span>, <span class="hljs-number">33488</span>], [<span class="hljs-number">249</span>, -<span class="hljs-number">8934</span>, <span class="hljs-number">12321</span>], [<span class="hljs-number">589</span>, -<span class="hljs-number">9617</span>, <span class="hljs-number">41998</span>], [<span class="hljs-number">840</span>, -<span class="hljs-number">1166</span>, <span class="hljs-number">22814</span>], [<span class="hljs-number">947</span>, -<span class="hljs-number">5660</span>, <span class="hljs-number">41003</span>], [<span class="hljs-number">206</span>, -<span class="hljs-number">7195</span>, <span class="hljs-number">46261</span>], [<span class="hljs-number">784</span>, -<span class="hljs-number">9270</span>, <span class="hljs-number">28410</span>], [<span class="hljs-number">338</span>, -<span class="hljs-number">3690</span>, <span class="hljs-number">19608</span>], [<span class="hljs-number">559</span>, -<span class="hljs-number">2078</span>, <span class="hljs-number">44397</span>], [<span class="hljs-number">534</span>, -<span class="hljs-number">3438</span>, <span class="hljs-number">47830</span>], [<span class="hljs-number">515</span>, -<span class="hljs-number">2139</span>, <span class="hljs-number">39546</span>], [<span class="hljs-number">603</span>, -<span class="hljs-number">6460</span>, <span class="hljs-number">49953</span>], [<span class="hljs-number">234</span>, -<span class="hljs-number">6824</span>, <span class="hljs-number">12579</span>], [<span class="hljs-number">805</span>, -<span class="hljs-number">8793</span>, <span class="hljs-number">36465</span>], [<span class="hljs-number">245</span>, -<span class="hljs-number">5886</span>, <span class="hljs-number">21077</span>], [<span class="hljs-number">190</span>, -<span class="hljs-number">7658</span>, <span class="hljs-number">20396</span>], [<span class="hljs-number">392</span>, -<span class="hljs-number">7053</span>, <span class="hljs-number">19739</span>], [<span class="hljs-number">609</span>, -<span class="hljs-number">5399</span>, <span class="hljs-number">39959</span>], [<span class="hljs-number">479</span>, -<span class="hljs-number">8172</span>, <span class="hljs-number">45734</span>], [<span class="hljs-number">321</span>, -<span class="hljs-number">7102</span>, <span class="hljs-number">41224</span>], [<span class="hljs-number">720</span>, -<span class="hljs-number">4487</span>, <span class="hljs-number">11055</span>], [<span class="hljs-number">208</span>, -<span class="hljs-number">1897</span>, <span class="hljs-number">15237</span>], [<span class="hljs-number">890</span>, -<span class="hljs-number">4427</span>, <span class="hljs-number">35168</span>], [<span class="hljs-number">513</span>, -<span class="hljs-number">5106</span>, <span class="hljs-number">45849</span>], [<span class="hljs-number">666</span>, -<span class="hljs-number">1137</span>, <span class="hljs-number">23725</span>], [<span class="hljs-number">755</span>, -<span class="hljs-number">6732</span>, <span class="hljs-number">39995</span>], [<span class="hljs-number">589</span>, -<span class="hljs-number">6421</span>, <span class="hljs-number">43716</span>], [<span class="hljs-number">866</span>, -<span class="hljs-number">3265</span>, <span class="hljs-number">30017</span>], [<span class="hljs-number">416</span>, -<span class="hljs-number">6540</span>, <span class="hljs-number">34979</span>], [<span class="hljs-number">840</span>, -<span class="hljs-number">1305</span>, <span class="hljs-number">18242</span>], [<span class="hljs-number">731</span>, -<span class="hljs-number">6844</span>, <span class="hljs-number">13781</span>], [<span class="hljs-number">561</span>, -<span class="hljs-number">2728</span>, <span class="hljs-number">10298</span>], [<span class="hljs-number">863</span>, -<span class="hljs-number">5953</span>, <span class="hljs-number">23132</span>], [<span class="hljs-number">204</span>, -<span class="hljs-number">4208</span>, <span class="hljs-number">27492</span>], [<span class="hljs-number">158</span>, -<span class="hljs-number">8701</span>, <span class="hljs-number">12720</span>], [<span class="hljs-number">802</span>, -<span class="hljs-number">4740</span>, <span class="hljs-number">16628</span>], [<span class="hljs-number">491</span>, -<span class="hljs-number">6874</span>, <span class="hljs-number">29057</span>], [<span class="hljs-number">531</span>, -<span class="hljs-number">4829</span>, <span class="hljs-number">29205</span>], [<span class="hljs-number">363</span>, -<span class="hljs-number">4775</span>, <span class="hljs-number">41711</span>], [<span class="hljs-number">319</span>, -<span class="hljs-number">9206</span>, <span class="hljs-number">46164</span>], [<span class="hljs-number">317</span>, -<span class="hljs-number">9270</span>, <span class="hljs-number">18290</span>], [<span class="hljs-number">680</span>, -<span class="hljs-number">5136</span>, <span class="hljs-number">12009</span>], [<span class="hljs-number">880</span>, -<span class="hljs-number">2940</span>, <span class="hljs-number">34900</span>], [<span class="hljs-number">162</span>, -<span class="hljs-number">2587</span>, <span class="hljs-number">49881</span>], [<span class="hljs-number">997</span>, -<span class="hljs-number">5265</span>, <span class="hljs-number">20890</span>], [<span class="hljs-number">485</span>, -<span class="hljs-number">9395</span>, <span class="hljs-number">23048</span>], [<span class="hljs-number">867</span>, -<span class="hljs-number">1652</span>, <span class="hljs-number">18926</span>], [<span class="hljs-number">691</span>, -<span class="hljs-number">7844</span>, <span class="hljs-number">11180</span>], [<span class="hljs-number">355</span>, -<span class="hljs-number">5990</span>, <span class="hljs-number">13172</span>], [<span class="hljs-number">923</span>, -<span class="hljs-number">2018</span>, <span class="hljs-number">23110</span>], [<span class="hljs-number">214</span>, -<span class="hljs-number">4719</span>, <span class="hljs-number">23005</span>], [<span class="hljs-number">921</span>, -<span class="hljs-number">9528</span>, <span class="hljs-number">29351</span>], [<span class="hljs-number">349</span>, -<span class="hljs-number">7957</span>, <span class="hljs-number">20161</span>], [<span class="hljs-number">470</span>, -<span class="hljs-number">1889</span>, <span class="hljs-number">46170</span>], [<span class="hljs-number">244</span>, -<span class="hljs-number">6106</span>, <span class="hljs-number">23879</span>], [<span class="hljs-number">419</span>, -<span class="hljs-number">5440</span>, <span class="hljs-number">43576</span>], [<span class="hljs-number">930</span>, -<span class="hljs-number">1123</span>, <span class="hljs-number">29859</span>], [<span class="hljs-number">151</span>, -<span class="hljs-number">5759</span>, <span class="hljs-number">23405</span>], [<span class="hljs-number">843</span>, -<span class="hljs-number">6770</span>, <span class="hljs-number">36558</span>], [<span class="hljs-number">574</span>, -<span class="hljs-number">6171</span>, <span class="hljs-number">33778</span>], [<span class="hljs-number">772</span>, -<span class="hljs-number">1073</span>, <span class="hljs-number">44718</span>], [<span class="hljs-number">932</span>, -<span class="hljs-number">4037</span>, <span class="hljs-number">40088</span>], [<span class="hljs-number">848</span>, -<span class="hljs-number">5813</span>, <span class="hljs-number">27304</span>], [<span class="hljs-number">194</span>, -<span class="hljs-number">6016</span>, <span class="hljs-number">39770</span>], [<span class="hljs-number">966</span>, -<span class="hljs-number">6789</span>, <span class="hljs-number">14217</span>], [<span class="hljs-number">219</span>, -<span class="hljs-number">6849</span>, <span class="hljs-number">40922</span>], [<span class="hljs-number">352</span>, -<span class="hljs-number">6046</span>, <span class="hljs-number">18558</span>], [<span class="hljs-number">794</span>, -<span class="hljs-number">8254</span>, <span class="hljs-number">29748</span>], [<span class="hljs-number">618</span>, -<span class="hljs-number">5887</span>, <span class="hljs-number">15535</span>], [<span class="hljs-number">202</span>, -<span class="hljs-number">9288</span>, <span class="hljs-number">26590</span>], [<span class="hljs-number">611</span>, -<span class="hljs-number">4341</span>, <span class="hljs-number">46682</span>], [<span class="hljs-number">155</span>, -<span class="hljs-number">7909</span>, <span class="hljs-number">16654</span>], [<span class="hljs-number">935</span>, -<span class="hljs-number">5739</span>, <span class="hljs-number">39342</span>], [<span class="hljs-number">998</span>, -<span class="hljs-number">6538</span>, <span class="hljs-number">24363</span>], [<span class="hljs-number">125</span>, -<span class="hljs-number">5679</span>, <span class="hljs-number">36725</span>], [<span class="hljs-number">507</span>, -<span class="hljs-number">7074</span>, <span class="hljs-number">15475</span>], [<span class="hljs-number">699</span>, -<span class="hljs-number">5836</span>, <span class="hljs-number">47549</span>]]<br>B = [[<span class="hljs-number">3</span>],[<span class="hljs-number">2</span>],[<span class="hljs-number">1</span>]]<br>B = matrix(B)<br>s = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    A = [cof_t[i],[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>],[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>]]<br>    A = matrix(A)<br>    C = A^(<span class="hljs-number">200000</span>-<span class="hljs-number">2</span>)*B<br>    s += C[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>    <br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(s)[-<span class="hljs-number">2000</span>:-<span class="hljs-number">1000</span>])<br><br><br><span class="hljs-comment">#python</span><br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5,sha256<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> unhexlify<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br>s = <span class="hljs-string">&#x27;8365222366127410597598169954399481033882921410074214649102398062373189165630613993923060190128768377015697889610969869189338768501949778819512483009804114510646333513147157016729806311717181191848898389803672575716843797638777123435881498143998689577186959772296072473194533856870919617472555638920296793205581043222881816090693269730028856738454951305575065708823347157677411074157254186955326531403441609073128679935513392779152628590893913048822608749327034655805831509883357484164977115164240733564895591006693108254829407400850621646091808483228634435805213269066211974452289769022399418497986464430356041737753404266468993201044272042844144895601296459104534111416147795404108912440106970848660340526207025880755825643455720871621993251258247195860214917957713359490024807893442884343732717743882154397539800059579470352302688717025991780505564794824908605015195865226780305658376169579983423732703921876787723921599023795922881747318116849413935343800909756656082327558085457335537828343666748&#x27;</span><br>key = unhexlify(md5(s.encode()).hexdigest())<br><span class="hljs-built_in">print</span>(key)<br>check = sha256(key).hexdigest()<br>verify = <span class="hljs-string">&#x27;2cf44ec396e3bb9ed0f2f3bdbe4fab6325ae9d9ec3107881308156069452a6d5&#x27;</span><br><span class="hljs-keyword">assert</span> check == verify<br>aes = AES.new(key, AES.MODE_ECB)<br>cipher = unhexlify(<span class="hljs-string">&#x27;4f12b3a3eadc4146386f4732266f02bd03114a404ba4cb2dabae213ecec451c9d52c70dc3d25154b5af8a304afafed87&#x27;</span>)<br><span class="hljs-built_in">print</span>(aes.decrypt(cipher))<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>çº¿ä»£</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¾ŠåŸæ¯-2020-Simple</title>
    <link href="/2022/08/20/%5B%E7%BE%8A%E5%9F%8E%E6%9D%AF%202020%5DSimple/"/>
    <url>/2022/08/20/%5B%E7%BE%8A%E5%9F%8E%E6%9D%AF%202020%5DSimple/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¾ŠåŸæ¯-2020-Simple"><a href="#ç¾ŠåŸæ¯-2020-Simple" class="headerlink" title="[ç¾ŠåŸæ¯ 2020]Simple"></a>[ç¾ŠåŸæ¯ 2020]Simple</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> DES<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">import</span> random<br><br>key = <span class="hljs-string">&quot;abcdefgh&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">des_encrypt</span>(<span class="hljs-params">m</span>):<br>    des = DES.new(key, DES.MODE_ECB)<br>    res = des.encrypt(m)<br>    <span class="hljs-keyword">return</span> res<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_key</span>():<br>    p = getPrime(<span class="hljs-number">2048</span>)<br>    q = getPrime(<span class="hljs-number">2048</span>)<br>    n = p * q<br>    bit = n.bit_length()<br>    phi_n = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<span class="hljs-comment">#4096bits</span><br>    num = random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        u = getPrime(bit / <span class="hljs-number">4</span> - num)<span class="hljs-comment">#1024bitså·¦å³</span><br>        <span class="hljs-keyword">if</span> gmpy2.gcd(u, phi_n) != <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">continue</span><br>        t = gmpy2.invert(u, phi_n)<br>        e = bytes_to_long(des_encrypt(long_to_bytes(t)))<br>        <span class="hljs-keyword">if</span> gmpy2.gcd(e, phi_n) == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> (n, e)<br><br>P = getPrime(<span class="hljs-number">1024</span>)<br>Q = getPrime(<span class="hljs-number">1024</span>)<br>N = P * Q<br>E = <span class="hljs-number">65537</span><br>lcm = gmpy2.lcm(P-<span class="hljs-number">1</span>, Q-<span class="hljs-number">1</span>)<br>e1 = gmpy2.invert(getPrime(<span class="hljs-number">730</span>), lcm)<br>e2 = gmpy2.invert(getPrime(<span class="hljs-number">730</span>), lcm)<br>m = bytes_to_long(flag)<br>c = <span class="hljs-built_in">pow</span>(m, E, N)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;N = &quot;</span> + <span class="hljs-built_in">str</span>(N)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;e2 = &quot;</span> + <span class="hljs-built_in">str</span>(e2)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;c = &quot;</span> + <span class="hljs-built_in">str</span>(c)<br>_n, _e = gen_key()<br>_c = <span class="hljs-built_in">pow</span>(e1, _e, _n)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;_n = &quot;</span> + <span class="hljs-built_in">str</span>(_n)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;_e = &quot;</span> + <span class="hljs-built_in">str</span>(_e)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;_c = &quot;</span> + <span class="hljs-built_in">str</span>(_c)<br><br><span class="hljs-comment"># N = 14922959775784066499316528935316325825140011208871830627653191549546959775167708525042423039865322548420928571524120743831693550123563493981797950912895893476200447083386549353336086899064921878582074346791320104106139965010480614879592357793053342577850761108944086318475849882440272688246818022209356852924215237481460229377544297224983887026669222885987323082324044645883070916243439521809702674295469253723616677245762242494478587807402688474176102093482019417118703747411862420536240611089529331148684440513934609412884941091651594861530606086982174862461739604705354416587503836130151492937714365614194583664241</span><br><span class="hljs-comment"># e2 = 27188825731727584656624712988703151030126350536157477591935558508817722580343689565924329442151239649607993377452763119541243174650065563589438911911135278704499670302489754540301886312489410648471922645773506837251600244109619850141762795901696503387880058658061490595034281884089265487336373011424883404499124002441860870291233875045675212355287622948427109362925199018383535259913549859747158348931847041907910313465531703810313472674435425886505383646969400166213185676876969805238803587967334447878968225219769481841748776108219650785975942208190380614555719233460250841332020054797811415069533137170950762289</span><br><span class="hljs-comment"># c = 6472367338832635906896423990323542537663849304314171581554107495210830026660211696089062916158894195561723047864604633460433867838687338370676287160274165915800235253640690510046066541445140501917731026596427080558567366267665887665459901724487706983166070740324307268574128474775026837827907818762764766069631267853742422247229582756256253175941899099898884656334598790711379305490419932664114615010382094572854799421891622789614614720442708271653376485660139560819668239118588069312179293488684403404385715780406937817124588773689921642802703005341324008483201528345805611493251791950304129082313093168732415486813</span><br><span class="hljs-comment"># _n = 440489238264900860776949063845200558734341182253911040104689726634414488997095518284964514078079911856352824174173937251558842251349762631716798307360995414545464514355957499460396352456341058329671470384493547042182238690727766731554287411757022792467324815342497916894285866240516524768645049867582541899123632009100512965460004548382054578461249990158442675234477122521189649316341623637146867589119951831385717513964941787562068891523060843170463600255518728070958509224053460041184869943038887434435024428311063533345514827827485121055022245800823723487812635502090530820946638405345755666124356919178290008475459419571761406117827422883820901663916276191422633940699113760516149002609672230610575442643822241126824287790055264162725209120192661985259423924307785452001927701323647247782658775780117642900694831475681037634691806232211286493187121464506122012889644137364079403183353774265910554863733455161820449073656744610495110838881353269890437984975607744603113572453211439334880155671730821755361054781243639407912133971530394031933785051770725331242932929244719594830548310768937037042243794551163891451545574837838357398072638709907958216067999891842395376953596940377457308329336524488962532620850237570279134567668379</span><br><span class="hljs-comment"># _e = 861605654852236668414010386016782729745549477722901970933220380452652052018502113737968204529790495739233258572209422774257139256367928649554562561889013164344608269555777150446651170697255381344437283003508476336814132594917061838422072660017477530465048729471603537912401826065081663165440462979219418291010867656746870617893935758241591032350010782861988742885918015532494020406350897048575155800941991107973433915573030255070411073793489218782862225921465295055907689734413881263179029741870520797816282420230090879687287575328294171448819803530205292587159921154471289747571107461754730577787617451127061265552788125691266357724955508391085485034126227212788895416902189479587194999818764639403752596165043883295506465916277734482380252399557395621566461322664559344483889187037851178431011220134914560438657522787409632677020269086895142488669203469256629173438313487046130238010206678820035631793666627274457756812810094004185303422637897314225624079032617334487815628021058997628511963565055629435278956251869329025544623291223984190562109149316159243565323565271491356378189561005084676592786453581431393651385181326525455441155960432946682976515756161038293313433862078763004704003356983371787414787104076401121444383911561</span><br><span class="hljs-comment"># _c = 305937839546594439230463861584604201077374759167468410827830943528403007941779658881672477705113617614828611332427199124217887937391378281943856159571057598203709366891547401974326016980711130197275312149966105151573748299654404630150641461765232935912266448303266990247145252052886920248198006212876273661195636104435277145396636985516064154534488750879453474211852461463041960835745695368577903786702607508492658563272121038693371752289017330781719235752018697635304458321008407930986565779826278048082764754367267460637798512780153281325733348999426407049795270044819657399403071013496169060640127279409914638535996355848933378734045908205536540619564723586905257569498716707820544351092379516465943537383422680357333849248129118148543389733395686399565999586899123087310025442994131218237679518267106194962305629529210402269726736072967966518381350920965727690274018080619332676536005722214955949897632990356174168234408837737546230730400434240785496100281815168806724358191550743656843853383646410487436540166360406982096949178466861150173527305369007546917550634679211293496458282787881244581230558011582720632502886494712233308474151958909251857281750741736910202763888790654287328846201724930302778996046434656839999091303411</span><br><br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>_e</code>æ±‚å‡º<code>t</code>ã€‚è§‚å¯Ÿ<code>u = getPrime(bit / 4 - num)</code>å¯çŸ¥ $u&lt;_n^{\dfrac{1}{4}}$ï¼Œå¯ä»¥å°è¯•ç”¨<code>Wienner Attack</code>åˆ†è§£<code>_n</code>ï¼Œç„¶åæ±‚å‡º<code>e1</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> DES<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> iroot<br><br>key = <span class="hljs-string">&quot;abcdefgh&quot;</span>.encode()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">des_decrypt</span>(<span class="hljs-params">c</span>):<br>    des = DES.new(key, DES.MODE_ECB)<br>    res = des.decrypt(c)<br>    <span class="hljs-keyword">return</span> res<br><br>n = <span class="hljs-number">440489238264900860776949063845200558734341182253911040104689726634414488997095518284964514078079911856352824174173937251558842251349762631716798307360995414545464514355957499460396352456341058329671470384493547042182238690727766731554287411757022792467324815342497916894285866240516524768645049867582541899123632009100512965460004548382054578461249990158442675234477122521189649316341623637146867589119951831385717513964941787562068891523060843170463600255518728070958509224053460041184869943038887434435024428311063533345514827827485121055022245800823723487812635502090530820946638405345755666124356919178290008475459419571761406117827422883820901663916276191422633940699113760516149002609672230610575442643822241126824287790055264162725209120192661985259423924307785452001927701323647247782658775780117642900694831475681037634691806232211286493187121464506122012889644137364079403183353774265910554863733455161820449073656744610495110838881353269890437984975607744603113572453211439334880155671730821755361054781243639407912133971530394031933785051770725331242932929244719594830548310768937037042243794551163891451545574837838357398072638709907958216067999891842395376953596940377457308329336524488962532620850237570279134567668379</span><br>e = <span class="hljs-number">861605654852236668414010386016782729745549477722901970933220380452652052018502113737968204529790495739233258572209422774257139256367928649554562561889013164344608269555777150446651170697255381344437283003508476336814132594917061838422072660017477530465048729471603537912401826065081663165440462979219418291010867656746870617893935758241591032350010782861988742885918015532494020406350897048575155800941991107973433915573030255070411073793489218782862225921465295055907689734413881263179029741870520797816282420230090879687287575328294171448819803530205292587159921154471289747571107461754730577787617451127061265552788125691266357724955508391085485034126227212788895416902189479587194999818764639403752596165043883295506465916277734482380252399557395621566461322664559344483889187037851178431011220134914560438657522787409632677020269086895142488669203469256629173438313487046130238010206678820035631793666627274457756812810094004185303422637897314225624079032617334487815628021058997628511963565055629435278956251869329025544623291223984190562109149316159243565323565271491356378189561005084676592786453581431393651385181326525455441155960432946682976515756161038293313433862078763004704003356983371787414787104076401121444383911561</span><br>c = <span class="hljs-number">305937839546594439230463861584604201077374759167468410827830943528403007941779658881672477705113617614828611332427199124217887937391378281943856159571057598203709366891547401974326016980711130197275312149966105151573748299654404630150641461765232935912266448303266990247145252052886920248198006212876273661195636104435277145396636985516064154534488750879453474211852461463041960835745695368577903786702607508492658563272121038693371752289017330781719235752018697635304458321008407930986565779826278048082764754367267460637798512780153281325733348999426407049795270044819657399403071013496169060640127279409914638535996355848933378734045908205536540619564723586905257569498716707820544351092379516465943537383422680357333849248129118148543389733395686399565999586899123087310025442994131218237679518267106194962305629529210402269726736072967966518381350920965727690274018080619332676536005722214955949897632990356174168234408837737546230730400434240785496100281815168806724358191550743656843853383646410487436540166360406982096949178466861150173527305369007546917550634679211293496458282787881244581230558011582720632502886494712233308474151958909251857281750741736910202763888790654287328846201724930302778996046434656839999091303411</span><br><br>t = bytes_to_long(des_decrypt(long_to_bytes(e)))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wienerAttack</span>(<span class="hljs-params">_e, _n</span>):<br>    con_frac = continued_fraction(_e / _n)<br>    conv = con_frac.convergents()<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> conv:<br>        k, dg = _.numerator(), _.denominator()<br>        <span class="hljs-keyword">if</span> k == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> dg == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">continue</span><br>        _phi = _e * dg // k<br>        <span class="hljs-keyword">if</span> (_n - _phi + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> iroot(<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">pow</span>((_n - _phi + <span class="hljs-number">1</span>) // <span class="hljs-number">2</span>, <span class="hljs-number">2</span>) - _n), <span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]:<br>            delta = (_phi - _n - <span class="hljs-number">1</span>) ** <span class="hljs-number">2</span> - <span class="hljs-number">4</span> * _n<br>            _p = (_n + <span class="hljs-number">1</span> - _phi - <span class="hljs-built_in">int</span>(iroot(delta, <span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])) // <span class="hljs-number">2</span><br>            _q = _n // _p<br>            <span class="hljs-keyword">assert</span> _n % _q == <span class="hljs-number">0</span><br>            <span class="hljs-keyword">return</span> _p, _q<br><br>p, q = wienerAttack(t, n)<br>phi = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>d = gmpy2.invert(e, phi)<br>e1 = <span class="hljs-built_in">pow</span>(c, d, n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e1 = <span class="hljs-subst">&#123;e1&#125;</span>&#x27;</span>)<br><span class="hljs-comment">#e1 = 114552459553730357961013268333698879659007919035942930313432809776799669181481660306531243618160127922304264986001501784564575128319884991774542682853466808329973362019677284072646678280051091964555611220961719302320547405880386113519147076299481594997799884384012548506240748042365643212774215730304047871679706035596550898944580314923260982768858133395187777029914150064371998328788068888440803565964567662563652062845388379897799506439389461619422933318625765603423604615137217375612091221578339493263160670355032898186792479034771118678394464854413824347305505135625135428816394053078365603937337271798774138959</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦å‚è€ƒè®ºæ–‡(<a href="https://dunkirkturbo.github.io/2020/05/04/WriteUp-De1CTF2020-Crypto/howgrave-graham1999.pdf">Extending Wienerâ€™s Attack in the Presence of Many Decrypting Exponents</a>)ï¼Œåˆ©ç”¨<code>e1,e2</code>åˆ†è§£<code>N</code>ã€‚</p><p>æ ¹æ®è®ºæ–‡ä¸­ï¼Œç»“åˆ<code>Wiener</code>å’Œ<code>Guo</code>çš„æƒ³æ³•ã€‚</p><p>ä»¤$Î»(N)&#x3D;(p âˆ’ 1)(q âˆ’ 1)&#x2F;g$ ï¼Œ $s &#x3D; 1 âˆ’ p âˆ’ q$ï¼ŒæŒ‰é¢˜æ„æœ‰<br>$$<br>\begin{cases}<br>e_1d_1 &#x3D; 1\quad mod\ Î»(N)\\<br>e_2d_2 &#x3D; 1\quad mod\ Î»(N)<br>\end{cases}<br>&#x3D;&#x3D;&gt;<br>\begin{cases}<br>e_1d_1 &#x3D; 1+k_1Î»(N)\\<br>e_2d_2 &#x3D; 1+k_2Î»(N)<br>\end{cases}<br>$$<br>æ ¹æ®<code>Wiener</code>çš„æƒ³æ³•ï¼Œæœ‰ç­‰å¼<br>$$<br>\begin{cases}<br>e_1d_1gâˆ’k_1N&#x3D;g+k_1s\\<br>e_2d_2g âˆ’ k_2N &#x3D; g+k_2s<br>\end{cases}\tag{1}<br>$$<br>æ ¹æ®<code>Guo</code>çš„æƒ³æ³•ï¼Œæœ‰ç­‰å¼(ä¸Šé¢çš„å¼å­åšå˜æ¢)<br>$$<br>k_1e_2d_2 âˆ’ k_2d_1e_1 &#x3D; k_1 âˆ’ k_2\tag{2}<br>$$<br>ç”±(1)(2)å¯å¾— (ç¬¬ä¸‰ä¸ªç­‰å¼ç”±(1)ä¸­ä¸¤ä¸ªå¼å­ç›¸ä¹˜çš„æ¥çš„)<br>$$<br>\begin{cases}<br>e_1d_1g âˆ’ k_1N &#x3D; g + k_1s\\<br>k_1e_2d_2 âˆ’ k_2d_1e_1 &#x3D; k_1 âˆ’ k_2\\<br>d_1d_2g^2e_1e_2 âˆ’ d_1gk_2e_1N âˆ’ d_2gk_1e_2N + k_1k_2N_2 &#x3D; (g + k_1s)(g + k_2s)<br>\end{cases}<br>$$<br>è½¬æ¢æˆçŸ©é˜µæ–¹ç¨‹($k_1k_2$æ‹¿æ¥å‡‘æ–¹é˜µ)<br>$$<br>A &#x3D; [k_1k_2, d_1gk_2, d_2gk_1, d_1d_2g_2]<br>$$</p><p>$$<br>L &#x3D; \left[<br>\matrix{<br>1 &amp; âˆ’N &amp; 0 &amp; N^2\\<br> &amp; e_1 &amp; âˆ’e_1 &amp; âˆ’e_1N\\<br> &amp; &amp; e_2 &amp; âˆ’e_2N\\<br>&amp; &amp; &amp;e_1e_2<br>}<br>\right]<br>$$</p><p>$$<br>B&#x3D;[k_1k_2, k_2(g + k_1s), g(k_1 âˆ’ k_2),(g + k_1s)(g + k_2s)]<br>$$</p><p>$$<br>AÃ—L&#x3D;B<br>$$</p><p>å¦‚æœBæ˜¯Lçš„æœ€çŸ­å‘é‡ï¼Œå¯ä»¥é€šè¿‡LLLç®—æ³•æ±‚å‡ºBï¼Œä½†æ˜¯ä¸Šå¼å¹¶ä¸æ»¡è¶³<code>Minkowoskiâ€™s first theorem</code>ï¼ˆå•Šå§å•Šå§ï¼‰ï¼Œéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚</p><p>ä»¤$M_1&#x3D;N^{1&#x2F;2}$ï¼Œ$M_2&#x3D;N^{1+Î±}$ (å…¶ä¸­$Î±&lt;5&#x2F;14$)<br>$$<br>L_2 &#x3D; \left[<br>\matrix{<br>N &amp; âˆ’M_1N &amp; 0 &amp; N^2\\<br> &amp; M_1e_1 &amp; âˆ’M_2e_1 &amp; âˆ’e_1N\\<br> &amp; &amp; M_2e_2 &amp; âˆ’e_2N\\<br>&amp; &amp; &amp;e_1e_2<br>}<br>\right]<br>$$<br>$$<br>B_2&#x3D;[k_1k_2N, k_2(g + k_1s)M_1, g(k_1 âˆ’ k_2)M_2,(g + k_1s)(g + k_2s)]<br>$$</p><p>$$<br>AÃ—L_2&#x3D;B_2<br>$$</p><p>ç„¶åå¯¹$L_2$è¿›è¡ŒLLLæ±‚å‡ºBï¼Œè§£çŸ©é˜µæ–¹ç¨‹æ±‚å‡ºAï¼Œç„¶å<br>$$<br>\dfrac{e_1Ã—A[1]}{A[0]}&#x3D;\dfrac{e_1d_1gk_2}{k_1k_2}&#x3D;\dfrac{k_1Ï†(N)+g}{k_1}&#x3D;Ï†(N)+\dfrac{g}{k_1}â‰ˆÏ†(N)<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes<br><span class="hljs-keyword">import</span> gmpy2<br>N = <span class="hljs-number">14922959775784066499316528935316325825140011208871830627653191549546959775167708525042423039865322548420928571524120743831693550123563493981797950912895893476200447083386549353336086899064921878582074346791320104106139965010480614879592357793053342577850761108944086318475849882440272688246818022209356852924215237481460229377544297224983887026669222885987323082324044645883070916243439521809702674295469253723616677245762242494478587807402688474176102093482019417118703747411862420536240611089529331148684440513934609412884941091651594861530606086982174862461739604705354416587503836130151492937714365614194583664241</span><br>e1 = <span class="hljs-number">114552459553730357961013268333698879659007919035942930313432809776799669181481660306531243618160127922304264986001501784564575128319884991774542682853466808329973362019677284072646678280051091964555611220961719302320547405880386113519147076299481594997799884384012548506240748042365643212774215730304047871679706035596550898944580314923260982768858133395187777029914150064371998328788068888440803565964567662563652062845388379897799506439389461619422933318625765603423604615137217375612091221578339493263160670355032898186792479034771118678394464854413824347305505135625135428816394053078365603937337271798774138959</span><br>e2 = <span class="hljs-number">27188825731727584656624712988703151030126350536157477591935558508817722580343689565924329442151239649607993377452763119541243174650065563589438911911135278704499670302489754540301886312489410648471922645773506837251600244109619850141762795901696503387880058658061490595034281884089265487336373011424883404499124002441860870291233875045675212355287622948427109362925199018383535259913549859747158348931847041907910313465531703810313472674435425886505383646969400166213185676876969805238803587967334447878968225219769481841748776108219650785975942208190380614555719233460250841332020054797811415069533137170950762289</span><br>c = <span class="hljs-number">6472367338832635906896423990323542537663849304314171581554107495210830026660211696089062916158894195561723047864604633460433867838687338370676287160274165915800235253640690510046066541445140501917731026596427080558567366267665887665459901724487706983166070740324307268574128474775026837827907818762764766069631267853742422247229582756256253175941899099898884656334598790711379305490419932664114615010382094572854799421891622789614614720442708271653376485660139560819668239118588069312179293488684403404385715780406937817124588773689921642802703005341324008483201528345805611493251791950304129082313093168732415486813</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>):<br>    alpha2 = i/<span class="hljs-number">1000</span><br>    M1 = <span class="hljs-built_in">int</span>(gmpy2.mpz(N)**<span class="hljs-number">0.5</span>)<br>    M2 = <span class="hljs-built_in">int</span>( gmpy2.mpz(N)**(<span class="hljs-number">1</span>+alpha2) )<br>    D = diagonal_matrix(ZZ, [N, M1, M2, <span class="hljs-number">1</span>])<br>    B = Matrix(ZZ, [ [<span class="hljs-number">1</span>, -N,   <span class="hljs-number">0</span>,  N**<span class="hljs-number">2</span>],<br>                 [<span class="hljs-number">0</span>, e1, -e1, -e1*N],<br>                 [<span class="hljs-number">0</span>,  <span class="hljs-number">0</span>,  e2, -e2*N],<br>                 [<span class="hljs-number">0</span>,  <span class="hljs-number">0</span>,   <span class="hljs-number">0</span>, e1*e2] ]) * D<br>    L = B.LLL()<br>    v = Matrix(ZZ, L[<span class="hljs-number">0</span>])<br>    x = v * B**(-<span class="hljs-number">1</span>)<br>    phi = (x[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>]/x[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]*e1).floor()<br>    <span class="hljs-keyword">try</span>:<br>        d = inverse_mod( <span class="hljs-number">65537</span>, phi)<br>        m = long_to_bytes(power_mod(c, d, N))<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;GWHT&#x27;</span> <span class="hljs-keyword">in</span> m <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> m:<br>            <span class="hljs-built_in">print</span>(i)<br>            <span class="hljs-built_in">print</span>(m)<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://dunkirkturbo.github.io/2020/05/04/WriteUp-De1CTF2020-Crypto/howgrave-graham1999.pdf">Extending Wienerâ€™s Attack in the Presence of Many Decrypting Exponents</a></p><p><a href="https://lazzzaro.github.io/2020/05/06/crypto-RSA/#%E5%A4%9A%E7%BB%84%E4%BD%8E%E8%A7%A3%E5%AF%86%E6%8C%87%E6%95%B0%E6%94%BB%E5%87%BB">RSA | Lazzaro (lazzzaro.github.io)</a></p><p><a href="https://4xwi11.github.io/posts/1b1ce809/?highlight=simple#Extending-Wiener%E2%80%99s-Attack">Wienerâ€™s Attack | 4XWi11â€™s Blog</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
      <tag>Wiener&#39;s Attack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022-å·…å³°æå®¢-ç½‘ç»œå®‰å…¨æŠ€èƒ½æŒ‘æˆ˜èµ›</title>
    <link href="/2022/08/20/2022-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E6%8C%91%E6%88%98%E8%B5%9B/"/>
    <url>/2022/08/20/2022-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E6%8C%91%E6%88%98%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="point-power"><a href="#point-power" class="headerlink" title="point-power"></a>point-power</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secrets <span class="hljs-keyword">import</span> flag<br><br><span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(flag)==<span class="hljs-number">42</span><br>p=getPrime(<span class="hljs-number">600</span>)<br>a=bytes_to_long(flag)<br>b=randrange(<span class="hljs-number">2</span>,p-<span class="hljs-number">1</span>)<br>E=EllipticCurve(GF(p),[a,b])<br>G=E.random_element()<br><br>x1,y1,_=G<br>G=<span class="hljs-number">2</span>*G<br>x2,y2,_=G<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;p = <span class="hljs-subst">&#123;p&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;b = <span class="hljs-subst">&#123;b&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;x1 = <span class="hljs-subst">&#123;x1&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;x2 = <span class="hljs-subst">&#123;x2&#125;</span>&quot;</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">p = 3660057339895840489386133099442699911046732928957592389841707990239494988668972633881890332850396642253648817739844121432749159024098337289268574006090698602263783482687565322890623</span><br><span class="hljs-string">b = 1515231655397326550194746635613443276271228200149130229724363232017068662367771757907474495021697632810542820366098372870766155947779533427141016826904160784021630942035315049381147</span><br><span class="hljs-string">x1 = 2157670468952062330453195482606118809236127827872293893648601570707609637499023981195730090033076249237356704253400517059411180554022652893726903447990650895219926989469443306189740</span><br><span class="hljs-string">x2 = 1991876990606943816638852425122739062927245775025232944491452039354255349384430261036766896859410449488871048192397922549895939187691682643754284061389348874990018070631239671589727</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>æ¤­åœ†æ›²çº¿åŸºç¡€çŸ¥è¯†</p><p>ä¸€èˆ¬æ–¹ç¨‹ï¼š$ y^2&#x3D;x^3+ax+b $ (å¿˜è®°äº†å·¦è¾¹æ˜¯å¹³æ–¹ï¼Œæäº†è›®ä¹…è¿˜ä¸çŸ¥é“è‡ªå·±é”™å“ªäº†)</p><p>å› ä¸ºæœ‰$(x2,y2)&#x3D;2(x1,y1)$ï¼Œæ‰€ä»¥å¯ä»¥è¿ç«‹æ–¹ç¨‹</p><p>æœ‰å¦‚ä¸‹ç­‰å¼<br>$$<br>\begin{cases} y_1^2&#x3D;x_1^2+ax_1+b\\<br>y_2^2&#x3D;x_2^2+ax_2+b\\<br>k&#x3D;\dfrac{3x_1^2+a}{2y_1}\\<br>x_2&#x3D;-2x_1+k^2 \end{cases}<br>$$<br>åŒ–ç®€æœ‰<br>$$<br> 4(x_1^3+ax_1+b)(2x_1+x_2)-(3x_1^2+a)&#x3D;0<br>$$<br>åœ¨$GF(p)$ä¸Šè§£è¯¥æ–¹ç¨‹å³å¯å¾—åˆ° $a$ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>p = <span class="hljs-number">3660057339895840489386133099442699911046732928957592389841707990239494988668972633881890332850396642253648817739844121432749159024098337289268574006090698602263783482687565322890623</span><br>b = <span class="hljs-number">1515231655397326550194746635613443276271228200149130229724363232017068662367771757907474495021697632810542820366098372870766155947779533427141016826904160784021630942035315049381147</span><br>x1 = <span class="hljs-number">2157670468952062330453195482606118809236127827872293893648601570707609637499023981195730090033076249237356704253400517059411180554022652893726903447990650895219926989469443306189740</span><br>x2 = <span class="hljs-number">1991876990606943816638852425122739062927245775025232944491452039354255349384430261036766896859410449488871048192397922549895939187691682643754284061389348874990018070631239671589727</span><br>R.&lt;a&gt; = PolynomialRing(Zmod(p), implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br><br>f = <span class="hljs-number">4</span>*(<span class="hljs-number">2</span>*x1+x2)*(x1^<span class="hljs-number">3</span> + a*x1 + b) - (<span class="hljs-number">3</span>*x1^<span class="hljs-number">2</span>+a)^<span class="hljs-number">2</span><br>f = f.monic()<br>root = f.roots()<br><span class="hljs-built_in">print</span>(root)<br><span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> root:<br>    m = <span class="hljs-built_in">int</span>(each[<span class="hljs-number">0</span>])<br>    <span class="hljs-built_in">print</span>(long_to_bytes(m))<br></code></pre></td></tr></table></figure><h1 id="strange-curve"><a href="#strange-curve" class="headerlink" title="strange curve"></a>strange curve</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secrets <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">P,Q</span>):<br>    (x1,y1)=P<br>    (x2,y2)=Q<br><br><br>    x3=(x1+x2)*(<span class="hljs-number">1</span>+y1*y2)*invert((<span class="hljs-number">1</span>+x1*x2)*(<span class="hljs-number">1</span>-y1*y2),p)%p<br>    y3=(y1+y2)*(<span class="hljs-number">1</span>+x1*x2)*invert((<span class="hljs-number">1</span>-x1*x2)*(<span class="hljs-number">1</span>+y1*y2),p)%p<br><br>    <span class="hljs-keyword">return</span> (x3,y3)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mul</span>(<span class="hljs-params">e,P</span>):<br>    Q=(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br>    e=e%p<br>    <span class="hljs-keyword">while</span> e:<br>        <span class="hljs-keyword">if</span> e&amp;<span class="hljs-number">1</span>:<br>            Q=add(Q,P)<br>        P=add(P,P)<br>        e&gt;&gt;=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> Q<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Legendre</span>(<span class="hljs-params">a,p</span>):<br>    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">pow</span>((a%p+p)%p,(p-<span class="hljs-number">1</span>)//<span class="hljs-number">2</span>,p))%p<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_ts</span>(<span class="hljs-params">p</span>):<br>    p=p-<span class="hljs-number">1</span><br>    count=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> p%<span class="hljs-number">2</span>==<span class="hljs-number">0</span>:<br>        count+=<span class="hljs-number">1</span><br>        p=p//<span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> count,p<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_nonre</span>(<span class="hljs-params">p</span>):<br>    a=random.randint(<span class="hljs-number">1</span>,p)<br>    <span class="hljs-keyword">while</span> Legendre(a,p)==<span class="hljs-number">1</span>:<br>        a=random.randint(<span class="hljs-number">1</span>,p)<br>    <span class="hljs-keyword">return</span> a<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">amm2</span>(<span class="hljs-params">a,p</span>):<br>    t,s=get_ts(p)<br>    ta=<span class="hljs-built_in">pow</span>(get_nonre(p),s,p)<br>    tb=<span class="hljs-built_in">pow</span>(a,s,p)<br>    h=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,t):<br>        d=<span class="hljs-built_in">pow</span>(tb,<span class="hljs-number">2</span>**t-<span class="hljs-number">1</span>-i,p)<br>        <span class="hljs-keyword">if</span> d==<span class="hljs-number">1</span>:<br>            k=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">else</span>:<br>            k=<span class="hljs-number">1</span><br>        tb=(tb*<span class="hljs-built_in">pow</span>(ta,<span class="hljs-number">2</span>*k,p))%p<br>        h=(h*<span class="hljs-built_in">pow</span>(ta,k,p))%p<br>        ta=<span class="hljs-built_in">pow</span>(ta,<span class="hljs-number">2</span>,p)<br>    <span class="hljs-keyword">return</span> h*<span class="hljs-built_in">pow</span>(a,(s+<span class="hljs-number">1</span>)//<span class="hljs-number">2</span>,p)%p  <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solve</span>(<span class="hljs-params">a,b,c,p</span>):<br>    tmpa=<span class="hljs-number">1</span><br>    tmpb=b*inverse(a,p)%p<br>    tmpc=c*inverse(a,p)%p<br>    <span class="hljs-keyword">assert</span> Legendre(tmpb**<span class="hljs-number">2</span>*inverse(<span class="hljs-number">4</span>,p)-tmpc,p)==<span class="hljs-number">1</span><br>    res1=(amm2(tmpb**<span class="hljs-number">2</span>*inverse(<span class="hljs-number">4</span>,p)-tmpc,p)-tmpb*inverse(<span class="hljs-number">2</span>,p))%p<br>    res2=(-amm2(tmpb**<span class="hljs-number">2</span>*inverse(<span class="hljs-number">4</span>,p)-tmpc,p)-tmpb*inverse(<span class="hljs-number">2</span>,p))%p<br>    <span class="hljs-keyword">return</span> (res1,res2)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lift</span>(<span class="hljs-params">x,a,b,p</span>):<br>    tmp=b*(x**<span class="hljs-number">2</span>-<span class="hljs-number">1</span>)*inverse(a*x,p)%p<br>    <span class="hljs-keyword">return</span> solve(<span class="hljs-number">1</span>,-tmp,-<span class="hljs-number">1</span>,p)[<span class="hljs-number">0</span>]<br><br>p=<span class="hljs-number">9410547699903726871336507117271550134683191140146415131394654141737636910570480327296351841515571767317596027931492843621727002889086193529096531342265353</span><br>a=<span class="hljs-number">54733430689690725746438325219044741824500093621550218736194675295708808435509</span><br>b=<span class="hljs-number">75237024593957256761258687646797952793573177095902495908321724558796076392871</span><br>x=bytes_to_long(flag)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        y=lift(x,a,b,p)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span>:<br>        x+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">continue</span><br><br><span class="hljs-keyword">assert</span> a*x*(y**<span class="hljs-number">2</span>-<span class="hljs-number">1</span>)%p == b*y*(x**<span class="hljs-number">2</span>-<span class="hljs-number">1</span>)%p<br><br>P=(x,y)<br>e=<span class="hljs-number">65537</span><br><br>eP=mul(e,P)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;P = <span class="hljs-subst">&#123;P&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;eP = <span class="hljs-subst">&#123;eP&#125;</span>&quot;</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">P = (56006392793427940134514899557008545913996191831278248640996846111183757392968770895731003245209281149, 5533217632352976155681815016236825302418119286774481415122941272968513081846849158651480192550482691343283818244963282636939305751909505213138032238524899)</span><br><span class="hljs-string">eP = (mpz(8694229840573103722999959579565187489450818138005222030156495740841851804943200684116883831426548909867463656993852596745698999492932194245562062558787005), mpz(9279986963919197374405152604360936066932975197577643570458423456304679111057526702737279809805694360981565554506626018364382736924914907001214909905449002))</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>    <br></code></pre></td></tr></table></figure><p>éé¢„æœŸè§£ã€‚æ ¹æ®ä¸‹é¢ä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        y=lift(x,a,b,p)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span>:<br>        x+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åªè¦å¯¹ $x$ å¾€ä¸‹çˆ†ç ´å°±è¡Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br>m = <span class="hljs-number">56006392793427940134514899557008545913996191831278248640996846111183757392968770895731003245209281149</span><br><span class="hljs-keyword">while</span> m!=<span class="hljs-number">0</span>:<br>    flag = long_to_bytes(m)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> flag:<br>        <span class="hljs-built_in">print</span>(flag)<br>        <span class="hljs-keyword">break</span><br>    m -= <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h1 id="learning-with-fault"><a href="#learning-with-fault" class="headerlink" title="learning_with_fault"></a>learning_with_fault</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secrets <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RSA</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,p,q,e</span>):<br>        self.p=p<br>        self.q=q<br>        self.e=e<br>        self.phi=(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>        self.d=invert(self.e,self.phi)<br>        self.dp=self.d%(p-<span class="hljs-number">1</span>)<br>        self.dq=self.d%(q-<span class="hljs-number">1</span>)<br>        self.n=p*q<br>        self.N=getPrime(<span class="hljs-number">512</span>)*getPrime(<span class="hljs-number">512</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">sign</span>(<span class="hljs-params">self,message</span>):<br>        m=bytes_to_long(message)<br>        sig_p=<span class="hljs-built_in">pow</span>(m,self.dp,self.p)<br>        sig_q=<span class="hljs-built_in">pow</span>(m,self.dq,self.q)<br>        alpha=q*invert(q,p)<br>        beta=p*invert(p,q)<br>        <span class="hljs-keyword">return</span> long_to_bytes((alpha*sig_p+beta*sig_q)%self.n)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">corrupt_sign</span>(<span class="hljs-params">self,message</span>):<br>        m=bytes_to_long(message)<br>        sig_p=<span class="hljs-built_in">pow</span>(m,self.dp,self.p)<br>        sig_q=<span class="hljs-built_in">pow</span>(m,self.dq,self.q)<br>        alpha=q*invert(q,p)<br>        beta=p*invert(p,q)<br>        <span class="hljs-keyword">return</span> long_to_bytes((alpha*sig_p+beta*sig_q)%self.N)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">self,message,sign</span>):<br>        <span class="hljs-keyword">return</span> long_to_bytes(<span class="hljs-built_in">pow</span>(bytes_to_long(sign),self.e,self.n)) == message<br><br>p=getPrime(<span class="hljs-number">512</span>)<br>q=getPrime(<span class="hljs-number">512</span>)<br>e=<span class="hljs-number">65537</span><br>rsa=RSA(p,q,e)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;sign.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f1:<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;corrupted_sign.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f2:<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>            message=os.urandom(<span class="hljs-number">64</span>)<br>            sign=rsa.sign(message)<br>            corrupted_sign=rsa.corrupt_sign(message)<br>            <span class="hljs-keyword">assert</span> rsa.verify(message,sign)<br>            f1.write(<span class="hljs-built_in">str</span>(sign)+<span class="hljs-string">&#x27;\n&#x27;</span>)<br>            f2.write(<span class="hljs-built_in">str</span>(corrupted_sign)+<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>enc=<span class="hljs-built_in">pow</span>(bytes_to_long(flag),rsa.e,rsa.n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;n = <span class="hljs-subst">&#123;rsa.n&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;N = <span class="hljs-subst">&#123;rsa.N&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;e = <span class="hljs-subst">&#123;rsa.e&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;enc = <span class="hljs-subst">&#123;enc&#125;</span>&quot;</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">n = 99670316685463632788041383175090257045961799409733877510733415402955763322569510896091638507050126669571444467488936880059210773298729542608112756526719533574432327269721804307073353651955251188547245641771980139488000798458617636759823027148955008149512692983471670488580994385743789385091027299901520585729</span><br><span class="hljs-string">N = 81332992898551792936282861980393365170738006789835182134055801566584228471896473385776004610279937176800796971820133195300006470892468060034368863410462219133248069442508287516929262751427926825122839525496671527936622212986733708071962237633082743396115729744192159064241674410003857168101669882043743570731</span><br><span class="hljs-string">e = 65537</span><br><span class="hljs-string">enc = 2476965183785968993595493003363618829317072815989584886372189393899395623714779397354978469504773556228655475355703015337932838278988328384587983506790841663233499939173166353582189202860394411808445422387063648198432242875738065748287034529713834303346017134249834382745931627301273142828893469374138264396</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>è¸ç ´é“é‹æ— è§…å¤„ï¼Œå¾—æ¥å…¨ä¸è´¹åŠŸå¤«ã€‚è¿˜å¾—æ˜¯Laä½¬çš„åšå®¢é¦™ï¼ğŸ˜­</p><p><a href="https://lazzzaro.github.io/2020/05/06/crypto-RSA/#RSA-CRT">RSA | Lazzaro (lazzzaro.github.io)</a></p><p>è®ºæ–‡å‚è€ƒï¼š<a href="https://eprint.iacr.org/2011/388.pdf">CMBX12 (iacr.org)</a></p><p>çœ‹å®Œä¹‹åå¹¶ä¸æ˜¯å¾ˆæ‡‚ï¼ˆå¤ªèœäº†ï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">import</span> gmpy2,sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">orthogonal_lattice</span>(<span class="hljs-params">B</span>):<br>    LB = B.transpose().left_kernel(basis=<span class="hljs-string">&quot;LLL&quot;</span>).basis_matrix()<br>    <span class="hljs-keyword">return</span> LB<br><br>n = <span class="hljs-number">99670316685463632788041383175090257045961799409733877510733415402955763322569510896091638507050126669571444467488936880059210773298729542608112756526719533574432327269721804307073353651955251188547245641771980139488000798458617636759823027148955008149512692983471670488580994385743789385091027299901520585729</span><br>N = <span class="hljs-number">81332992898551792936282861980393365170738006789835182134055801566584228471896473385776004610279937176800796971820133195300006470892468060034368863410462219133248069442508287516929262751427926825122839525496671527936622212986733708071962237633082743396115729744192159064241674410003857168101669882043743570731</span><br>e = <span class="hljs-number">65537</span><br>enc = <span class="hljs-number">2476965183785968993595493003363618829317072815989584886372189393899395623714779397354978469504773556228655475355703015337932838278988328384587983506790841663233499939173166353582189202860394411808445422387063648198432242875738065748287034529713834303346017134249834382745931627301273142828893469374138264396</span><br><br>cs_ = [<br>    <span class="hljs-string">b&quot;\x17\x8bb3\x11\x1b\xb9\xb9\xc6M\xb0\xaa\x07-\x1ar\xff\xfb\xb4&amp;H7!\xb8\xa1\xce\x07\x8b\x84M\x0bw=m\x193Oc\x97w\x8f\xffy4\xa1\x99\xfcW\xf9|\xeb\xa4\x00\x1eD*\xe8-&#x27;\xa9\xef\x9d\x13*\xf4\xbe\x9d\x9b&amp;w\xcb\xfd\xb3\xb6\xa3n\xb8\xb4\x97vT\xec@\x86\xd1R\xb0\n\xe1uC\xbc\x14\xeb\xceSu&amp;&#x27;&#123;\xb9\x12\x90\x82\xc7,\xdbr\xebP\xe1j\x11E\xd5\x17\xe1\xd0D\xe7z\x94vt\xbf\x1a\xc4+&quot;</span><br>    ,<span class="hljs-string">b&#x27;\x1dJ\xc5\xb2\xbe\x05\xe6\xc8T\n\xbe&quot;\xbeU\xed\xba\xec\x85\x05\x8b\x8ayE\xa3&#125;0\x1dk\xa7\x10\xe2E\x19\xfe\x10\x90\xef\r\xdbV\x8b\x87|(\xd1\xb5\xfd\xb9\x14\x84\x05\x03\x81\xc8\xf6\xe5\x8a\x92\xa0\x01I\x8aG:\xc19\x9e\xf0\x8eZ\\Yx\x80|\xb7\x80\x0e\xcd\xa3\xba6\xf8\x98\xb1pB\x05\x8aT#\xbf\x1e\x1b~\xcb\xf5\t\xa2H9\xc9n\x81e\xa2\x15\x97\x11\xe4\x93\xf2\xe6\x80\x97\x99G\xb5\xfe\x07/\xd2\xbd\xad\xcf\x04\x9e\xd0&#x27;</span><br>    ,<span class="hljs-string">b&#x27;Gs\xda\xb8\x8a\x85\xccK\xf7\xa8y\x16\xa5\xf0\x06\xbe\xeb\x83&amp;&#125;a\x85q\x8d:\x1fSb\xb8\xc5\x84\xba*[\xe7\xbb&#123;\x86\xd3\xb3r\xb6\xaaCN\x93\x1d&lt;(\xe2\x1c;\x8crU\x8fD=W\xa7\x0b\xc7\xeag\x96\x06\xd6\xbb\xe4\x04b\xd8\x02\x12\xd6\xfa2\x1e#\xf0\xde\x8b\x88M\xd2\xf47\\\x98\xe0\x04Fu\x1bsy\xf2\xc4\xad\xd6Y\x81u~B:\xd2\x1f\xb3\xab\x01:\xfa\xdf\x19J8\xd0\x18RN\xfe,CA\x15\xb3\xe0&#x27;</span><br>    ,<span class="hljs-string">b&quot;0I\xda5\x9f\x05v\x17\xdc\xd4q\xd6\x83,\x9d\r\xccc\x8a\xa1\xd4U\xd3\x18\xc9\xc6g\xcd\nX\x99Ah\xed&#125;\xf3\xb1(\xd5I\xc6\x0f@yw9\x9d\xfdv\x15x\xeaRA\xd6\xb0\x1e\xb5B\xe5\x05cc\x06m\xf4NN&#x27;\x02q\x1a\x11\xe4\x87P:\xc8\x11a\x9f\xbd\x9c\x98x\xda\xea\xc4\xa8f\x89s\xcaJ\x7f\xeb\xd8\xc1G#\xf4\xdc\xe2\x01\xf2\xa5\x95\x19`)2!\xf5\xb9\xf0\xf2\xbb\xf8\x0bF&amp;&amp;`\xfd*\xe1\xf2\x9c&quot;</span><br>    ,<span class="hljs-string">b&#x27;:\x99/Hxt\xd1\xd4\xaaB\xd6H\x16\xe1\xc9\xe2\xb3\xc3\xa9b\xd3\x96\x9c\x05x6\xf1\xc3d\xa2\xd1U+.\x1b\xac^\xf6Mh7\xb7\x03\x8e\xdc\xca\x0bn\xac\xed\x92\xb8x\x04)\x0f|\x11\xcc\xfa\xf2\\\xba\xee\xc4X\xa8(\x05\xf2\xb5\x8f&amp;\xf3\xff\x1eB\xe7\x94\xf4\xa6\x00!\xe5v\xd9x\xf0s\x94\xf4D(\xa9g\x118\xa7z\x83\xad\xdb\xe6\xe3\xe7\xf8\xf2\xef\xe5@\xe9\x13\x00OB\xcc\x05\xd1,_=\xd2/Og\x81\xa6+&#x27;</span><br>    ,<span class="hljs-string">b&#x27;\x1c|\xb6\xcc\xdfj\xc5\xa0s\xac w\xa6\xf2\x87D\xe3\xf9Y\xf5=\xf0\x0b\xd9\xea\x89,+e\x1e\xb7m#\x99\xd1\x87\x17Z\xed\x1d\xc8\x97;\xa0K\x05.\xaa&lt;\xc6s\xcf\xa2\xa2\\PO\x12&amp;\xb4\x11\xec\xad\x10\xf8\xf7\xd1\xd3_\x80\x17\xe0\x1eP\x93\xe3\xc2\x1e\x03\xea]^\xc6a\x9c\xcb\x90\xbb\x9f\x8by\xa5dhM\xce\xc7\xbc\xf7\xafe\xcf\xc1\xf1\x18@\x1e\xe2\xdb\xfb\xe4^\xc8\xe7\x19\xccnY\xc6o\x7fL\x9fV\xd4\xc4\x15\xe8&#x27;</span><br>]<br>s_ = [<br>    <span class="hljs-string">b&#x27;\t\x8b\xde\x98\x84\x1d\x9e\xd4\xa0\xb7f\xe0\x05\xb1\xbd8\xb9G\xe3\x0c\x83\x8a\xe5\xf0G7\x12\x1eT\x85o-B\xe4_\xd2\x04\xd9:\xab\xdf\xa1 \x8f\xedt+\x0f\xce\xb5\x90\xaaK\xf0U~v=\x84\xe7$G\xf5\xfb\xd3ok~V\x1a\xec&amp;\x15\x18Y\x0c\x80u\xafF\xf1\x10\x9f\xf2\xe6\xa6\x9a\xbb\xbd+\xa4l\xa9\x11\xd5\t\x13\x16\xa3\xde\xe1\xdfZ\xa9$r\xb5`\xc9&quot;\x11\xab\xc5\x87\xc4\x1d@\x9e\xa4t\xdb#\xbdj\xcb\x95\xefK&#x27;</span><br>    ,<span class="hljs-string">b&#x27;z/\xd6\xfb\xd8\xfa\xc4\xed\xbd\x99\xd0\xa0\x90\xcb\xca\x83\xd8B\xa7\xf4\xbd\xe0\xc2&amp;\x1aQl(\xd6p\x8f\x89=tT\xf1(\xeb\xab\x84[oR\x1fl=\xda\xf5\x18q\x8f\xa7k\x00\x1b\x1a\x0ei\x1fa.ho\x15\x04\x12\xe4\xc2\xd7\x19\x92\xc3\x9b\xfe\xd5\xb6R\xf8\x95\x9fr\x93\xddD\x1c[\x873\xd5\x06\x1b\xa5\x82/6\x9a\x13\xcf\xa4\xcd\x0e]\t\xad?\xd6\x84\r\x90\xef\x86\xf15)\xe34\xf7\xb77\xef\x0c&amp;\xdb8\xa6\xe0\xa5a&#x27;</span><br>    ,<span class="hljs-string">b&#x27;U\x0b\xf6\x9cm])1\xe2\xad\xf9G\x8f\xa2\xbc&#125;\xd7\x18\x89\xa4\xfdFQ\x80m&quot;\xf9\to^\xd9A\x98\xd2\xca\x1e(b\xa8\xbe\xc2m\xf7\n[O\x00\xbc\x87\x17\xed\x0cG\xf2=H\x0e\xc0\x14+\xcb\xd0\x1feT2\xf2Th\xec\xc2\xcf&gt;6,&lt;\x88X\x8f\xe9g\xa8\x00\xafr\x05\x95\rj\x9c\xc6\n\xbb\x8a\x019\xc1\x1ef#\x02[Rh\xd8\xdc|&#123;6\xeb\xe8U\x91\xa4\xeb&#125;\xf4s;E\xe72$i\xdft\xff\&#x27;&#x27;</span><br>    ,<span class="hljs-string">b&#x27;[\x94\x95T\xf4\xc4\xca\x8drO\x80\x14\xc9&lt;H\xa2a\xdc\xf4`\xac&gt;\xab\x03\xfa\x80Sx\x99\x14\x83$U\x0b\xfa\x8fv\xfd\xda\x1a\xa0\xebY\xaa\x01\xe2XsG\t\xcf\xae\xa0\xbf\x82iG\tQ \xb1\xfe\xa5k\x12\xd9\x12\xf7\x95\xa3\xa5\x8d`z\x19\x1a\x90-\x9aj\x15\xf6f&gt;\x18\x08\xb8\x1f\x88\x1a\x80Th\xd0\x15\x9bw#\&#x27;`K\xa5\xf1\xbf&quot;\xe79\xaf\xc7z%p\xa5\x9f\x14\xef\&#x27;1\x11\x05Gg\xe9\xda\xc9\x18~[&#x27;</span><br>    ,<span class="hljs-string">b&#x27;:\xefRE\xd7\xa1?\xf3\xb5\xf7\xdd\xe2\xb6~\x85014\xc0\x8a\x80\xe1\xb5#\x94\x10\xb2\xa0\xfe\x87\xd1t\xc3$&amp;\xde8\x195\xcd\xf4@3\x15\xcaK\xcc\xcd\r:\x83*\xd7l\xb6\xf2&#125; \tJ\xb5xKfjh.\xfb\xb5\x91\xc6\xf2x\x8e\x83\xdc\xc3\xef\x8b\x8dW\xa6\xa6\xb0w\xd8\xf2G\xa5-\xc3\x87\x17;\xedH`:\xcd\x08ts\x9eqPE\xd7\xfc\xc4\x98\xb5\xe0\xad\xb7A\x7f\xcb\x01\xbd\x98\xd3Ea\xb9\x07\x80\xf8\x19&#x27;</span><br>    ,<span class="hljs-string">b&quot;8\xca\x7f!;\\\xde\x1b\x80i\x9b!\x1c??u\x13\x955\xd0xG\xff\xd7\xba\xfe+\x95\x0eu^\x15\x1a\x0e*\xfe\x8a\xafM\xc0\xd1Ty\xd7\xf1\xa7@\xd6\xa6\xee\x0c:It\x1a\xeag\xfc\x0c\xaf\x02&lt;\x03T)\xeb\xb0\x15\x1cz\x85\x992\xa9\xbe\x9bm\xc4D\x83\xf7\xb5T\xdd9?\x94\xd4\x13\xb4\xb3\x8d\xa9\x92\x9dt\x86\xdb\x0b$\x19l\xb1\xb9\x05&#x27;o\xf3!\t\x01\x93&#x27;z\x15P\x88\xd7iN\n\x8bA\xb5\xd2&#125;\xe8\x10&quot;</span><br>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    s_[i] = bytes_to_long(s_[i])<br>    cs_[i] = bytes_to_long(cs_[i])<br><br>l = <span class="hljs-number">6</span><br><br>v = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(cs_)):<br>    v.append(<span class="hljs-built_in">int</span>(crt([s_[i], cs_[i]], [n, N])))<br>    <br>v = vector(ZZ, v)<br>Lv = orthogonal_lattice(Matrix(v))<br>L1 = orthogonal_lattice(Lv.submatrix(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, l-<span class="hljs-number">2</span>, l))<br>x, y = L1<br><span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-number">333</span>)):<br>    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-number">333</span>)):<br>        z = a*x+b*y<br>        <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> (v-z):<br>            tmp =  gcd(each,n)<br>            <span class="hljs-keyword">if</span> tmp&gt;<span class="hljs-number">1</span>:<br>                p = tmp<br>                <span class="hljs-built_in">print</span>(p)<br>                q = n//p<br>                <span class="hljs-keyword">assert</span> p*q == n<br>                phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>                d = gmpy2.invert(e,phi)<br>                m = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(enc,d,n))<br>                <span class="hljs-built_in">print</span>(long_to_bytes(m))<br>                sys.exit()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ECC</tag>
      
      <tag>RSA-CRT Fault Attack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬å…­å±Šâ€œå¼ºç½‘æ¯â€å…¨å›½ç½‘ç»œå®‰å…¨æŒ‘æˆ˜èµ›  çº¿ä¸Šèµ›</title>
    <link href="/2022/08/04/%E7%AC%AC%E5%85%AD%E5%B1%8A%E2%80%9C%E5%BC%BA%E7%BD%91%E6%9D%AF%E2%80%9D%E5%85%A8%E5%9B%BD%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8C%91%E6%88%98%E8%B5%9B-%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
    <url>/2022/08/04/%E7%AC%AC%E5%85%AD%E5%B1%8A%E2%80%9C%E5%BC%BA%E7%BD%91%E6%9D%AF%E2%80%9D%E5%85%A8%E5%9B%BD%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8C%91%E6%88%98%E8%B5%9B-%E7%BA%BF%E4%B8%8A%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="polydiv"><a href="#polydiv" class="headerlink" title="polydiv"></a>polydiv</h1><p>4ä½å“ˆå¸Œçˆ†ç ´ + æ‰‹æ’¸40éæ±‚b(x) ï¼ˆsagemathä¸Šä¸‹è½½pwnåº“æŠ¥é”™ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#4ä½å“ˆå¸Œçˆ†ç ´</span><br>part = <span class="hljs-string">&#x27;dSyotqgg1qNFrKru&#x27;</span><br>hashstr = <span class="hljs-string">&#x27;3c678965931a61af1a4950bb0da7fc02980bbf4524dbff107a941aabccc8bf8e&#x27;</span><br><br>table = string.ascii_letters+string.digits<br><br><span class="hljs-keyword">for</span> XXXX <span class="hljs-keyword">in</span> permutations(table, <span class="hljs-number">4</span>):<span class="hljs-comment">#å…¨æ’åˆ—</span><br>    XXXX = <span class="hljs-string">&#x27;&#x27;</span>.join(XXXX)<br>    <span class="hljs-keyword">if</span>( sha256((XXXX + part).encode()).hexdigest() == hashstr ):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;XXXX = <span class="hljs-subst">&#123;XXXX&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">break</span><br>        <br><span class="hljs-comment">#æ±‚b(x),å› ç»™å‡ºçš„ç³»æ•°éƒ½ä¸º1ï¼Œæ•…åœ¨Zmod(2)ä¸Šæ±‚è§£</span><br>R.&lt;x&gt; = Zmod(<span class="hljs-number">2</span>)[]<br>r = <br>a = <br>c = <br><br><span class="hljs-built_in">print</span>((r-c)/(a))<span class="hljs-comment">#print((r-c).quo_rem(a))</span><br></code></pre></td></tr></table></figure><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031039767.png"/><h1 id="ASR"><a href="#ASR" class="headerlink" title="ASR"></a>ASR</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> getPrime<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> falg<br>pad = <span class="hljs-keyword">lambda</span> s:s + <span class="hljs-built_in">bytes</span>([(<span class="hljs-built_in">len</span>(s)-<span class="hljs-number">1</span>)%<span class="hljs-number">16</span>+<span class="hljs-number">1</span>]*((<span class="hljs-built_in">len</span>(s)-<span class="hljs-number">1</span>)%<span class="hljs-number">16</span>+<span class="hljs-number">1</span>))<br><br>n = getPrime(<span class="hljs-number">128</span>)**<span class="hljs-number">2</span> * getPrime(<span class="hljs-number">128</span>)**<span class="hljs-number">2</span> * getPrime(<span class="hljs-number">128</span>)**<span class="hljs-number">2</span> * getPrime(<span class="hljs-number">128</span>)**<span class="hljs-number">2</span><br>e = <span class="hljs-number">3</span><br><br>flag = pad(flag)<br><span class="hljs-built_in">print</span>(flag)<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(flag) &gt;= <span class="hljs-number">48</span>)<br>m = <span class="hljs-built_in">int</span>.from_bytes(flag,<span class="hljs-string">&#x27;big&#x27;</span>)<br>c = <span class="hljs-built_in">pow</span>(m,e,n)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;n = <span class="hljs-subst">&#123;n&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e = <span class="hljs-subst">&#123;e&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;c = <span class="hljs-subst">&#123;c&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><p><code>yafu</code>åˆ†è§£ã€‚<code>phi</code> ä¸ <code>e</code> ä¸äº’ç´ ï¼Œå¯ä»¥é‡ç»„æ¨¡æ•°ä¹Ÿå¯ä»¥åœ¨æœ‰é™åŸŸä¸Šå¼€æ ¹æ±‚<code>m_i</code>ï¼Œå†<code>CRT</code>ç»„åˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#Sage</span><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br>e = <span class="hljs-number">3</span><br>c = <span class="hljs-number">945272793717722090962030960824180726576357481511799904903841312265308706852971155205003971821843069272938250385935597609059700446530436381124650731751982419593070224310399320617914955227288662661442416421725698368791013785074809691867988444306279231013360024747585261790352627234450209996422862329513284149</span><br>p1 = <span class="hljs-number">225933944608558304529179430753170813347</span><br>p2 = <span class="hljs-number">223213222467584072959434495118689164399</span><br>p3 = <span class="hljs-number">260594583349478633632570848336184053653</span><br>p4 = <span class="hljs-number">218566259296037866647273372633238739089</span><br><br>P.&lt;x&gt;=PolynomialRing(Zmod(p1),implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>f=x^e-c<br>root1=f.monic().roots()<br><br>P.&lt;x&gt;=PolynomialRing(Zmod(p2),implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>f=x^e-c<br>root2=f.monic().roots()<br><br>P.&lt;x&gt;=PolynomialRing(Zmod(p3),implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>f=x^e-c<br>root3=f.monic().roots()<br><br>P.&lt;x&gt;=PolynomialRing(Zmod(p4),implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>f=x^e-c<br>root4=f.monic().roots()<br><br><span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> root1:<br>    x=a[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> root2:<br>        y=b[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> root3:<br>            z = c[<span class="hljs-number">0</span>]<br>            <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> root4:<br>                s = d[<span class="hljs-number">0</span>]<br>                solution = long_to_bytes(CRT_list([<span class="hljs-built_in">int</span>(x), <span class="hljs-built_in">int</span>(y),<span class="hljs-built_in">int</span>(z),<span class="hljs-built_in">int</span>(s)], [p1,p2,p3,p4]))<br>                <span class="hljs-keyword">if</span> solution.startswith(<span class="hljs-string">b&#x27;flag&#x27;</span>):<br>                    <span class="hljs-built_in">print</span>(solution)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">n = p2**2 * p3**2</span><br><span class="hljs-string">phi = p2*(p2-1)*p3*(p3-1)</span><br><span class="hljs-string">d = gmpy2.invert(e,phi)</span><br><span class="hljs-string">m = pow(c,d,n)</span><br><span class="hljs-string">print(long_to_bytes(m))</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>                    <br>                    <br></code></pre></td></tr></table></figure><h1 id="Factor"><a href="#Factor" class="headerlink" title="Factor"></a>Factor</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding:utf-8</span><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><span class="hljs-keyword">from</span> flag <span class="hljs-keyword">import</span> flag<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen1</span>():<br>r = <span class="hljs-number">2</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>p2 = getPrime(<span class="hljs-number">1792</span>)<br>p1 = getPrime(<span class="hljs-number">1792</span>)<br><br>q1 = getPrime(<span class="hljs-number">512</span>)<br>q2 = getPrime(<span class="hljs-number">512</span>)<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(p1-p2) &lt; (p1//(<span class="hljs-number">2</span>*r*q1*q2))):<br>n1, n2 = (p1**r)*q1, (p2**r)*q2<br><span class="hljs-keyword">break</span><br><br>phi1 = (p1**(r-<span class="hljs-number">1</span>))*(p1-<span class="hljs-number">1</span>)*(q1-<span class="hljs-number">1</span>)<br>phi2 = (p2**(r-<span class="hljs-number">1</span>))*(p2-<span class="hljs-number">1</span>)*(q2-<span class="hljs-number">1</span>)<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>e1 = randint(<span class="hljs-number">5</span>, (p1-<span class="hljs-number">1</span>)*(q1-<span class="hljs-number">1</span>))<br>e2 = randint(<span class="hljs-number">5</span>, (p2-<span class="hljs-number">1</span>)*(q2-<span class="hljs-number">1</span>))<br><span class="hljs-keyword">if</span> gcd(e1, e2) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> gcd(phi1, e1) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> gcd(phi2, e2) == <span class="hljs-number">1</span>:<br><span class="hljs-keyword">break</span><br><span class="hljs-keyword">return</span> n11, n12, e11, e12<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen2</span>():<br>r = <span class="hljs-number">7</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>p = getPrime(<span class="hljs-number">512</span>)<br>q =getPrime(<span class="hljs-number">512</span>)<br>N = (p**r)*q<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">bin</span>(N)) == <span class="hljs-number">4096</span>:<br><span class="hljs-keyword">break</span><br><br>idx = (r*(r-<span class="hljs-number">1</span>)) / ((r+<span class="hljs-number">1</span>)*(r+<span class="hljs-number">1</span>))<br>delta = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(mpz(N), idx))<br>phi = (p**(r-<span class="hljs-number">1</span>))*(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>d1 = getPrime(<span class="hljs-built_in">int</span>(<span class="hljs-number">2048</span>*idx)//<span class="hljs-number">2</span>)<br>d2 = getPrime(<span class="hljs-built_in">int</span>(<span class="hljs-number">2048</span>*idx)//<span class="hljs-number">2</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(d1-d2) &lt; delta:<br>m1 = invert(d1, phi)<br>m2 = invert(d2, phi)<br><span class="hljs-keyword">break</span><br><br>e2 = <span class="hljs-number">0x10001</span><br><span class="hljs-keyword">return</span> n2, e2, m1, m2<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen3</span>():<br>r = <span class="hljs-number">7</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>p = getPrime(<span class="hljs-number">512</span>)<br>q =getPrime(<span class="hljs-number">512</span>)<br>N = (p**r)*q<br>phi = (p**(r-<span class="hljs-number">1</span>))*(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">bin</span>(N))-<span class="hljs-number">2</span> == <span class="hljs-number">4096</span>:<br><span class="hljs-keyword">break</span><br><br>idx = (r*(r-<span class="hljs-number">1</span>)) / ((r+<span class="hljs-number">1</span>)*(r+<span class="hljs-number">1</span>))<br>delta = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(mpz(N), idx))<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>b = getRandomNBitInteger(<span class="hljs-built_in">int</span>(<span class="hljs-number">2048</span>*idx)//<span class="hljs-number">2</span>)<br>a = getRandomNBitInteger(<span class="hljs-built_in">int</span>(<span class="hljs-number">2048</span>*idx)//<span class="hljs-number">2</span>)<br><span class="hljs-keyword">if</span> a*b &lt; delta:<br>e = invert(a, phi)*b<br><span class="hljs-keyword">return</span> n3, e3, b<br><br><br>n11, n12, e11, e12 = gen1()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;n11=<span class="hljs-subst">&#123;n11&#125;</span>\nn12=<span class="hljs-subst">&#123;n12&#125;</span>\ne11=<span class="hljs-subst">&#123;e11&#125;</span>\ne12=<span class="hljs-subst">&#123;e12&#125;</span>\n&quot;</span>)<br>n2, e2, m1, m2 = gen2()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;n2=<span class="hljs-subst">&#123;n2&#125;</span>\ne2=<span class="hljs-subst">&#123;e2&#125;</span>\n&quot;</span>)<br>n3, e3, b = gen3()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;n3=<span class="hljs-subst">&#123;n3&#125;</span>\ne3=<span class="hljs-subst">&#123;e3&#125;</span>\n&quot;</span>)<br><br>m3 = bytes_to_long(flag)<br>c11 = powmod(m1, e11, n11)<br>c12 = powmod(m2, e12, n12)<br>c2 = powmod(b, e2, n2)<br>c3 = powmod(m3, e3, n3)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;c11=<span class="hljs-subst">&#123;c11&#125;</span>\nc12=<span class="hljs-subst">&#123;c12&#125;</span>\nc2=<span class="hljs-subst">&#123;c2&#125;</span>\nc3=<span class="hljs-subst">&#123;c3&#125;</span>\n&quot;</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">n11=801049932940568005269978912396585741498810389425615966036828877784238116634177290247194019425111606811005728521368879065336038221361037062407029836155148874719789714345603547779284558101833801155509762818376470874215789574939002212274399950433269775325144015468620263028557804618774240232988157961712628677901130814703917513004114547234375629747176834581166306552311075522669403347828095831520693563291249869832390698646691647204371133362254846234990175138047928703289833460734235302093916147489509206061923877623300596194317059884824322527532662470348274079800781120104946546063500763852622187404608639542858285661288293918912184354236687975919510300221932074135531028314170475917110204254042336116619335841213418990605590620842511615815443114612333881430920769002933370887494558640833005339906706603497809846863863967391543647049224309556936909768179259581851520214669904560467640473144481633920438487615788689262961741053146610554997224861331949716721056553499531186695425439163222802917813140266513735841447717418846360096652592844940362932171019143434080184728093326143821165097895058935372215708948088248596585127475770021962501262915274497478428868130455122612016408381607561200802267038869516896665387576895570245272035575637</span><br><span class="hljs-string">n12=635401970340205725139325006504978344512744926958688031423448003992072769931808217486709574151492230879374574313457662436423263437792389711379687512056391117410807565492548718691166183372633151644917135272259770997096195518489056319350258673723095417922153182423913759272893696867426193704479752772511081457729513843682588951499551132432923147997238597538055902932123792252593514225328196541483451747314048080824405530742533473914329294346486691684904100406972073037050089861816604505650042953778360621934380815999541183067585498606053857125775979915077329566722531830089714823979965934190338538564188253271016367299890015449611141166780048763403252309160517164569110740561584100839212138661881615351382946813818078899882595313362934594951895560189003438775450675343590147821186953526262224973333962454561275321925151619178204499342339749637758100126893330994252902926509705617882239610380420830791088907378397226817514095468815228186716220057075095711894070032344613244803934541318573847029365563159918970404057137270884587905766828750387753130065274147902379993224780149663600462492281891320702134153853359393588902750423972068679293373333869389393970353760507436913233657422185531482023237384247535554666481760197851108297145147371</span><br><span class="hljs-string">e11=1898839980562048754607069073527844852132536432440793106124181406514770178066775988232362054809850074774981836898118651469424148725970708199461113088705044905633592578936333918328544505910996746428679299419879472444790941363558025887620570856598548320246426354974395765243741646121743413447132297230365355148066914830856904433750379114692122900723772114991199979638987571559860550883470977246459523068862898859694461427148626628283198896659337135438506574799585378178678790308410266713256003479022699264568844505977513537013529212961573269494683740987283682608189406719573301573662696753903050991812884192192569737274321828986847640839813424701894578472933385727757445011291134961124822612239865</span><br><span class="hljs-string">e12=1262647419018930022617189608995712260095623047273893811529510754596636390255564988827821761126917976430978175522450277907063247981106405519094560616378241247111698915199999363948015703788616554657275147338766805289909261129165025156078136718573006479030827585347458143645738353716189131209398056741864848486818076440355778886993462012533397208330925057305502653219173629466948635110352752162442552541812665607516753186595817376029707777599029040724727499952161261179707271814405907165207904499722122779096230563548011491932378429654764486855147873135769116637484240454596231092684424572258119768093562747249251518965380465994055049411715353547147466711949391814550591591830515262296556050946881</span><br><span class="hljs-string"></span><br><span class="hljs-string">n2=209798341155088334158217087474227805455138848036904381404809759100627849272231840321985747935471287990313456209656625928356468120896887536235496490078123448217785939608443507649096688546074968476040552137270080120417769906047001451239544719039212180059396791491281787790213953488743488306241516010351179070869410418232801398578982244984544906579574766534671056023774009163991804748763929626213884208260660722705479782932001102089367261720194650874553305179520889083170973755913964440175393646890791491057655226024046525748177999422035469428780228224800114202385209306803288475439775037067014297973202621118959024226798935588827359265962780792266516120013602384766460619793738405476219362508944225007365127768741191310079985425349292613888185378948854602285379329682053663283534930182589905986063348509703027498270111412063194971956202729807710253369312175636837558252924035002153389909587349043986253518050303628071319876207392440085675892353421232158925122721273720564784886530611286461575045181073744696415657043278123662980166364494583141297996445429477446442693717498789391918530672770193730629928408766563592081857706608049076318165712479742423149330311238462044666384622153280310696667586565906758451118241914402257039981388209</span><br><span class="hljs-string">e2=65537</span><br><span class="hljs-string"></span><br><span class="hljs-string">n3=539779851369541956878655738599584730199799866957191805784596190682932284216781781433367450841202917758999300635019369629627621029957135109806205877317954671312041249493462048283611940752235036153024920172209763260723728345918562258401803973624430150143563078517485996070862532682695228590709019451174548520135142052216785774589096706631010293690859363524584240662502290912412366366114571976050857239915691266377257797199583543940504695517331512813468837128344612227973709974625418257243011036826241599265375741977853552204640800449679679351666009764297016524814036295707311913711955324055690490892097177271718850857268982130811714517356073266905474635370690445031512184247179039751734276906533177939993769044135143389748416635981226449566039039202521305851567296884751935162651063209779647359922622084851547605090230221057349511482738300221222563908357379545905837110168948295030747460300104202323692732549831403834387939156877086852393515817984772384147449841124275061609701453997579569931391166586163299940486204581696722731952467570857217406030804590055255431828403195798003509083922294733709507134156466158642941338493323430671502043066148246348074878064089651235355282144209668143249348243220714471988019011613749340243917652821</span><br><span class="hljs-string">e3=8179300978753084587812861894047395225516049110376948812109811319430275614612773726672345893359691900281432484382670047044697374818043512731533402576374645405477207239801498428774783768163880078495448747421425078521981578408638790336528372019271073712013371141939808017049399434858687299480461753638164719404612128939787055797762174745092074547412183349192156638711750872083313795551439465507724807626674514935170104573715458782366469587138508845980490673890245713729782917089910271980557159592807350504157192913530007199510144004848020221181558472160543018733124225266127379373751910439604459368078652499029070936707349862139053913745186413782066470461478961703013591655136140060879250067379283913798867648758171004535775565306842444545755351202796833177560656564652632975685912935281581268141803696686952259539945588609591385807620108279333498170028167338690235117003515264281843953984997958878272347778561933726792473981855755454522886321669676790813189668084373153897754540290867346751033567500922477317530445967753955221454744946208555394588111484610700789566547507402309549957740815535069057837915204852490930168843605732632328017129154852857227895362549146737618906180651623216848500491438142456250653458053922622240299736136335179639180898730269690699965799644757774472147210271111150769048976871249731156387939260749192370361488285775377622944817570292095201906142567403539151179209316853493906909989301225903409448461436855145</span><br><span class="hljs-string"></span><br><span class="hljs-string">c11=18979511327426975645936984732782737165217332092805655747550406443960209507493506811471688957217003792679188427155591583024966608843371190136274378868083075515877811693937328204553788450031542610082653080302874606750443090466407543829279067099563572849101374714795279414177737277837595409805721290786607138569322435729584574023597293220443351227559400618351504654781318871214405850541820427562291662456382362148698864044961814456827646881685994720468255382299912036854657082505810206237294593538092338544641919051145900715456411365065867357857347860000894624247098719102875782712030938806816332901861114078070638796157513248160442185781635520426230183818695937457557248160135402734489627723104008584934936245208116232179751448263136309595931691285743580695792601141363221346329077184688857290503770641398917586422369221744736905117499140140651493031622040723274355292502182795605723573863581253354922291984335841915632076694172921289489383700174864888664946302588049384130628381766560976143458735712162489811693014419190718601945154153130272620025118408017441490090252674737105557818759190934585829634273698371996797545908125156282869589331913665938038870431655063063535672001112420959158339261862052308986374193671007982914711432579</span><br><span class="hljs-string">c12=336587005671304527566745948355290412636261748969581976214239578621816863343117433524033533838636941679300497270909696775021031004312477997130741361709262822736904340641138652359632950455651920464042448022467664596484055174270895170499076347333381222768518599018520948098943626229061996126260154604038101543546588917619576702866444998578555907070990331574722135141778182631559802154493815687284077524469331290249057291163803290619701104007028836609832847351748020354798788508790258935718399783002069490123663345156902440501507117289747695510266461539019431610123351176227443612317037899257774045751487135646052309277098939919088029284437221840182769808850184827681307611389353392683707516141736067793897378911235819049432542758429901945202632117089595899280390575706266239252841152490534353760118231918190110043319877744119083811214707593122757409240645257409097436061825613686773916466122693168971062418046703969144004779270391320645495586024342668002497155358623795942692477164489475917351003149045087283510728981096449890130735055015075557614253867698702479920619299919816768972581273507837309179450374634916567083251630203067065663910073926990517108921490442919372774170201239734064819301693527366233007925670043499415100789027665</span><br><span class="hljs-string">c2=18352572608055902550350386950073774530453857897248738030380007830701135570310622004368605208336922266513238134127496822199799761713782366178177809597137102612444147565578155260524747439899150012223027218489946124086276814899675563837669559795153349686434242738207425653079514376089070980797596457151965772460109519623572502109592612394316680202287712465721767341302234806130244551387296133051760893033194962691942040228545508895009195291106297581470066545991352668826197346830561010198417527057944507902143965634058848276017283478933675052993657822322866778994956205033704582047618324071045349072526540250707463112668579342537349567247810715604220690215313641329522674080146047291570752430231923566302463491877377617044768978997438596643458475128936850994934029476030136643053997549253792076260765459166618369864942681056864815996253315631930002738854235841120321870075261782250357506436825550088826469396508045912258303652912217151127280959435741419961721418428605515096160344688795655562889755165362006775317188009008288782691705879510655892181975003485714604340542378477388225736316682379616676770234557939471098919647053799313777248678455620231721202780830980063824003076308811540534492317719811588898727134190545533822501681653</span><br><span class="hljs-string">c3=113097822337683973761068913398570777162211043704088253732500045618770280334319497174908657828372816818344430304314992760410247741225285170975119344962728883084314382093407445567724674775086423808679124143380073906159023182353116556175251427048715466914368972746661938211846262612414049036821553068430149530397389927209475908905748728402722287875974303298260579839357610962198145974153609818939841880084892796820949226354126424023144300953584658958900737493704530725894948802258740332090822797815745616247879170037794873059391625680745994045522420168248552864215035136318711240256011217929372430302003068882829637056296413462078222453765071094277727760527662423010417144554652783429899139309180017349156600053882338180319473460877576898373222480215735280046214925463242092830060830764299787309912687294672319845054775281463150375545716818434962456139485501224661520991156961587158843064393883274763714930309353593180897123378717852182761518709151878662808890356934477932099818218743384674756674800089177733447066489275506387382342429495897972218764782517198727316942685748481956118012927027254979181519862451112593068440686462293151078537886822555211870303467014484443432209106264020502334805536091587252238173816637270028678636848763</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>è®ºæ–‡é¢˜ï¼š<a href="https://eprint.iacr.org/2015/399.pdf">https://eprint.iacr.org/2015/399.pdf</a></p><p>æ³¨æ„å‚æ•°é€‰å–ï¼Œè¿™é‡Œçš„<code>d1,d2,a,b</code>éƒ½æ˜¯<code>672bits</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> mpz<br><span class="hljs-comment">#gen1</span><br>n11 = <span class="hljs-number">801049932940568005269978912396585741498810389425615966036828877784238116634177290247194019425111606811005728521368879065336038221361037062407029836155148874719789714345603547779284558101833801155509762818376470874215789574939002212274399950433269775325144015468620263028557804618774240232988157961712628677901130814703917513004114547234375629747176834581166306552311075522669403347828095831520693563291249869832390698646691647204371133362254846234990175138047928703289833460734235302093916147489509206061923877623300596194317059884824322527532662470348274079800781120104946546063500763852622187404608639542858285661288293918912184354236687975919510300221932074135531028314170475917110204254042336116619335841213418990605590620842511615815443114612333881430920769002933370887494558640833005339906706603497809846863863967391543647049224309556936909768179259581851520214669904560467640473144481633920438487615788689262961741053146610554997224861331949716721056553499531186695425439163222802917813140266513735841447717418846360096652592844940362932171019143434080184728093326143821165097895058935372215708948088248596585127475770021962501262915274497478428868130455122612016408381607561200802267038869516896665387576895570245272035575637</span><br>n12 = <span class="hljs-number">635401970340205725139325006504978344512744926958688031423448003992072769931808217486709574151492230879374574313457662436423263437792389711379687512056391117410807565492548718691166183372633151644917135272259770997096195518489056319350258673723095417922153182423913759272893696867426193704479752772511081457729513843682588951499551132432923147997238597538055902932123792252593514225328196541483451747314048080824405530742533473914329294346486691684904100406972073037050089861816604505650042953778360621934380815999541183067585498606053857125775979915077329566722531830089714823979965934190338538564188253271016367299890015449611141166780048763403252309160517164569110740561584100839212138661881615351382946813818078899882595313362934594951895560189003438775450675343590147821186953526262224973333962454561275321925151619178204499342339749637758100126893330994252902926509705617882239610380420830791088907378397226817514095468815228186716220057075095711894070032344613244803934541318573847029365563159918970404057137270884587905766828750387753130065274147902379993224780149663600462492281891320702134153853359393588902750423972068679293373333869389393970353760507436913233657422185531482023237384247535554666481760197851108297145147371</span><br>_frac = continued_fraction(n11/n12)<span class="hljs-comment">#è¿åˆ†æ•°å½¢å¼</span><br>_frac = _frac.convergents()<span class="hljs-comment">#æ¸è¿›åˆ†æ•°å½¢å¼</span><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> _frac:<br>    q11 = _.numerator()<span class="hljs-comment">#å–åˆ†å­</span><br>    q12 = _.denominator()<span class="hljs-comment">#å–åˆ†æ¯</span><br>    <span class="hljs-keyword">if</span> q11 == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> q12 == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> n11 % q11 == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> q11 != <span class="hljs-number">1</span>:<span class="hljs-comment">#é˜² 1/2</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;q11 = <span class="hljs-subst">&#123;q11&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;q12 = <span class="hljs-subst">&#123;q12&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">break</span><br><br>e11=<span class="hljs-number">1898839980562048754607069073527844852132536432440793106124181406514770178066775988232362054809850074774981836898118651469424148725970708199461113088705044905633592578936333918328544505910996746428679299419879472444790941363558025887620570856598548320246426354974395765243741646121743413447132297230365355148066914830856904433750379114692122900723772114991199979638987571559860550883470977246459523068862898859694461427148626628283198896659337135438506574799585378178678790308410266713256003479022699264568844505977513537013529212961573269494683740987283682608189406719573301573662696753903050991812884192192569737274321828986847640839813424701894578472933385727757445011291134961124822612239865</span><br>e12=<span class="hljs-number">1262647419018930022617189608995712260095623047273893811529510754596636390255564988827821761126917976430978175522450277907063247981106405519094560616378241247111698915199999363948015703788616554657275147338766805289909261129165025156078136718573006479030827585347458143645738353716189131209398056741864848486818076440355778886993462012533397208330925057305502653219173629466948635110352752162442552541812665607516753186595817376029707777599029040724727499952161261179707271814405907165207904499722122779096230563548011491932378429654764486855147873135769116637484240454596231092684424572258119768093562747249251518965380465994055049411715353547147466711949391814550591591830515262296556050946881</span><br>c11=<span class="hljs-number">18979511327426975645936984732782737165217332092805655747550406443960209507493506811471688957217003792679188427155591583024966608843371190136274378868083075515877811693937328204553788450031542610082653080302874606750443090466407543829279067099563572849101374714795279414177737277837595409805721290786607138569322435729584574023597293220443351227559400618351504654781318871214405850541820427562291662456382362148698864044961814456827646881685994720468255382299912036854657082505810206237294593538092338544641919051145900715456411365065867357857347860000894624247098719102875782712030938806816332901861114078070638796157513248160442185781635520426230183818695937457557248160135402734489627723104008584934936245208116232179751448263136309595931691285743580695792601141363221346329077184688857290503770641398917586422369221744736905117499140140651493031622040723274355292502182795605723573863581253354922291984335841915632076694172921289489383700174864888664946302588049384130628381766560976143458735712162489811693014419190718601945154153130272620025118408017441490090252674737105557818759190934585829634273698371996797545908125156282869589331913665938038870431655063063535672001112420959158339261862052308986374193671007982914711432579</span><br>c12=<span class="hljs-number">336587005671304527566745948355290412636261748969581976214239578621816863343117433524033533838636941679300497270909696775021031004312477997130741361709262822736904340641138652359632950455651920464042448022467664596484055174270895170499076347333381222768518599018520948098943626229061996126260154604038101543546588917619576702866444998578555907070990331574722135141778182631559802154493815687284077524469331290249057291163803290619701104007028836609832847351748020354798788508790258935718399783002069490123663345156902440501507117289747695510266461539019431610123351176227443612317037899257774045751487135646052309277098939919088029284437221840182769808850184827681307611389353392683707516141736067793897378911235819049432542758429901945202632117089595899280390575706266239252841152490534353760118231918190110043319877744119083811214707593122757409240645257409097436061825613686773916466122693168971062418046703969144004779270391320645495586024342668002497155358623795942692477164489475917351003149045087283510728981096449890130735055015075557614253867698702479920619299919816768972581273507837309179450374634916567083251630203067065663910073926990517108921490442919372774170201239734064819301693527366233007925670043499415100789027665</span><br>p11 = gmpy2.iroot(n11//q11,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]<br>p12 = gmpy2.iroot(n12//q12,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]<br><span class="hljs-keyword">assert</span> p11**<span class="hljs-number">2</span>*q11 == n11 <span class="hljs-keyword">and</span> p12**<span class="hljs-number">2</span>*q12 == n12<br>d11 = gmpy2.invert(e11, p11*(p11-<span class="hljs-number">1</span>)*(q11-<span class="hljs-number">1</span>))<br>d12 = gmpy2.invert(e12, p12*(p12-<span class="hljs-number">1</span>)*(q12-<span class="hljs-number">1</span>))<br>m1 = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(c11,d11,n11))<br>m2 = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(c12,d12,n12))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;m1 = <span class="hljs-subst">&#123;m1&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;m2 = <span class="hljs-subst">&#123;m2&#125;</span>&#x27;</span>)<br>        <br><span class="hljs-comment">#gen2</span><br>n2 = <span class="hljs-number">209798341155088334158217087474227805455138848036904381404809759100627849272231840321985747935471287990313456209656625928356468120896887536235496490078123448217785939608443507649096688546074968476040552137270080120417769906047001451239544719039212180059396791491281787790213953488743488306241516010351179070869410418232801398578982244984544906579574766534671056023774009163991804748763929626213884208260660722705479782932001102089367261720194650874553305179520889083170973755913964440175393646890791491057655226024046525748177999422035469428780228224800114202385209306803288475439775037067014297973202621118959024226798935588827359265962780792266516120013602384766460619793738405476219362508944225007365127768741191310079985425349292613888185378948854602285379329682053663283534930182589905986063348509703027498270111412063194971956202729807710253369312175636837558252924035002153389909587349043986253518050303628071319876207392440085675892353421232158925122721273720564784886530611286461575045181073744696415657043278123662980166364494583141297996445429477446442693717498789391918530672770193730629928408766563592081857706608049076318165712479742423149330311238462044666384622153280310696667586565906758451118241914402257039981388209</span><br>c2 = <span class="hljs-number">18352572608055902550350386950073774530453857897248738030380007830701135570310622004368605208336922266513238134127496822199799761713782366178177809597137102612444147565578155260524747439899150012223027218489946124086276814899675563837669559795153349686434242738207425653079514376089070980797596457151965772460109519623572502109592612394316680202287712465721767341302234806130244551387296133051760893033194962691942040228545508895009195291106297581470066545991352668826197346830561010198417527057944507902143965634058848276017283478933675052993657822322866778994956205033704582047618324071045349072526540250707463112668579342537349567247810715604220690215313641329522674080146047291570752430231923566302463491877377617044768978997438596643458475128936850994934029476030136643053997549253792076260765459166618369864942681056864815996253315631930002738854235841120321870075261782250357506436825550088826469396508045912258303652912217151127280959435741419961721418428605515096160344688795655562889755165362006775317188009008288782691705879510655892181975003485714604340542378477388225736316682379616676770234557939471098919647053799313777248678455620231721202780830980063824003076308811540534492317719811588898727134190545533822501681653</span><br>e = <span class="hljs-number">65537</span><br>r = <span class="hljs-number">7</span><br>R.&lt;x&gt; = PolynomialRing(Zmod(n2), implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>f = m1*m2*x -(m2 - m1)<br>f = f.monic()<br>root = f.small_roots(X = <span class="hljs-number">2</span>^<span class="hljs-number">672</span>,beta = <span class="hljs-number">0.4</span>)[<span class="hljs-number">0</span>]<br><span class="hljs-comment">#print(root)</span><br>tmp = mpz(f(root))<br>g = <span class="hljs-built_in">int</span>(gmpy2.gcd(tmp,n2))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;gen2_g = <span class="hljs-subst">&#123;g&#125;</span>&#x27;</span>)<br><span class="hljs-comment">#print(gmpy2.iroot(g,r))#false</span><br><span class="hljs-comment">#print(gmpy2.iroot(g,r-1))#true</span><br>p2 = <span class="hljs-built_in">int</span>(gmpy2.iroot(g,r-<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>])<br>q2 = n2 // g // p2<br>phi2 = p2^<span class="hljs-number">6</span>*(p2-<span class="hljs-number">1</span>)*(q2-<span class="hljs-number">1</span>)<br>d2 = gmpy2.invert(e,phi2)<br>b = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(c2,d2,n2))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;b = <span class="hljs-subst">&#123;b&#125;</span>&#x27;</span>)<br><br><span class="hljs-comment">#gen3</span><br>n3 = <span class="hljs-number">539779851369541956878655738599584730199799866957191805784596190682932284216781781433367450841202917758999300635019369629627621029957135109806205877317954671312041249493462048283611940752235036153024920172209763260723728345918562258401803973624430150143563078517485996070862532682695228590709019451174548520135142052216785774589096706631010293690859363524584240662502290912412366366114571976050857239915691266377257797199583543940504695517331512813468837128344612227973709974625418257243011036826241599265375741977853552204640800449679679351666009764297016524814036295707311913711955324055690490892097177271718850857268982130811714517356073266905474635370690445031512184247179039751734276906533177939993769044135143389748416635981226449566039039202521305851567296884751935162651063209779647359922622084851547605090230221057349511482738300221222563908357379545905837110168948295030747460300104202323692732549831403834387939156877086852393515817984772384147449841124275061609701453997579569931391166586163299940486204581696722731952467570857217406030804590055255431828403195798003509083922294733709507134156466158642941338493323430671502043066148246348074878064089651235355282144209668143249348243220714471988019011613749340243917652821</span><br>c3 = <span class="hljs-number">113097822337683973761068913398570777162211043704088253732500045618770280334319497174908657828372816818344430304314992760410247741225285170975119344962728883084314382093407445567724674775086423808679124143380073906159023182353116556175251427048715466914368972746661938211846262612414049036821553068430149530397389927209475908905748728402722287875974303298260579839357610962198145974153609818939841880084892796820949226354126424023144300953584658958900737493704530725894948802258740332090822797815745616247879170037794873059391625680745994045522420168248552864215035136318711240256011217929372430302003068882829637056296413462078222453765071094277727760527662423010417144554652783429899139309180017349156600053882338180319473460877576898373222480215735280046214925463242092830060830764299787309912687294672319845054775281463150375545716818434962456139485501224661520991156961587158843064393883274763714930309353593180897123378717852182761518709151878662808890356934477932099818218743384674756674800089177733447066489275506387382342429495897972218764782517198727316942685748481956118012927027254979181519862451112593068440686462293151078537886822555211870303467014484443432209106264020502334805536091587252238173816637270028678636848763</span><br>e3 = <span class="hljs-number">8179300978753084587812861894047395225516049110376948812109811319430275614612773726672345893359691900281432484382670047044697374818043512731533402576374645405477207239801498428774783768163880078495448747421425078521981578408638790336528372019271073712013371141939808017049399434858687299480461753638164719404612128939787055797762174745092074547412183349192156638711750872083313795551439465507724807626674514935170104573715458782366469587138508845980490673890245713729782917089910271980557159592807350504157192913530007199510144004848020221181558472160543018733124225266127379373751910439604459368078652499029070936707349862139053913745186413782066470461478961703013591655136140060879250067379283913798867648758171004535775565306842444545755351202796833177560656564652632975685912935281581268141803696686952259539945588609591385807620108279333498170028167338690235117003515264281843953984997958878272347778561933726792473981855755454522886321669676790813189668084373153897754540290867346751033567500922477317530445967753955221454744946208555394588111484610700789566547507402309549957740815535069057837915204852490930168843605732632328017129154852857227895362549146737618906180651623216848500491438142456250653458053922622240299736136335179639180898730269690699965799644757774472147210271111150769048976871249731156387939260749192370361488285775377622944817570292095201906142567403539151179209316853493906909989301225903409448461436855145</span><br>r = <span class="hljs-number">7</span><br>R.&lt;x&gt; = PolynomialRing(Zmod(n3), implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>f = e3*x - b<br>f = f.monic()<br>root = f.small_roots(X = <span class="hljs-number">2</span>^<span class="hljs-number">672</span>,beta = <span class="hljs-number">0.4</span>)[<span class="hljs-number">0</span>]<br>tmp = <span class="hljs-built_in">int</span>(f(root))<br>g = gmpy2.gcd(tmp,n3)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;gen3_g = <span class="hljs-subst">&#123;g&#125;</span>&#x27;</span>)<br><span class="hljs-comment">#print(gmpy2.iroot(g,r))#false</span><br><span class="hljs-comment">#print(gmpy2.iroot(g,r-1))#true</span><br>p3 = <span class="hljs-built_in">int</span>(gmpy2.iroot(g,r-<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>])<br>q3 = n3 // g // p3<br>phi3 = p3^<span class="hljs-number">6</span>*(p3-<span class="hljs-number">1</span>)*(q3-<span class="hljs-number">1</span>)<br>d3 = gmpy2.invert(e3,phi3)<br>m = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">pow</span>(c3,d3,n3))<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF2022.07èµ‹èƒ½èµ›</title>
    <link href="/2022/07/24/DASCTF2022.07%E8%B5%8B%E8%83%BD%E8%B5%9B/"/>
    <url>/2022/07/24/DASCTF2022.07%E8%B5%8B%E8%83%BD%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="babysign"><a href="#babysign" class="headerlink" title="babysign"></a>babysign</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> ecdsa<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> os<br><br>flag = <span class="hljs-string">b&quot;xxx&quot;</span><br><br><span class="hljs-keyword">assert</span> flag.startswith(<span class="hljs-string">b&#x27;DASCTF&#123;&#x27;</span>) <span class="hljs-keyword">and</span> flag.endswith(<span class="hljs-string">b&#x27;&#125;&#x27;</span>)<br><span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(flag) == <span class="hljs-number">40</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    initiation</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">global</span> pub_key, priv_key, order, base,secret<br>    gen = ecdsa.NIST256p.generator<br>    order = gen.order()<br>    secret = bytes_to_long(flag[<span class="hljs-number">7</span>:-<span class="hljs-number">1</span>])<br>    <br>    pub_key = ecdsa.ecdsa.Public_key(gen, gen * secret)<br>    priv_key = ecdsa.ecdsa.Private_key(pub_key, secret)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sign</span>(<span class="hljs-params">msg, nonce</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    sign msg</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    msg = <span class="hljs-built_in">int</span>(hashlib.sha256(msg).hexdigest(), <span class="hljs-number">16</span>)<br>    <br>    sign = priv_key.sign(msg, nonce)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;R:&quot;</span>, <span class="hljs-built_in">hex</span>(sign.r)[<span class="hljs-number">2</span>:])<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;S:&quot;</span>, <span class="hljs-built_in">hex</span>(sign.s)[<span class="hljs-number">2</span>:])<br><br>init()<br>nonce = random.getrandbits(order.bit_length())<br>sign(<span class="hljs-string">b&#x27;welcome to ecdsa&#x27;</span>, nonce)<br><span class="hljs-built_in">print</span>(nonce)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">R: 7b35712a50d463ac5acf7af1675b4b63ba0da23b6452023afddd58d4891ef6e5</span><br><span class="hljs-string">S: a452fc44cc36fa6964d1b4f47392ff0a91350cfd58f11a4645c084d56e387e5c</span><br><span class="hljs-string">57872441580840888721108499129165088876046881204464784483281653404168342111855</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><p><a href="https://lazzzaro.github.io/2020/11/07/crypto-ECC/">ECC | Lazzaro (lazzzaro.github.io)</a></p><p><a href="https://blog.csdn.net/qq_51999772/article/details/122626382">ECDSAç®—æ³•_M3ng@Lçš„åšå®¢-CSDNåšå®¢_ecdsa</a></p><p>ç»™å®šäº†æ›²çº¿ï¼Œå¯ä»¥ç›´æ¥çŸ¥é“å®ƒçš„é˜¶(orderæˆ–n)ã€‚ç»™å‡ºäº†ç­¾å (R,S)å’Œmsgï¼Œæˆ‘ä»¬è¦æ±‚è§£çš„mæ˜¯$d_A$ã€‚</p><p>æ ¹æ®æ•°å­—ç­¾åå…¬å¼<br>$$<br>S â‰¡ K^{-1}*(H(m)+d_A*R)\quad (mod\ n)<br>$$<br>æ¨å‡º<br>$$<br>d_A â‰¡ R^{ -1 }*( S*K - H( m ) )\quad ( mod\ n )<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> invert<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>order = <span class="hljs-number">115792089210356248762697446949407573529996955224135760342422259061068512044369</span><br>R = <span class="hljs-number">0x7b35712a50d463ac5acf7af1675b4b63ba0da23b6452023afddd58d4891ef6e5</span><br>S = <span class="hljs-number">0xa452fc44cc36fa6964d1b4f47392ff0a91350cfd58f11a4645c084d56e387e5c</span><br>k = <span class="hljs-number">57872441580840888721108499129165088876046881204464784483281653404168342111855</span><br>msg = <span class="hljs-string">b&#x27;welcome to ecdsa&#x27;</span><br>msg = <span class="hljs-built_in">int</span>(hashlib.sha256(msg).hexdigest(), <span class="hljs-number">16</span>)<br>da = (S*k-msg)*invert(R,order)%order<br><span class="hljs-built_in">print</span>(da)<br><span class="hljs-built_in">print</span>(long_to_bytes(da))<br></code></pre></td></tr></table></figure><h1 id="easyNTRU"><a href="#easyNTRU" class="headerlink" title="easyNTRU"></a>easyNTRU</h1><p>éé¢„æœŸï¼Œå¯¹mè¿›è¡Œçˆ†ç ´ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">from</span> Crypto.Hash <span class="hljs-keyword">import</span> SHA3_256<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> pad<br><br>N = <span class="hljs-number">10</span><br>p = <span class="hljs-number">3</span><br>q = <span class="hljs-number">512</span><br>d = <span class="hljs-number">3</span><br>     <br>R.&lt;x&gt; = ZZ[]<br>may = [-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>]<br>maykey = []<br><span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> may:<br>    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> may:<br>        <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> may:<br>            <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> may:<br>                <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> may:<br>                    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> may:<br>                        <span class="hljs-keyword">for</span> g <span class="hljs-keyword">in</span> may:<br>                            <span class="hljs-keyword">for</span> h <span class="hljs-keyword">in</span> may:<br>                                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> may:<br>                                    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> may:<br>                                        result = [a,b,c,d,e,f,g,h,i,j]<br>                                        maykey.append(R(result))<br><br>c = <span class="hljs-string">b&#x27;\xb9W\x8c\x8b\x0cG\xde\x7fl\xf7\x03\xbb9m\x0c\xc4L\xfe\xe9Q\xad\xfd\xda!\x1a\xea@&#125;U\x9ay4\x8a\xe3y\xdf\xd5BV\xa7\x06\xf9\x08\x96=&quot;f\xc1\x1b\xd7\xdb\xc1j\x82F\x0b\x16\x06\xbcJMB\xc8\x80&#x27;</span><br><span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> maykey:<br>    sha3 = SHA3_256.new()<br>    sha3.update(<span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(m).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)))<br>    key = sha3.digest()<br><br>    cypher = AES.new(key, AES.MODE_ECB)<br>    flag = cypher.decrypt(pad(c, <span class="hljs-number">32</span>))<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;DASCTF&#x27;</span> <span class="hljs-keyword">in</span> flag:<br>        <span class="hljs-built_in">print</span>(key)<br>        <span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><h1 id="NTRURSA"><a href="#NTRURSA" class="headerlink" title="NTRURSA"></a>NTRURSA</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen</span>():<br>    p1 = getPrime(<span class="hljs-number">256</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        f = getRandomRange(<span class="hljs-number">1</span>, iroot(p1 // <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])<br>        g = getRandomRange(iroot(p1 // <span class="hljs-number">4</span>, <span class="hljs-number">2</span>)[<span class="hljs-number">0</span>], iroot(p1 // <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">if</span> gcd(f, p1) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> gcd(f, g) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> isPrime(g) == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">break</span><br>    rand = getRandomRange(<span class="hljs-number">0</span>, <span class="hljs-number">2</span> ^ <span class="hljs-number">20</span>)<br>    g1 = g ^^ rand<br>    h = (inverse(f, p1) * g1) % p1<br>    <span class="hljs-keyword">return</span> h, p1, g, f, g1<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_irreducable_poly</span>(<span class="hljs-params">deg</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        out = R.random_element(degree=deg)<br>        <span class="hljs-keyword">if</span> out.is_irreducible():<br>            <span class="hljs-keyword">return</span> out<br><br><br>h, p1, g, f, g1 = gen()<br>q = getPrime(<span class="hljs-number">1024</span>)<br>n = g * q <br>e = <span class="hljs-number">0x10001</span><br>c1 = <span class="hljs-built_in">pow</span>(bytes_to_long(flag), e, n)<br><br>hint = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">str</span>(h))<br>length = <span class="hljs-built_in">len</span>(hint)<span class="hljs-comment">#len(h)</span><br>bits = <span class="hljs-number">16</span><br>p2 = random_prime(<span class="hljs-number">2</span> ^ bits - <span class="hljs-number">1</span>, <span class="hljs-literal">False</span>, <span class="hljs-number">2</span> ^ (bits - <span class="hljs-number">1</span>))<br>R.&lt;x&gt; = PolynomialRing(GF(p2))<br>P = gen_irreducable_poly(ZZ.random_element(length, <span class="hljs-number">2</span> * length))<br>Q = gen_irreducable_poly(ZZ.random_element(length, <span class="hljs-number">2</span> * length))<br>N = P * Q<br>S.&lt;x&gt; = R.quotient(N)<span class="hljs-comment">#ä»¥Nä¸ºæ¨¡çš„å•†ç¯</span><br>m = S(hint)<span class="hljs-comment">#ä»¥hintä¸ºç³»æ•°çš„å¤šé¡¹å¼</span><br>c2 = m ^ e<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;p1 =&quot;</span>, p1)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;c1 =&quot;</span>, c1)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;p2 =&quot;</span>, p2)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;c2 =&quot;</span>, c2)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;n =&quot;</span>, n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;N =&quot;</span>, N)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">p1 = 106472061241112922861460644342336453303928202010237284715354717630502168520267</span><br><span class="hljs-string">c1 = 20920247107738496784071050239422540936224577122721266141057957551603705972966457203177812404896852110975768315464852962210648535130235298413611598658659777108920014929632531307409885868941842921815735008981335582297975794108016151210394446009890312043259167806981442425505200141283138318269058818777636637375101005540308736021976559495266332357714</span><br><span class="hljs-string">p2 = 64621</span><br><span class="hljs-string">c2 = 19921*x^174 + 49192*x^173 + 18894*x^172 + 61121*x^171 + 50271*x^170 + 11860*x^169 + 53128*x^168 + 38658*x^167 + 14191*x^166 + 9671*x^165 + 40879*x^164 + 15187*x^163 + 33523*x^162 + 62270*x^161 + 64211*x^160 + 54518*x^159 + 50446*x^158 + 2597*x^157 + 32216*x^156 + 10500*x^155 + 63276*x^154 + 27916*x^153 + 55316*x^152 + 30898*x^151 + 43706*x^150 + 5734*x^149 + 35616*x^148 + 14288*x^147 + 18282*x^146 + 22788*x^145 + 48188*x^144 + 34176*x^143 + 55952*x^142 + 9578*x^141 + 9177*x^140 + 22083*x^139 + 14586*x^138 + 9748*x^137 + 21118*x^136 + 155*x^135 + 64224*x^134 + 18193*x^133 + 33732*x^132 + 38135*x^131 + 51992*x^130 + 8203*x^129 + 8538*x^128 + 55203*x^127 + 5003*x^126 + 2009*x^125 + 45023*x^124 + 12311*x^123 + 21428*x^122 + 24110*x^121 + 43537*x^120 + 21885*x^119 + 50212*x^118 + 40445*x^117 + 17768*x^116 + 46616*x^115 + 4771*x^114 + 20903*x^113 + 47764*x^112 + 13056*x^111 + 50837*x^110 + 22313*x^109 + 39698*x^108 + 60377*x^107 + 59357*x^106 + 24051*x^105 + 5888*x^104 + 29414*x^103 + 31726*x^102 + 4906*x^101 + 23968*x^100 + 52360*x^99 + 58063*x^98 + 706*x^97 + 31420*x^96 + 62468*x^95 + 18557*x^94 + 1498*x^93 + 17590*x^92 + 62990*x^91 + 27200*x^90 + 7052*x^89 + 39117*x^88 + 46944*x^87 + 45535*x^86 + 28092*x^85 + 1981*x^84 + 4377*x^83 + 34419*x^82 + 33754*x^81 + 2640*x^80 + 44427*x^79 + 32179*x^78 + 57721*x^77 + 9444*x^76 + 49374*x^75 + 21288*x^74 + 44098*x^73 + 57744*x^72 + 63457*x^71 + 43300*x^70 + 1508*x^69 + 13775*x^68 + 23197*x^67 + 43070*x^66 + 20751*x^65 + 47479*x^64 + 18496*x^63 + 53392*x^62 + 10387*x^61 + 2317*x^60 + 57492*x^59 + 25441*x^58 + 52532*x^57 + 27150*x^56 + 33788*x^55 + 43371*x^54 + 30972*x^53 + 39583*x^52 + 36407*x^51 + 35564*x^50 + 44564*x^49 + 1505*x^48 + 47519*x^47 + 38695*x^46 + 43107*x^45 + 1676*x^44 + 42057*x^43 + 49879*x^42 + 29083*x^41 + 42241*x^40 + 8853*x^39 + 33546*x^38 + 48954*x^37 + 30352*x^36 + 62020*x^35 + 39864*x^34 + 9519*x^33 + 24828*x^32 + 34696*x^31 + 2387*x^30 + 27413*x^29 + 55829*x^28 + 40217*x^27 + 30205*x^26 + 42328*x^25 + 6210*x^24 + 52442*x^23 + 58495*x^22 + 2014*x^21 + 26452*x^20 + 33547*x^19 + 19840*x^18 + 5995*x^17 + 16850*x^16 + 37855*x^15 + 7221*x^14 + 32200*x^13 + 8121*x^12 + 23767*x^11 + 46563*x^10 + 51673*x^9 + 19372*x^8 + 4157*x^7 + 48421*x^6 + 41096*x^5 + 45735*x^4 + 53022*x^3 + 35475*x^2 + 47521*x + 27544</span><br><span class="hljs-string">n = 31398174203566229210665534094126601315683074641013205440476552584312112883638278390105806127975406224783128340041129316782549009811196493319665336016690985557862367551545487842904828051293613836275987595871004601968935866634955528775536847402581734910742403788941725304146192149165731194199024154454952157531068881114411265538547462017207361362857</span><br><span class="hljs-string">N = 25081*x^175 + 8744*x^174 + 9823*x^173 + 9037*x^172 + 6343*x^171 + 42205*x^170 + 28573*x^169 + 55714*x^168 + 17287*x^167 + 11229*x^166 + 42630*x^165 + 64363*x^164 + 50759*x^163 + 3368*x^162 + 20900*x^161 + 55947*x^160 + 7082*x^159 + 23171*x^158 + 48510*x^157 + 20013*x^156 + 16798*x^155 + 60438*x^154 + 58779*x^153 + 9289*x^152 + 10623*x^151 + 1085*x^150 + 23473*x^149 + 13795*x^148 + 2071*x^147 + 31515*x^146 + 42832*x^145 + 38152*x^144 + 37559*x^143 + 47653*x^142 + 37371*x^141 + 39128*x^140 + 48750*x^139 + 16638*x^138 + 60320*x^137 + 56224*x^136 + 41870*x^135 + 63961*x^134 + 47574*x^133 + 63954*x^132 + 9668*x^131 + 62360*x^130 + 15244*x^129 + 20599*x^128 + 28704*x^127 + 26857*x^126 + 34885*x^125 + 33107*x^124 + 17693*x^123 + 52753*x^122 + 60744*x^121 + 21305*x^120 + 63785*x^119 + 54400*x^118 + 17812*x^117 + 64549*x^116 + 20035*x^115 + 37567*x^114 + 38607*x^113 + 32783*x^112 + 24385*x^111 + 5387*x^110 + 5134*x^109 + 45893*x^108 + 58307*x^107 + 33821*x^106 + 54902*x^105 + 14236*x^104 + 58044*x^103 + 41257*x^102 + 46881*x^101 + 42834*x^100 + 1693*x^99 + 46058*x^98 + 15636*x^97 + 27111*x^96 + 3158*x^95 + 41012*x^94 + 26028*x^93 + 3576*x^92 + 37958*x^91 + 33273*x^90 + 60228*x^89 + 41229*x^88 + 11232*x^87 + 12635*x^86 + 17942*x^85 + 4*x^84 + 25397*x^83 + 63526*x^82 + 54872*x^81 + 40318*x^80 + 37498*x^79 + 52182*x^78 + 48817*x^77 + 10763*x^76 + 46542*x^75 + 36060*x^74 + 49972*x^73 + 63603*x^72 + 46506*x^71 + 44788*x^70 + 44905*x^69 + 46112*x^68 + 5297*x^67 + 26440*x^66 + 28470*x^65 + 15525*x^64 + 11566*x^63 + 15781*x^62 + 36098*x^61 + 44402*x^60 + 55331*x^59 + 61583*x^58 + 16406*x^57 + 59089*x^56 + 53161*x^55 + 43695*x^54 + 49580*x^53 + 62685*x^52 + 31447*x^51 + 26755*x^50 + 14810*x^49 + 3281*x^48 + 27371*x^47 + 53392*x^46 + 2648*x^45 + 10095*x^44 + 25977*x^43 + 22912*x^42 + 41278*x^41 + 33236*x^40 + 57792*x^39 + 7169*x^38 + 29250*x^37 + 16906*x^36 + 4436*x^35 + 2729*x^34 + 29736*x^33 + 19383*x^32 + 11921*x^31 + 26075*x^30 + 54616*x^29 + 739*x^28 + 38509*x^27 + 19118*x^26 + 20062*x^25 + 21280*x^24 + 12594*x^23 + 14974*x^22 + 27795*x^21 + 54107*x^20 + 1890*x^19 + 13410*x^18 + 5381*x^17 + 19500*x^16 + 47481*x^15 + 58488*x^14 + 26433*x^13 + 37803*x^12 + 60232*x^11 + 34772*x^10 + 1505*x^9 + 63760*x^8 + 20890*x^7 + 41533*x^6 + 16130*x^5 + 29769*x^4 + 49142*x^3 + 64184*x^2 + 55443*x + 45925</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>NTRU + å¤šé¡¹å¼RSA</p><h2 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h2><p>æ±‚è§£hã€‚å‚è€ƒ<a href="https://4xwi11.github.io/posts/a0a0f5aa/">å¤šé¡¹å¼RSA | 4XWi11çš„åšå®¢</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">p2 = <span class="hljs-number">64621</span><br>e = <span class="hljs-number">0x10001</span><br>R.&lt;x&gt; = PolynomialRing(GF(p2))<br>N = <span class="hljs-number">25081</span>*x^<span class="hljs-number">175</span> + <span class="hljs-number">8744</span>*x^<span class="hljs-number">174</span> + <span class="hljs-number">9823</span>*x^<span class="hljs-number">173</span> + <span class="hljs-number">9037</span>*x^<span class="hljs-number">172</span> + <span class="hljs-number">6343</span>*x^<span class="hljs-number">171</span> + <span class="hljs-number">42205</span>*x^<span class="hljs-number">170</span> + <span class="hljs-number">28573</span>*x^<span class="hljs-number">169</span> + <span class="hljs-number">55714</span>*x^<span class="hljs-number">168</span> + <span class="hljs-number">17287</span>*x^<span class="hljs-number">167</span> + <span class="hljs-number">11229</span>*x^<span class="hljs-number">166</span> + <span class="hljs-number">42630</span>*x^<span class="hljs-number">165</span> + <span class="hljs-number">64363</span>*x^<span class="hljs-number">164</span> + <span class="hljs-number">50759</span>*x^<span class="hljs-number">163</span> + <span class="hljs-number">3368</span>*x^<span class="hljs-number">162</span> + <span class="hljs-number">20900</span>*x^<span class="hljs-number">161</span> + <span class="hljs-number">55947</span>*x^<span class="hljs-number">160</span> + <span class="hljs-number">7082</span>*x^<span class="hljs-number">159</span> + <span class="hljs-number">23171</span>*x^<span class="hljs-number">158</span> + <span class="hljs-number">48510</span>*x^<span class="hljs-number">157</span> + <span class="hljs-number">20013</span>*x^<span class="hljs-number">156</span> + <span class="hljs-number">16798</span>*x^<span class="hljs-number">155</span> + <span class="hljs-number">60438</span>*x^<span class="hljs-number">154</span> + <span class="hljs-number">58779</span>*x^<span class="hljs-number">153</span> + <span class="hljs-number">9289</span>*x^<span class="hljs-number">152</span> + <span class="hljs-number">10623</span>*x^<span class="hljs-number">151</span> + <span class="hljs-number">1085</span>*x^<span class="hljs-number">150</span> + <span class="hljs-number">23473</span>*x^<span class="hljs-number">149</span> + <span class="hljs-number">13795</span>*x^<span class="hljs-number">148</span> + <span class="hljs-number">2071</span>*x^<span class="hljs-number">147</span> + <span class="hljs-number">31515</span>*x^<span class="hljs-number">146</span> + <span class="hljs-number">42832</span>*x^<span class="hljs-number">145</span> + <span class="hljs-number">38152</span>*x^<span class="hljs-number">144</span> + <span class="hljs-number">37559</span>*x^<span class="hljs-number">143</span> + <span class="hljs-number">47653</span>*x^<span class="hljs-number">142</span> + <span class="hljs-number">37371</span>*x^<span class="hljs-number">141</span> + <span class="hljs-number">39128</span>*x^<span class="hljs-number">140</span> + <span class="hljs-number">48750</span>*x^<span class="hljs-number">139</span> + <span class="hljs-number">16638</span>*x^<span class="hljs-number">138</span> + <span class="hljs-number">60320</span>*x^<span class="hljs-number">137</span> + <span class="hljs-number">56224</span>*x^<span class="hljs-number">136</span> + <span class="hljs-number">41870</span>*x^<span class="hljs-number">135</span> + <span class="hljs-number">63961</span>*x^<span class="hljs-number">134</span> + <span class="hljs-number">47574</span>*x^<span class="hljs-number">133</span> + <span class="hljs-number">63954</span>*x^<span class="hljs-number">132</span> + <span class="hljs-number">9668</span>*x^<span class="hljs-number">131</span> + <span class="hljs-number">62360</span>*x^<span class="hljs-number">130</span> + <span class="hljs-number">15244</span>*x^<span class="hljs-number">129</span> + <span class="hljs-number">20599</span>*x^<span class="hljs-number">128</span> + <span class="hljs-number">28704</span>*x^<span class="hljs-number">127</span> + <span class="hljs-number">26857</span>*x^<span class="hljs-number">126</span> + <span class="hljs-number">34885</span>*x^<span class="hljs-number">125</span> + <span class="hljs-number">33107</span>*x^<span class="hljs-number">124</span> + <span class="hljs-number">17693</span>*x^<span class="hljs-number">123</span> + <span class="hljs-number">52753</span>*x^<span class="hljs-number">122</span> + <span class="hljs-number">60744</span>*x^<span class="hljs-number">121</span> + <span class="hljs-number">21305</span>*x^<span class="hljs-number">120</span> + <span class="hljs-number">63785</span>*x^<span class="hljs-number">119</span> + <span class="hljs-number">54400</span>*x^<span class="hljs-number">118</span> + <span class="hljs-number">17812</span>*x^<span class="hljs-number">117</span> + <span class="hljs-number">64549</span>*x^<span class="hljs-number">116</span> + <span class="hljs-number">20035</span>*x^<span class="hljs-number">115</span> + <span class="hljs-number">37567</span>*x^<span class="hljs-number">114</span> + <span class="hljs-number">38607</span>*x^<span class="hljs-number">113</span> + <span class="hljs-number">32783</span>*x^<span class="hljs-number">112</span> + <span class="hljs-number">24385</span>*x^<span class="hljs-number">111</span> + <span class="hljs-number">5387</span>*x^<span class="hljs-number">110</span> + <span class="hljs-number">5134</span>*x^<span class="hljs-number">109</span> + <span class="hljs-number">45893</span>*x^<span class="hljs-number">108</span> + <span class="hljs-number">58307</span>*x^<span class="hljs-number">107</span> + <span class="hljs-number">33821</span>*x^<span class="hljs-number">106</span> + <span class="hljs-number">54902</span>*x^<span class="hljs-number">105</span> + <span class="hljs-number">14236</span>*x^<span class="hljs-number">104</span> + <span class="hljs-number">58044</span>*x^<span class="hljs-number">103</span> + <span class="hljs-number">41257</span>*x^<span class="hljs-number">102</span> + <span class="hljs-number">46881</span>*x^<span class="hljs-number">101</span> + <span class="hljs-number">42834</span>*x^<span class="hljs-number">100</span> + <span class="hljs-number">1693</span>*x^<span class="hljs-number">99</span> + <span class="hljs-number">46058</span>*x^<span class="hljs-number">98</span> + <span class="hljs-number">15636</span>*x^<span class="hljs-number">97</span> + <span class="hljs-number">27111</span>*x^<span class="hljs-number">96</span> + <span class="hljs-number">3158</span>*x^<span class="hljs-number">95</span> + <span class="hljs-number">41012</span>*x^<span class="hljs-number">94</span> + <span class="hljs-number">26028</span>*x^<span class="hljs-number">93</span> + <span class="hljs-number">3576</span>*x^<span class="hljs-number">92</span> + <span class="hljs-number">37958</span>*x^<span class="hljs-number">91</span> + <span class="hljs-number">33273</span>*x^<span class="hljs-number">90</span> + <span class="hljs-number">60228</span>*x^<span class="hljs-number">89</span> + <span class="hljs-number">41229</span>*x^<span class="hljs-number">88</span> + <span class="hljs-number">11232</span>*x^<span class="hljs-number">87</span> + <span class="hljs-number">12635</span>*x^<span class="hljs-number">86</span> + <span class="hljs-number">17942</span>*x^<span class="hljs-number">85</span> + <span class="hljs-number">4</span>*x^<span class="hljs-number">84</span> + <span class="hljs-number">25397</span>*x^<span class="hljs-number">83</span> + <span class="hljs-number">63526</span>*x^<span class="hljs-number">82</span> + <span class="hljs-number">54872</span>*x^<span class="hljs-number">81</span> + <span class="hljs-number">40318</span>*x^<span class="hljs-number">80</span> + <span class="hljs-number">37498</span>*x^<span class="hljs-number">79</span> + <span class="hljs-number">52182</span>*x^<span class="hljs-number">78</span> + <span class="hljs-number">48817</span>*x^<span class="hljs-number">77</span> + <span class="hljs-number">10763</span>*x^<span class="hljs-number">76</span> + <span class="hljs-number">46542</span>*x^<span class="hljs-number">75</span> + <span class="hljs-number">36060</span>*x^<span class="hljs-number">74</span> + <span class="hljs-number">49972</span>*x^<span class="hljs-number">73</span> + <span class="hljs-number">63603</span>*x^<span class="hljs-number">72</span> + <span class="hljs-number">46506</span>*x^<span class="hljs-number">71</span> + <span class="hljs-number">44788</span>*x^<span class="hljs-number">70</span> + <span class="hljs-number">44905</span>*x^<span class="hljs-number">69</span> + <span class="hljs-number">46112</span>*x^<span class="hljs-number">68</span> + <span class="hljs-number">5297</span>*x^<span class="hljs-number">67</span> + <span class="hljs-number">26440</span>*x^<span class="hljs-number">66</span> + <span class="hljs-number">28470</span>*x^<span class="hljs-number">65</span> + <span class="hljs-number">15525</span>*x^<span class="hljs-number">64</span> + <span class="hljs-number">11566</span>*x^<span class="hljs-number">63</span> + <span class="hljs-number">15781</span>*x^<span class="hljs-number">62</span> + <span class="hljs-number">36098</span>*x^<span class="hljs-number">61</span> + <span class="hljs-number">44402</span>*x^<span class="hljs-number">60</span> + <span class="hljs-number">55331</span>*x^<span class="hljs-number">59</span> + <span class="hljs-number">61583</span>*x^<span class="hljs-number">58</span> + <span class="hljs-number">16406</span>*x^<span class="hljs-number">57</span> + <span class="hljs-number">59089</span>*x^<span class="hljs-number">56</span> + <span class="hljs-number">53161</span>*x^<span class="hljs-number">55</span> + <span class="hljs-number">43695</span>*x^<span class="hljs-number">54</span> + <span class="hljs-number">49580</span>*x^<span class="hljs-number">53</span> + <span class="hljs-number">62685</span>*x^<span class="hljs-number">52</span> + <span class="hljs-number">31447</span>*x^<span class="hljs-number">51</span> + <span class="hljs-number">26755</span>*x^<span class="hljs-number">50</span> + <span class="hljs-number">14810</span>*x^<span class="hljs-number">49</span> + <span class="hljs-number">3281</span>*x^<span class="hljs-number">48</span> + <span class="hljs-number">27371</span>*x^<span class="hljs-number">47</span> + <span class="hljs-number">53392</span>*x^<span class="hljs-number">46</span> + <span class="hljs-number">2648</span>*x^<span class="hljs-number">45</span> + <span class="hljs-number">10095</span>*x^<span class="hljs-number">44</span> + <span class="hljs-number">25977</span>*x^<span class="hljs-number">43</span> + <span class="hljs-number">22912</span>*x^<span class="hljs-number">42</span> + <span class="hljs-number">41278</span>*x^<span class="hljs-number">41</span> + <span class="hljs-number">33236</span>*x^<span class="hljs-number">40</span> + <span class="hljs-number">57792</span>*x^<span class="hljs-number">39</span> + <span class="hljs-number">7169</span>*x^<span class="hljs-number">38</span> + <span class="hljs-number">29250</span>*x^<span class="hljs-number">37</span> + <span class="hljs-number">16906</span>*x^<span class="hljs-number">36</span> + <span class="hljs-number">4436</span>*x^<span class="hljs-number">35</span> + <span class="hljs-number">2729</span>*x^<span class="hljs-number">34</span> + <span class="hljs-number">29736</span>*x^<span class="hljs-number">33</span> + <span class="hljs-number">19383</span>*x^<span class="hljs-number">32</span> + <span class="hljs-number">11921</span>*x^<span class="hljs-number">31</span> + <span class="hljs-number">26075</span>*x^<span class="hljs-number">30</span> + <span class="hljs-number">54616</span>*x^<span class="hljs-number">29</span> + <span class="hljs-number">739</span>*x^<span class="hljs-number">28</span> + <span class="hljs-number">38509</span>*x^<span class="hljs-number">27</span> + <span class="hljs-number">19118</span>*x^<span class="hljs-number">26</span> + <span class="hljs-number">20062</span>*x^<span class="hljs-number">25</span> + <span class="hljs-number">21280</span>*x^<span class="hljs-number">24</span> + <span class="hljs-number">12594</span>*x^<span class="hljs-number">23</span> + <span class="hljs-number">14974</span>*x^<span class="hljs-number">22</span> + <span class="hljs-number">27795</span>*x^<span class="hljs-number">21</span> + <span class="hljs-number">54107</span>*x^<span class="hljs-number">20</span> + <span class="hljs-number">1890</span>*x^<span class="hljs-number">19</span> + <span class="hljs-number">13410</span>*x^<span class="hljs-number">18</span> + <span class="hljs-number">5381</span>*x^<span class="hljs-number">17</span> + <span class="hljs-number">19500</span>*x^<span class="hljs-number">16</span> + <span class="hljs-number">47481</span>*x^<span class="hljs-number">15</span> + <span class="hljs-number">58488</span>*x^<span class="hljs-number">14</span> + <span class="hljs-number">26433</span>*x^<span class="hljs-number">13</span> + <span class="hljs-number">37803</span>*x^<span class="hljs-number">12</span> + <span class="hljs-number">60232</span>*x^<span class="hljs-number">11</span> + <span class="hljs-number">34772</span>*x^<span class="hljs-number">10</span> + <span class="hljs-number">1505</span>*x^<span class="hljs-number">9</span> + <span class="hljs-number">63760</span>*x^<span class="hljs-number">8</span> + <span class="hljs-number">20890</span>*x^<span class="hljs-number">7</span> + <span class="hljs-number">41533</span>*x^<span class="hljs-number">6</span> + <span class="hljs-number">16130</span>*x^<span class="hljs-number">5</span> + <span class="hljs-number">29769</span>*x^<span class="hljs-number">4</span> + <span class="hljs-number">49142</span>*x^<span class="hljs-number">3</span> + <span class="hljs-number">64184</span>*x^<span class="hljs-number">2</span> + <span class="hljs-number">55443</span>*x + <span class="hljs-number">45925</span><br>c2 = <span class="hljs-number">19921</span>*x^<span class="hljs-number">174</span> + <span class="hljs-number">49192</span>*x^<span class="hljs-number">173</span> + <span class="hljs-number">18894</span>*x^<span class="hljs-number">172</span> + <span class="hljs-number">61121</span>*x^<span class="hljs-number">171</span> + <span class="hljs-number">50271</span>*x^<span class="hljs-number">170</span> + <span class="hljs-number">11860</span>*x^<span class="hljs-number">169</span> + <span class="hljs-number">53128</span>*x^<span class="hljs-number">168</span> + <span class="hljs-number">38658</span>*x^<span class="hljs-number">167</span> + <span class="hljs-number">14191</span>*x^<span class="hljs-number">166</span> + <span class="hljs-number">9671</span>*x^<span class="hljs-number">165</span> + <span class="hljs-number">40879</span>*x^<span class="hljs-number">164</span> + <span class="hljs-number">15187</span>*x^<span class="hljs-number">163</span> + <span class="hljs-number">33523</span>*x^<span class="hljs-number">162</span> + <span class="hljs-number">62270</span>*x^<span class="hljs-number">161</span> + <span class="hljs-number">64211</span>*x^<span class="hljs-number">160</span> + <span class="hljs-number">54518</span>*x^<span class="hljs-number">159</span> + <span class="hljs-number">50446</span>*x^<span class="hljs-number">158</span> + <span class="hljs-number">2597</span>*x^<span class="hljs-number">157</span> + <span class="hljs-number">32216</span>*x^<span class="hljs-number">156</span> + <span class="hljs-number">10500</span>*x^<span class="hljs-number">155</span> + <span class="hljs-number">63276</span>*x^<span class="hljs-number">154</span> + <span class="hljs-number">27916</span>*x^<span class="hljs-number">153</span> + <span class="hljs-number">55316</span>*x^<span class="hljs-number">152</span> + <span class="hljs-number">30898</span>*x^<span class="hljs-number">151</span> + <span class="hljs-number">43706</span>*x^<span class="hljs-number">150</span> + <span class="hljs-number">5734</span>*x^<span class="hljs-number">149</span> + <span class="hljs-number">35616</span>*x^<span class="hljs-number">148</span> + <span class="hljs-number">14288</span>*x^<span class="hljs-number">147</span> + <span class="hljs-number">18282</span>*x^<span class="hljs-number">146</span> + <span class="hljs-number">22788</span>*x^<span class="hljs-number">145</span> + <span class="hljs-number">48188</span>*x^<span class="hljs-number">144</span> + <span class="hljs-number">34176</span>*x^<span class="hljs-number">143</span> + <span class="hljs-number">55952</span>*x^<span class="hljs-number">142</span> + <span class="hljs-number">9578</span>*x^<span class="hljs-number">141</span> + <span class="hljs-number">9177</span>*x^<span class="hljs-number">140</span> + <span class="hljs-number">22083</span>*x^<span class="hljs-number">139</span> + <span class="hljs-number">14586</span>*x^<span class="hljs-number">138</span> + <span class="hljs-number">9748</span>*x^<span class="hljs-number">137</span> + <span class="hljs-number">21118</span>*x^<span class="hljs-number">136</span> + <span class="hljs-number">155</span>*x^<span class="hljs-number">135</span> + <span class="hljs-number">64224</span>*x^<span class="hljs-number">134</span> + <span class="hljs-number">18193</span>*x^<span class="hljs-number">133</span> + <span class="hljs-number">33732</span>*x^<span class="hljs-number">132</span> + <span class="hljs-number">38135</span>*x^<span class="hljs-number">131</span> + <span class="hljs-number">51992</span>*x^<span class="hljs-number">130</span> + <span class="hljs-number">8203</span>*x^<span class="hljs-number">129</span> + <span class="hljs-number">8538</span>*x^<span class="hljs-number">128</span> + <span class="hljs-number">55203</span>*x^<span class="hljs-number">127</span> + <span class="hljs-number">5003</span>*x^<span class="hljs-number">126</span> + <span class="hljs-number">2009</span>*x^<span class="hljs-number">125</span> + <span class="hljs-number">45023</span>*x^<span class="hljs-number">124</span> + <span class="hljs-number">12311</span>*x^<span class="hljs-number">123</span> + <span class="hljs-number">21428</span>*x^<span class="hljs-number">122</span> + <span class="hljs-number">24110</span>*x^<span class="hljs-number">121</span> + <span class="hljs-number">43537</span>*x^<span class="hljs-number">120</span> + <span class="hljs-number">21885</span>*x^<span class="hljs-number">119</span> + <span class="hljs-number">50212</span>*x^<span class="hljs-number">118</span> + <span class="hljs-number">40445</span>*x^<span class="hljs-number">117</span> + <span class="hljs-number">17768</span>*x^<span class="hljs-number">116</span> + <span class="hljs-number">46616</span>*x^<span class="hljs-number">115</span> + <span class="hljs-number">4771</span>*x^<span class="hljs-number">114</span> + <span class="hljs-number">20903</span>*x^<span class="hljs-number">113</span> + <span class="hljs-number">47764</span>*x^<span class="hljs-number">112</span> + <span class="hljs-number">13056</span>*x^<span class="hljs-number">111</span> + <span class="hljs-number">50837</span>*x^<span class="hljs-number">110</span> + <span class="hljs-number">22313</span>*x^<span class="hljs-number">109</span> + <span class="hljs-number">39698</span>*x^<span class="hljs-number">108</span> + <span class="hljs-number">60377</span>*x^<span class="hljs-number">107</span> + <span class="hljs-number">59357</span>*x^<span class="hljs-number">106</span> + <span class="hljs-number">24051</span>*x^<span class="hljs-number">105</span> + <span class="hljs-number">5888</span>*x^<span class="hljs-number">104</span> + <span class="hljs-number">29414</span>*x^<span class="hljs-number">103</span> + <span class="hljs-number">31726</span>*x^<span class="hljs-number">102</span> + <span class="hljs-number">4906</span>*x^<span class="hljs-number">101</span> + <span class="hljs-number">23968</span>*x^<span class="hljs-number">100</span> + <span class="hljs-number">52360</span>*x^<span class="hljs-number">99</span> + <span class="hljs-number">58063</span>*x^<span class="hljs-number">98</span> + <span class="hljs-number">706</span>*x^<span class="hljs-number">97</span> + <span class="hljs-number">31420</span>*x^<span class="hljs-number">96</span> + <span class="hljs-number">62468</span>*x^<span class="hljs-number">95</span> + <span class="hljs-number">18557</span>*x^<span class="hljs-number">94</span> + <span class="hljs-number">1498</span>*x^<span class="hljs-number">93</span> + <span class="hljs-number">17590</span>*x^<span class="hljs-number">92</span> + <span class="hljs-number">62990</span>*x^<span class="hljs-number">91</span> + <span class="hljs-number">27200</span>*x^<span class="hljs-number">90</span> + <span class="hljs-number">7052</span>*x^<span class="hljs-number">89</span> + <span class="hljs-number">39117</span>*x^<span class="hljs-number">88</span> + <span class="hljs-number">46944</span>*x^<span class="hljs-number">87</span> + <span class="hljs-number">45535</span>*x^<span class="hljs-number">86</span> + <span class="hljs-number">28092</span>*x^<span class="hljs-number">85</span> + <span class="hljs-number">1981</span>*x^<span class="hljs-number">84</span> + <span class="hljs-number">4377</span>*x^<span class="hljs-number">83</span> + <span class="hljs-number">34419</span>*x^<span class="hljs-number">82</span> + <span class="hljs-number">33754</span>*x^<span class="hljs-number">81</span> + <span class="hljs-number">2640</span>*x^<span class="hljs-number">80</span> + <span class="hljs-number">44427</span>*x^<span class="hljs-number">79</span> + <span class="hljs-number">32179</span>*x^<span class="hljs-number">78</span> + <span class="hljs-number">57721</span>*x^<span class="hljs-number">77</span> + <span class="hljs-number">9444</span>*x^<span class="hljs-number">76</span> + <span class="hljs-number">49374</span>*x^<span class="hljs-number">75</span> + <span class="hljs-number">21288</span>*x^<span class="hljs-number">74</span> + <span class="hljs-number">44098</span>*x^<span class="hljs-number">73</span> + <span class="hljs-number">57744</span>*x^<span class="hljs-number">72</span> + <span class="hljs-number">63457</span>*x^<span class="hljs-number">71</span> + <span class="hljs-number">43300</span>*x^<span class="hljs-number">70</span> + <span class="hljs-number">1508</span>*x^<span class="hljs-number">69</span> + <span class="hljs-number">13775</span>*x^<span class="hljs-number">68</span> + <span class="hljs-number">23197</span>*x^<span class="hljs-number">67</span> + <span class="hljs-number">43070</span>*x^<span class="hljs-number">66</span> + <span class="hljs-number">20751</span>*x^<span class="hljs-number">65</span> + <span class="hljs-number">47479</span>*x^<span class="hljs-number">64</span> + <span class="hljs-number">18496</span>*x^<span class="hljs-number">63</span> + <span class="hljs-number">53392</span>*x^<span class="hljs-number">62</span> + <span class="hljs-number">10387</span>*x^<span class="hljs-number">61</span> + <span class="hljs-number">2317</span>*x^<span class="hljs-number">60</span> + <span class="hljs-number">57492</span>*x^<span class="hljs-number">59</span> + <span class="hljs-number">25441</span>*x^<span class="hljs-number">58</span> + <span class="hljs-number">52532</span>*x^<span class="hljs-number">57</span> + <span class="hljs-number">27150</span>*x^<span class="hljs-number">56</span> + <span class="hljs-number">33788</span>*x^<span class="hljs-number">55</span> + <span class="hljs-number">43371</span>*x^<span class="hljs-number">54</span> + <span class="hljs-number">30972</span>*x^<span class="hljs-number">53</span> + <span class="hljs-number">39583</span>*x^<span class="hljs-number">52</span> + <span class="hljs-number">36407</span>*x^<span class="hljs-number">51</span> + <span class="hljs-number">35564</span>*x^<span class="hljs-number">50</span> + <span class="hljs-number">44564</span>*x^<span class="hljs-number">49</span> + <span class="hljs-number">1505</span>*x^<span class="hljs-number">48</span> + <span class="hljs-number">47519</span>*x^<span class="hljs-number">47</span> + <span class="hljs-number">38695</span>*x^<span class="hljs-number">46</span> + <span class="hljs-number">43107</span>*x^<span class="hljs-number">45</span> + <span class="hljs-number">1676</span>*x^<span class="hljs-number">44</span> + <span class="hljs-number">42057</span>*x^<span class="hljs-number">43</span> + <span class="hljs-number">49879</span>*x^<span class="hljs-number">42</span> + <span class="hljs-number">29083</span>*x^<span class="hljs-number">41</span> + <span class="hljs-number">42241</span>*x^<span class="hljs-number">40</span> + <span class="hljs-number">8853</span>*x^<span class="hljs-number">39</span> + <span class="hljs-number">33546</span>*x^<span class="hljs-number">38</span> + <span class="hljs-number">48954</span>*x^<span class="hljs-number">37</span> + <span class="hljs-number">30352</span>*x^<span class="hljs-number">36</span> + <span class="hljs-number">62020</span>*x^<span class="hljs-number">35</span> + <span class="hljs-number">39864</span>*x^<span class="hljs-number">34</span> + <span class="hljs-number">9519</span>*x^<span class="hljs-number">33</span> + <span class="hljs-number">24828</span>*x^<span class="hljs-number">32</span> + <span class="hljs-number">34696</span>*x^<span class="hljs-number">31</span> + <span class="hljs-number">2387</span>*x^<span class="hljs-number">30</span> + <span class="hljs-number">27413</span>*x^<span class="hljs-number">29</span> + <span class="hljs-number">55829</span>*x^<span class="hljs-number">28</span> + <span class="hljs-number">40217</span>*x^<span class="hljs-number">27</span> + <span class="hljs-number">30205</span>*x^<span class="hljs-number">26</span> + <span class="hljs-number">42328</span>*x^<span class="hljs-number">25</span> + <span class="hljs-number">6210</span>*x^<span class="hljs-number">24</span> + <span class="hljs-number">52442</span>*x^<span class="hljs-number">23</span> + <span class="hljs-number">58495</span>*x^<span class="hljs-number">22</span> + <span class="hljs-number">2014</span>*x^<span class="hljs-number">21</span> + <span class="hljs-number">26452</span>*x^<span class="hljs-number">20</span> + <span class="hljs-number">33547</span>*x^<span class="hljs-number">19</span> + <span class="hljs-number">19840</span>*x^<span class="hljs-number">18</span> + <span class="hljs-number">5995</span>*x^<span class="hljs-number">17</span> + <span class="hljs-number">16850</span>*x^<span class="hljs-number">16</span> + <span class="hljs-number">37855</span>*x^<span class="hljs-number">15</span> + <span class="hljs-number">7221</span>*x^<span class="hljs-number">14</span> + <span class="hljs-number">32200</span>*x^<span class="hljs-number">13</span> + <span class="hljs-number">8121</span>*x^<span class="hljs-number">12</span> + <span class="hljs-number">23767</span>*x^<span class="hljs-number">11</span> + <span class="hljs-number">46563</span>*x^<span class="hljs-number">10</span> + <span class="hljs-number">51673</span>*x^<span class="hljs-number">9</span> + <span class="hljs-number">19372</span>*x^<span class="hljs-number">8</span> + <span class="hljs-number">4157</span>*x^<span class="hljs-number">7</span> + <span class="hljs-number">48421</span>*x^<span class="hljs-number">6</span> + <span class="hljs-number">41096</span>*x^<span class="hljs-number">5</span> + <span class="hljs-number">45735</span>*x^<span class="hljs-number">4</span> + <span class="hljs-number">53022</span>*x^<span class="hljs-number">3</span> + <span class="hljs-number">35475</span>*x^<span class="hljs-number">2</span> + <span class="hljs-number">47521</span>*x + <span class="hljs-number">27544</span><br>S.&lt;x&gt; = R.quotient(N)<br>P,Q= N.factor()<br>P, Q = P[<span class="hljs-number">0</span>], Q[<span class="hljs-number">0</span>]<br>phi = (p2 ** P.degree() - <span class="hljs-number">1</span>) * (p2 ** Q.degree() - <span class="hljs-number">1</span>)<br>d = inverse_mod(e, phi)<br>m = <span class="hljs-built_in">pow</span>(c2,d,N)<br>h = <span class="hljs-built_in">int</span>(<span class="hljs-string">&quot;&quot;</span>.join([<span class="hljs-built_in">str</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> m.<span class="hljs-built_in">list</span>()]))<br><span class="hljs-built_in">print</span>(h)<br><span class="hljs-comment">#88520242910362871448352317137540300262448941340486475602003226117035863930302</span><br></code></pre></td></tr></table></figure><h2 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h2><p>æ±‚è§£fï¼Œgã€‚å‚è€ƒ<a href="https://xz.aliyun.com/t/7163#toc-4">ä»ä¸€é“CTFé¢˜åˆæ¢NTRUæ ¼å¯†ç  - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>æ„é€ æ ¼å¦‚ä¸‹æ‰€ç¤º</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031022463.png"/><p>è¿›è¡ŒLLL()å³å¯å¾—åˆ°(f,g)ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">h = <span class="hljs-number">88520242910362871448352317137540300262448941340486475602003226117035863930302</span><br>p1 = <span class="hljs-number">106472061241112922861460644342336453303928202010237284715354717630502168520267</span><br>v1 = vector(ZZ, [<span class="hljs-number">1</span>, h])<br>v2 = vector(ZZ, [<span class="hljs-number">0</span>, p1])<br>m = matrix([v1,v2])<br>shortest_vector = m.LLL()[<span class="hljs-number">0</span>]<br>f, g = shortest_vector<br><span class="hljs-built_in">print</span>(f,g)<br><span class="hljs-comment">#183610829622016944154542682943585488074 228679177303871981036829786447405151037</span><br></code></pre></td></tr></table></figure><h2 id="step3"><a href="#step3" class="headerlink" title="step3"></a>step3</h2><p>æ±‚gã€‚å¯¹gçš„ä½20ä½çˆ†ç ´ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><br>e = <span class="hljs-number">0x10001</span><br>g1 = <span class="hljs-number">228679177303871981036829786447405151037</span><br>c1 = <span class="hljs-number">20920247107738496784071050239422540936224577122721266141057957551603705972966457203177812404896852110975768315464852962210648535130235298413611598658659777108920014929632531307409885868941842921815735008981335582297975794108016151210394446009890312043259167806981442425505200141283138318269058818777636637375101005540308736021976559495266332357714</span><br>n = <span class="hljs-number">31398174203566229210665534094126601315683074641013205440476552584312112883638278390105806127975406224783128340041129316782549009811196493319665336016690985557862367551545487842904828051293613836275987595871004601968935866634955528775536847402581734910742403788941725304146192149165731194199024154454952157531068881114411265538547462017207361362857</span><br>g = (g1&gt;&gt;<span class="hljs-number">20</span>)&lt;&lt;<span class="hljs-number">20</span><br>g = next_prime(g)<br>end = g ^ (<span class="hljs-number">2</span>**<span class="hljs-number">20</span>-<span class="hljs-number">1</span>)<br><span class="hljs-keyword">while</span> g &lt;= end:<br>    <span class="hljs-keyword">if</span> n%g == <span class="hljs-number">0</span>:<br>        q = n//g<br>        d = invert(e,(q-<span class="hljs-number">1</span>)*(g-<span class="hljs-number">1</span>))<br>        m = <span class="hljs-built_in">pow</span>(c1,d,n)<br>        <span class="hljs-built_in">print</span>(long_to_bytes(m))<br>    g = next_prime(g)<br></code></pre></td></tr></table></figure><h1 id="LWE"><a href="#LWE" class="headerlink" title="LWE?"></a>LWE?</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> secret<br><span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(secret)==<span class="hljs-number">66</span>*<span class="hljs-number">3</span><br>sec = [<span class="hljs-built_in">ord</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> secret]<br><br>DEBUG = <span class="hljs-literal">False</span><br>m = <span class="hljs-number">66</span><br>n = <span class="hljs-number">200</span><br>p = <span class="hljs-number">3</span><br>q = <span class="hljs-number">2</span>^<span class="hljs-number">20</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">errorV</span>():<br>  <span class="hljs-keyword">return</span> vector(ZZ, [<span class="hljs-number">1</span> - randrange(p) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">matrixMn</span>():<br>  <span class="hljs-keyword">return</span> matrix(ZZ, [[q//<span class="hljs-number">2</span> - randrange(q) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m)])<br><br>A, B, C = matrixMn(), matrixMn(), matrixMn()<br>x = vector(ZZ, sec[<span class="hljs-number">0</span>:m])<br>y = vector(ZZ, sec[m:<span class="hljs-number">2</span>*m])<br>z = vector(ZZ, sec[<span class="hljs-number">2</span>*m:<span class="hljs-number">3</span>*m])<br>e = errorV()<br>b = x*A+y*B+z*C+e<br><br><span class="hljs-keyword">if</span> DEBUG:<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;x = %s&#x27;</span> % x)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;y = %s&#x27;</span> % y)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;z = %s&#x27;</span> % z)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;e = %s&#x27;</span> % e)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;A = \n%s&#x27;</span> % A)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;B = \n%s&#x27;</span> % B)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;C = \n%s&#x27;</span> % C)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;b = %s&#x27;</span> % b)<br></code></pre></td></tr></table></figure><p>å°†$b &#x3D; x*A+y*B+z*C+e$æ”¹é€ ä¸€ä¸‹ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªå¸¸è§çš„å¼å­ï¼š<br>$$<br>b &#x3D; [x,y,z]* \left[\matrix{A \\B\\C}\right] + e<br>$$<br>eå–è‡ª[-1,0,1]ï¼Œè¯¯å·®å¾ˆå°ï¼ŒæŒ‰ç…§å¸¸è§„è§£æ³•å°±å¯ä»¥å¾—åˆ°flagäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">str_to_int</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">return</span> [<span class="hljs-built_in">int</span>(each) <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> s]<br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;out&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>)<br>f.readline()<br>matA=[]<br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">66</span>):<br>    s = f.readline()[<span class="hljs-number">1</span>:-<span class="hljs-number">2</span>].split()<br>    row = str_to_int(s)<br>    matA.append(row)<br><br>f.readline()<br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">66</span>):<br>    s = f.readline()[<span class="hljs-number">1</span>:-<span class="hljs-number">2</span>].split()<br>    row = str_to_int(s)<br>    matA.append(row)<br><br>f.readline()<br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">66</span>):<br>    s = f.readline()[<span class="hljs-number">1</span>:-<span class="hljs-number">2</span>].split()<br>    row = str_to_int(s)<br>    matA.append(row)<br><br>row= [-<span class="hljs-number">19786291</span>, -<span class="hljs-number">713104590</span>, <span class="hljs-number">79700973</span>, <span class="hljs-number">23261288</span>, <span class="hljs-number">203038164</span>, <span class="hljs-number">430352288</span>, <span class="hljs-number">147848301</span>, <span class="hljs-number">633183638</span>, <span class="hljs-number">188651439</span>, <span class="hljs-number">243206160</span>, -<span class="hljs-number">654830271</span>, <span class="hljs-number">335642059</span>, -<span class="hljs-number">100511588</span>, <span class="hljs-number">180023362</span>, <span class="hljs-number">130607831</span>, <span class="hljs-number">227597861</span>, <span class="hljs-number">188424473</span>, <span class="hljs-number">175518170</span>, -<span class="hljs-number">246987997</span>, <span class="hljs-number">180879649</span>, <span class="hljs-number">421934976</span>, -<span class="hljs-number">227575274</span>, -<span class="hljs-number">628937118</span>, <span class="hljs-number">5466646</span>, -<span class="hljs-number">254939474</span>, -<span class="hljs-number">438417079</span>, <span class="hljs-number">150434624</span>, <span class="hljs-number">327054986</span>, <span class="hljs-number">163561829</span>, <span class="hljs-number">816959939</span>, -<span class="hljs-number">265298657</span>, <span class="hljs-number">82651050</span>, <span class="hljs-number">176899880</span>, <span class="hljs-number">174020455</span>, -<span class="hljs-number">419656325</span>, -<span class="hljs-number">101606182</span>, <span class="hljs-number">300413909</span>, <span class="hljs-number">237169571</span>, -<span class="hljs-number">589213744</span>, <span class="hljs-number">121803611</span>, -<span class="hljs-number">38080334</span>, -<span class="hljs-number">255712509</span>, -<span class="hljs-number">133782964</span>, <span class="hljs-number">106220001</span>, <span class="hljs-number">195767251</span>, -<span class="hljs-number">397096116</span>, -<span class="hljs-number">583305587</span>, -<span class="hljs-number">182462561</span>, -<span class="hljs-number">271478737</span>, -<span class="hljs-number">32014717</span>, <span class="hljs-number">114385188</span>, <span class="hljs-number">437506115</span>, -<span class="hljs-number">1165732</span>, <span class="hljs-number">179349265</span>, -<span class="hljs-number">77761751</span>, -<span class="hljs-number">233976783</span>, <span class="hljs-number">410153356</span>, <span class="hljs-number">476453640</span>, <span class="hljs-number">91892631</span>, -<span class="hljs-number">242168750</span>, <span class="hljs-number">506769243</span>, -<span class="hljs-number">384438362</span>, <span class="hljs-number">131852532</span>, <span class="hljs-number">586202810</span>, <span class="hljs-number">376719791</span>, <span class="hljs-number">578215353</span>, <span class="hljs-number">874304742</span>, <span class="hljs-number">163584566</span>, <span class="hljs-number">434260863</span>, <span class="hljs-number">98013671</span>, <span class="hljs-number">213627784</span>, <span class="hljs-number">59622886</span>, -<span class="hljs-number">84912852</span>, <span class="hljs-number">156744856</span>, <span class="hljs-number">169652328</span>, <span class="hljs-number">178143615</span>, <span class="hljs-number">400046730</span>, <span class="hljs-number">408163110</span>, -<span class="hljs-number">357990863</span>, -<span class="hljs-number">269552089</span>, -<span class="hljs-number">199410809</span>, <span class="hljs-number">187503858</span>, -<span class="hljs-number">853206157</span>, <span class="hljs-number">134901027</span>, <span class="hljs-number">313984185</span>, -<span class="hljs-number">162544217</span>, -<span class="hljs-number">69722073</span>, <span class="hljs-number">43817388</span>, -<span class="hljs-number">47389463</span>, <span class="hljs-number">210346729</span>, -<span class="hljs-number">46516961</span>, <span class="hljs-number">72002967</span>, <span class="hljs-number">327714191</span>, <span class="hljs-number">45052266</span>, <span class="hljs-number">1010509210</span>, <span class="hljs-number">110937225</span>, <span class="hljs-number">448179404</span>, <span class="hljs-number">341448936</span>, <span class="hljs-number">446550865</span>, <span class="hljs-number">221914340</span>, -<span class="hljs-number">804918424</span>, -<span class="hljs-number">12007071</span>, <span class="hljs-number">151215468</span>, <span class="hljs-number">440279795</span>, -<span class="hljs-number">73408566</span>, -<span class="hljs-number">112121988</span>, <span class="hljs-number">40294376</span>, <span class="hljs-number">283179449</span>, -<span class="hljs-number">193812410</span>, -<span class="hljs-number">30061804</span>, <span class="hljs-number">20326854</span>, <span class="hljs-number">65412625</span>, -<span class="hljs-number">260020045</span>, -<span class="hljs-number">570090340</span>, <span class="hljs-number">1546454</span>, <span class="hljs-number">548030557</span>, <span class="hljs-number">618148316</span>, <span class="hljs-number">290333796</span>, <span class="hljs-number">665474379</span>, <span class="hljs-number">301709165</span>, -<span class="hljs-number">104726821</span>, -<span class="hljs-number">503111899</span>, <span class="hljs-number">480689642</span>, -<span class="hljs-number">331192606</span>, -<span class="hljs-number">518345784</span>, -<span class="hljs-number">314602459</span>, <span class="hljs-number">25354403</span>, <span class="hljs-number">410995568</span>, <span class="hljs-number">179675848</span>, -<span class="hljs-number">207010027</span>, <span class="hljs-number">400838662</span>, <span class="hljs-number">125916880</span>, <span class="hljs-number">501112567</span>, <span class="hljs-number">578261227</span>, <span class="hljs-number">24802586</span>, <span class="hljs-number">493171331</span>, <span class="hljs-number">383306766</span>, -<span class="hljs-number">390093502</span>, -<span class="hljs-number">389822626</span>, -<span class="hljs-number">303615722</span>, <span class="hljs-number">20813851</span>, -<span class="hljs-number">399678371</span>, -<span class="hljs-number">566907567</span>, -<span class="hljs-number">432647113</span>, -<span class="hljs-number">280465568</span>, <span class="hljs-number">1002042393</span>, -<span class="hljs-number">510901339</span>, <span class="hljs-number">316603766</span>, -<span class="hljs-number">139701243</span>, <span class="hljs-number">211217523</span>, <span class="hljs-number">108545545</span>, -<span class="hljs-number">12948109</span>, -<span class="hljs-number">569199543</span>, <span class="hljs-number">37065919</span>, -<span class="hljs-number">150542603</span>, <span class="hljs-number">417851006</span>, -<span class="hljs-number">470173530</span>, -<span class="hljs-number">628557669</span>, -<span class="hljs-number">128339015</span>, -<span class="hljs-number">427978763</span>, <span class="hljs-number">381402990</span>, <span class="hljs-number">205835334</span>, -<span class="hljs-number">30976552</span>, -<span class="hljs-number">357466556</span>, -<span class="hljs-number">104985580</span>, -<span class="hljs-number">115366372</span>, <span class="hljs-number">296031071</span>, -<span class="hljs-number">8036087</span>, <span class="hljs-number">79340491</span>, <span class="hljs-number">650365147</span>, <span class="hljs-number">295521125</span>, <span class="hljs-number">885900267</span>, <span class="hljs-number">133049758</span>, <span class="hljs-number">217970062</span>, <span class="hljs-number">237420894</span>, <span class="hljs-number">358760095</span>, -<span class="hljs-number">2684469</span>, <span class="hljs-number">475711698</span>, <span class="hljs-number">316770575</span>, -<span class="hljs-number">25024622</span>, -<span class="hljs-number">193442003</span>, <span class="hljs-number">200260606</span>, <span class="hljs-number">89183826</span>, <span class="hljs-number">567491985</span>, <span class="hljs-number">726371428</span>, <span class="hljs-number">222116554</span>, <span class="hljs-number">87397506</span>, -<span class="hljs-number">29529094</span>, <span class="hljs-number">125968479</span>, -<span class="hljs-number">50793004</span>, <span class="hljs-number">218035181</span>, -<span class="hljs-number">210376687</span>, <span class="hljs-number">1025673749</span>, -<span class="hljs-number">262390458</span>, <span class="hljs-number">467412984</span>, -<span class="hljs-number">71097225</span>, <span class="hljs-number">259125517</span>, -<span class="hljs-number">337232810</span>, <span class="hljs-number">143359550</span>, <span class="hljs-number">27115363</span>]<br>matA.append(row)<br>L=Matrix(ZZ,matA)<br>e=vector(ZZ,L.LLL()[<span class="hljs-number">0</span>])<br><span class="hljs-built_in">print</span>(e)<br>b=vector(ZZ,row)<br>s=b-e<br>m=L.solve_left(s)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">list</span>(m)))<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b&quot;Oh, you get it?? Here is the flag: &#x27;DASCTF&#123;uuid&#125;&#x27;. What? You don&#x27;t know the uuid? The first part is &#x27;dcf41556&#x27;, second part-&gt; &#x27;c194&#x27;, and then &#x27;4c66&#x27;, &#x27;9092&#x27;. And finally, it&#x27;s &#x27;059e0bf8b84e&#x27;!!! 0v0\x00&quot;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ECDSA</tag>
      
      <tag>NTRU</tag>
      
      <tag>å¤šé¡¹å¼RSA</tag>
      
      <tag>LWE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NepCTF 2022</title>
    <link href="/2022/07/21/NepCTF%202022/"/>
    <url>/2022/07/21/NepCTF%202022/</url>
    
    <content type="html"><![CDATA[<h1 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h1><p>p,qæå…¶è¿‘ä¼¼ï¼Œå¯¹nå¼€æ ¹å·å–å‰åç´ æ•°æ±‚å‡ºp,q</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">import</span> sympy<br><br>n = <span class="hljs-number">19955580242010925349026385826277356862322608500430230515928936214328341334162349408990409245298441768036250429913772953915537485025323789254947881868366911379717813713406996010824562645958646441589124825897348626601466594149743648589703323284919806371555688798726766034226044561171215392728880842964598154362131942585577722616354074267803330013886538511795383890371097812191816934883393255463554256887559394146851379087386846398690114807642170885445050850978579391063585254346364297374019309370189128443081285875218288166996242359495992824824109894071316525623741755423467173894812627595135675814789191820979950786791</span><br>e = <span class="hljs-number">65537</span><br>c_mod_p = <span class="hljs-number">32087476819370469840242617415402189007173583393431940289526096277088796498999849060235750455260897143027010566292541554247738211165214410052782944239055659645055068913404216441100218886028415095562520911677409842046139862877354601487378542714918065194110094824176055917454013488494374453496445104680546085816</span><br>c_mod_q = <span class="hljs-number">59525076096565721328350936302014853798695106815890830036017737946936659488345231377005951566231961079087016626410792549096788255680730275579842963019533111895111371299157077454009624496993522735647049730706272867590368692485377454608513865895352910757518148630781337674813729235453169946609851250274688614922</span><br>tmp = gmpy2.iroot(n,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]<br>q = sympy.nextprime(tmp)<br>p = n // q<br>d = gmpy2.invert(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br><span class="hljs-string">&#x27;&#x27;&#x27;mä¸€èˆ¬éƒ½ä¸ä¼šå¾ˆé•¿ï¼Œå®Œå…¨å¯ä»¥ç”¨p,qä½œä¸ºæ¨¡æ•°</span><br><span class="hljs-string">m = pow(c_mod_p,gmpy2.invert(e,p-1),p)</span><br><span class="hljs-string">print(long_to_bytes(m))</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>invq = gmpy2.invert(q,p)<br>invp = gmpy2.invert(p,q)<br>c = (c_mod_p*invq*q + c_mod_q*invp*p)%n<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br></code></pre></td></tr></table></figure><h1 id="ä¸­å­¦æ•°å­¦"><a href="#ä¸­å­¦æ•°å­¦" class="headerlink" title="ä¸­å­¦æ•°å­¦"></a>ä¸­å­¦æ•°å­¦</h1><p>å·²çŸ¥$q&#x3D;next_prime(p+(p&gt;&gt;500))$ï¼Œåˆ™<br>$$<br>q&#x3D;\lfloor (1+\frac{1}{2^{500}})p\rfloor+r<br>$$<br>å…¶ä¸­ræ˜¯æ»¡è¶³qä¸ºç´ æ•°çš„æœ€å°æ•´æ•°ï¼Œ<br>$$<br>n&#x3D;pq&#x3D;\lfloor (1+\dfrac{1}{2^{500}})p^2\rfloor+rp<br>$$<br>äºæ˜¯<br>$$<br>âŒŠ(1+\dfrac{1}{2^{500}})nâŒ‹&#x3D;âŒŠ(1+\dfrac{1}{2^{500}})pâŒ‹^2+âŒŠ(1+\dfrac{1}{2^{500}})rpâŒ‹&gt;âŒŠ(1+\dfrac{1}{2^{500}})pâŒ‹^2<br>$$<br>åˆæœ‰<br>$$<br>âŒŠ(1+\dfrac{1}{2^{500}})nâŒ‹&#x3D;âŒŠ(1+\dfrac{1}{2^{500}})pâŒ‹^2+âŒŠ(1+\dfrac{1}{2^{500}})rpâŒ‹&lt;âŒŠ(1+\dfrac{1}{2^{500}})pâŒ‹^2+2âŒŠ(1+\dfrac{1}{2^{500}})rpâŒ‹+r^2 &#x3D; q^2<br>$$<br>æ‰€ä»¥<br>$$<br>âŒŠ(1+\dfrac{1}{2^{500}})pâŒ‹&lt;\sqrt{\lfloor(1+\frac{1}{2^{500}})n\rfloor}&lt;\lfloor(1+\frac{1}{2^{500}})p\rfloor+r<br>$$<br>å³<br>$$<br>qâˆ’r&lt;\sqrt{âŒŠ(1+\dfrac{1}{2^{500}})nâŒ‹}<br>$$<br>æ‰€ä»¥<br>$$<br>\lfloor(1+\frac{1}{2^{500}})p\rfloor&lt;\sqrt{\lfloor(1+\frac{1}{2^{500}})n\rfloor}&lt;\lfloor(1+\frac{1}{2^{500}})p\rfloor+r<br>$$<br>å¾—åˆ°äº†æ— éœ€çˆ†ç ´çš„å½¢å¼ã€‚</p><p>ä½†æ³¨æ„åˆ°next_primeç®—æ³•çš„æœ¬è´¨é€»è¾‘å³æ˜¯é€šè¿‡ä¸æ–­æšä¸¾å¥‡æ•°åˆ¤æ–­æ˜¯å¦ä¸ºç´ æ•°ï¼Œè€Œè¿™é‡Œnçš„åˆ†è§£ä¿è¯äº†å…¶å¿…ä¸ºç´ æ•°ï¼Œå†åˆ¤æ–­ç´ æ•°çš„è¯å±äºæ˜¯å¤šæ­¤ä¸€ä¸¾ï¼ˆæµªè´¹è®¡ç®—èµ„æºï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®ç´ æ•°åˆ†å¸ƒå…¬å¼æˆ–next_primeçš„æ–¹æ¡ˆå‘ä¸‹æšä¸¾ï¼Œå¾—åˆ°å”¯ä¸€åˆ†è§£å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> next_prime,iroot,invert<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>n= <span class="hljs-number">13776679754786305830793674359562910178503525293501875259698297791987196248336062506951151345232816992904634767521007443634017633687862289928715870204388479258679577315915061740028494078672493226329115247979108035669870651598111762906959057540508657823948600824548819666985698501483261504641066030188603032714383272686110228221709062681957025702835354151145335986966796484545336983392388743498515384930244837403932600464428196236533563039992819408281355416477094656741439388971695931526610641826910750926961557362454734732247864647404836037293509009829775634926600458845832805085222154851310850740227722601054242115507</span><br>c= <span class="hljs-number">6253975396639688013947622483271226838902346034187241970785550830715516801386404802832796746428068354515287579293520381463797045055114065533348514688044281004266071342722261719304097175009672596062130939189624163728328429608123325223000160428261082507446604698345173189268359115612698883860396660563679801383563588818099088505120717238037463747828729693649297904035253985982099474025883550074375828799938384533606092448272306356003096283602697757642323962299153853559914553690456801745940925602411053578841756504799815771173679267389055390097241148454899265156705442028845650177138185876173539754631720573266723359186</span><br>e = <span class="hljs-number">0x10001</span><br><br>q = iroot((n + (n &gt;&gt; <span class="hljs-number">500</span>)),<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(isPrime(q))<span class="hljs-comment">#False</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    q = next_prime(q)<br>    <span class="hljs-keyword">if</span> n % q == <span class="hljs-number">0</span>:<br>        p = n//q<br>        d = invert(e, (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>        m = <span class="hljs-built_in">pow</span>(c, d, n)<br>        flag = long_to_bytes(m)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> flag <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;NepCTF&#x27;</span> <span class="hljs-keyword">in</span> flag:<br>            <span class="hljs-built_in">print</span>(flag)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><h1 id="bd-key"><a href="#bd-key" class="headerlink" title="bd_key"></a>bd_key</h1><p><a href="https://eprint.iacr.org/2015/767.pdf">767.pdf (iacr.org)</a></p><p><a href="https://asecuritysite.com/encryption/dualec">Dual EC (asecuritysite.com)</a></p><p>æ¯”èµ›æ—¶æ€è·¯:</p><hr><p>åˆ†æä»£ç å‘ç°ï¼Œ<code>do_schnorr_identification()</code>èƒ½å½±å“ï¼ˆæˆ–æœ‰ä½œç”¨ï¼‰çš„æ˜¯<code>challenge()</code>ï¼Œåˆ†æ<code>getRandomNBytes()</code>ï¼Œå‘ç°ç»™å‡ºçš„<code>c = __Dual_EC_DRBG(0)  </code>ã€‚</p><p>åœ¨å¿½ç•¥<code>s_i</code>ç­‰å…¶ä»–å˜é‡çš„ï¼Œé€šè¿‡<code>getRandomNBytes()</code>åˆ†æ<code>key</code>å’Œ<code>c</code>çš„è·å–ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">c = <span class="hljs-constructor">__Dual_EC_DRBG(<span class="hljs-params">self</span>.<span class="hljs-params">h_adin</span>)</span><br>key = <span class="hljs-constructor">__Dual_EC_DRBG(<span class="hljs-params">self</span>.<span class="hljs-params">h_adin</span>)</span> &gt;&gt; <span class="hljs-number">128</span><br></code></pre></td></tr></table></figure><p>è™½ç„¶çœ‹ä¸Šå»å¯ä»¥é€šè¿‡<code>c</code>æ±‚<code>key</code>ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œä¸Šé¢ä¸¤ä¸ªå‡½æ•°æ—¶ä¼šå½±å“<code>s_i</code>,è¿›è€Œå½±å“åˆ°<code>key</code>ã€‚</p><p>äºæ˜¯ä¹å¤§è‡´æ€è·¯å°±æ˜¯é€šè¿‡<code>c</code>æ¥æ±‚å‡º<code>r_i</code>ä¹‹å‰çš„<code>s_i</code>ï¼Œç„¶åèµ°ä¸€éæµç¨‹å°±å¯ä»¥å¾—åˆ°<code>key</code>ã€‚</p><p>åˆ†æ<code>__Dual_EC_DRBG()</code>ï¼Œå¾—å‡ºä»¥ä¸‹å…¬å¼</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">s_i <span class="hljs-operator">=</span> (s_i*P)[<span class="hljs-number">0</span>]<br><span class="hljs-attribute">c</span> <span class="hljs-operator">=</span> r_i <span class="hljs-operator">=</span> (s_i*Q)[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“<code>P,Q,c</code>ï¼Œåˆ©ç”¨P,Qå’Œç”Ÿæˆçš„ç‚¹éƒ½åœ¨æ¤­åœ†æ›²çº¿ä¸Šï¼Œå…´è®¸å¯ä»¥è”ç«‹æ–¹ç¨‹æ±‚å‡º<code>s_i</code>ï¼Ÿ</p><p> åˆ©ç”¨æ¤­åœ†æ›²çº¿æ–¹ç¨‹ï¼Œå·²çŸ¥<code>x</code>æ±‚<code>y</code>ï¼Œæ±‚å‡ºç”Ÿæˆç‚¹ï¼Œç„¶ååˆ©ç”¨ECDLPæ±‚è§£<code>s_i</code>ï¼ˆå¥½åƒè·‘ä¸å‡ºæ¥ï¼‰</p><hr><p>æ³¨æ„ç±»åï¼Œæ”¾ç½‘ä¸Šä¸€æœå°±æœ‰ç›¸å…³å†…å®¹ï¼ï¼ï¼</p><hr><p><code>Dual_EC_DBRG</code>é—®é¢˜ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æœä¸€æœå…¶èƒŒåçš„æ•…äº‹ï¼ŒçœŸæœ‰ç‚¹é­”å¹»ã€‚</p><p>æ•´åˆä¸€ä¸‹ä¸Šé¢çš„åˆ†æï¼Œç”Ÿæˆ<code>c</code>çš„è¿‡ç¨‹æœ‰æ–¹ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">(1)</span>s_i = <span class="hljs-comment">(s_i*P)</span>[<span class="hljs-number">0</span>]<br><span class="hljs-comment">(2)</span>c = r_i = <span class="hljs-comment">(s_i*Q)</span>[<span class="hljs-number">0</span>]<br><span class="hljs-comment">(3)</span>s_i = <span class="hljs-comment">(s_i*P)</span>[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“<code>d</code>ï¼Œè¿™å°±ç›¸å½“äºç»™äº†ä¸ªåé—¨ã€‚</p><p>å‡è®¾æ¨ªåæ ‡ä¸º<code>c</code>çš„ç‚¹ä¸º<code>R = (c,y)</code>ï¼Œæ ¹æ®ä¸Šé¢çš„(1)(2)(3)å…¬å¼ä»¥åŠ$P&#x3D;d*Q$ï¼Œæœ‰<br>$$<br>d*R &#x3D; d*(s_i*Q) &#x3D; s_i*(d*Q) &#x3D; s_i*P<br>$$<br>äºæ˜¯å¯ä»¥ç›´æ¥å¾—åˆ°(3)çš„$s_i$ ï¼Œå†èµ°ä¸€éæµç¨‹å°±å¯ä»¥å¾—åˆ°<code>key</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># sagemath</span><br><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br>p = <span class="hljs-number">115792089210356248762697446949407573530086143415290314195533631308867097853951</span><br>n = <span class="hljs-number">115792089210356248762697446949407573529996955224135760342422259061068512044369</span><br>b = <span class="hljs-number">0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b</span><br>E = EllipticCurve(GF(p), [-<span class="hljs-number">3</span>, b])<br>Qx = <span class="hljs-number">0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296</span><br>Qy = <span class="hljs-number">0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5</span><br>Q = E(Qx, Qy)<br>d = <span class="hljs-number">66604141534275704476445937214374130642068729921454877238730830814793201802544</span><br>P = d * Q<br>c = <span class="hljs-number">59100197418944667413449341413044666843726352095054393072750502893110293231642</span><br>ct = <span class="hljs-number">25645992443585671366815910836517434170297823176311632150463962979581372384075859802765045877741181123347569267185176</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dec_flag</span>(<span class="hljs-params">ct, key</span>):<br>    cipher = AES.new(key, AES.MODE_ECB)<br>    ct = long_to_bytes(ct)<br>    flag = cipher.decrypt(ct)<br>    <span class="hljs-built_in">print</span>(flag)<br><br><span class="hljs-keyword">assert</span> E.is_x_coord(c)<span class="hljs-comment">#æ£€æµ‹cæ˜¯å¦æ˜¯xåæ ‡ï¼Œå³å­˜åœ¨ç‚¹ï¼Œxåæ ‡ä¸ºc</span><br>s1_Q = E.lift_x(c)<span class="hljs-comment">#æ‰¾ç‚¹</span><br>s2 = (d * s1_Q)[<span class="hljs-number">0</span>].lift()<br>s3 = (s2 * P)[<span class="hljs-number">0</span>].lift()<br>r3 = (s3 * Q)[<span class="hljs-number">0</span>].lift()<br>k = r3 &gt;&gt; ((<span class="hljs-number">32</span> - <span class="hljs-number">16</span>) * <span class="hljs-number">8</span>)<br>key = long_to_bytes(k)<br>dec_flag(ct, key)  <br></code></pre></td></tr></table></figure><h1 id="P-or-S"><a href="#P-or-S" class="headerlink" title="P or S"></a>P or S</h1><p>åˆ†æ<code>enc()</code>å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">enc</span>(<span class="hljs-params">v</span>):<br>    t = v<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> keys:<br>        q = []<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> Pbox:<br>            q.append(<span class="hljs-built_in">sum</span>([t[k] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> j]) % <span class="hljs-number">2</span>)<br>        t = [<span class="hljs-built_in">int</span>(q[j]) ^ <span class="hljs-built_in">int</span>(i[j]) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>)]<br>    <span class="hljs-keyword">return</span> t<br></code></pre></td></tr></table></figure><p>ç»†å¿ƒç‚¹å¯ä»¥å‘ç° $q$ çš„ç”Ÿæˆå¯ä»¥çœ‹æˆ $GF(2)$ ä¸Šçš„çŸ©é˜µè¿ç®—ï¼ˆè¡Œä¹˜åˆ—ï¼Œå¾ˆåƒå§ï¼‰ï¼Œå‡è®¾ $Pbox$ çš„çŸ©é˜µä¸º $P$ (32Ã—32)ï¼Œä¼ å…¥çš„æ˜æ–‡çš„çŸ©é˜µä¸º $M$ (32Ã—1)ï¼Œåˆ™ä¸­é—´ç”ŸæˆçŸ©é˜µä¸º $T&#x3D;P*M$ ï¼Œ$t$ è¿™ä¸€æ­¥å°±æ˜¯é¢å¤–åŠ ä¸€ä¸ªçŸ©é˜µ $K_i$(32Ã—1)ï¼Œäºæ˜¯6æ¬¡å¾ªç¯æœ‰å¦‚ä¸‹å…¬å¼<br>$$<br>c &#x3D; P*(P*(P*(P*(P*(P*M+K_1)+K_2)+K_3)+K_4)+K_5)+K_6 &#x3D; P^6*M+\sum_{i&#x3D;0}^{n&#x3D;6}P^{6-i}K_i<br>$$<br>é€šè¿‡å·²çŸ¥ä¸€ç»„æ˜å¯†æ–‡å¯ä»¥è®¡ç®—å‡ºå¯¹åº”çš„$\sum_{i&#x3D;0}^{n&#x3D;6}P^{6-i}K_i$ ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>Pbox = [<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">16</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">14</span>, <span class="hljs-number">16</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">25</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">13</span>, <span class="hljs-number">16</span>, <span class="hljs-number">19</span>, <span class="hljs-number">21</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>],<br>    [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">27</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">13</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">29</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>],<br>    [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>, <span class="hljs-number">25</span>, <span class="hljs-number">27</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">16</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">21</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>],<br>    [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">15</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">29</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">17</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">30</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">30</span>],<br>    [<span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">14</span>, <span class="hljs-number">16</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">24</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">25</span>, <span class="hljs-number">29</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>],<br>    [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">24</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>],<br>    [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">12</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">21</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">23</span>, <span class="hljs-number">26</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>],<br>    [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">16</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">25</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">10</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">25</span>, <span class="hljs-number">29</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">25</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">16</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">21</span>, <span class="hljs-number">23</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">16</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">21</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">28</span>],<br>    [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">14</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">25</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">13</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">19</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">27</span>],<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">12</span>, <span class="hljs-number">16</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">26</span>, <span class="hljs-number">30</span>]<br>]<br><br><span class="hljs-comment">#get Matrix P</span><br>P = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>):<br>    t = [<span class="hljs-number">0</span>]*<span class="hljs-number">32</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(Pbox[i])):<br>        t[Pbox[i][j]] = <span class="hljs-number">1</span><br>    P.append(t)<br>P = Matrix(GF(<span class="hljs-number">2</span>),P)<br>P6 = P^<span class="hljs-number">6</span><br>inv_P6 = P6^(-<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">#get sum of key_i*P^j</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getsum</span>(<span class="hljs-params">data,cipher</span>):<br>    A = [[<span class="hljs-built_in">int</span>(i)] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data]<span class="hljs-comment">#A = matrix(32,1,A)</span><br>    A = Matrix(GF(<span class="hljs-number">2</span>),A)<br>    C = [[<span class="hljs-built_in">int</span>(i)] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cipher]<br>    C = Matrix(GF(<span class="hljs-number">2</span>),C)<br>    <span class="hljs-built_in">sum</span> = C - P6*A<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span><br><br><span class="hljs-comment">#to decrypto</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solve</span>(<span class="hljs-params">B,C</span>):<span class="hljs-comment">#B is key_sum,C is cipher</span><br>    C = Matrix(GF(<span class="hljs-number">2</span>),C)<br>    f = inv_P6*(C-B)<br>    <span class="hljs-keyword">return</span> f.<span class="hljs-built_in">list</span>()<br><br><br>ciphertext = <span class="hljs-string">&#x27;0111110000100101000001101011110111101100000010110011101111000101111110111111100100100010001011000101000110110011111101000001001000000101111000001110001111001001100100111000011011101111111101001011100000100100110011111101100111001100111111110001111011101100&#x27;</span><br><span class="hljs-built_in">format</span> = <span class="hljs-built_in">bin</span>(bytes_to_long(<span class="hljs-string">b&#x27;flag&#x27;</span>))[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">32</span>)<br><span class="hljs-built_in">sum</span> = getsum(<span class="hljs-built_in">format</span>,ciphertext[:<span class="hljs-number">32</span>])<br><br>fb = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(ciphertext), <span class="hljs-number">32</span>):<br>    t = solve(<span class="hljs-built_in">sum</span>,[[<span class="hljs-built_in">int</span>(j)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> ciphertext[i:i + <span class="hljs-number">32</span>]])<br>    fb += <span class="hljs-string">&quot;&quot;</span>.join(<span class="hljs-built_in">str</span>(j) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> t)<br><br>flag = long_to_bytes(<span class="hljs-built_in">int</span>(fb,<span class="hljs-number">2</span>))<br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://www.wolai.com/nepnep/g2DTj6mRtBk2mikVuCyaE6">NepCTF 2022 (wolai.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Dual_EC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022 DSCTF</title>
    <link href="/2022/07/19/2022-dsctf/"/>
    <url>/2022/07/19/2022-dsctf/</url>
    
    <content type="html"><![CDATA[<h1 id="picproblem"><a href="#picproblem" class="headerlink" title="picproblem"></a>picproblem</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> numpy <span class="hljs-keyword">import</span> array, zeros, uint8<br><span class="hljs-keyword">import</span> gmpy2 <span class="hljs-keyword">as</span> gp<br><span class="hljs-keyword">import</span> cv2<br><span class="hljs-keyword">from</span> key <span class="hljs-keyword">import</span> x,y,kn,hint<br>image = cv2.imread(<span class="hljs-string">&quot;flag.jpg&quot;</span>)<br>img_gray = cv2.cvtColor(image,cv2.COLOR_RGB2GRAY)<br>imagearray = array(img_gray)<br>h = <span class="hljs-built_in">len</span>(imagearray)<br>w = <span class="hljs-built_in">len</span>(imagearray[<span class="hljs-number">0</span>])<br><br><span class="hljs-keyword">assert</span> <span class="hljs-number">1301149798051259562945444365741194129602596348352064372203373</span>*<span class="hljs-built_in">pow</span>(x, <span class="hljs-number">2</span>) == <span class="hljs-number">1175915431138623881271508290982969935822476052419526528443170552123</span>*<span class="hljs-built_in">pow</span>(y, <span class="hljs-number">2</span>) + <span class="hljs-number">1301149798051259562945444365741194129602596348352064372203373</span><br>x1 = <span class="hljs-built_in">round</span>(x/y*<span class="hljs-number">0.001</span>, <span class="hljs-number">16</span>)<br>u1 = y*<span class="hljs-number">3650</span>/x<br>x2 = <span class="hljs-built_in">round</span>(x/y*<span class="hljs-number">0.00101</span>, <span class="hljs-number">16</span>)<br>u2 = y*<span class="hljs-number">3675</span>/x<br>x3 = <span class="hljs-built_in">round</span>(x/y*<span class="hljs-number">0.00102</span>, <span class="hljs-number">16</span>)<br>u3 = y*<span class="hljs-number">3680</span>/x<br>kt = [x1, x2, x3]<br><br>temp_image = zeros(shape=[h, w, <span class="hljs-number">3</span>], dtype=uint8)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(temp_image))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(temp_image[<span class="hljs-number">0</span>]))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(temp_image[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]))<br><span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, kn):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, h):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, w):<br>            x1 = u1 * x1 * (<span class="hljs-number">1</span> - x1)<br>            x2 = u2 * x2 * (<span class="hljs-number">1</span> - x2)<br>            x3 = u3 * x3 * (<span class="hljs-number">1</span> - x3)<br>            r1 = <span class="hljs-built_in">int</span>(x1*<span class="hljs-number">255</span>)<br>            r2 = <span class="hljs-built_in">int</span>(x2*<span class="hljs-number">255</span>)<br>            r3 = <span class="hljs-built_in">int</span>(x3*<span class="hljs-number">255</span>)<br>            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>):<br>                temp_image[i][j][t] = (((r1+r2) ^ r3)+imagearray[i][j][t]) % <span class="hljs-number">256</span><br>    x1 = kt[<span class="hljs-number">0</span>]<br>    x2 = kt[<span class="hljs-number">1</span>]<br>    x3 = kt[<span class="hljs-number">2</span>]<br><br>encflagarray = Image.fromarray(temp_image)<br>encflagarray.show()<br>encflagarray.save(<span class="hljs-string">&quot;encflag.jpg&quot;</span>)<br><span class="hljs-comment">#************************************hint**************************************</span><br>m = hint<br>p = getPrime(<span class="hljs-number">512</span>)<br>q = getPrime(<span class="hljs-number">512</span>)<br>n = p * q<br>e = <span class="hljs-number">65537</span><br>phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>dp = gp.invert(e, p-<span class="hljs-number">1</span>)<br>c = <span class="hljs-built_in">pow</span>(m, e, n)<br><span class="hljs-comment">#n =  85413323752199019806030766630760449394238054889872415531186815348349883843039718091361611175963675771467536496812507338620957273406076058263122453235926619595761737396698699834116678598534261542535530241537247151318756003375573850725841254167462648747492270335084402716816450008370008491069875351593380154253</span><br><span class="hljs-comment">#dp =  1576424214336939000475035870826282526256046059505538052583882122452307602095912733650442447289122473348318614749578285418144935611098423641334952097553125</span><br><span class="hljs-comment">#c =  53653254613997095145108444611576166902006080900281661447007750088487109015427510365774527924664116641019490904245926171500894236952984157500461367769566121581870986304353174732328118576440353500038670030097108081972287049673200783198844842527470746431369314585103203118824985764754487936404004696485346196488</span><br><br></code></pre></td></tr></table></figure><p>hintéƒ¨åˆ†æ±‚è§£ç®€å•ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> libnum<br>e = <span class="hljs-number">65537</span><br>n =  <span class="hljs-number">85413323752199019806030766630760449394238054889872415531186815348349883843039718091361611175963675771467536496812507338620957273406076058263122453235926619595761737396698699834116678598534261542535530241537247151318756003375573850725841254167462648747492270335084402716816450008370008491069875351593380154253</span><br>dp =  <span class="hljs-number">1576424214336939000475035870826282526256046059505538052583882122452307602095912733650442447289122473348318614749578285418144935611098423641334952097553125</span><br>c =  <span class="hljs-number">53653254613997095145108444611576166902006080900281661447007750088487109015427510365774527924664116641019490904245926171500894236952984157500461367769566121581870986304353174732328118576440353500038670030097108081972287049673200783198844842527470746431369314585103203118824985764754487936404004696485346196488</span><br>pd = e*dp-<span class="hljs-number">1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ext_euclid</span>(<span class="hljs-params">a, b</span>):<br>    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, a<br>    <span class="hljs-keyword">else</span>:<br>        x, y, q = ext_euclid(b, a % b)<br>        x, y = y, (x - (a // b) * y)<br>        <span class="hljs-keyword">return</span> x, y, q<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mod_inv</span>(<span class="hljs-params">a, b</span>):<br>    <span class="hljs-keyword">return</span> ext_euclid(a, b)[<span class="hljs-number">0</span>] % b   <span class="hljs-comment">#å‡½æ•°è¿”å›çš„ç¬¬ä¸€ä¸ªæ•°%b</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,e):<br>    <span class="hljs-keyword">if</span> pd % i == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">if</span> n % (pd//i+<span class="hljs-number">1</span>) == <span class="hljs-number">0</span>:<br>            p = pd//i+<span class="hljs-number">1</span><br>            q = n//p<br>            fn = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>            d = mod_inv(e,fn)<br>            m = <span class="hljs-built_in">pow</span>(c,d,n)<br>            <span class="hljs-built_in">print</span>(libnum.n2s(m))<br><span class="hljs-comment">#b&#x27;*********** kn = 8 **************&#x27;</span><br></code></pre></td></tr></table></figure><p>æ‰¾åˆ°ç›¸å…³æ–‡ç« ï¼š<a href="https://icode.best/i/74795139605126">Logisticæ˜ å°„åœ¨å›¾åƒåŠ å¯†ä¸­çš„åº”ç”¨-çˆ±ä»£ç çˆ±ç¼–ç¨‹ (icode.best)</a></p><p>ä½†å·®è§£x,yçš„æ–¹ç¨‹ã€‚xï¼Œyçš„æ–¹ç¨‹åŒ–ç®€å¦‚ä¸‹ï¼š<br>$$<br>x^2 &#x3D; 903751*y^2 + 1<br>$$<br>æŸ¥é˜…å‘ç°æ˜¯<a href="https://oi-wiki.org/math/number-theory/pell-equation/">Pell æ–¹ç¨‹ (oi-wiki.org)</a>ï¼Œåˆ©ç”¨è¿åˆ†æ•°å¯¹å…¶æ±‚è§£ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Pell</span>(<span class="hljs-params">D</span>):<br>    temp = continued_fraction(sqrt(D))<br>    i=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        i+=<span class="hljs-number">1</span><br>        denom = temp.denominator(i)<br>        num = temp.numerator(i)<br>        <span class="hljs-keyword">if</span> num^<span class="hljs-number">2</span> - D*denom^<span class="hljs-number">2</span> == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> num,denom<br><br>Pell(<span class="hljs-number">903751</span>)<br><span class="hljs-comment">#(1524993807674193841904821512553946379967374698278296055158206699585083472817489721493862711615915407326315660670541801753616900039772802728925226091475860689682871555641241500183892397513037971186709123629077584204226084524811673794984687840178772052545441242927492902583547355565525538664836516589721942980577095421561886873928634330640979800040574060218872787212426630202508118484269553983399179155489583316400107655564222453437462724749097265122300644936717434151331633092585140183510349369422527440264746843972834927860065578557836150798690530172694679514231722613822246810010130005324032492360889531553803832398604563088256410481865243771216990603166993198935358471831328395618477974126824762560872337594997394218234427050399655270848385995088586420526886397320949350980406936200217112040971433660322179072288438842964957568719036794320203116263329623589339367497303140938070334557345834226085189140858264388063745189833584962825509843279678826240558480527560, 1604145232044543633656616254647708451166351104281510395737885491696385806407267633308545985473789119651681711082023113933085624628557168423578747544761597312012713558891523798820667618256495398479378172124019360339427592449217208805888502769358288779859969965560832505104388955091637704481336716722418336373334467787371085728212260231330510705797124224353810509272250940285165605853594811893804251478850270703294638335268305881655491870226553141286503109543313414279220480589704210363277523457948607498351377843904335637032510420141505975997452077477296326035048463179997347136990808017374750824810458605412236391952910679246288287664717533857743462935708681309073915761377477454479206054016260422865457862565353002789887917196437750618212918420129464330488021272187952177063175896447842395209693304502304253471733746765257510395226972224876277717457205220726240042035259947453816668460757995771018155703600926745905595162857982860955545877343914746294034180707)</span><br></code></pre></td></tr></table></figure><p>æœ€åè§£å¯†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> cv2<br><span class="hljs-keyword">from</span> numpy <span class="hljs-keyword">import</span> array, zeros, uint8<br><br>image = cv2.imread(<span class="hljs-string">&quot;encflag.jpg&quot;</span>)<br>imagearray = array(image)<br><span class="hljs-built_in">print</span>(imagearray.shape)<br>h = <span class="hljs-built_in">len</span>(imagearray)<span class="hljs-comment">#35</span><br>w = <span class="hljs-built_in">len</span>(imagearray[<span class="hljs-number">0</span>])<span class="hljs-comment">#261</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">img,key</span>):<br>    <span class="hljs-comment"># æ··æ²Œç³»ç»Ÿåˆå§‹æ¡ä»¶</span><br>    x1 = key[<span class="hljs-number">0</span>]<br>    x2 = key[<span class="hljs-number">1</span>]<br>    x3 = key[<span class="hljs-number">2</span>]<br>    <span class="hljs-comment"># åˆ†å²”å‚æ•°u</span><br>    u1 = key[<span class="hljs-number">3</span>]<br>    u2 = key[<span class="hljs-number">4</span>]<br>    u3 = key[<span class="hljs-number">5</span>]<br>    <span class="hljs-comment"># åŠ å¯†æ¬¡æ•°</span><br>    n = key[<span class="hljs-number">6</span>]<br>    <span class="hljs-comment"># ä¸€ä¸ªä¸´æ—¶æ•°ç»„ç”¨äºè¿”å›åŠ å¯†åçš„å›¾åƒï¼Œå¯ä»¥ä¸å½±å“ä¼ å…¥çš„åŠ å¯†å›¾åƒ</span><br>    img_tmp = zeros(shape=[h, w, <span class="hljs-number">3</span>], dtype=uint8)<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, n):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, h):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, w):<br>                x1 = u1 * x1 * (<span class="hljs-number">1</span> - x1)<br>                x2 = u2 * x2 * (<span class="hljs-number">1</span> - x2)<br>                x3 = u3 * x3 * (<span class="hljs-number">1</span> - x3)<br>                r1 = <span class="hljs-built_in">int</span>(x1 * <span class="hljs-number">255</span>)<br>                r2 = <span class="hljs-built_in">int</span>(x2 * <span class="hljs-number">255</span>)<br>                r3 = <span class="hljs-built_in">int</span>(x3 * <span class="hljs-number">255</span>)<br>                <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>):<br>                    img_tmp[i][j][t] = (img[i][j][t] - ((r1 + r2) ^ r3)) % <span class="hljs-number">256</span><br>        x1 = key[<span class="hljs-number">0</span>]<br>        x2 = key[<span class="hljs-number">1</span>]<br>        x3 = key[<span class="hljs-number">2</span>]<br>    <span class="hljs-keyword">return</span> img_tmp<br><br><br>x, y = (<span class="hljs-number">1524993807674193841904821512553946379967374698278296055158206699585083472817489721493862711615915407326315660670541801753616900039772802728925226091475860689682871555641241500183892397513037971186709123629077584204226084524811673794984687840178772052545441242927492902583547355565525538664836516589721942980577095421561886873928634330640979800040574060218872787212426630202508118484269553983399179155489583316400107655564222453437462724749097265122300644936717434151331633092585140183510349369422527440264746843972834927860065578557836150798690530172694679514231722613822246810010130005324032492360889531553803832398604563088256410481865243771216990603166993198935358471831328395618477974126824762560872337594997394218234427050399655270848385995088586420526886397320949350980406936200217112040971433660322179072288438842964957568719036794320203116263329623589339367497303140938070334557345834226085189140858264388063745189833584962825509843279678826240558480527560</span>, <span class="hljs-number">1604145232044543633656616254647708451166351104281510395737885491696385806407267633308545985473789119651681711082023113933085624628557168423578747544761597312012713558891523798820667618256495398479378172124019360339427592449217208805888502769358288779859969965560832505104388955091637704481336716722418336373334467787371085728212260231330510705797124224353810509272250940285165605853594811893804251478850270703294638335268305881655491870226553141286503109543313414279220480589704210363277523457948607498351377843904335637032510420141505975997452077477296326035048463179997347136990808017374750824810458605412236391952910679246288287664717533857743462935708681309073915761377477454479206054016260422865457862565353002789887917196437750618212918420129464330488021272187952177063175896447842395209693304502304253471733746765257510395226972224876277717457205220726240042035259947453816668460757995771018155703600926745905595162857982860955545877343914746294034180707</span>)<br><span class="hljs-keyword">assert</span> <span class="hljs-number">1301149798051259562945444365741194129602596348352064372203373</span>*<span class="hljs-built_in">pow</span>(x, <span class="hljs-number">2</span>) == <span class="hljs-number">1175915431138623881271508290982969935822476052419526528443170552123</span>*<span class="hljs-built_in">pow</span>(y, <span class="hljs-number">2</span>) + <span class="hljs-number">1301149798051259562945444365741194129602596348352064372203373</span><br>x1 = <span class="hljs-built_in">round</span>(x/y*<span class="hljs-number">0.001</span>, <span class="hljs-number">16</span>)<br>u1 = y*<span class="hljs-number">3650</span>/x<br>x2 = <span class="hljs-built_in">round</span>(x/y*<span class="hljs-number">0.00101</span>, <span class="hljs-number">16</span>)<br>u2 = y*<span class="hljs-number">3675</span>/x<br>x3 = <span class="hljs-built_in">round</span>(x/y*<span class="hljs-number">0.00102</span>, <span class="hljs-number">16</span>)<br>u3 = y*<span class="hljs-number">3680</span>/x<br>kn = <span class="hljs-number">8</span><br>kt = [x1, x2, x3, u1, u2, u3, kn]<br><span class="hljs-built_in">print</span>(kt)<br>temp_image = decrypt(imagearray, kt)<br>flagarray = Image.fromarray(temp_image)<br>flagarray.show()<br>flagarray.save(<span class="hljs-string">&quot;flag.jpg&quot;</span>)<br></code></pre></td></tr></table></figure><h1 id="RSA330"><a href="#RSA330" class="headerlink" title="RSA330"></a>RSA330</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">alarm(<span class="hljs-number">10</span>)<br>PoWp = random_prime(<span class="hljs-number">2</span>^<span class="hljs-number">100</span>)<br>PoWq = random_prime(<span class="hljs-number">2</span>^<span class="hljs-number">100</span>)<br>PoW = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">f&quot;Factor <span class="hljs-subst">&#123;PoWp*PoWq&#125;</span>:\n&quot;</span>))<br><span class="hljs-keyword">assert</span> PoW == PoWp + PoWq<br><br>alarm(<span class="hljs-number">60</span>)<br>se = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;plz select the size of e: &quot;</span>))<br><span class="hljs-keyword">assert</span> se &gt; <span class="hljs-number">16</span> <span class="hljs-keyword">and</span> se &lt; <span class="hljs-number">1024</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p = random_prime(<span class="hljs-number">2</span>^<span class="hljs-number">512</span>)<br>    q = random_prime(<span class="hljs-number">2</span>^<span class="hljs-number">512</span>)<br>    e = ZZ.random_element(<span class="hljs-number">2</span>^(se-<span class="hljs-number">1</span>),<span class="hljs-number">2</span>^se)<br>    <span class="hljs-keyword">if</span> gcd(e, (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)) == <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">break</span><br>        <br><span class="hljs-built_in">print</span>(e, e.inverse_mod(p-<span class="hljs-number">1</span>)&gt;&gt;<span class="hljs-number">330</span>, e.inverse_mod(q-<span class="hljs-number">1</span>)&gt;&gt;<span class="hljs-number">330</span>)<br>pq = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">f&quot;RSA330 - <span class="hljs-subst">&#123;p*q&#125;</span>:\n&quot;</span>))<br><span class="hljs-keyword">assert</span> pq == p + q<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag.txt&quot;</span>).read())<br></code></pre></td></tr></table></figure><p>sageä¸­æœ‰å¤§æ•°åˆ†è§£çš„å‡½æ•°ï¼Œç‰›å“‡ï¼</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">qsieve</span>(<span class="hljs-number">184378666276085226424026508072440771590659834511908100578309</span>)#<br><span class="hljs-built_in">factor</span>(<span class="hljs-number">184378666276085226424026508072440771590659834511908100578309</span>)#æ‰€æœ‰ç´ æ•°<br><span class="hljs-built_in">divisors</span>(<span class="hljs-number">184378666276085226424026508072440771590659834511908100578309</span>)#æ‰€æœ‰å› æ•°<br></code></pre></td></tr></table></figure><p>å‚è€ƒè®ºæ–‡ï¼š[Approximate Divisor Multiples](<a href="https://eprint.iacr.org/2022/271.pdf">271.pdf (iacr.org)</a>)</p><p>æ ¹æ®è®ºæ–‡ï¼Œé€‰å–$e&gt;N^{\dfrac{1}{12}}$ï¼Œå³$e.bit_length()&gt;85.333$ã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031020776.png"/><p>æ„é€ ä¸Šè¿°<code>A</code>å¯ä»¥å¾—åˆ°<code>k*l</code>ï¼Œç„¶åå¯¹ç­‰å¼(5)å¯¹<code>e</code>å–ä½™å¾—åˆ°ï¼š<br>$$<br>k+l &#x3D; 1-kl(N-1)\quad mod\ e<br>$$<br>å¾—åˆ°<code>k+l</code>ï¼Œè§£æ–¹ç¨‹ $(x-k)(x-l)&#x3D;0$ å¯ä»¥æ±‚å‡º<code>k,l</code>ã€‚</p><p>åˆ©ç”¨<code>Howgrave-Graham</code>å®šç†ï¼Œæ„å»ºå¦‚ä¸‹æ ¼ï¼š</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031020366.png"/><p>å…¶ä¸­æ¯è¡Œä¸º $g_i(x) :&#x3D; f^i(x)k^{m-i}N^{max(0,t-i)}$ ï¼Œ$f(x):&#x3D;x+a$ï¼Œ$f(x)$çš„æ„é€ è¿‡ç¨‹å¦‚ä¸‹</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031021553.png"/><p>ä¹Ÿå°±æ˜¯å°† åŸŸä¸º<code>kp</code>ä¸Šçš„å¾…è§£æ–¹ç¨‹$f &#x3D; e(dp^{(M)}*2^{330}+x)+k-1$ ï¼ˆå…¶ä¸­ $x &#x3D; dp^{(L)}$ ï¼‰çš„æœªçŸ¥æ•°çš„ç³»æ•°åŒ–ä¸º1ï¼ˆf.monic()ï¼‰å°±å¾—åˆ°äº†ã€‚</p><p>ç”¨å¾…æ±‚å¾—èŒƒå›´($2^{330}$)å…ˆä»£æ›¿$x$è¿›è¡ŒLLL()ï¼Œå†æ›¿æ¢å›æ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">C</span>(<span class="hljs-params">a,b</span>):<br>    ret = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(b):<br>        ret*=(a-i)<br>        ret/=(b-i)<br>    <span class="hljs-keyword">return</span> ret<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dec</span>(<span class="hljs-params">e,dp,k,n</span>):<br>    m,t=<span class="hljs-number">20</span>,<span class="hljs-number">10</span><br>    P = Zmod(k*n)[<span class="hljs-string">&#x27;x&#x27;</span>]<br>    x = P.gen()<br>    f = e*(dp+x) - <span class="hljs-number">1</span> + k<br>    f = f.monic()<br>    f = f.change_ring(ZZ)<br>    a = <span class="hljs-built_in">list</span>(f)[<span class="hljs-number">0</span>]<span class="hljs-comment">#å¸¸æ•°a</span><br>    L=matrix(ZZ,m+<span class="hljs-number">1</span>,m+<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m+<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i+<span class="hljs-number">1</span>):<br>            L[i,j] = k^(m-i)*n^<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>,t-i)*C(i,j)*<span class="hljs-built_in">pow</span>(a,i-j)*<span class="hljs-built_in">pow</span>((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">330</span>),j)<br>    L = L.LLL()<br>    P = ZZ[<span class="hljs-string">&#x27;y&#x27;</span>]<br>    y = P.gen()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m+<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m+<span class="hljs-number">1</span>):<br>            L[i,j]=L[i,j]//<span class="hljs-built_in">pow</span>(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">330</span>,j)<span class="hljs-comment">#çŸ©é˜µå¹¶ä¸èƒ½ç›´æ¥ä¹˜pow(y,j)ï¼Œä½†å–å…¶è¡Œï¼Œå¯¹å…¶ä¸­æ¯ä¸€åˆ—å¯ä»¥æ“ä½œ</span><br>    <br>    L = L*vector([y^i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m+<span class="hljs-number">1</span>)])<span class="hljs-comment">#å¯¹åº”å¤šä¸ªå¤šé¡¹å¼æ–¹ç¨‹</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> L:<br>        r = i.roots()<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(r) &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-comment">#print(r)</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(r[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]+dp)<br><br>e = <span class="hljs-number">715817461603291345056500257</span> <br>dpm = <span class="hljs-number">443241367152182375089742080168879750401826010196673998</span> <br>dqm = <span class="hljs-number">976237271910199872999512149615932692866377555493664771</span><br>n = <span class="hljs-number">27691523316352200817507757939445581338449495137376447632107748594499386764483747774332325018477605530261133431823935050480971625479504155045304870831284969481372795315373409317596161046086158910790777312868535076795758303488626394277433645375132000508031171867198231228726163618498261234493051930360826747417</span><br>kbits = <span class="hljs-number">330</span><br>A = (<span class="hljs-number">2</span>^(<span class="hljs-number">2</span>*kbits)*e^<span class="hljs-number">2</span>*dpm*dqm)//n + <span class="hljs-number">1</span><br>b = (<span class="hljs-number">1</span> - A*(n-<span class="hljs-number">1</span>))%e<br>delta = b^<span class="hljs-number">2</span> - <span class="hljs-number">4</span>*A<br><span class="hljs-keyword">if</span> delta &gt; <span class="hljs-number">0</span>:<br>    <span class="hljs-keyword">assert</span> sqrt(delta)^<span class="hljs-number">2</span> == delta<br>    k = (b+sqrt(delta))//<span class="hljs-number">2</span><br>    l = (b-sqrt(delta))//<span class="hljs-number">2</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;k = <span class="hljs-subst">&#123;k&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;l = <span class="hljs-subst">&#123;l&#125;</span>&#x27;</span>)<br><br>result = [dec(e,dpm&lt;&lt;kbits,k,n),dec(e,dqm&lt;&lt;kbits,l,n),dec(e,dpm&lt;&lt;kbits,l,n),dec(e,dqm&lt;&lt;kbits,k,n)]<br><span class="hljs-built_in">print</span>(result)<br>dp = result[<span class="hljs-number">2</span>]<br>dq = result[<span class="hljs-number">3</span>]<br>p = (e*dp-<span class="hljs-number">1</span>)//l+<span class="hljs-number">1</span><br>q = (e*dq-<span class="hljs-number">1</span>)//k+<span class="hljs-number">1</span><br><span class="hljs-keyword">assert</span> n == p*q<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;p = <span class="hljs-subst">&#123;p&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;q = <span class="hljs-subst">&#123;q&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://icode.best/i/74795139605126">Logisticæ˜ å°„åœ¨å›¾åƒåŠ å¯†ä¸­çš„åº”ç”¨-çˆ±ä»£ç çˆ±ç¼–ç¨‹ (icode.best)</a></p><p><a href="https://oi-wiki.org/math/number-theory/pell-equation/">Pell æ–¹ç¨‹ (oi-wiki.org)</a></p><p>[Approximate Divisor Multiples](<a href="https://eprint.iacr.org/2022/271.pdf">271.pdf (iacr.org)</a>)</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIzMTQ4NzE2Ng==&mid=2247492424&idx=1&sn=c1fc72dc278300d0e3935a781bb334e5&chksm=e8a1c099dfd6498f46cdd747027c56d620e728d73b260683c6ed9705eb7d3ab54e7597b38dcc&mpshare=1&scene=23&srcid=0716WzO8bts7RjWc7ooGARI4&sharer_sharetime=1657983613471&sharer_shareid=122e5be9c4961e59957c3603ed41e762#rd">2022DSCTF-wp (qq.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Pell</tag>
      
      <tag>RSA</tag>
      
      <tag>LLL</tag>
      
      <tag>Logistic</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022DASCTF MAY å‡ºé¢˜äººæŒ‘æˆ˜èµ›</title>
    <link href="/2022/07/13/2022DASCTF%20MAY%20%E5%87%BA%E9%A2%98%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9B/"/>
    <url>/2022/07/13/2022DASCTF%20MAY%20%E5%87%BA%E9%A2%98%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="Yusaçš„å¯†ç å­¦è¯¾å ‚â€”â€”ä¸€è§å¦‚æ•…"><a href="#Yusaçš„å¯†ç å­¦è¯¾å ‚â€”â€”ä¸€è§å¦‚æ•…" class="headerlink" title="Yusaçš„å¯†ç å­¦è¯¾å ‚â€”â€”ä¸€è§å¦‚æ•…"></a>Yusaçš„å¯†ç å­¦è¯¾å ‚â€”â€”ä¸€è§å¦‚æ•…</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Myrand</span>():<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,seed</span>):<br>self.index = <span class="hljs-number">0</span><br>self.isInit = <span class="hljs-number">1</span><br>self.MT = [seed] + [<span class="hljs-number">0</span>] * <span class="hljs-number">623</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">624</span>):<br>t = <span class="hljs-number">1314433253</span> * (self.MT[i-<span class="hljs-number">1</span>] ^ (self.MT[i-<span class="hljs-number">1</span>] &gt;&gt; <span class="hljs-number">30</span>)) + <span class="hljs-number">1</span><br>self.MT[i] = t &amp; <span class="hljs-number">0xffffffff</span><span class="hljs-comment">#32bit</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">self</span>):<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">624</span>):<br>y = (self.MT[i] &amp; <span class="hljs-number">0x80000000</span>) + (self.MT[(i+<span class="hljs-number">1</span>)%<span class="hljs-number">624</span>] &amp; <span class="hljs-number">0x7fffffff</span>)<br>self.MT[i] = self.MT[(i+<span class="hljs-number">397</span>)%<span class="hljs-number">624</span>] ^ (y &gt;&gt; <span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> y &amp; <span class="hljs-number">1</span>:<br>self.MT[i] ^= <span class="hljs-number">2567483520</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rand</span>(<span class="hljs-params">self</span>):<br><span class="hljs-keyword">if</span> self.index == <span class="hljs-number">0</span>:<br>self.generate()<br>y = self.MT[self.index]<br>y = y ^ self.cs2l(y, <span class="hljs-number">11</span>) ^ self.cs2l(y,<span class="hljs-number">15</span>)<br>y = y ^ self.cs2r(y,<span class="hljs-number">7</span>) ^ self.cs2r(y,<span class="hljs-number">19</span>)<br>self.index = (self.index + <span class="hljs-number">1</span>) % <span class="hljs-number">624</span><br><span class="hljs-keyword">return</span> y<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cs2l</span>(<span class="hljs-params">self, y, shift</span>):<br><span class="hljs-keyword">return</span> ((y &lt;&lt; shift) ^ (y &gt;&gt; (<span class="hljs-number">32</span> - shift))) &amp; <span class="hljs-number">0xffffffff</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cs2r</span>(<span class="hljs-params">self, y, shift</span>):<br><span class="hljs-keyword">return</span> ((y &gt;&gt; shift) ^ (y &lt;&lt; (<span class="hljs-number">32</span> - shift))) &amp; <span class="hljs-number">0xffffffff</span><br><br><span class="hljs-keyword">import</span> os<br>r = Myrand(<span class="hljs-built_in">int</span>(os.urandom(<span class="hljs-number">4</span>).<span class="hljs-built_in">hex</span>(),<span class="hljs-number">16</span>))<br>out = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">624</span>):<br>out.append(r.rand())<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;output.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f:<br>f.write(<span class="hljs-built_in">str</span>(out))<br><br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br>flag = <span class="hljs-string">&#x27;DASCTF&#123;&#x27;</span> + md5(<span class="hljs-built_in">str</span>(r.rand()).encode()).hexdigest() + <span class="hljs-string">&#x27;&#125;&#x27;</span><br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><p>ï¼ˆå°å£°é€¼é€¼ï¼šä¹‹å‰é‡åˆ°äº†ç±»ä¼¼çš„é¢˜ï¼Œä½†æ˜¯æ–‡ç« å› ä¸ªäººåŸå› ä¸¢å¤±äº†ï¼‰</p><p>ä¸éš¾å‘ç°ï¼Œå…³é”®ä¹‹å¤„åœ¨äºå¦‚ä½•ç ´è§£ <code>cs2l</code> å’Œ <code>cs2r</code> ï¼Œç ´è§£äº†å°±å¯ä»¥æ±‚å‡º <code>MT</code> åºåˆ—ï¼Œç„¶åæŒ‰é¢˜ç›®ä¸­ <code>flag</code> éƒ¨åˆ†çš„æ“ä½œå°±å¯ä»¥å¾—å‡º <code>flag</code> ã€‚</p><p>è§‚å¯Ÿ <code>cs2l</code> å’Œ <code>cs2r</code> ï¼Œå‘ç°å…¶åŠŸèƒ½æ˜¯å¾ªç¯ç§»ä½ã€‚è€Œä¸”ç‰¹å¾å¦‚ä¸‹ï¼š<br>$$<br>y &#x3D; x âŠ• (xâ‹˜p) âŠ•(xâ‹˜q)\tag 1<br>$$<br>ç½‘ä¸Šè§…å¾—ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/Tf1shC4T/p/15927062.html">å¾ªç¯ç§»ä½å¼‚æˆ–åŠ å¯† - Tf1shC4T - åšå®¢å›­ (cnblogs.com)</a></p><p>åœ¨é•¿åº¦ä¸º  $2^n$ çš„äºŒè¿›åˆ¶ä¸²ä¸­ï¼Œå¾ªç¯ç§»ä½å¼‚æˆ–å˜æ¢ä¸­ï¼Œå¦‚æœæœ‰å¥‡æ•°é¡¹ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜æ¢æ˜¯å¯é€†çš„ï¼Œå¦åˆ™å°±æ˜¯ä¸å¯é€†çš„ã€‚</p><p>åˆ†æä¸Šå¼ï¼Œä¸¤è¾¹åŒæ—¶ $â‹˜p$ å’Œ $â‹˜q$ ï¼Œå¾—<br>$$<br>yâ‹˜p &#x3D; (xâ‹˜p)âŠ•(xâ‹˜2p)âŠ•(xâ‹˜(p+q))\tag 2<br>$$</p><p>$$<br>yâ‹˜q &#x3D; (xâ‹˜q)âŠ•(xâ‹˜(p+q))âŠ•(xâ‹˜2q)\tag 3<br>$$</p><p>$(1)*(2)*(3)$ å¾—<br>$$<br>y_1 &#x3D; yâŠ•(yâ‹˜p) âŠ•(yâ‹˜q) &#x3D; xâŠ•(xâ‹˜2p) âŠ•(xâ‹˜2q)<br>$$<br>åŒç†<br>$$<br>y_2 &#x3D; y_1âŠ•(y_1â‹˜2p) âŠ•(y_1â‹˜2q) &#x3D; xâŠ•(xâ‹˜4p) âŠ•(xâ‹˜4q)<br>$$<br>$$<br>y_n &#x3D; y_{n-1}âŠ•(y_{n-1}â‹˜2^{n-1}p) âŠ•(y2â‹˜2^{n-1}q) &#x3D; xâŠ•(xâ‹˜2^np) âŠ•(xâ‹˜2^nq) &#x3D; x\quad (bitlen &#x3D; 2^n)<br>$$</p><p>å¦‚æ­¤å°±å¯ä»¥æ±‚å‡ºåŸæ¥å¾— <code>x</code> ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br><br>bitlen = <span class="hljs-number">32</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">y,k</span>):<span class="hljs-comment">#å¾ªç¯å·¦ç§»</span><br>    biny = <span class="hljs-built_in">bin</span>(y)[<span class="hljs-number">2</span>:].zfill(bitlen)<br>    k = k % bitlen<br>    biny = biny[k:] + biny[:k]<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(biny,<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">y,ks</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(bitlen):<br>        y = y ^ mov(y,ks[<span class="hljs-number">0</span>]) ^ mov(y,ks[<span class="hljs-number">1</span>])<br>        ks = [ k&lt;&lt;<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> ks]<br>    <span class="hljs-keyword">return</span> y<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Myrand</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,MT</span>):<br>        self.index = <span class="hljs-number">0</span><br>        self.isInit = <span class="hljs-number">1</span><br>        self.MT = MT<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">624</span>):<br>            y = (self.MT[i] &amp; <span class="hljs-number">0x80000000</span>) + (self.MT[(i+<span class="hljs-number">1</span>)%<span class="hljs-number">624</span>] &amp; <span class="hljs-number">0x7fffffff</span>)<br>            self.MT[i] = self.MT[(i+<span class="hljs-number">397</span>)%<span class="hljs-number">624</span>] ^ (y &gt;&gt; <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> y &amp; <span class="hljs-number">1</span>:<br>                self.MT[i] ^= <span class="hljs-number">2567483520</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">rand</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> self.index == <span class="hljs-number">0</span>:<br>            self.generate()<br>        y = self.MT[self.index]<br>        y = y ^ self.cs2l(y, <span class="hljs-number">11</span>) ^ self.cs2l(y,<span class="hljs-number">15</span>)<br>        y = y ^ self.cs2r(y,<span class="hljs-number">7</span>) ^ self.cs2r(y,<span class="hljs-number">19</span>)<br>        self.index = (self.index + <span class="hljs-number">1</span>) % <span class="hljs-number">624</span><br>        <span class="hljs-keyword">return</span> y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cs2l</span>(<span class="hljs-params">self, y, shift</span>):<br>        <span class="hljs-keyword">return</span> ((y &lt;&lt; shift) ^ (y &gt;&gt; (<span class="hljs-number">32</span> - shift))) &amp; <span class="hljs-number">0xffffffff</span><span class="hljs-comment">#å¾ªç¯ç§»ä½</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cs2r</span>(<span class="hljs-params">self, y, shift</span>):<br>        <span class="hljs-keyword">return</span> ((y &gt;&gt; shift) ^ (y &lt;&lt; (<span class="hljs-number">32</span> - shift))) &amp; <span class="hljs-number">0xffffffff</span><span class="hljs-comment">#å¾ªç¯ç§»ä½</span><br><br>out = [<span class="hljs-number">3417500333</span>, <span class="hljs-number">4091726338</span>, <span class="hljs-number">652603332</span>, <span class="hljs-number">4187304543</span>, <span class="hljs-number">4293795290</span>, <span class="hljs-number">1622245003</span>, <span class="hljs-number">3383443782</span>, <span class="hljs-number">2420250331</span>, <span class="hljs-number">322010852</span>, <span class="hljs-number">1604005753</span>, <span class="hljs-number">3137930218</span>, <span class="hljs-number">1074571824</span>, <span class="hljs-number">1566336258</span>, <span class="hljs-number">2754341076</span>, <span class="hljs-number">1059426660</span>, <span class="hljs-number">2461569360</span>, <span class="hljs-number">613134153</span>, <span class="hljs-number">860561774</span>, <span class="hljs-number">3003069274</span>, <span class="hljs-number">553387944</span>, <span class="hljs-number">1949778231</span>, <span class="hljs-number">249886857</span>, <span class="hljs-number">2322866121</span>, <span class="hljs-number">3685855175</span>, <span class="hljs-number">1977923546</span>, <span class="hljs-number">1887238269</span>, <span class="hljs-number">253812990</span>, <span class="hljs-number">2188417674</span>, <span class="hljs-number">2718707711</span>, <span class="hljs-number">1599975569</span>, <span class="hljs-number">3254935456</span>, <span class="hljs-number">3199641169</span>, <span class="hljs-number">362166522</span>, <span class="hljs-number">1378687155</span>, <span class="hljs-number">912036995</span>, <span class="hljs-number">3174049018</span>, <span class="hljs-number">780042016</span>, <span class="hljs-number">970421905</span>, <span class="hljs-number">3468971406</span>, <span class="hljs-number">801660807</span>, <span class="hljs-number">833926127</span>, <span class="hljs-number">473587885</span>, <span class="hljs-number">158979812</span>, <span class="hljs-number">405306558</span>, <span class="hljs-number">1363084996</span>, <span class="hljs-number">2023076543</span>, <span class="hljs-number">2069797730</span>, <span class="hljs-number">718155249</span>, <span class="hljs-number">1641186127</span>, <span class="hljs-number">3616747747</span>, <span class="hljs-number">1575693921</span>, <span class="hljs-number">3856591855</span>, <span class="hljs-number">223881884</span>, <span class="hljs-number">3002184567</span>, <span class="hljs-number">1666647440</span>, <span class="hljs-number">617661934</span>, <span class="hljs-number">2673101022</span>, <span class="hljs-number">885332395</span>, <span class="hljs-number">3391329168</span>, <span class="hljs-number">1640225363</span>, <span class="hljs-number">2565685644</span>, <span class="hljs-number">3892963352</span>, <span class="hljs-number">3034627488</span>, <span class="hljs-number">2415435183</span>, <span class="hljs-number">3648712566</span>, <span class="hljs-number">2140877952</span>, <span class="hljs-number">1303506086</span>, <span class="hljs-number">2455662362</span>, <span class="hljs-number">1720382700</span>, <span class="hljs-number">3970268445</span>, <span class="hljs-number">2579167586</span>, <span class="hljs-number">4117229324</span>, <span class="hljs-number">846645263</span>, <span class="hljs-number">3252991293</span>, <span class="hljs-number">79067029</span>, <span class="hljs-number">2756800392</span>, <span class="hljs-number">2212447526</span>, <span class="hljs-number">2203329967</span>, <span class="hljs-number">1270408703</span>, <span class="hljs-number">740176928</span>, <span class="hljs-number">3176125705</span>, <span class="hljs-number">166800854</span>, <span class="hljs-number">3327343902</span>, <span class="hljs-number">2079714725</span>, <span class="hljs-number">3702269956</span>, <span class="hljs-number">3659849279</span>, <span class="hljs-number">3658666909</span>, <span class="hljs-number">797535816</span>, <span class="hljs-number">600857570</span>, <span class="hljs-number">553836307</span>, <span class="hljs-number">2394740468</span>, <span class="hljs-number">1178393549</span>, <span class="hljs-number">2183765310</span>, <span class="hljs-number">4014432190</span>, <span class="hljs-number">652246726</span>, <span class="hljs-number">3693235932</span>, <span class="hljs-number">4046942361</span>, <span class="hljs-number">4105444828</span>, <span class="hljs-number">145386213</span>, <span class="hljs-number">1198390220</span>, <span class="hljs-number">3023119098</span>, <span class="hljs-number">663559283</span>, <span class="hljs-number">225958361</span>, <span class="hljs-number">3893000878</span>, <span class="hljs-number">1615631644</span>, <span class="hljs-number">1941951859</span>, <span class="hljs-number">471085675</span>, <span class="hljs-number">2164362049</span>, <span class="hljs-number">4274234562</span>, <span class="hljs-number">4127314557</span>, <span class="hljs-number">1833529303</span>, <span class="hljs-number">17668093</span>, <span class="hljs-number">3208743142</span>, <span class="hljs-number">3210135945</span>, <span class="hljs-number">1772990736</span>, <span class="hljs-number">3290157875</span>, <span class="hljs-number">3006334453</span>, <span class="hljs-number">3831748800</span>, <span class="hljs-number">1120411838</span>, <span class="hljs-number">690279329</span>, <span class="hljs-number">2436940844</span>, <span class="hljs-number">1440602808</span>, <span class="hljs-number">1552272917</span>, <span class="hljs-number">1321728089</span>, <span class="hljs-number">524486126</span>, <span class="hljs-number">3696307959</span>, <span class="hljs-number">1189129368</span>, <span class="hljs-number">28736041</span>, <span class="hljs-number">3143264315</span>, <span class="hljs-number">3050323849</span>, <span class="hljs-number">1458456612</span>, <span class="hljs-number">389869312</span>, <span class="hljs-number">2360130428</span>, <span class="hljs-number">854837117</span>, <span class="hljs-number">1270423403</span>, <span class="hljs-number">3471650414</span>, <span class="hljs-number">243573262</span>, <span class="hljs-number">3449929772</span>, <span class="hljs-number">2436299611</span>, <span class="hljs-number">420972940</span>, <span class="hljs-number">923873821</span>, <span class="hljs-number">3499748829</span>, <span class="hljs-number">2470333529</span>, <span class="hljs-number">3901870125</span>, <span class="hljs-number">3589884387</span>, <span class="hljs-number">3339475693</span>, <span class="hljs-number">1526947412</span>, <span class="hljs-number">1747516667</span>, <span class="hljs-number">2971536797</span>, <span class="hljs-number">273910310</span>, <span class="hljs-number">2185887289</span>, <span class="hljs-number">2723697010</span>, <span class="hljs-number">1973585459</span>, <span class="hljs-number">1166325256</span>, <span class="hljs-number">1360822059</span>, <span class="hljs-number">416514510</span>, <span class="hljs-number">4038763765</span>, <span class="hljs-number">1816380840</span>, <span class="hljs-number">940152644</span>, <span class="hljs-number">3918708431</span>, <span class="hljs-number">3410593321</span>, <span class="hljs-number">3358844522</span>, <span class="hljs-number">3678637784</span>, <span class="hljs-number">2412834780</span>, <span class="hljs-number">3052967117</span>, <span class="hljs-number">3672611162</span>, <span class="hljs-number">570069042</span>, <span class="hljs-number">95771608</span>, <span class="hljs-number">1210821251</span>, <span class="hljs-number">2163778365</span>, <span class="hljs-number">2739972546</span>, <span class="hljs-number">3094346015</span>, <span class="hljs-number">749719666</span>, <span class="hljs-number">1697477587</span>, <span class="hljs-number">986142486</span>, <span class="hljs-number">2591897292</span>, <span class="hljs-number">1234948693</span>, <span class="hljs-number">3659791160</span>, <span class="hljs-number">3990257960</span>, <span class="hljs-number">501199958</span>, <span class="hljs-number">3029961497</span>, <span class="hljs-number">578415668</span>, <span class="hljs-number">124517322</span>, <span class="hljs-number">1985205894</span>, <span class="hljs-number">3777347400</span>, <span class="hljs-number">1149995545</span>, <span class="hljs-number">290699775</span>, <span class="hljs-number">3399696193</span>, <span class="hljs-number">1062094395</span>, <span class="hljs-number">2896523484</span>, <span class="hljs-number">1562688856</span>, <span class="hljs-number">992098141</span>, <span class="hljs-number">3941170280</span>, <span class="hljs-number">262596967</span>, <span class="hljs-number">2585751001</span>, <span class="hljs-number">3682611205</span>, <span class="hljs-number">530523926</span>, <span class="hljs-number">1202322766</span>, <span class="hljs-number">3777439514</span>, <span class="hljs-number">3051700271</span>, <span class="hljs-number">261632458</span>, <span class="hljs-number">2736123960</span>, <span class="hljs-number">2786338595</span>, <span class="hljs-number">86310784</span>, <span class="hljs-number">2760191516</span>, <span class="hljs-number">1344514731</span>, <span class="hljs-number">350767781</span>, <span class="hljs-number">2858876127</span>, <span class="hljs-number">519088864</span>, <span class="hljs-number">3193340756</span>, <span class="hljs-number">3563489312</span>, <span class="hljs-number">3239917298</span>, <span class="hljs-number">161418824</span>, <span class="hljs-number">470724403</span>, <span class="hljs-number">3310407387</span>, <span class="hljs-number">1743713887</span>, <span class="hljs-number">3064036770</span>, <span class="hljs-number">1175434157</span>, <span class="hljs-number">3029464330</span>, <span class="hljs-number">116086349</span>, <span class="hljs-number">1652489862</span>, <span class="hljs-number">1176236897</span>, <span class="hljs-number">4139800383</span>, <span class="hljs-number">3758499033</span>, <span class="hljs-number">2961626313</span>, <span class="hljs-number">3064683859</span>, <span class="hljs-number">958478146</span>, <span class="hljs-number">596650527</span>, <span class="hljs-number">1000277312</span>, <span class="hljs-number">4102368994</span>, <span class="hljs-number">1480011430</span>, <span class="hljs-number">4001401502</span>, <span class="hljs-number">4004287177</span>, <span class="hljs-number">3202905309</span>, <span class="hljs-number">1754655955</span>, <span class="hljs-number">2064262245</span>, <span class="hljs-number">1840530874</span>, <span class="hljs-number">2284428117</span>, <span class="hljs-number">2281854453</span>, <span class="hljs-number">1023839768</span>, <span class="hljs-number">2166517711</span>, <span class="hljs-number">2709857675</span>, <span class="hljs-number">2005014414</span>, <span class="hljs-number">4161461001</span>, <span class="hljs-number">2932436148</span>, <span class="hljs-number">2411599350</span>, <span class="hljs-number">4267437788</span>, <span class="hljs-number">2132764972</span>, <span class="hljs-number">150665266</span>, <span class="hljs-number">286170947</span>, <span class="hljs-number">2249288787</span>, <span class="hljs-number">3953585886</span>, <span class="hljs-number">1231725143</span>, <span class="hljs-number">2479045931</span>, <span class="hljs-number">2377059462</span>, <span class="hljs-number">281316188</span>, <span class="hljs-number">379113422</span>, <span class="hljs-number">920019004</span>, <span class="hljs-number">163289886</span>, <span class="hljs-number">2210874762</span>, <span class="hljs-number">1578529538</span>, <span class="hljs-number">309521495</span>, <span class="hljs-number">3737017316</span>, <span class="hljs-number">88919917</span>, <span class="hljs-number">559742618</span>, <span class="hljs-number">978230553</span>, <span class="hljs-number">2154491496</span>, <span class="hljs-number">994913727</span>, <span class="hljs-number">498894258</span>, <span class="hljs-number">1355546448</span>, <span class="hljs-number">4023836881</span>, <span class="hljs-number">3014313787</span>, <span class="hljs-number">164044564</span>, <span class="hljs-number">2408825840</span>, <span class="hljs-number">2029992558</span>, <span class="hljs-number">3707778216</span>, <span class="hljs-number">86206872</span>, <span class="hljs-number">3576935874</span>, <span class="hljs-number">185356787</span>, <span class="hljs-number">1774175910</span>, <span class="hljs-number">3145237900</span>, <span class="hljs-number">3497547609</span>, <span class="hljs-number">841914878</span>, <span class="hljs-number">3425254534</span>, <span class="hljs-number">4264030778</span>, <span class="hljs-number">2348022032</span>, <span class="hljs-number">178331591</span>, <span class="hljs-number">943923822</span>, <span class="hljs-number">3384367749</span>, <span class="hljs-number">2806712599</span>, <span class="hljs-number">1178535099</span>, <span class="hljs-number">1251085540</span>, <span class="hljs-number">2410015803</span>, <span class="hljs-number">1480595408</span>, <span class="hljs-number">2732607876</span>, <span class="hljs-number">1579706357</span>, <span class="hljs-number">870791724</span>, <span class="hljs-number">2320512780</span>, <span class="hljs-number">2149666862</span>, <span class="hljs-number">3797999384</span>, <span class="hljs-number">3905363134</span>, <span class="hljs-number">3388169321</span>, <span class="hljs-number">851973359</span>, <span class="hljs-number">1418716205</span>, <span class="hljs-number">207581030</span>, <span class="hljs-number">1740441523</span>, <span class="hljs-number">1173839013</span>, <span class="hljs-number">4280610104</span>, <span class="hljs-number">1769134281</span>, <span class="hljs-number">1758916333</span>, <span class="hljs-number">4061069248</span>, <span class="hljs-number">2147554262</span>, <span class="hljs-number">2749007447</span>, <span class="hljs-number">909878569</span>, <span class="hljs-number">2054562584</span>, <span class="hljs-number">1515003000</span>, <span class="hljs-number">560286390</span>, <span class="hljs-number">2482663802</span>, <span class="hljs-number">2690882951</span>, <span class="hljs-number">3298162668</span>, <span class="hljs-number">2561737261</span>, <span class="hljs-number">167825221</span>, <span class="hljs-number">507375343</span>, <span class="hljs-number">2179952491</span>, <span class="hljs-number">795452860</span>, <span class="hljs-number">2877704207</span>, <span class="hljs-number">3243106071</span>, <span class="hljs-number">1633372043</span>, <span class="hljs-number">2152178033</span>, <span class="hljs-number">2993246714</span>, <span class="hljs-number">4176238981</span>, <span class="hljs-number">3828458887</span>, <span class="hljs-number">695369535</span>, <span class="hljs-number">2514762808</span>, <span class="hljs-number">2251430819</span>, <span class="hljs-number">2743651063</span>, <span class="hljs-number">783239046</span>, <span class="hljs-number">4036497041</span>, <span class="hljs-number">2175424426</span>, <span class="hljs-number">765021321</span>, <span class="hljs-number">897227922</span>, <span class="hljs-number">3192938155</span>, <span class="hljs-number">4173350810</span>, <span class="hljs-number">2290496185</span>, <span class="hljs-number">4215986056</span>, <span class="hljs-number">2448481441</span>, <span class="hljs-number">3114984799</span>, <span class="hljs-number">2920066349</span>, <span class="hljs-number">722868808</span>, <span class="hljs-number">594363801</span>, <span class="hljs-number">4012575088</span>, <span class="hljs-number">454547939</span>, <span class="hljs-number">3331771662</span>, <span class="hljs-number">1267229957</span>, <span class="hljs-number">3170277692</span>, <span class="hljs-number">2446344734</span>, <span class="hljs-number">3730529788</span>, <span class="hljs-number">2621611481</span>, <span class="hljs-number">2972284304</span>, <span class="hljs-number">2580290241</span>, <span class="hljs-number">486727007</span>, <span class="hljs-number">2727955445</span>, <span class="hljs-number">1457071884</span>, <span class="hljs-number">1053028185</span>, <span class="hljs-number">462301682</span>, <span class="hljs-number">3907840756</span>, <span class="hljs-number">1832398102</span>, <span class="hljs-number">3144685297</span>, <span class="hljs-number">3403964915</span>, <span class="hljs-number">4263570498</span>, <span class="hljs-number">792776003</span>, <span class="hljs-number">306771255</span>, <span class="hljs-number">1633688240</span>, <span class="hljs-number">2159479271</span>, <span class="hljs-number">942060576</span>, <span class="hljs-number">1311531808</span>, <span class="hljs-number">3145754189</span>, <span class="hljs-number">4142271069</span>, <span class="hljs-number">2844524541</span>, <span class="hljs-number">4082439147</span>, <span class="hljs-number">2847276716</span>, <span class="hljs-number">1374436698</span>, <span class="hljs-number">2601522390</span>, <span class="hljs-number">529644524</span>, <span class="hljs-number">206090172</span>, <span class="hljs-number">3015114937</span>, <span class="hljs-number">4137169373</span>, <span class="hljs-number">2600331537</span>, <span class="hljs-number">344659140</span>, <span class="hljs-number">155319271</span>, <span class="hljs-number">1724932164</span>, <span class="hljs-number">3187877676</span>, <span class="hljs-number">4020168431</span>, <span class="hljs-number">711431575</span>, <span class="hljs-number">4123955169</span>, <span class="hljs-number">2539963709</span>, <span class="hljs-number">2764832709</span>, <span class="hljs-number">3897838285</span>, <span class="hljs-number">2521203644</span>, <span class="hljs-number">2059212822</span>, <span class="hljs-number">1129046005</span>, <span class="hljs-number">3277260664</span>, <span class="hljs-number">2739869189</span>, <span class="hljs-number">1955591901</span>, <span class="hljs-number">2661672178</span>, <span class="hljs-number">2926355273</span>, <span class="hljs-number">28176978</span>, <span class="hljs-number">706409211</span>, <span class="hljs-number">1432061304</span>, <span class="hljs-number">26517996</span>, <span class="hljs-number">3180196905</span>, <span class="hljs-number">2178525849</span>, <span class="hljs-number">607854674</span>, <span class="hljs-number">3953350517</span>, <span class="hljs-number">3532394548</span>, <span class="hljs-number">4175940932</span>, <span class="hljs-number">626671309</span>, <span class="hljs-number">1273934270</span>, <span class="hljs-number">3481828801</span>, <span class="hljs-number">22643989</span>, <span class="hljs-number">2104739013</span>, <span class="hljs-number">4183577772</span>, <span class="hljs-number">3932721637</span>, <span class="hljs-number">3075788222</span>, <span class="hljs-number">2814353001</span>, <span class="hljs-number">4120869721</span>, <span class="hljs-number">2045506903</span>, <span class="hljs-number">603494333</span>, <span class="hljs-number">335162960</span>, <span class="hljs-number">2069261279</span>, <span class="hljs-number">2278614835</span>, <span class="hljs-number">210140447</span>, <span class="hljs-number">2012566692</span>, <span class="hljs-number">2345710126</span>, <span class="hljs-number">70390387</span>, <span class="hljs-number">457247932</span>, <span class="hljs-number">2764651800</span>, <span class="hljs-number">652766919</span>, <span class="hljs-number">555253440</span>, <span class="hljs-number">864036913</span>, <span class="hljs-number">1720142260</span>, <span class="hljs-number">453262569</span>, <span class="hljs-number">1113437101</span>, <span class="hljs-number">2576419688</span>, <span class="hljs-number">144008475</span>, <span class="hljs-number">1786881829</span>, <span class="hljs-number">2455128823</span>, <span class="hljs-number">2884922345</span>, <span class="hljs-number">4251332234</span>, <span class="hljs-number">58949785</span>, <span class="hljs-number">4206002785</span>, <span class="hljs-number">3374754553</span>, <span class="hljs-number">2976162198</span>, <span class="hljs-number">546450687</span>, <span class="hljs-number">1268444784</span>, <span class="hljs-number">4132330381</span>, <span class="hljs-number">3404894280</span>, <span class="hljs-number">2421962142</span>, <span class="hljs-number">212361299</span>, <span class="hljs-number">2526283704</span>, <span class="hljs-number">1656118437</span>, <span class="hljs-number">1249336298</span>, <span class="hljs-number">305885855</span>, <span class="hljs-number">1090758249</span>, <span class="hljs-number">3752057640</span>, <span class="hljs-number">3508190692</span>, <span class="hljs-number">3637428</span>, <span class="hljs-number">105102422</span>, <span class="hljs-number">2247418237</span>, <span class="hljs-number">1873609555</span>, <span class="hljs-number">1206760240</span>, <span class="hljs-number">3761689119</span>, <span class="hljs-number">3151616638</span>, <span class="hljs-number">1711308858</span>, <span class="hljs-number">1261541178</span>, <span class="hljs-number">1843103377</span>, <span class="hljs-number">3158893523</span>, <span class="hljs-number">1226253110</span>, <span class="hljs-number">3337577909</span>, <span class="hljs-number">126612372</span>, <span class="hljs-number">2239219657</span>, <span class="hljs-number">1415387229</span>, <span class="hljs-number">3657507305</span>, <span class="hljs-number">3330696118</span>, <span class="hljs-number">2304219467</span>, <span class="hljs-number">3782535397</span>, <span class="hljs-number">2523926865</span>, <span class="hljs-number">173770442</span>, <span class="hljs-number">469421316</span>, <span class="hljs-number">4068724979</span>, <span class="hljs-number">567442650</span>, <span class="hljs-number">1996215573</span>, <span class="hljs-number">2071307093</span>, <span class="hljs-number">778899724</span>, <span class="hljs-number">3534102235</span>, <span class="hljs-number">1001138889</span>, <span class="hljs-number">2821812427</span>, <span class="hljs-number">591691317</span>, <span class="hljs-number">1265763678</span>, <span class="hljs-number">2241915660</span>, <span class="hljs-number">3220601768</span>, <span class="hljs-number">653090205</span>, <span class="hljs-number">2367897867</span>, <span class="hljs-number">1393909319</span>, <span class="hljs-number">2691817329</span>, <span class="hljs-number">3098049768</span>, <span class="hljs-number">117121403</span>, <span class="hljs-number">1255294678</span>, <span class="hljs-number">2272844919</span>, <span class="hljs-number">788255921</span>, <span class="hljs-number">2333869622</span>, <span class="hljs-number">4052660679</span>, <span class="hljs-number">2407095869</span>, <span class="hljs-number">2636108242</span>, <span class="hljs-number">2204717619</span>, <span class="hljs-number">1672726444</span>, <span class="hljs-number">2250826426</span>, <span class="hljs-number">258706466</span>, <span class="hljs-number">2295454699</span>, <span class="hljs-number">337308034</span>, <span class="hljs-number">3703973770</span>, <span class="hljs-number">3133498524</span>, <span class="hljs-number">22718827</span>, <span class="hljs-number">3096937679</span>, <span class="hljs-number">2039003308</span>, <span class="hljs-number">1519854757</span>, <span class="hljs-number">568184976</span>, <span class="hljs-number">1986854118</span>, <span class="hljs-number">2888207511</span>, <span class="hljs-number">822307630</span>, <span class="hljs-number">3829301724</span>, <span class="hljs-number">3198527490</span>, <span class="hljs-number">3073739663</span>, <span class="hljs-number">3043580445</span>, <span class="hljs-number">3458239370</span>, <span class="hljs-number">802145890</span>, <span class="hljs-number">376901460</span>, <span class="hljs-number">1251103099</span>, <span class="hljs-number">1143003993</span>, <span class="hljs-number">1280321148</span>, <span class="hljs-number">661386076</span>, <span class="hljs-number">3708710489</span>, <span class="hljs-number">2237151715</span>, <span class="hljs-number">3928104641</span>, <span class="hljs-number">2975550516</span>, <span class="hljs-number">1087492088</span>, <span class="hljs-number">1504028830</span>, <span class="hljs-number">61927086</span>, <span class="hljs-number">3858242888</span>, <span class="hljs-number">1916136658</span>, <span class="hljs-number">2328550074</span>, <span class="hljs-number">3032032377</span>, <span class="hljs-number">2193802260</span>, <span class="hljs-number">3311627503</span>, <span class="hljs-number">3196945045</span>, <span class="hljs-number">3396801792</span>, <span class="hljs-number">806210594</span>, <span class="hljs-number">2449941623</span>, <span class="hljs-number">2514744466</span>, <span class="hljs-number">3922130206</span>, <span class="hljs-number">3245757763</span>, <span class="hljs-number">3128328446</span>, <span class="hljs-number">2335833206</span>, <span class="hljs-number">3205660364</span>, <span class="hljs-number">3527402441</span>, <span class="hljs-number">2174241644</span>, <span class="hljs-number">1262568556</span>, <span class="hljs-number">2360103007</span>, <span class="hljs-number">2490217737</span>, <span class="hljs-number">1485100950</span>, <span class="hljs-number">3407260</span>, <span class="hljs-number">3005226942</span>, <span class="hljs-number">1355314866</span>, <span class="hljs-number">3154763465</span>, <span class="hljs-number">619881867</span>, <span class="hljs-number">2409963438</span>, <span class="hljs-number">2422269402</span>, <span class="hljs-number">205756019</span>, <span class="hljs-number">3300644241</span>, <span class="hljs-number">1157501775</span>, <span class="hljs-number">1229058028</span>, <span class="hljs-number">161050869</span>, <span class="hljs-number">969496287</span>, <span class="hljs-number">3385825249</span>, <span class="hljs-number">2557284067</span>, <span class="hljs-number">4236642714</span>, <span class="hljs-number">169094727</span>, <span class="hljs-number">2698326774</span>, <span class="hljs-number">1863176242</span>, <span class="hljs-number">3532885426</span>, <span class="hljs-number">3046403588</span>, <span class="hljs-number">3869207867</span>, <span class="hljs-number">496104150</span>, <span class="hljs-number">353604631</span>, <span class="hljs-number">1054882225</span>, <span class="hljs-number">152711981</span>, <span class="hljs-number">1362131890</span>, <span class="hljs-number">76912113</span>, <span class="hljs-number">3052177189</span>, <span class="hljs-number">3932252092</span>, <span class="hljs-number">3834713905</span>, <span class="hljs-number">2338378436</span>, <span class="hljs-number">44417325</span>, <span class="hljs-number">117723195</span>, <span class="hljs-number">1089433566</span>, <span class="hljs-number">4166617161</span>, <span class="hljs-number">2848021308</span>, <span class="hljs-number">2229619096</span>, <span class="hljs-number">319957702</span>, <span class="hljs-number">3661655667</span>, <span class="hljs-number">2809620731</span>, <span class="hljs-number">482011930</span>, <span class="hljs-number">3983483016</span>, <span class="hljs-number">82362287</span>, <span class="hljs-number">1518135562</span>, <span class="hljs-number">3490996143</span>, <span class="hljs-number">510129461</span>, <span class="hljs-number">1400609584</span>, <span class="hljs-number">2646113779</span>, <span class="hljs-number">732457215</span>, <span class="hljs-number">3735585198</span>, <span class="hljs-number">3451194227</span>, <span class="hljs-number">959269510</span>, <span class="hljs-number">244188667</span>]<br>ks_l = [<span class="hljs-number">11</span>, <span class="hljs-number">15</span>]<br>ks_r = [bitlen - <span class="hljs-number">7</span>, bitlen - <span class="hljs-number">19</span>]<span class="hljs-comment">#å³ç§»è½¬æ¢æˆå·¦ç§»</span><br>MT = []<br><span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> out:<br>    MT.append(decrypt(decrypt(each,ks_r),ks_l))<br><br>r = Myrand(MT)<br>flag = <span class="hljs-string">&#x27;DASCTF&#123;&#x27;</span> + md5(<span class="hljs-built_in">str</span>(r.rand()).encode()).hexdigest() + <span class="hljs-string">&#x27;&#125;&#x27;</span><br><span class="hljs-built_in">print</span>(flag)<br><span class="hljs-comment">#DASCTF&#123;49e225e5b1b57a1d3c9803b5ddfd38f9&#125;</span><br></code></pre></td></tr></table></figure><h1 id="Yusaçš„å¯†ç å­¦è¯¾å ‚â€”â€”äºŒçœ¼æ·±æƒ…"><a href="#Yusaçš„å¯†ç å­¦è¯¾å ‚â€”â€”äºŒçœ¼æ·±æƒ…" class="headerlink" title="Yusaçš„å¯†ç å­¦è¯¾å ‚â€”â€”äºŒçœ¼æ·±æƒ…"></a>Yusaçš„å¯†ç å­¦è¯¾å ‚â€”â€”äºŒçœ¼æ·±æƒ…</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">ä»£ç åŒä¸Šï¼Œé¢å¤–æœ‰ï¼š<br><span class="hljs-keyword">import</span> os<br>secret = <span class="hljs-built_in">int</span>(os.urandom(<span class="hljs-number">4</span>).<span class="hljs-built_in">hex</span>(),<span class="hljs-number">16</span>)<br>r = Myrand(secret)<br>out = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">624</span>):<br>out.append(r.rand())<br><br><span class="hljs-keyword">try</span>:<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>a = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Your &quot;</span>+[<span class="hljs-string">&#x27;first&#x27;</span>,<span class="hljs-string">&#x27;second&#x27;</span>][i]+ <span class="hljs-string">&quot; see: &quot;</span>))<br><span class="hljs-built_in">print</span>(out[a % <span class="hljs-built_in">len</span>(out)])<br>guess = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;You konw my secret? &quot;</span>))<br><span class="hljs-keyword">if</span> guess == secret:<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;For you ~&quot;</span>)<br><span class="hljs-built_in">print</span>(os.getenv(<span class="hljs-string">&quot;DASFLAG&quot;</span>))<br>exit()<br><span class="hljs-keyword">else</span>:<br><span class="hljs-built_in">print</span>([<span class="hljs-string">&quot;Try again~ &quot;</span>,<span class="hljs-string">&quot;Bye~&quot;</span>][i])<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>exit()<br></code></pre></td></tr></table></figure><ol><li><p>ä¹Ÿå°±æ˜¯è¯´è¦é€‰å–ä¸¤ä¸ªåˆé€‚çš„ $out$ æ¥åæ¨å‡º $seed$ ã€‚å› æ­¤ï¼Œé€‰å– $out[395]$ å’Œ $out[622]$ ã€‚é€šè¿‡ç¬¬ä¸€é¢˜çš„æ–¹æ³•åæ¨å‡º<code>generate()</code>ä¹‹åçš„ $MT[395]$ å’Œ $MT[622]$ ã€‚</p></li><li><p>æ ¹æ®<code>generate</code>å‡½æ•°ï¼ŒçŒœæµ‹ $bin(y)$ çš„æœ€ä½ä½(ä¹Ÿå°±æ˜¯ $bin(MT[623])$ )ï¼Œè¿™æ ·å°±å¯ä»¥æ¨å‡º $bin(MT)[2:][1:]$ ï¼Œå†æ¬¡çŒœæµ‹å®ƒçš„æœ€é«˜ä½ï¼Œè¿™æ ·å°±æœ‰å››ç§æƒ…å†µã€‚</p></li><li><p>æ ¹æ®<code>__init__()</code>ä¸­çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">624</span>):<br>t = <span class="hljs-number">2037740385</span> * (self.MT[i-<span class="hljs-number">1</span>] ^ (self.MT[i-<span class="hljs-number">1</span>] &gt;&gt; <span class="hljs-number">30</span>)) + <span class="hljs-number">1</span><br>self.MT[i] = t &amp; <span class="hljs-number">0xffffffff</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥æ¨å‡ºæœ€åˆå§‹çš„ $MT$ ã€‚ t &amp; 0xffffffff ç›¸å½“äº t%$2^{32}$ã€‚è¿™æ ·ï¼Œ æ±‚å‡º $MT[i-1]$åªéœ€è¦ (t-1)*inv(2037740385,$2^{32}$) ï¼Œåœ¨è¿è¡Œä¸€éä¸Šé¢è¿™ä¸ªå¼‚æˆ–æ“ä½œå°±å¯ä»¥äº†ã€‚</p></li><li><p>å››ç§æƒ…å†µï¼Œå°±éœ€è¦ç­›é€‰ã€‚ç”¨ä¸Šé¢å¾—å‡ºçš„ $MT$ è¿è¡Œä¸€é<code>generate()</code>ï¼Œçœ‹æ˜¯å¦åŒ¹é…æ­¥éª¤(1)ä¸­çš„ $MT[395]$ å’Œ $MT[622]$ ã€‚</p></li></ol><p>ï¼ˆå¥‡æ€ªäº†ï¼æœ‰æ—¶å€™è¿è¡Œèƒ½å¾—å‡ºç»“æœï¼Œæœ‰æ—¶å€™ä¸èƒ½ï¼æ˜¯ä¸æ˜¯ä»£ç æœ‰é—®é¢˜ï¼Ÿæˆ‘æ£€æŸ¥äº†å¥½ä¹…ä½†æ²¡å‘ç°ï¼Œå¸Œæœ›å¸ˆå‚…ä»¬èƒ½æ–§æ­£ä¸€ä¸‹ï¼ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><br>s = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25122</span>)<br><span class="hljs-comment">#ç¬¬ä¸€è½®</span><br><span class="hljs-built_in">print</span>(s.recv())<br>s.sendline(<span class="hljs-string">b&#x27;395&#x27;</span>)<br>out395 = <span class="hljs-built_in">int</span>(s.recvline()[:-<span class="hljs-number">1</span>])<br><span class="hljs-built_in">print</span>(out395)<br><span class="hljs-built_in">print</span>(s.recv())<br>s.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br><span class="hljs-built_in">print</span>(s.recvline())<br><span class="hljs-comment">#ç¬¬äºŒè½®</span><br><span class="hljs-built_in">print</span>(s.recv())<br>s.sendline(<span class="hljs-string">b&#x27;622&#x27;</span>)<br>out622 = <span class="hljs-built_in">int</span>(s.recvline()[:-<span class="hljs-number">1</span>])<br><span class="hljs-built_in">print</span>(out622)<br><span class="hljs-built_in">print</span>(s.recv())<br><br><span class="hljs-comment">#generate()ä¹‹åçš„MT</span><br>bitlen = <span class="hljs-number">32</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">y,k</span>):<span class="hljs-comment">#å¾ªç¯å·¦ç§»</span><br>    biny = <span class="hljs-built_in">bin</span>(y)[<span class="hljs-number">2</span>:].zfill(bitlen)<br>    k = k % bitlen<br>    biny = biny[k:] + biny[:k]<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(biny,<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">y,ks</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(bitlen):<br>        y = y ^ mov(y,ks[<span class="hljs-number">0</span>]) ^ mov(y,ks[<span class="hljs-number">1</span>])<br>        ks = [ k&lt;&lt;<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> ks]<br>    <span class="hljs-keyword">return</span> y<br><br>ks_l = [<span class="hljs-number">11</span>, <span class="hljs-number">15</span>]<br>ks_r = [bitlen - <span class="hljs-number">7</span>, bitlen - <span class="hljs-number">19</span>]<span class="hljs-comment">#å³ç§»è½¬æ¢æˆå·¦ç§»</span><br>out395 = decrypt(decrypt(out395,ks_r),ks_l)<br>out622 = decrypt(decrypt(out622,ks_r),ks_l)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;out395 = <span class="hljs-subst">&#123;out395&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;out622 = <span class="hljs-subst">&#123;out622&#125;</span>&#x27;</span>)<br><br><span class="hljs-comment">#æ¢å¤æ‰€æœ‰åˆå§‹MT</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">recover</span>(<span class="hljs-params">seed</span>):<br>    seed &amp;= <span class="hljs-number">0xffffffff</span><br>    inv = <span class="hljs-built_in">int</span>(gmpy2.invert(<span class="hljs-number">2037740385</span>,<span class="hljs-number">0xffffffff</span>+<span class="hljs-number">1</span>))<span class="hljs-comment">#</span><br>    re_MT = [seed] + [<span class="hljs-number">0</span>]*<span class="hljs-number">623</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">624</span>):<br>        mt = ((re_MT[i-<span class="hljs-number">1</span>] - <span class="hljs-number">1</span>)*inv) &amp; <span class="hljs-number">0xffffffff</span><br>        <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        mt = bin(mt)[2:].zfill(32)</span><br><span class="hljs-string">        tmp1 = mt[:30]</span><br><span class="hljs-string">        tmp2 = int(tmp1[:2],2) ^ int(mt[30:],2)</span><br><span class="hljs-string">        tmp = (int(tmp1,2) &lt;&lt; 2) + tmp2</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span><br>        tmp = mt ^ (mt &gt;&gt; <span class="hljs-number">30</span>)<br>        re_MT[i] = tmp<br><br>    <span class="hljs-keyword">return</span> re_MT[::-<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">#æ£€éªŒ</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">MT</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">624</span>):<br>        y = (MT[i] &amp; <span class="hljs-number">0x80000000</span>) + (MT[(i + <span class="hljs-number">1</span>) % <span class="hljs-number">624</span>] &amp; <span class="hljs-number">0x7fffffff</span>)<br>        MT[i] = MT[(i + <span class="hljs-number">397</span>) % <span class="hljs-number">624</span>] ^ (y &gt;&gt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> y &amp; <span class="hljs-number">1</span>:<br>            MT[i] ^= <span class="hljs-number">25674835200</span><br>    <span class="hljs-comment">#print(f&#x27;checkMT = &#123;MT&#125;&#x27;)</span><br>    <span class="hljs-comment">#print(f&#x27;MT[395] = &#123;MT[395]&#125;,MT[622] = &#123;MT[622]&#125;&#x27;)</span><br>    <span class="hljs-keyword">if</span> MT[<span class="hljs-number">395</span>] == out395 <span class="hljs-keyword">and</span> MT[<span class="hljs-number">622</span>] == out622:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment">#æ¢å¤MT[623]</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dec_generate</span>(<span class="hljs-params">a,b</span>):<span class="hljs-comment">#aä¸ºout622,bä¸ºout395</span><br>    maybe = []<br>    <span class="hljs-comment">#MT[623]æœ€åä¸€bitä¸º1</span><br>    tmp1 = a ^ <span class="hljs-number">25674835200</span><br>    y = tmp1 ^ b<br>    y = (y &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span><br>    <span class="hljs-comment">#çŒœé«˜ä½0,1</span><br>    mt1 = <span class="hljs-number">0x80000000</span> + (y &amp; <span class="hljs-number">0x7fffffff</span>)<br>    maybe.append(mt1)<br>    mt2 = y &amp; <span class="hljs-number">0x7fffffff</span><br>    maybe.append(mt2)<br>    <span class="hljs-comment"># MT[623]æœ€åä¸€bitä¸º0</span><br>    y = a ^ b<br>    y = (y &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">0</span><br>    mt3 = <span class="hljs-number">0x80000000</span> + (y &amp; <span class="hljs-number">0x7fffffff</span>)<br>    maybe.append(mt3)<br>    mt4 = y &amp; <span class="hljs-number">0x7fffffff</span><br>    maybe.append(mt4)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;maybe = <span class="hljs-subst">&#123;maybe&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> maybe:<br>        MT = recover(each)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;MT = <span class="hljs-subst">&#123;MT&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">if</span> MT != -<span class="hljs-number">1</span>:<br>            isflag = check(MT.copy())<br>            <span class="hljs-comment">#print(&#x27;3&#x27;,MT)</span><br>            <span class="hljs-keyword">if</span> isflag:<br>                <span class="hljs-keyword">return</span> MT[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br><br><br>seed = dec_generate(out622,out395)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;seed = <span class="hljs-subst">&#123;seed&#125;</span>&#x27;</span>)<br>s.sendline(<span class="hljs-built_in">str</span>(seed).encode())<br><span class="hljs-built_in">print</span>(s.recv())<br><span class="hljs-comment">#b&#x27;DASCTF&#123;a448b996-140b-4b06-9bf0-b69c6cde067d&#125;&#x27;</span><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://www.mdlabs.cn/index.php/2022/05/24/dasctf%EF%BD%9C2022dasctf-may%E5%87%BA%E9%A2%98%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9B%E5%AE%98%E6%96%B9write/">DASCTFï½œ2022DASCTF Mayå‡ºé¢˜äººæŒ‘æˆ˜èµ›å®˜æ–¹Write â€“ MD labs</a></p><p><a href="https://www.cnblogs.com/Tf1shC4T/p/15927062.html">å¾ªç¯ç§»ä½å¼‚æˆ–åŠ å¯† - Tf1shC4T - åšå®¢å›­ (cnblogs.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MT19937</tag>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Dest0g3 520è¿æ–°èµ›</title>
    <link href="/2022/07/10/Dest0g3%20520%E8%BF%8E%E6%96%B0%E8%B5%9B/"/>
    <url>/2022/07/10/Dest0g3%20520%E8%BF%8E%E6%96%B0%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<p>å¾ˆé—æ†¾ï¼Œç”±äºæš‘å‡éœ€è¦å‚ä¸æ•°æ¨¡ï¼Œæš‘å‡æ¯æ—¥ä¸€ç»ƒå¯èƒ½å¾ˆéš¾å®ç°ï¼Œä½†ä»ä¼šé™†ç»­å¤ç°ä¸€äº›ä¹‹å‰çš„é¢˜ç›®ã€‚æ—¶é—´è·¨åº¦ä¸Šå¯èƒ½ä¼šé•¿ä¸€äº›ã€‚</p><hr><h1 id="babyRSA"><a href="#babyRSA" class="headerlink" title="babyRSA"></a>babyRSA</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> bytes_to_long, getPrime<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> next_prime<br>p = getPrime(<span class="hljs-number">1024</span>)<br>q = next_prime(p)<br>n = p*q<br>flag = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>m = bytes_to_long(flag)<br>e = <span class="hljs-number">65537</span><br>c = <span class="hljs-built_in">pow</span>(m, e, n)<br><span class="hljs-built_in">print</span>(n)<br><span class="hljs-built_in">print</span>(c)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">27272410937497615429184017335437367466288981498585803398561456300019447702001403165885200936510173980380489828828523983388730026101865884520679872671569532101708469344562155718974222196684544003071765625134489632331414011555536130289106822732544904502428727133498239161324625698270381715640332111381465813621908465311076678337695819124178638737015840941223342176563458181918865641701282965455705790456658431641632470787689389714643528968037519265144919465402561959014798324908010947632834281698638848683632113623788303921939908168450492197671761167009855312820364427648296494571794298105543758141065915257674305081267</span><br><span class="hljs-string">14181751948841206148995320731138166924841307246014981115736748934451763670304308496261846056687977917728671991049712129745906089287169170294259856601300717330153987080212591008738712344004443623518040786009771108879196701679833782022875324499201475522241396314392429412747392203809125245393462952461525539673218721341853515099201642769577031724762640317081252046606564108211626446676911167979492329012381654087618979631924439276786566078856385835786995011067720124277812004808431347148593882791476391944410064371926611180496847010107167486521927340045188960373155894717498700488982910217850877130989318706580155251854</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>$p,q$ è¿‘ä¼¼ï¼Œå¯¹ $n$ å¼€æ ¹å·å–å‰åç´ æ•°å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><br>n = <span class="hljs-number">27272410937497615429184017335437367466288981498585803398561456300019447702001403165885200936510173980380489828828523983388730026101865884520679872671569532101708469344562155718974222196684544003071765625134489632331414011555536130289106822732544904502428727133498239161324625698270381715640332111381465813621908465311076678337695819124178638737015840941223342176563458181918865641701282965455705790456658431641632470787689389714643528968037519265144919465402561959014798324908010947632834281698638848683632113623788303921939908168450492197671761167009855312820364427648296494571794298105543758141065915257674305081267</span><br>c = <span class="hljs-number">14181751948841206148995320731138166924841307246014981115736748934451763670304308496261846056687977917728671991049712129745906089287169170294259856601300717330153987080212591008738712344004443623518040786009771108879196701679833782022875324499201475522241396314392429412747392203809125245393462952461525539673218721341853515099201642769577031724762640317081252046606564108211626446676911167979492329012381654087618979631924439276786566078856385835786995011067720124277812004808431347148593882791476391944410064371926611180496847010107167486521927340045188960373155894717498700488982910217850877130989318706580155251854</span><br><br>tmp = gmpy2.iroot(n,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]<br>p = gmpy2.next_prime(tmp)<br>q = n//p<br>e = <span class="hljs-number">65537</span><br>d = gmpy2.invert(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br><span class="hljs-comment">#Dest0g3&#123;96411aad-032c-20a8-bc43-b473f6f08536&#125;</span><br></code></pre></td></tr></table></figure><h1 id="babyAES"><a href="#babyAES" class="headerlink" title="babyAES"></a>babyAES</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> os<br>iv = os.urandom(<span class="hljs-number">16</span>)<br>key = os.urandom(<span class="hljs-number">16</span>)<br>my_aes = AES.new(key, AES.MODE_CBC, iv)<br>flag = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>flag += (<span class="hljs-number">16</span> - <span class="hljs-built_in">len</span>(flag) % <span class="hljs-number">16</span>) * <span class="hljs-string">b&#x27;\x00&#x27;</span><br>c = my_aes.encrypt(flag)<br><span class="hljs-built_in">print</span>(c)<br><span class="hljs-built_in">print</span>(iv)<br><span class="hljs-built_in">print</span>(key)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b&#x27;C4:\x86Q$\xb0\xd1\x1b\xa9L\x00\xad\xa3\xff\x96 hJ\x1b~\x1c\xd1y\x87A\xfe0\xe2\xfb\xc7\xb7\x7f^\xc8\x9aP\xdaX\xc6\xdf\x17l=K\x95\xd07&#x27;</span><br><span class="hljs-string">b&#x27;\xd1\xdf\x8f)\x08w\xde\xf9yX%\xca[\xcb\x18\x80&#x27;</span><br><span class="hljs-string">b&#x27;\xa4\xa6M\xab&#123;\xf6\x97\x94&gt;hK\x9bBe]F&#x27;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br></code></pre></td></tr></table></figure><p>ç®€å•çš„AESåŠ è§£å¯†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br>c = <span class="hljs-string">b&#x27;C4:\x86Q$\xb0\xd1\x1b\xa9L\x00\xad\xa3\xff\x96 hJ\x1b~\x1c\xd1y\x87A\xfe0\xe2\xfb\xc7\xb7\x7f^\xc8\x9aP\xdaX\xc6\xdf\x17l=K\x95\xd07&#x27;</span><br>iv = <span class="hljs-string">b&#x27;\xd1\xdf\x8f)\x08w\xde\xf9yX%\xca[\xcb\x18\x80&#x27;</span><br>key = <span class="hljs-string">b&#x27;\xa4\xa6M\xab&#123;\xf6\x97\x94&gt;hK\x9bBe]F&#x27;</span><br>my_aes = AES.new(key, AES.MODE_CBC, iv)<br>flag = my_aes.decrypt(c)<br><span class="hljs-built_in">print</span>(flag)<br><span class="hljs-comment">#b&#x27;Dest0g3&#123;d0e5fa76-e50f-76f6-9cf1-b6c2d576b6f4&#125;\x00\x00\x00&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="ezDLP"><a href="#ezDLP" class="headerlink" title="ezDLP"></a>ezDLP</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>flag = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>x = bytes_to_long(flag)<br>g = <span class="hljs-number">19</span><br>p = <span class="hljs-number">335215034881592512312398694238485179340610060759881511231472142277527176340784432381542726029524727833039074808456839870641607412102746854257629226877248337002993023452385472058106944014653401647033456174126976474875859099023703472904735779212010820524934972736276889281087909166017427905825553503050645575935980580803899122224368875197728677516907272452047278523846912786938173456942568602502013001099009776563388736434564541041529106817380347284002060811645842312648498340150736573246893588079033524476111268686138924892091575797329915240849862827621736832883215569687974368499436632617425922744658912248644475097139485785819369867604176912652851123185884810544172785948158330991257118563772736929105360124222843930130347670027236797458715653361366862282591170630650344062377644570729478796795124594909835004189813214758026703689710017334501371279295621820181402191463184275851324378938021156631501330660825566054528793444353</span><br>h = <span class="hljs-built_in">pow</span>(g, x, p)<br><span class="hljs-built_in">print</span>(h)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">199533304296625406955683944856330940256037859126142372412254741689676902594083385071807594584589647225039650850524873289407540031812171301348304158895770989218721006018956756841251888659321582420167478909768740235321161096806581684857660007735707550914742749524818990843357217489433410647994417860374972468061110200554531819987204852047401539211300639165417994955609002932104372266583569468915607415521035920169948704261625320990186754910551780290421057403512785617970138903967874651050299914974180360347163879160470918945383706463326470519550909277678697788304151342226439850677611170439191913555562326538607106089620201074331099713506536192957054173076913374098400489398228161089007898192779738439912595619813699711049380213926849110877231503068464392648816891183318112570732792516076618174144968844351282497993164926346337121313644001762196098432060141494704659769545012678386821212213326455045335220435963683095439867976162</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br></code></pre></td></tr></table></figure><p>ç¦»æ•£å¯¹æ•°é—®é¢˜ã€‚ç”¨sageæˆ–pythonçš„sympyåº“æ±‚è§£ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br>g = <span class="hljs-number">19</span><br>p = <span class="hljs-number">335215034881592512312398694238485179340610060759881511231472142277527176340784432381542726029524727833039074808456839870641607412102746854257629226877248337002993023452385472058106944014653401647033456174126976474875859099023703472904735779212010820524934972736276889281087909166017427905825553503050645575935980580803899122224368875197728677516907272452047278523846912786938173456942568602502013001099009776563388736434564541041529106817380347284002060811645842312648498340150736573246893588079033524476111268686138924892091575797329915240849862827621736832883215569687974368499436632617425922744658912248644475097139485785819369867604176912652851123185884810544172785948158330991257118563772736929105360124222843930130347670027236797458715653361366862282591170630650344062377644570729478796795124594909835004189813214758026703689710017334501371279295621820181402191463184275851324378938021156631501330660825566054528793444353</span><br>h = <span class="hljs-number">199533304296625406955683944856330940256037859126142372412254741689676902594083385071807594584589647225039650850524873289407540031812171301348304158895770989218721006018956756841251888659321582420167478909768740235321161096806581684857660007735707550914742749524818990843357217489433410647994417860374972468061110200554531819987204852047401539211300639165417994955609002932104372266583569468915607415521035920169948704261625320990186754910551780290421057403512785617970138903967874651050299914974180360347163879160470918945383706463326470519550909277678697788304151342226439850677611170439191913555562326538607106089620201074331099713506536192957054173076913374098400489398228161089007898192779738439912595619813699711049380213926849110877231503068464392648816891183318112570732792516076618174144968844351282497993164926346337121313644001762196098432060141494704659769545012678386821212213326455045335220435963683095439867976162</span><br>m = discrete_log(mod(h,p),mod(g,p))<br><span class="hljs-built_in">print</span>(m)<br>----------------------------------------------------------------------------------<br><span class="hljs-comment">#python</span><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> discrete_log<br><br>g = <span class="hljs-number">19</span><br>p = <span class="hljs-number">335215034881592512312398694238485179340610060759881511231472142277527176340784432381542726029524727833039074808456839870641607412102746854257629226877248337002993023452385472058106944014653401647033456174126976474875859099023703472904735779212010820524934972736276889281087909166017427905825553503050645575935980580803899122224368875197728677516907272452047278523846912786938173456942568602502013001099009776563388736434564541041529106817380347284002060811645842312648498340150736573246893588079033524476111268686138924892091575797329915240849862827621736832883215569687974368499436632617425922744658912248644475097139485785819369867604176912652851123185884810544172785948158330991257118563772736929105360124222843930130347670027236797458715653361366862282591170630650344062377644570729478796795124594909835004189813214758026703689710017334501371279295621820181402191463184275851324378938021156631501330660825566054528793444353</span><br>h = <span class="hljs-number">199533304296625406955683944856330940256037859126142372412254741689676902594083385071807594584589647225039650850524873289407540031812171301348304158895770989218721006018956756841251888659321582420167478909768740235321161096806581684857660007735707550914742749524818990843357217489433410647994417860374972468061110200554531819987204852047401539211300639165417994955609002932104372266583569468915607415521035920169948704261625320990186754910551780290421057403512785617970138903967874651050299914974180360347163879160470918945383706463326470519550909277678697788304151342226439850677611170439191913555562326538607106089620201074331099713506536192957054173076913374098400489398228161089007898192779738439912595619813699711049380213926849110877231503068464392648816891183318112570732792516076618174144968844351282497993164926346337121313644001762196098432060141494704659769545012678386821212213326455045335220435963683095439867976162</span><br><br>m = discrete_log(p,h,g)<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br><span class="hljs-comment">#b&#x27;Dest0g3&#123;07ed2a6f-182f-a05d-c81e-1318af820a78&#125;&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="ezStream"><a href="#ezStream" class="headerlink" title="ezStream"></a>ezStream</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>)<br>flag = f.read()<br>f.close()<br><span class="hljs-keyword">assert</span> flag[:<span class="hljs-number">8</span>] == <span class="hljs-string">&quot;Dest0g3&#123;&quot;</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LCG</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.a = getRandomNBitInteger(<span class="hljs-number">32</span>)<br>        self.b = getRandomNBitInteger(<span class="hljs-number">32</span>)<br>        self.m = getPrime(<span class="hljs-number">32</span>)<br>        self.seed = getRandomNBitInteger(<span class="hljs-number">32</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">self</span>):<br>        self.seed = (self.a * self.seed + self.b) % self.m<br>        <span class="hljs-keyword">return</span> self.seed &gt;&gt; <span class="hljs-number">16</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">output</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;a = &#123;&#125;\nb = &#123;&#125;\nm = &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.a, self.b, self.m))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;state1 = &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.<span class="hljs-built_in">next</span>()))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;state2 = &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.<span class="hljs-built_in">next</span>()))<br><br><br>lcg = LCG()<br>lcg.output()<br>c = <span class="hljs-string">b&#x27;&#x27;</span>.join([long_to_bytes(<span class="hljs-built_in">ord</span>(flag[i]) ^ (lcg.<span class="hljs-built_in">next</span>() % <span class="hljs-number">10</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(flag))])<br><span class="hljs-built_in">print</span>(bytes_to_long(c))<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">a = 3939333498</span><br><span class="hljs-string">b = 3662432446</span><br><span class="hljs-string">m = 2271373817</span><br><span class="hljs-string">state1 = 17362  </span><br><span class="hljs-string">state2 = 20624</span><br><span class="hljs-string">600017039001091357643174067454938198067935635401496485588306838343558125283178792619821966678282131419050878</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>$$<br>\begin{cases}<br>seed1 &#x3D; (a * seed + b)% m,\ state1 &#x3D; seed1&gt;&gt;16<br>\\seed2 &#x3D; (a * seed1 + b)% m,\ state2 &#x3D; seed2&gt;&gt;16<br>\end{cases}<br>$$</p><p>è¿™è®©æˆ‘æƒ³åˆ°äº†äºŒå…ƒcopperï¼Œä¸è¿‡è²Œä¼¼æ²¡æ±‚å‡ºæ­£è§£ã€‚</p><p>$seed1,seed2$ ç¼ºå¤±ä½æ•°å°ï¼Œå¯ä»¥è¿›è¡Œçˆ†ç ´ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LCG</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,a,b,m,seed</span>):<br>        self.a = a<br>        self.b = b<br>        self.m = m<br>        self.seed = seed<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">self</span>):<br>        self.seed = (self.a * self.seed + self.b) % self.m<br>        <span class="hljs-keyword">return</span> self.seed &gt;&gt; <span class="hljs-number">16</span><br><br>a = <span class="hljs-number">3939333498</span><span class="hljs-comment">#32bit</span><br>b = <span class="hljs-number">3662432446</span><span class="hljs-comment">#32bit</span><br>m = <span class="hljs-number">2271373817</span><br>state1 = <span class="hljs-number">17362</span><br>state2 = <span class="hljs-number">20624</span><br>c = <span class="hljs-number">600017039001091357643174067454938198067935635401496485588306838343558125283178792619821966678282131419050878</span><br>c = long_to_bytes(c)<br><br>end = <span class="hljs-number">2</span>**<span class="hljs-number">16</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(end)):<br>    seed1 = (state1 &lt;&lt; <span class="hljs-number">16</span>) + i<span class="hljs-comment">#æ‰“æ‹¬å·ï¼ï¼ï¼</span><br>    seed2 = (a*seed1+b)%m<br>    <span class="hljs-keyword">if</span> seed2 &gt;&gt; <span class="hljs-number">16</span> == state2:<br>        <span class="hljs-built_in">print</span>(seed2)<br>        lcg1 = LCG(a, b, m, seed2)<br>        flag = <span class="hljs-string">b&#x27;&#x27;</span>.join([long_to_bytes(c[i] ^ (lcg1.<span class="hljs-built_in">next</span>() % <span class="hljs-number">10</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(c))])<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Dest0g3&#123;&#x27;</span> <span class="hljs-keyword">in</span> flag:<br>            <span class="hljs-built_in">print</span>(flag)<br>            <span class="hljs-keyword">break</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">1351677183</span><br><span class="hljs-string">b&#x27;Dest0g3&#123;f21c7180-c35e-f912-e4bc-bfd235759a25&#125;&#x27;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="Mr-Doctor"><a href="#Mr-Doctor" class="headerlink" title="Mr.Doctor"></a>Mr.Doctor</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">import</span> string<br><br>table = string.ascii_letters + string.digits<br>flag = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read()[<span class="hljs-number">8</span>:-<span class="hljs-number">1</span>]<br>seed = getRandomNBitInteger(<span class="hljs-number">40</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SHA256</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.proof = []<br>        self.sha = <span class="hljs-number">0</span><br>        self.sha_flag = []<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encryption</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(flag) // <span class="hljs-number">4</span>):<br>            self.proof.append(flag[<span class="hljs-number">4</span> * i:<span class="hljs-number">4</span> + <span class="hljs-number">4</span> * i])<span class="hljs-comment">#å››ä¸ªä¸€ç»„</span><br>            self.sha = sha256(self.proof[i]).hexdigest().encode()<span class="hljs-comment">#sha256åŠ å¯† 64bytes</span><br>            self.sha_flag.append(bytes_to_long(self.sha))<br>        <span class="hljs-keyword">return</span> self.sha_flag<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RHODES_ELITE</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.Doctor = getPrime(<span class="hljs-number">64</span>)<br>        self.Amiya = getRandomNBitInteger(<span class="hljs-number">40</span>)<br>        self.Rosmontis = getRandomNBitInteger(<span class="hljs-number">40</span>)<br>        self.Blaze = getRandomNBitInteger(<span class="hljs-number">40</span>)<br>        self.seed = seed<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">self</span>):<br>        self.seed = (self.Amiya * self.seed * self.seed + self.Rosmontis * self.seed + self.Blaze) % self.Doctor<br>        <span class="hljs-keyword">return</span> self.seed &gt;&gt; <span class="hljs-number">12</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">output</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Amiya = &quot;</span>, self.Amiya)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Rosmontis = &quot;</span>, self.Rosmontis)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Blaze = &quot;</span>, self.Blaze)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Doctor = &quot;</span>, self.Doctor)<br><br><br>sha = SHA256()<br>sha_flag = sha.encryption()<br>elite = RHODES_ELITE()<br>elite.output()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Ash = &quot;</span>, elite.<span class="hljs-built_in">next</span>())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;SliverAsh = &quot;</span>, elite.<span class="hljs-built_in">next</span>())<br>W = <span class="hljs-string">b&#x27;&#x27;</span>.join([long_to_bytes(sha_flag[i] % (seed ** <span class="hljs-number">3</span>) ^ (elite.<span class="hljs-built_in">next</span>() % <span class="hljs-number">100</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(sha_flag))])<br><span class="hljs-built_in">print</span>(bytes_to_long(W))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Amiya =  956366446278</span><br><span class="hljs-string">Rosmontis =  1061992537343</span><br><span class="hljs-string">Blaze =  636205571590</span><br><span class="hljs-string">Doctor =  18068433704538283397</span><br><span class="hljs-string">Ash =  1097363493609113</span><br><span class="hljs-string">SliverAsh =  2051431344160327</span><br><span class="hljs-string">1920358673646340365826516899186299898354902389402251443712585240681673718967552394250439615271108958695077816395789102908554482423707690040360881719002797624203057223577713119411615697309430781610828105111854807558984242631896605944487456402584672441464316236703857236007195673926937583757881853655505218912262929700452404084</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>è·Ÿä¸Šä¸€é¢˜ç›¸å·®ä¸å¤§ï¼ŒåŒæ ·å¯ä»¥è¿›è¡ŒäºŒå…ƒcopperæˆ–çˆ†ç ´æ±‚å‡º $seed1,seed2$ ï¼Œä¸è¿‡è¿˜è¦æ±‚å‡º $seed$ã€‚</p><p>äºŒå…ƒcopperå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">import</span> itertools<br><br>Amiya = <span class="hljs-number">956366446278</span><br>Rosmontis = <span class="hljs-number">1061992537343</span><br>Blaze = <span class="hljs-number">636205571590</span><br>Doctor = <span class="hljs-number">18068433704538283397</span><br>Ash = <span class="hljs-number">1097363493609113</span><br>SliverAsh = <span class="hljs-number">2051431344160327</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">small_roots</span>(<span class="hljs-params">f, bounds, m=<span class="hljs-number">1</span>, d=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> d:<br>        d = f.degree()<br>    R = f.base_ring()<br>    N = R.cardinality()<br>    f /= f.coefficients().pop(<span class="hljs-number">0</span>)<br>    f = f.change_ring(ZZ)<br>    G = <span class="hljs-type">Sequence</span>([], f.parent())<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m+<span class="hljs-number">1</span>):<br>        base = N^(m-i) * f^i<br>        <span class="hljs-keyword">for</span> shifts <span class="hljs-keyword">in</span> itertools.product(<span class="hljs-built_in">range</span>(d), repeat=f.nvariables()):<br>            g = base * prod(<span class="hljs-built_in">map</span>(power, f.variables(), shifts))<br>            G.append(g)<br>    B, monomials = G.coefficient_matrix()<br>    monomials = vector(monomials)<br>    factors = [monomial(*bounds) <span class="hljs-keyword">for</span> monomial <span class="hljs-keyword">in</span> monomials]<br>    <span class="hljs-keyword">for</span> i, factor <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(factors):<br>        B.rescale_col(i, factor)<br>    B = B.dense_matrix().LLL()<br>    B = B.change_ring(QQ)<br>    <span class="hljs-keyword">for</span> i, factor <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(factors):<br>        B.rescale_col(i, <span class="hljs-number">1</span>/factor)<br>    H = <span class="hljs-type">Sequence</span>([], f.parent().change_ring(QQ))<br>    <span class="hljs-keyword">for</span> h <span class="hljs-keyword">in</span> <span class="hljs-built_in">filter</span>(<span class="hljs-literal">None</span>, B*monomials):<br>        H.append(h)<br>        I = H.ideal()<br>        <span class="hljs-keyword">if</span> I.dimension() == -<span class="hljs-number">1</span>:<br>            H.pop()<br>        <span class="hljs-keyword">elif</span> I.dimension() == <span class="hljs-number">0</span>:<br>            roots = []<br>            <span class="hljs-keyword">for</span> root <span class="hljs-keyword">in</span> I.variety(ring=ZZ):<br>                root = <span class="hljs-built_in">tuple</span>(R(root[var]) <span class="hljs-keyword">for</span> var <span class="hljs-keyword">in</span> f.variables())<br>                roots.append(root)<br>            <span class="hljs-keyword">return</span> roots<br>    <span class="hljs-keyword">return</span> []<br><br>R.&lt;x1,x2&gt; = PolynomialRing(Zmod(Doctor))<br>f = Amiya*(Ash*<span class="hljs-number">2</span>^<span class="hljs-number">12</span>+x2)^<span class="hljs-number">2</span> + Rosmontis*(Ash*<span class="hljs-number">2</span>^<span class="hljs-number">12</span>+x2) + Blaze - (SliverAsh*<span class="hljs-number">2</span>^<span class="hljs-number">12</span>+x1)<br>result = small_roots(f,[<span class="hljs-number">2</span>^<span class="hljs-number">12</span>, <span class="hljs-number">2</span>^<span class="hljs-number">12</span>],m =<span class="hljs-number">4</span>,d=<span class="hljs-number">4</span>)<br><span class="hljs-comment">#[(1695, 3324)]ï¼ŒéªŒè¯äº†ä¸€ä¸‹ï¼Œæ˜¯å¯¹çš„</span><br>low_Ash, low_Sli = result[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>],result[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br><span class="hljs-comment">#print(low_Ash)</span><br><span class="hljs-comment">#print(low_Sli)</span><br><br>seed1 = (Ash&lt;&lt;<span class="hljs-number">12</span>)+low_Ash<br>seed2 = (SliverAsh&lt;&lt;<span class="hljs-number">12</span>)+low_Sli<br><br>R.&lt;x&gt; = PolynomialRing(Zmod(Doctor))<br>f = Amiya*x^<span class="hljs-number">2</span> + Rosmontis*x + Blaze - seed1<br>x0 = f.monic().roots()<br><span class="hljs-built_in">print</span>(x0)<br><span class="hljs-comment">#[(12358488364449364025, 1), (626844643882, 1)]</span><br></code></pre></td></tr></table></figure><p>æ ¹æ® $seed$ çš„èŒƒå›´ç­›é€‰å‡º $seed$ ã€‚</p><p>è¿˜æœ‰ä¸ªéº»çƒ¦å°±æ˜¯ä¸æ¸…æ¥šåŠ å¯†çš„æ—¶å€™æœ‰å¤šå°‘ç»„ã€‚ä½†å¯ä»¥æ ¹æ® $seed$ æ¥åˆ¤æ–­ã€‚$seed$ 40bitï¼Œä¸‰æ¬¡æ–¹å°±120bitï¼Œæ•…<code>long_to_bytes</code>ä¹‹åå°±æ˜¯15bytesä¸€ç»„ï¼Œè€Œ $W$ è½¬å­—èŠ‚åæ­£å¥½æ˜¯135bytesï¼Œæ•…åˆ†ä¸º9ç»„ã€‚</p><p>å‰©ä¸‹çš„å°±æ˜¯çˆ†ç ´äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><br>table = <span class="hljs-string">&#x27;0123456789abcdef-&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">SHA256_decrypt</span>(<span class="hljs-params">state,seed,data</span>):<br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> table:<br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> table:<br>            <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> table:<br>                <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> table:<br>                    b_string = (a+b+c+d).encode()<br>                    sha = sha256(b_string).hexdigest().encode()<br>                    sha_flag = bytes_to_long(sha)<br>                    <span class="hljs-keyword">if</span> long_to_bytes((sha_flag % (seed ** <span class="hljs-number">3</span>)) ^ (state % <span class="hljs-number">100</span>)) == data:<br>                        <span class="hljs-built_in">print</span>(b_string)<br>                        <span class="hljs-keyword">return</span> b_string<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RHODES_ELITE</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,Doctor,Amiya,Rosmontis,Blaze,seed</span>):<br>        self.Doctor = Doctor<br>        self.Amiya = Amiya<br>        self.Rosmontis = Rosmontis<br>        self.Blaze = Blaze<br>        self.seed = seed<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">self</span>):<br>        self.seed = (self.Amiya * self.seed * self.seed + self.Rosmontis * self.seed + self.Blaze) % self.Doctor<br>        <span class="hljs-keyword">return</span> self.seed &gt;&gt; <span class="hljs-number">12</span><br><br>Amiya = <span class="hljs-number">956366446278</span><br>Rosmontis = <span class="hljs-number">1061992537343</span><br>Blaze = <span class="hljs-number">636205571590</span><br>Doctor = <span class="hljs-number">18068433704538283397</span><br>Ash = <span class="hljs-number">1097363493609113</span><br>SliverAsh = <span class="hljs-number">2051431344160327</span><br>W = <span class="hljs-number">1920358673646340365826516899186299898354902389402251443712585240681673718967552394250439615271108958695077816395789102908554482423707690040360881719002797624203057223577713119411615697309430781610828105111854807558984242631896605944487456402584672441464316236703857236007195673926937583757881853655505218912262929700452404084</span><br>W = long_to_bytes(W)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(W))<br>W = [W[i:i+<span class="hljs-number">15</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">135</span>,<span class="hljs-number">15</span>)]<br><br>low_Ash = <span class="hljs-number">3324</span><br>low_Sli = <span class="hljs-number">1695</span><br>seed = <span class="hljs-number">626844643882</span><br>seed1 = (Ash&lt;&lt;<span class="hljs-number">12</span>)+low_Ash<br>seed2 = (SliverAsh&lt;&lt;<span class="hljs-number">12</span>)+low_Sli<br><br>elite = RHODES_ELITE(Doctor,Amiya,Rosmontis,Blaze,seed2)<br><br>flag = <span class="hljs-string">b&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> tqdm(W):<br>     state = elite.<span class="hljs-built_in">next</span>()<br>     flag += SHA256_decrypt(state,seed,each)<br><br><span class="hljs-built_in">print</span>(flag)<br><span class="hljs-comment">#b&#x27;d2a4d1af-8a80-8794-99ac-635f89494cac&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="Bag"><a href="#Bag" class="headerlink" title="Bag"></a>Bag</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><br>message = bytes_to_long(flag[<span class="hljs-number">8</span>:-<span class="hljs-number">1</span>])<br>Baglenth=<span class="hljs-number">286</span><br>Bag=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">12</span>, <span class="hljs-number">24</span>, <span class="hljs-number">48</span>, <span class="hljs-number">96</span>, <span class="hljs-number">192</span>, <span class="hljs-number">384</span>, <span class="hljs-number">768</span>, <span class="hljs-number">1536</span>, <span class="hljs-number">3072</span>, <span class="hljs-number">6144</span>, <span class="hljs-number">12288</span>, <span class="hljs-number">24576</span>, <span class="hljs-number">49152</span>, <span class="hljs-number">98304</span>, <span class="hljs-number">196608</span>, <span class="hljs-number">393216</span>, <span class="hljs-number">786432</span>, <span class="hljs-number">1572864</span>, <span class="hljs-number">3145728</span>, <span class="hljs-number">6291456</span>, <span class="hljs-number">12582912</span>, <span class="hljs-number">25165824</span>, <span class="hljs-number">50331648</span>, <span class="hljs-number">100663296</span>, <span class="hljs-number">201326592</span>, <span class="hljs-number">402653184</span>, <span class="hljs-number">805306368</span>, <span class="hljs-number">1610612736</span>, <span class="hljs-number">3221225472</span>, <span class="hljs-number">6442450944</span>, <span class="hljs-number">12884901888</span>, <span class="hljs-number">25769803776</span>, <span class="hljs-number">51539607552</span>, <span class="hljs-number">103079215104</span>, <span class="hljs-number">206158430208</span>, <span class="hljs-number">412316860416</span>, <span class="hljs-number">824633720832</span>, <span class="hljs-number">1649267441664</span>, <span class="hljs-number">3298534883328</span>, <span class="hljs-number">6597069766656</span>, <span class="hljs-number">13194139533312</span>, <span class="hljs-number">26388279066624</span>, <span class="hljs-number">52776558133248</span>, <span class="hljs-number">105553116266496</span>, <span class="hljs-number">211106232532992</span>, <span class="hljs-number">422212465065984</span>, <span class="hljs-number">844424930131968</span>, <span class="hljs-number">1688849860263936</span>, <span class="hljs-number">3377699720527872</span>, <span class="hljs-number">6755399441055744</span>, <span class="hljs-number">13510798882111488</span>, <span class="hljs-number">27021597764222976</span>, <span class="hljs-number">54043195528445952</span>, <span class="hljs-number">108086391056891904</span>, <span class="hljs-number">216172782113783808</span>, <span class="hljs-number">432345564227567616</span>, <span class="hljs-number">864691128455135232</span>, <span class="hljs-number">1729382256910270464</span>, <span class="hljs-number">3458764513820540928</span>, <span class="hljs-number">6917529027641081856</span>, <span class="hljs-number">13835058055282163712</span>, <span class="hljs-number">27670116110564327424</span>, <span class="hljs-number">55340232221128654848</span>, <span class="hljs-number">110680464442257309696</span>, <span class="hljs-number">221360928884514619392</span>, <span class="hljs-number">442721857769029238784</span>, <span class="hljs-number">885443715538058477568</span>, <span class="hljs-number">1770887431076116955136</span>, <span class="hljs-number">3541774862152233910272</span>, <span class="hljs-number">7083549724304467820544</span>, <span class="hljs-number">14167099448608935641088</span>, <span class="hljs-number">28334198897217871282176</span>, <span class="hljs-number">56668397794435742564352</span>, <span class="hljs-number">113336795588871485128704</span>, <span class="hljs-number">226673591177742970257408</span>, <span class="hljs-number">453347182355485940514816</span>, <span class="hljs-number">906694364710971881029632</span>, <span class="hljs-number">1813388729421943762059264</span>, <span class="hljs-number">3626777458843887524118528</span>, <span class="hljs-number">7253554917687775048237056</span>, <span class="hljs-number">14507109835375550096474112</span>, <span class="hljs-number">29014219670751100192948224</span>, <span class="hljs-number">58028439341502200385896448</span>, <span class="hljs-number">116056878683004400771792896</span>, <span class="hljs-number">232113757366008801543585792</span>, <span class="hljs-number">464227514732017603087171584</span>, <span class="hljs-number">928455029464035206174343168</span>, <span class="hljs-number">1856910058928070412348686336</span>, <span class="hljs-number">3713820117856140824697372672</span>, <span class="hljs-number">7427640235712281649394745344</span>, <span class="hljs-number">14855280471424563298789490688</span>, <span class="hljs-number">29710560942849126597578981376</span>, <span class="hljs-number">59421121885698253195157962752</span>, <span class="hljs-number">118842243771396506390315925504</span>, <span class="hljs-number">237684487542793012780631851008</span>, <span class="hljs-number">475368975085586025561263702016</span>, <span class="hljs-number">950737950171172051122527404032</span>, <span class="hljs-number">1901475900342344102245054808064</span>, <span class="hljs-number">3802951800684688204490109616128</span>, <span class="hljs-number">7605903601369376408980219232256</span>, <span class="hljs-number">15211807202738752817960438464512</span>, <span class="hljs-number">30423614405477505635920876929024</span>, <span class="hljs-number">60847228810955011271841753858048</span>, <span class="hljs-number">121694457621910022543683507716096</span>, <span class="hljs-number">243388915243820045087367015432192</span>, <span class="hljs-number">486777830487640090174734030864384</span>, <span class="hljs-number">973555660975280180349468061728768</span>, <span class="hljs-number">1947111321950560360698936123457536</span>, <span class="hljs-number">3894222643901120721397872246915072</span>, <span class="hljs-number">7788445287802241442795744493830144</span>, <span class="hljs-number">15576890575604482885591488987660288</span>, <span class="hljs-number">31153781151208965771182977975320576</span>, <span class="hljs-number">62307562302417931542365955950641152</span>, <span class="hljs-number">124615124604835863084731911901282304</span>, <span class="hljs-number">249230249209671726169463823802564608</span>, <span class="hljs-number">498460498419343452338927647605129216</span>, <span class="hljs-number">996920996838686904677855295210258432</span>, <span class="hljs-number">1993841993677373809355710590420516864</span>, <span class="hljs-number">3987683987354747618711421180841033728</span>, <span class="hljs-number">7975367974709495237422842361682067456</span>, <span class="hljs-number">15950735949418990474845684723364134912</span>, <span class="hljs-number">31901471898837980949691369446728269824</span>, <span class="hljs-number">63802943797675961899382738893456539648</span>, <span class="hljs-number">127605887595351923798765477786913079296</span>, <span class="hljs-number">255211775190703847597530955573826158592</span>, <span class="hljs-number">510423550381407695195061911147652317184</span>, <span class="hljs-number">1020847100762815390390123822295304634368</span>, <span class="hljs-number">2041694201525630780780247644590609268736</span>, <span class="hljs-number">4083388403051261561560495289181218537472</span>, <span class="hljs-number">8166776806102523123120990578362437074944</span>, <span class="hljs-number">16333553612205046246241981156724874149888</span>, <span class="hljs-number">32667107224410092492483962313449748299776</span>, <span class="hljs-number">65334214448820184984967924626899496599552</span>, <span class="hljs-number">130668428897640369969935849253798993199104</span>, <span class="hljs-number">261336857795280739939871698507597986398208</span>, <span class="hljs-number">522673715590561479879743397015195972796416</span>, <span class="hljs-number">1045347431181122959759486794030391945592832</span>, <span class="hljs-number">2090694862362245919518973588060783891185664</span>, <span class="hljs-number">4181389724724491839037947176121567782371328</span>, <span class="hljs-number">8362779449448983678075894352243135564742656</span>, <span class="hljs-number">16725558898897967356151788704486271129485312</span>, <span class="hljs-number">33451117797795934712303577408972542258970624</span>, <span class="hljs-number">66902235595591869424607154817945084517941248</span>, <span class="hljs-number">133804471191183738849214309635890169035882496</span>, <span class="hljs-number">267608942382367477698428619271780338071764992</span>, <span class="hljs-number">535217884764734955396857238543560676143529984</span>, <span class="hljs-number">1070435769529469910793714477087121352287059968</span>, <span class="hljs-number">2140871539058939821587428954174242704574119936</span>, <span class="hljs-number">4281743078117879643174857908348485409148239872</span>, <span class="hljs-number">8563486156235759286349715816696970818296479744</span>, <span class="hljs-number">17126972312471518572699431633393941636592959488</span>, <span class="hljs-number">34253944624943037145398863266787883273185918976</span>, <span class="hljs-number">68507889249886074290797726533575766546371837952</span>, <span class="hljs-number">137015778499772148581595453067151533092743675904</span>, <span class="hljs-number">274031556999544297163190906134303066185487351808</span>, <span class="hljs-number">548063113999088594326381812268606132370974703616</span>, <span class="hljs-number">1096126227998177188652763624537212264741949407232</span>, <span class="hljs-number">2192252455996354377305527249074424529483898814464</span>, <span class="hljs-number">4384504911992708754611054498148849058967797628928</span>, <span class="hljs-number">8769009823985417509222108996297698117935595257856</span>, <span class="hljs-number">17538019647970835018444217992595396235871190515712</span>, <span class="hljs-number">35076039295941670036888435985190792471742381031424</span>, <span class="hljs-number">70152078591883340073776871970381584943484762062848</span>, <span class="hljs-number">140304157183766680147553743940763169886969524125696</span>, <span class="hljs-number">280608314367533360295107487881526339773939048251392</span>, <span class="hljs-number">561216628735066720590214975763052679547878096502784</span>, <span class="hljs-number">1122433257470133441180429951526105359095756193005568</span>, <span class="hljs-number">2244866514940266882360859903052210718191512386011136</span>, <span class="hljs-number">4489733029880533764721719806104421436383024772022272</span>, <span class="hljs-number">8979466059761067529443439612208842872766049544044544</span>, <span class="hljs-number">17958932119522135058886879224417685745532099088089088</span>, <span class="hljs-number">35917864239044270117773758448835371491064198176178176</span>, <span class="hljs-number">71835728478088540235547516897670742982128396352356352</span>, <span class="hljs-number">143671456956177080471095033795341485964256792704712704</span>, <span class="hljs-number">287342913912354160942190067590682971928513585409425408</span>, <span class="hljs-number">574685827824708321884380135181365943857027170818850816</span>, <span class="hljs-number">1149371655649416643768760270362731887714054341637701632</span>, <span class="hljs-number">2298743311298833287537520540725463775428108683275403264</span>, <span class="hljs-number">4597486622597666575075041081450927550856217366550806528</span>, <span class="hljs-number">9194973245195333150150082162901855101712434733101613056</span>, <span class="hljs-number">18389946490390666300300164325803710203424869466203226112</span>, <span class="hljs-number">36779892980781332600600328651607420406849738932406452224</span>, <span class="hljs-number">73559785961562665201200657303214840813699477864812904448</span>, <span class="hljs-number">147119571923125330402401314606429681627398955729625808896</span>, <span class="hljs-number">294239143846250660804802629212859363254797911459251617792</span>, <span class="hljs-number">588478287692501321609605258425718726509595822918503235584</span>, <span class="hljs-number">1176956575385002643219210516851437453019191645837006471168</span>, <span class="hljs-number">2353913150770005286438421033702874906038383291674012942336</span>, <span class="hljs-number">4707826301540010572876842067405749812076766583348025884672</span>, <span class="hljs-number">9415652603080021145753684134811499624153533166696051769344</span>, <span class="hljs-number">18831305206160042291507368269622999248307066333392103538688</span>, <span class="hljs-number">37662610412320084583014736539245998496614132666784207077376</span>, <span class="hljs-number">75325220824640169166029473078491996993228265333568414154752</span>, <span class="hljs-number">150650441649280338332058946156983993986456530667136828309504</span>, <span class="hljs-number">301300883298560676664117892313967987972913061334273656619008</span>, <span class="hljs-number">602601766597121353328235784627935975945826122668547313238016</span>, <span class="hljs-number">1205203533194242706656471569255871951891652245337094626476032</span>, <span class="hljs-number">2410407066388485413312943138511743903783304490674189252952064</span>, <span class="hljs-number">4820814132776970826625886277023487807566608981348378505904128</span>, <span class="hljs-number">9641628265553941653251772554046975615133217962696757011808256</span>, <span class="hljs-number">19283256531107883306503545108093951230266435925393514023616512</span>, <span class="hljs-number">38566513062215766613007090216187902460532871850787028047233024</span>, <span class="hljs-number">77133026124431533226014180432375804921065743701574056094466048</span>, <span class="hljs-number">154266052248863066452028360864751609842131487403148112188932096</span>, <span class="hljs-number">308532104497726132904056721729503219684262974806296224377864192</span>, <span class="hljs-number">617064208995452265808113443459006439368525949612592448755728384</span>, <span class="hljs-number">1234128417990904531616226886918012878737051899225184897511456768</span>, <span class="hljs-number">2468256835981809063232453773836025757474103798450369795022913536</span>, <span class="hljs-number">4936513671963618126464907547672051514948207596900739590045827072</span>, <span class="hljs-number">9873027343927236252929815095344103029896415193801479180091654144</span>, <span class="hljs-number">19746054687854472505859630190688206059792830387602958360183308288</span>, <span class="hljs-number">39492109375708945011719260381376412119585660775205916720366616576</span>, <span class="hljs-number">78984218751417890023438520762752824239171321550411833440733233152</span>, <span class="hljs-number">157968437502835780046877041525505648478342643100823666881466466304</span>, <span class="hljs-number">315936875005671560093754083051011296956685286201647333762932932608</span>, <span class="hljs-number">631873750011343120187508166102022593913370572403294667525865865216</span>, <span class="hljs-number">1263747500022686240375016332204045187826741144806589335051731730432</span>, <span class="hljs-number">2527495000045372480750032664408090375653482289613178670103463460864</span>, <span class="hljs-number">5054990000090744961500065328816180751306964579226357340206926921728</span>, <span class="hljs-number">10109980000181489923000130657632361502613929158452714680413853843456</span>, <span class="hljs-number">20219960000362979846000261315264723005227858316905429360827707686912</span>, <span class="hljs-number">40439920000725959692000522630529446010455716633810858721655415373824</span>, <span class="hljs-number">80879840001451919384001045261058892020911433267621717443310830747648</span>, <span class="hljs-number">161759680002903838768002090522117784041822866535243434886621661495296</span>, <span class="hljs-number">323519360005807677536004181044235568083645733070486869773243322990592</span>, <span class="hljs-number">647038720011615355072008362088471136167291466140973739546486645981184</span>, <span class="hljs-number">1294077440023230710144016724176942272334582932281947479092973291962368</span>, <span class="hljs-number">2588154880046461420288033448353884544669165864563894958185946583924736</span>, <span class="hljs-number">5176309760092922840576066896707769089338331729127789916371893167849472</span>, <span class="hljs-number">10352619520185845681152133793415538178676663458255579832743786335698944</span>, <span class="hljs-number">20705239040371691362304267586831076357353326916511159665487572671397888</span>, <span class="hljs-number">41410478080743382724608535173662152714706653833022319330975145342795776</span>, <span class="hljs-number">82820956161486765449217070347324305429413307666044638661950290685591552</span>, <span class="hljs-number">165641912322973530898434140694648610858826615332089277323900581371183104</span>, <span class="hljs-number">331283824645947061796868281389297221717653230664178554647801162742366208</span>, <span class="hljs-number">662567649291894123593736562778594443435306461328357109295602325484732416</span>, <span class="hljs-number">1325135298583788247187473125557188886870612922656714218591204650969464832</span>, <span class="hljs-number">2650270597167576494374946251114377773741225845313428437182409301938929664</span>, <span class="hljs-number">5300541194335152988749892502228755547482451690626856874364818603877859328</span>, <span class="hljs-number">10601082388670305977499785004457511094964903381253713748729637207755718656</span>, <span class="hljs-number">21202164777340611954999570008915022189929806762507427497459274415511437312</span>, <span class="hljs-number">42404329554681223909999140017830044379859613525014854994918548831022874624</span>, <span class="hljs-number">84808659109362447819998280035660088759719227050029709989837097662045749248</span>, <span class="hljs-number">169617318218724895639996560071320177519438454100059419979674195324091498496</span>, <span class="hljs-number">339234636437449791279993120142640355038876908200118839959348390648182996992</span>, <span class="hljs-number">678469272874899582559986240285280710077753816400237679918696781296365993984</span>, <span class="hljs-number">1356938545749799165119972480570561420155507632800475359837393562592731987968</span>, <span class="hljs-number">2713877091499598330239944961141122840311015265600950719674787125185463975936</span>, <span class="hljs-number">5427754182999196660479889922282245680622030531201901439349574250370927951872</span>, <span class="hljs-number">10855508365998393320959779844564491361244061062403802878699148500741855903744</span>, <span class="hljs-number">21711016731996786641919559689128982722488122124807605757398297001483711807488</span>, <span class="hljs-number">43422033463993573283839119378257965444976244249615211514796594002967423614976</span>, <span class="hljs-number">86844066927987146567678238756515930889952488499230423029593188005934847229952</span>, <span class="hljs-number">173688133855974293135356477513031861779904976998460846059186376011869694459904</span>, <span class="hljs-number">347376267711948586270712955026063723559809953996921692118372752023739388919808</span>, <span class="hljs-number">694752535423897172541425910052127447119619907993843384236745504047478777839616</span>, <span class="hljs-number">1389505070847794345082851820104254894239239815987686768473491008094957555679232</span>, <span class="hljs-number">2779010141695588690165703640208509788478479631975373536946982016189915111358464</span>, <span class="hljs-number">5558020283391177380331407280417019576956959263950747073893964032379830222716928</span>, <span class="hljs-number">11116040566782354760662814560834039153913918527901494147787928064759660445433856</span>, <span class="hljs-number">22232081133564709521325629121668078307827837055802988295575856129519320890867712</span>, <span class="hljs-number">44464162267129419042651258243336156615655674111605976591151712259038641781735424</span>, <span class="hljs-number">88928324534258838085302516486672313231311348223211953182303424518077283563470848</span>, <span class="hljs-number">177856649068517676170605032973344626462622696446423906364606849036154567126941696</span>, <span class="hljs-number">355713298137035352341210065946689252925245392892847812729213698072309134253883392</span>, <span class="hljs-number">711426596274070704682420131893378505850490785785695625458427396144618268507766784</span>, <span class="hljs-number">1422853192548141409364840263786757011700981571571391250916854792289236537015533568</span>, <span class="hljs-number">2845706385096282818729680527573514023401963143142782501833709584578473074031067136</span>, <span class="hljs-number">5691412770192565637459361055147028046803926286285565003667419169156946148062134272</span>, <span class="hljs-number">11382825540385131274918722110294056093607852572571130007334838338313892296124268544</span>, <span class="hljs-number">22765651080770262549837444220588112187215705145142260014669676676627784592248537088</span>, <span class="hljs-number">45531302161540525099674888441176224374431410290284520029339353353255569184497074176</span>, <span class="hljs-number">91062604323081050199349776882352448748862820580569040058678706706511138368994148352</span>, <span class="hljs-number">182125208646162100398699553764704897497725641161138080117357413413022276737988296704</span>, <span class="hljs-number">364250417292324200797399107529409794995451282322276160234714826826044553475976593408</span>, <span class="hljs-number">728500834584648401594798215058819589990902564644552320469429653652089106951953186816</span>, <span class="hljs-number">1457001669169296803189596430117639179981805129289104640938859307304178213903906373632</span>, <span class="hljs-number">2914003338338593606379192860235278359963610258578209281877718614608356427807812747264</span>, <span class="hljs-number">5828006676677187212758385720470556719927220517156418563755437229216712855615625494528</span>, <span class="hljs-number">11656013353354374425516771440941113439854441034312837127510874458433425711231250989056</span>, <span class="hljs-number">23312026706708748851033542881882226879708882068625674255021748916866851422462501978112</span>, <span class="hljs-number">46624053413417497702067085763764453759417764137251348510043497833733702844925003956224</span>, <span class="hljs-number">93248106826834995404134171527528907518835528274502697020086995667467405689850007912448</span>, <span class="hljs-number">186496213653669990808268343055057815037671056549005394040173991334934811379700015824896</span>]<br>Bag=Bag[::-<span class="hljs-number">1</span>]<br>m=<span class="hljs-number">372992427307339981616536686110115630075342113098010788080347982669869622759400031649792</span><br>w=<span class="hljs-number">274062421102700155372289583695782343443</span><br><br><span class="hljs-keyword">assert</span> gmpy2.gcd(m,w)==<span class="hljs-number">1</span><br>h=<span class="hljs-number">0</span><br>j=<span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> m.bit_length()%<span class="hljs-number">2</span>==<span class="hljs-number">0</span>:<br>    h=m.bit_length()<br>    j=<span class="hljs-built_in">int</span>(h//<span class="hljs-number">2</span>)<br><span class="hljs-keyword">else</span>:<br>    h=m.bit_length()<br>    j=<span class="hljs-built_in">int</span>(h//<span class="hljs-number">2</span>+<span class="hljs-number">1</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pad</span>(<span class="hljs-params">m,lenth</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(m)&lt;lenth:<br>        m=<span class="hljs-string">&#x27;0&#x27;</span>+m<br>    <span class="hljs-keyword">return</span> m<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">keygen</span>():<br>    pk=[]<br>    sk=[]<br>    sk.append(m)<br>    sk.append(<span class="hljs-built_in">int</span>(gmpy2.invert(w,m)))<br>    D=[]<br>    binD=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(Baglenth):<br>        di=(w*Bag[i])%m<br>        D.append(di)<br>        bindi=<span class="hljs-built_in">bin</span>(di)[<span class="hljs-number">2</span>:]<br>        bindi=pad(bindi,h)<br>        binD.append(bindi)<br>    U=[]<br>    V=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(Baglenth):<br>        tempu=<span class="hljs-built_in">int</span>(<span class="hljs-built_in">str</span>(binD[i][:j]),<span class="hljs-number">2</span>)<br>        U.append(tempu)<br>        tempv=<span class="hljs-built_in">int</span>(<span class="hljs-built_in">str</span>(binD[i][j:]),<span class="hljs-number">2</span>)<br>        V.append(tempv)<br>    e=gmpy2.next_prime(<span class="hljs-built_in">sum</span>(V))+<span class="hljs-number">2</span><br>    f=gmpy2.next_prime(<span class="hljs-built_in">sum</span>(U))<br>    <span class="hljs-keyword">assert</span> gmpy2.gcd(e,f)==<span class="hljs-number">1</span><br>    sk.append(<span class="hljs-built_in">int</span>(e))<br>    sk.append(<span class="hljs-built_in">int</span>(f))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(Baglenth):<br>        ai=e*U[i]+f*V[i]<br>        pk.append(<span class="hljs-built_in">int</span>(ai))<br>    <span class="hljs-keyword">return</span> pk,sk<br><br>Pk,Sk=keygen()<br><span class="hljs-built_in">print</span>(Pk)<br><span class="hljs-built_in">print</span>(Sk)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Encrypt</span>(<span class="hljs-params">plain,pk</span>):<br>    mbin=<span class="hljs-built_in">bin</span>(plain)[<span class="hljs-number">2</span>:]<br>    c=<span class="hljs-number">0</span><br>    mbin=pad(mbin,Baglenth)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(Baglenth):<br>        c=c+<span class="hljs-built_in">int</span>(mbin[i])*pk[i]<br>    <span class="hljs-keyword">return</span> c<br><br>c=Encrypt(message,Pk)<br><span class="hljs-built_in">print</span>(c)<br><br><span class="hljs-comment"># [13427720507293490146512325883268574617159432219330328705146993381673927145360640901644288, 20141580760940235219768488824902861925739148328995493057720490072510890718040961352466432, 10070790380470117609884244412451430962869574164497746528860245036255445359020480676233216, 5035395190235058804942122206225715481434787082248873264430122518127722679510240338116608, 15945418102411019548983386986381432357876825760454765337362054640737788485115761070702592, 7972709051205509774491693493190716178938412880227382668681027320368894242557880535351296, 3986354525602754887245846746595358089469206440113691334340513660184447121278940267675648, 1993177262801377443622923373297679044734603220056845667170256830092223560639470133837824, 14424309138694178868323787569917414139526733829358751538732121796720038925680375968563200, 20639875076640579580674219668227281686922799134009704474513054280033946608200828885925888, 10319937538320289790337109834113640843461399567004852237256527140016973304100414442962944, 5159968769160144895168554917056820421730699783502426118628263570008486652050207221481472, 16007704891873562594096603341796984828024782111081541764461125166678170471385744512385024, 21431572953230271443560627554167067031171823274871099587377555965013012381053513157836800, 24143506983908625868292639660352108132745343856765878498835771364180433335887397480562688, 25499473999247803080658645713444628683532104147713267954564879063764143813304339641925632, 26177457506917391686841648739990888958925484293186962682429432913555999052012810722607104, 13088728753458695843420824369995444479462742146593481341214716456777999526006405361303552, 6544364376729347921710412184997722239731371073296740670607358228388999763003202680651776, 16699902695658164107367531975767435737025117755978699040450672495868427026862242241970176, 8349951347829082053683765987883717868512558877989349520225336247934213513431121120985088, 4174975673914541026841882993941858934256279438994674760112668123967106756715560560492544, 2087487836957270513420941496970929467128139719497337380056334061983553378357780280246272, 1043743918478635256710470748485464733564069859748668690028167030991776689178890140123136, 521871959239317628355235374242732366782034929874334345014083515495888344589445070061568, 260935979619658814177617687121366183391017464937167172507041757747944172294722535030784, 13558188497103319553601134726829257708854940951798912291400514260547899231508002169159680, 20206814755845149923312893246683203471586902695229784850847250511947876761114641986224128, 23531127885216065108168772506610176352952883566945221130570618637647865525917961894756352, 25193284449901522700596712136573662793635874002802939270432302700497859908319621849022464, 12596642224950761350298356068286831396817937001401469635216151350248929954159810924511232, 6298321112475380675149178034143415698408968500700734817608075675124464977079905462255616, 16576881063531180484086914900340282466363916469680696113951031219236159633900593632772096, 21716161039059080388555783333438715850341390454170676762122508991292006962310937718030336, 10858080519529540194277891666719357925170695227085338381061254495646003481155468859015168, 5429040259764770097138945833359678962585347613542669190530627247823001740577734429507584, 2714520129882385048569472916679839481292673806771334595265313623911500870288867214753792, 1357260064941192524284736458339919740646336903385667297632656811955750435144433607376896, 678630032470596262142368229169959870323168451692833648816328405977875217572216803688448, 13767035523528788277583509997853554552321016445176745529555157584662864754146749303488512, 6883517761764394138791754998926777276160508222588372764777578792331432377073374651744256, 16869479388175687215908203382731963255239686330624515087535782777839643333897328227516416, 8434739694087843607954101691365981627619843165312257543767891388919821666948664113758208, 4217369847043921803977050845682990813809921582656128771883945694459910833474332056879104, 2108684923521960901988525422841495406904960791328064385941972847229955416737166028439552, 1054342461760980450994262711420747703452480395664032192970986423614977708368583014219776, 527171230880490225497131355710373851726240197832016096485493211807488854184291507109888, 13691306122733735259260891561123761543022552318246336753389739987577671572452786655199232, 20273373568660357776142771663830455388670708378453497081841863375462762931587034229243904, 10136686784330178888071385831915227694335354189226748540920931687731381465793517114621952, 18496063899458579590548018799226188464327109313943702975607459225539617878257399458955264, 9248031949729289795274009399613094232163554656971851487803729612769808939128699729477632, 4624015974864644897637004699806547116081777328485925743901864806384904469564349864738816, 2312007987432322448818502349903273558040888664242962871950932403192452234782174932369408, 14583724501009651370921577058220211396179876551451810141122459583270153262751728367828992, 7291862250504825685460788529110105698089938275725905070561229791635076631375864183914496, 3645931125252412842730394264555052849044969137862952535280614895817538315687932091957248, 15250686069919696567877523015546101041681916788261804972787300829582696303204606947622912, 7625343034959848283938761507773050520840958394130902486393650414791348151602303473811456, 17240392024773414288481706637155099877579911416395779948343818589069601221161792638550016, 22047916519680197290753179201846124555949387927528218679318902676208727755941537220919296, 24451678767133588791888915484191636895134126183094438044806444719778291023331409512103936, 25653559890860284542456783625364393064726495310877547727550215741563072657026345657696256, 26254500452723632417740717695950771149522679874769102568922101252455463473873813730492416, 26554970733655306355382684731243960191920772156714879989608044007901658882297547766890496, 26705205874121143324203668248890554713119818297687768699951015385624756586509414785089536, 26780323444354061808614160007713851973719341368174213055122501074486305438615348294189056, 13390161722177030904307080003856925986859670684087106527561250537243152719307674147094528, 20122801368382005598665865885197037610589267561373881968927618650295503505014477975191552, 23489121191484492945845258825867093422454066000017269689610802706821678897867879889240064, 11744560595742246472922629412933546711227033000008634844805401353410839448933939944620032, 5872280297871123236461314706466773355613516500004317422402700676705419724466969972310016, 16363860656229051764742983236501961294966190469332487416348343720026637007594125887799296, 8181930328114525882371491618250980647483095234666243708174171860013318503797062943899648, 17518685671350753087698071692394064940900979836663450559234079311680586397259172373594112, 8759342835675376543849035846197032470450489918331725279617039655840293198629586186797056, 17807391925131178418436843806367090852384677178496191344955513209594073744675433995042816, 8903695962565589209218421903183545426192338589248095672477756604797036872337716997521408, 17879568488576284751121536834860347330255601513954376541385871684072445581529499400404992, 8939784244288142375560768417430173665127800756977188270692935842036222790764749700202496, 17897612629437561334292710091983661449723332597818922840493461302692038540743015751745536, 8948806314718780667146355045991830724861666298909461420246730651346019270371507875872768, 4474403157359390333573177522995915362430833149454730710123365325673009635185753937936384, 15664922085973185313298914644766532298374848794057694060208676044510431962953517870612480, 21260181550280082803161783205651840766346856616359175735251331403929143126837399836950528, 24057811282433531548093217486094495000332860527509916572772659083638498708779340820119552, 25456626148510255920558934626315822117325862483085286991533322923493176499750311311704064, 26156033581548618106791793196426485675822363460872972200913654843420515395235796557496320, 26505737298067799199908222481481817455070613949766814805603820803384184842978539180392448, 13252868649033899599954111240740908727535306974883407402801910401692092421489269590196224, 6626434324516949799977055620370454363767653487441703701400955200846046210744634795098112, 3313217162258474899988527810185227181883826743720851850700477600423023105372317397549056, 15084329088422727596506589788361188208101345591190754630497232181885438698046799600418816, 7542164544211363798253294894180594104050672795595377315248616090942719349023399800209408, 3771082272105681899126647447090297052025336397797688657624308045471359674511699900104704, 15313261643346331096075649606813723143172100418229173033959147404409606982616490851696640, 21084351328966655694550150686675436188745482428444915222126567083878730636668886327492608, 10542175664483327847275075343337718094372741214222457611063283541939365318334443163746304, 5271087832241663923637537671668859047186370607111228805531641770969682659167221581873152, 16063264423414322108331094719103004140752617522885943107912814267158768474944251692580864, 21459352719000651200677873242820076687535740980773300259103400515253311382832766747934720, 10729676359500325600338936621410038343767870490386650129551700257626655691416383373967360, 5364838179750162800169468310705019171883935245193325064775850128813327845708191686983680, 16110139597168571546597060038621084203101399841926991237534918446080591068214736745136128, 8055069798584285773298530019310542101550699920963495618767459223040295534107368372568064, 4027534899292142886649265009655271050775349960481747809383729611520147767053684186284032, 2013767449646071443324632504827635525387674980240873904691864805760073883526842093142016, 1006883724823035721662316252413817762693837490120436952345932402880036941763421046571008, 503441862411517860831158126206908881346918745060218476172966201440018470881710523285504, 251720931205758930415579063103454440673459372530109238086483100720009235440855261642752, 125860465602879465207789531551727220336729686265054619043241550360004617720427630821376, 13490650740094929879116220649044438227327797062462856014668614156853929454220854717054976, 6745325370047464939558110324522219113663898531231428007334307078426964727110427358527488, 16800383192317222616291381045529684173991381484946042708814146920887409508915854580908032, 21827912103452101454658016406033416704155122961803350059554066842117631899818568192098304, 24341676559019540873841334086285282969236993700232003734924026802732743095269924997693440, 12170838279509770436920667043142641484618496850116001867462013401366371547634962498846720, 19513139647048375364972659404839895359468680644388329638878000082357112919178122151067648, 9756569823524187682486329702419947679734340322194164819439000041178556459589061075533824, 4878284911762093841243164851209973839867170161097082409719500020589278229794530537766912, 2439142455881046920621582425604986919933585080548541204859750010294639114897265268883456, 14647291735234013606823117096071068077126224759604599307576868386821246702809273536086016, 20751366374910496949923884431304108655722544599132628358935427575084550496765277669687296, 23803403694748738621474268098920628945020704518896642884614707169216202393743279736487936, 11901701847374369310737134049460314472510352259448321442307353584608101196871639868243968, 5950850923687184655368567024730157236255176129724160721153676792304050598435819934121984, 16403145969137082474196609395633653235287020284192409065723831777825952444578550868705280, 21629293491862031383610630581085401234802942361426533238008909270586903367649916335996928, 10814646745931015691805315290542700617401471180713266619004454635293451683824958167998464, 5407323372965507845902657645271350308700735590356633309502227317646725841912479083999232, 2703661686482753922951328822635675154350367795178316654751113658823362920956239541999616, 1351830843241376961475664411317837577175183897589158327375556829411681460478119770999808, 675915421620688480737832205658918788587591948794579163687778414705840730239059885499904, 337957710810344240368916102829459394293795974397289581843889207352920365119529942749952, 168978855405172120184458051414729697146897987198644790921944603676460182559764971374976, 84489427702586060092229025707364848573448993599322395460972301838230091279882485687488, 42244713851293030046114512853682424286724496799661197730486150919115045639941242843744, 21122356925646515023057256426841212143362248399830598865243075459557522819970621421872, 10561178462823257511528628213420606071681124199915299432621537729778761409985310710936, 5280589231411628755764314106710303035840562099957649716310768864889380704992655355468, 2640294615705814377882157053355151517920281049978824858155384432444690352496327677734, 1320147307852907188941078526677575758960140524989412429077692216222345176248163838867, 11376929106527795892898839465621865505177413571970563898745322852504166513570004716585524, 5688464553263897946449419732810932752588706785985281949372661426252083256785002358292762, 2844232276631948973224709866405466376294353392992640974686330713126041628392501179146381, 12798385171189843925916723859561259905445110198204389679873949362959076155178131224239281, 17775461618468791402262730856139156670020488600810264032467758687875593418570946246785731, 20263999842108265140435734354428105052308177802113201208764663350333852050267353758058956, 10131999921054132570217867177214052526154088901056600604382331675166926025133676879029478, 5065999960527066285108933588607026263077044450528300302191165837583463012566838439514739, 13909269013137402581858835720662039848836455726972219343626366925187786847265299854423460, 6954634506568701290929417860331019924418227863486109671813183462593893423632649927211730, 3477317253284350645464708930165509962209113931743054835906591731296946711816324963605865, 13114927659516044762036723391441281698402490467579596610484079872044528696890043116469023, 17933732862631891820322730622079167566499178735497867497772823942418319689426902192900602, 8966866431315945910161365311039583783249589367748933748886411971209159844713451096450301, 15859702248531842394385051581878318608922728185582536066973989992000635263338606182891241, 19306120157139790636496894717297686021759297594499337226017779002396372972651183726111711, 21029329111443764757552816285007369728177582298957737805539673507594241827307472497721946, 10514664555721882378776408142503684864088791149478868902769836753797120913653736248860973, 16633601310734810628692572997610369149342329076447503643915702383294615797808748759096577, 19693069688241274753650655425163711291969098039931821014488635198043363239886255014214379, 21222803876994506816129696638940382363282482521673979699775101605417736960925008141773280, 10611401938497253408064848319470191181641241260836989849887550802708868480462504070886640, 5305700969248626704032424159735095590820620630418494924943775401354434240231252035443320, 2652850484624313352016212079867547795410310315209247462471887700677217120115626017721660, 1326425242312156676008106039933773897705155157604623731235943850338608560057813008860830, 663212621156078338004053019966886948852577578802311865617971925169304280028906504430415, 11707875343451908608306395436341970191724222291109225125339769968980707480996333886881298, 5853937671725954304153197718170985095862111145554612562669884984490353740498166943440649, 14303237868736846591380967785444019265228989074485375473865726498641232211230964106386415, 18527887967242292734994852819080536349912428038950756929463647255716671446597362687859298, 9263943983621146367497426409540268174956214019475378464731823627858335723298681343929649, 16008241024684442623053082131128660804776040511445758424896695820325223202631221306630915, 19380389545216090750830909991922857119685953757430948404979131916558666942297491287981548, 9690194772608045375415454995961428559842976878715474202489565958279333471148745643990774, 4845097386304022687707727497980714279921488439357737101244782979139666735574372821995387, 13798817726025880783158232675348883857258677721386937743153175495965888708769067045663784, 6899408863012940391579116337674441928629338860693468871576587747982944354384533522831892, 3449704431506470195789558168837220964314669430346734435788293873991472177192266761415946, 1724852215753235097894779084418610482157334715173367217894146936995736088596133380707973, 12238695140750486988251758468567831958376600859294752801477857474893923385279947325020077, 17495616603249112933430248160642442696486233931355445593269712743843017033621854297176129, 20124077334498425906019493006679748065541050467385791989165640378317563857792807783254155, 21438307700123082392314115429698400750068458735400965187113604195554837269878284526293168, 10719153850061541196157057714849200375034229367700482593556802097777418634939142263146584, 5359576925030770598078528857424600187517114683850241296778401048888709317469571131573292, 2679788462515385299039264428712300093758557341925120648389200524444354658734785565786646, 1339894231257692649519632214356150046879278670962560324194600262222177329367392782893323, 12046216148502715764064185033536601740737572837189349354628084137507144005665577026112752, 6023108074251357882032092516768300870368786418594674677314042068753572002832788513056376, 3011554037125678941016046258384150435184393209297337338657021034376786001416394256528188, 1505777018562839470508023129192075217592196604648668669328510517188393000708197128264094, 752888509281419735254011564596037608796098302324334334664255258594196500354098564132047, 11752713287514579306931374708656545521695982652870236359862911635693153591158929916732114, 5876356643757289653465687354328272760847991326435118179931455817846576795579464958366057, 14314447354752514266037212603522663097721929164925628282496511915319343738771613113849119, 18533492710250126572322975228119858266158898084170883333779039964055727210367687191590650, 9266746355125063286161487614059929133079449042085441666889519982027863605183843595795325, 16009642210436401082385112733388491283837658022750790025975543997409987143573802432563753, 19381090138092069980496925293052772359216762513083464205518556005101048912768781850947967, 21066814101919904429552831572884912896906314758249801295290062008946579797366271560140074, 10533407050959952214776415786442456448453157379124900647645031004473289898683135780070037, 16642972558353845546692576819579754941524512191270519516353299508632700290323448524701109, 19697755312050792212650657336148404188060189597343328950707433760712405486143604897016645, 21225146688899265545629697594432728811328028300379733667884500886752258084053683083174413, 21988842377323502212119217723574891122961947651897936026473034449772184383008722176253297, 22370690221535620545363977788145972278778907327657037205767301231282147532486241722792739, 22561614143641679711986357820431512856687387165536587795414434622037129107225001496062460, 11280807071820839855993178910215756428343693582768293897707217311018564553612500748031230, 5640403535910419927996589455107878214171846791384146948853608655509282276806250374015615, 14196470800829079403302663653912465824383856897400142666957588334150696479385005821673898, 7098235400414539701651331826956232912191928448700071333478794167075348239692502910836949, 14925386733081139290130034839836643173393897726058104859270181089933729460828132090084565, 18838962399414439084369386346276848303994882364737121622165874551362920071395946679708373, 20795750232581088981489062099496950869295374684076630003613721282077515376679853974520277, 21774144149164413930048899976107002151945620843746384194337644647434813029321807621926229, 22263341107456076404328818914412027793270743923581261289699606330113461855642784445629205, 22507939586601907641468778383564540613933305463498699837380587171452786268803272857480693, 22630238826174823260038758118140797024264586233457419111221077592122448475383517063406437, 22691388445961281069323747985428925229430226618436778748141322802457279578673639166369309, 22721963255854509973966242919072989332013046810926458566601445407624695130318700217850745, 22737250660801124426287490385895021383304456907171298475831506710208402906141230743591463, 22744894363274431652448114119306037408950161955293718430446537361500256794052496006461822, 11372447181637215826224057059653018704475080977646859215223268680750128397026248003230911, 17062492623692477352416397456185036069535473990531498800142418346771119539495004636281546, 8531246311846238676208198728092518034767736995265749400071209173385559769747502318140773, 15641892188796988777408468290404785734681801999340943892566388593088835225855631793736477, 19197215127272363828008603071560919584638834501378541138813978302940472953909696531534329, 20974876596510051353308670462138986509617350752397339761937773157866291817936728900433255, 21863707331128895115958704157428019972106608877906739073499670585329201249950245084882718, 10931853665564447557979352078714009986053304438953369536749835292664600624975122542441359, 16842195865656093218294044965715531710324585721184753960905701652728355653469441905886770, 8421097932828046609147022482857765855162292860592376980452850826364177826734720952943385, 15586817999287892743877880167787409644879079932004257682757209419578144254349241111137783, 19169678032517815811243309010252231539737473467710198033909388716185127468156501190234982, 9584839016258907905621654505126115769868736733855099016954694358092563734078250595117491, 16168688541003323392115196178921584602232301868635618701008131185442337208021005932224836, 8084344270501661696057598089460792301116150934317809350504065592721168604010502966112418, 4042172135250830848028799044730396150558075467158904675252032796360584302005251483056209, 13397355100499284863318768448723724792576971235287521530156800404576347491984506376194195, 18074946583123511870963753150720389113586419119351829957609184208684229086974133822763188, 9037473291561755935481876575360194556793209559675914978804592104342114543487066911381594, 4518736645780877967740938287680097278396604779837957489402296052171057271743533455690797, 13635637355764308423174838070198575356496235891627047937231932032481583976853647362511489, 18194087710756023650891787961457814395546051447521593161146750022636847329408704315921835, 20473312888251881264750262907087433915070959225468865773104159017714479005686232792627008, 10236656444125940632375131453543716957535479612734432886552079508857239502843116396313504, 5118328222062970316187565726771858478767739806367216443276039754428619751421558198156752, 2559164111031485158093782863385929239383869903183608221638019877214309875710779099078376, 1279582055515742579046891431692964619691934951591804110819009938607154937855389549539188, 639791027757871289523445715846482309845967475795902055409504969303577468927694774769594, 319895513878935644761722857923241154922983737897951027704752484651788734463847387384797, 11536216789813337261685230355320147294759425370657044706383160248721949708213804328358489, 17144377427780538070146984104018600364677646187036591545722364130757030195088782798845335, 19948457746764138474377860978367826899636756595226364965391966071774570438526272034088758, 9974228873382069237188930489183913449818378297613182482695983035887285219263136017044379, 16363383469564904057898834170950483442207122650514660433878775524339697950613448643188280, 8181691734782452028949417085475241721103561325257330216939387762169848975306724321594140, 4090845867391226014474708542737620860551780662628665108469693881084924487653362160797070, 2045422933695613007237354271368810430275890331314332554234846940542462243826681080398535, 12398980499721675942923046062042931932435878667365235469648207476667286462895221174865358, 6199490249860837971461523031021465966217939333682617734824103738333643231447610587432679, 14476014157804288425035130441869259700406903168549378059942835875562876956705685928382430, 7238007078902144212517565220934629850203451584274689029971417937781438478352842964191215, 14995272572324941545563151536825841642399659293845413707516492975286774580158302116761698, 7497636286162470772781575768412920821199829646922706853758246487643387290079151058380849, 15125087175955104825695156810564987127897848325169422619409907250217748986021456163856515, 18938812620851421852151947331641020281246857664292780502235737631504929833992608716594348, 9469406310425710926075973665820510140623428832146390251117868815752464916996304358297174, 4734703155212855463037986832910255070311714416073195125558934407876232458498152179148587, 13743620610480297170823362342813654252453790709744666755310251210334171570230956724240384, 6871810305240148585411681171406827126226895354872333377655125605167085785115478362120192, 3435905152620074292705840585703413563113447677436166688827562802583542892557739181060096, 1717952576310037146352920292851706781556723838718083344413781401291771446278869590530048, 858976288155018573176460146425853390778361919359041672206890700645885723139434795265024, 429488144077509286588230073212926695389180959679520836103445350322942861569717397632512, 214744072038754643294115036606463347694590479839760418051722675161471430784858698816256, 107372036019377321647057518303231673847295239919880209025861337580735715392429349408128, 53686018009688660823528759151615836923647619959940104512930668790367857696214674704064, 26843009004844330411764379575807918461823809979970052256465334395183928848107337352032, 13421504502422165205882189787903959230911904989985026128232667197591964424053668676016, 6710752251211082602941094893951979615455952494992513064116333598795982212026834338008, 3355376125605541301470547446975989807727976247496256532058166799397991106013417169004, 1677688062802770650735273723487994903863988123748128266029083399698995553006708584502, 838844031401385325367636861743997451931994061874064133014541699849497776503354292251]</span><br><span class="hljs-comment"># [372992427307339981616536686110115630075342113098010788080347982669869622759400031649792, 284117116837182934114178639859989682847967251175497623662086047895218803240335140835099, 1605652832106941558090105598761930941083559723, 1020259092832776008725259110973662538898604019]</span><br><span class="hljs-comment"># 1475864207352419823225329328555476398971654057144688193866218781853021651529290611526242518</span><br></code></pre></td></tr></table></figure><p>ä¹‹å‰æ²¡å­¦ä¹ è¿‡èƒŒåŒ…å¯†ç ã€‚ç°åœ¨é•¿é•¿è§è¯†ã€‚</p><p>å‚è€ƒï¼š<a href="https://jayxv.github.io/2020/06/08/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bknapsack/">å¯†ç å­¦å­¦ä¹ ç¬”è®° ä¹‹ knapsack | Van1shçš„å°å±‹ (jayxv.github.io)</a></p><p>å› ä¸º $Pk$ æ˜¯æ— åºçš„ï¼Œæ‰€ä»¥æ„å»ºçŸ©é˜µå¦‚ä¸‹ï¼š</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031025091.png"/><p>è¿›è¡ŒLLLæ ¼åŸºè§„çº¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br>Pk = [<span class="hljs-number">13427720507293490146512325883268574617159432219330328705146993381673927145360640901644288</span>, <span class="hljs-number">20141580760940235219768488824902861925739148328995493057720490072510890718040961352466432</span>, <span class="hljs-number">10070790380470117609884244412451430962869574164497746528860245036255445359020480676233216</span>, <span class="hljs-number">5035395190235058804942122206225715481434787082248873264430122518127722679510240338116608</span>, <span class="hljs-number">15945418102411019548983386986381432357876825760454765337362054640737788485115761070702592</span>, <span class="hljs-number">7972709051205509774491693493190716178938412880227382668681027320368894242557880535351296</span>, <span class="hljs-number">3986354525602754887245846746595358089469206440113691334340513660184447121278940267675648</span>, <span class="hljs-number">1993177262801377443622923373297679044734603220056845667170256830092223560639470133837824</span>, <span class="hljs-number">14424309138694178868323787569917414139526733829358751538732121796720038925680375968563200</span>, <span class="hljs-number">20639875076640579580674219668227281686922799134009704474513054280033946608200828885925888</span>, <span class="hljs-number">10319937538320289790337109834113640843461399567004852237256527140016973304100414442962944</span>, <span class="hljs-number">5159968769160144895168554917056820421730699783502426118628263570008486652050207221481472</span>, <span class="hljs-number">16007704891873562594096603341796984828024782111081541764461125166678170471385744512385024</span>, <span class="hljs-number">21431572953230271443560627554167067031171823274871099587377555965013012381053513157836800</span>, <span class="hljs-number">24143506983908625868292639660352108132745343856765878498835771364180433335887397480562688</span>, <span class="hljs-number">25499473999247803080658645713444628683532104147713267954564879063764143813304339641925632</span>, <span class="hljs-number">26177457506917391686841648739990888958925484293186962682429432913555999052012810722607104</span>, <span class="hljs-number">13088728753458695843420824369995444479462742146593481341214716456777999526006405361303552</span>, <span class="hljs-number">6544364376729347921710412184997722239731371073296740670607358228388999763003202680651776</span>, <span class="hljs-number">16699902695658164107367531975767435737025117755978699040450672495868427026862242241970176</span>, <span class="hljs-number">8349951347829082053683765987883717868512558877989349520225336247934213513431121120985088</span>, <span class="hljs-number">4174975673914541026841882993941858934256279438994674760112668123967106756715560560492544</span>, <span class="hljs-number">2087487836957270513420941496970929467128139719497337380056334061983553378357780280246272</span>, <span class="hljs-number">1043743918478635256710470748485464733564069859748668690028167030991776689178890140123136</span>, <span class="hljs-number">521871959239317628355235374242732366782034929874334345014083515495888344589445070061568</span>, <span class="hljs-number">260935979619658814177617687121366183391017464937167172507041757747944172294722535030784</span>, <span class="hljs-number">13558188497103319553601134726829257708854940951798912291400514260547899231508002169159680</span>, <span class="hljs-number">20206814755845149923312893246683203471586902695229784850847250511947876761114641986224128</span>, <span class="hljs-number">23531127885216065108168772506610176352952883566945221130570618637647865525917961894756352</span>, <span class="hljs-number">25193284449901522700596712136573662793635874002802939270432302700497859908319621849022464</span>, <span class="hljs-number">12596642224950761350298356068286831396817937001401469635216151350248929954159810924511232</span>, <span class="hljs-number">6298321112475380675149178034143415698408968500700734817608075675124464977079905462255616</span>, <span class="hljs-number">16576881063531180484086914900340282466363916469680696113951031219236159633900593632772096</span>, <span class="hljs-number">21716161039059080388555783333438715850341390454170676762122508991292006962310937718030336</span>, <span class="hljs-number">10858080519529540194277891666719357925170695227085338381061254495646003481155468859015168</span>, <span class="hljs-number">5429040259764770097138945833359678962585347613542669190530627247823001740577734429507584</span>, <span class="hljs-number">2714520129882385048569472916679839481292673806771334595265313623911500870288867214753792</span>, <span class="hljs-number">1357260064941192524284736458339919740646336903385667297632656811955750435144433607376896</span>, <span class="hljs-number">678630032470596262142368229169959870323168451692833648816328405977875217572216803688448</span>, <span class="hljs-number">13767035523528788277583509997853554552321016445176745529555157584662864754146749303488512</span>, <span class="hljs-number">6883517761764394138791754998926777276160508222588372764777578792331432377073374651744256</span>, <span class="hljs-number">16869479388175687215908203382731963255239686330624515087535782777839643333897328227516416</span>, <span class="hljs-number">8434739694087843607954101691365981627619843165312257543767891388919821666948664113758208</span>, <span class="hljs-number">4217369847043921803977050845682990813809921582656128771883945694459910833474332056879104</span>, <span class="hljs-number">2108684923521960901988525422841495406904960791328064385941972847229955416737166028439552</span>, <span class="hljs-number">1054342461760980450994262711420747703452480395664032192970986423614977708368583014219776</span>, <span class="hljs-number">527171230880490225497131355710373851726240197832016096485493211807488854184291507109888</span>, <span class="hljs-number">13691306122733735259260891561123761543022552318246336753389739987577671572452786655199232</span>, <span class="hljs-number">20273373568660357776142771663830455388670708378453497081841863375462762931587034229243904</span>, <span class="hljs-number">10136686784330178888071385831915227694335354189226748540920931687731381465793517114621952</span>, <span class="hljs-number">18496063899458579590548018799226188464327109313943702975607459225539617878257399458955264</span>, <span class="hljs-number">9248031949729289795274009399613094232163554656971851487803729612769808939128699729477632</span>, <span class="hljs-number">4624015974864644897637004699806547116081777328485925743901864806384904469564349864738816</span>, <span class="hljs-number">2312007987432322448818502349903273558040888664242962871950932403192452234782174932369408</span>, <span class="hljs-number">14583724501009651370921577058220211396179876551451810141122459583270153262751728367828992</span>, <span class="hljs-number">7291862250504825685460788529110105698089938275725905070561229791635076631375864183914496</span>, <span class="hljs-number">3645931125252412842730394264555052849044969137862952535280614895817538315687932091957248</span>, <span class="hljs-number">15250686069919696567877523015546101041681916788261804972787300829582696303204606947622912</span>, <span class="hljs-number">7625343034959848283938761507773050520840958394130902486393650414791348151602303473811456</span>, <span class="hljs-number">17240392024773414288481706637155099877579911416395779948343818589069601221161792638550016</span>, <span class="hljs-number">22047916519680197290753179201846124555949387927528218679318902676208727755941537220919296</span>, <span class="hljs-number">24451678767133588791888915484191636895134126183094438044806444719778291023331409512103936</span>, <span class="hljs-number">25653559890860284542456783625364393064726495310877547727550215741563072657026345657696256</span>, <span class="hljs-number">26254500452723632417740717695950771149522679874769102568922101252455463473873813730492416</span>, <span class="hljs-number">26554970733655306355382684731243960191920772156714879989608044007901658882297547766890496</span>, <span class="hljs-number">26705205874121143324203668248890554713119818297687768699951015385624756586509414785089536</span>, <span class="hljs-number">26780323444354061808614160007713851973719341368174213055122501074486305438615348294189056</span>, <span class="hljs-number">13390161722177030904307080003856925986859670684087106527561250537243152719307674147094528</span>, <span class="hljs-number">20122801368382005598665865885197037610589267561373881968927618650295503505014477975191552</span>, <span class="hljs-number">23489121191484492945845258825867093422454066000017269689610802706821678897867879889240064</span>, <span class="hljs-number">11744560595742246472922629412933546711227033000008634844805401353410839448933939944620032</span>, <span class="hljs-number">5872280297871123236461314706466773355613516500004317422402700676705419724466969972310016</span>, <span class="hljs-number">16363860656229051764742983236501961294966190469332487416348343720026637007594125887799296</span>, <span class="hljs-number">8181930328114525882371491618250980647483095234666243708174171860013318503797062943899648</span>, <span class="hljs-number">17518685671350753087698071692394064940900979836663450559234079311680586397259172373594112</span>, <span class="hljs-number">8759342835675376543849035846197032470450489918331725279617039655840293198629586186797056</span>, <span class="hljs-number">17807391925131178418436843806367090852384677178496191344955513209594073744675433995042816</span>, <span class="hljs-number">8903695962565589209218421903183545426192338589248095672477756604797036872337716997521408</span>, <span class="hljs-number">17879568488576284751121536834860347330255601513954376541385871684072445581529499400404992</span>, <span class="hljs-number">8939784244288142375560768417430173665127800756977188270692935842036222790764749700202496</span>, <span class="hljs-number">17897612629437561334292710091983661449723332597818922840493461302692038540743015751745536</span>, <span class="hljs-number">8948806314718780667146355045991830724861666298909461420246730651346019270371507875872768</span>, <span class="hljs-number">4474403157359390333573177522995915362430833149454730710123365325673009635185753937936384</span>, <span class="hljs-number">15664922085973185313298914644766532298374848794057694060208676044510431962953517870612480</span>, <span class="hljs-number">21260181550280082803161783205651840766346856616359175735251331403929143126837399836950528</span>, <span class="hljs-number">24057811282433531548093217486094495000332860527509916572772659083638498708779340820119552</span>, <span class="hljs-number">25456626148510255920558934626315822117325862483085286991533322923493176499750311311704064</span>, <span class="hljs-number">26156033581548618106791793196426485675822363460872972200913654843420515395235796557496320</span>, <span class="hljs-number">26505737298067799199908222481481817455070613949766814805603820803384184842978539180392448</span>, <span class="hljs-number">13252868649033899599954111240740908727535306974883407402801910401692092421489269590196224</span>, <span class="hljs-number">6626434324516949799977055620370454363767653487441703701400955200846046210744634795098112</span>, <span class="hljs-number">3313217162258474899988527810185227181883826743720851850700477600423023105372317397549056</span>, <span class="hljs-number">15084329088422727596506589788361188208101345591190754630497232181885438698046799600418816</span>, <span class="hljs-number">7542164544211363798253294894180594104050672795595377315248616090942719349023399800209408</span>, <span class="hljs-number">3771082272105681899126647447090297052025336397797688657624308045471359674511699900104704</span>, <span class="hljs-number">15313261643346331096075649606813723143172100418229173033959147404409606982616490851696640</span>, <span class="hljs-number">21084351328966655694550150686675436188745482428444915222126567083878730636668886327492608</span>, <span class="hljs-number">10542175664483327847275075343337718094372741214222457611063283541939365318334443163746304</span>, <span class="hljs-number">5271087832241663923637537671668859047186370607111228805531641770969682659167221581873152</span>, <span class="hljs-number">16063264423414322108331094719103004140752617522885943107912814267158768474944251692580864</span>, <span class="hljs-number">21459352719000651200677873242820076687535740980773300259103400515253311382832766747934720</span>, <span class="hljs-number">10729676359500325600338936621410038343767870490386650129551700257626655691416383373967360</span>, <span class="hljs-number">5364838179750162800169468310705019171883935245193325064775850128813327845708191686983680</span>, <span class="hljs-number">16110139597168571546597060038621084203101399841926991237534918446080591068214736745136128</span>, <span class="hljs-number">8055069798584285773298530019310542101550699920963495618767459223040295534107368372568064</span>, <span class="hljs-number">4027534899292142886649265009655271050775349960481747809383729611520147767053684186284032</span>, <span class="hljs-number">2013767449646071443324632504827635525387674980240873904691864805760073883526842093142016</span>, <span class="hljs-number">1006883724823035721662316252413817762693837490120436952345932402880036941763421046571008</span>, <span class="hljs-number">503441862411517860831158126206908881346918745060218476172966201440018470881710523285504</span>, <span class="hljs-number">251720931205758930415579063103454440673459372530109238086483100720009235440855261642752</span>, <span class="hljs-number">125860465602879465207789531551727220336729686265054619043241550360004617720427630821376</span>, <span class="hljs-number">13490650740094929879116220649044438227327797062462856014668614156853929454220854717054976</span>, <span class="hljs-number">6745325370047464939558110324522219113663898531231428007334307078426964727110427358527488</span>, <span class="hljs-number">16800383192317222616291381045529684173991381484946042708814146920887409508915854580908032</span>, <span class="hljs-number">21827912103452101454658016406033416704155122961803350059554066842117631899818568192098304</span>, <span class="hljs-number">24341676559019540873841334086285282969236993700232003734924026802732743095269924997693440</span>, <span class="hljs-number">12170838279509770436920667043142641484618496850116001867462013401366371547634962498846720</span>, <span class="hljs-number">19513139647048375364972659404839895359468680644388329638878000082357112919178122151067648</span>, <span class="hljs-number">9756569823524187682486329702419947679734340322194164819439000041178556459589061075533824</span>, <span class="hljs-number">4878284911762093841243164851209973839867170161097082409719500020589278229794530537766912</span>, <span class="hljs-number">2439142455881046920621582425604986919933585080548541204859750010294639114897265268883456</span>, <span class="hljs-number">14647291735234013606823117096071068077126224759604599307576868386821246702809273536086016</span>, <span class="hljs-number">20751366374910496949923884431304108655722544599132628358935427575084550496765277669687296</span>, <span class="hljs-number">23803403694748738621474268098920628945020704518896642884614707169216202393743279736487936</span>, <span class="hljs-number">11901701847374369310737134049460314472510352259448321442307353584608101196871639868243968</span>, <span class="hljs-number">5950850923687184655368567024730157236255176129724160721153676792304050598435819934121984</span>, <span class="hljs-number">16403145969137082474196609395633653235287020284192409065723831777825952444578550868705280</span>, <span class="hljs-number">21629293491862031383610630581085401234802942361426533238008909270586903367649916335996928</span>, <span class="hljs-number">10814646745931015691805315290542700617401471180713266619004454635293451683824958167998464</span>, <span class="hljs-number">5407323372965507845902657645271350308700735590356633309502227317646725841912479083999232</span>, <span class="hljs-number">2703661686482753922951328822635675154350367795178316654751113658823362920956239541999616</span>, <span class="hljs-number">1351830843241376961475664411317837577175183897589158327375556829411681460478119770999808</span>, <span class="hljs-number">675915421620688480737832205658918788587591948794579163687778414705840730239059885499904</span>, <span class="hljs-number">337957710810344240368916102829459394293795974397289581843889207352920365119529942749952</span>, <span class="hljs-number">168978855405172120184458051414729697146897987198644790921944603676460182559764971374976</span>, <span class="hljs-number">84489427702586060092229025707364848573448993599322395460972301838230091279882485687488</span>, <span class="hljs-number">42244713851293030046114512853682424286724496799661197730486150919115045639941242843744</span>, <span class="hljs-number">21122356925646515023057256426841212143362248399830598865243075459557522819970621421872</span>, <span class="hljs-number">10561178462823257511528628213420606071681124199915299432621537729778761409985310710936</span>, <span class="hljs-number">5280589231411628755764314106710303035840562099957649716310768864889380704992655355468</span>, <span class="hljs-number">2640294615705814377882157053355151517920281049978824858155384432444690352496327677734</span>, <span class="hljs-number">1320147307852907188941078526677575758960140524989412429077692216222345176248163838867</span>, <span class="hljs-number">11376929106527795892898839465621865505177413571970563898745322852504166513570004716585524</span>, <span class="hljs-number">5688464553263897946449419732810932752588706785985281949372661426252083256785002358292762</span>, <span class="hljs-number">2844232276631948973224709866405466376294353392992640974686330713126041628392501179146381</span>, <span class="hljs-number">12798385171189843925916723859561259905445110198204389679873949362959076155178131224239281</span>, <span class="hljs-number">17775461618468791402262730856139156670020488600810264032467758687875593418570946246785731</span>, <span class="hljs-number">20263999842108265140435734354428105052308177802113201208764663350333852050267353758058956</span>, <span class="hljs-number">10131999921054132570217867177214052526154088901056600604382331675166926025133676879029478</span>, <span class="hljs-number">5065999960527066285108933588607026263077044450528300302191165837583463012566838439514739</span>, <span class="hljs-number">13909269013137402581858835720662039848836455726972219343626366925187786847265299854423460</span>, <span class="hljs-number">6954634506568701290929417860331019924418227863486109671813183462593893423632649927211730</span>, <span class="hljs-number">3477317253284350645464708930165509962209113931743054835906591731296946711816324963605865</span>, <span class="hljs-number">13114927659516044762036723391441281698402490467579596610484079872044528696890043116469023</span>, <span class="hljs-number">17933732862631891820322730622079167566499178735497867497772823942418319689426902192900602</span>, <span class="hljs-number">8966866431315945910161365311039583783249589367748933748886411971209159844713451096450301</span>, <span class="hljs-number">15859702248531842394385051581878318608922728185582536066973989992000635263338606182891241</span>, <span class="hljs-number">19306120157139790636496894717297686021759297594499337226017779002396372972651183726111711</span>, <span class="hljs-number">21029329111443764757552816285007369728177582298957737805539673507594241827307472497721946</span>, <span class="hljs-number">10514664555721882378776408142503684864088791149478868902769836753797120913653736248860973</span>, <span class="hljs-number">16633601310734810628692572997610369149342329076447503643915702383294615797808748759096577</span>, <span class="hljs-number">19693069688241274753650655425163711291969098039931821014488635198043363239886255014214379</span>, <span class="hljs-number">21222803876994506816129696638940382363282482521673979699775101605417736960925008141773280</span>, <span class="hljs-number">10611401938497253408064848319470191181641241260836989849887550802708868480462504070886640</span>, <span class="hljs-number">5305700969248626704032424159735095590820620630418494924943775401354434240231252035443320</span>, <span class="hljs-number">2652850484624313352016212079867547795410310315209247462471887700677217120115626017721660</span>, <span class="hljs-number">1326425242312156676008106039933773897705155157604623731235943850338608560057813008860830</span>, <span class="hljs-number">663212621156078338004053019966886948852577578802311865617971925169304280028906504430415</span>, <span class="hljs-number">11707875343451908608306395436341970191724222291109225125339769968980707480996333886881298</span>, <span class="hljs-number">5853937671725954304153197718170985095862111145554612562669884984490353740498166943440649</span>, <span class="hljs-number">14303237868736846591380967785444019265228989074485375473865726498641232211230964106386415</span>, <span class="hljs-number">18527887967242292734994852819080536349912428038950756929463647255716671446597362687859298</span>, <span class="hljs-number">9263943983621146367497426409540268174956214019475378464731823627858335723298681343929649</span>, <span class="hljs-number">16008241024684442623053082131128660804776040511445758424896695820325223202631221306630915</span>, <span class="hljs-number">19380389545216090750830909991922857119685953757430948404979131916558666942297491287981548</span>, <span class="hljs-number">9690194772608045375415454995961428559842976878715474202489565958279333471148745643990774</span>, <span class="hljs-number">4845097386304022687707727497980714279921488439357737101244782979139666735574372821995387</span>, <span class="hljs-number">13798817726025880783158232675348883857258677721386937743153175495965888708769067045663784</span>, <span class="hljs-number">6899408863012940391579116337674441928629338860693468871576587747982944354384533522831892</span>, <span class="hljs-number">3449704431506470195789558168837220964314669430346734435788293873991472177192266761415946</span>, <span class="hljs-number">1724852215753235097894779084418610482157334715173367217894146936995736088596133380707973</span>, <span class="hljs-number">12238695140750486988251758468567831958376600859294752801477857474893923385279947325020077</span>, <span class="hljs-number">17495616603249112933430248160642442696486233931355445593269712743843017033621854297176129</span>, <span class="hljs-number">20124077334498425906019493006679748065541050467385791989165640378317563857792807783254155</span>, <span class="hljs-number">21438307700123082392314115429698400750068458735400965187113604195554837269878284526293168</span>, <span class="hljs-number">10719153850061541196157057714849200375034229367700482593556802097777418634939142263146584</span>, <span class="hljs-number">5359576925030770598078528857424600187517114683850241296778401048888709317469571131573292</span>, <span class="hljs-number">2679788462515385299039264428712300093758557341925120648389200524444354658734785565786646</span>, <span class="hljs-number">1339894231257692649519632214356150046879278670962560324194600262222177329367392782893323</span>, <span class="hljs-number">12046216148502715764064185033536601740737572837189349354628084137507144005665577026112752</span>, <span class="hljs-number">6023108074251357882032092516768300870368786418594674677314042068753572002832788513056376</span>, <span class="hljs-number">3011554037125678941016046258384150435184393209297337338657021034376786001416394256528188</span>, <span class="hljs-number">1505777018562839470508023129192075217592196604648668669328510517188393000708197128264094</span>, <span class="hljs-number">752888509281419735254011564596037608796098302324334334664255258594196500354098564132047</span>, <span class="hljs-number">11752713287514579306931374708656545521695982652870236359862911635693153591158929916732114</span>, <span class="hljs-number">5876356643757289653465687354328272760847991326435118179931455817846576795579464958366057</span>, <span class="hljs-number">14314447354752514266037212603522663097721929164925628282496511915319343738771613113849119</span>, <span class="hljs-number">18533492710250126572322975228119858266158898084170883333779039964055727210367687191590650</span>, <span class="hljs-number">9266746355125063286161487614059929133079449042085441666889519982027863605183843595795325</span>, <span class="hljs-number">16009642210436401082385112733388491283837658022750790025975543997409987143573802432563753</span>, <span class="hljs-number">19381090138092069980496925293052772359216762513083464205518556005101048912768781850947967</span>, <span class="hljs-number">21066814101919904429552831572884912896906314758249801295290062008946579797366271560140074</span>, <span class="hljs-number">10533407050959952214776415786442456448453157379124900647645031004473289898683135780070037</span>, <span class="hljs-number">16642972558353845546692576819579754941524512191270519516353299508632700290323448524701109</span>, <span class="hljs-number">19697755312050792212650657336148404188060189597343328950707433760712405486143604897016645</span>, <span class="hljs-number">21225146688899265545629697594432728811328028300379733667884500886752258084053683083174413</span>, <span class="hljs-number">21988842377323502212119217723574891122961947651897936026473034449772184383008722176253297</span>, <span class="hljs-number">22370690221535620545363977788145972278778907327657037205767301231282147532486241722792739</span>, <span class="hljs-number">22561614143641679711986357820431512856687387165536587795414434622037129107225001496062460</span>, <span class="hljs-number">11280807071820839855993178910215756428343693582768293897707217311018564553612500748031230</span>, <span class="hljs-number">5640403535910419927996589455107878214171846791384146948853608655509282276806250374015615</span>, <span class="hljs-number">14196470800829079403302663653912465824383856897400142666957588334150696479385005821673898</span>, <span class="hljs-number">7098235400414539701651331826956232912191928448700071333478794167075348239692502910836949</span>, <span class="hljs-number">14925386733081139290130034839836643173393897726058104859270181089933729460828132090084565</span>, <span class="hljs-number">18838962399414439084369386346276848303994882364737121622165874551362920071395946679708373</span>, <span class="hljs-number">20795750232581088981489062099496950869295374684076630003613721282077515376679853974520277</span>, <span class="hljs-number">21774144149164413930048899976107002151945620843746384194337644647434813029321807621926229</span>, <span class="hljs-number">22263341107456076404328818914412027793270743923581261289699606330113461855642784445629205</span>, <span class="hljs-number">22507939586601907641468778383564540613933305463498699837380587171452786268803272857480693</span>, <span class="hljs-number">22630238826174823260038758118140797024264586233457419111221077592122448475383517063406437</span>, <span class="hljs-number">22691388445961281069323747985428925229430226618436778748141322802457279578673639166369309</span>, <span class="hljs-number">22721963255854509973966242919072989332013046810926458566601445407624695130318700217850745</span>, <span class="hljs-number">22737250660801124426287490385895021383304456907171298475831506710208402906141230743591463</span>, <span class="hljs-number">22744894363274431652448114119306037408950161955293718430446537361500256794052496006461822</span>, <span class="hljs-number">11372447181637215826224057059653018704475080977646859215223268680750128397026248003230911</span>, <span class="hljs-number">17062492623692477352416397456185036069535473990531498800142418346771119539495004636281546</span>, <span class="hljs-number">8531246311846238676208198728092518034767736995265749400071209173385559769747502318140773</span>, <span class="hljs-number">15641892188796988777408468290404785734681801999340943892566388593088835225855631793736477</span>, <span class="hljs-number">19197215127272363828008603071560919584638834501378541138813978302940472953909696531534329</span>, <span class="hljs-number">20974876596510051353308670462138986509617350752397339761937773157866291817936728900433255</span>, <span class="hljs-number">21863707331128895115958704157428019972106608877906739073499670585329201249950245084882718</span>, <span class="hljs-number">10931853665564447557979352078714009986053304438953369536749835292664600624975122542441359</span>, <span class="hljs-number">16842195865656093218294044965715531710324585721184753960905701652728355653469441905886770</span>, <span class="hljs-number">8421097932828046609147022482857765855162292860592376980452850826364177826734720952943385</span>, <span class="hljs-number">15586817999287892743877880167787409644879079932004257682757209419578144254349241111137783</span>, <span class="hljs-number">19169678032517815811243309010252231539737473467710198033909388716185127468156501190234982</span>, <span class="hljs-number">9584839016258907905621654505126115769868736733855099016954694358092563734078250595117491</span>, <span class="hljs-number">16168688541003323392115196178921584602232301868635618701008131185442337208021005932224836</span>, <span class="hljs-number">8084344270501661696057598089460792301116150934317809350504065592721168604010502966112418</span>, <span class="hljs-number">4042172135250830848028799044730396150558075467158904675252032796360584302005251483056209</span>, <span class="hljs-number">13397355100499284863318768448723724792576971235287521530156800404576347491984506376194195</span>, <span class="hljs-number">18074946583123511870963753150720389113586419119351829957609184208684229086974133822763188</span>, <span class="hljs-number">9037473291561755935481876575360194556793209559675914978804592104342114543487066911381594</span>, <span class="hljs-number">4518736645780877967740938287680097278396604779837957489402296052171057271743533455690797</span>, <span class="hljs-number">13635637355764308423174838070198575356496235891627047937231932032481583976853647362511489</span>, <span class="hljs-number">18194087710756023650891787961457814395546051447521593161146750022636847329408704315921835</span>, <span class="hljs-number">20473312888251881264750262907087433915070959225468865773104159017714479005686232792627008</span>, <span class="hljs-number">10236656444125940632375131453543716957535479612734432886552079508857239502843116396313504</span>, <span class="hljs-number">5118328222062970316187565726771858478767739806367216443276039754428619751421558198156752</span>, <span class="hljs-number">2559164111031485158093782863385929239383869903183608221638019877214309875710779099078376</span>, <span class="hljs-number">1279582055515742579046891431692964619691934951591804110819009938607154937855389549539188</span>, <span class="hljs-number">639791027757871289523445715846482309845967475795902055409504969303577468927694774769594</span>, <span class="hljs-number">319895513878935644761722857923241154922983737897951027704752484651788734463847387384797</span>, <span class="hljs-number">11536216789813337261685230355320147294759425370657044706383160248721949708213804328358489</span>, <span class="hljs-number">17144377427780538070146984104018600364677646187036591545722364130757030195088782798845335</span>, <span class="hljs-number">19948457746764138474377860978367826899636756595226364965391966071774570438526272034088758</span>, <span class="hljs-number">9974228873382069237188930489183913449818378297613182482695983035887285219263136017044379</span>, <span class="hljs-number">16363383469564904057898834170950483442207122650514660433878775524339697950613448643188280</span>, <span class="hljs-number">8181691734782452028949417085475241721103561325257330216939387762169848975306724321594140</span>, <span class="hljs-number">4090845867391226014474708542737620860551780662628665108469693881084924487653362160797070</span>, <span class="hljs-number">2045422933695613007237354271368810430275890331314332554234846940542462243826681080398535</span>, <span class="hljs-number">12398980499721675942923046062042931932435878667365235469648207476667286462895221174865358</span>, <span class="hljs-number">6199490249860837971461523031021465966217939333682617734824103738333643231447610587432679</span>, <span class="hljs-number">14476014157804288425035130441869259700406903168549378059942835875562876956705685928382430</span>, <span class="hljs-number">7238007078902144212517565220934629850203451584274689029971417937781438478352842964191215</span>, <span class="hljs-number">14995272572324941545563151536825841642399659293845413707516492975286774580158302116761698</span>, <span class="hljs-number">7497636286162470772781575768412920821199829646922706853758246487643387290079151058380849</span>, <span class="hljs-number">15125087175955104825695156810564987127897848325169422619409907250217748986021456163856515</span>, <span class="hljs-number">18938812620851421852151947331641020281246857664292780502235737631504929833992608716594348</span>, <span class="hljs-number">9469406310425710926075973665820510140623428832146390251117868815752464916996304358297174</span>, <span class="hljs-number">4734703155212855463037986832910255070311714416073195125558934407876232458498152179148587</span>, <span class="hljs-number">13743620610480297170823362342813654252453790709744666755310251210334171570230956724240384</span>, <span class="hljs-number">6871810305240148585411681171406827126226895354872333377655125605167085785115478362120192</span>, <span class="hljs-number">3435905152620074292705840585703413563113447677436166688827562802583542892557739181060096</span>, <span class="hljs-number">1717952576310037146352920292851706781556723838718083344413781401291771446278869590530048</span>, <span class="hljs-number">858976288155018573176460146425853390778361919359041672206890700645885723139434795265024</span>, <span class="hljs-number">429488144077509286588230073212926695389180959679520836103445350322942861569717397632512</span>, <span class="hljs-number">214744072038754643294115036606463347694590479839760418051722675161471430784858698816256</span>, <span class="hljs-number">107372036019377321647057518303231673847295239919880209025861337580735715392429349408128</span>, <span class="hljs-number">53686018009688660823528759151615836923647619959940104512930668790367857696214674704064</span>, <span class="hljs-number">26843009004844330411764379575807918461823809979970052256465334395183928848107337352032</span>, <span class="hljs-number">13421504502422165205882189787903959230911904989985026128232667197591964424053668676016</span>, <span class="hljs-number">6710752251211082602941094893951979615455952494992513064116333598795982212026834338008</span>, <span class="hljs-number">3355376125605541301470547446975989807727976247496256532058166799397991106013417169004</span>, <span class="hljs-number">1677688062802770650735273723487994903863988123748128266029083399698995553006708584502</span>, <span class="hljs-number">838844031401385325367636861743997451931994061874064133014541699849497776503354292251</span>]<br>c = <span class="hljs-number">1475864207352419823225329328555476398971654057144688193866218781853021651529290611526242518</span><br><br>n = <span class="hljs-built_in">len</span>(Pk)<br><br>M = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>    L = [<span class="hljs-number">0</span>]*(n+<span class="hljs-number">1</span>)<br>    L[i] = <span class="hljs-number">2</span><br>    L[n] = Pk[i]<br>    M.append(L)<br>M.append([<span class="hljs-number">1</span>]*n+[c])<br>M = matrix(M)<br>L = M.LLL()<br><span class="hljs-built_in">print</span>(L)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">print(L[-16].list())</span><br><span class="hljs-string">print(L[-8].list())</span><br><span class="hljs-string">print(L[-6].list())</span><br><span class="hljs-string">print(L[-5].list())</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>               <br></code></pre></td></tr></table></figure><p>å¾ˆé—æ†¾ï¼Œå¹¶æ²¡æœ‰å®Œå…¨æ»¡è¶³çš„å‘é‡ã€‚å°†å‘é‡ä¸­çš„ä¸ç¬¦åˆåœ°åšä¸€äº›å¾®å°æ”¹å˜ï¼Œå°½é‡æ‹Ÿåˆflagã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>L = [<br>    [-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]<br>    ,[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">3</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]<br>    ,[-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]<br>    ,[-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">3</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]<br>]<br><br><span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> L:<br>    m = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(each)-<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">if</span> each[i] == -<span class="hljs-number">1</span>:<br>            m += <span class="hljs-string">&#x27;0&#x27;</span><br>        <span class="hljs-keyword">elif</span> each[i] == <span class="hljs-number">1</span>:<br>            m += <span class="hljs-string">&#x27;1&#x27;</span><br>        <span class="hljs-keyword">elif</span> each[i] == -<span class="hljs-number">3</span>:<br>            m += <span class="hljs-string">&#x27;0&#x27;</span><br>        <span class="hljs-keyword">elif</span> each[i] == <span class="hljs-number">3</span>:<br>            m += <span class="hljs-string">&#x27;1&#x27;</span><br>    <span class="hljs-built_in">print</span>(m)<br>    <span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-built_in">int</span>(m,<span class="hljs-number">2</span>)))<br><span class="hljs-comment">#5090ea29-8cb6-4ad8-ab43-1e6f65cc8eeb</span><br><span class="hljs-comment">#5090ea29-8cb6-4ad7=ab43-1e6f65cc8eebï¼ˆ-1ï¼Œ+1ä»£è¡¨çš„å€¼äº’æ¢ï¼‰</span><br><span class="hljs-comment">#5090ea29-8cb6-4ad75ab43-1e6f65cc8ee\x82</span><br></code></pre></td></tr></table></figure><p>å‡ºæ¥çš„ç»“æœæœ‰äº›è¯¯å·®ã€‚</p><h1 id="FourThousandRSA"><a href="#FourThousandRSA" class="headerlink" title="FourThousandRSA"></a>FourThousandRSA</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> p, q, flag<br><br>d = (p - <span class="hljs-number">1</span>) * (randint(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">895</span>, <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">905</span>)) + getPrime(<span class="hljs-number">66</span>)<br><span class="hljs-keyword">assert</span> GCD(d, (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)) == <span class="hljs-number">1</span><br><br>e = inverse(d, (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>))<br>n = p * q<br>m = bytes_to_long(flag)<br>c = <span class="hljs-built_in">pow</span>(m, e, n)<br>lnK = [n, e, d, p, q]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    lnK[i] = lnK[i].bit_length()<br><br><span class="hljs-built_in">print</span>(n)<br><span class="hljs-built_in">print</span>(e)<br><span class="hljs-built_in">print</span>(c)<br><span class="hljs-built_in">print</span>(lnK)<br><span class="hljs-comment"># 2008245202726111195525139787077766845460301971221282725789653525445717877831247040311792229284045975453691272797897794805042646233029706866078707630143984010874126231698685294168749255436126975986003969530103617426741064270423218259588978877370113177828293456561413806780703064713982940589926704665536293631846419385505665983693074491341550629844185026851229010312732921558017787072574777346960912025366025572718687418119633550194015169661191937337614795319500510125026882103589501497847356092372022899906904311120130529291320419495706452187192436497658895872460456299020678691633147066767550340869239242665444676015223859488181778716351439391614896237952082547346751012334359281894362102507693710804521999826603241204878074796474371682930675553715217908515291214108531394832662173298837242969662633805422396059510882443282508140025449969731242643820520540750378151812795959963934842270926945543049483993393288111252859368438315000543965899671606298852910335484127077917071912504701937501178567564695543045503695648983193718396823789188986832546133398012148358369105865469590306905583050200981598525031197740358763416786658682107838491293027639364508979821571709310278056633617824675033779928720051885352835157353803</span><br><span class="hljs-comment"># 807032534004084758580375189157328561548795804530942985115124520531221373527096275904469284031734054835824102563821158171589235747667599272991298059693818077176669425056991292994334793629184405818520272993874070884698385334019049156576500287497429412919772544592662544872484546264801483551861046175807498926198088282017428499839509688184982602419754320550459089738363252159087637831975525246450729834548975894498204691170246637710357850579558483403451912974355124654280116319260254145067344177881377307629659609044861901831073680528402705499960011480684401009582453074445582770870258919978732068123428866624493163278443134701482587357134070124133221075748585768453464832312107505344577054027293922365686198638830956703448628155371973969488855140627118939048137913508744817167302068674632091539914140795622964012240768679911315743790231690924423221631592930482614786389990208367405878537840797769431729477448292378308254306426728498718084148271069061132613717597098762769671154028101328451549784614737777731600209296493017630537336889457808923914655393955515432343410385118818484779667586279513209712795980030600707800342547828383384392042988707358771882529896527356417371670949948690120768388723079299981807646726911</span><br><span class="hljs-comment"># 1479098843223597304786742970274134598770261170942980086038287429905405158086547268458308645377797729404756116803215570224420375863682276378830919895619659050799395956146572726236750711207231799570925819982063426093862796144319017426916290208631746748701116840125309109359766050752569570197143931328071928910272144487415408708111493159410784983656461473802920988821467611079772020575539261046542193167444757825649926376069763390388540651778066220417921640963803183015067230139701713552782995724061821817700770220827885999306389960050273479873187643335537248639494631153812809968161473247467770291102906672062014528600784321726886085505174266116545186131025910553430133389924415555728463048311407897414482070647200465503078473266937663980748718243201906335338839452018573040634977122916044674440902206770428978968958675742011856119772241474589012913197944864164658153691848011206012988704668234612237127302621256390964532600110123457039129898476045860122356186227473879930882612843980001579020344087043771505157047280424063737637399280369256220373591698317585713187436849457927758798371213053969011609925655180333896843921881279342761083499824073913636798612382743862755759722932438784880987705776287623448376091072071</span><br><span class="hljs-comment"># [4038, 4036, 3503, 2599, 1439]</span><br></code></pre></td></tr></table></figure><p>è®ºæ–‡é¢˜ï¼š<a href="https://link.springer.com/content/pdf/10.1007%2F3-540-45708-9_16.pdf">https://link.springer.com/content/pdf/10.1007%2F3-540-45708-9_16.pdf</a></p><p>æ„é€ å¦‚ä¸‹çŸ©é˜µï¼š</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031025357.png"/><p>å…¶ä¸­$f_p(x,y) &#x3D; ex - y$ã€‚çŸ©é˜µä¸­çš„æ¯ä¸€è¡Œä¸º$g_{m,i,j}(x,y)$ã€‚</p><p>è‡³äº$n,m$çš„é€‰å–ä¼¼ä¹æ²¡æœ‰å¾ˆå‡†ç¡®çš„è¯´æ˜ã€‚ï¼ˆå¯èƒ½æ˜¯æˆ‘æ²¡æœ‰è¯»é€ï¼‰</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031025301.png"/><p>æˆ‘ä¸ç†è§£çš„åœ°æ–¹æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>$x,y$çš„ç³»æ•°ä¸ºä»€ä¹ˆæ˜¯è§£ã€‚</li><li>å¾—å‡ºçš„è§£æŒ‰ç…§è®ºæ–‡åº”è¯¥æ˜¯$(x_0,y_0)&#x3D;(dp,k+1)$ï¼Œä½†ä¸ºä»€ä¹ˆ$k$æœ€åæ˜¯+1è€Œä¸æ˜¯-1ã€‚</li></ol><p>å¦‚æœæœ‰æ¸…æ¥šçš„å¸ˆå‚…å¸Œæœ›èƒ½è§£ç­”æˆ‘çš„ç–‘æƒ‘ï¼æ„Ÿè°¢ï¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br>N=<span class="hljs-number">2008245202726111195525139787077766845460301971221282725789653525445717877831247040311792229284045975453691272797897794805042646233029706866078707630143984010874126231698685294168749255436126975986003969530103617426741064270423218259588978877370113177828293456561413806780703064713982940589926704665536293631846419385505665983693074491341550629844185026851229010312732921558017787072574777346960912025366025572718687418119633550194015169661191937337614795319500510125026882103589501497847356092372022899906904311120130529291320419495706452187192436497658895872460456299020678691633147066767550340869239242665444676015223859488181778716351439391614896237952082547346751012334359281894362102507693710804521999826603241204878074796474371682930675553715217908515291214108531394832662173298837242969662633805422396059510882443282508140025449969731242643820520540750378151812795959963934842270926945543049483993393288111252859368438315000543965899671606298852910335484127077917071912504701937501178567564695543045503695648983193718396823789188986832546133398012148358369105865469590306905583050200981598525031197740358763416786658682107838491293027639364508979821571709310278056633617824675033779928720051885352835157353803</span><br>e=<span class="hljs-number">807032534004084758580375189157328561548795804530942985115124520531221373527096275904469284031734054835824102563821158171589235747667599272991298059693818077176669425056991292994334793629184405818520272993874070884698385334019049156576500287497429412919772544592662544872484546264801483551861046175807498926198088282017428499839509688184982602419754320550459089738363252159087637831975525246450729834548975894498204691170246637710357850579558483403451912974355124654280116319260254145067344177881377307629659609044861901831073680528402705499960011480684401009582453074445582770870258919978732068123428866624493163278443134701482587357134070124133221075748585768453464832312107505344577054027293922365686198638830956703448628155371973969488855140627118939048137913508744817167302068674632091539914140795622964012240768679911315743790231690924423221631592930482614786389990208367405878537840797769431729477448292378308254306426728498718084148271069061132613717597098762769671154028101328451549784614737777731600209296493017630537336889457808923914655393955515432343410385118818484779667586279513209712795980030600707800342547828383384392042988707358771882529896527356417371670949948690120768388723079299981807646726911</span><br><br>n=<span class="hljs-number">12</span><br>beta = <span class="hljs-number">0.36</span><br>delta = <span class="hljs-number">0.02</span><br><br>X = <span class="hljs-built_in">int</span>(N ** delta*(n+<span class="hljs-number">1</span>)/<span class="hljs-number">2</span>)<br>Y = <span class="hljs-built_in">int</span>(N ** (delta + beta)*(n+<span class="hljs-number">1</span>)/<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">C</span>(<span class="hljs-params">a,b</span>):<br>    ret=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(b):<br>        ret*=(a-i)<br>        ret/=(b-i)<br>    <span class="hljs-keyword">return</span> ret<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_Matrix</span>(<span class="hljs-params">n,m</span>):<br>    MM=[[<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> __ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)]<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n): <br>        pN=<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>,m-j)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(j+<span class="hljs-number">1</span>):<br>            MM[j][i]=<span class="hljs-built_in">pow</span>(N,pN)*<span class="hljs-built_in">pow</span>(X,n-i-<span class="hljs-number">1</span>)*<span class="hljs-built_in">pow</span>(Y,i)*<span class="hljs-built_in">pow</span>(e,j-i)*C(j,i)*<span class="hljs-built_in">pow</span>(-<span class="hljs-number">1</span>,i)<br>    MM=Matrix(ZZ,MM)<br>    <span class="hljs-keyword">return</span> MM<br><br>M=get_Matrix(n,n//<span class="hljs-number">2</span>+<span class="hljs-number">1</span>)<br>L=M.LLL()[<span class="hljs-number">0</span>]<br><br>x,y = var(<span class="hljs-string">&#x27;x&#x27;</span>),var(<span class="hljs-string">&#x27;y&#x27;</span>)<br>f=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>    f+=x**(n-i-<span class="hljs-number">1</span>) * y**i * (L[i] // <span class="hljs-built_in">pow</span>(X,n-i-<span class="hljs-number">1</span>) // <span class="hljs-built_in">pow</span>(Y,i))<span class="hljs-comment">#å°†x,yå‚æ•°åŒ–</span><br><br><span class="hljs-built_in">print</span>(f.factor())<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><br>n = <span class="hljs-number">2008245202726111195525139787077766845460301971221282725789653525445717877831247040311792229284045975453691272797897794805042646233029706866078707630143984010874126231698685294168749255436126975986003969530103617426741064270423218259588978877370113177828293456561413806780703064713982940589926704665536293631846419385505665983693074491341550629844185026851229010312732921558017787072574777346960912025366025572718687418119633550194015169661191937337614795319500510125026882103589501497847356092372022899906904311120130529291320419495706452187192436497658895872460456299020678691633147066767550340869239242665444676015223859488181778716351439391614896237952082547346751012334359281894362102507693710804521999826603241204878074796474371682930675553715217908515291214108531394832662173298837242969662633805422396059510882443282508140025449969731242643820520540750378151812795959963934842270926945543049483993393288111252859368438315000543965899671606298852910335484127077917071912504701937501178567564695543045503695648983193718396823789188986832546133398012148358369105865469590306905583050200981598525031197740358763416786658682107838491293027639364508979821571709310278056633617824675033779928720051885352835157353803</span><br>e = <span class="hljs-number">807032534004084758580375189157328561548795804530942985115124520531221373527096275904469284031734054835824102563821158171589235747667599272991298059693818077176669425056991292994334793629184405818520272993874070884698385334019049156576500287497429412919772544592662544872484546264801483551861046175807498926198088282017428499839509688184982602419754320550459089738363252159087637831975525246450729834548975894498204691170246637710357850579558483403451912974355124654280116319260254145067344177881377307629659609044861901831073680528402705499960011480684401009582453074445582770870258919978732068123428866624493163278443134701482587357134070124133221075748585768453464832312107505344577054027293922365686198638830956703448628155371973969488855140627118939048137913508744817167302068674632091539914140795622964012240768679911315743790231690924423221631592930482614786389990208367405878537840797769431729477448292378308254306426728498718084148271069061132613717597098762769671154028101328451549784614737777731600209296493017630537336889457808923914655393955515432343410385118818484779667586279513209712795980030600707800342547828383384392042988707358771882529896527356417371670949948690120768388723079299981807646726911</span><br>c = <span class="hljs-number">1479098843223597304786742970274134598770261170942980086038287429905405158086547268458308645377797729404756116803215570224420375863682276378830919895619659050799395956146572726236750711207231799570925819982063426093862796144319017426916290208631746748701116840125309109359766050752569570197143931328071928910272144487415408708111493159410784983656461473802920988821467611079772020575539261046542193167444757825649926376069763390388540651778066220417921640963803183015067230139701713552782995724061821817700770220827885999306389960050273479873187643335537248639494631153812809968161473247467770291102906672062014528600784321726886085505174266116545186131025910553430133389924415555728463048311407897414482070647200465503078473266937663980748718243201906335338839452018573040634977122916044674440902206770428978968958675742011856119772241474589012913197944864164658153691848011206012988704668234612237127302621256390964532600110123457039129898476045860122356186227473879930882612843980001579020344087043771505157047280424063737637399280369256220373591698317585713187436849457927758798371213053969011609925655180333896843921881279342761083499824073913636798612382743862755759722932438784880987705776287623448376091072071</span><br>lnK = [<span class="hljs-number">4038</span>, <span class="hljs-number">4036</span>, <span class="hljs-number">3503</span>, <span class="hljs-number">2599</span>, <span class="hljs-number">1439</span>]<br><br>dp = <span class="hljs-number">53884891560160528919</span><br>k = <span class="hljs-number">302884665515803766011906438013192003712099358870001780564269089035021793994528619923490222376829646206262773174752214834261410191185822844479036873079049649442148949148666170143829689538107319496991988733386708820659360609308128307216254687970393854057754055298044301139034587343570198869912515404392889596455648319972063467359880205558544007697140900913860985852897308920005250016284550898672612541129402073944532028683909649120706671728845700276654410</span><br>k += <span class="hljs-number">1</span><br><br>p = (e * dp - <span class="hljs-number">1</span> ) // k + <span class="hljs-number">1</span><br>q = n // p<br><span class="hljs-built_in">print</span>(p.bit_length())<br><span class="hljs-built_in">print</span>(q.bit_length())<br>d = gmpy2.invert(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br><span class="hljs-comment">#b&#x27;Dest0g3&#123;1087fb88-a2da-4d21-d81a-40c6e1f105fa&#125;&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
      <tag>AES</tag>
      
      <tag>èƒŒåŒ…å¯†ç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SUSCTF - Ez_Pager_Tiper</title>
    <link href="/2022/06/28/Ez_Pager_Tiper/"/>
    <url>/2022/06/28/Ez_Pager_Tiper/</url>
    
    <content type="html"><![CDATA[<h1 id="Ez-Pager-Tiper"><a href="#Ez-Pager-Tiper" class="headerlink" title="Ez_Pager_Tiper"></a>Ez_Pager_Tiper</h1><p>åˆ†æ<code>magic_box</code>ä¸­çš„ä»£ç ï¼Œæµ‹è¯•å‘ç°<code>malicious_magic</code>ä¸­çš„<code>now = (-magic &amp; magic)</code>çš„å€¼å–å†³äº<code>magic</code>äºŒè¿›åˆ¶æœ«å°¾0çš„ä¸ªæ•°ï¼Œå³$now &#x3D; 2^{äºŒè¿›åˆ¶æœ«å°¾0çš„ä¸ªæ•°}$ï¼Œè¿›è€Œæ¯æ¬¡æ‰§è¡Œè¯¥å‡½æ•°ï¼Œ<code>magic</code>çš„äºŒè¿›åˆ¶ä¸­æœ€åä¸€ä¸ª1æ”¹ä¸º0ï¼Œæ•…<code>confusion</code>å‡½æ•°ä¸­çš„å¾ªç¯æ¬¡æ•°ä¸º<code>magic</code>äºŒè¿›åˆ¶ä¸­çš„1çš„ä¸ªæ•°ã€‚</p><p>å†æ¥çœ‹çœ‹<code>confusion</code>å¾ªç¯ä¸­çš„<code>output</code>çš„å€¼ã€‚ç”±äºæ¯æ¬¡<code>now</code>éƒ½ç­‰äº<code>magic</code>äºŒè¿›åˆ¶ä¸­æœ€åä¸€ä¸ª1åŠåé¢éƒ¨åˆ†ï¼Œäºæ˜¯ä¹åœ¨å¾ªç¯ç»“æŸå<br>$$<br>\begin{align}<br>output &amp;&#x3D; output \oplus now_1\oplus now_2\oplus â€¦\oplus now_n<br>\\&amp;&#x3D; output \oplus magic(æœ€åˆå§‹)<br>\\&amp;&#x3D;magic(æœ€åˆå§‹) \oplus c1 \oplus c2 \oplus magic(æœ€åˆå§‹)<br>\\&amp;&#x3D;c1 \oplus c2<br>\end{align}<br>$$<br>è€Œæ¯æ¬¡å¾ªç¯ä¸­<code>cnt ^= 1</code>ï¼Œæ•…å¾ªç¯æ¬¡æ•°ä¸ºå¶æ•°æ—¶ï¼ˆ<code>magic</code>äºŒè¿›åˆ¶ä¸­1çš„ä¸ªæ•°ä¸ºå¶æ•°ä¸ªï¼‰<code>cnt = 0</code>ï¼Œåä¹‹åˆ™<code>cnt = 1</code>ã€‚</p><p>å¾ªç¯å®Œå<code>output ^= cnt * c1</code>ï¼Œæ•…å¾ªç¯æ¬¡æ•°ä¸ºå¶æ•°æ—¶<code>output = c1^c2</code>ï¼Œåä¹‹åˆ™<code>output = c2</code>ã€‚</p><hr><p>æ ¹æ®ä¸Šè¿°åˆ†æå¯å¾—<code>problem1</code>çš„åŠ å¯†ç®€åŒ–ä¸º<code>ch ^ c2</code>ï¼Œ<code>problem2</code>çš„åŠ å¯†ç®€åŒ–ä¸º<code>ch ^ c1 ^ c2</code>ã€‚</p><p>é€šè¿‡å·²çŸ¥çš„éƒ¨åˆ†æ–‡æ®µå¯ä»¥åˆ†ææ–‡æœ¬æ ¼å¼ä»¥<code>Date: yyyy-mm-dd</code>ä½œä¸ºå¼€å¤´ï¼Œæ—¥æœŸä¿¡æ¯ç”±æ–‡ä»¶åç§°b64decodeå¾—åˆ°ã€‚åˆ©ç”¨å·²çŸ¥æ˜æ–‡å¯†æ–‡å¯¹ï¼Œå¯ä»¥æ¢å¤lfsrçš„å†…éƒ¨çŠ¶æ€ã€‚</p><hr><h2 id="problem1"><a href="#problem1" class="headerlink" title="problem1"></a>problem1</h2><p>åœ¨<code>problem1</code>ä¸­ç”±äº<code>n2 = 12</code>ï¼Œå¯ä»¥å¯¹<code>mask2</code>è¿›è¡Œçˆ†ç ´ï¼Œæ±‚å‡º<code>mask2</code>åå¯ä»¥åæ¨å‡ºï¼ˆæˆ–çˆ†ç ´ï¼‰<code>seed2</code>ï¼Œäºæ˜¯å°±å¯ä»¥è§£å¯†å‡ºå¯¹åº”çš„æ–‡æœ¬ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> magic_box <span class="hljs-keyword">import</span> *<br><br>n1, n2 = <span class="hljs-number">64</span>, <span class="hljs-number">12</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;MTk4NC0wNC0wMQ==_6d30.enc&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    cipher1 = f.read()<br><br>date1 = <span class="hljs-string">&#x27;Date: 1984-04-01&#x27;</span><span class="hljs-comment">#å°‘äº†ä¸ªç©ºæ ¼ï¼Œæ·¦ï¼ä¸€ä¸ªæ™šä¸Šå°±è¿™ä¹ˆæ²¡äº†</span><br>known_output = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(date1)):<br>    bit8 = <span class="hljs-built_in">ord</span>(date1[i]) ^ cipher1[i]<br>    known_output += <span class="hljs-built_in">bin</span>(bit8)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">8</span>)<br><br><span class="hljs-comment">#çˆ†ç ´mask2(12ä½bit)</span><br>mask2 = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> mask <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4096</span>):<br>    output = <span class="hljs-number">0</span><br>    lfsr2 = lfsr(<span class="hljs-built_in">int</span>(known_output[:n2],<span class="hljs-number">2</span>), mask, n2)<span class="hljs-comment">#known_output[:n2],å¦åˆ™å°±æ‹¿ä½ä½å»&amp;äº†</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(known_output) - n2):<br>        output = (output &lt;&lt; <span class="hljs-number">1</span>) ^ lfsr2.<span class="hljs-built_in">next</span>()<br>    <span class="hljs-keyword">if</span> output == <span class="hljs-built_in">int</span>(known_output[n2:],<span class="hljs-number">2</span>):<br>        mask2 = mask<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;mask2 = <span class="hljs-subst">&#123;mask2&#125;</span>&#x27;</span>)<br><span class="hljs-comment">#çˆ†ç ´seed(12ä½bit)</span><br>seed2 = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> seed <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4096</span>):<br>    output = <span class="hljs-number">0</span><br>    lfsr2 = lfsr(seed, mask2, n2)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(known_output)):<br>        output = (output &lt;&lt; <span class="hljs-number">1</span>) ^ lfsr2.<span class="hljs-built_in">next</span>()<br>    <span class="hljs-keyword">if</span> output == <span class="hljs-built_in">int</span>(known_output,<span class="hljs-number">2</span>):<br>        seed2 = seed<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;seed2 = <span class="hljs-subst">&#123;seed2&#125;</span>&#x27;</span>)<br><br>lfsr2 = lfsr(seed2,mask2,n2)<br><br>txt1 = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(cipher1)):<br>    txt1 += <span class="hljs-built_in">chr</span>(lfsr2.getrandbit(<span class="hljs-number">8</span>) ^ cipher1[i])<br><br><span class="hljs-built_in">print</span>(txt1)<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">mask2 = <span class="hljs-number">2053</span><br>seed2 = <span class="hljs-number">2989</span><br><span class="hljs-symbol">Date:</span> <span class="hljs-number">1984</span><span class="hljs-number">-04</span><span class="hljs-number">-01</span><br>The pursuit was renewed, till the water was again muddied.  <span class="hljs-keyword">But </span>he could not <span class="hljs-keyword">wait. </span> He unstrapped the tin <span class="hljs-keyword">bucket </span><span class="hljs-keyword">and </span><span class="hljs-keyword">began </span>to <span class="hljs-keyword">bale </span>the pool.  He <span class="hljs-keyword">baled </span>wildly <span class="hljs-built_in">at</span> first, splashing himself <span class="hljs-keyword">and </span>flinging the water so <span class="hljs-keyword">short </span>a <span class="hljs-keyword">distance </span>that it ran <span class="hljs-keyword">back </span>into the pool.  He worked more carefully, striving to <span class="hljs-keyword">be </span>cool, though his heart was pounding against his chest <span class="hljs-keyword">and </span>his hands were trembling.  <span class="hljs-built_in">At</span> the end of half an hour the pool was nearly dry.  Not a cupful of water remained.  <span class="hljs-keyword">And </span>there was no fish.  He found a hidden crevice among the stones through which it had escaped to the adjoining <span class="hljs-keyword">and </span>larger poolÃ¢Â€Â”a pool which he could not empty in a night <span class="hljs-keyword">and </span>a day.  Had he known of the crevice, he could have <span class="hljs-keyword">closed </span>it with a rock <span class="hljs-built_in">at</span> the <span class="hljs-keyword">beginning </span><span class="hljs-keyword">and </span>the fish would have <span class="hljs-keyword">been </span>his.<br>Thus he thought, <span class="hljs-keyword">and </span>crumpled up <span class="hljs-keyword">and </span>sank down upon the wet earth.  <span class="hljs-built_in">At</span> first he cried softly to himself, then he cried loudly to the pitiless desolation that ringed him around<span class="hljs-comment">; and for a long time after he was shaken by great dry sobs.</span><br>He <span class="hljs-keyword">built </span>a fire <span class="hljs-keyword">and </span>warmed himself <span class="hljs-keyword">by </span>drinking quarts of hot water, <span class="hljs-keyword">and </span>made camp on a rocky ledge in the same fashion he had the night <span class="hljs-keyword">before. </span> The last thing he <span class="hljs-keyword">did </span>was to see that his matches were dry <span class="hljs-keyword">and </span>to wind his watch.  The <span class="hljs-keyword">blankets </span>were wet <span class="hljs-keyword">and </span>clammy.  His ankle pulsed with pain.  <span class="hljs-keyword">But </span>he knew only that he was hungry, <span class="hljs-keyword">and </span>through his restless sleep he dreamed of feasts <span class="hljs-keyword">and </span><span class="hljs-keyword">banquets </span><span class="hljs-keyword">and </span>of food served <span class="hljs-keyword">and </span>spread in all imaginable ways.<br>He awoke chilled <span class="hljs-keyword">and </span>sick.  There was no sun.  The gray of earth <span class="hljs-keyword">and </span>sky had <span class="hljs-keyword">become </span>deeper, more profound.  A raw wind was <span class="hljs-keyword">blowing, </span><span class="hljs-keyword">and </span>the first flurries of snow were whitening the hilltops.  The air about him thickened <span class="hljs-keyword">and </span>grew white while he made a fire <span class="hljs-keyword">and </span><span class="hljs-keyword">boiled </span>more water.  It was wet snow, half rain, <span class="hljs-keyword">and </span>the flakes were large <span class="hljs-keyword">and </span>soggy.  <span class="hljs-built_in">At</span> first they melted as soon as they came in contact with the earth, <span class="hljs-keyword">but </span>ever more fell, covering the ground, putting out the fire, spoiling his supply of moss-fuel.<br></code></pre></td></tr></table></figure><h2 id="problem2"><a href="#problem2" class="headerlink" title="problem2"></a>problem2</h2><p>ç”±äº<code>lfsr2</code>ä¸­çš„<code>n2 = 12</code>ï¼Œæ•…å¯¹<code>seed3</code>è¿›è¡Œçˆ†ç ´ï¼Œæ ¹æ®å¾—å‡ºçš„<code>lfsr2æµ</code>æ¨å‡º<code>lfsr1æµ</code>ã€‚è¿›è€Œæ¢å¤<code>seed1</code>å’Œ<code>mask1</code>ã€‚ä»è€Œå¯¹åŠ å¯†æ–‡æœ¬è§£å¯†ï¼Œç­›é€‰å‡ºflagã€‚</p><p>ï¼ˆå—¯ï¼è¿™ä¸ªBMç®—æ³•è¿˜æ²¡ææ‡‚ï¼Œè´´ä¸€ä¸‹åˆ«äººçš„ä»£ç ï¼Œfrom DengFengï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> libnum<br>n1, n2 = <span class="hljs-number">64</span>, <span class="hljs-number">12</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">lfsr</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, seed, mask, length</span>):<br>        self.length_mask = <span class="hljs-number">2</span> ** length - <span class="hljs-number">1</span><br>        self.mask = mask &amp; self.length_mask<br>        self.state = seed &amp; self.length_mask<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">self</span>):<br>        next_state = (self.state &lt;&lt; <span class="hljs-number">1</span>) &amp; self.length_mask<br>        i = self.state &amp; self.mask &amp; self.length_mask<br>        output = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> i != <span class="hljs-number">0</span>:<br>            output ^^= (i &amp; <span class="hljs-number">1</span>)<br>            i = i &gt;&gt; <span class="hljs-number">1</span><br>        next_state ^^= output<br>        self.state = next_state<br>        <span class="hljs-keyword">return</span> output<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">getrandbit</span>(<span class="hljs-params">self, nbit</span>):<br>        output = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(nbit):<br>            output = (output &lt;&lt; <span class="hljs-number">1</span>) ^^ self.<span class="hljs-built_in">next</span>()<br>        <span class="hljs-keyword">return</span> output<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_key</span>(<span class="hljs-params">mask,key,degree</span>):<br>    R = <span class="hljs-string">&quot;&quot;</span><br>    index = <span class="hljs-number">0</span><br>    key = key[degree-<span class="hljs-number">1</span>] + key[:degree]<br>    <span class="hljs-keyword">while</span> index &lt; degree:<br>        tmp = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(degree):<br>            <span class="hljs-keyword">if</span> mask &gt;&gt; i &amp; <span class="hljs-number">1</span>:<br>                <span class="hljs-comment"># tmp ^= int(key[255 - i])</span><br>                tmp = (tmp+<span class="hljs-built_in">int</span>(key[degree-<span class="hljs-number">1</span>-i]))%<span class="hljs-number">2</span><br>        R = <span class="hljs-built_in">str</span>(tmp) + R<br>        index += <span class="hljs-number">1</span><br>        key = key[degree-<span class="hljs-number">1</span>] + <span class="hljs-built_in">str</span>(tmp) + key[<span class="hljs-number">1</span>:degree-<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(R,<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_int</span>(<span class="hljs-params">x,degree</span>):<br>    m=<span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(degree):<br>        m += <span class="hljs-built_in">str</span>(x[i])<br>    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">int</span>(m,<span class="hljs-number">2</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BM</span>(<span class="hljs-params">r,degree</span>):<br>    a=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(r)):<br>        a.append(<span class="hljs-built_in">int</span>(r[i]))       <span class="hljs-comment">#å°† r è½¬æ¢æˆåˆ—è¡¨a = [0,0,1,...,]æ ¼å¼    </span><br>    res = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(degree):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(degree):<br>            <span class="hljs-keyword">if</span> a[i+j]==<span class="hljs-number">1</span>:<br>                res.append(<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">else</span>:<br>                res.append(<span class="hljs-number">0</span>)<br>    sn = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(degree):<br>        <span class="hljs-keyword">if</span> a[degree+i]==<span class="hljs-number">1</span>:<br>            sn.append(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">else</span>:<br>            sn.append(<span class="hljs-number">0</span>)<br>    MS = MatrixSpace(GF(<span class="hljs-number">2</span>),degree,degree)        <br>    MSS = MatrixSpace(GF(<span class="hljs-number">2</span>),<span class="hljs-number">1</span>,degree)         <br>    A = MS(res)<br>    s = MSS(sn)                       <span class="hljs-comment">#å°† res å’Œ sn çš„å€¼å¯¼å…¥çŸ©é˜µç©ºé—´ä¸­</span><br>    <span class="hljs-keyword">try</span>:<br>        inv = A.inverse()            <span class="hljs-comment"># æ±‚A çš„é€†çŸ©é˜µ</span><br>    <span class="hljs-keyword">except</span> ZeroDivisionError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>,-<span class="hljs-number">1</span><br>    mask = s*inv <br>    <span class="hljs-keyword">return</span> get_key(get_int(mask[<span class="hljs-number">0</span>],degree),r[:degree],degree),get_int(mask[<span class="hljs-number">0</span>],degree)<br><br>seed2 = <span class="hljs-number">2989</span><br>mask2 = <span class="hljs-number">2053</span><br><br>date2 = <span class="hljs-string">b&#x27;Date: 1984-12-25&#x27;</span><br>cipher2 = <span class="hljs-string">b&#x27;\x18\xff\xa57\xa65&quot;\x00\xfd/\x8d\x06\xe7z\xa4\xe6\t$\xec\x94$`\xaalB\xb6\x90`\x9e\&#x27;7\x9f\xcca\xaa1\x96\x19\t\xa2\xb8U\xde\xc5\xa0\xc7\xd23\xcd\xa0\xafRHP\x90\x8a\xa9M\x17@\xef8:]\xe1\xdc\x10\xad\xdfI\x04=\x01\x82\x1a\xec\x1e\x19\xdaV\x95\xc1K\x86\xfdZ\x90O7r\xeeZCewY8\xf1\x80\x81\x16NC\x94\xb0\xa0&lt;\xd5\xc9\x1a\xeb.\xf6\xaa\xbb\xa6\x9a&lt;t\xce\xdcQ$\xfdK\x89v\xee\xe0\x9dc\x9b6\xe6\xf0\xc9\xb6[l\xd3\xdc\xf8\n\xb7\xc6\xf9^\x0eIr\&#x27;&gt;\x1dD!\x83\xfd\xc6Q\xf9\xce\xee%\xa7l\xb9\xfc\xcc\xf9;\x0b\x04\xce\x07\x97\xae\xf5C\xa5\x96\xfeU\xe8\xfb\x06\x96\xe3Dr\x8a\xc8\xb7\xa0\xe4s\xe3\xac\x9dT\t\x0eL*Vys\x03\xbb\xf2$\xa8pR\x8c\xa8h\xf6\x04&lt;I4@&#125;\xe5\x12\x8d\x14\xbe\xe4\xb1\x86V`\xcf\x9bE\x8e\xf0m\xbd\xedP\xe3\xafo7\xbd\xb1\xb9R\x9a2*\xaabz@\xb2\xf9\xf59c\xf9\x13\xf12\x8b\xc2z\xda\xf4\x87\x130\xc2\x93\xf3\xce\x84\xe8q.\x01\xeec\xb1\x10X\xcd\x00\x91%\xb7|yW\xf2\xc4\xb3\x997\xc1\xb45\xe5)K \xfc\x93\x04\xee-\xf9\xc3\x06Js\xe1\tZ\x86=k8:\x17\x9e&#125;\xb1$\xce\xaa\xbc\x05\x97d\x83c~\xf57\x02\x08\xa2\tHz\xecq\x07Y\xe6&#125;\xf8\xf0\xaa\x00\x1e\x12f\xf5\xab\xf62u\x12\xf5\xcfx\xc3)B\xd4\xd1\x9dxX\x0b#\x9f\xf1\xa0&quot;\xb9M\xe9\xcf\x17\xc9\\\xbf\xf3y\xb1E\xc0\xa1\x88\x83\x95\xa6\xc9\xde=Md\xaf\xb4\x14\x815;\x18X\x9bQ2\x86\xa0`x&#123;\x18\xde\xean\xcd\xc3*y\x82\x8c\xe4l\x88\x96\xb7\x0e\x03u\xe7\xe8.&quot;!\xfb\xb1Bg\xea\xa2`\x99\xab\xa4d\xedA\x0e\x86\xd5\xaf5D\&#x27;\xcd3\xbf\xcd5\xb4\xc3^\xfe\x14t\x90\xf9\x01\x98\xd5~s\xdc\xa7\xb1\x8d\xf6\xd9\x92\xb9\xe0\x996?\x8f\\\x1d\xb2\x12\x97\xf6\x07;\xfaTL\x92.\xaf\x16$\xfa\x94\xcb0\xbf\x8a\xad](\xc6&#125;K\xc87\xfc\xc9\xc6\xdb\x08\x99\x9f(&lt;\x1e\x97\xe1\x00^\x13]\x16\xe13\xee\xebS1h\xdd\xe11n\x1a\xe6\x12\x01\xb5\x0c|\xf5\x8a\xbd=5S\xe4\xf9$\xf1\xedp\xce\x1f\x96.\x97\xe4;\x02 \x17&amp;\xd7\xd9*\x1f\xa4u\xe6\xad\xfd\xbaIR\x1f\x1a=F\xbf\xf3\x07\x19!=\xf7\xd8/\xe4i\xc6+\x9c5^t\x7f\xb2\x06\xe8\xf2\xac=\x16\x00r\xdd\x7f\xe34w\xde)\x86\x82\xb6gj\xf4\xfa\x18Pd\xd9\x82\xcd\xda\xee\x8bv\xd1NKu\\\x04\xe2\xbbt\x94\x82\x11\xc9\x1d\xdd\xb1\xb5\x8c\x86\xbfg\xa8L\x1eI\xb4\xddF\x8b\xa7\xd1\x16\x9c\x80\x94UXS\x13\x91\xf8\xe6=\x15\x16\x9a,\x0b8\xd2\xfeE\xa04&quot;\xaa1&#125;\xc7\x93\x9f\xb2%p\xb4\x01\x17r*\xd5\xc6\xfd\xfb\xb0&lt;\x18j\x86\xab\xe0\x17\xf2R\xdfZ\xc3Ty\xe9\xd2j\x8b\x15\t\xabrHwi~1K\x89\xebVZ\xec&#125;\x1av\xc5\x90\xb7\xa5$k\xd3&quot;\x05\xfa\xc6\x1d\xfe\xb5\x9e;#ig\xdd\xa3\x9b.[\x96\xf1r\x01D\xe7\xdeqkj%\x9cvU\xec\x04\xb0\xab\x9e4\x13\xd7\x07\xa8\xcarK&lt;-\xd1x\xb7|\xdf\xc5c\x13R\xd9\x1b\xd8\xa0=F\xbc9\xf2\x8c\xfc\xe8KO\xb6bfv\xaf\xb3\x9c\xa4\x1f(\xc4O\xa9\x0f]x\x832\x89\xd9\xc77\x1fa0\xe4\xac\xa7AA\xc4\x14\x9cm\xd5\xf0\x02\xb4\x9c(ej\xdb\x88U\xa7!+\x83]N\xee\x8c\x87*\x84W\x12$\xfc\x0eEC\xcb\x14\x88\x1eEr\x12N\x8fY\xd6\x18\x8b^\x98z\xbf\x84\xc1\xc8!\x8a\x1a\xaaQ\x89aP\xadL\xa4w\xda\xb9WN\x90\xe1\x9e\xcf\x1fx\xc7\x84\xf4\x0f\x9a8Q\xcc-\xbasuc0\x988\xf8&quot;\xecmFeI?\x13m1\x11D\xe3l\x0b\x16\xf7\xa4\x05[\xd0\xeac\x16\xc6\n`\xcf\xbcf\xda\xc6\xf8n\xbc\xea*\x857n\xb2\x91\x12#\xe0\xf9\x12\xc3\x83\x8f\xfb\x1b\xb2\xd8\xf6\x1fmwC\xaa\x8b\xaeV\xabQ\xd3\xe2\xd6\x1e\xf1u\xc5\xfd\x8a\xf7rw\&#x27;\x12\x95\x9dl:o\r\r\x13\xf9\x02\xab\&#x27;.&#123;\xc0b\x9f\xc1.\xde\xeb\xce\xf1Cd\xbf\xdfOAMi\xc3\x96bhC\xc7\xa6\x1ch\x06X\xed\xafR\xda\x80\xee \x1c=\x92\xf9&amp;\x8b\xbf\x7f\xf1^k[\x94\xd26C\xfe\x1fY16\xc8Q\x9f7`\xc1\xf8D_\xef\xbb$L&gt;R)\xef\xd7\xf5\r\x91\x17@\x8dZ\xa0\x81\x8a&lt;F+\x8d\xd5\n5/\x10\x0ed\xb4\xc1\xc0\xb8a\xe5\x81\x85&#125;\x0f2\x90\xa4\xaeg\xb7\xe8#\xe85h&quot;?\x90\x99\x7f\xe46\xf7y\xe1o\x1e5\xe6o\xda?!\xeb\xc2\x98\xcf\x98\xb0\x15\x01]E\xa5V\x032\xaa\x16\x83K*\xe3$\xcb\xfc\xe6\xb4\x8f\xa2\xa7\x900\x04G\xd8\x95\x98$\x9fN~\xb1\xa7\x0c\x8bGd\xa6\xa7\xe0F\xdd\xa2\xfbU\x9bE\xdc\x025\x1e\xfe\xc5v#\xb1Ft\xc1\x9c\x909\xd9\xb8\xe1h\xc1G*\x02c\xe5\xc7\x91q\x86/\xab\xfaS\xb9Tk\x90\xcc\x07\xb1\xa3E\x11e\x95fw\x02\xbfF\xb7j\x82\r\x92hD\x92\&#x27;FD\xb9\x9b\x0c\xc4%\xb6&gt;:\x1cZ \xc7\x1b\xa9\x15h[\xff?\x88\xcd\xbb\xe5\xf6\xb3\xb6B\xac\xda\xcd\xa7h\x81 \xcd\xeeu@\xef\x92!\xe2Vr+\x1d\xa6\x83Z\xdb\xb7\x1a\xd7#$)\xf1\x1f\x82\xdd\x80A\x94W\xf4\xa1\xe7J$\xda\x02\xd4\xb6\xe5\x84\xbegH\xb9\xc2\xe3\x82\xc5\xfd\xb1\xe7!\xeb\xe0\xd1J\x94\x04\x7f\x81\xee\xafn\xe3\x0e;\x17\xb6\x18\x9e;\xca\xb6`\x89\xd0\&#x27;\x87\xff\xcc \xf4yW#*j\x00ad\x9f.5/\xfc\tx1\xa6\xf7V.]\xfa\xec\xc9\x93\x87\x9a;\xb4\xe0\x0eC\x98&lt;5\x14a\xb1c\xaa\x91\x08O\xbaIz*Y\xf0\t\x8e\x96\x92\xa8\x0b\xeb\xa7\xdep\xa2zl\xd6_\x05%\x96\xda\x9e&quot;\x80\xeb\xf2bc\xfb\t\x1a\xe2h\xd1\x00tb|M\xf6\xd7\xc4.\xb5\xb1\xe3a\xa1\x96\x08\x9f\xa6:\xa8\xccouN^#fq\x03\xcan\x8cRJD6&amp;\n\xda\xe0T\xf5\x18\xfcp\xcd\x8f`\xdcS\x10\x00;\xd2\xb2\x14\xbd\xe4xa\x88v\x03p\x83\xdeL\xb0\xa0\xe8D\x04\xdd~\xa0\xacR\xc6 \xe0\x83t\xbf\xbf\x1d#\xc4`\xbe\xc6\xd7\xf9Z\x08\x88Tm\x81\xd6f*\xdc\x13\x0e\xc7\xae-\xadSmQ\x02y\xa4.\xbe\x8b\xf4\xe7\x9c\xbd\xdc5\xc3\x98&#123;Qw\xba\xeb\xf5\xc6jMy\xcaj\xd5\x01L8&lt;c\xf0k\xd6p\xe7\x1cz\xffW72\xd3&gt;Q\xe1\xab\xc3\x87tTW\xfdb\x88\x07Xu\xf8V\x92\x8e-\xffG\x80j\xd0/\x0e\xe1?W\x8f\xe7\xd2A\x80L\x19d\xce\xd0\xd4]\x00\x92\xde\xb9\xb3|\xda\x13mLQ_4\xbb1\xd3w\xa3f&amp;\xd4=\xd6~/=\x83U\xb6W\xc7\x95\x95\x05\xcb\xe3\xde\xc1\x15\xc9\x9bB\xce\tH\\z\xc1\xf3c\xc1v\xca\xbd\x06,\xea\n\x03\x1b\x12!C\xefj\x97\x96K\x07O\xa9\x98\xca\t\x1e\xd9\xc5\x98=\x9cq\x80\xd0\xba?`\x14\x91\x8c\xa9\xab\x83\\\xa6\xb5&gt;zq\xed\xc68\x0b\xba\xed\xda\xb2N\xfbI\xde\x8d\xb7\x1fu\xce\xf0[D\x9a\x8cW\xea\xd4\xebGz&#125;\x81\xd4\xf4\&#x27;N\\\xceW\x96:E\x06\xed\xd3\x06\xf8\x18d\x9e\x0edW\xdcb\xe1\xea\x1c+I\xf8\xdc\xd4\xda\\r~\x96\xb9?yd\xd9\xb7&#125;\xfb\x9ek\x85\xa84h\xf9\x8b\&#x27;(\xa9\xb4S\x87\xc7\x87\xa7\xf1\xdaIy\x95D\xfe\xe3\x90\xf0\x08\xf3\xfc\x00\x8e\x81\xc2k\xb8a3\xc1&#125;@\x8d\\\xf9T\xfc\xb0J\xeb\x8f\x99\xc9~\x95_\x14\xdde\x1c\xaf\xbeG\xd8\xdc\x99))\xb5\x8f\xdd\xdc\x06O~(\x0c\xa1\x1d\xa5c4\xf9=~Z\xc2\xea5G\xed\x10\x85S\x00~\x0c*\x14$\xcb\x0b\x08$0\x89\x1e\xd6Qq\x81\x18_\xb0\xc9o\x81,_\x9c\xcfi\xb7\x86\xf1\xbd\xa8\xa2N\x84@~\xaf.\x9f\x89\xbd/\xc3n\xcd\xf1\xc0\x83\xbaQ\xe1,\x9c6&quot;p]\xb5\xae\x835\xd1\xb6m\xe7M0&amp;q\xb3\x91S\xd0o\xdbF\xbc&lt;\x17&#123;eP6\xc3c\x7fR\x9a\xacWd3?\xb6joQ\x1d\xb2_\xc1\x9d`\xb8\x08!\x97\xc3z3Y_\xb8@\x88\xecc\r\xc1\xb7y\x80&#x27;</span><br>bits =<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(date2)):<br>    tmp = <span class="hljs-built_in">bin</span>(cipher2[:<span class="hljs-built_in">len</span>(date2)][i]^^date2[i])[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">8</span>)<br>    bits += tmp<br><br><span class="hljs-keyword">for</span> seed3 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>&lt;&lt;n2,<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>):<br>    lfsr2 = lfsr(seed3,mask2,n2)<br>    output2 = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(date2)):<br>        tmp = lfsr2.getrandbit(<span class="hljs-number">8</span>)<br>        output2 += <span class="hljs-built_in">bin</span>(tmp)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">8</span>)<br>    output1 = <span class="hljs-built_in">int</span>(bits,<span class="hljs-number">2</span>)^^<span class="hljs-built_in">int</span>(output2,<span class="hljs-number">2</span>)<br>    output1 = <span class="hljs-built_in">bin</span>(output1)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">128</span>)<br>    seed1, mask1 = BM(output1,<span class="hljs-number">64</span>)<br>    <span class="hljs-keyword">if</span> seed1 == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> mask1 == -<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">continue</span><br>    lfsr1 = lfsr(seed1,mask1,n1)<br>    lfsr2 = lfsr(seed3,mask2,n2)<br>    flag = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> cipher2:<br>        temp = i^^lfsr1.getrandbit(<span class="hljs-number">8</span>)^^lfsr2.getrandbit(<span class="hljs-number">8</span>)<br>        <span class="hljs-comment">#flag += libnum.n2s(int(temp))</span><br>        flag += <span class="hljs-built_in">chr</span>(temp)<br>    <span class="hljs-built_in">print</span>(seed3)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;SUSCTF&#x27;</span> <span class="hljs-keyword">in</span> flag <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;CTF&#x27;</span> <span class="hljs-keyword">in</span> flag <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;ctf&#x27;</span> <span class="hljs-keyword">in</span> flag:<br>        <span class="hljs-built_in">print</span>(flag)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">seed3 = 3054</span><br><span class="hljs-string">Date: 1984-12-25</span><br><span class="hljs-string">Though the hunger pangs were no longer so exquisite, he realized that he was weak.  He was compelled to pause for frequent rests, when he attacked the muskeg berries and rush-grass patches.  His tongue felt dry and large, as though covered with a fine hairy growth, and it tasted bitter in his mouth.  His heart gave him a great deal of trouble.  When he had travelled a few minutes it would begin a remorseless thump, thump, thump, and then leap up and away in a painful flutter of beats that choked him and made him go faint and dizzy.</span><br><span class="hljs-string">In the middle of the day he found two minnows in a large pool.  It was impossible to bale it, but he was calmer now and managed to catch them in his tin bucket.  They were no longer than his little finger, but he was not particularly hungry.  The dull ache in his stomach had been growing duller and fainter.  It seemed almost that his stomach was dozing.  He ate the fish raw, masticating with painstaking care, for the eating was an act of pure reason.  While he had no desire to eat, he knew that he must eat to live.</span><br><span class="hljs-string">In the evening he caught three more minnows, eating two and saving the third for breakfast.  The sun had dried stray shreds of moss, and he was able to warm himself with hot water.  He had not covered more than ten miles that day; and the next day, travelling whenever his heart permitted him, he covered no more than five miles.  But his stomach did not give him the slightest uneasiness.  It had gone to sleep.  He was in a strange country, too, and the caribou were growing more plentiful, also the wolves.  Often their yelps drifted across the desolation, and once he saw three of them slinking away before his path.</span><br><span class="hljs-string">The content is an excerpt from Love of Life, by Jack London. The problem is mainly about LFSR and I&#x27;ve tried not to make it hard (with the cost of some running time, actually). Your flag is SUSCTF&#123;Thx_f0r_y0uR_P4ti3nce_:)_GoodLuck!_1bc9b80142c24fef610b8d770b500009&#125; and I hope you will enjoy our game. You&#x27;ll find this problem so ez while solving other problems, which is created by --.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p>[SUSCTF2022_official_wp&#x2F;Ez_Pager_Tiper wp.md at main Â· susers&#x2F;SUSCTF2022_official_wp (github.com)](<a href="https://github.com/susers/SUSCTF2022_official_wp/blob/main/crypto/Ez_Pager_Tiper/Ez_Pager_Tiper">https://github.com/susers/SUSCTF2022_official_wp/blob/main/crypto/Ez_Pager_Tiper/Ez_Pager_Tiper</a> wp.md)</p><p>[SUSCTF-Cryptoæ–¹å‘æ‰€æœ‰èµ›é¢˜ - Love_DengFengâ€™s Blog](<a href="https://love-deng-feng.top/2022/03/02/Writeup">https://love-deng-feng.top/2022/03/02/Writeup</a> of SUSCTF&#x2F;)</p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
      <tag>æµå¯†ç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ACTF2022</title>
    <link href="/2022/06/26/ACTF2022/"/>
    <url>/2022/06/26/ACTF2022/</url>
    
    <content type="html"><![CDATA[<h1 id="impossible-RSA"><a href="#impossible-RSA" class="headerlink" title="impossible RSA"></a>impossible RSA</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> Crypto.PublicKey <span class="hljs-keyword">import</span> RSA<br><br>e = <span class="hljs-number">65537</span><br>flag = <span class="hljs-string">b&#x27;ACTF&#123;...&#125;&#x27;</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p = getPrime(<span class="hljs-number">1024</span>)<br>    q = inverse(e, p)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isPrime(q):<br>        <span class="hljs-keyword">continue</span><br>    n = p * q;<br>    public = RSA.construct((n, e))<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;public.pem&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> file:<br>        file.write(public.exportKey(<span class="hljs-string">&#x27;PEM&#x27;</span>))<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> file:<br>        file.write(long_to_bytes(<span class="hljs-built_in">pow</span>(bytes_to_long(flag), e, n)))<br>    <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure><p>$$<br>e*q &#x3D; 1 \ mod\ p\\<br>&#x3D;&#x3D;&gt;e*q &#x3D; 1 + k*p(å¯ä»¥çŸ¥é“kçš„å€¼è¿‘ä¼¼e)\\<br>&#x3D;&#x3D;&gt;e*q^2-q-k*n&#x3D;0\\<br>è§£æ–¹ç¨‹å°±è¡Œäº†<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">import</span> rsa<br><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;public.pem&quot;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    keydata = f.read()<br>    pubckey = rsa.PublicKey.load_pkcs1_openssl_pem(keydata)<br>    pubckey.n<br>    pubckey.e<br><br>n = pubckey.n<br>e = pubckey.e<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;n = <span class="hljs-subst">&#123;n&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e = <span class="hljs-subst">&#123;e&#125;</span>&#x27;</span>)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    c = bytes_to_long(f.read())<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;c = <span class="hljs-subst">&#123;c&#125;</span>&#x27;</span>)<br><br><span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,e):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;k = <span class="hljs-subst">&#123;k&#125;</span>&quot;</span>)<br>    deta = <span class="hljs-number">1</span> + <span class="hljs-number">4</span> * k * e * n<br>    <span class="hljs-keyword">if</span> gmpy2.iroot(deta,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>] &gt;= <span class="hljs-number">0</span>:<br>        <span class="hljs-comment">#p = int((gmpy2.iroot(deta,2)[0]+1)/(2*e))</span><br>        p = <span class="hljs-built_in">int</span>(gmpy2.iroot(deta,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]+<span class="hljs-number">1</span>)//(<span class="hljs-number">2</span>*e)<span class="hljs-comment">#å‰é¢éœ€è¦intåŒ–ï¼Œæ·¦ï¼</span><br>        q = n//p<br>        <span class="hljs-keyword">if</span> p*q == n:<br>            phi = (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>            d = gmpy2.invert(e, phi)<br>            m = <span class="hljs-built_in">pow</span>(c, d, n)<br>            flag = long_to_bytes(m)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;ACTF&#x27;</span> <span class="hljs-keyword">in</span> flag:<br>                <span class="hljs-built_in">print</span>(flag)<br>                <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure><h1 id="RSA-LEAK"><a href="#RSA-LEAK" class="headerlink" title="RSA LEAK"></a>RSA LEAK</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sage.<span class="hljs-built_in">all</span> <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> bytes_to_long<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leak</span>(<span class="hljs-params">a, b</span>):<br>    p = random_prime(<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">64</span>))<br>    q = random_prime(<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">64</span>))<br>    n = p*q<br>    e = <span class="hljs-number">65537</span><br>    <span class="hljs-built_in">print</span>(n)<br>    <span class="hljs-built_in">print</span>((<span class="hljs-built_in">pow</span>(a, e) + <span class="hljs-built_in">pow</span>(b, e) + <span class="hljs-number">0xdeadbeef</span>) % n)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_key</span>():<br>    a = randrange(<span class="hljs-number">0</span>, <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>,<span class="hljs-number">256</span>))<br>    b = randrange(<span class="hljs-number">0</span>, <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>,<span class="hljs-number">256</span>))<br>    p = <span class="hljs-built_in">pow</span>(a, <span class="hljs-number">4</span>)<br>    q = <span class="hljs-built_in">pow</span>(b, <span class="hljs-number">4</span>)<br>    rp = randrange(<span class="hljs-number">0</span>, <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>,<span class="hljs-number">24</span>))<br>    rq = randrange(<span class="hljs-number">0</span>, <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>,<span class="hljs-number">24</span>))<br>    pp = next_prime(p+rp)<br>    qq = next_prime(q+rq)<br>    <span class="hljs-keyword">if</span> pp % <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>) == (pp-p) % <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>) <span class="hljs-keyword">and</span> qq % <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>) == (qq-q) % <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>):<br>        n = pp*qq<br>        rp = pp-p<br>        rq = qq-q<br>        <span class="hljs-keyword">return</span> n, rp, rq<br>    <br>n, rp, rq = gen_key()<br>e = <span class="hljs-number">65537</span><br>c = <span class="hljs-built_in">pow</span>(bytes_to_long(flag), e, n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;n =&quot;</span>, n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;e =&quot;</span>, e)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;c =&quot;</span>, c)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=======leak=======&quot;</span>)<br>leak(rp, rq)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">n = 3183573836769699313763043722513486503160533089470716348487649113450828830224151824106050562868640291712433283679799855890306945562430572137128269318944453041825476154913676849658599642113896525291798525533722805116041675462675732995881671359593602584751304602244415149859346875340361740775463623467503186824385780851920136368593725535779854726168687179051303851797111239451264183276544616736820298054063232641359775128753071340474714720534858295660426278356630743758247422916519687362426114443660989774519751234591819547129288719863041972824405872212208118093577184659446552017086531002340663509215501866212294702743</span><br><span class="hljs-string">e = 65537</span><br><span class="hljs-string">c = 48433948078708266558408900822131846839473472350405274958254566291017137879542806238459456400958349315245447486509633749276746053786868315163583443030289607980449076267295483248068122553237802668045588106193692102901936355277693449867608379899254200590252441986645643511838233803828204450622023993363140246583650322952060860867801081687288233255776380790653361695125971596448862744165007007840033270102756536056501059098523990991260352123691349393725158028931174218091973919457078350257978338294099849690514328273829474324145569140386584429042884336459789499705672633475010234403132893629856284982320249119974872840</span><br><span class="hljs-string">=======leak=======</span><br><span class="hljs-string">122146249659110799196678177080657779971</span><br><span class="hljs-string">90846368443479079691227824315092288065</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br></code></pre></td></tr></table></figure><h2 id="æ³•ä¸€"><a href="#æ³•ä¸€" class="headerlink" title="æ³•ä¸€"></a>æ³•ä¸€</h2><p>è®ºæ–‡ï¼š<a href="https://einspem.upm.edu.my/journal/fullpaper/vol13saugust/8.pdf">8.pdf (upm.edu.my)</a></p><p>é€šè¿‡ä¸Šè¿°è®ºæ–‡å¯çŸ¥ï¼Œæˆ‘ä»¬è¦å…ˆæ±‚å‡º<code>rp(pp-p),rq(qq-q)</code>ã€‚</p><p>ä»¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">leak_out = <span class="hljs-number">90846368443479079691227824315092288065</span><br>leak_n = <span class="hljs-number">122146249659110799196678177080657779971</span><br>tmp = <span class="hljs-number">0xdeadbeef</span><br></code></pre></td></tr></table></figure><p>è¯¥é¢˜ä¸­<code>leak_n</code>å¾ˆå°æ˜“åˆ†è§£å‡º<code>leak_p,leak_q</code>ï¼Œä¸”<code>rp,rq</code>çš„èŒƒå›´åœ¨[0,1&lt;&lt;24]å·¦å³ï¼Œæ•…å¯ä»¥å¯¹<code>rp</code>è¿›è¡Œæšä¸¾ï¼ˆæšä¸¾èŒƒå›´å¯ä»¥å‡åŠï¼Œå³<code>rp,rq</code>çš„å€¼å¯¹è°ƒï¼‰ï¼Œæœ‰ç­‰å¼$rq^e &#x3D; leak\_out - tmp - rq^e\quad (mod\quad leak\_n)$ï¼Œç„¶åè§£å¯†å¾—åˆ°<code>rq</code>ï¼Œé€šè¿‡ä»¥ä¸‹æ¡ä»¶ç­›é€‰å‡º<code>rp,rq</code></p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs excel"><span class="hljs-number">1</span>)rq in [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">24</span>)<br><span class="hljs-number">2</span>)rp*rq â‰¡ <span class="hljs-built_in">n</span> (<span class="hljs-built_in">mod</span> <span class="hljs-number">16</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åå†æ ¹æ®è®ºæ–‡ä¸­çš„æ­¥éª¤å†™å‡ºç®—æ³•ï¼š</p><p><a href="https://imgtu.com/i/vCJKgI"><img src="https://s1.ax1x.com/2022/07/28/vCJKgI.png" alt="vCJKgI.png" border="0" /></a></p><p>ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> iroot,invert<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">from</span> math <span class="hljs-keyword">import</span> ceil,floor<br><br>n = <span class="hljs-number">3183573836769699313763043722513486503160533089470716348487649113450828830224151824106050562868640291712433283679799855890306945562430572137128269318944453041825476154913676849658599642113896525291798525533722805116041675462675732995881671359593602584751304602244415149859346875340361740775463623467503186824385780851920136368593725535779854726168687179051303851797111239451264183276544616736820298054063232641359775128753071340474714720534858295660426278356630743758247422916519687362426114443660989774519751234591819547129288719863041972824405872212208118093577184659446552017086531002340663509215501866212294702743</span><br>e = <span class="hljs-number">65537</span><br>c = <span class="hljs-number">48433948078708266558408900822131846839473472350405274958254566291017137879542806238459456400958349315245447486509633749276746053786868315163583443030289607980449076267295483248068122553237802668045588106193692102901936355277693449867608379899254200590252441986645643511838233803828204450622023993363140246583650322952060860867801081687288233255776380790653361695125971596448862744165007007840033270102756536056501059098523990991260352123691349393725158028931174218091973919457078350257978338294099849690514328273829474324145569140386584429042884336459789499705672633475010234403132893629856284982320249119974872840</span><br><br>leak_n = <span class="hljs-number">122146249659110799196678177080657779971</span><br>leak_p = <span class="hljs-number">8949458376079230661</span><br>leak_q = <span class="hljs-number">13648451618657980711</span><br>leak_phi = (leak_p - <span class="hljs-number">1</span>)*(leak_q - <span class="hljs-number">1</span>)<br>leak_d = invert(e,leak_phi)<br>leak_out = <span class="hljs-number">90846368443479079691227824315092288065</span><br>leak_out -= <span class="hljs-number">0xdeadbeef</span><br>m = <span class="hljs-number">4</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">for rp in tqdm(range(1,16777216)):</span><br><span class="hljs-string">    rpe = pow(rp,e,leak_n)</span><br><span class="hljs-string">    rq = pow(leak_out-rpe,leak_d,leak_n)</span><br><span class="hljs-string">    #if rq.bit_length() in range(23,25):</span><br><span class="hljs-string">    if rq.bit_length() &lt;= 24 and n%16 == (rp*rq)%16:</span><br><span class="hljs-string">        print(rp,rq)</span><br><span class="hljs-string">        break</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#rp, rq = 405771, 11974933</span><br>rq, rp = <span class="hljs-number">405771</span>, <span class="hljs-number">11974933</span><br>start = ceil(iroot(rp*rq,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])<br>edge = floor(rq/<span class="hljs-number">2</span>+<span class="hljs-number">2</span>**(m/<span class="hljs-number">2</span>-<span class="hljs-number">1</span>)*rp+<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;start = <span class="hljs-subst">&#123;start&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;edge = <span class="hljs-subst">&#123;edge&#125;</span>&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(start,edge)):<br>    sigma = (<span class="hljs-built_in">int</span>(iroot(n,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]) - i)**<span class="hljs-number">2</span><span class="hljs-comment">#æ•´æ•°åŒ–</span><br>    z = (n - rp*rq)%sigma<br>    delta = z**<span class="hljs-number">2</span> - <span class="hljs-number">4</span>*sigma*rp*rq<br>    <span class="hljs-keyword">if</span> delta &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> iroot(delta,<span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]:<br>        x1, x2 = (z+<span class="hljs-built_in">int</span>(iroot(delta,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]))//<span class="hljs-number">2</span>, (z-<span class="hljs-built_in">int</span>(iroot(delta,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>]))//<span class="hljs-number">2</span><span class="hljs-comment">#æ•´æ•°åŒ–</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;x1 = <span class="hljs-subst">&#123;x1&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">assert</span> x1**<span class="hljs-number">2</span> - z*x1 + sigma*rp*rq == <span class="hljs-number">0</span><br>        maybe_p = <span class="hljs-built_in">int</span>(n//(x1//rp+rq))<br>        <span class="hljs-keyword">if</span> n%maybe_p == <span class="hljs-number">0</span>:<br>            p = maybe_p<br>            q = n//p<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;p = <span class="hljs-subst">&#123;p&#125;</span>\nq = <span class="hljs-subst">&#123;q&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;x2 = <span class="hljs-subst">&#123;x2&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">assert</span> x2**<span class="hljs-number">2</span> - z*x2 + sigma*rp*rq == <span class="hljs-number">0</span><br>        maybe_q = <span class="hljs-built_in">int</span>(n//(x2//rq+rp))<br>        <span class="hljs-keyword">if</span> n%maybe_q == <span class="hljs-number">0</span>:<br>            q = maybe_q<br>            p = n//q<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;p = <span class="hljs-subst">&#123;p&#125;</span>\nq = <span class="hljs-subst">&#123;q&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br><br>phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>d = invert(e,phi)<br>flag = long_to_bytes(<span class="hljs-built_in">pow</span>(c,d,n))<br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><h2 id="æ³•äºŒ"><a href="#æ³•äºŒ" class="headerlink" title="æ³•äºŒ"></a>æ³•äºŒ</h2><p><code>rp,rq</code>çš„æ±‚æ³•åŒä¸Šã€‚ï¼ˆrp &#x3D; pp - pï¼Œrq &#x3D; qq-qï¼‰<br>$$<br>\begin{cases}<br>pp &#x3D; a^4+rp<br>\\qq &#x3D; b^4+rq<br>\end{cases}<br>$$<br>æ¯”è¾ƒå„æ•°å€¼å¤§å°</p><figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs parser3"><span class="language-xml">a,båœ¨</span><span class="hljs-number">256</span><span class="language-xml">bitå·¦å³ï¼Œa</span><span class="hljs-keyword">^4</span><span class="language-xml">,b</span><span class="hljs-keyword">^4</span><span class="language-xml">åœ¨</span><span class="hljs-number">1024</span><span class="language-xml">bitå·¦å³</span><br><span class="language-xml">è€Œrp,rqåœ¨</span><span class="hljs-number">24</span><span class="language-xml">bitå·¦å³</span><br><span class="language-xml">æ•…n=pp*qq=(a</span><span class="hljs-keyword">^4</span><span class="language-xml">+rp)*(b</span><span class="hljs-keyword">^4</span><span class="language-xml">+rq)â‰ˆa</span><span class="hljs-keyword">^4</span><span class="language-xml">*b</span><span class="hljs-keyword">^4</span><br></code></pre></td></tr></table></figure><p>äºæ˜¯å¯ä»¥è”ç«‹æ–¹ç¨‹<br>$$<br>\begin{cases}<br>n &#x3D; (a^4+rp)*(b^4+rq)<br>\\n^{1&#x2F;4} &#x3D; a*b<br>\end{cases}<br>$$<br>è§£æ­¤æ–¹ç¨‹å¯å¾—åˆ°<code>a,b</code>ï¼Œç»§è€Œæ±‚å‡º<code>p,q</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> iroot,invert<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br>n = <span class="hljs-number">3183573836769699313763043722513486503160533089470716348487649113450828830224151824106050562868640291712433283679799855890306945562430572137128269318944453041825476154913676849658599642113896525291798525533722805116041675462675732995881671359593602584751304602244415149859346875340361740775463623467503186824385780851920136368593725535779854726168687179051303851797111239451264183276544616736820298054063232641359775128753071340474714720534858295660426278356630743758247422916519687362426114443660989774519751234591819547129288719863041972824405872212208118093577184659446552017086531002340663509215501866212294702743</span><br>e = <span class="hljs-number">65537</span><br>c = <span class="hljs-number">48433948078708266558408900822131846839473472350405274958254566291017137879542806238459456400958349315245447486509633749276746053786868315163583443030289607980449076267295483248068122553237802668045588106193692102901936355277693449867608379899254200590252441986645643511838233803828204450622023993363140246583650322952060860867801081687288233255776380790653361695125971596448862744165007007840033270102756536056501059098523990991260352123691349393725158028931174218091973919457078350257978338294099849690514328273829474324145569140386584429042884336459789499705672633475010234403132893629856284982320249119974872840</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">for i in tqdm(range(1,16777216)):</span><br><span class="hljs-string">    rpe = pow(rp,e,leak_n)</span><br><span class="hljs-string">    rq = pow(leak_out-rpe,leak_d,leak_n)</span><br><span class="hljs-string">    if rq.bit_length() &lt;= 24 and n%16 == (rp*rq)%16:</span><br><span class="hljs-string">        print(rp,rq)</span><br><span class="hljs-string">        break</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>rp, rq = <span class="hljs-number">405771</span>, <span class="hljs-number">11974933</span><br><br>a,b = Ints(<span class="hljs-string">&#x27;a b&#x27;</span>)<br>solver = Solver()<br><span class="hljs-comment">#solver.add(n == (a**4+rp)*(b**4+rq))</span><br><span class="hljs-comment">#solver.add(int(iroot(n,4)[0]) == a*b)#intåŒ–</span><br>solver.add( n == (a**<span class="hljs-number">4</span>+rp)*(b**<span class="hljs-number">4</span>+rq), <span class="hljs-built_in">int</span>(iroot(n,<span class="hljs-number">4</span>)[<span class="hljs-number">0</span>]) == a*b )<br><span class="hljs-keyword">if</span> solver.check() == sat:<br>    result = solver.model()<br><br>a_, b_ = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">str</span>(result[a])), <span class="hljs-built_in">int</span>(<span class="hljs-built_in">str</span>(result[b]))<span class="hljs-comment">#å¿…é¡»å…ˆæ•´æ•°åŒ–ï¼Œå¦åˆ™åé¢çš„p,qæ˜¯å¼å­</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;a = <span class="hljs-subst">&#123;a_&#125;</span>,b = <span class="hljs-subst">&#123;b_&#125;</span>&#x27;</span>)<br>p = a_**<span class="hljs-number">4</span>+rp<br>q = b_**<span class="hljs-number">4</span>+rq<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;p = <span class="hljs-subst">&#123;p&#125;</span>\nq = <span class="hljs-subst">&#123;q&#125;</span>&#x27;</span>)<br><br><span class="hljs-keyword">assert</span> p*q == n<br>d = invert(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://files.zsxq.com/Fs-DbVF1HxSse2xhcc_dzxypH0RM?attname=ACTF%20WriteUp%20By%20Nu1L.pdf&e=1656393210&token=kIxbL07-8jAj8w1n4s9zv64FuZZNEATmlU_Vm6zD:lR1WUNhjBvWtVI20OtfYRO26-lY=">ACTF WriteUp By Nu1L</a></p><p><a href="https://einspem.upm.edu.my/journal/fullpaper/vol13saugust/8.pdf">8.pdf (upm.edu.my)</a></p><p><a href="https://furutsuki.hatenablog.com/entry/2022/06/28/001931">ACTF 2022 writeup - ãµã‚‹ã¤ã (hatenablog.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®æ³¢å¸‚ç½‘ç»œå®‰å…¨å¤§èµ›2022-Crypto-WP</title>
    <link href="/2022/05/16/%E5%AE%81%E6%B3%A2%E5%B8%82%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B2022/"/>
    <url>/2022/05/16/%E5%AE%81%E6%B3%A2%E5%B8%82%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B2022/</url>
    
    <content type="html"><![CDATA[<h1 id="n-n"><a href="#n-n" class="headerlink" title="n_n"></a>n_n</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">ucnd fclsmn.rmjy.irdapc jdsncm zpmscjdp, almph_mn_yniz<br>ucnd hpfcpm jdsncm uyvz<br>jdsncm zdsl2<br><br>s = zpmscjdp(<span class="hljs-number">1024</span>)<br>x = zpmscjdp(<span class="hljs-number">1024</span>)<br>i = s * x<br>p = 0g130u7u3<br>k = zdsl2.jiwpcm(p, (s-<span class="hljs-number">1</span>)*(x-<span class="hljs-number">1</span>))<br>jiws_x = zdsl2.jiwpcm(s, x)<br>jiwx_s = zdsl2.jiwpcm(x, s)<br><br>d = almph_mn_yniz(uyvz)<br>f = zdsl2.snbdnk(d, p, i)<br><br>scjim(p)<br>scjim(k)<br>scjim(jiws_x)<br>scjim(jiwx_s)<br>scjim(f)<br></code></pre></td></tr></table></figure><p>ä¸€çœ‹å°±æ˜¯å­—æ¯æ›¿æ¢äº†ï¼Œæ‹¿åˆ°<a href="https://quipqiup.com/">quipqiup - cryptoquip and cryptogram solver</a>ä¸Šåˆ†æä¸€ä¸‹å°±æœ‰äº†å¤§è‡´æ„æ€äº†ï¼Œå†ç¨å¾®åŠ ç‚¹é™åˆ¶å°±è¡Œäº†ã€‚</p><p>å‡ºæ¥æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> crypto.util.number <span class="hljs-keyword">import</span> getprime, bytes_to_long<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">import</span> gmpy2<br><br>p = getprime(<span class="hljs-number">1024</span>)<br>q = getprime(<span class="hljs-number">1024</span>)<br>n = p * q<br>e = <span class="hljs-number">0x130f7f3</span><br>d = gmpy2.invert(e, (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>))<br>invp_q = gmpy2.invert(p, q)<br>invq_p = gmpy2.invert(q, p)<br>m = bytes_to_long(flag)<br>c = gmpy2.powmod(m, e, n)<br><span class="hljs-built_in">print</span>(e)<br><span class="hljs-built_in">print</span>(d)<br><span class="hljs-built_in">print</span>(invp_q)<br><span class="hljs-built_in">print</span>(invq_p)<br><span class="hljs-built_in">print</span>(c)<br></code></pre></td></tr></table></figure><p>ä¸€é“ä¸é•¿å®‰â€œæˆ˜ç–«â€ç›¸åŒçš„é¢˜ç›®ï¼ˆæ²¡å†™ï¼Œè¿˜ä¸ä¼šï¼‰ã€‚</p><p>ä¸ºäº†æ–¹é¢ä¹¦å†™ï¼Œè¿™é‡Œä»¤$s &#x3D; invp\_q,t &#x3D; invq\_p$<br>$$<br>\begin{cases} s*p &#x3D; 1\ mod\ q\\ t*q &#x3D; 1\ mod\ p \end{cases}<br>$$<br>æ”¹å†™æˆ<br>$$<br>\begin{cases} s*p &#x3D; 1+k_1*q\\ t*q &#x3D; 1+k_2*p \end{cases}<br>$$<br>ä¸¤å¼ç›¸å‡<br>$$<br>(s+k_2)*p &#x3D; (k_1+t)*q<br>$$<br>å®¹æ˜“çŸ¥é“pâ‰ qï¼Œæ‰€ä»¥<br>$$<br>\begin{cases} p &#x3D; k_1 + t\\ q &#x3D; k_2 + s \end{cases}<br>$$<br>å°† p,q ä»£å…¥$s*p &#x3D; 1+k_1*q$ï¼Œå¾—<br>$$<br>s*t &#x3D; 1 + k_1*k_2<br>$$<br>å¾—å‡º<br>$$<br>k_1 &#x3D; \dfrac{s*t-1}{k_2}<br>$$<br>æ ¹æ®<br>$$<br>Ï†(n) &#x3D; (p-1)*(q-1)<br>$$<br>æœ‰æ–¹ç¨‹<br>$$<br>(t-1)*k_2^2+(2*s*t-t-s-Ï†(n))*k_2+(s*t-1)*(s-1)&#x3D;0<br>$$<br>è€Œ$k &#x3D; \dfrac{e*d-1}{Ï†(n)}$ï¼Œ$d&lt;Ï†(n)$ï¼Œæ‰€ä»¥$k&lt;e$ï¼Œäºæ˜¯å°†$k_2$çš„å–å€¼çº¦æŸåˆ°$(0,e)$ä¸Šï¼Ÿï¼ˆè¿™kèƒ½ä¸€æ ·å—ï¼Ÿï¼‰</p><p>é€šè¿‡æšä¸¾kï¼Œè§£æ–¹ç¨‹æ±‚å‡º$k_2$ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br>e = <span class="hljs-number">19986419</span><br>d = <span class="hljs-number">3246030980112569716252525489178402976566547966168594693884910274513154299462041341004375201921016318938426026345098668299377474330375073434720935772407207944175167323817898036516011079576927822972280584550642421759163857196487310343842151887753901290056007928776238985151298531470667875043069631236869106891057021962478109360022955201129953336276429238305672598460147562806963064866859947227329083491706302615233310732434276569920504055705370558759864687603230396302816302264528911561986103345422868194300484993924394687653074699941027740263298870609889050004072341364150017277319759241334188164360195703910784166355</span><br>s = <span class="hljs-number">23389236347134283235213306702183810016424721867486963556461081084876520502820941836694411695676757754191365637169094291954507615676165999068189562213594619012687252636744435260033076208286475321060918985189871377901228212667433573382718485160649112811594950994116619369682212010587535385364596418447338709974</span><br>t = <span class="hljs-number">102920556609507191536438498232122774923059359709189772008951429751731499708926283579532737890030392620334257693429608011647339365489651578950937878926965514185822024062626226427621775843089345409431424163821245825850075741313035783453477904427927137045546100973267423868918950101645341426259141920145517101346</span><br>c = <span class="hljs-number">1553892238198363827492950017785469649883078335860404183601470514633985702148771439291915519584864956768837128975747502834867950051639396112333353729920983641277214334076161962538797900388907160490701194265684200572530520821773449401826082542234651817152190240489004982304794568360099499384170323027423530546020874791949260720440971235829841009999271630682762487975448340845503303511707467319967171026472363519627299488034799105120005884793797012235913877429590605758066993126024240880065915024533204819606519268788794771634158963247834960191894770256479582799808670787421459015846778168822826961225790849202125973374</span><br>kphi = e*d-<span class="hljs-number">1</span><br><br><span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,e):<br>    <span class="hljs-keyword">if</span> kphi%k == <span class="hljs-number">0</span>:<br>        phi = kphi//k<br>        x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br>        solve = Solver()<br>        solve.add(x*phi == (s*t-<span class="hljs-number">1</span>+(t-<span class="hljs-number">1</span>)*x)*(x+s-<span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">if</span> solve.check() == sat:<br>            result = solve.model()<br>            k2 = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">str</span>(result[x]))<br>            k1 = (s*t-<span class="hljs-number">1</span>)//k2<br>            p = k1 + t<br>            q = k2 + s<br>            <span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-built_in">pow</span>(c,d,p*q)))<br>            <span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-built_in">pow</span>(c, d, p)))<br>            <span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-built_in">pow</span>(c, d, q)))<br><br><span class="hljs-comment">#flag&#123;e171892fdcccfc5b0c390806b975a72c&#125;</span><br></code></pre></td></tr></table></figure><h1 id="PRNG"><a href="#PRNG" class="headerlink" title="PRNG"></a>PRNG</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> random<br>p0 = <span class="hljs-number">115792089210356248762697446949407573530086143415290314195533631308867097853951</span><br>a = <span class="hljs-number">115792089210356248762697446949407573530086143415290314195533631308867097853948</span><br>b = <span class="hljs-number">41058363725152142129326129780047268409114441015993725554835256314039467401291</span><br>E=EllipticCurve(GF(p0),[a,b])<br>P0=E(<span class="hljs-number">0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296</span>,<span class="hljs-number">0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5</span>)<br>n=<span class="hljs-number">0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551</span><br>rlist1=[]<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">624</span>):<br>    rlist1.append(random.getrandbits(<span class="hljs-number">32</span>))<br><span class="hljs-built_in">print</span>(rlist1)<br>s0=random.getrandbits(<span class="hljs-number">256</span>)<br>RMT=random.getrandbits(<span class="hljs-number">256</span>)<br>s0=s0%n<br>p=getPrime(<span class="hljs-number">256</span>)<br>q=getPrime(<span class="hljs-number">256</span>)<br><span class="hljs-keyword">assert</span> p!=q<br>x0=<span class="hljs-built_in">int</span>(inverse_mod(q,n))<br>e1=(p*x0)%n<br><span class="hljs-comment">#print(&quot;e1&quot;,hex(e1))</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">GenRNG</span>():<br>    si=s0<br>    p_point=p*P0<br>    q_point=q*P0<br>    Random_i=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        si=<span class="hljs-built_in">int</span>((p_point*si)[<span class="hljs-number">0</span>])<br>        ri=<span class="hljs-built_in">int</span>((q_point*si)[<span class="hljs-number">0</span>])<br>        Random_i=ri&amp;(<span class="hljs-number">0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff</span>)<br>    r_point=si*p_point<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hex</span>(Random_i),r_point<br>rand,point=GenRNG()<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(rand,<span class="hljs-number">16</span>)^^RMT)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">genPrime</span>():<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        a = random.getrandbits(<span class="hljs-number">256</span>)<br>        b = random.getrandbits(<span class="hljs-number">256</span>)<br>        <span class="hljs-keyword">if</span> b % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">continue</span><br>        p = <span class="hljs-built_in">int</span>(a ** <span class="hljs-number">2</span> + <span class="hljs-number">3</span> * b ** <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">if</span> p.bit_length() == <span class="hljs-number">512</span> <span class="hljs-keyword">and</span> p % <span class="hljs-number">3</span> == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> isPrime(p):<br>            <span class="hljs-keyword">return</span> p<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">P, Q, mod</span>):<br>    m, n = P<br>    p, q = Q<br>    <span class="hljs-keyword">if</span> p <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> P<br>    <span class="hljs-keyword">if</span> m <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> Q<br>    <span class="hljs-keyword">if</span> n <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> q <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        x = m * p % mod<br>        y = (m + p) % mod<br>        <span class="hljs-keyword">return</span> (x, y)<br>    <span class="hljs-keyword">if</span> n <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> q <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        m, n, p, q = p, q, m, n<br>    <span class="hljs-keyword">if</span> q <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">if</span> (n + p) % mod != <span class="hljs-number">0</span>:<br>            x = (m * p + <span class="hljs-number">2</span>) * inverse(n + p, mod) % mod<br>            y = (m + n * p) * inverse(n + p, mod) % mod<br>            <span class="hljs-keyword">return</span> (x, y)<br>        <span class="hljs-keyword">elif</span> (m - n ** <span class="hljs-number">2</span>) % mod != <span class="hljs-number">0</span>:<br>            x = (m * p + <span class="hljs-number">2</span>) * inverse(m - n ** <span class="hljs-number">2</span>, mod) % mod<br>            <span class="hljs-keyword">return</span> (x, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">if</span> (m + p + n * q) % mod != <span class="hljs-number">0</span>:<br>            x = (m * p + (n + q) * <span class="hljs-number">2</span>) * inverse(m + p + n * q, mod) % mod<br>            y = (n * p + m * q + <span class="hljs-number">2</span>) * inverse(m + p + n * q, mod) % mod<br>            <span class="hljs-keyword">return</span> (x, y)<br>        <span class="hljs-keyword">elif</span> (n * p + m * q + <span class="hljs-number">2</span>) % mod != <span class="hljs-number">0</span>:<br>            x = (m * p + (n + q) * <span class="hljs-number">2</span>) * inverse(n * p + m * q + r, mod) % mod<br>            <span class="hljs-keyword">return</span> (x, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">power</span>(<span class="hljs-params">P, a, mod</span>):<br>    res = (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>    t = P<br>    <span class="hljs-keyword">while</span> a &gt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">if</span> a % <span class="hljs-number">2</span>:<br>            res = add(res, t, mod)<br>        t = add(t, t, mod)<br>        a &gt;&gt;= <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> res<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">random_pad</span>(<span class="hljs-params">msg, ln</span>):<br>    pad = <span class="hljs-built_in">bytes</span>([random.getrandbits(<span class="hljs-number">8</span>) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ln - <span class="hljs-built_in">len</span>(msg))])<br>    <span class="hljs-keyword">return</span> msg + pad<br><br>p, q = genPrime(), genPrime()<br>N = p * q<br>phi = (p ** <span class="hljs-number">2</span> + p + <span class="hljs-number">1</span>) * (q ** <span class="hljs-number">2</span> + q + <span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;N: <span class="hljs-subst">&#123;N&#125;</span>&quot;</span>)<br>d = getPrime(<span class="hljs-number">400</span>)<br>e2 = inverse(d, phi)<br>k = (e * d - <span class="hljs-number">1</span>)/phi<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;e2:&quot;</span>,e2)<br>to_enc=long_to_bytes(e1)<br>ln = <span class="hljs-built_in">len</span>(to_enc)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Length: <span class="hljs-subst">&#123;ln&#125;</span>&quot;</span>)<br>pt1, pt2 = random_pad(to_enc[: ln // <span class="hljs-number">2</span>], <span class="hljs-number">127</span>), random_pad(to_enc[ln // <span class="hljs-number">2</span> :], <span class="hljs-number">127</span>)<br>M = (bytes_to_long(pt1), bytes_to_long(pt2))<br>E = power(M, e2, N)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;E: <span class="hljs-subst">&#123;E&#125;</span>&quot;</span>)<br><br>flag=<span class="hljs-string">b&quot;flag&#123;**********&#125;&quot;</span><br>m=bytes_to_long(flag)<br>c=m^^<span class="hljs-built_in">int</span>(point[<span class="hljs-number">0</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;c:&quot;</span>,c)<br></code></pre></td></tr></table></figure><p>æ²¡æœ‰å¤´ç»ªã€‚åº”è¯¥å¯ä»¥é€šè¿‡ç»™å‡ºçš„éšæœºæ•°åˆ†åˆ«é¢„æµ‹$s_0,RMT$ï¼Œæ¯æ¬¡é¢„æµ‹32bitï¼Œå…±8æ¬¡ï¼Œä½†æ˜¯åé¢ä¸çŸ¥é“æ€ä¹ˆä¸‹æ‰‹äº†ã€‚</p><p>ä¸è¿‡è¿™é“é¢˜è²Œä¼¼æ˜¯ä¸€ä¸ªåŸé¢˜ï¼Œåªæ˜¯ç¨å¾®æ”¹äº†ä¸€ä¸‹ã€‚å¯ä»¥å‚è€ƒ<a href="https://blog.y011d4.com/20211011-pbctf-writeup#yet-another-rsa">pbctf 2021 Writeup | y011d4.log</a>ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>2022DASCTF Apr X FATE é˜²ç–«æŒ‘æˆ˜èµ›</title>
    <link href="/2022/04/29/2022DASCTF%20Apr%20X%20FATE%20%E9%98%B2%E7%96%AB%E6%8C%91%E6%88%98%E8%B5%9B/"/>
    <url>/2022/04/29/2022DASCTF%20Apr%20X%20FATE%20%E9%98%B2%E7%96%AB%E6%8C%91%E6%88%98%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="easy-real"><a href="#easy-real" class="headerlink" title="easy_real"></a>easy_real</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> hashlib<br><br>flag = <span class="hljs-string">&#x27;xxxxxxxxxxxxxxxxxxxx&#x27;</span><br>key = random.randint(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(flag)):<br>crypto += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(flag[i])^key)<br>m = cryptoçš„<span class="hljs-built_in">ascii</span>åå…­è¿›åˆ¶<br>e = random.randint(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>)<br><span class="hljs-built_in">print</span>(hashlib.md5(e))<br>p = <span class="hljs-number">64310413306776406422334034047152581900365687374336418863191177338901198608319</span><br>q = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br>n = p*q<br>c = <span class="hljs-built_in">pow</span>(m,e,n)<br><span class="hljs-built_in">print</span>(n)<br><span class="hljs-built_in">print</span>(c)<br></code></pre></td></tr></table></figure><p>ç­¾åˆ°é¢˜ã€‚ç”±äºkeyå’Œeçš„èŒƒå›´éƒ½æ¯”è¾ƒå°ï¼Œæ— è„‘çˆ†ç ´å°±è¡Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>e_hash = <span class="hljs-string">&#x27;37693cfc748049e45d87b8c7d8b9aacd&#x27;</span><br>n = <span class="hljs-number">4197356622576696564490569060686240088884187113566430134461945130770906825187894394672841467350797015940721560434743086405821584185286177962353341322088523</span><br>c = <span class="hljs-number">3298176862697175389935722420143867000970906723110625484802850810634814647827572034913391972640399446415991848730984820839735665233943600223288991148186397</span><br>p = <span class="hljs-number">64310413306776406422334034047152581900365687374336418863191177338901198608319</span><br>q = n//p<br><span class="hljs-keyword">assert</span> p*q == n<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">101</span>):<br><span class="hljs-keyword">if</span> hashlib.md5(<span class="hljs-built_in">str</span>(i).encode()).hexdigest() == e_hash:<br>e = i<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e = <span class="hljs-subst">&#123;e&#125;</span>&#x27;</span>)<br><span class="hljs-keyword">break</span><br><br>d = gmpy2.invert(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br>crypto = long_to_bytes(m)<br><span class="hljs-keyword">for</span> cnt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">11</span>):<br>txt = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(crypto)):<br>txt += <span class="hljs-built_in">chr</span>(crypto[i]^cnt)<br><span class="hljs-built_in">print</span>(txt)<br></code></pre></td></tr></table></figure><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031016052.png"/><h1 id="special-rsa"><a href="#special-rsa" class="headerlink" title="special_rsa"></a>special_rsa</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getPrime1</span>(<span class="hljs-params">bitLength, e</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        i = getPrime(bitLength)<br>        <span class="hljs-keyword">if</span> (i - <span class="hljs-number">1</span>) % e ** <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> i<br>flag=<span class="hljs-string">b&#x27;DASCTF&#123;????????????????????&#125;&#x27;</span><br>m = bytes_to_long(flag)<br>lenth = ((<span class="hljs-built_in">len</span>(<span class="hljs-built_in">bin</span>(m)) - <span class="hljs-number">2</span>) // <span class="hljs-number">2</span>) + <span class="hljs-number">9</span><br>e=<span class="hljs-number">113</span><br>p = getPrime1(lenth, e)<br>q = getPrime1(lenth, e)<br>n=p*q<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;n = <span class="hljs-subst">&#123;n&#125;</span>&quot;</span>)<br>c1 = <span class="hljs-built_in">pow</span>(m, e, n)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">26</span>):<br>    lenth = ((<span class="hljs-built_in">len</span>(<span class="hljs-built_in">bin</span>(c)) - <span class="hljs-number">2</span>) // <span class="hljs-number">2</span>) + <span class="hljs-number">9</span><br>    p = getPrime1(lenth, e)<br>    q = getPrime1(lenth, e)<br>    n=p*q<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;n = <span class="hljs-subst">&#123;n&#125;</span>&quot;</span>)<br>    c=<span class="hljs-built_in">pow</span>(c,e,n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;e = <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;c = <span class="hljs-subst">&#123;c&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><p>å°è¯•å°†nè¿›è¡Œåˆ†è§£ï¼Œå‘ç°æ‰€æœ‰néƒ½å¯ä»¥åˆ†è§£ã€‚ä½†æ˜¯ä¸»è¦é—®é¢˜æ¥äº†ï¼Œå‘ç°$gcd(e,p_i-1)&#x3D;e,gcd(e,q_i-1)&#x3D;1$ï¼Œè¿™è®©æˆ‘æƒ³åˆ°äº†BUUä¸Šçš„ä¸€é“é¢˜<code>[NCTF2019]easy rsa</code>ã€‚åˆ©ç”¨AMMç®—æ³•è¿›è¡Œå¼€æ ¹ã€‚ç”±äºæ¯æ¬¡å¼€æ ¹ä¼šå¾—åˆ°113*113ç§æƒ…å†µï¼Œéœ€è¦è¿›è¡Œç­›é€‰ï¼ˆåˆ©ç”¨$ c_i &lt; p_{i-1}q_{i-1}$ï¼‰ã€‚</p><p>çœŸæ²¡æƒ³åˆ°å¯ä»¥ç›´æ¥ç”¨small_rootä»£æ›¿AMMç®—æ³•ï¼ˆå†æ¬¡çœ‹äº†ä¹‹å‰çš„å‚è€ƒæ–‡ç« ï¼Œå‘ç°é‡Œé¢æœ‰è¯´è¿™ä¸ªçš„ï¼‰ã€‚</p><p>å½“ç„¶åº”è¯¥è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ï¼ˆæ¯”èµ›æ—¶æƒ³åˆ°çš„æ–¹å‘ï¼Œä½†æ˜¯ä¸ä¼šå†™ä»£ç ï¼Œæ·¦ï¼ï¼‰ã€‚</p><p><a href="https://eprint.iacr.org/2013/117.pdf">117.pdf (iacr.org)</a></p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031017847.png"/><p>è¿›è¡Œäº†æµ‹è¯•ï¼Œå‘ç°ï¼Œ$p,q$éƒ½ç¬¦åˆè¯¥æƒ…å†µï¼ˆå³ $(q-1)%r&#x3D;0$ ï¼‰ã€‚ä¸è¿‡æˆ‘å¹¶æ²¡æœ‰æˆåŠŸå®ç°ã€‚(å¦‚æœ‰ä¸å¯¹çš„åœ°æ–¹ï¼Œçƒ¦è¯·æ–§æ­£)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">from</span> libnum <span class="hljs-keyword">import</span> n2s<br><br>e = <span class="hljs-number">113</span><br>c = <span class="hljs-number">1028324919038104683475485759234995158466543298184637219012354053883391759172761125802189697762778242175407876548832454351014064525118465877297277847501477586955680645311999174005606833294172830817159</span><br>ps = [<span class="hljs-number">953730950786751671162019537171974567</span>, <span class="hljs-number">232079231415308325450092906880606082069</span>, <span class="hljs-number">88067722275537586769787599991567203589751</span>, <span class="hljs-number">24335212484189159197840692460327461505035059</span>, <span class="hljs-number">7832299017937880395583715032476962329929226581</span>, <span class="hljs-number">1656848589754467667368312855929759764100120657831</span>, <span class="hljs-number">385788223643735590500185001710758495904528462058461</span>, <span class="hljs-number">135813272566456906193934636644217527100917542578856697</span>, <span class="hljs-number">37185691759470013533730603170661686570987787098353146897</span>, <span class="hljs-number">6623023178993627032758350846838617937710601663528839184727</span>, <span class="hljs-number">954412804126450754097808991490470782833291028309980575506163</span>, <span class="hljs-number">350121371461894793578110243222665782247737840410076591434903787</span>, <span class="hljs-number">66882708962198932251728043152245270662769508317424500666902658099</span>, <span class="hljs-number">43449898447639409732732812916430042263570178747794530133229640125923</span>, <span class="hljs-number">11136261905010083405430254612464029672882837025885682392810368001188527</span>, <span class="hljs-number">2623629589005115152329094552749299711026240699896424120660145647226563547</span>, <span class="hljs-number">262775599542220820608778738911414710660835549772895468394761119434220071003</span>, <span class="hljs-number">102366458668689911004027849640392002821642295855327735994412634235696717329671</span>, <span class="hljs-number">15874438801602936764330936047390981280096007684699625987478211613419079727910193</span>, <span class="hljs-number">4479430800690915874719403516331677127806963529247809966024777708496270901092401687</span>, <span class="hljs-number">1328165608715012145707239303399129070657427496129541416861187541092152796676371237057</span>, <span class="hljs-number">368461902207817023013078031477042541053987571003677386333567043030477451518424731838173</span>, <span class="hljs-number">206721456778089912780641186795393376537372828449722520397829606593267585681448641482345737</span>, <span class="hljs-number">43870497594014737833600078975099212558645315030912084285417550950854483979406797450479252891</span>, <span class="hljs-number">14702310219802004876082313481498680940324963613770096574742182597840558294030859405666549879531</span>, <span class="hljs-number">5952590790902091635268726673538951527433355660839816621733964706901441977862333411532558667717227</span>, <span class="hljs-number">978009050697262759337388871320370165458800566798280419667959552859180906066907114053826258140106617</span>]<br>qs = [<span class="hljs-number">1189933229053113361422958527792232151</span>, <span class="hljs-number">295185057334340451492588650872876746227</span>, <span class="hljs-number">88380889077762105057154017276462714444697</span>, <span class="hljs-number">43974782968656404951924524450501283426052127</span>, <span class="hljs-number">10726403821316775206273675267109184566904426261</span>, <span class="hljs-number">2714357008989072105081411295741540337141142641741</span>, <span class="hljs-number">576581905150085393327734090419529952232186498060949</span>, <span class="hljs-number">140758317578347635848563045232314610161039815135897421</span>, <span class="hljs-number">41680117092754807988080699273322244961911189757589699867</span>, <span class="hljs-number">9419832152875820180139633405089278278408407453522978357309</span>, <span class="hljs-number">1567597041534155679238655992215022394597376421096298363211067</span>, <span class="hljs-number">367712839396521757736384350030802803477965822058616833553305103</span>, <span class="hljs-number">103424977238409568447978495499643051307907366367259219393937014631</span>, <span class="hljs-number">46014074200352892806829193743016415423205917845271691428043440245531</span>, <span class="hljs-number">12445294229358634680867170058509842935273054334385354032543323581223253</span>, <span class="hljs-number">3200631836176555526009533059891690177091538103904679780020639896015937897</span>, <span class="hljs-number">317277895959173163347650321012213555955385929418622006880521870012130207557</span>, <span class="hljs-number">104379442774418262390337411577160146519860415840398189010112686742489182665577</span>, <span class="hljs-number">26984206512970181742033712455904984758134288864531714209886622060356697128804201</span>, <span class="hljs-number">5467527956822382309398095704409409074818664888285375307055715842283183939297839923</span>, <span class="hljs-number">1692196606246085729483398884059069884182535824953762329164855466589577530953493347747</span>, <span class="hljs-number">428750921047556327595864876619292414694543668237320723518704707914310601565770504401619</span>, <span class="hljs-number">212549643149353357950643557614966235999942509894271006476145929120541407503538644651435909</span>, <span class="hljs-number">59471978701477648587546053450213894562580907285714122639903144859545186463681183925646967041</span>, <span class="hljs-number">15115713372931874518523751684548940147062395364112500028355694776530968944848166318295947674571</span>, <span class="hljs-number">7541333580839789645678699855290145212677767915429008863004397257213367753100058966625356835737037</span>, <span class="hljs-number">1086686910531802445146659484012613083647370307628438760118376029969836222533970554565751069314622539</span>]<br>ns = [<span class="hljs-number">1134876149917575363176366704410565158549594427794901202977560677131703617</span>, <span class="hljs-number">68506321231437453734007374706367120760326482177047006099953454136095248103663</span>, <span class="hljs-number">7783503593765446343363083302704731608384677185199537317445372251030064778965500447</span>, <span class="hljs-number">1070135687488356161164202697449500843725645617129661751744246979913699130211505096520493</span>, <span class="hljs-number">84012402115704505952834528733063574032699054524475028392540927197962976150657887637275643641</span>, <span class="hljs-number">4497278582433699034700211877087309784829036823057043402314297478185216205338241432310114079123771</span>, <span class="hljs-number">222438508972972285373674471797570608108219830357859030918870564627162064662598790037437036093579139489</span>, <span class="hljs-number">19116847751264029874551971240684579996570601026679560309305369168779130317938356692609176166515369250878437</span>, <span class="hljs-number">1549903986709797721131070830901667744892392382636347158789834851868638863292232718716074359148785900673192362699</span>, <span class="hljs-number">62387766690725996279968636478698222263235233511074646032501495855928095611796694112573478405813305623307157261619643</span>, <span class="hljs-number">1496134688150941811618178638810353297864345150241986530472328508974364124440160181353848429438725939837967063441528305921</span>, <span class="hljs-number">128744123633657656499069966444992201456797762973822340505291131642660343436783413140023509983315177426811890315424928661125061</span>, <span class="hljs-number">6917342652058596217869122177298094984415751234677039849514181349685079073411591975537016273056773954075238307918266361998553646469</span>, <span class="hljs-number">1999306851167477770905800721615579416365273707414308684419794311809177595829473632853128686208533753019224536487399393397120864878000113</span>, <span class="hljs-number">138594056023048386926766329537127538558164718841925506735112367176642328352257472034381662493666299220910783237918231719166519833124529218331</span>, <span class="hljs-number">8397272388904583425531462714999219642572091279898695377838194583995214737828538895164195817973441184775814069396690436662985593377966417476040659</span>, <span class="hljs-number">83372889332166088651413254885376085265561130214754686361784964744744711092668473281132249352040520639092871294276293287744276919265091479681667169671</span>, <span class="hljs-number">10684953914628370830889219903654707140968094024767031366624595731918523435466123514094659595357231410471738736952266383928737163485550013190959149252435167</span>, <span class="hljs-number">428359134899960532964729749713513106760306719712194950954567619156985067322564731294653991204666853689688900339268764469280769569535109069729404621290809120793</span>, <span class="hljs-number">24491413133428851306933688733518898516890217803647806829002775935975741568422047344206442746983871735723486865901743352102305801200224958166496937663406627341150101</span>, <span class="hljs-number">2247517335600310176909964109060502815240207684510918447209767597511414934626668616704865548059751008841620288545344598917362752622130186820039265603312354963258673860579</span>, <span class="hljs-number">157978379942536176944325875241196121764116712487226808271002140500926678942090491383544034591205964958130852055691446362753906164711087278555153881606839791499207025307202087</span>, <span class="hljs-number">43938571869497484913682975192955012614794498816057204091016374302341854100775132924321569876797699342959191646206571444845883942305710956894334106963321644724361549027630634869933</span>, <span class="hljs-number">2609065298534470914730686454716224905333131812890643378630636043224255484662185236061585264231004975072801053316107165770342161619265243081616632312934742288262985830181883449780965531</span>, <span class="hljs-number">222235907202454132555071455958700740228567465616560859711214102245461514428187391909176054661864893645713338391509536653547350134615807194339839952004333949540567943568810413945779642106201</span>, <span class="hljs-number">44890472824427626252451120059527486677662371033945481542195354255473403815853320591468917295474578271680865394304946847791535710766947049195816261224382109115684638995528332538466194474846836399</span>, <span class="hljs-number">1062789633774349417938788353001516763303743389381120380522262327123099728631034935663418832664265833959487018276693680850987382421521055508477988016246558095545925414048663082368488342633334571240563</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solve</span>(<span class="hljs-params">ii, ci</span>):<br>    pi, qi = ps[ii], qs[ii]<br>    R.&lt;x&gt; = Zmod(pi)[]<br>    f = x ^ e - ci<br>    f = f.monic()<br>    mp = f.roots()<br><br>    R.&lt;x&gt; = Zmod(qi)[]<br>    f = x ^ e - ci<br>    f = f.monic()<br>    mq = f.roots()<br><br>    solution = []<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> mp:<br>        <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> mq:<br>            mi = crt([<span class="hljs-built_in">int</span>(x[<span class="hljs-number">0</span>]), <span class="hljs-built_in">int</span>(y[<span class="hljs-number">0</span>])], [pi, qi])<br>            <span class="hljs-keyword">if</span> ii != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> mi &lt; ns[ii - <span class="hljs-number">1</span>]:<br>                solution.append(mi)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;No.<span class="hljs-subst">&#123;ii&#125;</span> x = <span class="hljs-subst">&#123;x&#125;</span>, y = <span class="hljs-subst">&#123;y&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">elif</span> n2s(<span class="hljs-built_in">int</span>(mi)).startswith(<span class="hljs-string">b&#x27;DASCTF&#x27;</span>):<br>                <span class="hljs-built_in">print</span>(n2s(<span class="hljs-built_in">int</span>(mi)))<br>                <span class="hljs-keyword">return</span><br>                <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> solution:<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">for</span> cc <span class="hljs-keyword">in</span> solution:<br>        solve(ii - <span class="hljs-number">1</span>, cc)<br><br>solve(<span class="hljs-built_in">len</span>(ns)-<span class="hljs-number">1</span>, c)<br></code></pre></td></tr></table></figure><p>(ä¸ºäº†åšè¿™é“é¢˜ï¼ŒèŠ±äº†ä¸€æ™šä¸Šææ¸…æ¥šå¦‚ä½•ä½¿ç”¨sagemathä»¥åŠè°ƒç”¨pythonåº“ï¼Œä¸è¿‡ä¸‹äº†Cryptoåº“ä½†è¿˜æ˜¯è°ƒç”¨ä¸äº†ğŸ˜£ï¼Œä¸è¿‡æŒºå€¼å¾—çš„ğŸ˜)</p><hr><p>ä¸€äº›å¼€æ ¹ç®—æ³•ï¼š</p><ul><li><p>Tonelli-Shanks algorithmï¼ˆå¼€å¹³æ–¹æ ¹ï¼‰</p><p><a href="https://rosettacode.org/wiki/Tonelli-Shanks_algorithm#Python">Tonelli-Shanks algorithm - Rosetta Code</a>(ä»£ç )</p><p><a href="https://handwiki.org/wiki/Tonelli%E2%80%93Shanks_algorithm#cite_note-dickson-3">Tonelliâ€“Shanks algorithm - HandWiki</a>ï¼ˆç†è®ºï¼‰</p><p><a href="https://en.wikipedia.org/wiki/Tonelli%E2%80%93Shanks_algorithm%EF%BC%88%E7%90%86%E8%AE%BA%EF%BC%89">https://en.wikipedia.org/wiki/Tonelli%E2%80%93Shanks_algorithmï¼ˆç†è®ºï¼‰</a></p></li><li><p>Rabin</p><p><a href="https://blog.csdn.net/qq_43698421/article/details/107452334">RabinåŠ å¯†ç®—æ³•_Dragon Liuçš„åšå®¢-CSDNåšå®¢_rabinç®—æ³•</a></p></li><li><p>AMM</p><p><a href="https://arxiv.org/pdf/1111.4877.pdf">1111.4877.pdf (arxiv.org)</a>(ç†è®º)</p><p>[RSA&#x2F;rth-root extraction at master Â· mad-jcbx&#x2F;RSA (github.com)](<a href="https://github.com/mad-jcbx/RSA/blob/master/rth-root">https://github.com/mad-jcbx/RSA/blob/master/rth-root</a> extraction)(ä»£ç )</p></li><li><p>ä»¥åŠä¸Šé¢ä»‹ç»çš„é‚£ä¸ªæœ¬äººæœªå®ç°å¼€æ ¹ç®—æ³•ã€‚</p></li></ul><h1 id="CVE-OF-RSA"><a href="#CVE-OF-RSA" class="headerlink" title="CVE OF RSA"></a>CVE OF RSA</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socketserver<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span>(socketserver.BaseRequestHandler):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_recvall</span>(<span class="hljs-params">self</span>):<br>        BUFF_SIZE = <span class="hljs-number">2048</span><br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            part = self.request.recv(BUFF_SIZE)<br>            data += part<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(part) &lt; BUFF_SIZE:<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">return</span> data.strip()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, msg, newline=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> newline:<br>                msg += <span class="hljs-string">b&#x27;\n&#x27;</span><br>            self.request.sendall(msg)<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recv</span>(<span class="hljs-params">self, prompt=<span class="hljs-string">b&#x27;[-] &#x27;</span></span>):<br>        self.send(prompt, newline=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">return</span> self._recvall()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">special_rsa</span>(<span class="hljs-params">self</span>):<br>        kbits = <span class="hljs-number">37</span><br>        abit = <span class="hljs-number">62</span><br>        M = <span class="hljs-number">962947420735983927056946215901134429196419130606213075415963491270</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            k = getRandomNBitInteger(kbits)<br>            a = getRandomNBitInteger(abit)<br>            p = k * M + <span class="hljs-built_in">pow</span>(<span class="hljs-number">0x10001</span>, a, M)<br>            <span class="hljs-keyword">if</span> isPrime(p):<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            l = getRandomNBitInteger(kbits)<br>            b = getRandomNBitInteger(abit)<br>            q = l * M + <span class="hljs-built_in">pow</span>(<span class="hljs-number">0x10001</span>, b, M)<br>            <span class="hljs-keyword">if</span> isPrime(q):<br>                <span class="hljs-keyword">break</span><br>        n = p * q<br>        self.send(<span class="hljs-string">b&#x27;n = &#x27;</span> + <span class="hljs-built_in">str</span>(n).encode())<br>        flag = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>        m = bytes_to_long(flag)<br>        c = <span class="hljs-built_in">pow</span>(m, <span class="hljs-number">0x10001</span>, n)<br>        self.send(<span class="hljs-string">b&#x27;c = &#x27;</span> + <span class="hljs-built_in">str</span>(c).encode())<br>        self.request.close()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">self</span>):<br>        self.special_rsa()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadedServer</span>(socketserver.ThreadingMixIn, socketserver.TCPServer):<br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ForkedServer</span>(socketserver.ForkingMixIn, socketserver.TCPServer):<br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    HOST, PORT = <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">9999</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;HOST:POST &quot;</span> + HOST + <span class="hljs-string">&quot;:&quot;</span> + <span class="hljs-built_in">str</span>(PORT))<br>    server = ForkedServer((HOST, PORT), Task)<br>    server.allow_reuse_address = <span class="hljs-literal">True</span><br>    server.serve_forever()<br></code></pre></td></tr></table></figure><p>$p,q$ç”Ÿæˆæ–¹å¼å¦‚ä¸‹<br>$$<br>p &#x3D; k * M + 65537^a\ %M\<br>q &#x3D; l * M + 65537^b\ %M<br>$$<br>æ‰¾åˆ°äº†ç›¸åº”çš„è®ºæ–‡ï¼Œå—¯â€¦â€¦å†™ä¸å‡ºä»£ç æ¥ğŸ˜…ã€‚</p><p><a href="https://acmccs.github.io/papers/p1631-nemecA.pdf">The Return of Coppersmithâ€™s Attack:Practical Factorization of Widely Used RSA Moduli (acmccs.github.io)</a></p><p>å¤ç°åæ‰çŸ¥é“è¿™æ˜¯ROCA(Return of Coppersmithâ€™s Attack)æ¼æ´ã€‚<u>ç®€å•è½¬è¿°ä¸€ä¸‹å°±æ˜¯ï¼Œä¸€äº›ç¡¬ä»¶é‡‡ç”¨ä»¥ä¸Šæ–¹æ³•å¿«é€Ÿäº§ç”ŸRSAçš„ç§é’¥ï¼Œè¿™æ ·äº§ç”Ÿçš„å…¬é’¥$n$ä¼šå¸¦æœ‰ä¸€ä¸ªæŒ‡çº¹ï¼Œä½†ç”±äº$M$æ˜¯å…‰æ»‘æ•°ï¼Œè¿™ä¸ªæŒ‡çº¹å¯ä»¥å¾ˆå¿«è¢«æ”»å‡»è€…ç¡®å®šï¼Œä»è€Œåˆ†è§£$n$ã€‚</u>ï¼ˆfrom 4xwi11ï¼‰</p><p>åŒæ ·ä¹Ÿæ‰¾åˆ°äº†ä¸€ä¸ªå¯†ç æ”»å‡»è„šæœ¬çš„ä»“åº“<a href="https://github.com/jvdsn/crypto-attacks">jvdsn&#x2F;crypto-attacks</a>ï¼ˆæŒºä¸é”™çš„ï¼Œæœ‰æ—¶é—´å¾—å¥½å¥½æ‹œè¯»ï¼‰</p><p>è¿è¡Œè¿‡ç¨‹å°±å‚è€ƒ4xwi11å¸ˆå‚…çš„å§ï¼Œæˆ‘å¹¶æ²¡æœ‰æå®šåœ¨pythonä¸­ä½¿ç”¨sageåº“ã€‚</p><hr><p>æ€»ç»“ï¼š</p><ul><li>èƒ½ç¡®å®šæ”»å‡»æ–¹å¼ï¼Œä½†å´å†™ä¸å‡ºå¥½çš„è„šæœ¬ï¼Œæœ‰å¾…æé«˜ã€‚</li><li>å‘ç°ä¸€äº›å¤§ä½¬çš„åšå®¢æˆ‘éƒ½æœ‰æ”¶è—ï¼Œä½†å´å‡ ä¹ä¸æ€ä¹ˆé˜…è¯»è¿‡ã€‚</li><li>æ‰¾åˆ°äº†æœ‰å…³å¯†ç æ”»å‡»è„šæœ¬çš„ä»“åº“ï¼Œå¤ªæ£’äº†ã€‚</li><li>pythonä¸Šä½¿ç”¨sageåº“è¿˜æ˜¯æ²¡æœ‰è§£å†³ğŸ˜‘</li></ul><hr><p>å‚è€ƒï¼š</p><p><a href="https://4xwi11.github.io/posts/9171e9d7/#special-rsa">20220423-DAS-FATE-CryptoSec | 4XWi11çš„åšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>starctf2022</title>
    <link href="/2022/04/20/starctf2022/"/>
    <url>/2022/04/20/starctf2022/</url>
    
    <content type="html"><![CDATA[<h1 id="ezRSA"><a href="#ezRSA" class="headerlink" title="ezRSA"></a>ezRSA</h1><p>é™„ä»¶ï¼š <a href="ezRSA.zip">ezRSA.zip</a> </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> getStrongPrime<br><span class="hljs-keyword">from</span> gmpy <span class="hljs-keyword">import</span> next_prime<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> getrandbits<br><span class="hljs-keyword">from</span> flag <span class="hljs-keyword">import</span> flag<br><br>p=getStrongPrime(<span class="hljs-number">1024</span>)<br>q=next_prime(p^((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">900</span>)-<span class="hljs-number">1</span>)^getrandbits(<span class="hljs-number">300</span>))<br>n=p*q<br>e=<span class="hljs-number">65537</span><br><br>m=<span class="hljs-built_in">int</span>(flag.encode(<span class="hljs-string">&#x27;hex&#x27;</span>),<span class="hljs-number">16</span>)<br><span class="hljs-keyword">assert</span> m&lt;n<br>c=<span class="hljs-built_in">pow</span>(m,e,n)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(n))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(c))<br></code></pre></td></tr></table></figure><p>ä¸€é“ç›¸ä¼¼çš„é¢˜ç›®ï¼Œè™½æœ‰æ‰€æ”¹åŠ¨ï¼Œä½†å¯ä»¥å‚è€ƒä¸€ä¸‹ï¼š</p><p><a href="https://www.nevi.dev/2022/03/20/writeup-zer0pts-ctf-2022/#anti-fermat-crypto-warmup">Writeup: zer0pts CTF 2022 - nevi.dev</a></p><p>åˆ†æä¸€ä¸‹é¢˜ç›®ï¼Œæœ‰ç”¨çš„å…³é”®ä¿¡æ¯æ˜¯<code>q=next_prime(p^((1&lt;&lt;900)-1)^getrandbits(300))</code>ã€‚</p><p>ä»ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“è§£é¢˜çš„æ–¹å‘æ˜¯ä»bitå‡ºå‘å¹¶ä¸”ç›®çš„æ˜¯åˆ†è§£$n$ã€‚é€šè¿‡ä¸Šå¼å°†$p,q$åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œé«˜124bitsç›¸åŒï¼Œä¸­é—´600bitsç›¸åï¼Œä½300bitsæ˜¯æ— æ³•é¢„æµ‹çš„ã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031027154.png"/><p>æ‰€ä»¥æˆ‘ä»¬å°†æ±‚è§£$p,q$çš„æ­¥éª¤åˆ†ä¸º3æ­¥ï¼š</p><ol><li><p>æ±‚$p,q$çš„é«˜124bitsã€‚</p><p>ç”±$p$ç”Ÿæˆ$q$çš„æ­¥éª¤åªæ˜¯æ”¹å˜äº†ä½900bitsï¼Œç”±äº$p,q$æ˜¯å¤§æ•°ï¼Œè€Œä¸”å¼€å¹³æ–¹æ ¹çš„è¯¯å·®å¤§æ¦‚ç‡ä¼šå‡ºç°åœ¨ä½ä½ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¯¹$n$å¼€å¹³æ–¹æ ¹å–å…¶é«˜124bitså³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">ph = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">bin</span>(gmpy2.iroot(n,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])[<span class="hljs-number">2</span>:<span class="hljs-number">126</span>],<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure></li><li><p>æ±‚$p,q$çš„ä¸­é—´600bitsã€‚</p><p>æˆ‘ä»¬ä»¤$p$çš„ä½900bitsæœ€å¤§åŒ–ï¼Œå³æ¯ä¸ªbitä½å…¨ä¸º1ï¼Œä»¤$q$çš„ä½900bitsæœ€å°åŒ–ï¼Œå³æ¯ä¸ªbitä½å…¨ä¸º0ã€‚è¿™æ ·ä¹Ÿçš„è¯ä¸­é—´600bitsæ­£å¥½æ˜¯ç›¸åçš„ã€‚</p><p>ä¹‹åæˆ‘ä»¬å¯¹$p,q$çš„ä¸­é—´600bitsçš„ä»é«˜åˆ°ä½åŒæ—¶ä¸1è¿›è¡Œå¼‚æˆ–ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ä¸­é—´600bitsä»æ˜¯ç›¸åçš„ã€‚æœŸé—´å¯¹å¾—åˆ°çš„$p,q$ä¹‹ç§¯ä¸$n$è¿›è¡Œæ¯”è¾ƒï¼Œå°çš„è¯å°±æ›´æ–°$p,q$çš„å€¼ï¼Œæœ€ç»ˆå¾—åˆ°ä¸­é—´600bitsã€‚</p><p>é‚£ä¸ºä»€ä¹ˆè¿™æ ·åšå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“ä¸¤ä¸ªæ•°åœ¨å’Œä¸å˜çš„æƒ…å†µä¸‹ï¼Œåªæœ‰å½“è¿™ä¸¤ä¸ªæ•°ç›¸ç­‰æ—¶ä¹˜ç§¯æ‰èƒ½æœ€å¤§åŒ–ã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031027657.png"/><p>ç°åœ¨$p$æ˜¯æœ€å¤§çš„ï¼Œ$q$æ˜¯æœ€å°çš„ï¼Œ$p+q$æ˜¯å›ºå®šçš„ï¼Œ$p*q&lt;n$è¯´æ˜$p$å¤ªå¤§äº†ï¼Œ$q$å¤ªå°äº†ï¼Œäºæ˜¯æ›´æ”¹$p,q$çš„å¯¹åº”bitä½ï¼ˆåšåˆ°äº†$p$å¢åŠ äº†ç›¸åº”çš„é‡ï¼Œ$q$å‡å°‘äº†ç›¸åº”çš„é‡ï¼‰ã€‚å¤§äºçš„æƒ…å†µå°±ä¸è¯´æ˜äº†ã€‚ï¼ˆæ„Ÿè§‰æœ‰ç‚¹åºŸè¯äº†ï¼Œè¯´çš„æœ‰ç‚¹è¿‡äºè¯¦ç»†ä»¥è‡³äºæœ‰ç‚¹â€¦â€¦ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">ph = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">bin</span>(gmpy2.iroot(n,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])[<span class="hljs-number">2</span>:<span class="hljs-number">126</span>],<span class="hljs-number">2</span>)<br>p = (ph&lt;&lt;<span class="hljs-number">900</span>)^((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">900</span>)-<span class="hljs-number">1</span>)^((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">300</span>)-<span class="hljs-number">1</span>)<br>q = ph&lt;&lt;<span class="hljs-number">900</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">899</span>, <span class="hljs-number">300</span>, -<span class="hljs-number">1</span>):<br>    cur = <span class="hljs-number">1</span>&lt;&lt;i<br>    <span class="hljs-keyword">if</span> (p ^ cur) * (q ^ cur) &lt; n:<br>        p ^= cur<br>        q ^= cur<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;highp = <span class="hljs-subst">&#123;p&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;highq = <span class="hljs-subst">&#123;q&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure></li><li><p>æ±‚$p$æˆ–$q$çš„ä½300bitsã€‚</p><p>çŸ¥é“äº†$p$æˆ–$q$é«˜ä½ï¼Œæ±‚å…¶ä½ä½ï¼Œäºæ˜¯å¯ä»¥ç”¨small_roots()æ±‚è§£äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">highp = <span class="hljs-number">170966211863977623201944075700366958395158791305775637137148430402719914596268969449870561801896130406088025694634815584789789278534177858182071449441084789053688828370314062664371344767976558822028720769455584351917211545467432347213218207146202261834961563977909337587431826932558897962855935319930935705600</span><br>n = <span class="hljs-number">29229445599118483001701466306458274418313207587536209963238059476868917454504410032112597117546615733598387274665904107870896556998881063494600049216084775281584147609749667294182462818941181246561319625259137178286553974862986352158857172427903588054746932151579636584132759169528954347728678147797597780996214188968831836400285920685337294608990778009074569367505456248478822993714411937836237079928768898433354626698856023139709607246825672149802133458391862603953992754636020632951723690379324712160511376119409228990756977864084382454893999090811914709514495628598844102290648843131526073812299407141152746828211</span><br>c = <span class="hljs-number">0xd7f6c90512bc9494370c3955ff3136bb245a6d1095e43d8636f66f11db525f2063b14b2a4363a96e6eb1bea1e9b2cc62b0cae7659f18f2b8e41fca557281a1e859e8e6b35bd114655b6bf5e454753653309a794fa52ff2e79433ca4bbeb1ab9a78ec49f49ebee2636abd9dd9b80306ae1b87a86c8012211bda88e6e14c58805feb6721a01481d1a7031eb3333375a81858ff3b58d8837c188ffcb982a631e1a7a603b947a6984bd78516c71cfc737aaba479688d56df2c0952deaf496a4eb3f603a46a90efbe9e82a6aef8cfb23e5fcb938c9049b227b7f15c878bd99b61b6c56db7dfff43cd457429d5dcdb5fe314f1cdf317d0c5202bad6a9770076e9b25b1</span><br>e = <span class="hljs-number">65537</span><br><br>R.&lt;x&gt; = PolynomialRing(Zmod(n))<br>f = highp+x<br>x0 = f.small_roots(X=<span class="hljs-number">2</span>**<span class="hljs-number">450</span>,beta = <span class="hljs-number">0.4</span>)[<span class="hljs-number">0</span>]<span class="hljs-comment">#é€‚å½“æé«˜ç‚¹xçš„èŒƒå›´</span><br>p = f(x0)<br>q = n//<span class="hljs-built_in">int</span>(p)<br><span class="hljs-built_in">print</span>(p)<br><span class="hljs-built_in">print</span>(q)<br>d = inverse_mod(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(m)<br></code></pre></td></tr></table></figure><p>ï¼ˆå“¦ï¼Œå¯¹äº†ï¼å› ä¸ºæˆ‘å†™æˆsmall_roots(x &#x3D; 2**450)å¯¼è‡´æŠ¥é”™äº†ï¼Œä½†ç»™å‡ºçš„æŠ¥é”™ä¿¡æ¯æ˜¯<code>list index out of range</code>ï¼Œè¿˜ä»¥ä¸ºæ˜¯æ²¡æœ‰è§£å‘¢ã€‚ï¼‰</p></li></ol><p>åˆ†æå®Œæ¯•ï¼Œæ•´ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python</span><br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>e = <br>n = <br>c = <br><br>ph = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">bin</span>(gmpy2.iroot(n,<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])[<span class="hljs-number">2</span>:<span class="hljs-number">126</span>],<span class="hljs-number">2</span>)<span class="hljs-comment">#é«˜124bitsç›¸åŒ</span><br>p = (ph&lt;&lt;<span class="hljs-number">900</span>)^((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">900</span>)-<span class="hljs-number">1</span>)^((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">300</span>)-<span class="hljs-number">1</span>)<br>q = ph&lt;&lt;<span class="hljs-number">900</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">899</span>, <span class="hljs-number">300</span>, -<span class="hljs-number">1</span>):<br>    cur = <span class="hljs-number">1</span>&lt;&lt;i<br>    <span class="hljs-keyword">if</span> (p ^ cur) * (q ^ cur) &lt; n:<br>        p ^= cur<br>        q ^= cur<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;highp = <span class="hljs-subst">&#123;p&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;highq = <span class="hljs-subst">&#123;q&#125;</span>&#x27;</span>)<br><span class="hljs-comment">#sage</span><br>highp = <br>n = <br>e = <br><br>R.&lt;x&gt; = PolynomialRing(Zmod(n))<br>f = highp+x<br>x0 = f.small_roots(X=<span class="hljs-number">2</span>**<span class="hljs-number">450</span>,beta = <span class="hljs-number">0.4</span>)[<span class="hljs-number">0</span>]<span class="hljs-comment">#é€‚å½“æé«˜ç‚¹xçš„èŒƒå›´</span><br>p = f(x0)<br>q = n//<span class="hljs-built_in">int</span>(p)<br><span class="hljs-built_in">print</span>(p)<br><span class="hljs-built_in">print</span>(q)<br>d = inverse_mod(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(m)<br><span class="hljs-comment">#python</span><br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br><span class="hljs-comment">#*CTF&#123;St.Diana_pls_take_me_with_you!&#125;</span><br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://github.com/sixstars/starctf2022">https://github.com/sixstars/starctf2022</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æ ¼å¯†ç å­¦ä¹ ï¼ˆäºŒï¼‰</title>
    <link href="/2022/04/19/%E6%A0%BC%E5%AF%86%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <url>/2022/04/19/%E6%A0%BC%E5%AF%86%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦é€šè¿‡åˆ†æä¸€äº›ä¾‹é¢˜æ¥å­¦ä¹ æ ¼ã€‚</p><hr><h1 id="NTRU"><a href="#NTRU" class="headerlink" title="NTRU"></a>NTRU</h1><p>æ‘˜è‡ªLazzaro</p><p>ä¸‰ä¸ªæ•´æ•°å‚æ•°$(N,p,q)$å’Œå››ä¸ªæ¬¡æ•°ä¸º$N-1$å¾—æ•´æ•°å¤šé¡¹å¼é›†åˆ $L_f,L_g,L_Ï†,L_m$ã€‚$N$ä¸ºç´ æ•°ï¼Œ$p,q$å¯ä»¥æ˜¯åˆæ•°ï¼Œä½†è¦æ±‚$gcd(p,q) &#x3D; 1$ï¼Œä¸”$q$è¿œå¤§äº$p$ã€‚</p><p>NTRUå·¥ä½œäºå¤šé¡¹å¼æ•´æ•°ç¯$R &#x3D; Z[x]&#x2F;(x^N-1)$ï¼Œå½“$FâˆˆR$æ—¶ï¼Œå¯ä»¥æŠŠ$F$è¡¨ç¤ºä¸ºå¤šé¡¹å¼æˆ–å‘é‡å½¢å¼ï¼š<br>$$<br>F&#x3D;\sum_{i&#x3D;0}^{N-1}{F_ix^i}&#x3D;[F_0,F_1,â€¦,F_{N-1}]<br>$$<br>é€‰å–ä¸‰ä¸ªç¡®å®šçš„æ•´æ•°$d_f,d_g,d_Ï†$ï¼Œå¤šé¡¹å¼é›†åˆ$L_f&#x3D;L(d_f,d_{f-1}),L_g&#x3D;L(d_g,d_g),L_Ï†&#x3D;L(d_Ï†,d_Ï†)$ï¼Œè€Œ$L_m&#x3D;{mâˆˆR|mçš„ç³»æ•°ä½äºåŒºé—´[-\dfrac{p-1}{2},\dfrac{p-1}{2}],å…¶ä¸­pä¸ºç´ æ•°}$ã€‚</p><ul><li><p>å¯†é’¥ç”Ÿæˆ</p><p>é€‰æ‹©å¤šé¡¹å¼$f$å’Œ$g$ï¼Œ$fâˆˆL_f$ï¼Œ$gâˆˆL_g$ã€‚è¦æ±‚$f$å…³äºæ¨¡$p$å’Œæ¨¡$q$çš„é€†å…ƒ$F_p$ï¼Œ$F_q$éƒ½å­˜åœ¨ï¼Œå¦åˆ™é‡æ–°é€‰å–$f$ã€‚</p></li><li><p>åŠ å¯†</p><p>Aå‘é€çš„æ¶ˆæ¯$mâˆˆL_m$ï¼Œæ ¹æ®å‚æ•°$d_Ï†$éšæœºé€‰å–ä¸€ä¸ª$Ï†âˆˆL_Ï†$ï¼Œåˆ©ç”¨å…¬é’¥$h$è®¡ç®—<br>$$<br>c â‰¡ Ï†*h+m\quad(mod\ q)<br>$$<br>AæŠŠå¯†æ–‡cå‘ç»™äº†Bã€‚</p></li><li><p>è§£å¯†</p><p>Bæ”¶åˆ°å¯†æ–‡cåï¼Œåˆ©ç”¨ç§é’¥$f$è®¡ç®—<br>$$<br>aâ‰¡f*c\quad(mod\ q)<br>$$<br>é€‰æ‹©açš„ç³»æ•°ä½äº$[-\dfrac{p-1}{2},\dfrac{p-1}{2}]$ä¹‹é—´ï¼Œè®¡ç®—<br>$$<br>bâ‰¡a\quad(mod\ p)\<br>mâ‰¡F_p*b\quad(mod\ p)<br>$$<br>å¤šé¡¹å¼må³æ˜¯æ˜æ–‡ã€‚</p></li></ul><p>ä¾‹é¢˜ï¼š</p><p>å·…å³°æå®¢çº¿ä¸Šèµ›çš„ä¸€é“å¯†ç é¢˜NTUREã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> flag <span class="hljs-keyword">import</span> flag<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>():<br>    p = getStrongPrime(<span class="hljs-number">2048</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        f = getRandomNBitInteger(<span class="hljs-number">1024</span>)<br>        g = getStrongPrime(<span class="hljs-number">768</span>)<br>        h = gmpy2.invert(f, p) * g % p<br>        <span class="hljs-keyword">return</span> (p, f, g, h)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">plaintext, p, h</span>):<br>    m = bytes_to_long(plaintext)<br>    r = getRandomNBitInteger(<span class="hljs-number">1024</span>)<br>    c = (r * h + m) % p<br>    <span class="hljs-keyword">return</span> c<br><br><br>p, f, g, h = generate()<br>c = encrypt(flag, p, h)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;cipher.txt&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(<span class="hljs-string">&quot;h = &quot;</span> + <span class="hljs-built_in">str</span>(h) + <span class="hljs-string">&quot;\n&quot;</span>)<br>    f.write(<span class="hljs-string">&quot;p = &quot;</span> + <span class="hljs-built_in">str</span>(p) + <span class="hljs-string">&quot;\n&quot;</span>)<br>    f.write(<span class="hljs-string">&quot;c = &quot;</span> + <span class="hljs-built_in">str</span>(c) + <span class="hljs-string">&quot;\n&quot;</span>)<br></code></pre></td></tr></table></figure><p><a href="https://xz.aliyun.com/t/7163">ä»ä¸€é“CTFé¢˜åˆæ¢NTRUæ ¼å¯†ç  - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a>ä¸­æœ‰éå¸¸è¯¦ç»†çš„è§£æã€‚ï¼ˆå¤§å¯ä¸å¿…ç»§ç»­å¾€ä¸‹ç¿»ï¼‰</p><p>æ ¹æ®é¢˜ç›®æœ‰<br>$$<br>\begin{align}<br>h &#x3D; f_p*g\quad (mod\ p) \tag{1}\\<br>c &#x3D; r*h+m\quad (mod\ p) \tag{2}<br>\end{align}<br>$$<br>(2)å¼ç­‰å¼ä¸¤è¾¹åŒ$Ã—f$ï¼Œå¾—<br>$$<br>c*f &#x3D; r*g + m*f\quad (mod\ p)\tag{3}<br>$$<br>åˆ†æå„ä¸ªæ•°çš„bitï¼š</p><p>(è´´è¿‡æ¥)</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">r</span>ï¼š<span class="hljs-number">1024</span>bit<br><span class="hljs-attribute">g</span>ï¼š<span class="hljs-number">768</span>bit<br><span class="hljs-attribute">m</span>ï¼šflagå­—ç¬¦ä¸²è½¬æˆæ•°å­—ï¼Œä¸€ä¸ªå­—ç¬¦<span class="hljs-number">8</span>bitï¼Œä¸€èˆ¬æ¥è¯´flagä¸ä¼šå¤ªé•¿ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šæ˜¯å°<span class="hljs-number">1000</span>bitçš„ã€‚<br><span class="hljs-attribute">f</span>ï¼š<span class="hljs-number">1024</span>bit<br><span class="hljs-attribute">p</span>ï¼š<span class="hljs-number">2048</span>bit<br></code></pre></td></tr></table></figure><p>å‘ç°$r*g + m*f$å°äº$p$ï¼Œæ•…ä»¤$a &#x3D; c*f%p$ï¼Œåˆ™æœ‰ç­‰å¼<br>$$<br>a &#x3D; r*g+m*f\tag{4}<br>$$<br>(4)å¼å¯¹gå–æ¨¡å¾—<br>$$<br>a &#x3D; m*f\quad(mod\ g)\tag{5}<br>$$<br>å¾ˆå¯æƒœï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“$f,g$ã€‚</p><p>è¿™é‡Œå°±éœ€è¦ç”¨åˆ°æ ¼äº†ã€‚</p><p>æˆ‘ä»¬å·²çŸ¥$h,p,c$ï¼Œè¦æ±‚$f,g$ã€‚</p><p>å¦‚ä½•æ„é€ å‘¢ï¼Ÿä»¥ä¸‹æ˜¯æˆ‘çš„åˆæ­¥ç†è§£ï¼ˆå¯èƒ½æœ‰è¯¯ï¼‰ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">åˆ©ç”¨å…³ç³»ç­‰å¼ã€å·²çŸ¥é‡ä»¥åŠå¸¸é‡æ„é€ æ ¼ï¼ˆçŸ©é˜µï¼‰ï¼Œé€šè¿‡çŸ©é˜µå˜åŒ–æ±‚å‡ºå«f,gçš„çŸ©é˜µã€‚<br>æ±‚è§£æœªçŸ¥æ•°çš„ä¸ªæ•°ä¸€èˆ¬æ˜¯çŸ©é˜µçš„è¡Œå’Œåˆ—ã€‚<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå°±æœ‰ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm">æ„é€ <span class="hljs-number">2</span>Ã—<span class="hljs-number">2</span>çš„çŸ©é˜µM<br>çŸ©é˜µ<span class="hljs-keyword">B</span> = [f,g]ä¸ºæˆ‘ä»¬çš„æœ€ç»ˆç»“æœ<br></code></pre></td></tr></table></figure><p>æ ¹æ®å…³ç³»ç­‰å¼(1)ï¼Œæ”¹å†™å¾—$f*h &#x3D; g\quad(mod\ p)$ï¼Œè¿›ä¸€æ­¥æœ‰$f*h &#x3D; g + k*p$ï¼Œå°†$k*p$ç§»è‡³ç­‰å¼å·¦è¾¹å¾—$g &#x3D; f*h-k*p$ã€‚</p><p>å¾ˆæ˜¾ç„¶ï¼Œ$f,g,p$ä¹‹é—´å­˜åœ¨å…³ç³»ï¼Œå°†çŸ©é˜µ$B &#x3D; [f,g]$åŒ–æˆ$[f,f*h-k*p]$ï¼Œè®¨è®ºå®ƒæ˜¯ç”±æ€æ ·ä¸€ä¸ª2Ã—2çš„çŸ©é˜µ$M$å¾—æ¥çš„ä»¥åŠå¦‚ä½•å¾—åˆ°çš„ã€‚</p><p>æ˜“çŸ¥$[f,g]$æ˜¯ç”±ä¸€ä¸ª1Ã—2çš„çŸ©é˜µ$A$ä¹˜ä¸€ä¸ª2Ã—2çš„çŸ©é˜µ$M$å¾—æ¥çš„ã€‚åæ¨ä¸€ä¸‹ï¼Œå°±æœ‰$A &#x3D; [f,-k]$ï¼Œ$M&#x3D;\left[\matrix{1&amp;h\\0&amp;p}\right]$ã€‚</p><ol><li>å› ä¸ºä¸$f$æœ‰å…³çš„å…³ç³»ç­‰å¼å·²ç»ç”¨æ¥ä»£æ¢$g$äº†ï¼Œæ‰€ä»¥æ¨å‡º$A&#x3D;[fï¼Œï¼Ÿ]$</li><li>ç„¶åå¯ä»¥æ¨å‡º$M&#x3D;\left[\matrix{1&amp;?\\0&amp;?}\right]$</li><li>æ ¹æ®$B&#x3D;[f,f*h-k*p]$ç¬¬äºŒä¸ªæ•°ï¼Œå¯çŸ¥$A &#x3D; [f,-k]$ï¼Œ$M&#x3D;\left[\matrix{1&amp;h\\0&amp;p}\right]$ã€‚</li></ol><p>ï¼ˆå¯èƒ½å‘é‡ç»´åº¦ä¸€é«˜ï¼Œé€†å‘åˆ†æå°±å¾ˆéš¾äº†ï¼‰</p><p>ä½†å¥½åœ¨æ¥è¿™ç±»é¢˜ç›®æœ‰é€šç”¨çŸ©é˜µ</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031040179.png"/><p>ç»§ç»­åˆ†æï¼Œæ±‚å‡ºçš„çŸ©é˜µ$B &#x3D; [f,g]$ä¸ºä»€ä¹ˆå°±æ˜¯æœ€çŸ­å‘é‡å‘¢ï¼Ÿ</p><p><code>Gaussian heurstic</code>ï¼š</p><p>ä»¥åŠ<img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031040878.png"/></p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031041704.png"/><p>å¯çŸ¥ï¼Œåœ¨è¿™ä¸ªMä¸­æœ€çŸ­å‘é‡çš„é•¿åº¦å¤§æ¦‚åœ¨$sqrt(det(M))&#x3D; sqrt(p)&#x3D;sqrt(2^{2048})&#x3D;2^{1024}$å·¦å³ã€‚</p><p>è€Œ$sqrt(det(B)) &#x3D; sqrt(\sqrt{f^2+g^2}) â‰ˆ 2^{1024}$ã€‚</p><p>å› æ­¤ï¼Œå¾ˆå¤§æ¦‚ç‡ä¸Šï¼Œè¿™ä¸ª$[f, g]$å°±æ˜¯è¿™ä¸ªlatticeçš„æœ€çŸ­å‘é‡ã€‚</p><p>ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br>h = <span class="hljs-number">7257231567493321493497732423756001924698993879741072696808433246581786362611889417289029671240997843541696187487722285762633068287623369923457879458577466240950224087015909821079480431797917376609839097610864517760515986973340148901898582075413756737310797402537478388864632901178463429574227279668004092519322204990617969134092793157225082977967228366838748193084097651575835471869030934527383379794480007872562067799484905159381690179011192017159985260435844246766711550315143517066359521598424992244464723490166447105679062078049379153154659732304112563255058750656946353654402824529058734270363154894216317570784</span><br>p = <span class="hljs-number">23969137365202547728693945383611572667294904799854243194734466236017441545927679469239814785947383727854265554138290421827510545078908517696536495567625593439996528098119344504866817224169113920532528233185011693829122447604993468817512696036673804626830507903206709121383065701222707251053362179946170981868061834734684494881504724254812067180384269711822738708203454131838741703416329765575995359232573740932069147491776326045743679105041246906081872936901848272288949389026129761726749334006319072981386763830897454245553866145620689939497868469730297795063648030738668273210516497399954626983672357236110363894081</span><br>c = <span class="hljs-number">6388077150013017095358415295704360631706672647932184267739118115740221804173068089559645506533240372483689997499821300861865955720630884024099415936433339512125910973936154713306915269365877588850574948033131161679256849814325373882706559635563285860782658950169507940368219930971600522754831612134153314448445006958300840618894359885321144158064446236744722180819829183828290798747455324761671198097712539900569386477647697973195787663298318786718012522378981137877863153067057280649127202971806609339007027052518049995341356359016898069863799529357397514218249272201695539181908803360181347114492616706419618151757</span><br><br>m = matrix([[<span class="hljs-number">1</span>,h],[<span class="hljs-number">0</span>,p]])<br>shortest_vector = m.LLL()[<span class="hljs-number">0</span>]<br>f,g = shortest_vector<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;f = <span class="hljs-subst">&#123;f&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;g = <span class="hljs-subst">&#123;g&#125;</span>&#x27;</span>)<br><br>a = c*f%p%g<br>m = a*inverse_mod(f,g)%g<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;m = <span class="hljs-subst">&#123;m&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æœ€ålong_to_bytes(m)å°±è¡Œäº†ã€‚</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://xz.aliyun.com/t/7163">ä»ä¸€é“CTFé¢˜åˆæ¢NTRUæ ¼å¯†ç  - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://lazzzaro.github.io/2020/11/07/crypto-%E6%A0%BC%E5%AF%86%E7%A0%81/">æ ¼å¯†ç  Lazzaro (lazzzaro.github.io)</a></p><p><a href="https://blog.csdn.net/qq_33458986/article/details/104366177">Lattices and Cryptographyï¼ˆæ ¼ç†è®ºä¸å¯†ç å­¦ï¼‰</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NTRU</tag>
      
      <tag>æ ¼å¯†ç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ ¼å¯†ç å­¦ä¹ ï¼ˆä¸€ï¼‰</title>
    <link href="/2022/04/10/%E6%A0%BC%E5%AF%86%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2022/04/10/%E6%A0%BC%E5%AF%86%E7%A0%81%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å‡ å¤©å­¦ä¹ äº†æ ¼å¯†ç ï¼Œäºæ˜¯å†™ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ï¼Œå½“ç„¶å…¶ä¸­ä¸ä¹ä¸€äº›æœ¬äººçš„é”™è¯¯ç†è§£ï¼Œè¿˜æœ›å¤šå¤šæŒ‡æ­£ï¼Œæ„Ÿè°¢ï¼</p><hr><p>åœ¨è®²æ ¼ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹åŸºå‘é‡å’ŒçŸ©é˜µã€‚</p><h1 id="åŸº"><a href="#åŸº" class="headerlink" title="åŸº"></a>åŸº</h1><p>å­¦è¿‡çº¿æ€§ä»£æ•°åº”è¯¥çŸ¥é“ï¼Œä¸€ç»„åŸºæ˜¯ç”±å„ä¸ªçº¿æ€§æ— å…³å‘é‡ç»„æˆã€‚</p><p>ä¾‹å¦‚åœ¨ç›´è§’åæ ‡ç³»ä¸­ï¼Œä»»ä½•ä¸€ä¸ªå‘é‡éƒ½å¯ä»¥ç”±(1ï¼Œ0)å’Œï¼ˆ0ï¼Œ1ï¼‰è¿™ä¸¤ä¸ªå‘é‡ä»»æ„ç»„åˆè€Œæˆï¼Œé‚£ä¹ˆç§°è¿™ä¸¤ä¸ªå‘é‡ä¸ºåŸºåº•å‘é‡ã€‚</p><p>ä¸‰ç»´ç©ºé—´ä¸­ï¼ŒåŸºåº•å‘é‡ä¸ºï¼ˆ1ï¼Œ0ï¼Œ0ï¼‰å’Œï¼ˆ0ï¼Œ1ï¼Œ0ï¼‰å’Œï¼ˆ0ï¼Œ0ï¼Œ1ï¼‰ã€‚</p><p>æ‰©å±•åˆ°nç»´ç©ºé—´ï¼Œå°±æœ‰åŸºåº•å‘é‡ï¼ˆ1ï¼Œ0ï¼Œ0ï¼Œâ€¦â€¦ï¼Œ0ï¼‰ï¼Œï¼ˆ0ï¼Œ1ï¼Œ0ï¼Œâ€¦â€¦ï¼Œ0ï¼‰ï¼Œâ€¦â€¦ï¼ˆ0ï¼Œ0ï¼Œ0ï¼Œâ€¦â€¦ï¼Œ1ï¼‰ã€‚</p><p>å½“ç„¶åŸºåº•å‘é‡å¹¶ä¸æ˜¯å”¯ä¸€çš„ï¼Œåªè¦æ˜¯ä¸€ç»„çº¿æ€§æ— å…³å‘é‡ï¼Œå¹¶ä¸”æ»¡è¶³ç©ºé—´ä¸­ä»»ä¸€é¡¹é‡èƒ½ç”±è¯¥ç»„å‘é‡è¡¨ç¤ºï¼Œå°±å¯ä»¥ç§°ä¸ºåŸºå‘é‡ã€‚</p><h1 id="çŸ©é˜µ"><a href="#çŸ©é˜µ" class="headerlink" title="çŸ©é˜µ"></a>çŸ©é˜µ</h1><p>çŸ©é˜µå¯ä»¥ç†è§£ä¸ºä¸€ç»„å‘é‡çš„é›†åˆï¼Œå³çŸ©é˜µ$$A &#x3D; \{\vec{i_1}ï¼Œ\vec{i_2}ï¼Œâ€¦â€¦,\vec{i_n}\}ï¼Œ$$$\vec{i_j}$ä¸ºmç»´å‘é‡ï¼Œ$jâˆˆ[1,n]$ã€‚<br>$$<br>A &#x3D;\left[\matrix{\vec{i_1}\\vec{i_2}\\â€¦\\vec{i_n} }\right]<br>&#x3D;\left[<br>\matrix{<br>  a_{11}&amp;a_{12}&amp;â€¦&amp;a_{1m}\\<br>  a_{21}&amp;a_{22}&amp;â€¦&amp;a_{2m}\\<br> \\â€¦&amp;â€¦&amp;â€¦&amp;â€¦\\<br>  a_{n1}&amp;a_{n2}&amp;â€¦&amp;a_{nm}\\<br>}\right]<br>$$</p><h1 id="æ ¼"><a href="#æ ¼" class="headerlink" title="æ ¼"></a>æ ¼</h1><p>æ ¼å¯ä»¥ç†è§£ä¸ºnç»´ç©ºé—´ä¸Šçš„åŸºå‘é‡çš„çº¿æ€§ç»„åˆï¼Œä»å¯è®¤ä¸ºæ˜¯ä¸€ä¸ªå‘é‡ï¼Œè¡¨ç¤ºå½¢å¼ä¸ºçŸ©é˜µã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>æ ¼$L&#x3D;\{a_1\vec{r_1}+a_2\vec{r_2}+â€¦+a_n\vec{r_n}|a_iâˆˆZ\}$ï¼Œå¯è¡¨ç¤ºä¸º</p><p>$$<br>L &#x3D;\left[\matrix{a_{1}&amp;a_{2}&amp;â€¦&amp;a_{n}\}\right]<br>\left[\matrix{\vec{i_1}\vec{i_2}\â€¦\vec{i_n} }\right]<br>&#x3D;\left[<br>\matrix{a_1\vec{r_1}+a_2\vec{r_2}+â€¦+a_n\vec{r_n}}\right]<br>$$<br><strong>ä½†æ˜¯</strong>ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å‘é‡éƒ½æ˜¯æ ¼ã€‚ï¼ˆè¿™ä¸ªæœ‰ç‚¹ä¸å¥½è¡¨è¿°ï¼‰</p><p>ä¾‹å¦‚ï¼Œæ•´æ•°æ ¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031041878.png"/><p>$\vec{AC}$æ˜¯æ•´æ•°æ ¼ï¼Œä½†$\vec{AB}$ä¸æ˜¯æ•´æ•°æ ¼ã€‚</p><p>å¯ä»¥æŠŠæ ¼ç†è§£ä¸ºæŸç©ºé—´ä¸­ç‰¹å®šçš„ç‚¹ï¼Œä¾‹å¦‚åªèƒ½æ˜¯ä¸‹å›¾å½“ä¸­å·²æ ‡å¥½çš„ç¦»æ•£çš„ç‚¹ï¼š</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031042842.png"/><h1 id="æ ¼çš„Determinant"><a href="#æ ¼çš„Determinant" class="headerlink" title="æ ¼çš„Determinant"></a>æ ¼çš„Determinant</h1><p>æ ¼å¯ä»¥å†™æˆçŸ©é˜µçš„å½¢å¼ï¼Œäºæ˜¯å®ƒçš„Determinantï¼ˆè¡Œåˆ—å¼ï¼‰ä»£è¡¨å…¶è¡Œåˆ—å¼çš„å€¼ï¼Œä½†ä¸€èˆ¬ä¸å«ä½œè¡Œåˆ—å¼ï¼Œè€Œæ˜¯ç»„æˆæ ¼çš„å‘é‡æ‰€å›´æˆå›¾å½¢çš„é¢ç§¯æˆ–è€…ä½“ç§¯ã€‚</p><h1 id="æœ€çŸ­è·ç¦»"><a href="#æœ€çŸ­è·ç¦»" class="headerlink" title="æœ€çŸ­è·ç¦»"></a>æœ€çŸ­è·ç¦»</h1><p>æœ€çŸ­è·ç¦»$Î»$è¡¨ç¤ºæ ¼ä¸­ç‚¹ä¸ç‚¹ä¹‹é—´çš„æœ€çŸ­è·ç¦»ã€‚<br>$$<br>Î»_1 &#x3D; min||\vec{x}-\vec{y}||,\vec{x},\vec{y}âˆˆæ ¼L,\vec{x}â‰ \vec{y}\\<br>&#x3D;min||\vec{x}||,\vec{x}âˆˆæ ¼L,\vec{x}â‰ \vec{0},\vec{y}ä¸ºåŸç‚¹o<br>$$<br>è®°$Î»_i$ä¸ºç¬¬içŸ­çš„è·ç¦»ï¼Œåˆ™æœ‰$Î»_1â‰¤Î»_2â‰¤â€¦â‰¤Î»_n$ã€‚</p><h1 id="è·ç¦»å‡½æ•°"><a href="#è·ç¦»å‡½æ•°" class="headerlink" title="è·ç¦»å‡½æ•°"></a>è·ç¦»å‡½æ•°</h1><p>ä»»æ„ä¸€ä¸ªç‚¹tï¼ˆå¯ä»¥ä¸åœ¨æ ¼Lä¸Šï¼‰åˆ°æœ€è¿‘çš„æ ¼ç‚¹çš„æœ€çŸ­è·ç¦»çš„å‡½æ•°ï¼Œè®°ä½œ$Î¼(tï¼ŒL)$ã€‚</p><h1 id="è¦†ç›–åŠå¾„"><a href="#è¦†ç›–åŠå¾„" class="headerlink" title="è¦†ç›–åŠå¾„"></a>è¦†ç›–åŠå¾„</h1><p>ä»¥æ ¼Lä¸­æ‰€æœ‰çš„æ ¼ç‚¹ä¸ºåœ†å¿ƒï¼Œé€æ¸æ‰©å¤§å…¶åŠå¾„ï¼Œä½¿å¾—èƒ½è¦†ç›–æ•´ä¸ªç©ºé—´ï¼Œæ­¤æ—¶çš„åŠå¾„å°±æ˜¯è¦†ç›–åŠå¾„$Î¼$ã€‚</p><h1 id="æ ¼å¯†ç ä¸­çš„ä¸€äº›éš¾é¢˜"><a href="#æ ¼å¯†ç ä¸­çš„ä¸€äº›éš¾é¢˜" class="headerlink" title="æ ¼å¯†ç ä¸­çš„ä¸€äº›éš¾é¢˜"></a>æ ¼å¯†ç ä¸­çš„ä¸€äº›éš¾é¢˜</h1><h2 id="æœ€çŸ­å‘é‡é—®é¢˜ï¼ˆSVPï¼‰"><a href="#æœ€çŸ­å‘é‡é—®é¢˜ï¼ˆSVPï¼‰" class="headerlink" title="æœ€çŸ­å‘é‡é—®é¢˜ï¼ˆSVPï¼‰"></a>æœ€çŸ­å‘é‡é—®é¢˜ï¼ˆSVPï¼‰</h2><p>ç»™å®šæ ¼$L$ä¸­çš„ä¸€ç»„åŸº$B$ï¼Œæ‰¾åˆ°è¿™ç»„åŸºæ„æˆçš„ä¸€ä¸ªæ ¼ç‚¹$Bx:x$ï¼Œä½¿å¾—è¯¥æ ¼ç‚¹åˆ°0åæ ‡ç‚¹çš„è·ç¦»æœ€è¿‘ï¼Œå³<br>$$<br>||\vec{Bx}|| &#x3D; Î»_1<br>$$<br><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031042211.png"/></p><p>å¯ä»¥ç†è§£ä¸ºæ‰¾åˆ°ä¸€ç»„æ•´æ•°$[x,y]$ï¼Œä½¿å¾—æ–°æ„æˆçš„å‘é‡<br>$$<br>\vec{Bx} &#x3D;\left[\matrix{x&amp;y\}\right]<br>\left[\matrix{\vec{a}\\vec{b}\}\right]<br>&#x3D;x\vec{a}+y\vec{b}<br>$$<br>æ»¡è¶³$||\vec{Bx}-\vec{0}|| &#x3D; ||\vec{Bx}||&#x3D;Î»_1$ã€‚</p><h2 id="æœ€è¿‘å‘é‡é—®é¢˜ï¼ˆCVPï¼‰"><a href="#æœ€è¿‘å‘é‡é—®é¢˜ï¼ˆCVPï¼‰" class="headerlink" title="æœ€è¿‘å‘é‡é—®é¢˜ï¼ˆCVPï¼‰"></a>æœ€è¿‘å‘é‡é—®é¢˜ï¼ˆCVPï¼‰</h2><p>ç»™å®š<u>è¿ç»­ç©ºé—´</u>ä¸­çš„ä»»æ„ä¸€ä¸ªç‚¹$\vec{t}$ï¼Œåœ¨æ ¼ç©ºé—´$L$ä¸­æ‰¾åˆ°ä¸€ä¸ªæ ¼ç‚¹$\vec{Bx}$ï¼Œä¸¤ç‚¹è·ç¦»æœ€çŸ­ï¼Œå³$||\vec{Bx}-\vec{t}||$æœ€å°ï¼Œç”±è¦†ç›–åŠå¾„å®šä¹‰å¯çŸ¥ï¼Œ$||\vec{Bx}-\vec{t}||â‰¤Î¼$ã€‚</p><h1 id="åˆ©ç”¨æ ¼è¿›è¡Œé€šä¿¡"><a href="#åˆ©ç”¨æ ¼è¿›è¡Œé€šä¿¡" class="headerlink" title="åˆ©ç”¨æ ¼è¿›è¡Œé€šä¿¡"></a>åˆ©ç”¨æ ¼è¿›è¡Œé€šä¿¡</h1><p>æ ¹æ®CVPï¼Œå‡è®¾æˆ‘ä»¬ä¿¡æ¯åŠ å¯†åæ˜¯æ ¼ç‚¹$\vec{Bx}$ï¼Œç„¶åè¿›è¡Œå™ªéŸ³å¹²æ‰°ï¼ˆå¯ä»¥ç†è§£ä¸ºåŠ äº†ä¸€ä¸ªå‘é‡ï¼‰ï¼Œå˜æˆäº†$\vec{t}$ã€‚è¿™æ ·åˆ«äººå°±å¾ˆéš¾ä»$\vec{t}$ç ´è§£å‡ºæ˜æ–‡ã€‚</p><h1 id="å°è¯•åˆ†æCVPé—®é¢˜"><a href="#å°è¯•åˆ†æCVPé—®é¢˜" class="headerlink" title="å°è¯•åˆ†æCVPé—®é¢˜"></a>å°è¯•åˆ†æCVPé—®é¢˜</h1><p>ç”±äºCVPåœ¨ç¬›å¡å°”åæ ‡ç³»æ•´æ•°æ ¼ä¸­å¾ˆå¥½æ±‚è§£ï¼Œåªéœ€è¦å‘ä¸Šæˆ–å‘ä¸‹å–æ•´å³å¯ï¼Œå› ä¸ºè¯¥ç©ºé—´ä¸­çš„åŸºå‘é‡éƒ½æ˜¯äº’ç›¸å‚ç›´çš„ã€‚æ•…åœ¨è§£å†³æ²¡æœ‰æ­£äº¤åŸºçš„æ ¼ä¸­ï¼Œæˆ‘ä»¬å°†å…¶åŸºæ­£äº¤åŒ–ï¼Œæ„é€ å‡ºæ­£äº¤åŸºï¼Œå¹¶åˆ©ç”¨æ­£äº¤åŸºåˆ’åˆ†æ ¼ç©ºé—´ï¼Œä½¿å¾—æ¯ä¸ªæ ¼ç‚¹éƒ½åœ¨é•¿æ–¹å½¢çš„æ­£ä¸­å¿ƒï¼Œ</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031043691.png"/><p>é‚£ä¹ˆå¯¹ä»»æ„ä¸€ä¸ªéæ ¼ç‚¹$\vec{t}$ï¼Œæ±‚å…¶æœ€è¿‘å‘é‡ä¸ºæ ¼ç‚¹$\vec{Bx}$ï¼Œå®ƒä»¬ä¹‹é—´çš„è·ç¦»ä¸€å®šä¸ä¼šè¶…è¿‡é•¿æ–¹å½¢å¯¹è§’çº¿çš„ä¸€åŠã€‚</p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨å†…åœˆä¸­çš„éæ ¼ç‚¹ï¼Œå…¶æœ€è¿‘å‘é‡éƒ½åœ¨åœ†å¿ƒå¤„ï¼Œä½†å¯¹äºå¤–åœˆä¸­çš„éæ ¼ç‚¹ï¼Œå¯èƒ½å­˜åœ¨å¤šè§£é—®é¢˜ï¼ˆä¾‹å¦‚é»„çº¿ä¸Šçš„æŸäº›ç‚¹ï¼‰</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/161411204">Latticeå­¦ä¹ ç¬”è®°01ï¼šæ ¼çš„ç®€ä»‹ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/161622928">Latticeå­¦ä¹ ç¬”è®°02ï¼šæ ¼ä¸­éš¾é¢˜ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ¼å¯†ç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Midnight Sun CTF2022</title>
    <link href="/2022/04/05/Midnight%20Sun%20CTF2022/"/>
    <url>/2022/04/05/Midnight%20Sun%20CTF2022/</url>
    
    <content type="html"><![CDATA[<h1 id="Pelleâ€™s-Rotor-Supported-Arithmetic"><a href="#Pelleâ€™s-Rotor-Supported-Arithmetic" class="headerlink" title="Pelleâ€™s Rotor-Supported Arithmetic"></a>Pelleâ€™s Rotor-Supported Arithmetic</h1><p>è§£æï¼š</p><ul><li><p>æ±‚n</p><p>å–c &#x3D; -1ï¼Œrot &#x3D; 0ã€‚æœ‰å¦‚ä¸‹å…¬å¼ï¼ˆæ ¹æ®e * d &#x3D; 1+k * Ï†(n)å¯çŸ¥dä¸ºå¥‡æ•°ï¼‰<br>$$<br>r &#x3D; -1^d\ mod\ n<br>$$<br>å› ä¸ºdä¸ºå¥‡æ•°<br>$$<br>r &#x3D; -1\ mod\ n<br>$$<br>åˆæœ‰<br>$$<br>n-1 &#x3D; -1\ mod\ n<br>$$<br>æ‰€ä»¥<br>$$<br>n &#x3D; r+1<br>$$</p></li><li><p>æ±‚d</p><p>æ³¨æ„åˆ°<code>oracle()</code>ä¸»è¦æ˜¯å¯¹dè¿›è¡Œå¾ªç¯ç§»ä½ï¼Œæ•…å¯ä»¥ä¾æ¬¡æ±‚å‡ºdçš„æ¯ä¸€ä½ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼ˆå€Ÿé‰´æ¥çš„ï¼‰ï¼š</p><ul><li>å‡è®¾d &#x3D; 314159ï¼Œå‘æœåŠ¡å™¨è¯¢é—®ä¸¤æ¬¡ï¼Œä¸º(2,0)å’Œ(2,1)ã€‚</li><li>å¾—åˆ°$r &#x3D; 2^{314159}$å’Œ$s &#x3D; 2^{141593}$ã€‚</li><li>ç„¶åä¸ºäº†æ„å»ºç­‰å¼ï¼ŒæŠŠä¸Šè¿°å¼å­è½¬æ¢æˆ$2^{3141593}$ï¼Œäºæ˜¯æœ‰$r^{10}*2^3 &#x3D; s*2^{3*10^{6}}$ã€‚</li><li>æ˜¾ç„¶ï¼Œæˆ‘ä»¬è¦æ±‚çš„æ˜¯3ï¼Œè®¾å…¶ä¸ºxï¼Œ6ä¸ºdçš„é•¿åº¦ï¼Œä¹Ÿæ˜¯æœªçŸ¥çš„ï¼Œè®¾å…¶ä¸ºlenã€‚æ•…æœ‰ä¸€èˆ¬å¼$r^{10}*2^x &#x3D; s*2^{x*10^{len}}$ã€‚</li><li>æ ¹æ®æµ‹è¯•å‘ç°lenä¸º307å·¦å³ï¼Œå¯ä»¥è¿›è¡Œæšä¸¾ã€‚</li></ul></li><li><p>åˆ†è§£n</p><p>åˆ©ç”¨Wienner Attackè„šæœ¬ã€‚</p></li></ul><p>(æ²¡æœ‰ç¯å¢ƒå¤ç°ï¼Œå¦‚æœ‰é”™è¯¯çš„åœ°æ–¹è¯·æŒ‡å‡º)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br>e = <span class="hljs-number">65537</span><br>sh = remote(<span class="hljs-string">&#x27;pelle-01.hfsc.tf&#x27;</span>,<span class="hljs-number">4591</span>)<br>sh.recvuntil(<span class="hljs-string">b&#x27;flag &#x27;</span>)<br>Cipher = sh.recv()[:-<span class="hljs-number">1</span>].decode()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Cipher = <span class="hljs-subst">&#123;Cipher&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(sh.recv())<br>c_list = []<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">c,i</span>):<br>    sh.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sh.recv()<br>    sh.sendline(<span class="hljs-built_in">str</span>(c).encode())<br>    sh.recv()<br>    sh.sendline(<span class="hljs-built_in">str</span>(i).encode())<br>    <span class="hljs-keyword">return</span> sh.recv()[:-<span class="hljs-number">1</span>].decode()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_di</span>(<span class="hljs-params"><span class="hljs-built_in">len</span>,r,s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">len</span>, <span class="hljs-built_in">int</span>)://æ–¹ä¾¿å¤ç”¨<br>        <span class="hljs-built_in">len</span> = [<span class="hljs-built_in">len</span>]<br>    <span class="hljs-keyword">for</span> dlen <span class="hljs-keyword">in</span> <span class="hljs-built_in">len</span>:<br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>            tmp1 = <span class="hljs-built_in">pow</span>(r,<span class="hljs-number">10</span>,n)*<span class="hljs-number">2</span>**x%n<br>            tmp2 = s*<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>,x*<span class="hljs-number">10</span>**dlen,n)%n<br>            <span class="hljs-keyword">if</span> (tmp1-tmp2)%n == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> dlen,x<br><br>n = get(-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)+<span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;n = <span class="hljs-subst">&#123;n&#125;</span>&#x27;</span>)<br><br>ps = [get(<span class="hljs-number">2</span>,i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">315</span>)]<br><span class="hljs-built_in">len</span>, d0 = get_di([<span class="hljs-number">306</span>,<span class="hljs-number">307</span>,<span class="hljs-number">308</span>,<span class="hljs-number">309</span>],ps[<span class="hljs-number">0</span>],ps[<span class="hljs-number">1</span>])<br>di_list = [get_di(<span class="hljs-built_in">len</span>,ps[i],ps[i+<span class="hljs-number">1</span>])[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">314</span>)]<br>d = <span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [d0]+di_list)[:<span class="hljs-built_in">len</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;d = <span class="hljs-subst">&#123;d&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ï¼ˆå«–ä¸ªè„šæœ¬ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> iroot,invert<br><br>n = <span class="hljs-number">43047796890477362990074961769201922093931501549521114743916627406636416622979445051218421149675256799232393301700370094540087679119082880899747691935251456178408503271262210863920917237676311115019888447360967178340255706657371448083420218420057544839628399548904356647638728064251771091862957676254700954117</span><br>e = <span class="hljs-number">27674287480195801722658014392785989313845949971533997686660899124104025285859437857972359428690936714607919108095274315625722478853856599143509311634893475488768721169431521077251366133165140420429800291880801747490176817398575093644983093206936398362605552523502972162034264567777255223024221794336695299713</span><br> <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wienerAttack</span>(<span class="hljs-params">_e, _n</span>):<br>    con_frac = continued_fraction(_e / _n)<br>    conv = con_frac.convergents()<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> conv:<br>        k, dg = _.numerator(), _.denominator()<br>        <span class="hljs-keyword">if</span> k == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> dg == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">continue</span><br>        _phi = _e * dg // k<br>        <span class="hljs-keyword">if</span> (_n - _phi + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> iroot(<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">pow</span>((_n - _phi + <span class="hljs-number">1</span>) // <span class="hljs-number">2</span>, <span class="hljs-number">2</span>) - _n), <span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]:<br>            delta = (_phi - _n - <span class="hljs-number">1</span>) ** <span class="hljs-number">2</span> - <span class="hljs-number">4</span> * _n<br>            _p = (_n + <span class="hljs-number">1</span> - _phi - <span class="hljs-built_in">int</span>(iroot(delta, <span class="hljs-number">2</span>)[<span class="hljs-number">0</span>])) // <span class="hljs-number">2</span><br>            _q = _n // _p<br>            <span class="hljs-keyword">assert</span> _n % _q == <span class="hljs-number">0</span><br>            <span class="hljs-keyword">return</span> _p, _q<br><br>p, q = wienerAttack(e, n)<br><span class="hljs-built_in">print</span>(p)<br><span class="hljs-built_in">print</span>(q)<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://github.com/Neobeo/Midnight-Sun">Neobeo&#x2F;Midnight-Sun (github.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>2022DASCTF X SU ä¸‰æœˆæ˜¥å­£æŒ‘æˆ˜èµ›</title>
    <link href="/2022/03/28/2022DASCTF%20X%20SU%20%E4%B8%89%E6%9C%88%E6%98%A5%E5%AD%A3%E6%8C%91%E6%88%98%E8%B5%9B/"/>
    <url>/2022/03/28/2022DASCTF%20X%20SU%20%E4%B8%89%E6%9C%88%E6%98%A5%E5%AD%A3%E6%8C%91%E6%88%98%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="FlowerCipher"><a href="#FlowerCipher" class="headerlink" title="FlowerCipher"></a>FlowerCipher</h1><p>æ˜¾ç„¶å·²çŸ¥<br>$$<br>\begin{cases}<br>L_{n} &#x3D; R_{n-1}+L_{n-1}(k[i]^3+r_n)<br>\<br>R_n &#x3D; L_{n-1}<br>\end{cases}<br>$$<br>è½¬æ¢å¾—<br>$$<br>L_{n} &#x3D; R_{n-1}+R_{n}(k[i]^3+r_n)<br>$$<br>å·²çŸ¥$L_{n},R_{n}$ï¼Œå¯¹ä¸Šå¼è¿›è¡Œæ¨¡è¿ç®—å¯å¾—$R_{n-1}$ï¼Œ$L_{n-1}$ä¸º$R_{n}$ï¼Œåå¤ä¸Šè¿°è¿ç®—ç›´åˆ°$L&#x3D;1\quad or\quad R &#x3D; 0  $ï¼Œæ±‚å¾—å…¨éƒ¨$k[i]^3+r_n$ã€‚</p><p>ç”±äºä¸Šå¼åŒ…å«éšæœºæ•°ï¼Œä½†éšæœºæ•°çš„èŒƒå›´å¾ˆå°ã€‚é€šè¿‡è®¡ç®—å­—ç¬¦â€™0â€™~â€™fâ€™çš„ASCIIç çš„ç«‹æ–¹ï¼Œå®ƒä»¬ä¹‹é—´çš„å·®å¤§äº4096ï¼Œä¹Ÿå°±æ˜¯è¯´éšæœºæ•°çš„å½±å“å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œç›´æ¥å¼€ç«‹æ–¹æ ¹å³å¯å¾—åˆ°$k[i]$ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><br>L = <span class="hljs-number">15720197268945348388429429351303006925387388927292304717594511259390194100850889852747653387197205392431053069043632340374252629529419776874410817927770922310808632581666181899</span><br>R = <span class="hljs-number">139721425176294317602347104909475448503147767726747922243703132013053043430193232376860554749633894589164137720010858254771905261753520854314908256431590570426632742469003</span><br><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">while</span> L != <span class="hljs-number">1</span>:<br>    pre_R = L%R<br>    tmp = (L-pre_R)//R<br>    k = gmpy2.iroot(tmp,<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>]<br>    flag += <span class="hljs-built_in">chr</span>(k)<br>    L = R<br>    R = pre_R<br><br><span class="hljs-built_in">print</span>(flag[::-<span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>çº¢æ˜è°·æ¯2022</title>
    <link href="/2022/03/23/%E7%BA%A2%E6%98%8E%E8%B0%B7%E6%9D%AF2022/"/>
    <url>/2022/03/23/%E7%BA%A2%E6%98%8E%E8%B0%B7%E6%9D%AF2022/</url>
    
    <content type="html"><![CDATA[<h1 id="easy-ya"><a href="#easy-ya" class="headerlink" title="easy_ya"></a>easy_ya</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> flag <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen</span>():<br>    e = <span class="hljs-number">3</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            p = getPrime(<span class="hljs-number">512</span>)<br>            q = getPrime(<span class="hljs-number">512</span>)<br>            n = p*q<br>            phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>            d = inverse(e,phi)<br>            <span class="hljs-keyword">return</span> p,q,d,n,e<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">return</span><br>p,q,d,n,e = gen()<br>r = getPrime(<span class="hljs-number">512</span>)<br>m = bytes_to_long(flag+os.urandom(<span class="hljs-number">32</span>))<br>M = m%r<br>c = <span class="hljs-built_in">pow</span>(m,e,n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;r = %d&quot;</span>%r)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;M = %d&quot;</span>%M)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;n = %d&quot;</span>%n)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;e = %d&quot;</span>%e)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;c = %d&quot;</span>%c)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">r = 7996728164495259362822258548434922741290100998149465194487628664864256950051236186227986990712837371289585870678059397413537714250530572338774305952904473</span><br><span class="hljs-string">M = 4159518144549137412048572485195536187606187833861349516326031843059872501654790226936115271091120509781872925030241137272462161485445491493686121954785558</span><br><span class="hljs-string">n = 131552964273731742744001439326470035414270864348139594004117959631286500198956302913377947920677525319260242121507196043323292374736595943942956194902814842206268870941485429339132421676367167621812260482624743821671183297023718573293452354284932348802548838847981916748951828826237112194142035380559020560287</span><br><span class="hljs-string">e = 3</span><br><span class="hljs-string">c = 46794664006708417132147941918719938365671485176293172014575392203162005813544444720181151046818648417346292288656741056411780813044749520725718927535262618317679844671500204720286218754536643881483749892207516758305694529993542296670281548111692443639662220578293714396224325591697834572209746048616144307282</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>å¾ˆå®¹æ˜“çœ‹å‡ºè¿™æ˜¯å·²çŸ¥mä½ä½æ±‚é«˜ä½çš„coppersmithã€‚<br>$$<br>M&#x3D; m\ mod\ r \quad&#x3D;&#x3D;&gt;\quad m &#x3D; x*r + M \\<br>$$</p><p>è½¬æ¢æˆ<br>$$<br>c &#x3D; (x*r + M)^e\ mod\ n<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br>r = <span class="hljs-number">7996728164495259362822258548434922741290100998149465194487628664864256950051236186227986990712837371289585870678059397413537714250530572338774305952904473</span><br>M = <span class="hljs-number">4159518144549137412048572485195536187606187833861349516326031843059872501654790226936115271091120509781872925030241137272462161485445491493686121954785558</span><br>n = <span class="hljs-number">131552964273731742744001439326470035414270864348139594004117959631286500198956302913377947920677525319260242121507196043323292374736595943942956194902814842206268870941485429339132421676367167621812260482624743821671183297023718573293452354284932348802548838847981916748951828826237112194142035380559020560287</span><br>e = <span class="hljs-number">3</span><br>c = <span class="hljs-number">46794664006708417132147941918719938365671485176293172014575392203162005813544444720181151046818648417346292288656741056411780813044749520725718927535262618317679844671500204720286218754536643881483749892207516758305694529993542296670281548111692443639662220578293714396224325591697834572209746048616144307282</span><br>R.&lt;x&gt; = PolynomialRing(Zmod(n), implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>((x*r + M)^e - c).monic().small_roots()<br><span class="hljs-comment"># 810968823598060539864535</span><br><span class="hljs-comment">#python</span><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes<br><span class="hljs-built_in">print</span>(long_to_bytes(<span class="hljs-number">810968823598060539864535</span> * r + M))<br></code></pre></td></tr></table></figure><p>å¦ä¸€ç§æ€è·¯ï¼Œæ±‚ä¸å‡ºæ¥ï¼Œæš‚æ—¶ä¸çŸ¥å“ªé‡Œå‡ºé”™äº†ã€‚<br>$$<br>M&#x3D;m\ mod\ r\quad &#x3D;&#x3D;&gt;\quad M^e&#x3D;m^e\ mod\ r<br>$$</p><p>è½¬æ¢æˆ<br>$$<br>c&#x3D;M^e+kâˆ—n \ mod\ r<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br>n = <span class="hljs-number">131552964273731742744001439326470035414270864348139594004117959631286500198956302913377947920677525319260242121507196043323292374736595943942956194902814842206268870941485429339132421676367167621812260482624743821671183297023718573293452354284932348802548838847981916748951828826237112194142035380559020560287</span> <br>e = <span class="hljs-number">3</span><br>c = <span class="hljs-number">46794664006708417132147941918719938365671485176293172014575392203162005813544444720181151046818648417346292288656741056411780813044749520725718927535262618317679844671500204720286218754536643881483749892207516758305694529993542296670281548111692443639662220578293714396224325591697834572209746048616144307282</span><br>M = <span class="hljs-number">4159518144549137412048572485195536187606187833861349516326031843059872501654790226936115271091120509781872925030241137272462161485445491493686121954785558</span><br>r = <span class="hljs-number">7996728164495259362822258548434922741290100998149465194487628664864256950051236186227986990712837371289585870678059397413537714250530572338774305952904473</span><br>R.&lt;x&gt; = PolynomialRing(Zmod(r), implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>f = M^e+x*n-c<br>x0 = f.monic().small_roots(X = r)<br><span class="hljs-built_in">print</span>(x0)<br><span class="hljs-comment">#è¾“å‡ºä¸ºç©º</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Copperstudy</title>
    <link href="/2022/03/22/Copperstudy/"/>
    <url>/2022/03/22/Copperstudy/</url>
    
    <content type="html"><![CDATA[<hr><p>æœ€è¿‘é‡åˆ°ä¸€ä¸ªå¾ˆä¸é”™çš„é¢˜ã€å¼ºç½‘æ¯2019 Copperstudyã€‘ï¼Œé‡Œé¢åŒ…å«å¤§å¤šæ•°Coppersmithæ”»å‡»ï¼Œæ•…ä»¥æ­¤é¢˜æ¥åˆ†æå…¶ä¸­å‡ºç°çš„ä¸åŒæƒ…å†µçš„æ”»å‡»æ–¹å¼ã€‚</p><hr><p>Coppersmith å¯ä»¥ç”¨äºæ±‚å¤šé¡¹å¼çš„å°æ ¹ï¼Œç»å¸¸ç”¨äº RSA æ”»å‡»ä¸­â€œå·²çŸ¥æŸäº›äºŒè¿›åˆ¶ä½ï¼Œæ±‚å‰©ä½™ä½â€è¿™ä¸€ç±»é—®é¢˜ã€‚</p><hr><h1 id="d0-hashçˆ†ç ´"><a href="#d0-hashçˆ†ç ´" class="headerlink" title="d0:hashçˆ†ç ´"></a>d0:hashçˆ†ç ´</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">d0</span>(<span class="hljs-params">hashstr,<span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>                s = <span class="hljs-built_in">str</span>+a.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;big&#x27;</span>)+b.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;big&#x27;</span>)+c.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;big&#x27;</span>)<br>                <span class="hljs-keyword">if</span> hashlib.sha256(s).hexdigest() == hashstr:<br>                    <span class="hljs-keyword">return</span> binascii.hexlify(s)<br><br>sh = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">29418</span>)<br>sh.recvline()<br>sh.recvuntil(<span class="hljs-string">b&#x27;=&#x27;</span>)<br>hashstr = sh.recvline()[:-<span class="hljs-number">1</span>].decode()<br>sh.recvuntil(<span class="hljs-string">b&#x27;=&#x27;</span>)<br><span class="hljs-built_in">str</span> = binascii.unhexlify(sh.recvline()[:-<span class="hljs-number">1</span>])<br>sh.recvline()<br>sh.sendline(d0(hashstr,<span class="hljs-built_in">str</span>))<br><span class="hljs-built_in">print</span>(sh.recvline())<br></code></pre></td></tr></table></figure><h1 id="d1-å·²çŸ¥pé«˜ä½æ±‚ä½ä½"><a href="#d1-å·²çŸ¥pé«˜ä½æ±‚ä½ä½" class="headerlink" title="d1:å·²çŸ¥pé«˜ä½æ±‚ä½ä½"></a>d1:å·²çŸ¥pé«˜ä½æ±‚ä½ä½</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">e = <br>n = <br>phigh = <br>R.&lt;x&gt; = PolynomialRing(Zmod(n))<br>p = phigh + x<br>x0 = p.small_roots(X = <span class="hljs-number">2</span>^<span class="hljs-number">388</span>,beta = <span class="hljs-number">0.4</span>)[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(x0)<br></code></pre></td></tr></table></figure><h1 id="d2-å·²çŸ¥mé«˜ä½æ±‚ä½ä½"><a href="#d2-å·²çŸ¥mé«˜ä½æ±‚ä½ä½" class="headerlink" title="d2:å·²çŸ¥mé«˜ä½æ±‚ä½ä½"></a>d2:å·²çŸ¥mé«˜ä½æ±‚ä½ä½</h1><p>$$<br>highm &#x3D; 2^{72}*m_{h72}\quad å’Œ\quad<br>câ‰¡(highm+x)^e\ mod\ n<br>$$</p><p>è½¬æ¢æˆsageæ–¹ç¨‹ï¼š<br>$$<br>f &#x3D; (highm+x)^e - c &#x3D; 0<br>$$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">n = <br>e = <br>c = <br>highm = <br><br>R.&lt;x&gt; = PolynomialRing(Zmod(n), implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br><br>f = (highm+x)^e - c<br>x0 = f.small_roots()[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(x0)<br><br>m = highm+x0<br><span class="hljs-built_in">print</span>(m)<br></code></pre></td></tr></table></figure><h1 id="d3-å·²çŸ¥dä½ä½æ±‚é«˜ä½"><a href="#d3-å·²çŸ¥dä½ä½æ±‚é«˜ä½" class="headerlink" title="d3:å·²çŸ¥dä½ä½æ±‚é«˜ä½"></a>d3:å·²çŸ¥dä½ä½æ±‚é«˜ä½</h1><p>dçš„ä½512bits<br>$$<br>e*d â‰¡ 1\ mod \ Ï†(n)\<br>&#x3D;&gt;e*d &#x3D; 1+k*(p-1)*(q-1)<br>$$<br>ä¸¤è¾¹å¯¹$2^{512}$å–æ¨¡ï¼Œå¾—ï¼š<br>$$<br>e*d_{low} â‰¡ 1 + k*(n-p-q+1)\ mod\ 2^{512}<br>$$<br>ä¸ºäº†è®©ä¸Šå¼æˆä¸ºå•å˜é‡ç­‰å¼ï¼ˆå‡å®škå·²çŸ¥ï¼‰ï¼Œä¸¤è¾¹åŒä¹˜pï¼ˆæˆ–qï¼‰ï¼Œå¾—ï¼š<br>$$<br>e*d_{low}*p â‰¡ 1 + k*(n*p-p^2-n-p)\ mod\ 2^{512}<br>$$<br>è§£æ­¤æ–¹ç¨‹å¯å¾—åˆ°pçš„ä½512bitsï¼Œå†é€šè¿‡ç±»ä¼¼d2çš„æ–¹æ³•æ±‚å…¶é«˜ä½ï¼Œä»è€Œå¾—åˆ°p,qã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯kæ˜¯æœªçŸ¥çš„ï¼Œéœ€è¦æšä¸¾å…¶å€¼ã€‚å‚è€ƒä»–äººåšå®¢ï¼Œåº”è¯¥æšä¸¾å‰å‡ ä¸ªå°±è¡Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getp</span>(<span class="hljs-params">n,p_list</span>):<br>    <br>    R.&lt;x&gt; = PolynomialRing(Zmod(n), implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>    <span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> p_list:<br>        f = x*<span class="hljs-number">2</span>^<span class="hljs-number">512</span> + each<br>        x0 = f.monic().small_roots(X = <span class="hljs-number">2</span>^<span class="hljs-number">128</span>, beta = <span class="hljs-number">0.4</span>)<br>        <span class="hljs-keyword">if</span> x0:<br>            <span class="hljs-keyword">return</span> f(x0[<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">d3</span>(<span class="hljs-params">d_low,n,c,e</span>):<br>    <br>    p_list = []<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>):<br>        p = var(<span class="hljs-string">&#x27;p&#x27;</span>)<br>        f = solve_mod([<span class="hljs-number">3</span>*p*d_low == p+k*(n*p-p^<span class="hljs-number">2</span>-n+p)],<span class="hljs-number">2</span>^<span class="hljs-number">512</span>)<br>        p_list += [<span class="hljs-built_in">int</span>(x[<span class="hljs-number">0</span>]) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f]<br>    <span class="hljs-comment">#print(p_list)    </span><br>    p = <span class="hljs-built_in">int</span>(getp(n,p_list))<br>    q = n//p<br>    d = inverse_mod(e,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>    m = <span class="hljs-built_in">pow</span>(c,d,n)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(m)[<span class="hljs-number">2</span>:])<br>    <br>n = <br>c = <br>d_low = <br>e = <span class="hljs-number">3</span><br><br>d3(d_low,n,c,e)<br></code></pre></td></tr></table></figure><h1 id="d4-å¹¿æ’­æ”»å‡»"><a href="#d4-å¹¿æ’­æ”»å‡»" class="headerlink" title="d4:å¹¿æ’­æ”»å‡»"></a>d4:å¹¿æ’­æ”»å‡»</h1><p>åˆ©ç”¨ä¸­å›½å‰©ä½™å®šç†æ±‚è§£ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br>e=<span class="hljs-number">3</span><br>n1=<span class="hljs-number">78642188663937191491235684351005990853149481644703243255021321296087539054265733392095095639539412823093600710316645130404423641473150336492175402885270861906530337207734106926328737198871118125840680572148601743121884788919989184318198417654263598170932154428514561079675550090698019678767738203477097731989</span><br>c1=<span class="hljs-number">23419685303892339080979695469481275906709035609088426118328601771163101123641599051556995351678670765521269546319724616458499631461037359417701720430452076029312714313804716888119910334476982840024696320503747736428099717113471541651211596481005191146454458591558743268791485623924245960696651150688621664860</span><br>n2=<span class="hljs-number">98174485544103863705821086588292917749386955237408645745685476234349659452606822650329076955303471252833860010724515777826660887118742978051231030080666542833950748806944312437614585352818344599399156268450521239843157288915059003487783576003027303399985723834248634230998110618288843582573006048070816520647</span><br>c2=<span class="hljs-number">72080679612442543693944655041130370753964497034378634203383617624269927191363529233872659451561571441107920350406295389613006330637565645758727103723546610079332161151567096389071050158035757745766399510575237344950873632114050632573903701015749830874081198250578516967517980592506626547273178363503100507676</span><br><br>M = CRT([c1,c2],[n1,n2])<br>m = gmpy2.iroot(M,<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(m)[<span class="hljs-number">2</span>:])<br></code></pre></td></tr></table></figure><h1 id="d5-ranklin-Reiter-ç›¸å…³æ¶ˆæ¯æ”»å‡»"><a href="#d5-ranklin-Reiter-ç›¸å…³æ¶ˆæ¯æ”»å‡»" class="headerlink" title="d5:ranklin-Reiter ç›¸å…³æ¶ˆæ¯æ”»å‡»"></a>d5:ranklin-Reiter ç›¸å…³æ¶ˆæ¯æ”»å‡»</h1><p>$$<br>\begin{cases}<br>c_1 â‰¡ m^e\ mod\ n<br>\\<br>c_2 â‰¡ (m+1)^e\ mod\ n<br>\end{cases}<br>&#x3D;&#x3D;&gt;<br>\begin{cases}<br>m^e-c_1&#x3D;0<br>\\<br>(m+1)^e-c_2&#x3D;0<br>\end{cases}<br>$$</p><p>æ—¢ç„¶å·²çŸ¥$m$æ˜¯ä¸Šè¿°ä¸¤æ–¹ç¨‹çš„æ ¹ï¼Œè¯´æ˜å…¶å…¬çº¦å¼å«$(x-m)$ã€‚</p><p>(å› ä¸ºæ–¹ç¨‹å¯ä»¥åŒ–æˆ$(x-x_1)*(x-x_2)*â€¦*(x-x_e)$)</p><p>äºæ˜¯ä¹ï¼Œå¯¹ä¸¤ä¸ªæ–¹ç¨‹æ±‚å…¬çº¦å¼å³å¯ï¼ˆsagemathæ˜¯çœŸçš„å¼ºå¤§ï¼Œè¿™éƒ½èƒ½æ±‚ï¼Œä»£ç ç±»ä¼¼æ±‚ä¸¤ä¸ªæ•°çš„å…¬çº¦æ•°ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">gcd</span>(<span class="hljs-params">a,b</span>):<br>    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> a.monic()<br>    <span class="hljs-keyword">else</span>: <br>        <span class="hljs-keyword">return</span> gcd(b,a%b)<br><br>n = <br>c1 = <br>c2 = <br>e = <br><br>R.&lt;x&gt; = PolynomialRing(Zmod(n))<br>f1 = x^e - c1<br>f2 = (x+<span class="hljs-number">1</span>)^e - c2<br><br>g = gcd(f1,f2)<br><span class="hljs-comment">#print(g)</span><br><span class="hljs-comment">#print(g.coefficients())#æ±‚å„é¡¹çš„ç³»æ•°ï¼ŒæŒ‰æ¬¡æ•°ä»ä½åˆ°é«˜æ’åˆ—</span><br>m = n - g.coefficients()[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(m)[<span class="hljs-number">2</span>:])<br></code></pre></td></tr></table></figure><h1 id="d6-Boneh-Durfee-æ”»å‡»"><a href="#d6-Boneh-Durfee-æ”»å‡»" class="headerlink" title="d6:Boneh Durfee æ”»å‡»"></a>d6:Boneh Durfee æ”»å‡»</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">[+]n= <br>[+]d=random.getrandbits(<span class="hljs-number">1024</span>*<span class="hljs-number">0.270</span>)<br>[+]e=invmod(d,phin)<br>[+]<span class="hljs-built_in">hex</span>(e)=<br>[+]m=random.getrandbits(<span class="hljs-number">512</span>)<br>[+]c=<span class="hljs-built_in">pow</span>(m,e,n)=<br></code></pre></td></tr></table></figure><p>å·²çŸ¥$eï¼Œdâ‰¤n^{0.27}$ã€‚ä½¿ç”¨</p><p><a href="https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/boneh_durfee.sage">Boneh Durfee æ”»å‡»</a></p><hr><p>å‚è€ƒï¼š</p><p><a href="https://www.ruanx.net/coppersmith/">Coppersmith æ”»å‡» (ruanx.net)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Coppersmith</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>D^3CTF2022</title>
    <link href="/2022/03/18/D%5E3CTF%202022/"/>
    <url>/2022/03/18/D%5E3CTF%202022/</url>
    
    <content type="html"><![CDATA[<h1 id="d3factor"><a href="#d3factor" class="headerlink" title="d3factor"></a>d3factor</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> bytes_to_long, getPrime<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> msg<br><span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> nextprime<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> invert<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br><br>flag = <span class="hljs-string">&#x27;d3ctf&#123;&#x27;</span>+md5(msg).hexdigest()+<span class="hljs-string">&#x27;&#125;&#x27;</span><br>p = getPrime(<span class="hljs-number">256</span>)<br>q = getPrime(<span class="hljs-number">256</span>)<br><span class="hljs-keyword">assert</span> p &gt; q<br>n = p * q<br>e = <span class="hljs-number">0x10001</span><br>m = bytes_to_long(msg)<br>c = <span class="hljs-built_in">pow</span>(m, e, n)<br><br>N = <span class="hljs-built_in">pow</span>(p, <span class="hljs-number">7</span>) * q<br>phi = <span class="hljs-built_in">pow</span>(p, <span class="hljs-number">6</span>) * (p - <span class="hljs-number">1</span>) * (q - <span class="hljs-number">1</span>)<br>d1 = getPrime(<span class="hljs-number">2000</span>)<br>d2 = nextprime(d1 + getPrime(<span class="hljs-number">1000</span>))<br>e1 = invert(d1, phi)<br>e2 = invert(d2, phi)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;c = <span class="hljs-subst">&#123;c&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;N = <span class="hljs-subst">&#123;N&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e1 = <span class="hljs-subst">&#123;e1&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e2 = <span class="hljs-subst">&#123;e2&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><p>è§£æï¼š</p><p><a href="https://eprint.iacr.org/2015/399.pdf">399.pdf (iacr.org)</a></p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031022272.png"/><p>å³åˆ©ç”¨$e_1*e_2*(d1-d2)â‰¡e_2-e_1\ mod\ Ï†(N)â‰ˆe_2-e1\ mod\ N$ï¼Œæ±‚è§£æ–¹ç¨‹$e_1*e_2*x - (e_2-e_1) &#x3D; 0$ åœ¨æ¨¡Nä¸‹çš„è§£ã€‚</p><p>ï¼ˆè²Œä¼¼sageä¸­æœªçŸ¥æ•°xå‰ç³»æ•°å¾—ä¸º1ï¼‰</p><p>å¦å¤–è¿™é‡Œçš„cé•¿åº¦è¿œå°äºNçš„é•¿åº¦ï¼Œæ•…è§£å¯†æ—¶$n&#x3D;p*q$ã€‚</p><p>sage</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><br>N = <span class="hljs-number">1476751427633071977599571983301151063258376731102955975364111147037204614220376883752032253407881568290520059515340434632858734689439268479399482315506043425541162646523388437842149125178447800616137044219916586942207838674001004007237861470176454543718752182312318068466051713087927370670177514666860822341380494154077020472814706123209865769048722380888175401791873273850281384147394075054950169002165357490796510950852631287689747360436384163758289159710264469722036320819123313773301072777844457895388797742631541101152819089150281489897683508400098693808473542212963868834485233858128220055727804326451310080791</span><br>e1 = <span class="hljs-number">425735006018518321920113858371691046233291394270779139216531379266829453665704656868245884309574741300746121946724344532456337490492263690989727904837374279175606623404025598533405400677329916633307585813849635071097268989906426771864410852556381279117588496262787146588414873723983855041415476840445850171457530977221981125006107741100779529209163446405585696682186452013669643507275620439492021019544922913941472624874102604249376990616323884331293660116156782891935217575308895791623826306100692059131945495084654854521834016181452508329430102813663713333608459898915361745215871305547069325129687311358338082029</span><br>e2 = <span class="hljs-number">1004512650658647383814190582513307789549094672255033373245432814519573537648997991452158231923692387604945039180687417026069655569594454408690445879849410118502279459189421806132654131287284719070037134752526923855821229397612868419416851456578505341237256609343187666849045678291935806441844686439591365338539029504178066823886051731466788474438373839803448380498800384597878814991008672054436093542513518012957106825842251155935855375353004898840663429274565622024673235081082222394015174831078190299524112112571718817712276118850981261489528540025810396786605197437842655180663611669918785635193552649262904644919</span><br>a = (e2-e1)*gmpy2.invert(e1*e2,N)<br>R.&lt;x&gt; = PolynomialRing(Zmod(N),implementation=<span class="hljs-string">&#x27;NTL&#x27;</span>)<br>f = x-a<br>x0 = f.small_roots(X = <span class="hljs-number">2</span>^<span class="hljs-number">1000</span>,beta = <span class="hljs-number">0.4</span>)<br><span class="hljs-built_in">print</span>(x0)<br></code></pre></td></tr></table></figure><p>python</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br><br>c = <span class="hljs-number">2420624631315473673388732074340410215657378096737020976722603529598864338532404224879219059105950005655100728361198499550862405660043591919681568611707967</span><br>N = <span class="hljs-number">1476751427633071977599571983301151063258376731102955975364111147037204614220376883752032253407881568290520059515340434632858734689439268479399482315506043425541162646523388437842149125178447800616137044219916586942207838674001004007237861470176454543718752182312318068466051713087927370670177514666860822341380494154077020472814706123209865769048722380888175401791873273850281384147394075054950169002165357490796510950852631287689747360436384163758289159710264469722036320819123313773301072777844457895388797742631541101152819089150281489897683508400098693808473542212963868834485233858128220055727804326451310080791</span><br>e1 = <span class="hljs-number">425735006018518321920113858371691046233291394270779139216531379266829453665704656868245884309574741300746121946724344532456337490492263690989727904837374279175606623404025598533405400677329916633307585813849635071097268989906426771864410852556381279117588496262787146588414873723983855041415476840445850171457530977221981125006107741100779529209163446405585696682186452013669643507275620439492021019544922913941472624874102604249376990616323884331293660116156782891935217575308895791623826306100692059131945495084654854521834016181452508329430102813663713333608459898915361745215871305547069325129687311358338082029</span><br>e2 = <span class="hljs-number">1004512650658647383814190582513307789549094672255033373245432814519573537648997991452158231923692387604945039180687417026069655569594454408690445879849410118502279459189421806132654131287284719070037134752526923855821229397612868419416851456578505341237256609343187666849045678291935806441844686439591365338539029504178066823886051731466788474438373839803448380498800384597878814991008672054436093542513518012957106825842251155935855375353004898840663429274565622024673235081082222394015174831078190299524112112571718817712276118850981261489528540025810396786605197437842655180663611669918785635193552649262904644919</span><br>e = <span class="hljs-number">0x10001</span><br>x = <span class="hljs-number">1476751427633071977599571983301151063258376731102955975364111147037204614220376883752032253407881568290520059515340434632858734689439268479399482315506043425541162646523388437842149125178447800616137044219916586942207838674001004007237861470176454543718752182312318068466051713087927370670177514666860822341380494148050832401609562069841131611670608508889564903156115171543356434938854665775998209034026454583918190592316542096833683522232732078346945883792128428219017665904611238598515356080299964332522186719141840239751107772675611703424971072329706974374008179321418610378586680426547416872428073384036373775613</span><br><br>tmp = e1*e2*x-(e2-e1)<br>p6 = gmpy2.gcd(tmp,N)<br>//<span class="hljs-built_in">print</span>(p6)<br>p = gmpy2.iroot(p6,<span class="hljs-number">6</span>)[<span class="hljs-number">0</span>]<br>//<span class="hljs-built_in">print</span>(p)<br>q = N//(p**<span class="hljs-number">7</span>)<br>phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>d = gmpy2.invert(e,phi)<br>m = <span class="hljs-built_in">pow</span>(c,d,p*q)<br><br>flag = <span class="hljs-string">&#x27;d3ctf&#123;&#x27;</span>+md5(long_to_bytes(m)).hexdigest()+<span class="hljs-string">&#x27;&#125;&#x27;</span><br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><h1 id="d3qcg"><a href="#d3qcg" class="headerlink" title="d3qcg"></a>d3qcg</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><span class="hljs-keyword">from</span> gmpy2 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">assert</span> <span class="hljs-string">b&#x27;d3ctf&#x27;</span> <span class="hljs-keyword">in</span> flag<br>Bits = <span class="hljs-number">512</span><br>UnKnownBits = <span class="hljs-number">146</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">QCG</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,bit_length</span>):<br>        p = getPrime(bit_length)<br>        a = randint(<span class="hljs-number">0</span>,p)<br>        c = randint(<span class="hljs-number">0</span>,p)<br>        self._key = &#123;<span class="hljs-string">&#x27;a&#x27;</span>:a,<span class="hljs-string">&#x27;c&#x27;</span>:c,<span class="hljs-string">&#x27;p&#x27;</span>:p&#125;<br>        self.secret = randint(<span class="hljs-number">0</span>,p)<br>        self.high = []<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Qnext</span>(<span class="hljs-params">self,num</span>):<br>        <span class="hljs-keyword">return</span> ((self._key[<span class="hljs-string">&#x27;a&#x27;</span>])*num**<span class="hljs-number">2</span>+self._key[<span class="hljs-string">&#x27;c&#x27;</span>])%self._key[<span class="hljs-string">&#x27;p&#x27;</span>]<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hint</span>(<span class="hljs-params">self</span>):<br>        num = self.secret<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>            num = self.Qnext(num)<br>            self.high.append(num&gt;&gt;UnKnownBits)<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_key</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self._key<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_hint</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self.high<br><br>Q1 = QCG(Bits)<br><span class="hljs-built_in">print</span>(Q1.get_key())<br><span class="hljs-comment">#&#123;&#x27;a&#x27;: 3591518680290719943596137190796366296374484536382380061852237064647969442581391967815457547858969187198898670115651116598727939742165753798804458359397101, &#x27;c&#x27;: 6996824752943994631802515921125382520044917095172009220000813718617441355767447428067985103926211738826304567400243131010272198095205381950589038817395833, &#x27;p&#x27;: 7386537185240346459857715381835501419533088465984777861268951891482072249822526223542514664598394978163933836402581547418821954407062640385756448408431347&#125;</span><br>Q1.hint()<br><span class="hljs-built_in">print</span>(Q1.get_hint())<br><span class="hljs-comment">#[67523583999102391286646648674827012089888650576715333147417362919706349137337570430286202361838682309142789833, 70007105679729967877791601360700732661124470473944792680253826569739619391572400148455527621676313801799318422]</span><br>enc = bytes_to_long(hashlib.sha512(<span class="hljs-string">b&#x27;%d&#x27;</span>%(secret)).digest())^bytes_to_long(flag)<br><span class="hljs-built_in">print</span>(enc)<br><span class="hljs-comment"># 6176615302812247165125832378994890837952704874849571780971393318502417187945089718911116370840334873574762045429920150244413817389304969294624001945527125</span><br></code></pre></td></tr></table></figure><p>è§£æï¼š</p><p>ç¿»è¯‘ä¸€ä¸‹å¤§æ¦‚å°±æ˜¯è¿™æ ·ã€‚</p><p>ç»™å‡ºå…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>num1 &#x3D; (a*secret^2+c)%p<br>$$<br>ä»¥åŠ<br>$$<br>num2 &#x3D; (a*num1^2+c)%p<br>$$<br>ç°æœ‰<code>num1&gt;&gt;146</code>å’Œ<code>num2&gt;&gt;146</code>çš„ç»“æœ<code>[h1,h2]</code>ï¼Œæ±‚<code>secret</code></p><p>éœ€è¦è¿›è¡ŒäºŒå…ƒ<code>Coppersmith</code>ã€‚ï¼ˆæ·¦ï¼ä¸€å…ƒçš„éƒ½ä¸æ€ä¹ˆç†Ÿæ‚‰ï¼Œè¿˜æ˜¯åˆ«äººçš„è„šæœ¬é¦™ğŸ˜…ï¼‰</p><p>ç”±äºæœ€åæ±‚çš„secretéœ€è¦å¼€å¹³æ–¹ã€‚ï¼ˆ ç”±äº $p &#x3D; 4k + 3$ï¼Œæ‰€ä»¥$x&#x3D; a^{(p+1)&#x2F;&#x2F;4}\ mod\ p$ ï¼‰</p><p><a href="https://rosettacode.org/wiki/Tonelli-Shanks_algorithm#Python">Tonelli-Shanks algorithm - Rosetta Code</a>(ä»£ç )</p><p><a href="https://handwiki.org/wiki/Tonelli%E2%80%93Shanks_algorithm#cite_note-dickson-3">Tonelliâ€“Shanks algorithm - HandWiki</a>ï¼ˆç†è®ºï¼‰</p><p><a href="https://en.wikipedia.org/wiki/Tonelli%E2%80%93Shanks_algorithm%EF%BC%88%E7%90%86%E8%AE%BA%EF%BC%89">https://en.wikipedia.org/wiki/Tonelli%E2%80%93Shanks_algorithmï¼ˆç†è®ºï¼‰</a></p><p><a href="https://blog.csdn.net/qq_43698421/article/details/107452334"> RabinåŠ å¯†ç®—æ³•_Dragon Liuçš„åšå®¢-CSDNåšå®¢_rabinç®—æ³•</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#sage</span><br><span class="hljs-keyword">import</span> itertools<br>a = <span class="hljs-number">3591518680290719943596137190796366296374484536382380061852237064647969442581391967815457547858969187198898670115651116598727939742165753798804458359397101</span><br>c = <span class="hljs-number">6996824752943994631802515921125382520044917095172009220000813718617441355767447428067985103926211738826304567400243131010272198095205381950589038817395833</span><br>p = <span class="hljs-number">7386537185240346459857715381835501419533088465984777861268951891482072249822526223542514664598394978163933836402581547418821954407062640385756448408431347</span><br>ans = (<span class="hljs-number">50712831100361370819145886978385347931029768</span>, <span class="hljs-number">9089234402520025586415667640120652372860183</span>)<br>high = [<span class="hljs-number">67523583999102391286646648674827012089888650576715333147417362919706349137337570430286202361838682309142789833</span>, <span class="hljs-number">70007105679729967877791601360700732661124470473944792680253826569739619391572400148455527621676313801799318422</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">small_roots</span>(<span class="hljs-params">f, bounds, m=<span class="hljs-number">1</span>, d=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> d:<br>        d = f.degree()<br>    R = f.base_ring()<br>    N = R.cardinality()<br>    f /= f.coefficients().pop(<span class="hljs-number">0</span>)<br>    f = f.change_ring(ZZ)<br>    G = <span class="hljs-type">Sequence</span>([], f.parent())<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m+<span class="hljs-number">1</span>):<br>        base = N^(m-i) * f^i<br>        <span class="hljs-keyword">for</span> shifts <span class="hljs-keyword">in</span> itertools.product(<span class="hljs-built_in">range</span>(d), repeat=f.nvariables()):<br>            g = base * prod(<span class="hljs-built_in">map</span>(power, f.variables(), shifts))<br>            G.append(g)<br>    B, monomials = G.coefficient_matrix()<br>    monomials = vector(monomials)<br>    factors = [monomial(*bounds) <span class="hljs-keyword">for</span> monomial <span class="hljs-keyword">in</span> monomials]<br>    <span class="hljs-keyword">for</span> i, factor <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(factors):<br>        B.rescale_col(i, factor)<br>    B = B.dense_matrix().LLL()<br>    B = B.change_ring(QQ)<br>    <span class="hljs-keyword">for</span> i, factor <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(factors):<br>        B.rescale_col(i, <span class="hljs-number">1</span>/factor)<br>    H = <span class="hljs-type">Sequence</span>([], f.parent().change_ring(QQ))<br>    <span class="hljs-keyword">for</span> h <span class="hljs-keyword">in</span> <span class="hljs-built_in">filter</span>(<span class="hljs-literal">None</span>, B*monomials):<br>        H.append(h)<br>        I = H.ideal()<br>        <span class="hljs-keyword">if</span> I.dimension() == -<span class="hljs-number">1</span>:<br>            H.pop()<br>        <span class="hljs-keyword">elif</span> I.dimension() == <span class="hljs-number">0</span>:<br>            roots = []<br>            <span class="hljs-keyword">for</span> root <span class="hljs-keyword">in</span> I.variety(ring=ZZ):<br>                root = <span class="hljs-built_in">tuple</span>(R(root[var]) <span class="hljs-keyword">for</span> var <span class="hljs-keyword">in</span> f.variables())<br>                roots.append(root)<br>            <span class="hljs-keyword">return</span> roots<br>    <span class="hljs-keyword">return</span> []<br><br>R.&lt;x1,x2&gt; = PolynomialRing(Zmod(p))<br>f = a*(high[<span class="hljs-number">0</span>]*(<span class="hljs-number">2</span>^<span class="hljs-number">146</span>)+x1)^<span class="hljs-number">2</span> + c - (high[<span class="hljs-number">1</span>]*<span class="hljs-number">2</span>^<span class="hljs-number">146</span>+x2)<br><span class="hljs-built_in">print</span>(small_roots(f,[<span class="hljs-number">2</span>^<span class="hljs-number">146</span>, <span class="hljs-number">2</span>^<span class="hljs-number">146</span>],m =<span class="hljs-number">4</span>,d = <span class="hljs-number">4</span>))<br><br><span class="hljs-comment">#python</span><br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> hashlib<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Legendre</span>(<span class="hljs-params">a, p</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(a, (p-<span class="hljs-number">1</span>)//<span class="hljs-number">2</span>, p)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Tonelli_Shanks</span>(<span class="hljs-params">a, p</span>):<br>    <span class="hljs-keyword">assert</span> Legendre(a, p) == <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span>(p % <span class="hljs-number">4</span> == <span class="hljs-number">3</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(a, (p+<span class="hljs-number">1</span>)//<span class="hljs-number">4</span>, p)<br>    s, q = <span class="hljs-number">0</span>, p-<span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> q &amp; <span class="hljs-number">1</span> == <span class="hljs-number">0</span>:<br>        q &gt;&gt;= <span class="hljs-number">1</span><br>        s += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> z <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, p):<br>        <span class="hljs-keyword">if</span> Legendre(z, p) == p-<span class="hljs-number">1</span>:<br>            c = <span class="hljs-built_in">pow</span>(z, q, p)<br>            <span class="hljs-keyword">break</span><br>    r, t, m = <span class="hljs-built_in">pow</span>(a, (q+<span class="hljs-number">1</span>)//<span class="hljs-number">2</span>, p), <span class="hljs-built_in">pow</span>(a, q, p), s<br>    temp, i = <span class="hljs-number">1</span>, <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> t % p != <span class="hljs-number">1</span>:<br>        i += <span class="hljs-number">1</span><br>        temp = <span class="hljs-built_in">pow</span>(t, <span class="hljs-number">2</span>**i, p)<br>        <span class="hljs-keyword">if</span> temp % p == <span class="hljs-number">1</span>:<br>            b = <span class="hljs-built_in">pow</span>(c, <span class="hljs-number">2</span>**(m-<span class="hljs-number">1</span>-i), p)<br>            r = r * b % p<br>            c = b * b % p<br>            t = t * c % p<br>            m = i<br>            i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> r<br><br>a = <span class="hljs-number">3591518680290719943596137190796366296374484536382380061852237064647969442581391967815457547858969187198898670115651116598727939742165753798804458359397101</span><br>c = <span class="hljs-number">6996824752943994631802515921125382520044917095172009220000813718617441355767447428067985103926211738826304567400243131010272198095205381950589038817395833</span><br>p = <span class="hljs-number">7386537185240346459857715381835501419533088465984777861268951891482072249822526223542514664598394978163933836402581547418821954407062640385756448408431347</span><br>ans = (<span class="hljs-number">50712831100361370819145886978385347931029768</span>, <span class="hljs-number">9089234402520025586415667640120652372860183</span>)<br>high = [<span class="hljs-number">67523583999102391286646648674827012089888650576715333147417362919706349137337570430286202361838682309142789833</span>, <span class="hljs-number">70007105679729967877791601360700732661124470473944792680253826569739619391572400148455527621676313801799318422</span>]<br>enc = <span class="hljs-number">6176615302812247165125832378994890837952704874849571780971393318502417187945089718911116370840334873574762045429920150244413817389304969294624001945527125</span><br>data = (high[<span class="hljs-number">0</span>]&lt;&lt;<span class="hljs-number">146</span>) + ans[<span class="hljs-number">0</span>]<br>secret = (data - c) * gmpy2.invert(a, p) % p<br>secret = Tonelli_Shanks(secret, p)<br><span class="hljs-built_in">print</span>(secret)<br>flag = bytes_to_long(hashlib.sha512(<span class="hljs-string">b&#x27;%d&#x27;</span>%(secret)).digest())^enc<br><span class="hljs-built_in">print</span>(long_to_bytes(flag))<br></code></pre></td></tr></table></figure><h1 id="d3bug"><a href="#d3bug" class="headerlink" title="d3bug"></a>d3bug</h1><p>xoræ¨¡å¼ä¸‹å¯ä»¥ä»è¾“å‡ºæ¨å‡ºmessageçš„å‰34ä½ã€‚</p><p>å‡è®¾ <code>mask = &#39;10100100&#39;</code>, $R&#x3D;m_0m_1â€¦m_7$</p><p>ç¬¬ä¸€è½®xor,å¾—<br>$$<br>lastbit_0&#x3D;\overline m_0âŠ•m_1âŠ•\overline m_2âŠ•m_3âŠ•m_4âŠ•\overline m_5âŠ•m_6âŠ•m_7<br>$$<br>ç¬¬äºŒè½®xorï¼Œå¾—<br>$$<br>lastbit_1&#x3D;\overline m_1âŠ•m_2âŠ•\overline m_3âŠ•m_4âŠ•m_5âŠ•\overline m_6âŠ•m_7âŠ•lastbit_0<br>$$<br>åŒ–ç®€ $lastbit_1$,å¾—<br>$$<br>lastbit_1&#x3D;\overline m_0âŠ•1&#x3D;m_0\<br>(å…¶ä¸­âŠ•1å¾—ä¸ªæ•°ç­‰äºmaskä¸­1çš„ä¸ªæ•°å’Œä½ç½®è€Œå®š)<br>$$<br>å‰©ä¸‹çš„30ä½å¯ä»¥åˆ©ç”¨&amp;æ¨¡å¼ä¸‹çš„è¾“å‡ºæ„é€ çŸ©é˜µæ–¹ç¨‹æ±‚è§£ã€‚</p><hr><p>å‚è€ƒ:</p><p><a href="https://blog.wm-team.cn/index.php/archives/13/">AntCTF &amp; DË†3CTF 2022 By W&amp;M - W&amp;M Team (wm-team.cn)</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
      <tag>Coppersmith</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SUSCTF2022</title>
    <link href="/2022/03/18/SUSCTF2022/"/>
    <url>/2022/03/18/SUSCTF2022/</url>
    
    <content type="html"><![CDATA[<h2 id="large-case"><a href="#large-case" class="headerlink" title="large case"></a>large case</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> e,message<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pad</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s)&lt;<span class="hljs-number">3</span>*L:<br>        s+=<span class="hljs-built_in">bytes</span>(<span class="hljs-number">3</span>*L-<span class="hljs-built_in">len</span>(s))<br>    <span class="hljs-keyword">return</span> s<br><br>L=<span class="hljs-number">128</span><br>p=<br>q=<br>r=<br>n=p*q*r<br><br><span class="hljs-keyword">assert</span> isPrime(GCD(e,p-<span class="hljs-number">1</span>)) <span class="hljs-keyword">and</span> isPrime(GCD(e,q-<span class="hljs-number">1</span>)) <span class="hljs-keyword">and</span> isPrime(GCD(e,r-<span class="hljs-number">1</span>)) <span class="hljs-keyword">and</span> e==GCD(e,p-<span class="hljs-number">1</span>)*GCD(e,q-<span class="hljs-number">1</span>)*GCD(e,r-<span class="hljs-number">1</span>)<br><span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(message)&gt;L <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(message)&lt;<span class="hljs-number">2</span>*L<br><span class="hljs-keyword">assert</span> <span class="hljs-string">b&#x27;SUSCTF&#x27;</span> <span class="hljs-keyword">in</span> message<br>m=bytes_to_long(pad(message))<br><br>c=<span class="hljs-built_in">pow</span>(m,e,n)<br><span class="hljs-built_in">print</span>(c)<br></code></pre></td></tr></table></figure><p>æ ¹æ®$e&#x3D;&#x3D;GCD(e,p-1)*GCD(e,q-1)*GCD(e,r-1)$ï¼Œè®¾$e &#x3D; e_pe_qe_r$ã€‚<br>$$<br>câ‰¡m^{e_pe_qe_r}â‰¡(m^{e_pe_q})^{e_r}\ mod\ n<br>$$<br>ç»§è€Œ<br>$$<br>câ‰¡(m^{e_pe_q})^{e_r}\ mod\ (r-1)<br>$$<br>æ ¹æ®è´¹é©¬å°å®šç†æœ‰ï¼š<br>$$<br>c^{(r-1)&#x2F;e_r}â‰¡(m^{e_pe_q})^{r-1}â‰¡1\ mod\ (r-1)<br>$$<br>äºæ˜¯æ±‚å¾—$e_r$ï¼ŒåŒç†$e_p,e_q$ä¹Ÿå¦‚æ­¤ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ±‚å¾—äº†eï¼Œä½†gcd(e,(p-1)<em>(q-1)</em>(r-1)) &#x3D; eï¼Œå¹¶ä¸èƒ½ç›´æ¥è§£å¯†ï¼Œå¯ä»¥ç”¨AMMç®—æ³•æ±‚è§£ã€‚</p><p>ä½†è¿™é‡Œæ ¹æ®å®˜æ–¹é¢˜è§£ç”¨ä¸€ä¸ªæ›´å¿«çš„æ–¹æ³•ã€‚ï¼ˆç®—æ³•æ¥æºï¼š<a href="https://eprint.iacr.org/2020/1059.pdf">1059.pdf (iacr.org)</a>ï¼‰ï¼ˆç¨€é‡Œç³Šæ¶‚ï¼Œè‹±è¯­æ°´å¹³æœ‰é™ï¼Œçœ‹ä¸æ‡‚ï¼‰</p><p>ä½†æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031028950.png"/><p>ç”±äºè¯¥ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(e)ï¼Œå³ä¸eæˆçº¿æ€§å…³ç³»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼©çŸ­eæ¥ç¼©çŸ­æ—¶é—´ã€‚</p><p>æ ¹æ®é¢˜ç›®ä¸­$len(message)&gt;L\ and\ len(message)&lt;2*L$ï¼Œè€Œé€šè¿‡$pad$å‡½æ•°å¯ä»¥å‘ç°ï¼Œmessageçš„å¡«å……éƒ¨åˆ†&gt;1024bitã€‚å› æ­¤å¯ä»¥å°†nç¼©å°ä¸ºpqï¼Œeç¼©å°ä¸º$e_pe_q$ã€‚<br>$$<br>c â‰¡ m^{e} â‰¡ (m*2^{1024})^e\ mod\ n<br>$$<br>äºæ˜¯<br>$$<br>c_1 &#x3D; c*2^{-1024e}â‰¡m^e\ mod\ n<br>$$<br>ç®€åŒ–æ¨¡æ•°<br>$$<br>c_1 â‰¡ m^e\ mod\ (p*q)<br>$$<br>è¿™æ—¶å€™å†å°† $e_r$ æ¶ˆé™¤<br>$$<br>e_rd_r â‰¡ 1\ mod\ (p-1)*(q-1)\<br>c_0 &#x3D; c_1^{d_r} â‰¡ m^{ed_r} â‰¡ m^{e_pe_q}\ mod\ (p*q)<br>$$<br>æ ¹æ®ç®—æ³•æè¿°å†™å‡ºè„šæœ¬ï¼š</p><p>ç¬¬ä¸€æ­¥ï¼šå¯»æ‰¾$g_E$ã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031029653.png"/><p>ç¬¬äºŒæ­¥ï¼šæ‰¾ç¬¦åˆçš„æ˜æ–‡</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031029505.png"/><p>å…¶ä¸­çš„$l$ä¸º$l&#x3D;g_E^i$ã€‚</p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main//img/202210031029045.png"/><p>ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> primefac<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-keyword">import</span> tqdm<br><br>p=<span class="hljs-number">127846753573603084140032502367311687577517286192893830888210505400863747960458410091624928485398237221748639465569360357083610343901195273740653100259873512668015324620239720302434418836556626441491996755736644886234427063508445212117628827393696641594389475794455769831224080974098671804484986257952189021223</span><br>q=<span class="hljs-number">145855456487495382044171198958191111759614682359121667762539436558951453420409098978730659224765186993202647878416602503196995715156477020462357271957894750950465766809623184979464111968346235929375202282811814079958258215558862385475337911665725569669510022344713444067774094112542265293776098223712339100693</span><br>r=<span class="hljs-number">165967627827619421909025667485886197280531070386062799707570138462960892786375448755168117226002965841166040777799690060003514218907279202146293715568618421507166624010447447835500614000601643150187327886055136468260391127675012777934049855029499330117864969171026445847229725440665179150874362143944727374907</span><br>c=<span class="hljs-number">2832775557487418816663494645849097066925967799754895979829784499040437385450603537732862576495758207240632734290947928291961063611897822688909447511260639429367768479378599532712621774918733304857247099714044615691877995534173849302353620399896455615474093581673774297730056975663792651743809514320379189748228186812362112753688073161375690508818356712739795492736743994105438575736577194329751372142329306630950863097761601196849158280502041616545429586870751042908365507050717385205371671658706357669408813112610215766159761927196639404951251535622349916877296956767883165696947955379829079278948514755758174884809479690995427980775293393456403529481055942899970158049070109142310832516606657100119207595631431023336544432679282722485978175459551109374822024850128128796213791820270973849303929674648894135672365776376696816104314090776423931007123128977218361110636927878232444348690591774581974226318856099862175526133892</span><br><br><span class="hljs-keyword">for</span> ep <span class="hljs-keyword">in</span> primefac.primefac(p-<span class="hljs-number">1</span>):<span class="hljs-comment">#åˆ†è§£å‡ºp-1çš„æ‰€æœ‰å› æ•°</span><br>    <span class="hljs-keyword">if</span> ep&gt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">pow</span>(c%p,(p-<span class="hljs-number">1</span>)//ep,p)==<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">break</span><br><span class="hljs-keyword">for</span> eq <span class="hljs-keyword">in</span> primefac.primefac(q-<span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">if</span> eq&gt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">pow</span>(c%q,(q-<span class="hljs-number">1</span>)//eq,q)==<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">break</span><br><span class="hljs-keyword">for</span> er <span class="hljs-keyword">in</span> primefac.primefac(r-<span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">if</span> er&gt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">pow</span>(c%r,(r-<span class="hljs-number">1</span>)//er,r)==<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">break</span><br><br>e=ep*eq*er<br>n=p*q*r<br>e0=ep*eq<br>n0=p*q<br>phi0=(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>d1=gmpy2.invert(er,phi0)<br>c1=c*gmpy2.invert(<span class="hljs-built_in">pow</span>(<span class="hljs-number">256</span>,<span class="hljs-number">128</span>*e,n),n)%n<br>c0=<span class="hljs-built_in">pow</span>(c1,d1,n0)<br><br>g = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    g+=<span class="hljs-number">1</span><br>    gE = <span class="hljs-built_in">pow</span>(g,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)//e0,n0)<br>    <span class="hljs-keyword">if</span> gE != <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">break</span><br><br><span class="hljs-comment">#gE=pow(2,phi0//e0,n0)</span><br>d0=gmpy2.invert(e0,phi0//e0)<br>a0=<span class="hljs-built_in">pow</span>(c0,d0,n0)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm.tqdm(<span class="hljs-built_in">range</span>(e0)):<br>    m=long_to_bytes(a0)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;SUSCTF&#x27;</span> <span class="hljs-keyword">in</span> m:<br>        flag=m.decode()<br>        <span class="hljs-built_in">print</span>(flag)<br>        <span class="hljs-keyword">break</span><br>    a0=a0*gE%n0<br></code></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p><a href="https://github.com/susers/SUSCTF2022_official_wp/tree/main/crypto">SUSCTF2022_official_wp&#x2F;crypto at main Â· susers&#x2F;SUSCTF2022_official_wp (github.com)</a></p><p><a href="https://eprint.iacr.org/2020/1059.pdf">1059.pdf (iacr.org)</a></p><p><a href="https://team-su.github.io/passages/2022-2-28-SUSCTF/">2022 SUSCTF SU Writeup | TEAM-SU</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/8/#large+case">SUSCTF 2022 By W&amp;M - W&amp;M Team (wm-team.cn)</a></p><p><a href="https://blog.csdn.net/qq_51999772/article/details/123273510">SUSCTF_Crypto_large case_å¤ç°_M3ng@Lçš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RSA</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
