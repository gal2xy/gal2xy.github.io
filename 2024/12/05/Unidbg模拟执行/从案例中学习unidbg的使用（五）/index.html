

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="gla2xy">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、引言目标 APK：dazhongdianping.apk 目标类：com.meituan.android.common.mtguard.NBridge$SIUACollector 目标方法：见第二小节 目标方法实现：libmtguard.so 二、任务介绍JADX反编译 APK，找到com.meituan.android.common.mtguard.NBridge类，其中有一个叫SIUACo">
<meta property="og:type" content="article">
<meta property="og:title" content="从案例中学习unidbg的使用（五）">
<meta property="og:url" content="http://example.com/2024/12/05/Unidbg%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/%E4%BB%8E%E6%A1%88%E4%BE%8B%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E7%9A%84%E4%BD%BF%E7%94%A8%EF%BC%88%E4%BA%94%EF%BC%89/index.html">
<meta property="og:site_name" content="gla2xy&#39;s blog">
<meta property="og:description" content="一、引言目标 APK：dazhongdianping.apk 目标类：com.meituan.android.common.mtguard.NBridge$SIUACollector 目标方法：见第二小节 目标方法实现：libmtguard.so 二、任务介绍JADX反编译 APK，找到com.meituan.android.common.mtguard.NBridge类，其中有一个叫SIUACo">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202412051703442.png">
<meta property="og:image" content="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202412051703244.png">
<meta property="article:published_time" content="2024-12-05T09:54:32.000Z">
<meta property="article:modified_time" content="2024-12-05T09:56:24.828Z">
<meta property="article:author" content="gla2xy">
<meta property="article:tag" content="Unidbg">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202412051703442.png">
  
  
  
  <title>从案例中学习unidbg的使用（五） - gla2xy&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"y4ByOj1FL3SFodYp7tlkfLna-gzGzoHsz","app_key":"7E1eIfDTBkJaMJkiQI0jToXE","server_url":null,"path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>gal2xy&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="从案例中学习unidbg的使用（五）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        gla2xy
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-05 17:54" pubdate>
          2024年12月5日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          95k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          795 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">从案例中学习unidbg的使用（五）</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h1><p>目标 APK：dazhongdianping.apk</p>
<p>目标类：com.meituan.android.common.mtguard.NBridge$SIUACollector</p>
<p>目标方法：见第二小节</p>
<p>目标方法实现：libmtguard.so</p>
<h1 id="二、任务介绍"><a href="#二、任务介绍" class="headerlink" title="二、任务介绍"></a>二、任务介绍</h1><p><code>JADX</code>反编译 APK，找到<code>com.meituan.android.common.mtguard.NBridge</code>类，其中有一个叫<code>SIUACollector</code>的内部类，里面有以下这些 Native 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getEnvironmentInfo</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getEnvironmentInfoExtra</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getExternalEquipmentInfo</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getHWEquipmentInfo</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getHWProperty</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getHWStatus</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getLocationInfo</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getPlatformInfo</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">getUserAction</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">startCollection</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>

<p>请在 Unidbg 中依次执行这十个函数，本篇的重点是巩固 Unidbg 补环境的形式，以及学习 Unidbg 补环境的内容。</p>
<h1 id="三、初始化"><a href="#三、初始化" class="headerlink" title="三、初始化"></a>三、初始化</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.meituan.android.common.mtguard;<br><br><span class="hljs-keyword">import</span> com.github.unidbg.AndroidEmulator;<br><span class="hljs-keyword">import</span> com.github.unidbg.arm.backend.Unicorn2Factory;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.*;<br><span class="hljs-keyword">import</span> com.github.unidbg.memory.Memory;<br><span class="hljs-keyword">import</span> com.github.unidbg.virtualmodule.android.AndroidModule;<br><span class="hljs-keyword">import</span> com.github.unidbg.virtualmodule.android.JniGraphics;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NBridge</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJni</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Memory memory;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DvmObject&lt;?&gt; cSIUACollectorObj;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NBridge</span><span class="hljs-params">()</span>&#123;<br><br>        emulator = AndroidEmulatorBuilder<br>            .for32Bit()<br>            .addBackendFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Unicorn2Factory</span>(<span class="hljs-literal">true</span>))<br>            .setProcessName(<span class="hljs-string">&quot;com.dianping.v1&quot;</span>)<br>            .build();<br><br>        memory = emulator.getMemory();<br>        memory.setLibraryResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>));<br><br>        vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android/src/test/resources/dazhongdianping/dazhongdianping.apk&quot;</span>));<br>        vm.setJni(<span class="hljs-built_in">this</span>);<br>        vm.setVerbose(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// 使用 libandroid.so 虚拟模块, 需早于目标 SO 加载的时机</span><br><span class="hljs-comment">//        new AndroidModule(emulator, vm).register(memory);</span><br>        <span class="hljs-comment">// 使用 libjnigraphics.so 的虚拟模块</span><br><span class="hljs-comment">//        new JniGraphics(emulator, vm).register(memory);</span><br><br>        <span class="hljs-type">DalvikModule</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span> vm.loadLibrary(<span class="hljs-string">&quot;mtguard&quot;</span>, <span class="hljs-literal">true</span>);<br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">cSIUACollector</span> <span class="hljs-operator">=</span> vm.resolveClass(<span class="hljs-string">&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;</span>);<br>        cSIUACollectorObj = cSIUACollector.newObject(<span class="hljs-literal">null</span>);<br>        dm.callJNI_OnLoad(emulator);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">NBridge</span> <span class="hljs-variable">nBridge</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NBridge</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于我们所需要执行的这十个函数都是实例方法，为了免于重复<code>newObject</code>，将<code>SIUACollector</code>处理为<code>DvmObject</code>。</p>
<p>执行会提示</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[14:11:16 565]</span>  INFO <span class="hljs-selector-attr">[com.github.unidbg.linux.AndroidElfLoader]</span> (AndroidElfLoader:<span class="hljs-number">481</span>) - libmtguard<span class="hljs-selector-class">.so</span> load dependency libandroid<span class="hljs-selector-class">.so</span> failed<br><span class="hljs-selector-attr">[14:11:16 579]</span>  INFO <span class="hljs-selector-attr">[com.github.unidbg.linux.AndroidElfLoader]</span> (AndroidElfLoader:<span class="hljs-number">481</span>) - libmtguard<span class="hljs-selector-class">.so</span> load dependency libjnigraphics<span class="hljs-selector-class">.so</span> failed<br></code></pre></td></tr></table></figure>

<p>意思是加载 libandroid.so、libjnigraphics.so 失败， unidbg 提供了这两个库的虚拟模块，只需<strong>早于</strong>目标 SO 加载的时机之前加载即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 使用 libandroid.so 虚拟模块, 需早于目标 SO 加载的时机</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidModule</span>(emulator, vm).register(memory);<br><span class="hljs-comment">// 使用 libjnigraphics.so 的虚拟模块</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">JniGraphics</span>(emulator, vm).register(memory);<br></code></pre></td></tr></table></figure>



<h1 id="四、getEnvironmentInfo"><a href="#四、getEnvironmentInfo" class="headerlink" title="四、getEnvironmentInfo"></a>四、getEnvironmentInfo</h1><p>调用代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getEnvironmentInfo</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">envInfo</span> <span class="hljs-operator">=</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getEnvironmentInfo()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>    <span class="hljs-keyword">return</span> envInfo;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行发现直接得出了结果，无需补环境。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">getEnvironmentInfo call result: 0|<span class="hljs-string">0</span>|<span class="hljs-string">0</span>|<span class="hljs-string">-</span>|<span class="hljs-string">0</span>|<br></code></pre></td></tr></table></figure>



<h1 id="五、getEnvironmentInfoExtra"><a href="#五、getEnvironmentInfoExtra" class="headerlink" title="五、getEnvironmentInfoExtra"></a>五、getEnvironmentInfoExtra</h1><p>调用代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getEnvironmentInfoExtra</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">envInfoEx</span> <span class="hljs-operator">=</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getEnvironmentInfoExtra()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>    <span class="hljs-keyword">return</span> envInfoEx;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错如下</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">JNIEnv-&gt;<span class="hljs-built_in">NewGlobalRef</span>(class java/lang/StringBuilder) was called from RX@<span class="hljs-number">0</span>x12005f5d<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x5f5d<br><span class="hljs-selector-attr">[14:19:27 954]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x117, PC=unidbg@<span class="hljs-number">0</span>xfffe0204, LR=RX@<span class="hljs-number">0</span>x12007443<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x7443, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/lang/StringBuilder-&gt;allocObject<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.allocObject</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">812</span>)<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.DvmClass</span><span class="hljs-selector-class">.allocObject</span>(DvmClass<span class="hljs-selector-class">.java</span>:<span class="hljs-number">74</span>)<br></code></pre></td></tr></table></figure>

<p>参考 AbstractJni 中的 allocObject 处理</p>
<p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202412051703442.png" srcset="/img/loading.gif" lazyload></p>
<p>做相同处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> DvmObject&lt;?&gt; allocObject(BaseVM vm, DvmClass dvmClass, String signature) &#123;<br>    <span class="hljs-keyword">switch</span> (signature)&#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/StringBuilder-&gt;allocObject&quot;</span>: &#123;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            <span class="hljs-keyword">return</span> dvmClass.newObject(builder);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.allocObject(vm, dvmClass, signature);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">JNIEnv-&gt;<span class="hljs-built_in">GetMethodID</span>(java/lang/StringBuilder.&lt;init&gt;()V) =&gt; <span class="hljs-number">0</span>xad81ca9c was called from RX@<span class="hljs-number">0</span>x12006369<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x6369<br><span class="hljs-selector-attr">[14:24:36 014]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x13b, PC=unidbg@<span class="hljs-number">0</span>xfffe0444, LR=RX@<span class="hljs-number">0</span>x120095f1<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x95f1, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/lang/StringBuilder-&gt;&lt;init&gt;()V<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callVoidMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1007</span>)<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callVoidMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">990</span>)<br></code></pre></td></tr></table></figure>

<p>刚分配的StirngBuilder需要初始化，这里什么也不做，直接返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callVoidMethodV</span><span class="hljs-params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (signature)&#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/StringBuilder-&gt;&lt;init&gt;()V&quot;</span>: &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">super</span>.callVoidMethodV(vm, dvmObject, signature, vaList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">JNIEnv-&gt;<span class="hljs-constructor">GetMethodID(<span class="hljs-params">com</span><span class="hljs-operator">/</span><span class="hljs-params">meituan</span><span class="hljs-operator">/</span><span class="hljs-params">android</span><span class="hljs-operator">/</span><span class="hljs-params">common</span><span class="hljs-operator">/</span><span class="hljs-params">mtguard</span><span class="hljs-operator">/</span>NBridge<span class="hljs-params">$SIUACollector</span>.<span class="hljs-params">getEnvironmentInfo</span>()</span>Ljava/lang/String;) =&gt; <span class="hljs-number">0xa10d6eee</span> was called from RX@<span class="hljs-number">0x12006369</span><span class="hljs-literal">[<span class="hljs-identifier">libmtguard</span>.<span class="hljs-identifier">so</span>]</span><span class="hljs-number">0x6369</span><br><span class="hljs-literal">[<span class="hljs-number">14</span>:<span class="hljs-number">29</span>:<span class="hljs-number">42</span> <span class="hljs-number">737</span>]</span>  WARN <span class="hljs-literal">[<span class="hljs-identifier">com</span>.<span class="hljs-identifier">github</span>.<span class="hljs-identifier">unidbg</span>.<span class="hljs-identifier">linux</span>.ARM32S<span class="hljs-identifier">yscallHandler</span>]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0x120</span>, PC=unidbg@<span class="hljs-number">0xfffe0294</span>, LR=RX@<span class="hljs-number">0x12008403</span><span class="hljs-literal">[<span class="hljs-identifier">libmtguard</span>.<span class="hljs-identifier">so</span>]</span><span class="hljs-number">0x8403</span>, syscall=null<br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;get<span class="hljs-constructor">EnvironmentInfo()</span>Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AbstractJni</span>.</span></span>call<span class="hljs-constructor">ObjectMethodV(AbstractJni.<span class="hljs-params">java</span>:417)</span><br>	at com.github.unidbg.linux.android.dvm.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AbstractJni</span>.</span></span>call<span class="hljs-constructor">ObjectMethodV(AbstractJni.<span class="hljs-params">java</span>:262)</span><br></code></pre></td></tr></table></figure>

<p>这个方法就是我们上一个补的 getEnvironmentInfo，你可能希望像下面这样处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;<br>    <span class="hljs-keyword">switch</span> (signature)&#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getEnvironmentInfo()Ljava/lang/String;&quot;</span>:&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, getEnvironmentInfo());<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>但这是行不通的，<strong>Native 方法里调用另一个 Native 方法，这属于嵌套调用，Unidbg 暂不支持这么做，所以这里手动填入先前得到的结果。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;<br>    <span class="hljs-keyword">switch</span> (signature)&#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getEnvironmentInfo()Ljava/lang/String;&quot;</span>: &#123;<br>            <span class="hljs-comment">// 把之前运行getEnvironmentInfo得到的结果封装给unidbg</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;0|0|0|-|0|&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">JNIEnv-&gt;GetMethodID(java<span class="hljs-regexp">/lang/</span>StringBuilder.<span class="hljs-keyword">append</span>(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>StringBuilder;) =&gt; <span class="hljs-number">0</span>x7b1bffd9 was called <span class="hljs-keyword">from</span> RX@<span class="hljs-number">0</span>x12006369[libmtguard.so]<span class="hljs-number">0</span>x6369<br>[<span class="hljs-number">14</span>:<span class="hljs-number">36</span>:<span class="hljs-number">50</span> <span class="hljs-number">617</span>]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x120, PC=unidbg@<span class="hljs-number">0</span>xfffe0294, LR=RX@<span class="hljs-number">0</span>x120085d9[libmtguard.so]<span class="hljs-number">0</span>x85d9, syscall=<span class="hljs-keyword">null</span><br>java.lang.UnsupportedOperationException: java<span class="hljs-regexp">/lang/</span>StringBuilder-&gt;<span class="hljs-keyword">append</span>(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>StringBuilder;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:<span class="hljs-number">417</span>)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:<span class="hljs-number">94</span>)<br></code></pre></td></tr></table></figure>

<p>修补代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/StringBuilder-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取对象</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> (StringBuilder)dvmObject.getValue();<br>    <span class="hljs-comment">// 获取参数</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg1</span> <span class="hljs-operator">=</span> vaList.getObjectArg(<span class="hljs-number">0</span>).getValue().toString();<br>    <span class="hljs-comment">//执行append</span><br>    builder.append(arg1);<br>    <span class="hljs-comment">// 封装给unidbg</span><br>    <span class="hljs-keyword">return</span> ProxyDvmObject.createObject(vm, builder);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">JNIEnv-&gt;<span class="hljs-constructor">GetMethodID(<span class="hljs-params">com</span><span class="hljs-operator">/</span><span class="hljs-params">meituan</span><span class="hljs-operator">/</span><span class="hljs-params">android</span><span class="hljs-operator">/</span><span class="hljs-params">common</span><span class="hljs-operator">/</span><span class="hljs-params">mtguard</span><span class="hljs-operator">/</span>NBridge<span class="hljs-params">$SIUACollector</span>.<span class="hljs-params">isVPN</span>()</span>Ljava/lang/String;) =&gt; <span class="hljs-number">0xdd0ce7bd</span> was called from RX@<span class="hljs-number">0x12006369</span><span class="hljs-literal">[<span class="hljs-identifier">libmtguard</span>.<span class="hljs-identifier">so</span>]</span><span class="hljs-number">0x6369</span><br><span class="hljs-literal">[<span class="hljs-number">14</span>:<span class="hljs-number">39</span>:<span class="hljs-number">40</span> <span class="hljs-number">524</span>]</span>  WARN <span class="hljs-literal">[<span class="hljs-identifier">com</span>.<span class="hljs-identifier">github</span>.<span class="hljs-identifier">unidbg</span>.<span class="hljs-identifier">linux</span>.ARM32S<span class="hljs-identifier">yscallHandler</span>]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0x120</span>, PC=unidbg@<span class="hljs-number">0xfffe0294</span>, LR=RX@<span class="hljs-number">0x120079dd</span><span class="hljs-literal">[<span class="hljs-identifier">libmtguard</span>.<span class="hljs-identifier">so</span>]</span><span class="hljs-number">0x79dd</span>, syscall=null<br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;is<span class="hljs-constructor">VPN()</span>Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AbstractJni</span>.</span></span>call<span class="hljs-constructor">ObjectMethodV(AbstractJni.<span class="hljs-params">java</span>:417)</span><br>	at com.meituan.android.common.mtguard.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NBridge</span>.</span></span>call<span class="hljs-constructor">ObjectMethodV(NBridge.<span class="hljs-params">java</span>:104)</span><br></code></pre></td></tr></table></figure>

<p>这是样本里的函数，要么代码copy过来并调用，要么静态分析看出具体值（显然很麻烦），要么frida hook 具体值。</p>
<p>这里直接frida hook 该函数并主动调用获取具体值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-title class_">SIUACollector</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;</span>);<br>            <span class="hljs-title class_">SIUACollector</span>[<span class="hljs-string">&quot;isVPN&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.isVPN is called`</span>);<br>                <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;isVPN&quot;</span>]();<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.isVPN result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;;<br>            <span class="hljs-comment">//主动调用</span><br>            <span class="hljs-keyword">var</span> currentApplication = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;android.app.ActivityThread&#x27;</span>).<span class="hljs-title function_">currentApplication</span>();<br>            <span class="hljs-keyword">var</span> context = currentApplication.<span class="hljs-title function_">getApplicationContext</span>();<br>            <span class="hljs-title class_">SIUACollector</span>.$new(context)[<span class="hljs-string">&quot;isVPN&quot;</span>]();<br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果如下</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">SIUACollector.isVPN <span class="hljs-keyword">is</span> called<br>SIUACollector.isVPN <span class="hljs-literal">result</span>=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>在<code>callObjectMethodV</code>方法下添加如下分支</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isVPN()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">JNIEnv-&gt;<span class="hljs-built_in">GetFieldID</span>(com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span><span class="hljs-selector-class">.mContext</span> Landroid/<span class="hljs-attribute">content</span>/Context;) =&gt; <span class="hljs-number">0</span>xc458fdce was called from RX@<span class="hljs-number">0</span>x1200668b<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x668b<br><span class="hljs-selector-attr">[14:44:50 042]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x15b, PC=unidbg@<span class="hljs-number">0</span>xfffe0644, LR=RX@<span class="hljs-number">0</span>x120090c9<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x90c9, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;mContext:Landroid/<span class="hljs-attribute">content</span>/Context;<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.getObjectField</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">171</span>)<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.getObjectField</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">141</span>)<br></code></pre></td></tr></table></figure>

<p>先占位，后续报错再通过Frida Hook出具体值来解决</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> DvmObject&lt;?&gt; getObjectField(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature) &#123;<br>    <span class="hljs-keyword">switch</span> (signature) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;mContext:Landroid/content/Context;&quot;</span>: &#123;<br>            <span class="hljs-comment">// 先占位，后续报错再解决</span><br>            <span class="hljs-keyword">return</span> vm.resolveClass(<span class="hljs-string">&quot;android/content/Context&quot;</span>).newObject(<span class="hljs-literal">null</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getObjectField(vm, dvmObject, signature);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">JNIEnv-&gt;GetMethodID(com<span class="hljs-regexp">/meituan/</span>android<span class="hljs-regexp">/common/m</span>tguard<span class="hljs-regexp">/NBridge$SIUACollector.brightness(Landroid/</span>content<span class="hljs-regexp">/Context;)Ljava/</span>lang/String;) =&gt; <span class="hljs-number">0</span>x2437a7e4 was called <span class="hljs-keyword">from</span> RX@<span class="hljs-number">0</span>x12006369[libmtguard.so]<span class="hljs-number">0</span>x6369<br>[<span class="hljs-number">14</span>:<span class="hljs-number">48</span>:<span class="hljs-number">49</span> <span class="hljs-number">208</span>]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x120, PC=unidbg@<span class="hljs-number">0</span>xfffe0294, LR=RX@<span class="hljs-number">0</span>x12009cbb[libmtguard.so]<span class="hljs-number">0</span>x9cbb, syscall=<span class="hljs-keyword">null</span><br>java.lang.UnsupportedOperationException: com<span class="hljs-regexp">/meituan/</span>android<span class="hljs-regexp">/common/m</span>tguard<span class="hljs-regexp">/NBridge$SIUACollector-&gt;brightness(Landroid/</span>content<span class="hljs-regexp">/Context;)Ljava/</span>lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:<span class="hljs-number">417</span>)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:<span class="hljs-number">108</span>)<br></code></pre></td></tr></table></figure>

<p>看函数名应该是个关于屏幕亮度的函数，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">brightness</span><span class="hljs-params">(Context context)</span> &#123;<br>    Object[] objArr = &#123;context&#125;;<br>    <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>    <span class="hljs-keyword">return</span> PatchProxy.isSupport(objArr, <span class="hljs-built_in">this</span>, changeQuickRedirect2, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;e3c10305f195ff2aac2fd606a6235fb2&quot;</span>, RobustBitConfig.DEFAULT_VALUE) ? (String) PatchProxy.accessDispatch(objArr, <span class="hljs-built_in">this</span>, changeQuickRedirect2, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;e3c10305f195ff2aac2fd606a6235fb2&quot;</span>) : DeviceInfoWorker.brightness(context);<br>&#125;<br><span class="hljs-comment">//具体实现代码</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">brightness</span><span class="hljs-params">(Context context)</span> &#123;<br>    Object[] objArr = &#123;context&#125;;<br>    <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>    <span class="hljs-keyword">if</span> (PatchProxy.isSupport(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;af80a1c664fdf95866b7caabf24ab495&quot;</span>, RobustBitConfig.DEFAULT_VALUE)) &#123;<br>        <span class="hljs-keyword">return</span> (String) PatchProxy.accessDispatch(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;af80a1c664fdf95866b7caabf24ab495&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> StringUtils.toString(Settings.System.getInt(context.getContentResolver(), <span class="hljs-string">&quot;screen_brightness&quot;</span>) / <span class="hljs-number">255.0f</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable th) &#123;<br>        c.a(th);<br>        <span class="hljs-keyword">return</span> StringUtils.toString(<span class="hljs-number">0.0f</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Google 搜索<code>getContentResolver</code>+<code>screen_brightness</code>，找到如下代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取系统默认屏幕亮度值 屏幕亮度值范围（0-255）</span><br><span class="hljs-comment"> * **/</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getScreenBrightness</span><span class="hljs-params">(Context context)</span> &#123;<br>    <span class="hljs-type">ContentResolver</span> <span class="hljs-variable">contentResolver</span> <span class="hljs-operator">=</span> context.getContentResolver();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">defVal</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> Settings.System.getInt(contentResolver,<br>            Settings.System.SCREEN_BRIGHTNESS, defVal);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也就是说，最终获取的值是是 0-1 之间的一个数，然后转字符串，我这里选择 0.8。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;brightness(Landroid/content/Context;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;0.8&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">JNIEnv-&gt;GetMethodID(com<span class="hljs-regexp">/meituan/</span>android<span class="hljs-regexp">/common/m</span>tguard<span class="hljs-regexp">/NBridge$SIUACollector.systemVolume(Landroid/</span>content<span class="hljs-regexp">/Context;)Ljava/</span>lang/String;) =&gt; <span class="hljs-number">0</span>x80b60b0c was called <span class="hljs-keyword">from</span> RX@<span class="hljs-number">0</span>x12006369[libmtguard.so]<span class="hljs-number">0</span>x6369<br>[<span class="hljs-number">14</span>:<span class="hljs-number">51</span>:<span class="hljs-number">10</span> <span class="hljs-number">180</span>]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x120, PC=unidbg@<span class="hljs-number">0</span>xfffe0294, LR=RX@<span class="hljs-number">0</span>x1200980b[libmtguard.so]<span class="hljs-number">0</span>x980b, syscall=<span class="hljs-keyword">null</span><br>java.lang.UnsupportedOperationException: com<span class="hljs-regexp">/meituan/</span>android<span class="hljs-regexp">/common/m</span>tguard<span class="hljs-regexp">/NBridge$SIUACollector-&gt;systemVolume(Landroid/</span>content<span class="hljs-regexp">/Context;)Ljava/</span>lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:<span class="hljs-number">417</span>)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:<span class="hljs-number">111</span>)<br></code></pre></td></tr></table></figure>

<p><code>systemVolume</code>具体实现代码如下，明显是获取音量的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">systemVolume</span><span class="hljs-params">(Context context)</span> &#123;<br>        Object[] objArr = &#123;context&#125;;<br>        <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>        <span class="hljs-keyword">if</span> (PatchProxy.isSupport(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;94db8653238995da6df94fea33fbbf79&quot;</span>, RobustBitConfig.DEFAULT_VALUE)) &#123;<br>            <span class="hljs-keyword">return</span> (String) PatchProxy.accessDispatch(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;94db8653238995da6df94fea33fbbf79&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">AudioManager</span> <span class="hljs-variable">audioManager</span> <span class="hljs-operator">=</span> (AudioManager) context.getSystemService(<span class="hljs-string">&quot;audio&quot;</span>);<br>            <span class="hljs-keyword">return</span> StringUtils.toString((audioManager.getStreamVolume(<span class="hljs-number">1</span>) * <span class="hljs-number">100</span>) / audioManager.getStreamMaxVolume(<span class="hljs-number">1</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable th) &#123;<br>            c.a(th);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>搜索<code>getStreamVolume</code>和<code>getStreamMaxVolume</code>可以获知相关信息，我这里直接返回0，表示静音</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;systemVolume(Landroid/content/Context;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">JNIEnv-&gt;<span class="hljs-built_in">GetMethodID</span>(com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span><span class="hljs-selector-class">.isAccessibilityEnable</span>()Z) =&gt; <span class="hljs-number">0</span>xf45f6eaa was called from RX@<span class="hljs-number">0</span>x12006369<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x6369<br><span class="hljs-selector-attr">[14:53:26 404]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x123, PC=unidbg@<span class="hljs-number">0</span>xfffe02c4, LR=RX@<span class="hljs-number">0</span>x12007a8f<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x7a8f, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;<span class="hljs-built_in">isAccessibilityEnable</span>()Z<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callBooleanMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">625</span>)<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callBooleanMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">603</span>)<br></code></pre></td></tr></table></figure>

<p><code>isAccessibilityEnable</code>是无障碍服务。无障碍服务的本意是帮助残障人士、老人小孩等等，但长久以来被用于自动化控制，比如抢单，因此检测无障碍服务是风险检测、环境检测、反欺诈检测的重要一环。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">callBooleanMethodV</span><span class="hljs-params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (signature) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isAccessibilityEnable()Z&quot;</span>: &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.callBooleanMethodV(vm, dvmObject, signature, vaList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">JNIEnv-&gt;GetStaticMethodID(java/lang/String.valueOf(I)Ljava/lang/String;) =&gt; 0x382c5880 was called <span class="hljs-keyword">from</span> RX@0x12006369[libmtguard.so]0x6369<br>[14:56:03 539]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x171, <span class="hljs-attribute">PC</span>=unidbg@0xfffe07a4, <span class="hljs-attribute">LR</span>=RX@0x1200a2a9[libmtguard.so]0xa2a9, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/String-&gt;valueOf(I)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticObjectMethodV(AbstractJni.java:504)<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticObjectMethodV(AbstractJni.java:438)<br></code></pre></td></tr></table></figure>

<p>完善<code>valueOf</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;<br>    <span class="hljs-keyword">switch</span> (signature)&#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/String-&gt;valueOf(I)Ljava/lang/String;&quot;</span>: &#123;<br>            <span class="hljs-comment">// 获取参数</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> vaList.getIntArg(<span class="hljs-number">0</span>);<br>            <span class="hljs-comment">//调用 string.valueOf</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> String.valueOf(arg);<br>            <span class="hljs-comment">//封装</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, result);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.callStaticObjectMethodV(vm, dvmClass, signature, vaList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[14:58:45 968]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x12f, PC=unidbg@<span class="hljs-number">0</span>xfffe0384, LR=RX@<span class="hljs-number">0</span>x12007c73<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x7c73, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;<span class="hljs-built_in">uiAutomatorClickCount</span>()I<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callIntMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">563</span>)<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callIntMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">529</span>)<br></code></pre></td></tr></table></figure>

<p>Frida hook 该函数并主动调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">function <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123;<br>    Java.perform(<br>        function()&#123;<br>            <span class="hljs-type">let</span> <span class="hljs-variable">SIUACollector</span> <span class="hljs-operator">=</span> Java.use(<span class="hljs-string">&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;</span>);<br>            SIUACollector[<span class="hljs-string">&quot;uiAutomatorClickCount&quot;</span>].implementation = function () &#123;<br>                console.log(`SIUACollector.uiAutomatorClickCount is called`);<br>                <span class="hljs-type">let</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>[<span class="hljs-string">&quot;uiAutomatorClickCount&quot;</span>]();<br>                console.log(`SIUACollector.uiAutomatorClickCount result=$&#123;result&#125;`);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;;<br>            <span class="hljs-comment">//主动调用</span><br>            <span class="hljs-type">var</span> <span class="hljs-variable">currentApplication</span> <span class="hljs-operator">=</span> Java.use(<span class="hljs-string">&#x27;android.app.ActivityThread&#x27;</span>).currentApplication();<br>            <span class="hljs-type">var</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> currentApplication.getApplicationContext();<br>            SIUACollector.$<span class="hljs-keyword">new</span>(context)[<span class="hljs-string">&quot;uiAutomatorClickCount&quot;</span>]();<br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>hook 结果如下</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">SIUACollector.uiAutomatorClickCount <span class="hljs-keyword">is</span> called<br>SIUACollector.uiAutomatorClickCount <span class="hljs-literal">result</span>=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>那么补环境时直接返回0即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">callIntMethodV</span><span class="hljs-params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (signature) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;uiAutomatorClickCount()I&quot;</span>: &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.callIntMethodV(vm, dvmObject, signature, vaList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[15:02:38 832]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x120096f3[libmtguard.so]0x96f3, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;toString()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:114)<br></code></pre></td></tr></table></figure>

<p>这个比较简单，完善<code>toString</code>方法即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/StringBuilder-&gt;toString()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-comment">// 获取StringBuilder对象</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> (StringBuilder) dvmObject.getValue();<br>    <span class="hljs-comment">// 执行 toString</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> builder.toString();<br>    <span class="hljs-comment">// 封装</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, str);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行成功，结果如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">getEnvironmentInfoExtra</span> call result:<span class="hljs-number">0</span>|<span class="hljs-number">0</span>|<span class="hljs-number">0</span>|-|<span class="hljs-number">0</span>|<span class="hljs-number">0</span>|<span class="hljs-number">0</span>.<span class="hljs-number">8</span>|<span class="hljs-number">0</span>|<span class="hljs-number">0</span>|<span class="hljs-number">0</span>|<br></code></pre></td></tr></table></figure>



<h1 id="六、getExternalEquipmentInfo"><a href="#六、getExternalEquipmentInfo" class="headerlink" title="六、getExternalEquipmentInfo"></a>六、getExternalEquipmentInfo</h1><p>调用代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getExternalEquipmentInfo</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">exEqInfo</span> <span class="hljs-operator">=</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getExternalEquipmentInfo()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>    <span class="hljs-keyword">return</span> exEqInfo;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[15:07:29 158]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x120, PC=unidbg@<span class="hljs-number">0</span>xfffe0294, LR=RX@<span class="hljs-number">0</span>x1203ddd7<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x3ddd7, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/<span class="hljs-attribute">content</span>/Context-&gt;<span class="hljs-built_in">getApplicationContext</span>()Landroid/content/Context;<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callObjectMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">417</span>)<br>	at com<span class="hljs-selector-class">.meituan</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.mtguard</span><span class="hljs-selector-class">.NBridge</span><span class="hljs-selector-class">.callObjectMethodV</span>(NBridge<span class="hljs-selector-class">.java</span>:<span class="hljs-number">129</span>)<br></code></pre></td></tr></table></figure>

<p>跟上一小节的报错一样，仍然是简单的占位即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/content/Context-&gt;getApplicationContext()Landroid/content/Context;&quot;</span> &#123;<br>    <span class="hljs-comment">// 先占位，后续报错再frida hook 具体值解决</span><br>    <span class="hljs-keyword">return</span> vm.resolveClass(<span class="hljs-string">&quot;android/content/Context&quot;</span>).newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[15:10:05 165]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x120396b5[libmtguard.so]0x396b5, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/content/Context-&gt;getSystemService(Ljava/lang/String;)Ljava/lang/Object;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:133)<br></code></pre></td></tr></table></figure>

<p>系统服务是 Android 所提供的一项重要服务，在 JNI 补环境中出现频率相当高， Unidbg 对它做了专门处理，可以参考 AbstractJni，其中有如下代码片段。</p>
<p><img src="https://raw.githubusercontent.com/gal2xy/blog_img/main/img/202412051703244.png" srcset="/img/loading.gif" lazyload></p>
<p>抄一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/content/Context-&gt;getSystemService(Ljava/lang/String;)Ljava/lang/Object;&quot;</span>: &#123;<br>    <span class="hljs-type">StringObject</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> vaList.getObjectArg(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">assert</span> serviceName != <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemService</span>(vm, serviceName.getValue());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行还是报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[15:16:59 472]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x123, <span class="hljs-attribute">PC</span>=unidbg@0xfffe02c4, <span class="hljs-attribute">LR</span>=RX@0x1203994d[libmtguard.so]0x3994d, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;isPermissionGranted(Ljava/lang/String;Landroid/content/Context;)Z<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)<br>	at com.meituan.android.common.mtguard.NBridge.callBooleanMethodV(NBridge.java:148)<br></code></pre></td></tr></table></figure>

<p><code>isPermissionGranted</code>显然是检查App是否具有某项权限，我这里直接返回true，要是想分类讨论，可以先打印权限名称然后决定是否给予权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isPermissionGranted(Ljava/lang/String;Landroid/content/Context;)Z&quot;</span>: &#123;<br>    <span class="hljs-comment">//String permissionName = vaList.getObjectArg(0).getValue().toString();</span><br>    <span class="hljs-comment">//System.out.println(&quot;check permission:&quot;+permissionName);</span><br>    <span class="hljs-comment">// 权限都给</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[15:19:04 185]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x192, PC=unidbg@<span class="hljs-number">0</span>xfffe09b4, LR=RX@<span class="hljs-number">0</span>x1203c723<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x3c723, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/os/Build<span class="hljs-variable">$VERSION</span>-&gt;SDK_INT:I<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.getStaticIntField</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">136</span>)<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.getStaticIntField</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">128</span>)<br></code></pre></td></tr></table></figure>

<p><code>SDK_INT</code>顾名思义是sdk版本，这里返回unidbg使用的sdk版本（其他的也行）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getStaticIntField</span><span class="hljs-params">(BaseVM vm, DvmClass dvmClass, String signature)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (signature) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build$VERSION-&gt;SDK_INT:I&quot;</span>: &#123;<br>            <span class="hljs-comment">//返回sdk版本</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">23</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getStaticIntField(vm, dvmClass, signature);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行，继续报错（由于选的是sdk23，会出现如下错误）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[15:21:18 191]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12035f07[libmtguard.so]0x35f07, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/telephony/TelephonyManager-&gt;getDeviceId()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:138)<br></code></pre></td></tr></table></figure>

<p>frida hook 具体值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">function <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123;<br>    Java.perform(<br>        function()&#123;<br>            <span class="hljs-comment">// 获取 TelephonyManager 类</span><br>            <span class="hljs-type">var</span> <span class="hljs-variable">TelephonyManager</span> <span class="hljs-operator">=</span> Java.use(<span class="hljs-string">&quot;android.telephony.TelephonyManager&quot;</span>);<br>        <br>            <span class="hljs-comment">// 获取系统上下文</span><br>            <span class="hljs-type">var</span> <span class="hljs-variable">currentApplication</span> <span class="hljs-operator">=</span> Java.use(<span class="hljs-string">&#x27;android.app.ActivityThread&#x27;</span>).currentApplication();<br>            <span class="hljs-type">var</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> currentApplication.getApplicationContext();<br>            <br>            <span class="hljs-comment">// 获取 TelephonyManager 的实例</span><br>            <span class="hljs-type">var</span> <span class="hljs-variable">telephonyManager</span> <span class="hljs-operator">=</span> context.getSystemService(<span class="hljs-string">&quot;phone&quot;</span>);<br>            <span class="hljs-type">var</span> <span class="hljs-variable">TelephonyManager</span> <span class="hljs-operator">=</span> Java.use(<span class="hljs-string">&quot;android.telephony.TelephonyManager&quot;</span>);<br>            telephonyManager = Java.cast(telephonyManager, TelephonyManager);<span class="hljs-comment">//强转类型，否则无法调用getDeviceId</span><br>            <span class="hljs-comment">// 主动调用 getDeviceId()</span><br>            <span class="hljs-type">var</span> <span class="hljs-variable">deviceId</span> <span class="hljs-operator">=</span> telephonyManager.getDeviceId();<br>            <br>            console.log(<span class="hljs-string">&quot;Active Device ID: &quot;</span> + deviceId);<br><br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果如下！？（也许哪里出错了）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Active Device ID:</span> <span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure>

<p>由于返回值是String，所以将null封装成StringObject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/telephony/TelephonyManager-&gt;getDeviceId()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-comment">//frida hook 获取对应值</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[15:23:02 435]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1203c617[libmtguard.so]0x3c617, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;checkBuildAttribute(Ljava/lang/String;)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:142)<br></code></pre></td></tr></table></figure>

<p><code>checkBuildAttribute</code>代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">checkBuildAttribute</span><span class="hljs-params">(String str)</span> &#123;<br>    Object[] objArr = &#123;str&#125;;<br>    <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>    <span class="hljs-keyword">return</span> PatchProxy.isSupport(objArr, <span class="hljs-built_in">this</span>, changeQuickRedirect2, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;3b097946787cf593049f918e4d2f8a4e&quot;</span>, RobustBitConfig.DEFAULT_VALUE) ? (String) PatchProxy.accessDispatch(objArr, <span class="hljs-built_in">this</span>, changeQuickRedirect2, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;3b097946787cf593049f918e4d2f8a4e&quot;</span>) : (TextUtils.isEmpty(str) || str.equalsIgnoreCase(<span class="hljs-string">&quot;unknown&quot;</span>)) ? CommonConstant.Symbol.MINUS : str;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>逻辑很简单，就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">(TextUtils.isEmpty(str) || str.equalsIgnoreCase(<span class="hljs-string">&quot;unknown&quot;</span>)) ? CommonConstant.Symbol.MINUS : str;<br></code></pre></td></tr></table></figure>

<p><code>CommonConstant.Symbol.MINUS</code>的值是”-“，所以补环境代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span>  <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;checkBuildAttribute(Ljava/lang/String;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (String) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    <span class="hljs-keyword">if</span> (arg.isEmpty() || arg.equalsIgnoreCase(<span class="hljs-string">&quot;unknown&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;-&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, arg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[11:40:36 615]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1203ce83[libmtguard.so]0x3ce83, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/view/WindowManager-&gt;getDefaultDisplay()Landroid/view/Display;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:152)<br></code></pre></td></tr></table></figure>

<p>这是一个 Android 对象，按照前面所说的补环境原则直接处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/view/WindowManager-&gt;getDefaultDisplay()Landroid/view/Display;&quot;</span>: &#123;<br>    <span class="hljs-comment">//占位</span><br>    <span class="hljs-keyword">return</span> vm.resolveClass(<span class="hljs-string">&quot;android/view/Display&quot;</span>).newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[11:42:08 615]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x12f, PC=unidbg@<span class="hljs-number">0</span>xfffe0384, LR=RX@<span class="hljs-number">0</span>x1203a291<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x3a291, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/view/Display-&gt;<span class="hljs-built_in">getHeight</span>()I<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callIntMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">563</span>)<br>	at com<span class="hljs-selector-class">.meituan</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.mtguard</span><span class="hljs-selector-class">.NBridge</span><span class="hljs-selector-class">.callIntMethodV</span>(NBridge<span class="hljs-selector-class">.java</span>:<span class="hljs-number">194</span>)<br></code></pre></td></tr></table></figure>

<p>又是 Android FrameWork 层的 API ，Google 搜索发现它和getWidth一起用于获取屏幕的宽高。对于这类基本设备信息，完全可以通过 ADB 获取。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">adb shell wm size</span><br>Physical size: 1440x2560<br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/view/Display-&gt;getHeight()I&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2560</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[11:47:20 967]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1203f1e1[libmtguard.so]0x3f1e1, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;append(I)Ljava/lang/StringBuilder;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:156)<br></code></pre></td></tr></table></figure>

<p>遇见过相同的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/StringBuilder-&gt;append(I)Ljava/lang/StringBuilder;&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) vaList.getIntArg(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//获取对象</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> (StringBuilder) dvmObject.getValue();<br>    <span class="hljs-comment">//执行append</span><br>    builder.append(arg);<br>    <span class="hljs-comment">//封装</span><br>    <span class="hljs-keyword">return</span> ProxyDvmObject.createObject(vm, builder);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[11:51:06 660]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1203bd31[libmtguard.so]0x3bd31, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;append(C)Ljava/lang/StringBuilder;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:166)<br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/StringBuilder-&gt;append(C)Ljava/lang/StringBuilder;&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">char</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (<span class="hljs-type">char</span>) vaList.getIntArg(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//获取对象</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> (StringBuilder) dvmObject.getValue();<br>    <span class="hljs-comment">//执行append</span><br>    builder.append(arg);<br>    <span class="hljs-comment">//封装</span><br>    <span class="hljs-keyword">return</span> ProxyDvmObject.createObject(vm, builder);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[11:53:27 955]</span>  WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x12f, PC=unidbg@<span class="hljs-number">0</span>xfffe0384, LR=RX@<span class="hljs-number">0</span>x1203e717<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x3e717, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/view/Display-&gt;<span class="hljs-built_in">getWidth</span>()I<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callIntMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">563</span>)<br>	at com<span class="hljs-selector-class">.meituan</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.mtguard</span><span class="hljs-selector-class">.NBridge</span><span class="hljs-selector-class">.callIntMethodV</span>(NBridge<span class="hljs-selector-class">.java</span>:<span class="hljs-number">217</span>)<br></code></pre></td></tr></table></figure>

<p>之前补的是高，现在是宽。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/view/Display-&gt;getWidth()I&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1440</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[11:55:06 439]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1203a117[libmtguard.so]0x3a117, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getTotalInternalMemorySize()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:176)<br></code></pre></td></tr></table></figure>

<p>Frida Hook该函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-title class_">SIUACollector</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;</span>);<br>            <span class="hljs-title class_">SIUACollector</span>[<span class="hljs-string">&quot;getTotalInternalMemorySize&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.getTotalInternalMemorySize is called`</span>);<br>                <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;getTotalInternalMemorySize&quot;</span>]();<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.getTotalInternalMemorySize result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;;<br>            <span class="hljs-comment">// 获取系统上下文</span><br>            <span class="hljs-keyword">var</span> currentApplication = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;android.app.ActivityThread&#x27;</span>).<span class="hljs-title function_">currentApplication</span>();<br>            <span class="hljs-keyword">var</span> context = currentApplication.<span class="hljs-title function_">getApplicationContext</span>();<br>            <span class="hljs-comment">//主动调用</span><br>            <span class="hljs-title class_">SIUACollector</span>.$new(context).<span class="hljs-title function_">getTotalInternalMemorySize</span>();<br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>得到结果如下</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">SIUACollector.getTotalInternalMemorySize <span class="hljs-keyword">is</span> called<br>SIUACollector.getTotalInternalMemorySize <span class="hljs-literal">result</span>=<span class="hljs-number">24</span>GB<br></code></pre></td></tr></table></figure>

<p>补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getTotalInternalMemorySize()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;24GB&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[12:04:11 864]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12036db3[libmtguard.so]0x36db3, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getTotalExternalMemorySize()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:182)<br></code></pre></td></tr></table></figure>

<p>Frida Hook该函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-title class_">SIUACollector</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;</span>);<br>            <span class="hljs-title class_">SIUACollector</span>[<span class="hljs-string">&quot;getTotalExternalMemorySize&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.getTotalExternalMemorySize is called`</span>);<br>                <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;getTotalExternalMemorySize&quot;</span>]();<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.getTotalExternalMemorySize result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;;<br>            <span class="hljs-comment">// 获取系统上下文</span><br>            <span class="hljs-keyword">var</span> currentApplication = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;android.app.ActivityThread&#x27;</span>).<span class="hljs-title function_">currentApplication</span>();<br>            <span class="hljs-keyword">var</span> context = currentApplication.<span class="hljs-title function_">getApplicationContext</span>();<br>            <span class="hljs-comment">//主动调用</span><br>            <span class="hljs-title class_">SIUACollector</span>.$new(context).<span class="hljs-title function_">getTotalExternalMemorySize</span>();<br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>得到结果如下</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">SIUACollector.getTotalExternalMemorySize <span class="hljs-keyword">is</span> called<br>SIUACollector.getTotalExternalMemorySize <span class="hljs-literal">result</span>=<span class="hljs-number">24</span>GB<br></code></pre></td></tr></table></figure>

<p>补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getTotalInternalMemorySize()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;24GB&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x16f, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0784, <span class="hljs-attribute">LR</span>=RX@0x12036961[libmtguard.so]0x36961, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/text/TextUtils-&gt;isEmpty(Ljava/lang/CharSequence;)Z<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticBooleanMethodV(AbstractJni.java:191)<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticBooleanMethodV(AbstractJni.java:186)<br></code></pre></td></tr></table></figure>

<p>这是 Android FrameWork 中处理字符串的工具类，这种工具函数往往不会很复杂，在 AOSP 中找一下它的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">(CharSequence str)</span> &#123;<br>    <span class="hljs-keyword">return</span> str == <span class="hljs-literal">null</span> || str.length() == <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>复写一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">callStaticBooleanMethodV</span><span class="hljs-params">(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (signature) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/text/TextUtils-&gt;isEmpty(Ljava/lang/CharSequence;)Z&quot;</span>: &#123;<br>            <span class="hljs-type">CharSequence</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> (CharSequence) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>            <span class="hljs-keyword">return</span> str == <span class="hljs-literal">null</span> || str.length() == <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.callStaticBooleanMethodV(vm, dvmClass, signature, vaList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12039247[libmtguard.so]0x39247, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/telephony/TelephonyManager-&gt;getSimOperator()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:180)<br></code></pre></td></tr></table></figure>

<p>又是 Android FrameWork 里的函数，搜索<code>getSimOperator</code>发现是获取SIM卡的运营商信息。同样可以使用 ADB 获取到相关信息。这里使用Frida Hook 获取</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-comment">// 获取 TelephonyManager 类</span><br>            <span class="hljs-keyword">var</span> <span class="hljs-title class_">TelephonyManager</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;android.telephony.TelephonyManager&quot;</span>);<br>        <br>            <span class="hljs-comment">// 获取系统上下文</span><br>            <span class="hljs-keyword">var</span> currentApplication = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;android.app.ActivityThread&#x27;</span>).<span class="hljs-title function_">currentApplication</span>();<br>            <span class="hljs-keyword">var</span> context = currentApplication.<span class="hljs-title function_">getApplicationContext</span>();<br>            <br>            <span class="hljs-comment">// 获取 TelephonyManager 的实例</span><br>            <span class="hljs-keyword">var</span> telephonyManager = context.<span class="hljs-title function_">getSystemService</span>(<span class="hljs-string">&quot;phone&quot;</span>);<br>            <span class="hljs-keyword">var</span> <span class="hljs-title class_">TelephonyManager</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;android.telephony.TelephonyManager&quot;</span>);<br>            telephonyManager = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(telephonyManager, <span class="hljs-title class_">TelephonyManager</span>);<span class="hljs-comment">//强转类型，否则无法调用getDeviceId</span><br>            <span class="hljs-comment">// 主动调用 getSimOperator()</span><br>            <span class="hljs-keyword">var</span> simOp = telephonyManager.<span class="hljs-title function_">getSimOperator</span>();<br>            <br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;getSimOperator: &quot;</span> + simOp);<br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于我的测试机没有SIM卡，所以返回的结果是空的。</p>
<p>后面搜索发现 SimOperator 由 MCC + MNC 组成。</p>
<p><code>MCC</code>由国际电信联盟 ITU 在全世界范围内统一分配和管理，唯一识别移动用户所属的国家，共3位，中国为460。</p>
<p><code>MNC</code>用于识别移动用户所归属的移动通信网，2~3位。中国移动系统使用 00、02、04、07，中国联通系统使用 01、06、09，中国电信使用 03、05、11，中国铁通系统使用 20 。</p>
<p>于是随意组了一个数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/telephony/TelephonyManager-&gt;getSimOperator()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;46000&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1203a91b[libmtguard.so]0x3a91b, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getAccessSubType()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:183)<br></code></pre></td></tr></table></figure>

<p><code>getAccessSubType</code>代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">getAccessSubType</span><span class="hljs-params">()</span> &#123;<br>    Object[] objArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>    <span class="hljs-keyword">if</span> (PatchProxy.isSupport(objArr, <span class="hljs-built_in">this</span>, changeQuickRedirect2, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;4e473c1fae47c0bf65e6f819cd3eaf7c&quot;</span>, RobustBitConfig.DEFAULT_VALUE)) &#123;<br>        <span class="hljs-keyword">return</span> (String) PatchProxy.accessDispatch(objArr, <span class="hljs-built_in">this</span>, changeQuickRedirect2, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;4e473c1fae47c0bf65e6f819cd3eaf7c&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mContext;<br>    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> StringUtil.NULL;<span class="hljs-comment">//&quot;null&quot;</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (isPermissionGranted(<span class="hljs-string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>, context)) &#123;<br>        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">connectivityManager</span> <span class="hljs-operator">=</span> (ConnectivityManager) <span class="hljs-built_in">this</span>.mContext.getApplicationContext().getSystemService(<span class="hljs-string">&quot;connectivity&quot;</span>);<br>        <span class="hljs-type">NetworkInfo</span> <span class="hljs-variable">activeNetworkInfo</span> <span class="hljs-operator">=</span> connectivityManager != <span class="hljs-literal">null</span> ? connectivityManager.getActiveNetworkInfo() : <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (activeNetworkInfo == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> StringUtil.NULL;<span class="hljs-comment">//&quot;null&quot;</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> (activeNetworkInfo.getType() == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;wifi&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (activeNetworkInfo.getType() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">subtype</span> <span class="hljs-operator">=</span> activeNetworkInfo.getSubtype();<br>            <span class="hljs-keyword">return</span> (subtype == <span class="hljs-number">4</span> || subtype == <span class="hljs-number">1</span> || subtype == <span class="hljs-number">2</span>) ? <span class="hljs-string">&quot;2G&quot;</span> : (subtype == <span class="hljs-number">3</span> || subtype == <span class="hljs-number">8</span> || subtype == <span class="hljs-number">6</span> || subtype == <span class="hljs-number">5</span> || subtype == <span class="hljs-number">12</span>) ? <span class="hljs-string">&quot;3G&quot;</span> : subtype == <span class="hljs-number">13</span> ? <span class="hljs-string">&quot;4G&quot;</span> : <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> CommonConstant.Symbol.MINUS;<span class="hljs-comment">//&quot;-&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>看起来是获取网络类型，具体有”wifi”、”2G”、”3G”、”4G”，随便选一个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getAccessSubType()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;wifi&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终运行成功</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">getExternalEquipmentInfo call result: -|<span class="hljs-string">-</span>|<span class="hljs-string">-</span>|<span class="hljs-string">2560*1440</span>|<span class="hljs-string">24GB</span>|<span class="hljs-string">24GB</span>|<span class="hljs-string">AQmac</span>|<span class="hljs-string">46000</span>|<span class="hljs-string">wifi</span>|<br></code></pre></td></tr></table></figure>

<h1 id="七、getHWEquipmentInfo"><a href="#七、getHWEquipmentInfo" class="headerlink" title="七、getHWEquipmentInfo"></a>七、getHWEquipmentInfo</h1><p>调用代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHWEquipmentInfo</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getHWEquipmentInfo()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12030eaf[libmtguard.so]0x30eaf, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getCpuInfoType()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:193)<br></code></pre></td></tr></table></figure>

<p>顾名思义，获取CPU的架构，通过源码也可知其返回值为”x86”、”arm”，这里选择”arm”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getCpuInfoType()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;arm&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x117, PC=unidbg@<span class="hljs-number">0</span>xfffe0204, LR=RX@<span class="hljs-number">0</span>x1202bcef<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x2bcef, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/io/BufferedReader-&gt;allocObject<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.allocObject</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">812</span>)<br>	at com<span class="hljs-selector-class">.meituan</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.mtguard</span><span class="hljs-selector-class">.NBridge</span><span class="hljs-selector-class">.allocObject</span>(NBridge<span class="hljs-selector-class">.java</span>:<span class="hljs-number">88</span>)<br></code></pre></td></tr></table></figure>

<p>同样的<code>allocObject</code>情况，但是当创建<code>BufferedReader</code>的时候，需要参数，即确定缓冲区大小，<strong>它所需要的初始化参数在<code>allocObject</code>阶段并没有展露出来，在后续真正初始化的时候才有值</strong>。这里直接用空的<code>dvmObject</code>占位。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/BufferedReader-&gt;allocObject&quot;</span>: &#123;<br>    <span class="hljs-comment">//这里的 dvmClass 等价于vm.resolveClass(&quot;java/io/BufferedReader&quot;)</span><br>    <span class="hljs-keyword">return</span> dvmClass.newObject(<span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">//return vm.resolveClass(&quot;java/io/BufferedReader&quot;).newObject(null);</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来是<code>InputStreamReader</code>的<code>allocObject</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x117, PC=unidbg@<span class="hljs-number">0</span>xfffe0204, LR=RX@<span class="hljs-number">0</span>x1202a687<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x2a687, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/io/InputStreamReader-&gt;allocObject<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.allocObject</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">812</span>)<br>	at com<span class="hljs-selector-class">.meituan</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.mtguard</span><span class="hljs-selector-class">.NBridge</span><span class="hljs-selector-class">.allocObject</span>(NBridge<span class="hljs-selector-class">.java</span>:<span class="hljs-number">94</span>)<br></code></pre></td></tr></table></figure>

<p>同样进行占位处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/InputStreamReader-&gt;allocObject&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> dvmClass.newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后是<code>FileInputStream</code>的<code>allocObject</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x117, PC=unidbg@<span class="hljs-number">0</span>xfffe0204, LR=RX@<span class="hljs-number">0</span>x1202c66f<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x2c66f, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/io/FileInputStream-&gt;allocObject<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.allocObject</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">812</span>)<br>	at com<span class="hljs-selector-class">.meituan</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.mtguard</span><span class="hljs-selector-class">.NBridge</span><span class="hljs-selector-class">.allocObject</span>(NBridge<span class="hljs-selector-class">.java</span>:<span class="hljs-number">96</span>)<br></code></pre></td></tr></table></figure>

<p>同样进行占位处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/FileInputStream-&gt;allocObject&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> dvmClass.newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x13b, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0444, <span class="hljs-attribute">LR</span>=RX@0x12030391[libmtguard.so]0x30391, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/io/FileInputStream-&gt;&lt;init&gt;(Ljava/lang/String;)V<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)<br>	at com.meituan.android.common.mtguard.NBridge.callVoidMethodV(NBridge.java:110)<br></code></pre></td></tr></table></figure>

<p>这是个重点！！！之前我们对于<code>FileInputStream</code>的<code>allocObject</code>仅仅只是做了占位处理，而且因为<code>callVoid</code>系列 API 没有返回值，它的操作基于原先的占位<code>dvmObject</code>，因为我们没法对它重新赋值，所以需要声明为一个全局变量处理它以及后面的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NBridge</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJni</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Memory memory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DvmObject&lt;?&gt; cSIUACollectorObj;<br>    <span class="hljs-keyword">public</span> FileInputStream fileInputStream;<br></code></pre></td></tr></table></figure>

<p>然后补具体逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span>  <span class="hljs-string">&quot;java/io/FileInputStream-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;</span>: &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> vaList.getObjectArg(<span class="hljs-number">0</span>).getValue().toString();<br>    System.out.println(<span class="hljs-string">&quot;FileInputStream-&gt;&lt;init&gt;: &quot;</span> + arg);<br>    <span class="hljs-keyword">try</span> &#123;<br>        fileInputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(arg);<br>    &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行后发现报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x13b, PC=unidbg@<span class="hljs-number">0</span>xfffe0444, LR=RX@<span class="hljs-number">0</span>x12030391<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x30391, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.RuntimeException</span>: java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.FileNotFoundException</span>: \proc\cpuinfo (系统找不到指定的路径。)<br>	at com<span class="hljs-selector-class">.meituan</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.mtguard</span><span class="hljs-selector-class">.NBridge</span><span class="hljs-selector-class">.callVoidMethodV</span>(NBridge<span class="hljs-selector-class">.java</span>:<span class="hljs-number">112</span>)<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callVoidMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">990</span>)<br></code></pre></td></tr></table></figure>

<p>程序在访问 &#x2F;proc&#x2F;cpuinfo 文件，那么我们将 &#x2F;proc&#x2F;cpuinfo 文件拖到本地项目中，然后做路径的重定位。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span>  <span class="hljs-string">&quot;java/io/FileInputStream-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;</span>: &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> vaList.getObjectArg(<span class="hljs-number">0</span>).getValue().toString();<br>    System.out.println(<span class="hljs-string">&quot;FileInputStream-&gt;&lt;init&gt;: &quot;</span> + arg);<br>    <span class="hljs-keyword">if</span> (arg.equals(<span class="hljs-string">&quot;/proc/cpuinfo&quot;</span>))&#123;<br>        arg = <span class="hljs-string">&quot;unidbg-android/src/test/resources/dazhongdianping/cpuinfo&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        fileInputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(arg);<br>    &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来是<code>InputStreamReader</code>的<code>init</code>，做同样处理，先全局声明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NBridge</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJni</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Memory memory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DvmObject&lt;?&gt; cSIUACollectorObj;<br>    <span class="hljs-keyword">public</span> FileInputStream fileInputStream;<br>    <span class="hljs-keyword">public</span> InputStreamReader inputStreamReader;<br></code></pre></td></tr></table></figure>

<p>再处理具体逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/InputStreamReader-&gt;&lt;init&gt;(Ljava/io/InputStream;)V&quot;</span>: &#123;<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (InputStream) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    inputStreamReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(arg);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然而这样做会报错，这是因为这个 <code>InputStream</code> 参数就是我们之前定义的全局变量 <code>InputStream</code>，然而我们通过<code> vaList</code>获取的则是占位符而已，无法对其进行初始化，因此需要使用全局变量进行初始化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/InputStreamReader-&gt;&lt;init&gt;(Ljava/io/InputStream;)V&quot;</span>: &#123;<br>    inputStreamReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(fileInputStream);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>之后是<code>BufferedReader</code>的<code>init</code>，做同样处理，先全局声明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> BufferedReader bufferedReader;<br></code></pre></td></tr></table></figure>

<p>再处理具体逻辑，同样的，使用全局变量<code>inputStreamReader</code>作为参数传入，刚才这几个文件读取相关的函数处理相当于套娃了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/BufferedReader-&gt;&lt;init&gt;(Ljava/io/Reader;)V&quot;</span>: &#123;<br>    bufferedReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(inputStreamReader);<br>    <span class="hljs-keyword">return</span>;            <br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1202e89f[libmtguard.so]0x2e89f, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/io/BufferedReader-&gt;readLine()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>这个处理起来很简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/BufferedReader-&gt;readLine()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        line = bufferedReader.readLine();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (line != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, line);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x12f, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0384, <span class="hljs-attribute">LR</span>=RX@0x1202c179[libmtguard.so]0x2c179, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/String-&gt;compareToIgnoreCase(Ljava/lang/String;)I<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)<br></code></pre></td></tr></table></figure>

<p>补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/String-&gt;compareToIgnoreCase(Ljava/lang/String;)I&quot;</span>: &#123;<br>    <span class="hljs-comment">// 获取参数</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (String) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    <span class="hljs-comment">// 获取对象</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (String) dvmObject.getValue();<br><br>    <span class="hljs-keyword">return</span> obj.compareToIgnoreCase(arg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x13b, PC=unidbg@<span class="hljs-number">0</span>xfffe0444, LR=RX@<span class="hljs-number">0</span>x1202bcbf<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x2bcbf, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/io/BufferedReader-&gt;<span class="hljs-built_in">close</span>()V<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callVoidMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1007</span>)<br></code></pre></td></tr></table></figure>

<p>补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/BufferedReader-&gt;close()V&quot;</span>: &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        bufferedReader.close();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x120312c3[libmtguard.so]0x312c3, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/hardware/SensorManager-&gt;getDefaultSensor(I)Landroid/hardware/Sensor;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p><code>getDefaultSensor</code>是唤醒传感器，参数是传感器类型，源码在<code>/frameworks/base/core/java/android/hardware/SensorManager.java</code>下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> Sensor <span class="hljs-title function_">getDefaultSensor</span><span class="hljs-params">(<span class="hljs-type">int</span> type)</span> &#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> need to be smarter, for now, just return the 1st sensor</span><br>    List&lt;Sensor&gt; l = getSensorList(type);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">wakeUpSensor</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// For the following sensor types, return a wake-up sensor. These types are by default</span><br>    <span class="hljs-comment">// defined as wake-up sensors. For the rest of the SDK defined sensor types return a</span><br>    <span class="hljs-comment">// non_wake-up version.</span><br>    <span class="hljs-keyword">if</span> (type == Sensor.TYPE_PROXIMITY || type == Sensor.TYPE_SIGNIFICANT_MOTION<br>        || type == Sensor.TYPE_TILT_DETECTOR || type == Sensor.TYPE_WAKE_GESTURE<br>        || type == Sensor.TYPE_GLANCE_GESTURE || type == Sensor.TYPE_PICK_UP_GESTURE<br>        || type == Sensor.TYPE_WRIST_TILT_GESTURE<br>        || type == Sensor.TYPE_DYNAMIC_SENSOR_META) &#123;<br>        wakeUpSensor = <span class="hljs-literal">true</span>;<br>    &#125;<br>	<span class="hljs-comment">// 遍历传感器</span><br>    <span class="hljs-keyword">for</span> (Sensor sensor : l) &#123;<br>        <span class="hljs-keyword">if</span> (sensor.isWakeUpSensor() == wakeUpSensor) <span class="hljs-keyword">return</span> sensor;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Sensor 表示的是传感器类，其源码在<code>/frameworks/base/core/java/android/hardware/Sensor.java</code>下，所具有的传感器类型部分如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_ACCELEROMETER</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">//加速度传感器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_ORIENTATION</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<span class="hljs-comment">//方向传感器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_POSE_6DOF</span> <span class="hljs-operator">=</span> <span class="hljs-number">28</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_PRESSURE</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<span class="hljs-comment">//气压传感器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_PROXIMITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;<span class="hljs-comment">//距离传感器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_RELATIVE_HUMIDITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">12</span>;<span class="hljs-comment">//湿度传感器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_ROTATION_VECTOR</span> <span class="hljs-operator">=</span> <span class="hljs-number">11</span><span class="hljs-comment">//旋转矢量传感器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_SIGNIFICANT_MOTION</span> <span class="hljs-operator">=</span> <span class="hljs-number">17</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_STATIONARY_DETECT</span> <span class="hljs-operator">=</span> <span class="hljs-number">29</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_STEP_COUNTER</span> <span class="hljs-operator">=</span> <span class="hljs-number">19</span>;<span class="hljs-comment">//单次步数传感器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_STEP_DETECTOR</span> <span class="hljs-operator">=</span> <span class="hljs-number">18</span>;<span class="hljs-comment">//累计步数传感器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_GRAVITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">9</span>;<span class="hljs-comment">//重力传感器</span><br></code></pre></td></tr></table></figure>

<p>打印参数，看样本在获取哪类传感器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/hardware/SensorManager-&gt;getDefaultSensor(I)Landroid/hardware/Sensor;&quot;</span>: &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> vaList.getIntArg(<span class="hljs-number">0</span>);<br>    System.out.println(<span class="hljs-string">&quot;Sensor type:&quot;</span>+type);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果如下 </p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-type">Sensor</span> <span class="hljs-keyword">type</span>:1<br></code></pre></td></tr></table></figure>

<p>1 对应于加速度传感器，那么创建相应的传感器即可（这里仅占位）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/hardware/SensorManager-&gt;getDefaultSensor(I)Landroid/hardware/Sensor;&quot;</span>: &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> vaList.getIntArg(<span class="hljs-number">0</span>);<br>    System.out.println(<span class="hljs-string">&quot;Sensor type:&quot;</span>+type);<br>    <span class="hljs-keyword">return</span> vm.resolveClass(<span class="hljs-string">&quot;android/hardware/Sensor&quot;</span>).newObject(type);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12031b3b[libmtguard.so]0x31b3b, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/hardware/Sensor-&gt;getName()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>需要获取传感器的名字。这里我们可以写个Android项目的小demo来获取加速度传感器的名字</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getSensorName</span><span class="hljs-params">()</span>&#123;<br>    SensorManager manager= (SensorManager)getSystemService(SENSOR_SERVICE);<br>    <span class="hljs-type">Sensor</span> <span class="hljs-variable">accelSensor</span> <span class="hljs-operator">=</span> manager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);<br>    Log.e(<span class="hljs-string">&quot;gal2xy&quot;</span>,accelSensor.getName());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>日志输出</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">BMI160 </span>accelerometer<br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/hardware/Sensor-&gt;getName()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-comment">// 不是安卓环境，用不了android的Sensor</span><br>    <span class="hljs-comment">//                Sensor sensor = (Sensor) dvmObject.getValue();</span><br>    <span class="hljs-comment">// 获取的是type!?</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) dvmObject.getValue();<br>    System.out.println(<span class="hljs-string">&quot;Sensor getName:&quot;</span>+type);<br>    <span class="hljs-keyword">if</span> (type == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;BMI160 accelerometer&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(signature);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来是</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1202e717[libmtguard.so]0x2e717, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/hardware/Sensor-&gt;getVendor()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>同样在Android项目中获取一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getVendor</span><span class="hljs-params">()</span>&#123;<br>    SensorManager manager= (SensorManager)getSystemService(SENSOR_SERVICE);<br>    <span class="hljs-type">Sensor</span> <span class="hljs-variable">accelSensor</span> <span class="hljs-operator">=</span> manager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);<br>    Log.e(<span class="hljs-string">&quot;gal2xy&quot;</span>,accelSensor.getVendor());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Bosch</span><br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/hardware/Sensor-&gt;getVendor()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) dvmObject.getValue();<br>    System.out.println(<span class="hljs-string">&quot;Sensor getVendor:&quot;</span>+type);<br>    <span class="hljs-keyword">if</span> (type == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;Bosch&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(signature);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Sensor getName:9<br>[15:15:28 547]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1202ad4f[libmtguard.so]0x2ad4f, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/hardware/Sensor-&gt;getName()Ljava/lang/String;<br>	at com.meituan.android.common.mtguard.NBridge.callObjectMethodV(NBridge.java:264)<br></code></pre></td></tr></table></figure>

<p>这次获取的type&#x3D;9的传感器信息，相关操作如法炮制一下，最终得到设备名为Gravity，供应商为Google，继续完善补环境。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/hardware/Sensor-&gt;getName()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) dvmObject.getValue();<br>    System.out.println(<span class="hljs-string">&quot;Sensor getName:&quot;</span>+type);<br>    <span class="hljs-keyword">if</span> (type == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;BMI160 accelerometer&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-number">9</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;Gravity&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(signature);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/hardware/Sensor-&gt;getVendor()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) dvmObject.getValue();<br>    System.out.println(<span class="hljs-string">&quot;Sensor getVendor:&quot;</span>+type);<br>    <span class="hljs-keyword">if</span> (type == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;Bosch&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-number">9</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;Google&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(signature);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x13b, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0444, <span class="hljs-attribute">LR</span>=RX@0x1202c103[libmtguard.so]0x2c103, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;safeClose(Ljava/io/Closeable;)V<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)<br></code></pre></td></tr></table></figure>

<p>jadx中查看<code>safeClose</code>代码，发现是关闭某种资源，这里简单处理即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;safeClose(Ljava/io/Closeable;)V&quot;</span>:&#123;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终跑通</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">getHWEquipmentInfo call result: -|<span class="hljs-string">-</span>|<span class="hljs-string">4</span>|<span class="hljs-string">BMI160 accelerometer</span>|<span class="hljs-string">Bosch</span>|<span class="hljs-string">Gravity</span>|<span class="hljs-string">Google</span>|<br></code></pre></td></tr></table></figure>

<h1 id="八、getHWProperty"><a href="#八、getHWProperty" class="headerlink" title="八、getHWProperty"></a>八、getHWProperty</h1><p>调用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHWProperty</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getHWProperty()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x18d, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0964, <span class="hljs-attribute">LR</span>=RX@0x1200fbfd[libmtguard.so]0xfbfd, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/os/Build-&gt;BOARD:Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)<br></code></pre></td></tr></table></figure>

<p>需要获取设备的品牌方。对于 Build 下的信息，同样可以写 demo 看，这个办法相当灵活好用，或者使用 ADB 也行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getBoard</span><span class="hljs-params">()</span>&#123;<br>    Log.e(<span class="hljs-string">&quot;gal2xy&quot;</span>, <span class="hljs-string">&quot;getBoard: &quot;</span> + Build.BOARD);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果如下</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">marlin</span><br></code></pre></td></tr></table></figure>

<p>adb结果如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">getprop | grep board</span><br>[ro.board.platform]: [msm8996]<br>[ro.product.board]: [marlin]<br></code></pre></td></tr></table></figure>

<p>补环境代如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;<br>    <span class="hljs-keyword">switch</span> (signature) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;BOARD:Ljava/lang/String;&quot;</span>: &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;marlin&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getStaticObjectField(vm, dvmClass, signature);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x18d, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0964, <span class="hljs-attribute">LR</span>=RX@0x120160ab[libmtguard.so]0x160ab, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/os/Build-&gt;MANUFACTURER:Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)<br></code></pre></td></tr></table></figure>

<p>demo运行和adb结果如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//demo</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getManufacturer</span><span class="hljs-params">()</span>&#123;<br>	Log.e(<span class="hljs-string">&quot;gal2xy&quot;</span>, <span class="hljs-string">&quot;getManufacturer: &quot;</span> + Build.MANUFACTURER);<br>&#125;<br><span class="hljs-comment">//结果</span><br>getManufacturer: Google<br><br><span class="hljs-comment">//adb</span><br>&gt; getprop | grep manufacturer<br>[media.recorder.show_manufacturer_and_model]: [<span class="hljs-literal">true</span>]<br>[ro.product.manufacturer]: [Google]<br>[ro.product.odm.manufacturer]: [Google]<br>[ro.product.system.manufacturer]: [Google]<br>[ro.product.vendor.manufacturer]: [Google]<br></code></pre></td></tr></table></figure>

<p>补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;MANUFACTURER:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;Google&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>还是获取Build类下的信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x18d, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0964, <span class="hljs-attribute">LR</span>=RX@0x12016b1b[libmtguard.so]0x16b1b, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/os/Build-&gt;BRAND:Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)<br></code></pre></td></tr></table></figure>

<p>相同操作不再叙述，直接展示补环境代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;BRAND:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;Google&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>仍旧是Build类</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x18d, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0964, <span class="hljs-attribute">LR</span>=RX@0x12014c13[libmtguard.so]0x14c13, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/os/Build-&gt;MODEL:Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)<br></code></pre></td></tr></table></figure>

<p>补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;MODEL:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;Pixel XL&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>终于不再是Build类的报错了</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1200d2a7[libmtguard.so]0xd2a7, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>jadx查看了该函数，发现是获取系统的相关信息，先来看一下传入的参数是啥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (String) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    System.out.println(<span class="hljs-string">&quot;getSysProp param: &quot;</span> + arg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>打印结果如下</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">getSysProp param: ro<span class="hljs-selector-class">.product</span><span class="hljs-selector-class">.cpu</span>.abi<br></code></pre></td></tr></table></figure>

<p>这个属性信息用 ADB 获取很方便，第一个就是。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">marlin:/ # getprop | grep ro.product.cpu.abi<br>[ro.product.cpu.abi]: [arm64-v8a]<br>[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]<br>[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]<br>[ro.product.cpu.abilist64]: [arm64-v8a]<br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (String) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    System.out.println(<span class="hljs-string">&quot;getSysProp param: &quot;</span> + arg);<br>    <span class="hljs-keyword">switch</span> (arg) &#123;<br>    	<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;ro.product.cpu.abi&quot;</span>:<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;arm64-v8a&quot;</span>);<br>        <span class="hljs-keyword">default</span>:<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(signature);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">getSysProp param: ro.product.cpu.abi2<br>[15:54:19 964]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12018613[libmtguard.so]0x18613, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;<br>	at com.meituan.android.common.mtguard.MyAbstractJni.callObjectMethodV(MyAbstractJni.java:221)<br></code></pre></td></tr></table></figure>

<p>这次获取的属性是ro.product.cpu.abi2，同样adb获取，adb getprop 找不到这个属性，所以返回空字符串 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;ro.product.cpu.abi2&quot;</span>:<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>接下来的报错按顺序分别是 PRODUCT、HARDWARE、DEVICE。补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;PRODUCT:Ljava/lang/String;&quot;</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;HARDWARE:Ljava/lang/String;&quot;</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;DEVICE:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;marlin&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">getSysProp param: ro.build.product<br>[16:02:00 388]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1201831f[libmtguard.so]0x1831f, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;<br>	at com.meituan.android.common.mtguard.MyAbstractJni.callObjectMethodV(MyAbstractJni.java:224)<br></code></pre></td></tr></table></figure>

<p>补充<code>ro.build.product</code>的属性获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;ro.build.product&quot;</span>:<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;marlin&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>接下来又续上了Build类属性：HOST、ID。补相应环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;HOST:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;abfarm830&quot;</span>);<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;ID:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;QP1A.191005.007.A3&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x18d, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0964, <span class="hljs-attribute">LR</span>=RX@0x12010777[libmtguard.so]0x10777, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/os/Build<span class="hljs-variable">$VERSION</span>-&gt;RELEASE:Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)<br></code></pre></td></tr></table></figure>

<p>写个demo获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getRelease</span><span class="hljs-params">()</span>&#123;<br>    Log.e(<span class="hljs-string">&quot;gal2xy&quot;</span>, <span class="hljs-string">&quot;getRelease: &quot;</span> + Build.VERSION.RELEASE);<br>&#125;<br><span class="hljs-comment">//结果</span><br>getRelease: <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build$VERSION-&gt;RELEASE:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;10&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来是个简单的报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x171, <span class="hljs-attribute">PC</span>=unidbg@0xfffe07a4, <span class="hljs-attribute">LR</span>=RX@0x1200c9c1[libmtguard.so]0xc9c1, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/Integer-&gt;toString(I)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticObjectMethodV(AbstractJni.java:504)<br></code></pre></td></tr></table></figure>

<p>jdk中函数，按照一般步骤走即可：获取对象、获取参数、调用方法、封装。由于这个是静态方法，不需要实例对象即可调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/Integer-&gt;toString(I)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> vaList.getIntArg(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// 调用方法</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Integer.toString(arg);<br>    <span class="hljs-comment">// 封装</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, result);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x120, PC=unidbg@<span class="hljs-number">0</span>xfffe0294, LR=RX@<span class="hljs-number">0</span>x120102b3<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x102b3, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/<span class="hljs-attribute">content</span>/Context-&gt;<span class="hljs-built_in">getResources</span>()Landroid/content/res/Resources;<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callObjectMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">417</span>)<br></code></pre></td></tr></table></figure>

<p>本想刚才所说的一般步骤走，结果发现这个是Android里的库方法，所以占位即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/content/Context-&gt;getResources()Landroid/content/res/Resources;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> vm.resolveClass(<span class="hljs-string">&quot;android/content/res/Resources&quot;</span>).newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来是获取资源配置信息</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x120, PC=unidbg@<span class="hljs-number">0</span>xfffe0294, LR=RX@<span class="hljs-number">0</span>x12012e8b<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x12e8b, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/<span class="hljs-attribute">content</span>/res/Resources-&gt;<span class="hljs-built_in">getConfiguration</span>()Landroid/content/res/Configuration;<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callObjectMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">417</span>)<br></code></pre></td></tr></table></figure>

<p>同样进行占位</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/content/res/Resources-&gt;getConfiguration()Landroid/content/res/Configuration;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> vm.resolveClass(<span class="hljs-string">&quot;android/content/res/Configuration&quot;</span>).newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x15b, PC=unidbg@<span class="hljs-number">0</span>xfffe0644, LR=RX@<span class="hljs-number">0</span>x1201187f<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x1187f, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/<span class="hljs-attribute">content</span>/res/Configuration-&gt;locale:Ljava/util/Locale;<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.getObjectField</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">171</span>)<br></code></pre></td></tr></table></figure>

<p>获取<code>Configuration</code>的<code>locale</code>属性，具体而言，是获取区域信息，<code>locale </code>在 JDK 里也有，所以改用 <code>createObject</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/content/res/Configuration-&gt;locale:Ljava/util/Locale;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> ProxyDvmObject.createObject(vm, Locale.getDefault());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来还是Build类的报错：TAGS、FINGERPRINT、TYPE。demo跑一下获取对应值，补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;TAGS:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;release-keys&quot;</span>);<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;FINGERPRINT:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;google/marlin/marlin:10/QP1A.191005.007&quot;</span>);<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build-&gt;TYPE:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;user&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来是又是<code>getSysProp</code>报错，获取的属性是：<code>ro.build.description</code>、<code>ro.secure</code>、<code>ro.debuggable</code>。</p>
<p>adb获取</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">marlin:/ # getprop | grep ro.build.description<br>[<span class="hljs-symbol">ro.build.description</span>]: <span class="hljs-link">[marlin-user 10 QP1A.191005.007.A3 5972272 release-keys]</span><br>marlin:/ # getprop | grep ro.secure<br>[<span class="hljs-symbol">ro.secure</span>]: <span class="hljs-link">[1]</span><br>marlin:/ # getprop | grep ro.debuggable<br>[<span class="hljs-symbol">ro.debuggable</span>]: <span class="hljs-link">[1]</span><br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;ro.build.description&quot;</span>:<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;marlin-user 10 QP1A.191005.007.A3 5972272 release-keys&quot;</span>);<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;ro.secure&quot;</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;ro.debuggable&quot;</span>:<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;1&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>最终执行成功</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">getHWProperty call result: marlin|<span class="hljs-string">Google</span>|<span class="hljs-string">Google</span>|<span class="hljs-string">Pixel XL</span>|<span class="hljs-string">arm64-v8a</span>|<span class="hljs-string">-</span>|<span class="hljs-string">marlin</span>|<span class="hljs-string">marlin</span>|<span class="hljs-string">marlin</span>|<span class="hljs-string">marlin</span>|<span class="hljs-string">abfarm830</span>|<span class="hljs-string">QP1A.191005.007.A3</span>|<span class="hljs-string">10</span>|<span class="hljs-string">29</span>|<span class="hljs-string">zh</span>|<span class="hljs-string">CN</span>|<span class="hljs-string">release-keys</span>|<span class="hljs-string">google/marlin/marlin:10/QP1A.191005.007</span>|<span class="hljs-string">user</span>|<span class="hljs-string">marlin-user 10 QP1A.191005.007.A3 5972272 release-keys</span>|<span class="hljs-string">1</span>|<span class="hljs-string">1</span>|<br></code></pre></td></tr></table></figure>

<h1 id="九、getHWStatus"><a href="#九、getHWStatus" class="headerlink" title="九、getHWStatus"></a>九、getHWStatus</h1><p>调用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHWStatus</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getHWStatus()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">getSysProp param: persist.sys.usb.config<br>[16:43:17 924]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12023a11[libmtguard.so]0x23a11, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;<br>	at com.meituan.android.common.mtguard.MyAbstractJni.callObjectMethodV(MyAbstractJni.java:233)<br></code></pre></td></tr></table></figure>

<p>这是在获取设备是否连接了 ADB，因此我返回空字符串，接连三个都是类似的属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;sys.usb.state&quot;</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;sys.usb.config&quot;</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;persist.sys.usb.config&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x123, PC=unidbg@<span class="hljs-number">0</span>xfffe02c4, LR=RX@<span class="hljs-number">0</span>x12026075<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x26075, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/<span class="hljs-attribute">content</span>/pm/PackageManager-&gt;<span class="hljs-built_in">hasSystemFeature</span>(Ljava/lang/String;)Z<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callBooleanMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">625</span>)<br></code></pre></td></tr></table></figure>

<p>搜索发现 <code>hasSystemFeature()</code> 判断系统是否有特定的模块功能，这里我们打印参数看看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/content/pm/PackageManager-&gt;hasSystemFeature(Ljava/lang/String;)Z&quot;</span>: &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (String) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    System.out.println(<span class="hljs-string">&quot;hasSystemFeature: &quot;</span> + arg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>发现是检测是否存在加速度传感器</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">hasSystemFeature: android<span class="hljs-selector-class">.hardware</span><span class="hljs-selector-class">.sensor</span>.accelerometer<br></code></pre></td></tr></table></figure>

<p>返回 True，然后又检测了不少传感器和硬件支持。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/content/pm/PackageManager-&gt;hasSystemFeature(Ljava/lang/String;)Z&quot;</span>: &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> (String) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    System.out.println(<span class="hljs-string">&quot;hasSystemFeature: &quot;</span> + arg);<br>    <span class="hljs-keyword">switch</span> (arg)&#123;<br>            <span class="hljs-comment">// 检测加速传感器</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.sensor.accelerometer&quot;</span>:<br>            <span class="hljs-comment">// nfc</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.nfc&quot;</span>:<br>            <span class="hljs-comment">// gps</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.location.gps&quot;</span>:<br>            <span class="hljs-comment">// USB 配件API</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.usb.accessory&quot;</span>:<br>            <span class="hljs-comment">// 电话</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.telephony&quot;</span>:<br>            <span class="hljs-comment">// 蓝牙低功耗</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.bluetooth_le&quot;</span>:<br>            <span class="hljs-comment">// 蓝牙</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.bluetooth&quot;</span>:<br>            <span class="hljs-comment">// wifi</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.wifi&quot;</span>:<br>            <span class="hljs-comment">// 检测陀螺仪传感器</span><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android.hardware.sensor.gyroscope&quot;</span>: &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">default</span>: &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>期间报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x12f, PC=unidbg@<span class="hljs-number">0</span>xfffe0384, LR=RX@<span class="hljs-number">0</span>x12021bb9<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x21bb9, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;<span class="hljs-built_in">boolean2Integer</span>(Z)I<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callIntMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">563</span>)<br></code></pre></td></tr></table></figure>

<p>查看<code>boolean2Integer</code>发现是将true转成1，false转成0。但是 Unidbg 没法 getBoolean，连这步都节省了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;boolean2Integer(Z)I&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-comment">//Boolean arg = (Boolean) vaList.getObjectArg(0).getValue();//获取的是null！？</span><br>    <span class="hljs-comment">//return arg ? 1 : 0;</span><br>    <span class="hljs-keyword">return</span> vaList.getIntArg(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，又是报错<code>getSysProp</code>，获取的属性是<code>gsm.version.baseband</code>、<code>gsm.version.ril-impl</code>、<code>gsm.sim.state</code>、<code>gsm.sim.state.2</code>，先adb获取信息，再补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;gsm.version.baseband&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;8996-130361-1905270421&quot;</span>);<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;gsm.version.ril-impl&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;Qualcomm RIL 1.0&quot;</span>);<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;gsm.sim.state&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;ABSENT&quot;</span>);<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;gsm.sim.state.2&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来报错的是 File</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x117, PC=unidbg@<span class="hljs-number">0</span>xfffe0204, LR=RX@<span class="hljs-number">0</span>x1202009d<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x2009d, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/io/File-&gt;allocObject<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.allocObject</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">812</span>)<br>	at com<span class="hljs-selector-class">.meituan</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.mtguard</span><span class="hljs-selector-class">.MyAbstractJni</span><span class="hljs-selector-class">.allocObject</span>(MyAbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">35</span>)<br></code></pre></td></tr></table></figure>

<p>File 同样像之前处理，进行占位</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/File-&gt;allocObject&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> dvmClass.newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后是 File 的构造函数报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x13b, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0444, <span class="hljs-attribute">LR</span>=RX@0x1201d887[libmtguard.so]0x1d887, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/io/File-&gt;&lt;init&gt;(Ljava/lang/String;)V<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)<br></code></pre></td></tr></table></figure>

<p>和先前一样，用全局变量处理，因为担心会初始化多个文件，所以命名为 file1。</p>
<p>先打印看一下是哪个文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/File-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;</span>:&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> vaList.getObjectArg(<span class="hljs-number">0</span>).getValue().toString();<br>    System.out.println(<span class="hljs-string">&quot;File-&gt;&lt;init&gt; param: &quot;</span>+filePath);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>打印结果如下</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">File</span>-&gt;&lt;init&gt; param: <span class="hljs-regexp">/sys/</span><span class="hljs-keyword">class</span><span class="hljs-regexp">/power_supply/</span>battery/voltage_now<br></code></pre></td></tr></table></figure>

<p>这是电池信息相关的文件。</p>
<p>在 Unidbg 中建立对应的文件，补环境，做重定向。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/File-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> (String) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    System.out.println(<span class="hljs-string">&quot;File-&gt;&lt;init&gt; param: &quot;</span> + filePath);<br>    <span class="hljs-keyword">switch</span> (filePath) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;/sys/class/power_supply/battery/voltage_now&quot;</span>: &#123;<br>            file1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android/src/test/resources/dazhongdianping/voltage_now&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">default</span>:&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续运行，报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x123, PC=unidbg@<span class="hljs-number">0</span>xfffe02c4, LR=RX@<span class="hljs-number">0</span>x1201dc27<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x1dc27, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/io/File-&gt;<span class="hljs-built_in">exists</span>()Z<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callBooleanMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">625</span>)<br></code></pre></td></tr></table></figure>

<p>很明显，这里是判断刚才创建的file1是否存在，补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/File-&gt;exists()Z&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> file1.exists();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后样本开始处理另一个文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">File-&gt;&lt;init&gt; param: /sys/class/power_supply/battery/temp<br>[17:27:35 259]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x13b, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0444, <span class="hljs-attribute">LR</span>=RX@0x12026601[libmtguard.so]0x26601, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException<br>	at com.meituan.android.common.mtguard.MyAbstractJni.callVoidMethodV(MyAbstractJni.java:87)<br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;/sys/class/power_supply/battery/temp&quot;</span>: &#123;<br>    file2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android/src/test/resources/dazhongdianping/temp&quot;</span>);<br>    <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于存在多个文件的使用，因此将<code>java/io/File-&gt;exists()Z</code>的处理改为始终返回<code>true</code>，因为样本所使用的两个文件我们都弄到了unidbg项目中，所以是存在的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/io/File-&gt;exists()Z&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后一个报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">getSysProp param: wifi.interface<br>[17:18:47 564]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1201f0a3[libmtguard.so]0x1f0a3, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;<br>	at com.meituan.android.common.mtguard.MyAbstractJni.callObjectMethodV(MyAbstractJni.java:262)<br></code></pre></td></tr></table></figure>

<p>adb获取信息并添加<code>wifi.interface</code>分支</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;wifi.interface&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;wlan0&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终运行成功，结果如下</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">getHWStatus call result: -|<span class="hljs-string">-</span>|<span class="hljs-string">-</span>|<span class="hljs-string">1</span>|<span class="hljs-string">1</span>|<span class="hljs-string">8996-130361-1905270421</span>|<span class="hljs-string">Qualcomm RIL 1.0</span>|<span class="hljs-string">ABSENT</span>|<span class="hljs-string">-</span>|<span class="hljs-string">0</span>|<span class="hljs-string">0</span>|<span class="hljs-string">1</span>|<span class="hljs-string">wlan0</span>|<span class="hljs-string">1</span>|<span class="hljs-string">1</span>|<span class="hljs-string">1</span>|<span class="hljs-string">1</span>|<span class="hljs-string">1</span>|<span class="hljs-string">1</span>|<span class="hljs-string">1</span>|<br></code></pre></td></tr></table></figure>

<h1 id="十、getLocationInfo"><a href="#十、getLocationInfo" class="headerlink" title="十、getLocationInfo"></a>十、getLocationInfo</h1><p>调用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLocationInfo</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getLocationInfo()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12053cf7[libmtguard.so]0x53cf7, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/net/wifi/WifiManager-&gt;getConnectionInfo()Landroid/net/wifi/WifiInfo;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>android的库函数，而且返回的是android库函数里的对象，那只能占位处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/net/wifi/WifiManager-&gt;getConnectionInfo()Landroid/net/wifi/WifiInfo;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> vm.resolveClass(<span class="hljs-string">&quot;android/net/wifi/WifiInfo&quot;</span>).newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12058323[libmtguard.so]0x58323, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/net/wifi/WifiInfo-&gt;getSSID()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>搜索<code>getSSID</code>发现是获取wifi名称，查看手机所连接的 WIFI 名，做补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/net/wifi/WifiInfo-&gt;getSSID()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;CMCC&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x123, <span class="hljs-attribute">PC</span>=unidbg@0xfffe02c4, <span class="hljs-attribute">LR</span>=RX@0x1205980f[libmtguard.so]0x5980f, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/String-&gt;equalsIgnoreCase(Ljava/lang/String;)Z<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)<br></code></pre></td></tr></table></figure>

<p>jdk函数，按照之前所提到的步骤走就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/String-&gt;equalsIgnoreCase(Ljava/lang/String;)Z&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> vaList.getObjectArg(<span class="hljs-number">0</span>).getValue().toString();<br>    <span class="hljs-comment">//获取实例对象</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (String) dvmObject.getValue();<br>    <span class="hljs-comment">//调用方法</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> obj.equalsIgnoreCase(arg);<br>    <span class="hljs-comment">//封装</span><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x123, <span class="hljs-attribute">PC</span>=unidbg@0xfffe02c4, <span class="hljs-attribute">LR</span>=RX@0x120508b3[libmtguard.so]0x508b3, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/String-&gt;equals(Ljava/lang/Object;)Z<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)<br></code></pre></td></tr></table></figure>

<p>处理类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/String-&gt;equals(Ljava/lang/Object;)Z&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> vaList.getObjectArg(<span class="hljs-number">0</span>).getValue().toString();<br>    <span class="hljs-comment">//获取实例对象</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (String) dvmObject.getValue();<br>    <span class="hljs-comment">//调用方法</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> obj.equals(arg);<br>    <span class="hljs-comment">//封装</span><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错，仍旧是跟String类相关的</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x12f, PC=unidbg@<span class="hljs-number">0</span>xfffe0384, LR=RX@<span class="hljs-number">0</span>x120549c9<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x549c9, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: java/lang/String-&gt;<span class="hljs-built_in">length</span>()I<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callIntMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">563</span>)<br></code></pre></td></tr></table></figure>

<p>处理类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/String-&gt;length()I&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取实例对象</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (String) dvmObject.getValue();<br>    <span class="hljs-comment">//调用方法</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> obj.length();<br>    <span class="hljs-comment">//封装</span><br>    <span class="hljs-keyword">return</span> length;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x120577c7[libmtguard.so]0x577c7, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;append(Ljava/lang/CharSequence;II)Ljava/lang/StringBuilder;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>都是以前见过的，处理起来很顺手</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/StringBuilder-&gt;append(Ljava/lang/CharSequence;II)Ljava/lang/StringBuilder;&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取实例对象</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> (StringBuilder) dvmObject.getValue();<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">CharSequence</span> <span class="hljs-variable">sequence</span> <span class="hljs-operator">=</span> (CharSequence) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> vaList.getIntArg(<span class="hljs-number">1</span>);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> vaList.getIntArg(<span class="hljs-number">2</span>);<br>    <span class="hljs-comment">//调用方法</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">newBuilder</span> <span class="hljs-operator">=</span> builder.append(sequence, start, end);<br>    <span class="hljs-comment">//封装</span><br>    <span class="hljs-keyword">return</span> ProxyDvmObject.createObject(vm,newBuilder);<br>&#125;   <br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x120515e3[libmtguard.so]0x515e3, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/net/wifi/WifiInfo-&gt;getBSSID()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p><code>getBSSID</code>获取的是WIFI的MAC地址，直接ifconfig获取，或者写个Android demo也行。补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/net/wifi/WifiInfo-&gt;getBSSID()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;ac:37:43:48:ec:7a&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后还是WIFI相关报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x12f, PC=unidbg@<span class="hljs-number">0</span>xfffe0384, LR=RX@<span class="hljs-number">0</span>x12050943<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x50943, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: android/net/wifi/WifiInfo-&gt;<span class="hljs-built_in">getRssi</span>()I<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callIntMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">563</span>)<br></code></pre></td></tr></table></figure>

<p><code>getRssi</code>获取WIFI强度，范围值是 -100到0之前，值越大表示信号越好，补环境时随便返回一个数即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/net/wifi/WifiInfo-&gt;getRssi()I&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> -<span class="hljs-number">10</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来<code>TelephonyManager</code>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12058f2f[libmtguard.so]0x58f2f, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/telephony/TelephonyManager-&gt;getNetworkOperator()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p> <code>getNetworkOperator()</code> 方法用于获取当前设备所连接的移动网络的运营商标识符，返回值的格式通常是 <code>MCCMNC</code>，这是我们前面遇到的情况，仍然返回46000</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/telephony/TelephonyManager-&gt;getNetworkOperator()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;46000&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x120588d3[libmtguard.so]0x588d3, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/lang/String-&gt;substring(I)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>jdk函数，处理简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/lang/String-&gt;substring(I)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取实例对象</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (String) dvmObject.getValue();<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> vaList.getIntArg(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//调用函数</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> obj.substring(arg);<br>    <span class="hljs-comment">//封装</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,result);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后成功运行</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">getLocationInfo call result: -|<span class="hljs-string">-</span>|<span class="hljs-string">MC</span>|<span class="hljs-string">ac:37:43:48:ec:7a</span>|<span class="hljs-string">1</span>|<span class="hljs-string">-10</span>|<span class="hljs-string">460</span>|<span class="hljs-string">00</span>|<span class="hljs-string">-</span>|<br></code></pre></td></tr></table></figure>

<h1 id="十一、getPlatformInfo"><a href="#十一、getPlatformInfo" class="headerlink" title="十一、getPlatformInfo"></a>十一、getPlatformInfo</h1><p>调用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPlatformInfo</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getPlatformInfo()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x117, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0204, <span class="hljs-attribute">LR</span>=RX@0x120479cd[libmtguard.so]0x479cd, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/text/SimpleDateFormat-&gt;allocObject<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.allocObject(AbstractJni.java:812)<br></code></pre></td></tr></table></figure>

<p>进行占位处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/text/SimpleDateFormat-&gt;allocObject&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> dvmClass.newObject(<span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">//或者</span><br><span class="hljs-comment">//    return dvmClass.newObject(new SimpleDateFormat());</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来是它的构造函数报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x13b, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0444, <span class="hljs-attribute">LR</span>=RX@0x12047cf3[libmtguard.so]0x47cf3, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/text/SimpleDateFormat-&gt;&lt;init&gt;(Ljava/lang/String;Ljava/util/Locale;)V<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)<br></code></pre></td></tr></table></figure>

<p>处理为全局变量，然后补环境。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/text/SimpleDateFormat-&gt;&lt;init&gt;(Ljava/lang/String;Ljava/util/Locale;)V&quot;</span>: &#123;<br>    <span class="hljs-comment">// 获取参数</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> (String) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    <span class="hljs-type">Locale</span> <span class="hljs-variable">locale</span> <span class="hljs-operator">=</span> (Locale) vaList.getObjectArg(<span class="hljs-number">1</span>).getValue();<br>    <span class="hljs-comment">//实例化</span><br>    dataFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(pattern, locale);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x18d, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0964, <span class="hljs-attribute">LR</span>=RX@0x120476db[libmtguard.so]0x476db, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: android/os/Build<span class="hljs-variable">$VERSION</span>-&gt;SDK:Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)<br></code></pre></td></tr></table></figure>

<p>获取sdk版本，跟之前的对上就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;android/os/Build$VERSION-&gt;SDK:Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;29&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x117, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0204, <span class="hljs-attribute">LR</span>=RX@0x12047a29[libmtguard.so]0x47a29, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/util/Date-&gt;allocObject<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.allocObject(AbstractJni.java:812)<br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/util/Date-&gt;allocObject&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> dvmClass.newObject(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来是它的init</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x13b, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0444, <span class="hljs-attribute">LR</span>=RX@0x1204aa6b[libmtguard.so]0x4aa6b, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/util/Date-&gt;&lt;init&gt;()V<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)<br></code></pre></td></tr></table></figure>

<p><strong>由于这是一个无参构造</strong>，可以回头修改 allocObject 那儿的代码，使得思路更流畅。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/util/Date-&gt;allocObject&quot;</span>: &#123;<br>    <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>    <span class="hljs-comment">// return dvmClass.newObject(date);</span><br>    <span class="hljs-keyword">return</span> ProxyDvmObject.createObject(vm, date);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后下面初始化时就不用做什么了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/util/Date-&gt;&lt;init&gt;()V&quot;</span>:&#123;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>做个小结，带参的init必须全局化变量处理，对应的allocObject仅占位即可，对于不带参的init，在allocObject中可以创建实例对象并返回，然后init处仅需return即可（目前开来是jdk库函数适合）</p>
</blockquote>
<p>继续报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12048993[libmtguard.so]0x48993, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: java/text/SimpleDateFormat-&gt;format(Ljava/util/Date;)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;java/text/SimpleDateFormat-&gt;format(Ljava/util/Date;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-comment">//获取参数</span><br>    <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> (Date) vaList.getObjectArg(<span class="hljs-number">0</span>).getValue();<br>    <span class="hljs-comment">//获取实例对象, 实例对象就是刚才全局化的dataFormat</span><br>    <span class="hljs-comment">// SimpleDateFormat dateFormat = (SimpleDateFormat) dvmObject.getValue();</span><br>    <span class="hljs-comment">//执行方法</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> dataFormat.format(date);<br>    <span class="hljs-comment">//封装返回</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, result);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x12f, PC=unidbg@<span class="hljs-number">0</span>xfffe0384, LR=RX@<span class="hljs-number">0</span>x1204845f<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x4845f, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;<span class="hljs-built_in">androidAppCnt</span>(Landroid/<span class="hljs-attribute">content</span>/Context;)I<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callIntMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">563</span>)<br></code></pre></td></tr></table></figure>

<p>jadx 中看 androidAppCnt 的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">androidAppCnt</span><span class="hljs-params">(Context context)</span> &#123;<br>    <span class="hljs-type">int</span> i;<br>    Object[] objArr = &#123;context&#125;;<br>    <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>    <span class="hljs-keyword">if</span> (PatchProxy.isSupport(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;e2af58080aad5d311267bb7c71e6cce2&quot;</span>, RobustBitConfig.DEFAULT_VALUE)) &#123;<br>        <span class="hljs-keyword">return</span> ((Integer) PatchProxy.accessDispatch(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;e2af58080aad5d311267bb7c71e6cce2&quot;</span>)).intValue();<br>    &#125;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i2</span> <span class="hljs-operator">=</span> androidAppCntCache;<br>    <span class="hljs-keyword">if</span> (i2 != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> i2;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (Thread.currentThread() == Looper.getMainLooper().getThread()) &#123;<br>        <span class="hljs-keyword">return</span> androidAppCntCache;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        lock.lock();<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable th) &#123;<br>        c.a(th);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (androidAppCntCache != <span class="hljs-number">0</span>) &#123;<br>        i = androidAppCntCache;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">PackageManager</span> <span class="hljs-variable">pkgManager</span> <span class="hljs-operator">=</span> getPkgManager(context);<br>        <span class="hljs-keyword">if</span> (pkgManager == <span class="hljs-literal">null</span>) &#123;<br>            i = androidAppCntCache;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            androidAppCntCache = pkgManager.getInstalledApplications(<span class="hljs-number">128</span>).size();<br>            lock.unlock();<br>            <span class="hljs-keyword">return</span> androidAppCntCache;<br>        &#125;<br>    &#125;<br>    lock.unlock();<br>    <span class="hljs-keyword">return</span> i;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>getInstalledApplications</code>用于获取设备上已安装的应用程序列表，整个代码逻辑就是在获取设备安装了多少 App，补环境时返回一个合适的数就行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;androidAppCnt(Landroid/content/Context;)I&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">50</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后又报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12048f23[libmtguard.so]0x48f23, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;appCache(Landroid/content/Context;)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p><code>appCache</code>函数如下，主要功能是获取当前 Android 应用的缓存大小</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title function_">appCache</span><span class="hljs-params">(Context context)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (AppInfoWorker.class) &#123;<br>        Object[] objArr = &#123;context&#125;;<br>        <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>        <span class="hljs-keyword">if</span> (PatchProxy.isSupport(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;cf8fe1c6518d456cb61aad67de922620&quot;</span>, RobustBitConfig.DEFAULT_VALUE)) &#123;<br>            <span class="hljs-keyword">return</span> (String) PatchProxy.accessDispatch(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;cf8fe1c6518d456cb61aad67de922620&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (appCacheSizeCache != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> appCacheSizeCache;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;unknown&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">fileSize</span> <span class="hljs-operator">=</span> FileUtils.getFileSize(context.getCacheDir(), <span class="hljs-literal">true</span>) + FileUtils.getFileSize(context.getFilesDir(), <span class="hljs-literal">true</span>) + FileUtils.getFileSize(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(context.getFilesDir().getPath() + File.separator + context.getPackageName() + <span class="hljs-string">&quot;/shared_prefs&quot;</span>), <span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">if</span> (Environment.getExternalStorageState().equals(<span class="hljs-string">&quot;mounted&quot;</span>)) &#123;<br>                fileSize += FileUtils.getFileSize(context.getCacheDir(), <span class="hljs-literal">true</span>);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> fileSize + <span class="hljs-string">&quot;&quot;</span>;<br>            appCacheSizeCache = str;<br>            <span class="hljs-keyword">return</span> str;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Frida Hook获取</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <br>            <span class="hljs-keyword">let</span> <span class="hljs-title class_">SIUACollector</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;</span>);<br>            <span class="hljs-title class_">SIUACollector</span>[<span class="hljs-string">&quot;appCache&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.appCache is called: context=<span class="hljs-subst">$&#123;context&#125;</span>`</span>);<br>                <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;appCache&quot;</span>](context);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.appCache result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;;<br><br>            <span class="hljs-comment">// 获取系统上下文</span><br>            <span class="hljs-keyword">var</span> currentApplication = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;android.app.ActivityThread&#x27;</span>).<span class="hljs-title function_">currentApplication</span>();<br>            <span class="hljs-keyword">var</span> context = currentApplication.<span class="hljs-title function_">getApplicationContext</span>();<br>            <span class="hljs-comment">//主动调用</span><br>            <span class="hljs-title class_">SIUACollector</span>.$new(context).<span class="hljs-title function_">appCache</span>(context);<br><br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果如下</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">SIUACollector.appCache is called: <span class="hljs-attribute">context</span>=com.dianping.v1.NovaHydraApplication@1fc5fc1<br>SIUACollector.appCache <span class="hljs-attribute">result</span>=96458538<br></code></pre></td></tr></table></figure>

<p>补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;appCache(Landroid/content/Context;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;96458538&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1204adf7[libmtguard.so]0x4adf7, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;availableSystem()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p><code>availableSystem</code>代码逻辑如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">availableSystem</span><span class="hljs-params">()</span> &#123;<br>    Object[] objArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>    <span class="hljs-keyword">if</span> (PatchProxy.isSupport(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;234b4d16d3aab7d4062d61d2146219de&quot;</span>, RobustBitConfig.DEFAULT_VALUE)) &#123;<br>        <span class="hljs-keyword">return</span> (String) PatchProxy.accessDispatch(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;234b4d16d3aab7d4062d61d2146219de&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">dataDirectory</span> <span class="hljs-operator">=</span> Environment.getDataDirectory();<br>        <span class="hljs-keyword">if</span> (readable(dataDirectory)) &#123;<br>            <span class="hljs-type">StatFs</span> <span class="hljs-variable">statFs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StatFs</span>(dataDirectory.getPath());<br>            <span class="hljs-keyword">return</span> StringUtils.toString(statFs.getAvailableBlocks() * statFs.getBlockSize());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;unknown&quot;</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable th) &#123;<br>        c.a(th);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;unknown&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回值都是”unknown”，所以补环境时也这样返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;availableSystem()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;unknown&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1204a037[libmtguard.so]0x4a037, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;totalMemory()Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p><code>totalMemory</code>代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">totalMemory</span><span class="hljs-params">()</span> &#123;<br>    Object[] objArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>    <span class="hljs-keyword">if</span> (PatchProxy.isSupport(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;a240e07aebe4d91708d281e29b9fc189&quot;</span>, RobustBitConfig.DEFAULT_VALUE)) &#123;<br>        <span class="hljs-keyword">return</span> (String) PatchProxy.accessDispatch(objArr, <span class="hljs-literal">null</span>, changeQuickRedirect2, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;a240e07aebe4d91708d281e29b9fc189&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">FileReader</span> <span class="hljs-variable">fileReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">&quot;/proc/meminfo&quot;</span>);<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(fileReader);<br>        bufferedReader.close();<br>        fileReader.close();<br>        <span class="hljs-keyword">return</span> StringUtils.toString(Long.valueOf(bufferedReader.readLine().split(<span class="hljs-string">&quot;\\s+&quot;</span>)[<span class="hljs-number">1</span>]).intValue() * <span class="hljs-number">1024</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable th) &#123;<br>        c.a(th);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;unknown&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>获取”&#x2F;proc&#x2F;meminfo”文件的第一行，取分隔后的第二个值乘以1024返回。这里 frida hook 或者 查看对应文件都可以，具体操作不展示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;totalMemory()Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;3948355584&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x1204d603[libmtguard.so]0x4d603, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getFirstLaunchTime(Landroid/content/Context;)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p><code>getFirstLaunchTime</code> 顾名思义，获取应用程序首次启动的时间。</p>
<p>同样还是 frida hook返回值，补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getFirstLaunchTime(Landroid/content/Context;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;1732634813346&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终运行成功，结果如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">getPlatformInfo</span> call result: Android|com.dianping.v1|<span class="hljs-number">10</span>.<span class="hljs-number">41</span>.<span class="hljs-number">15</span>|<span class="hljs-number">29</span>|-|<span class="hljs-number">2024</span>-<span class="hljs-number">11</span>-<span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">33</span>:<span class="hljs-number">42</span>:<span class="hljs-number">042</span>|<span class="hljs-number">50</span>|<span class="hljs-number">96458538</span>|-|<span class="hljs-number">3948355584</span>|<span class="hljs-number">1732634813346</span>|-|-|<br></code></pre></td></tr></table></figure>

<h1 id="十二、getUserAction"><a href="#十二、getUserAction" class="headerlink" title="十二、getUserAction"></a>十二、getUserAction</h1><p>调用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserAction</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> cSIUACollectorObj.callJniMethodObject(emulator, <span class="hljs-string">&quot;getUserAction()Ljava/lang/String;&quot;</span>)<br>        .getValue()<br>        .toString();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x15b, PC=unidbg@<span class="hljs-number">0</span>xfffe0644, LR=RX@<span class="hljs-number">0</span>x120424c5[libmtguard.so]<span class="hljs-number">0</span>x424c5, syscall=<span class="hljs-keyword">null</span><br>java.lang.UnsupportedOperationException: com<span class="hljs-regexp">/meituan/</span>android<span class="hljs-regexp">/common/m</span>tguard<span class="hljs-regexp">/NBridge$SIUACollector-&gt;batteryHelper:Lcom/m</span>eituan<span class="hljs-regexp">/android/</span>common<span class="hljs-regexp">/dfingerprint/</span>collection<span class="hljs-regexp">/utils/</span>BatteryHelper;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.getObjectField(AbstractJni.java:<span class="hljs-number">171</span>)<br></code></pre></td></tr></table></figure>

<p>获取<code>batteryHelper</code>实例对象报错，这里直接占位处理，后面肯定会遇到与它相关的函数调用的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;batteryHelper:Lcom/meituan/android/common/dfingerprint/collection/utils/BatteryHelper;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> vm.resolveClass(<span class="hljs-string">&quot;com/meituan/android/common/dfingerprint/collection/utils/BatteryHelper&quot;</span>).newObject(signature);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>果真没错，继续运行报错</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WARN <span class="hljs-selector-attr">[com.github.unidbg.linux.ARM32SyscallHandler]</span> (ARM32SyscallHandler:<span class="hljs-number">538</span>) - handleInterrupt intno=<span class="hljs-number">2</span>, NR=-<span class="hljs-number">452987096</span>, svcNumber=<span class="hljs-number">0</span>x123, PC=unidbg@<span class="hljs-number">0</span>xfffe02c4, LR=RX@<span class="hljs-number">0</span>x120414af<span class="hljs-selector-attr">[libmtguard.so]</span><span class="hljs-number">0</span>x414af, syscall=null<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UnsupportedOperationException</span>: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;<span class="hljs-built_in">getBatteryInfo</span>()Z<br>	at com<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.unidbg</span><span class="hljs-selector-class">.linux</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.dvm</span><span class="hljs-selector-class">.AbstractJni</span><span class="hljs-selector-class">.callBooleanMethodV</span>(AbstractJni<span class="hljs-selector-class">.java</span>:<span class="hljs-number">625</span>)<br></code></pre></td></tr></table></figure>

<p>查看<code>getBatteryInfo</code>代码，是在获取电源状态信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBatteryInfo</span><span class="hljs-params">()</span> &#123;<br>    Object[] objArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-type">ChangeQuickRedirect</span> <span class="hljs-variable">changeQuickRedirect2</span> <span class="hljs-operator">=</span> changeQuickRedirect;<br>    <span class="hljs-keyword">if</span> (PatchProxy.isSupport(objArr, <span class="hljs-built_in">this</span>, changeQuickRedirect2, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;2d10aac5384d6818e2765f99df76bffe&quot;</span>, RobustBitConfig.DEFAULT_VALUE)) &#123;<br>        <span class="hljs-keyword">return</span> ((Boolean) PatchProxy.accessDispatch(objArr, <span class="hljs-built_in">this</span>, changeQuickRedirect2, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;2d10aac5384d6818e2765f99df76bffe&quot;</span>)).booleanValue();<br>    &#125;<br>    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mContext;<br>    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-type">BatteryStatus</span> <span class="hljs-variable">batteryStatus</span> <span class="hljs-operator">=</span> BatteryHelper.getInstance(context).getBatteryStatus();<br>    <span class="hljs-built_in">this</span>.level = batteryStatus.batteryLevel;<span class="hljs-comment">//电池当前的电量级别（例如，0 到 100 之间的整数值）。</span><br>    <span class="hljs-built_in">this</span>.scale = batteryStatus.batteryScale;<span class="hljs-comment">//电池的最大电量。</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> batteryStatus.batteryStatus;<span class="hljs-comment">//电池的充电状态，值为：1 表示充电。2 表示正在放电。3 表示电池状态未知。</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i2</span> <span class="hljs-operator">=</span> batteryStatus.batteryPlugged;<span class="hljs-comment">//电池是否插电，值为：1 表示充电器插入（比如 USB 插入）。2 表示通过电源适配器（如电源插座）插电充电。0 表示没有插电。</span><br>    <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span> &amp;&amp; i2 == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-built_in">this</span>.status = <span class="hljs-number">1</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.status = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (i2 == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-built_in">this</span>.plugged = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.plugged = <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>选择返回true，这意味着获取到了电源状态信息，补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getBatteryInfo()Z&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x160, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0694, <span class="hljs-attribute">LR</span>=RX@0x120458d9[libmtguard.so]0x458d9, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;level:I<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.getIntField(AbstractJni.java:648)<br></code></pre></td></tr></table></figure>

<p>在刚才的<code>getBatteryInfo</code>代码中进行了赋值，它代表的是电池当前的电量级别。</p>
<p>接下来报错是关于这四个属性的获取，即<code>level</code>、<code>scale</code>、<code>status</code>、<code>plugged</code>。</p>
<p>查看实例中某些字段的值，这个场景用 <a target="_blank" rel="noopener" href="https://github.com/r0ysue/r0tracer/blob/main/r0tracer.js">r0tracer</a> 会很舒服，<u>尤其是批量追踪包含某个关键字的所有类</u>。我这里手写hook脚本，由于我是attach模式下进行hook，尝试使用<code>java.choose()</code>搜索<code>SIUACollector</code>实例，并没有找到，但可以通过主动调用<code>getBatteryInfo</code>，然后获取字段值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<br>        <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <br>            <span class="hljs-keyword">let</span> <span class="hljs-title class_">SIUACollector</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;</span>);<br>            <span class="hljs-title class_">SIUACollector</span>[<span class="hljs-string">&quot;getBatteryInfo&quot;</span>].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.getBatteryInfo is called`</span>);<br>                <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>[<span class="hljs-string">&quot;getBatteryInfo&quot;</span>]();<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SIUACollector.getBatteryInfo result=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;;<br><br>            <span class="hljs-comment">// 获取系统上下文</span><br>            <span class="hljs-keyword">var</span> currentApplication = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;android.app.ActivityThread&#x27;</span>).<span class="hljs-title function_">currentApplication</span>();<br>            <span class="hljs-keyword">var</span> context = currentApplication.<span class="hljs-title function_">getApplicationContext</span>();<br>            <span class="hljs-comment">//主动调用</span><br>            <span class="hljs-keyword">var</span> collector = <span class="hljs-title class_">SIUACollector</span>.$new(context);<br>            collector.<span class="hljs-title function_">getBatteryInfo</span>();<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;level: &quot;</span> + collector.<span class="hljs-property">level</span>.<span class="hljs-property">value</span>);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;scale: &quot;</span> + collector.<span class="hljs-property">scale</span>.<span class="hljs-property">value</span>);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;status: &quot;</span> + collector.<span class="hljs-property">status</span>.<span class="hljs-property">value</span>);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;plugged: &quot;</span> + collector.<span class="hljs-property">plugged</span>.<span class="hljs-property">value</span>);<br>        &#125;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>hook 结果如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java">SIUACollector.getBatteryInfo is called<br>SIUACollector.getBatteryInfo result=<span class="hljs-literal">true</span><br>level: <span class="hljs-number">100</span><br>scale: <span class="hljs-number">100</span><br>status: <span class="hljs-number">0</span><br>plugged: <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>补环境代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getIntField</span><span class="hljs-params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (signature) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;level:I&quot;</span>:<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;scale:I&quot;</span>: &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;<br>        &#125;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;status:I&quot;</span>: &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getIntField(vm, dvmObject, signature);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBooleanField</span><span class="hljs-params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (signature) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;plugged:Z&quot;</span>: &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getBooleanField(vm, dvmObject, signature);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来报错</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt <span class="hljs-attribute">intno</span>=2, <span class="hljs-attribute">NR</span>=-452987096, <span class="hljs-attribute">svcNumber</span>=0x120, <span class="hljs-attribute">PC</span>=unidbg@0xfffe0294, <span class="hljs-attribute">LR</span>=RX@0x12042d93[libmtguard.so]0x42d93, <span class="hljs-attribute">syscall</span>=<span class="hljs-literal">null</span><br>java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge<span class="hljs-variable">$SIUACollector</span>-&gt;getDataActivity(Landroid/content/Context;)Ljava/lang/String;<br>	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)<br></code></pre></td></tr></table></figure>

<p>还是 frida hook 返回值，然后补环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getDataActivity(Landroid/content/Context;)Ljava/lang/String;&quot;</span>: &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm,<span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终运行成功，结果如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">getUserAction</span> call result: -|<span class="hljs-number">100</span>|<span class="hljs-number">1</span>|<span class="hljs-number">0</span>|<span class="hljs-number">1</span>|-|<span class="hljs-number">52706</span>c36-ec3d-<span class="hljs-number">4</span>d2a-<span class="hljs-number">9</span>e35-d11bd1580e5f|<span class="hljs-number">0</span>|<br></code></pre></td></tr></table></figure>



<h1 id="十三、参考"><a href="#十三、参考" class="headerlink" title="十三、参考"></a>十三、参考</h1><p>[Unidbg 的基本使用（六）](<a target="_blank" rel="noopener" href="https://www.yuque.com/lilac-2hqvv/xdwlsg/avlc01hrko6yvr26#">https://www.yuque.com/lilac-2hqvv/xdwlsg/avlc01hrko6yvr26?#</a> 《Unidbg 的基本使用（六）》)</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Unidbg/" class="category-chain-item">Unidbg</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Unidbg/">#Unidbg</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>从案例中学习unidbg的使用（五）</div>
      <div>http://example.com/2024/12/05/Unidbg模拟执行/从案例中学习unidbg的使用（五）/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>gla2xy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年12月5日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/12/05/Unidbg%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/unidbg%E4%B8%AD%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E6%97%B6%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%B0%81%E8%A3%85/" title="unidbg中参数传递时的类型封装">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">unidbg中参数传递时的类型封装</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/05/Unidbg%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/%E4%BB%8E%E6%A1%88%E4%BE%8B%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E7%9A%84%E4%BD%BF%E7%94%A8%EF%BC%88%E5%9B%9B%EF%BC%89/" title="从案例中学习unidbg的使用（四）">
                        <span class="hidden-mobile">从案例中学习unidbg的使用（四）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
